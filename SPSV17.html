<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>特採系統 (Supabase 版)</title>
    
    <!-- DNS 預解析和資源預載入 -->
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//htamptcakcnlmltwdcog.supabase.co">
    
    <!-- 預載入關鍵字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- 非同步載入外部資源 -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script type="module">
        // 您的 Supabase 設定
    const supabaseUrl = 'https://htamptcakcnlmltwdcog.supabase.co';
    // 將 URL 與金鑰掛到 window，供其他模組/備援流程取用
        window.SUPABASE_URL = supabaseUrl;
        // 兼容舊程式碼（若有處參考 window.supabaseUrl 或全域 supabaseUrl）：
        window.supabaseUrl = supabaseUrl;
        // 輔助：統一取得 Functions 基底 URL
        window.getSupabaseBaseUrl = function() {
            return window.SUPABASE_URL || window.supabaseUrl || '';
        };
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0YW1wdGNha2NubG1sdHdkY29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0ODM2MzAsImV4cCI6MjA2OTA1OTYzMH0.Pt94WOX9lX9svYrq02s27Dvm1El1K2DktAxR9o9nhOE';
    // 讓其他 module script 可安全存取（避免跨模組作用域問題）
    window.SUPABASE_ANON_KEY = supabaseAnonKey;

        // 等待依賴載入完成
        const waitForDependencies = () => {
            return new Promise((resolve) => {
                const checkDependencies = () => {
                    if (window.supabase && window.XlsxPopulate) {
                        resolve();
                    } else {
                        setTimeout(checkDependencies, 50);
                    }
                };
                checkDependencies();
            });
        };

        // 初始化 Supabase（延遲載入）
        const initSupabase = async () => {
            if (typeof supabase !== 'undefined') {
                const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
                window.supabase = supabaseClient;
            } else {
                // 如果 supabase 還未載入，等待
                setTimeout(initSupabase, 100);
            }
        };

        // 當頁面載入完成後初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSupabase);
        } else {
            initSupabase();
        }

        // 在以 file:// 開啟時提示 CORS 風險，建議改用本機 HTTP 伺服器
        const ensureTopWarningBanner = () => {
            if (location.protocol !== 'file:') return;
            if (document.getElementById('file-protocol-warning')) return;
            const bar = document.createElement('div');
            bar.id = 'file-protocol-warning';
            bar.style.position = 'fixed';
            bar.style.top = '0';
            bar.style.left = '0';
            bar.style.right = '0';
            bar.style.zIndex = '10000';
            bar.style.background = '#b91c1c';
            bar.style.color = 'white';
            bar.style.padding = '8px 12px';
            bar.style.fontSize = '13px';
            bar.style.textAlign = 'center';
            bar.textContent = '偵測到以檔案路徑 (file://) 開啟本頁，瀏覽器將封鎖跨域請求，可能導致 Edge Function 上傳/下載失敗。請改以本機伺服器（http://localhost）開啟此專案。';
            document.body.appendChild(bar);
            // 推下整體內容避免被遮住
            document.body.style.paddingTop = '36px';
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', ensureTopWarningBanner);
        } else {
            ensureTopWarningBanner();
        }
    </script>

    <script type="module">
        // === 效能優化工具函數 ===
        
        // 防抖動函數
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // 節流函數
        const throttle = (func, limit) => {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        };

        // 緩存管理器
        const CacheManager = {
            cache: new Map(),
            maxSize: 100,
            
            set(key, value, ttl = 300000) { // 5分鐘默認TTL
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    value,
                    timestamp: Date.now(),
                    ttl
                });
            },
            
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                if (Date.now() - item.timestamp > item.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.value;
            },
            
            clear(key = null) {
                if (key) {
                    this.cache.delete(key);
                } else {
                    this.cache.clear();
                }
            }
        };

        // 將工具函數掛載到全域
        window.debounce = debounce;
        window.throttle = throttle;

        // 資源載入優化管理器
        class ResourceOptimizer {
            constructor() {
                this.loadedImages = new Set();
                this.imageCache = new Map();
                this.loadQueue = [];
                this.isProcessing = false;
            }

            // 懶載入圖片
            lazyLoadImage(imgElement, src, fallbackSrc = '/api/placeholder/300/200') {
                if (this.loadedImages.has(src)) {
                    imgElement.src = src;
                    return Promise.resolve();
                }

                return new Promise((resolve, reject) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        this.loadedImages.add(src);
                        this.imageCache.set(src, img);
                        imgElement.src = src;
                        imgElement.classList.add('loaded');
                        resolve();
                    };
                    
                    img.onerror = () => {
                        console.warn(`圖片載入失敗: ${src}`);
                        if (fallbackSrc && src !== fallbackSrc) {
                            this.lazyLoadImage(imgElement, fallbackSrc).then(resolve).catch(reject);
                        } else {
                            imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZiNzI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWclueJh+aXoOazleS4reaIlui8ieWFpTwvdGV4dD48L3N2Zz4=';
                            imgElement.classList.add('error');
                            reject(new Error('圖片載入失敗'));
                        }
                    };
                    
                    // 設置載入超時
                    setTimeout(() => {
                        if (!img.complete) {
                            img.onerror();
                        }
                    }, 10000);
                    
                    img.src = src;
                });
            }

            // 預載入關鍵資源
            preloadCriticalResources() {
                const criticalImages = [
                    // 可以添加需要預載入的關鍵圖片 URL
                ];

                return Promise.all(
                    criticalImages.map(src => {
                        if (this.loadedImages.has(src)) return Promise.resolve();
                        
                        return new Promise((resolve) => {
                            const img = new Image();
                            img.onload = () => {
                                this.loadedImages.add(src);
                                this.imageCache.set(src, img);
                                resolve();
                            };
                            img.onerror = () => resolve(); // 即使失敗也繼續
                            img.src = src;
                        });
                    })
                );
            }

            // 清理未使用的圖片快取
            cleanupCache() {
                const maxCacheSize = 50;
                if (this.imageCache.size > maxCacheSize) {
                    const entries = Array.from(this.imageCache.entries());
                    const toRemove = entries.slice(0, entries.length - maxCacheSize);
                    
                    toRemove.forEach(([src]) => {
                        this.imageCache.delete(src);
                        this.loadedImages.delete(src);
                    });
                }
            }

            // 批量處理圖片載入
            batchLoadImages(images) {
                this.loadQueue.push(...images);
                if (!this.isProcessing) {
                    this.processQueue();
                }
            }

            async processQueue() {
                this.isProcessing = true;
                const batchSize = 3; // 同時載入的圖片數量
                
                while (this.loadQueue.length > 0) {
                    const batch = this.loadQueue.splice(0, batchSize);
                    
                    await Promise.allSettled(
                        batch.map(({ element, src, fallback }) => 
                            this.lazyLoadImage(element, src, fallback)
                        )
                    );
                    
                    // 在批次間加入小延遲避免阻塞主線程
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                this.isProcessing = false;
                this.cleanupCache();
            }
        }

        // 創建全域資源優化器實例
        window.resourceOptimizer = new ResourceOptimizer();

        // Intersection Observer 用於圖片懶載入
        const createImageObserver = () => {
            if (!window.IntersectionObserver) return null;

            return new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const src = img.dataset.src;
                        const fallback = img.dataset.fallback;
                        
                        if (src) {
                            window.resourceOptimizer.lazyLoadImage(img, src, fallback)
                                .finally(() => {
                                    imageObserver.unobserve(img);
                                });
                        }
                    }
                });
            }, {
                rootMargin: '50px 0px', // 提前 50px 開始載入
                threshold: 0.1
            });
        };

        const imageObserver = createImageObserver();

        // 優化的圖片元素創建函數
        window.createOptimizedImage = (src, alt = '', className = '', fallbackSrc) => {
            const img = document.createElement('img');
            img.alt = alt;
            img.className = `lazy-image transition-opacity duration-300 opacity-0 ${className}`;
            img.dataset.src = src;
            if (fallbackSrc) img.dataset.fallback = fallbackSrc;
            
            // 設置載入中的佔位符
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PGNpcmNsZSBjeD0iNTAlIiBjeT0iNTAlIiByPSIyMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZDFkNWRiIiBzdHJva2Utd2lkdGg9IjIiPjxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiBmcm9tPSIwIDUwIDUwIiB0bz0iMzYwIDUwIDUwIiBkdXI9IjFzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPjwvY2lyY2xlPjx0ZXh0IHg9IjUwJSIgeT0iNjUlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM2YjcyODAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPui8ieWFpeS4rTwvdGV4dD48L3N2Zz4=';
            
            // 當圖片成功載入時添加載入完成的樣式
            img.addEventListener('load', () => {
                img.classList.add('opacity-100');
                img.classList.remove('opacity-0');
            });
            
            // 如果支援 Intersection Observer，使用懶載入
            if (imageObserver) {
                imageObserver.observe(img);
            } else {
                // 降級方案：立即載入
                window.resourceOptimizer.lazyLoadImage(img, src, fallbackSrc);
            }
            
            return img;
        };

        window.CacheManager = CacheManager;
    </script>

    <style>
        /* 基礎變數定義 */
        :root {
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-normal: 0 4px 6px rgba(0,0,0,0.1);
            --border-radius: 0.5rem;
        }

        /* 效能優化的動畫 */
        .spinner-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            will-change: transform;
        }
        .spinner-dot { 
            width: 1.5rem; 
            height: 1.5rem; 
            background-color: #3b82f6; 
            border-radius: 50%; 
            margin: 0 0.5rem; 
            animation: bounce-delay 1.4s infinite ease-in-out both;
            will-change: transform;
        }
        .spinner-dot:nth-child(1) { animation-delay: -0.32s; }
        .spinner-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce-delay { 
            0%, 80%, 100% { transform: scale(0); } 
            40% { transform: scale(1.0); } 
        }
        
        .view { 
            display: none; 
            animation: fadeIn var(--transition-normal);
            will-change: opacity;
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        /* 通知系統優化 */
        #notification-container { 
            position: fixed; 
            top: 1rem; 
            right: 1rem; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 0.5rem;
            pointer-events: none;
        }
        
        .notification { 
            padding: 1rem; 
            border-radius: var(--border-radius); 
            color: white; 
            box-shadow: var(--shadow-normal); 
            animation: slideIn var(--transition-normal) ease-out, fadeOut 0.5s ease-in 2.5s forwards; 
            white-space: pre-wrap;
            pointer-events: auto;
            will-change: transform, opacity;
        }
        
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        
        @keyframes slideIn { 
            from { transform: translateX(100%); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }
        
        @keyframes fadeOut { 
            from { opacity: 1; } 
            to { opacity: 0; transform: scale(0.95); } 
        }
        
        /* 互動元素優化 */
        .tab-button.active { 
            border-color: #3b82f6; 
            color: #3b82f6;
            transition: all var(--transition-fast);
        }
        
        .sortable {
            transition: background-color var(--transition-fast);
            cursor: pointer;
        }
        
        .sortable:hover { 
            background-color: #f9fafb; 
        }
        
        .sort-icon { 
            opacity: 0.4; 
            display: inline-block; 
            margin-left: 4px;
            transition: opacity var(--transition-fast);
        }
        
        .sortable.active .sort-icon { 
            opacity: 1; 
            color: #3b82f6; 
        }

        /* Hover popover for dashboard request ID */
        .request-id-hover {
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: help;
        }
        .hover-popover {
            position: fixed;
            z-index: 50;
            width: 320px;
            max-width: calc(100vw - 24px);
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            border-radius: 0.5rem;
            padding: 12px;
            display: none;
        }
        .hover-popover.show { display: block; }
        .hover-popover .title { font-weight: 700; font-size: 14px; color: #111827; }
        .hover-popover .kv { display: grid; grid-template-columns: 90px 1fr; gap: 6px 8px; margin-top: 8px; font-size: 12px; color: #374151; }
        .hover-popover .actions { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .hover-popover .btn { padding: 4px 8px; border-radius: 6px; font-size: 12px; border: 1px solid #e5e7eb; background: #f9fafb; color: #111827; }
        .hover-popover .btn:hover { background: #f3f4f6; }
    .hover-popover .close-btn { position: absolute; top: 8px; right: 8px; width: 22px; height: 22px; line-height: 22px; text-align: center; border-radius: 9999px; border: 1px solid #e5e7eb; background: #ffffff; color: #6b7280; }
    .hover-popover .close-btn:hover { background: #f3f4f6; color: #111827; }

        /* 主題樣式優化 - 使用 CSS 自訂屬性提升效能 */
    
        /* Apple Theme Styles */
        .theme-apple {
            --bg-color: #f5f5f7;
            --card-bg-color: #ffffff;
            --text-color: #1d1d1f;
            --subtle-text-color: #6e6e73;
            --border-color: #d2d2d7;
            --accent-color: #007aff;
            --accent-hover-color: #0071e3;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            background-color: var(--bg-color) !important;
            font-family: var(--font-family) !important;
            color: var(--text-color) !important;
        }
        .theme-apple body, .theme-apple .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-apple .bg-white, .theme-apple .bg-gray-100 { background-color: var(--card-bg-color) !important; }
        .theme-apple .shadow-sm, .theme-apple .shadow-md, .theme-apple .shadow-lg, .theme-apple .shadow-xl {
             box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.04), 0 1px 2px -1px rgba(0, 0, 0, 0.04) !important;
             border: 1px solid var(--border-color);
        }
        .theme-apple .rounded-lg { border-radius: 12px !important; }
        .theme-apple .rounded-md { border-radius: 8px !important; }
        .theme-apple .border, .theme-apple .border-gray-300, .theme-apple .border-gray-200, .theme-apple .divide-y > :not([hidden]) ~ :not([hidden]), .theme-apple .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-apple .text-gray-900, .theme-apple .text-gray-800, .theme-apple .text-gray-700 { color: var(--text-color) !important; }
        .theme-apple .text-gray-600, .theme-apple .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-apple .text-blue-600 { color: var(--accent-color) !important; }
        .theme-apple .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-apple .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-apple input, .theme-apple select, .theme-apple textarea {
            background-color: #f0f0f0 !important;
            border-radius: 8px !important;
            border: 1px solid var(--border-color) !important;
        }
        .theme-apple input:focus, .theme-apple select:focus, .theme-apple textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2) !important;
            outline: none !important;
        }
        .theme-apple .tab-button.active {
            border-color: var(--accent-color) !important;
            color: var(--accent-color) !important;
        }

        /* Sci-Fi Theme Styles */
        .theme-scifi {
            --bg-color: #0a0f1a;
            --card-bg-color: #1a202c;
            --text-color: #00f7ff;
            --subtle-text-color: #8a9ecb;
            --border-color: #2d3748;
            --accent-color: #00f7ff;
            --accent-hover-color: #00d1db;
            --font-family: 'Orbitron', sans-serif;

            background-color: var(--bg-color) !important;
            font-family: var(--font-family) !important;
            color: var(--text-color) !important;
        }
        .theme-scifi body, .theme-scifi .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-scifi .bg-white, .theme-scifi .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-scifi .shadow-sm, .theme-scifi .shadow-md, .theme-scifi .shadow-lg, .theme-scifi .shadow-xl {
             box-shadow: 0 0 15px rgba(0, 247, 255, 0.1), 0 0 5px rgba(0, 247, 255, 0.05) !important;
             border: 1px solid var(--border-color);
        }
        .theme-scifi .rounded-lg, .theme-scifi .rounded-md { border-radius: 4px !important; }
        .theme-scifi .border, .theme-scifi .border-gray-300, .theme-scifi .border-gray-200, .theme-scifi .divide-y > :not([hidden]) ~ :not([hidden]), .theme-scifi .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-scifi .text-gray-900, .theme-scifi .text-gray-800, .theme-scifi .text-gray-700 { color: var(--text-color) !important; }
        .theme-scifi .text-gray-600, .theme-scifi .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-scifi .text-blue-600 { color: var(--accent-color) !important; }
        .theme-scifi .bg-blue-600 { background-color: var(--accent-color) !important; color: #0a0f1a !important; }
        .theme-scifi .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-scifi input, .theme-scifi select, .theme-scifi textarea {
            background-color: #0a0f1a !important;
            border-radius: 4px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-scifi input:focus, .theme-scifi select:focus, .theme-scifi textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(0, 247, 255, 0.3) !important;
            outline: none !important;
        }
        .theme-scifi .tab-button.active {
            border-color: var(--accent-color) !important;
            color: var(--accent-color) !important;
        }

        /* Ghibli Theme Styles */
        .theme-ghibli {
            --bg-color: #fbf1c7;
            --card-bg-color: #fdf6e3;
            --text-color: #3c3836;
            --subtle-text-color: #7c6f64;
            --border-color: #d5c4a1;
            --accent-color: #458588;
            --accent-hover-color: #076678;
            --font-family: 'Noto Sans TC', sans-serif;

            background-color: var(--bg-color) !important;
            font-family: var(--font-family) !important;
            color: var(--text-color) !important;
        }
        .theme-ghibli body, .theme-ghibli .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-ghibli .bg-white, .theme-ghibli .bg-gray-100 { background-color: var(--card-bg-color) !important; }
        .theme-ghibli .shadow-sm, .theme-ghibli .shadow-md, .theme-ghibli .shadow-lg, .theme-ghibli .shadow-xl {
             box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05) !important;
             border: 1px solid var(--border-color);
        }
        .theme-ghibli .rounded-lg { border-radius: 10px !important; }
        .theme-ghibli .rounded-md { border-radius: 6px !important; }
        .theme-ghibli .border, .theme-ghibli .border-gray-300, .theme-ghibli .border-gray-200, .theme-ghibli .divide-y > :not([hidden]) ~ :not([hidden]), .theme-ghibli .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-ghibli .text-gray-900, .theme-ghibli .text-gray-800, .theme-ghibli .text-gray-700 { color: var(--text-color) !important; }
        .theme-ghibli .text-gray-600, .theme-ghibli .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-ghibli .text-blue-600 { color: var(--accent-color) !important; }
        .theme-ghibli .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-ghibli .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-ghibli input, .theme-ghibli select, .theme-ghibli textarea {
            background-color: #f9f5d7 !important;
            border-radius: 6px !important;
            border: 1px solid var(--border-color) !important;
        }
        .theme-ghibli input:focus, .theme-ghibli select:focus, .theme-ghibli textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(69, 133, 136, 0.2) !important;
            outline: none !important;
        }
        .theme-ghibli .tab-button.active {
            border-color: var(--accent-color) !important;
            color: var(--accent-color) !important;
        }

        /* Abstract Art Theme Styles */
        .theme-abstract {
            --bg-color: #1a1a1a;
            --card-bg-color: #2a2a2a;
            --text-color: #f0f0f0;
            --subtle-text-color: #aaaaaa;
            --border-color: #444444;
            --accent-color: #ff00ff;
            --accent-hover-color: #cc00cc;
            --font-family: 'Montserrat', sans-serif;

            background-color: var(--bg-color) !important;
            font-family: var(--font-family) !important;
            color: var(--text-color) !important;
        }
        .theme-abstract body, .theme-abstract .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-abstract .bg-white, .theme-abstract .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-abstract .shadow-sm, .theme-abstract .shadow-md, .theme-abstract .shadow-lg, .theme-abstract .shadow-xl {
             box-shadow: none !important;
             border: 2px solid var(--border-color);
        }
        .theme-abstract .rounded-lg, .theme-abstract .rounded-md { border-radius: 0 !important; }
        .theme-abstract .border, .theme-abstract .border-gray-300, .theme-abstract .border-gray-200, .theme-abstract .divide-y > :not([hidden]) ~ :not([hidden]), .theme-abstract .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-abstract .text-gray-900, .theme-abstract .text-gray-800, .theme-abstract .text-gray-700 { color: var(--text-color) !important; }
        .theme-abstract .text-gray-600, .theme-abstract .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-abstract .text-blue-600 { color: var(--accent-color) !important; }
        .theme-abstract .bg-blue-600 { background-color: var(--accent-color) !important; color: #1a1a1a !important; }
        .theme-abstract .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-abstract input, .theme-abstract select, .theme-abstract textarea {
            background-color: #1a1a1a !important;
            border-radius: 0 !important;
            border: 2px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-abstract input:focus, .theme-abstract select:focus, .theme-abstract textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: none !important;
            outline: none !important;
        }
        .theme-abstract .tab-button.active {
            border-color: var(--accent-color) !important;
            color: var(--accent-color) !important;
            border-bottom-width: 4px !important;
        }

        /* Eldercare Soft Theme */
        .theme-care-soft {
            --bg-color: #fff7ed; /* orange-50 */
            --card-bg-color: #fffaf0; /* warm cream */
            --text-color: #3f2d20; /* warm brown */
            --subtle-text-color: #a16207; /* amber-700 */
            --border-color: #fed7aa; /* orange-200 */
            --accent-color: #f59e0b; /* amber-500 */
            --accent-hover-color: #d97706; /* amber-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-care-soft body, .theme-care-soft .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-care-soft .bg-white, .theme-care-soft .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-care-soft .shadow-sm, .theme-care-soft .shadow-md, .theme-care-soft .shadow-lg, .theme-care-soft .shadow-xl {
             box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05) !important;
             border: 1px solid var(--border-color);
        }
        .theme-care-soft .rounded-lg { border-radius: 12px !important; }
        .theme-care-soft .rounded-md { border-radius: 8px !important; }
        .theme-care-soft .border, .theme-care-soft .border-gray-300, .theme-care-soft .border-gray-200, .theme-care-soft .divide-y > :not([hidden]) ~ :not([hidden]), .theme-care-soft .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-care-soft .text-gray-900, .theme-care-soft .text-gray-800, .theme-care-soft .text-gray-700 { color: var(--text-color) !important; }
        .theme-care-soft .text-gray-600, .theme-care-soft .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-care-soft .text-blue-600 { color: var(--accent-color) !important; }
        .theme-care-soft .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-care-soft .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-care-soft input, .theme-care-soft select, .theme-care-soft textarea {
            background-color: #fffef9 !important;
            border-radius: 10px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-care-soft input:focus, .theme-care-soft select:focus, .theme-care-soft textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2) !important;
            outline: none !important;
        }
        .theme-care-soft .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Eldercare Fresh Theme */
        .theme-care-fresh {
            --bg-color: #ecfdf5; /* emerald-50 */
            --card-bg-color: #ffffff;
            --text-color: #064e3b; /* emerald-900 */
            --subtle-text-color: #10b981; /* emerald-500 */
            --border-color: #d1fae5; /* emerald-200 */
            --accent-color: #10b981; /* emerald-500 */
            --accent-hover-color: #059669; /* emerald-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-care-fresh body, .theme-care-fresh .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-care-fresh .bg-white, .theme-care-fresh .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-care-fresh .shadow-sm, .theme-care-fresh .shadow-md, .theme-care-fresh .shadow-lg, .theme-care-fresh .shadow-xl { box-shadow: 0 2px 4px rgba(0,0,0,0.04) !important; border: 1px solid var(--border-color); }
        .theme-care-fresh .rounded-lg { border-radius: 12px !important; }
        .theme-care-fresh .rounded-md { border-radius: 8px !important; }
        .theme-care-fresh .border, .theme-care-fresh .border-gray-300, .theme-care-fresh .border-gray-200, .theme-care-fresh .divide-y > :not([hidden]) ~ :not([hidden]), .theme-care-fresh .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-care-fresh .text-gray-900, .theme-care-fresh .text-gray-800, .theme-care-fresh .text-gray-700 { color: var(--text-color) !important; }
        .theme-care-fresh .text-gray-600, .theme-care-fresh .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-care-fresh .text-blue-600 { color: var(--accent-color) !important; }
        .theme-care-fresh .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-care-fresh .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-care-fresh input, .theme-care-fresh select, .theme-care-fresh textarea { background-color: #f7fff9 !important; border-radius: 10px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-care-fresh input:focus, .theme-care-fresh select:focus, .theme-care-fresh textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.25) !important; outline: none !important; }
        .theme-care-fresh .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Medical Clean Theme */
        .theme-med-clean {
            --bg-color: #f8fafc; /* slate-50 */
            --card-bg-color: #ffffff;
            --text-color: #0f172a; /* slate-900 */
            --subtle-text-color: #64748b; /* slate-500 */
            --border-color: #e2e8f0; /* slate-200 */
            --accent-color: #3b82f6; /* blue-500 */
            --accent-hover-color: #2563eb; /* blue-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-med-clean body, .theme-med-clean .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-med-clean .bg-white, .theme-med-clean .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-med-clean .shadow-sm, .theme-med-clean .shadow-md, .theme-med-clean .shadow-lg, .theme-med-clean .shadow-xl { box-shadow: 0 1px 3px rgba(0,0,0,0.06) !important; border: 1px solid var(--border-color); }
        .theme-med-clean .rounded-lg, .theme-med-clean .rounded-md { border-radius: 8px !important; }
        .theme-med-clean .border, .theme-med-clean .border-gray-300, .theme-med-clean .border-gray-200, .theme-med-clean .divide-y > :not([hidden]) ~ :not([hidden]), .theme-med-clean .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-med-clean .text-gray-900, .theme-med-clean .text-gray-800, .theme-med-clean .text-gray-700 { color: var(--text-color) !important; }
        .theme-med-clean .text-gray-600, .theme-med-clean .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-med-clean .text-blue-600 { color: var(--accent-color) !important; }
        .theme-med-clean .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-med-clean .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-med-clean input, .theme-med-clean select, .theme-med-clean textarea { background-color: #ffffff !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-med-clean input:focus, .theme-med-clean select:focus, .theme-med-clean textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important; outline: none !important; }
        .theme-med-clean .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Medical Trust Theme */
        .theme-med-trust {
            --bg-color: #eff6ff; /* blue-50 */
            --card-bg-color: #ffffff;
            --text-color: #0c4a6e; /* sky-900 */
            --subtle-text-color: #60a5fa; /* blue-400 */
            --border-color: #bfdbfe; /* blue-200 */
            --accent-color: #0ea5e9; /* sky-500 */
            --accent-hover-color: #0284c7; /* sky-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-med-trust body, .theme-med-trust .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-med-trust .bg-white, .theme-med-trust .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-med-trust .shadow-sm, .theme-med-trust .shadow-md, .theme-med-trust .shadow-lg, .theme-med-trust .shadow-xl { box-shadow: 0 1px 3px rgba(2,132,199,0.08) !important; border: 1px solid var(--border-color); }
        .theme-med-trust .rounded-lg, .theme-med-trust .rounded-md { border-radius: 8px !important; }
        .theme-med-trust .border, .theme-med-trust .border-gray-300, .theme-med-trust .border-gray-200, .theme-med-trust .divide-y > :not([hidden]) ~ :not([hidden]), .theme-med-trust .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-med-trust .text-gray-900, .theme-med-trust .text-gray-800, .theme-med-trust .text-gray-700 { color: var(--text-color) !important; }
        .theme-med-trust .text-gray-600, .theme-med-trust .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-med-trust .text-blue-600 { color: var(--accent-color) !important; }
        .theme-med-trust .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-med-trust .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-med-trust input, .theme-med-trust select, .theme-med-trust textarea { background-color: #ffffff !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-med-trust input:focus, .theme-med-trust select:focus, .theme-med-trust textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.25) !important; outline: none !important; }
        .theme-med-trust .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Hotel Luxury Theme */
        .theme-hotel-lux {
            --bg-color: #0f0f13; /* near black */
            --card-bg-color: #1a1a22; /* deep charcoal */
            --text-color: #f5f5f5; /* light */
            --subtle-text-color: #cbd5e1; /* slate-300 */
            --border-color: #2a2a33; /* dark border */
            --accent-color: #d4af37; /* gold */
            --accent-hover-color: #b38e1d; /* darker gold */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-hotel-lux body, .theme-hotel-lux .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-hotel-lux .bg-white, .theme-hotel-lux .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-hotel-lux .shadow-sm, .theme-hotel-lux .shadow-md, .theme-hotel-lux .shadow-lg, .theme-hotel-lux .shadow-xl { box-shadow: 0 6px 16px rgba(0,0,0,0.35) !important; border: 1px solid var(--border-color); }
        .theme-hotel-lux .rounded-lg, .theme-hotel-lux .rounded-md { border-radius: 10px !important; }
        .theme-hotel-lux .border, .theme-hotel-lux .border-gray-300, .theme-hotel-lux .border-gray-200, .theme-hotel-lux .divide-y > :not([hidden]) ~ :not([hidden]), .theme-hotel-lux .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-hotel-lux .text-gray-900, .theme-hotel-lux .text-gray-800, .theme-hotel-lux .text-gray-700 { color: var(--text-color) !important; }
        .theme-hotel-lux .text-gray-600, .theme-hotel-lux .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-hotel-lux .text-blue-600 { color: var(--accent-color) !important; }
        .theme-hotel-lux .bg-blue-600 { background-color: var(--accent-color) !important; color: #111111 !important; }
        .theme-hotel-lux .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-hotel-lux input, .theme-hotel-lux select, .theme-hotel-lux textarea { background-color: #111216 !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-hotel-lux input:focus, .theme-hotel-lux select:focus, .theme-hotel-lux textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.3) !important; outline: none !important; }
        .theme-hotel-lux .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Hotel Resort Theme */
        .theme-hotel-resort {
            --bg-color: #fef3c7; /* amber-100 sand */
            --card-bg-color: #ffffff;
            --text-color: #3b2210; /* warm brown */
            --subtle-text-color: #8b5e34; /* sand brown */
            --border-color: #fde68a; /* amber-200 */
            --accent-color: #14b8a6; /* teal-500 */
            --accent-hover-color: #0d9488; /* teal-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-hotel-resort body, .theme-hotel-resort .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-hotel-resort .bg-white, .theme-hotel-resort .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-hotel-resort .shadow-sm, .theme-hotel-resort .shadow-md, .theme-hotel-resort .shadow-lg, .theme-hotel-resort .shadow-xl { box-shadow: 0 2px 6px rgba(13,148,136,0.12) !important; border: 1px solid var(--border-color); }
        .theme-hotel-resort .rounded-lg { border-radius: 12px !important; }
        .theme-hotel-resort .rounded-md { border-radius: 8px !important; }
        .theme-hotel-resort .border, .theme-hotel-resort .border-gray-300, .theme-hotel-resort .border-gray-200, .theme-hotel-resort .divide-y > :not([hidden]) ~ :not([hidden]), .theme-hotel-resort .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-hotel-resort .text-gray-900, .theme-hotel-resort .text-gray-800, .theme-hotel-resort .text-gray-700 { color: var(--text-color) !important; }
        .theme-hotel-resort .text-gray-600, .theme-hotel-resort .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-hotel-resort .text-blue-600 { color: var(--accent-color) !important; }
        .theme-hotel-resort .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-hotel-resort .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-hotel-resort input, .theme-hotel-resort select, .theme-hotel-resort textarea { background-color: #ffffff !important; border-radius: 10px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-hotel-resort input:focus, .theme-hotel-resort select:focus, .theme-hotel-resort textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.25) !important; outline: none !important; }
        .theme-hotel-resort .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Forest Theme Styles */
        .theme-forest {
            --bg-color: #0b2e13; /* deep forest green */
            --card-bg-color: #123524; /* darker green */
            --text-color: #e8f5e9; /* minty light */
            --subtle-text-color: #a7d7c5; /* soft teal */
            --border-color: #1f4d2e; /* green border */
            --accent-color: #34d399; /* emerald-400 */
            --accent-hover-color: #10b981; /* emerald-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-forest body, .theme-forest .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-forest .bg-white, .theme-forest .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-forest .shadow-sm, .theme-forest .shadow-md, .theme-forest .shadow-lg, .theme-forest .shadow-xl {
             box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.15) !important;
             border: 1px solid var(--border-color);
        }
        .theme-forest .rounded-lg { border-radius: 12px !important; }
        .theme-forest .rounded-md { border-radius: 8px !important; }
        .theme-forest .border, .theme-forest .border-gray-300, .theme-forest .border-gray-200, .theme-forest .divide-y > :not([hidden]) ~ :not([hidden]), .theme-forest .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-forest .text-gray-900, .theme-forest .text-gray-800, .theme-forest .text-gray-700 { color: var(--text-color) !important; }
        .theme-forest .text-gray-600, .theme-forest .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-forest .text-blue-600 { color: var(--accent-color) !important; }
        .theme-forest .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-forest .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-forest input, .theme-forest select, .theme-forest textarea {
            background-color: var(--card-bg-color) !important;
            border-radius: 8px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-forest input:focus, .theme-forest select:focus, .theme-forest textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.25) !important;
            outline: none !important;
        }
        .theme-forest .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Ocean Theme Styles */
        .theme-ocean {
            --bg-color: #0b1220; /* deep navy */
            --card-bg-color: #0e2239; /* ocean deep */
            --text-color: #e0f2fe; /* sky-100 */
            --subtle-text-color: #93c5fd; /* blue-300 */
            --border-color: #1e3a8a; /* indigo-800 */
            --accent-color: #38bdf8; /* sky-400 */
            --accent-hover-color: #0ea5e9; /* sky-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-ocean body, .theme-ocean .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-ocean .bg-white, .theme-ocean .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-ocean .shadow-sm, .theme-ocean .shadow-md, .theme-ocean .shadow-lg, .theme-ocean .shadow-xl {
             box-shadow: 0 0 20px rgba(14, 165, 233, 0.08), 0 0 6px rgba(56, 189, 248, 0.05) !important;
             border: 1px solid var(--border-color);
        }
        .theme-ocean .rounded-lg, .theme-ocean .rounded-md { border-radius: 6px !important; }
        .theme-ocean .border, .theme-ocean .border-gray-300, .theme-ocean .border-gray-200, .theme-ocean .divide-y > :not([hidden]) ~ :not([hidden]), .theme-ocean .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-ocean .text-gray-900, .theme-ocean .text-gray-800, .theme-ocean .text-gray-700 { color: var(--text-color) !important; }
        .theme-ocean .text-gray-600, .theme-ocean .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-ocean .text-blue-600 { color: var(--accent-color) !important; }
        .theme-ocean .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-ocean .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-ocean input, .theme-ocean select, .theme-ocean textarea {
            background-color: #0b1220 !important;
            border-radius: 6px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-ocean input:focus, .theme-ocean select:focus, .theme-ocean textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3) !important;
            outline: none !important;
        }
        .theme-ocean .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Sunset Theme Styles */
        .theme-sunset {
            --bg-color: #2b0a1a; /* dark wine */
            --card-bg-color: #3a0e22; /* deeper rose */
            --text-color: #ffe4e6; /* rose-100 */
            --subtle-text-color: #fecdd3; /* pink-200 */
            --border-color: #7f1d1d; /* red-900 */
            --accent-color: #fb7185; /* rose-400 */
            --accent-hover-color: #f43f5e; /* rose-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-sunset body, .theme-sunset .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-sunset .bg-white, .theme-sunset .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-sunset .shadow-sm, .theme-sunset .shadow-md, .theme-sunset .shadow-lg, .theme-sunset .shadow-xl {
             box-shadow: 0 2px 6px 0 rgba(244, 63, 94, 0.15) !important;
             border: 1px solid var(--border-color);
        }
        .theme-sunset .rounded-lg { border-radius: 10px !important; }
        .theme-sunset .rounded-md { border-radius: 6px !important; }
        .theme-sunset .border, .theme-sunset .border-gray-300, .theme-sunset .border-gray-200, .theme-sunset .divide-y > :not([hidden]) ~ :not([hidden]), .theme-sunset .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-sunset .text-gray-900, .theme-sunset .text-gray-800, .theme-sunset .text-gray-700 { color: var(--text-color) !important; }
        .theme-sunset .text-gray-600, .theme-sunset .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-sunset .text-blue-600 { color: var(--accent-color) !important; }
        .theme-sunset .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-sunset .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-sunset input, .theme-sunset select, .theme-sunset textarea {
            background-color: var(--card-bg-color) !important;
            border-radius: 6px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-sunset input:focus, .theme-sunset select:focus, .theme-sunset textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(251, 113, 133, 0.25) !important;
            outline: none !important;
        }
        .theme-sunset .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Midnight Theme Styles */
        .theme-midnight {
            --bg-color: #0a0a0f; /* near black */
            --card-bg-color: #14141f; /* dark indigo */
            --text-color: #e5e7eb; /* gray-200 */
            --subtle-text-color: #9ca3af; /* gray-400 */
            --border-color: #1f2937; /* gray-800 */
            --accent-color: #8b5cf6; /* violet-500 */
            --accent-hover-color: #7c3aed; /* violet-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-midnight body, .theme-midnight .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-midnight .bg-white, .theme-midnight .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-midnight .shadow-sm, .theme-midnight .shadow-md, .theme-midnight .shadow-lg, .theme-midnight .shadow-xl {
             box-shadow: 0 1px 3px rgba(0,0,0,0.4) !important;
             border: 1px solid var(--border-color);
        }
        .theme-midnight .rounded-lg, .theme-midnight .rounded-md { border-radius: 6px !important; }
        .theme-midnight .border, .theme-midnight .border-gray-300, .theme-midnight .border-gray-200, .theme-midnight .divide-y > :not([hidden]) ~ :not([hidden]), .theme-midnight .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-midnight .text-gray-900, .theme-midnight .text-gray-800, .theme-midnight .text-gray-700 { color: var(--text-color) !important; }
        .theme-midnight .text-gray-600, .theme-midnight .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-midnight .text-blue-600 { color: var(--accent-color) !important; }
        .theme-midnight .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-midnight .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-midnight input, .theme-midnight select, .theme-midnight textarea {
            background-color: var(--card-bg-color) !important;
            border-radius: 6px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-midnight input:focus, .theme-midnight select:focus, .theme-midnight textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25) !important;
            outline: none !important;
        }
        .theme-midnight .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Sakura Theme Styles */
        .theme-sakura {
            --bg-color: #fff1f2; /* rose-50 */
            --card-bg-color: #ffe4e6; /* rose-100 */
            --text-color: #3f1d2b; /* plum */
            --subtle-text-color: #9f1239; /* rose-800 */
            --border-color: #fecdd3; /* pink-200 */
            --accent-color: #f472b6; /* pink-400 */
            --accent-hover-color: #ec4899; /* pink-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-sakura body, .theme-sakura .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-sakura .bg-white, .theme-sakura .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-sakura .shadow-sm, .theme-sakura .shadow-md, .theme-sakura .shadow-lg, .theme-sakura .shadow-xl {
             box-shadow: 0 2px 4px 0 rgba(244, 114, 182, 0.15) !important;
             border: 1px solid var(--border-color);
        }
        .theme-sakura .rounded-lg { border-radius: 10px !important; }
        .theme-sakura .rounded-md { border-radius: 6px !important; }
        .theme-sakura .border, .theme-sakura .border-gray-300, .theme-sakura .border-gray-200, .theme-sakura .divide-y > :not([hidden]) ~ :not([hidden]), .theme-sakura .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-sakura .text-gray-900, .theme-sakura .text-gray-800, .theme-sakura .text-gray-700 { color: var(--text-color) !important; }
        .theme-sakura .text-gray-600, .theme-sakura .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-sakura .text-blue-600 { color: var(--accent-color) !important; }
        .theme-sakura .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-sakura .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-sakura input, .theme-sakura select, .theme-sakura textarea {
            background-color: #fff7f8 !important;
            border-radius: 8px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-sakura input:focus, .theme-sakura select:focus, .theme-sakura textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(244, 114, 182, 0.25) !important;
            outline: none !important;
        }
        .theme-sakura .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Nord Theme */
        .theme-nord {
            --bg-color: #2e3440; /* nord0 */
            --card-bg-color: #3b4252; /* nord1 */
            --text-color: #eceff4; /* nord6 */
            --subtle-text-color: #a3be8c; /* nord14 */
            --border-color: #434c5e; /* nord2 */
            --accent-color: #88c0d0; /* nord8 */
            --accent-hover-color: #81a1c1; /* nord9 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-nord body, .theme-nord .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-nord .bg-white, .theme-nord .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-nord .shadow-sm, .theme-nord .shadow-md, .theme-nord .shadow-lg, .theme-nord .shadow-xl { box-shadow: 0 2px 6px rgba(129,161,193,0.15) !important; border: 1px solid var(--border-color); }
        .theme-nord .rounded-lg, .theme-nord .rounded-md { border-radius: 8px !important; }
        .theme-nord .border, .theme-nord .border-gray-300, .theme-nord .border-gray-200, .theme-nord .divide-y > :not([hidden]) ~ :not([hidden]), .theme-nord .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-nord .text-gray-900, .theme-nord .text-gray-800, .theme-nord .text-gray-700 { color: var(--text-color) !important; }
        .theme-nord .text-gray-600, .theme-nord .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-nord .text-blue-600 { color: var(--accent-color) !important; }
        .theme-nord .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-nord .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-nord input, .theme-nord select, .theme-nord textarea { background-color: var(--card-bg-color) !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-nord input:focus, .theme-nord select:focus, .theme-nord textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(136, 192, 208, 0.25) !important; outline: none !important; }
        .theme-nord .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Latte Theme */
        .theme-latte {
            --bg-color: #faf3e0; /* warm beige */
            --card-bg-color: #fffaf0; /* ivory */
            --text-color: #3f2e1e; /* coffee */
            --subtle-text-color: #b08968; /* caramel */
            --border-color: #f1e3c6; /* light beige */
            --accent-color: #d97706; /* amber-600 */
            --accent-hover-color: #b45309; /* amber-700 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-latte body, .theme-latte .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-latte .bg-white, .theme-latte .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-latte .shadow-sm, .theme-latte .shadow-md, .theme-latte .shadow-lg, .theme-latte .shadow-xl { box-shadow: 0 2px 4px rgba(217,119,6,0.08) !important; border: 1px solid var(--border-color); }
        .theme-latte .rounded-lg, .theme-latte .rounded-md { border-radius: 10px !important; }
        .theme-latte .border, .theme-latte .border-gray-300, .theme-latte .border-gray-200, .theme-latte .divide-y > :not([hidden]) ~ :not([hidden]), .theme-latte .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-latte .text-gray-900, .theme-latte .text-gray-800, .theme-latte .text-gray-700 { color: var(--text-color) !important; }
        .theme-latte .text-gray-600, .theme-latte .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-latte .text-blue-600 { color: var(--accent-color) !important; }
        .theme-latte .bg-blue-600 { background-color: var(--accent-color) !important; color: #fff !important; }
        .theme-latte .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-latte input, .theme-latte select, .theme-latte textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-latte input:focus, .theme-latte select:focus, .theme-latte textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.2) !important; outline: none !important; }
        .theme-latte .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Mint Theme */
        .theme-mint {
            --bg-color: #f0fdf4; /* green-50 */
            --card-bg-color: #ffffff;
            --text-color: #064e3b; /* emerald-900 */
            --subtle-text-color: #10b981; /* emerald-500 */
            --border-color: #bbf7d0; /* green-200 */
            --accent-color: #34d399; /* emerald-400 */
            --accent-hover-color: #10b981; /* emerald-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-mint body, .theme-mint .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-mint .bg-white, .theme-mint .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-mint .shadow-sm, .theme-mint .shadow-md, .theme-mint .shadow-lg, .theme-mint .shadow-xl { box-shadow: 0 1px 3px rgba(16,185,129,0.12) !important; border: 1px solid var(--border-color); }
        .theme-mint .rounded-lg, .theme-mint .rounded-md { border-radius: 10px !important; }
        .theme-mint .border, .theme-mint .border-gray-300, .theme-mint .border-gray-200, .theme-mint .divide-y > :not([hidden]) ~ :not([hidden]), .theme-mint .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-mint .text-gray-900, .theme-mint .text-gray-800, .theme-mint .text-gray-700 { color: var(--text-color) 
            !important; }
        .theme-mint .text-gray-600, .theme-mint .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-mint .text-blue-600 { color: var(--accent-color) !important; }
        .theme-mint .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-mint .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-mint input, .theme-mint select, .theme-mint textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-mint input:focus, .theme-mint select:focus, .theme-mint textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.25) !important; outline: none !important; }
        .theme-mint .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Solar Theme */
        .theme-solar {
            --bg-color: #fffbea; /* warm light */
            --card-bg-color: #fffef3; /* near white */
            --text-color: #7c2d12; /* amber-900 */
            --subtle-text-color: #f59e0b; /* amber-500 */
            --border-color: #fde68a; /* amber-200 */
            --accent-color: #fb923c; /* orange-400 */
            --accent-hover-color: #f97316; /* orange-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-solar body, .theme-solar .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-solar .bg-white, .theme-solar .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-solar .shadow-sm, .theme-solar .shadow-md, .theme-solar .shadow-lg, .theme-solar .shadow-xl { box-shadow: 0 2px 4px rgba(249,115,22,0.12) !important; border: 1px solid var(--border-color); }
        .theme-solar .rounded-lg, .theme-solar .rounded-md { border-radius: 8px !important; }
        .theme-solar .border, .theme-solar .border-gray-300, .theme-solar .border-gray-200, .theme-solar .divide-y > :not([hidden]) ~ :not([hidden]), .theme-solar .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-solar .text-gray-900, .theme-solar .text-gray-800, .theme-solar .text-gray-700 { color: var(--text-color) !important; }
        .theme-solar .text-gray-600, .theme-solar .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-solar .text-blue-600 { color: var(--accent-color) !important; }
        .theme-solar .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-solar .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-solar input, .theme-solar select, .theme-solar textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-solar input:focus, .theme-solar select:focus, .theme-solar textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.25) !important; outline: none !important; }
        .theme-solar .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Slate Theme */
        .theme-slate {
            --bg-color: #111827; /* gray-900 */
            --card-bg-color: #1f2937; /* gray-800 */
            --text-color: #e5e7eb; /* gray-200 */
            --subtle-text-color: #9ca3af; /* gray-400 */
            --border-color: #374151; /* gray-700 */
            --accent-color: #60a5fa; /* blue-400 */
            --accent-hover-color: #3b82f6; /* blue-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-slate body, .theme-slate .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-slate .bg-white, .theme-slate .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-slate .shadow-sm, .theme-slate .shadow-md, .theme-slate .shadow-lg, .theme-slate .shadow-xl { box-shadow: 0 1px 3px rgba(0,0,0,0.35) !important; border: 1px solid var(--border-color); }
        .theme-slate .rounded-lg, .theme-slate .rounded-md { border-radius: 6px !important; }
        .theme-slate .border, .theme-slate .border-gray-300, .theme-slate .border-gray-200, .theme-slate .divide-y > :not([hidden]) ~ :not([hidden]), .theme-slate .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-slate .text-gray-900, .theme-slate .text-gray-800, .theme-slate .text-gray-700 { color: var(--text-color) !important; }
        .theme-slate .text-gray-600, .theme-slate .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-slate .text-blue-600 { color: var(--accent-color) !important; }
        .theme-slate .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-slate .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-slate input, .theme-slate select, .theme-slate textarea { background-color: var(--card-bg-color) !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-slate input:focus, .theme-slate select:focus, .theme-slate textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.25) !important; outline: none !important; }
        .theme-slate .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Metro Theme */
        .theme-metro {
            --bg-color: #f3f4f6; /* gray-100 */
            --card-bg-color: #ffffff;
            --text-color: #111827; /* gray-900 */
            --subtle-text-color: #6b7280; /* gray-500 */
            --border-color: #e5e7eb; /* gray-200 */
            --accent-color: #2563eb; /* blue-600 */
            --accent-hover-color: #1d4ed8; /* blue-700 */
            --font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            font-family: var(--font-family) !important;
        }
        .theme-metro body, .theme-metro .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-metro .bg-white, .theme-metro .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-metro .shadow-sm, .theme-metro .shadow-md, .theme-metro .shadow-lg, .theme-metro .shadow-xl { box-shadow: 0 1px 2px rgba(0,0,0,0.06) !important; border: 1px solid var(--border-color); }
        .theme-metro .rounded-lg, .theme-metro .rounded-md { border-radius: 4px !important; }
        .theme-metro .border, .theme-metro .divide-y > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-metro .text-blue-600 { color: var(--accent-color) !important; }
        .theme-metro .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-metro .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-metro input, .theme-metro select, .theme-metro textarea { background-color: #f9fafb !important; border-radius: 4px !important; border: 1px solid var(--border-color) !important; }
        .theme-metro input:focus, .theme-metro select:focus, .theme-metro textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2) !important; outline: none !important; }
        .theme-metro .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Pastel Theme */
        .theme-pastel {
            --bg-color: #faf5ff; /* violet-50 */
            --card-bg-color: #ffffff;
            --text-color: #292524; /* stone-800 */
            --subtle-text-color: #6d6875; /* pastel gray */
            --border-color: #e9d5ff; /* violet-200 */
            --accent-color: #a78bfa; /* violet-400 */
            --accent-hover-color: #8b5cf6; /* violet-500 */
            --font-family: 'Noto Sans TC', sans-serif;

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            font-family: var(--font-family) !important;
        }
        .theme-pastel body, .theme-pastel .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-pastel .bg-white, .theme-pastel .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-pastel .shadow-sm, .theme-pastel .shadow-md, .theme-pastel .shadow-lg, .theme-pastel .shadow-xl { box-shadow: 0 2px 6px rgba(167,139,250,0.12) !important; border: 1px solid var(--border-color); }
        .theme-pastel .rounded-lg { border-radius: 12px !important; }
        .theme-pastel .rounded-md { border-radius: 8px !important; }
        .theme-pastel .text-blue-600 { color: var(--accent-color) !important; }
        .theme-pastel .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-pastel .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-pastel input, .theme-pastel select, .theme-pastel textarea { background-color: #ffffff !important; border-radius: 10px !important; border: 1px solid var(--border-color) !important; }
        .theme-pastel input:focus, .theme-pastel select:focus, .theme-pastel textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(167,139,250,0.25) !important; outline: none !important; }
        .theme-pastel .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Neon Theme */
        .theme-neon {
            --bg-color: #0a0a0a;
            --card-bg-color: #111827; /* gray-900 */
            --text-color: #e2e8f0; /* slate-200 */
            --subtle-text-color: #34d399; /* emerald-400 */
            --border-color: #1f2937; /* gray-800 */
            --accent-color: #22d3ee; /* cyan-400 */
            --accent-hover-color: #06b6d4; /* cyan-500 */
            --font-family: 'Orbitron', sans-serif;

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            font-family: var(--font-family) !important;
        }
        .theme-neon body, .theme-neon .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-neon .bg-white, .theme-neon .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-neon .shadow-sm, .theme-neon .shadow-md, .theme-neon .shadow-lg, .theme-neon .shadow-xl { box-shadow: 0 0 20px rgba(34, 211, 238, 0.12), 0 0 6px rgba(34, 211, 238, 0.08) !important; border: 1px solid var(--border-color); }
        .theme-neon .rounded-lg, .theme-neon .rounded-md { border-radius: 4px !important; }
        .theme-neon .text-blue-600 { color: var(--accent-color) !important; }
        .theme-neon .bg-blue-600 { background-color: var(--accent-color) !important; color: #0a0a0a !important; }
        .theme-neon .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-neon input, .theme-neon select, .theme-neon textarea { background-color: #0a0a0a !important; border-radius: 4px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-neon input:focus, .theme-neon select:focus, .theme-neon textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.3) !important; outline: none !important; }
        .theme-neon .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Retro Theme */
        .theme-retro {
            --bg-color: #fff7ed; /* orange-50 */
            --card-bg-color: #fef3c7; /* amber-100 */
            --text-color: #1f2937; /* slate-800 */
            --subtle-text-color: #b45309; /* amber-700 */
            --border-color: #fcd34d; /* amber-300 */
            --accent-color: #d97706; /* amber-600 */
            --accent-hover-color: #b45309; /* amber-700 */
            --font-family: 'Montserrat', sans-serif;

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            font-family: var(--font-family) !important;
        }
        .theme-retro body, .theme-retro .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-retro .bg-white, .theme-retro .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-retro .shadow-sm, .theme-retro .shadow-md, .theme-retro .shadow-lg, .theme-retro .shadow-xl { box-shadow: 0 2px 4px rgba(217,119,6,0.12) !important; border: 1px solid var(--border-color); }
        .theme-retro .rounded-lg { border-radius: 12px !important; }
        .theme-retro .rounded-md { border-radius: 8px !important; }
        .theme-retro .text-blue-600 { color: var(--accent-color) !important; }
        .theme-retro .bg-blue-600 { background-color: var(--accent-color) !important; color: #fff !important; }
        .theme-retro .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-retro input, .theme-retro select, .theme-retro textarea { background-color: #fffdf5 !important; border-radius: 10px !important; border: 1px solid var(--border-color) !important; }
        .theme-retro input:focus, .theme-retro select:focus, .theme-retro textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.25) !important; outline: none !important; }
        .theme-retro .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Minimal Theme */
        .theme-minimal {
            --bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-color: #111827; /* gray-900 */
            --subtle-text-color: #6b7280; /* gray-500 */
            --border-color: #e5e7eb; /* gray-200 */
            --accent-color: #111827; /* gray-900 */
            --accent-hover-color: #000000; /* black */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            font-family: var(--font-family) !important;
        }
        .theme-minimal body, .theme-minimal .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-minimal .bg-white, .theme-minimal .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-minimal .shadow-sm, .theme-minimal .shadow-md, .theme-minimal .shadow-lg, .theme-minimal .shadow-xl { box-shadow: none !important; border: 1px solid var(--border-color); }
        .theme-minimal .rounded-lg, .theme-minimal .rounded-md { border-radius: 0 !important; }
        .theme-minimal .text-blue-600 { color: var(--accent-color) !important; }
        .theme-minimal .bg-blue-600 { background-color: var(--accent-color) !important; color: #fff !important; }
        .theme-minimal .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-minimal input, .theme-minimal select, .theme-minimal textarea { background-color: #ffffff !important; border-radius: 0 !important; border: 1px solid var(--border-color) !important; }
        .theme-minimal input:focus, .theme-minimal select:focus, .theme-minimal textarea:focus { border-color: var(--accent-color) !important; box-shadow: none !important; outline: none !important; }
        .theme-minimal .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; border-bottom-width: 2px !important; }

        /* Paper Theme */
        .theme-paper {
            --bg-color: #fefcf3; /* paper */
            --card-bg-color: #ffffff;
            --text-color: #1f2937; /* slate-800 */
            --subtle-text-color: #6b7280; /* gray-500 */
            --border-color: #f3e8ff; /* violet-100 */
            --accent-color: #16a34a; /* green-600 */
            --accent-hover-color: #15803d; /* green-700 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-paper body, .theme-paper .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-paper .bg-white, .theme-paper .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-paper .shadow-sm, .theme-paper .shadow-md, .theme-paper .shadow-lg, .theme-paper .shadow-xl { box-shadow: 0 2px 4px rgba(0,0,0,0.06) !important; border: 1px solid var(--border-color); }
        .theme-paper .rounded-lg, .theme-paper .rounded-md { border-radius: 8px !important; }
        .theme-paper .text-blue-600 { color: var(--accent-color) !important; }
        .theme-paper .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-paper .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-paper input, .theme-paper select, .theme-paper textarea { background-color: #ffffff !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; }
        .theme-paper input:focus, .theme-paper select:focus, .theme-paper textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.2) !important; outline: none !important; }
        .theme-paper .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Grape Theme */
        .theme-grape {
            --bg-color: #faf5ff; /* violet-50 */
            --card-bg-color: #f5f3ff; /* violet-100 */
            --text-color: #1f2937; /* slate-800 */
            --subtle-text-color: #7c3aed; /* violet-600 */
            --border-color: #ddd6fe; /* violet-200 */
            --accent-color: #8b5cf6; /* violet-500 */
            --accent-hover-color: #7c3aed; /* violet-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-grape body, .theme-grape .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-grape .bg-white, .theme-grape .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-grape .shadow-sm, .theme-grape .shadow-md, .theme-grape .shadow-lg, .theme-grape .shadow-xl { box-shadow: 0 2px 6px rgba(139,92,246,0.12) !important; border: 1px solid var(--border-color); }
        .theme-grape .rounded-lg, .theme-grape .rounded-md { border-radius: 8px !important; }
        .theme-grape .text-blue-600 { color: var(--accent-color) !important; }
        .theme-grape .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-grape .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-grape input, .theme-grape select, .theme-grape textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; }
        .theme-grape input:focus, .theme-grape select:focus, .theme-grape textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25) !important; outline: none !important; }
        .theme-grape .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Cobalt Theme */
        .theme-cobalt {
            --bg-color: #0b1020; /* deep navy */
            --card-bg-color: #0f1b2d; /* cobalt deep */
            --text-color: #e2e8f0; /* slate-200 */
            --subtle-text-color: #60a5fa; /* blue-400 */
            --border-color: #1e3a8a; /* indigo-800 */
            --accent-color: #3b82f6; /* blue-500 */
            --accent-hover-color: #2563eb; /* blue-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-cobalt body, .theme-cobalt .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-cobalt .bg-white, .theme-cobalt .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-cobalt .shadow-sm, .theme-cobalt .shadow-md, .theme-cobalt .shadow-lg, .theme-cobalt .shadow-xl { box-shadow: 0 0 16px rgba(59,130,246,0.10) !important; border: 1px solid var(--border-color); }
        .theme-cobalt .rounded-lg, .theme-cobalt .rounded-md { border-radius: 6px !important; }
        .theme-cobalt .text-blue-600 { color: var(--accent-color) !important; }
        .theme-cobalt .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-cobalt .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-cobalt input, .theme-cobalt select, .theme-cobalt textarea { background-color: #0f1b2d !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-cobalt input:focus, .theme-cobalt select:focus, .theme-cobalt textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(59,130,246,0.25) !important; outline: none !important; }
        .theme-cobalt .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Sand Theme */
        .theme-sand {
            --bg-color: #fdf6e3; /* sand */
            --card-bg-color: #fffaf0; /* ivory */
            --text-color: #3f2d1c; /* warm brown */
            --subtle-text-color: #b08968; /* caramel */
            --border-color: #f1e3c6; /* light beige */
            --accent-color: #eab308; /* amber-500 */
            --accent-hover-color: #ca8a04; /* amber-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-sand body, .theme-sand .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-sand .bg-white, .theme-sand .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-sand .shadow-sm, .theme-sand .shadow-md, .theme-sand .shadow-lg, .theme-sand .shadow-xl { box-shadow: 0 2px 4px rgba(202,138,4,0.10) !important; border: 1px solid var(--border-color); }
        .theme-sand .rounded-lg, .theme-sand .rounded-md { border-radius: 10px !important; }
        .theme-sand .text-blue-600 { color: var(--accent-color) !important; }
        .theme-sand .bg-blue-600 { background-color: var(--accent-color) !important; color: #111827 !important; }
        .theme-sand .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-sand input, .theme-sand select, .theme-sand textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; }
        .theme-sand input:focus, .theme-sand select:focus, .theme-sand textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(234,179,8,0.25) !important; outline: none !important; }
        .theme-sand .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Rosewood Theme */
        .theme-rosewood {
            --bg-color: #1b0a0a; /* deep burgundy */
            --card-bg-color: #2a0f0f; /* darker burgundy */
            --text-color: #fde2e2; /* rose-100 */
            --subtle-text-color: #fecaca; /* rose-200 */
            --border-color: #7f1d1d; /* red-900 */
            --accent-color: #f87171; /* red-400 */
            --accent-hover-color: #ef4444; /* red-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-rosewood body, .theme-rosewood .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-rosewood .bg-white, .theme-rosewood .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-rosewood .shadow-sm, .theme-rosewood .shadow-md, .theme-rosewood .shadow-lg, .theme-rosewood .shadow-xl { box-shadow: 0 2px 6px rgba(239,68,68,0.12) !important; border: 1px solid var(--border-color); }
        .theme-rosewood .rounded-lg, .theme-rosewood .rounded-md { border-radius: 8px !important; }
        .theme-rosewood .text-blue-600 { color: var(--accent-color) !important; }
        .theme-rosewood .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-rosewood .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-rosewood input, .theme-rosewood select, .theme-rosewood textarea { background-color: #2a0f0f !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-rosewood input:focus, .theme-rosewood select:focus, .theme-rosewood textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(248,113,113,0.25) !important; outline: none !important; }
        .theme-rosewood .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Blossom Theme */
        .theme-blossom {
            --bg-color: #fff7fb; /* pink tint */
            --card-bg-color: #fff0f6; /* lighter pink */
            --text-color: #3f1d2b; /* plum */
            --subtle-text-color: #e879f9; /* fuchsia-400 */
            --border-color: #fbcfe8; /* pink-200 */
            --accent-color: #f472b6; /* pink-400 */
            --accent-hover-color: #ec4899; /* pink-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-blossom body, .theme-blossom .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-blossom .bg-white, .theme-blossom .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-blossom .shadow-sm, .theme-blossom .shadow-md, .theme-blossom .shadow-lg, .theme-blossom .shadow-xl { box-shadow: 0 2px 4px rgba(236,72,153,0.12) !important; border: 1px solid var(--border-color); }
        .theme-blossom .rounded-lg, .theme-blossom .rounded-md { border-radius: 10px !important; }
        .theme-blossom .text-blue-600 { color: var(--accent-color) !important; }
        .theme-blossom .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-blossom .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-blossom input, .theme-blossom select, .theme-blossom textarea { background-color: #fff7fb !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; }
        .theme-blossom input:focus, .theme-blossom select:focus, .theme-blossom textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(244, 114, 182, 0.25) !important; outline: none !important; }
        .theme-blossom .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Jade Theme */
        .theme-jade {
            --bg-color: #ecfdf5; /* emerald-50 */
            --card-bg-color: #f0fdf4; /* green-50 */
            --text-color: #064e3b; /* emerald-900 */
            --subtle-text-color: #10b981; /* emerald-500 */
            --border-color: #d1fae5; /* emerald-200 */
            --accent-color: #22c55e; /* green-500 */
            --accent-hover-color: #16a34a; /* green-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-jade body, .theme-jade .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-jade .bg-white, .theme-jade .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-jade .shadow-sm, .theme-jade .shadow-md, .theme-jade .shadow-lg, .theme-jade .shadow-xl { box-shadow: 0 2px 4px rgba(34,197,94,0.10) !important; border: 1px solid var(--border-color); }
        .theme-jade .rounded-lg, .theme-jade .rounded-md { border-radius: 10px !important; }
        .theme-jade .text-blue-600 { color: var(--accent-color) !important; }
        .theme-jade .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-jade .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-jade input, .theme-jade select, .theme-jade textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; }
        .theme-jade input:focus, .theme-jade select:focus, .theme-jade textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(34,197,94,0.25) !important; outline: none !important; }
        .theme-jade .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Cinder Theme */
        .theme-cinder {
            --bg-color: #0f0f10; /* near black */
            --card-bg-color: #16161a; /* dark graphite */
            --text-color: #e5e7eb; /* gray-200 */
            --subtle-text-color: #9ca3af; /* gray-400 */
            --border-color: #27272a; /* zinc-800 */
            --accent-color: #fbbf24; /* amber-400 */
            --accent-hover-color: #f59e0b; /* amber-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-cinder body, .theme-cinder .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-cinder .bg-white, .theme-cinder .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-cinder .shadow-sm, .theme-cinder .shadow-md, .theme-cinder .shadow-lg, .theme-cinder .shadow-xl { box-shadow: 0 1px 3px rgba(0,0,0,0.4) !important; border: 1px solid var(--border-color); }
        .theme-cinder .rounded-lg, .theme-cinder .rounded-md { border-radius: 6px !important; }
        .theme-cinder .text-blue-600 { color: var(--accent-color) !important; }
        .theme-cinder .bg-blue-600 { background-color: var(--accent-color) !important; color: #111827 !important; }
        .theme-cinder .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-cinder input, .theme-cinder select, .theme-cinder textarea { background-color: #16161a !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-cinder input:focus, .theme-cinder select:focus, .theme-cinder textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(251,191,36,0.25) !important; outline: none !important; }
        .theme-cinder .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

    /* === Extra 30 Themes === */
    /* Aurora */
    .theme-aurora { --bg-color:#0b1220; --card-bg-color:#102336; --text-color:#e6fffb; --subtle-text-color:#6ee7b7; --border-color:#1e3a8a; --accent-color:#34d399; --accent-hover-color:#10b981; }
    .theme-aurora body, .theme-aurora .bg-gray-50 { background-color: var(--bg-color) !important; }
    .theme-aurora .bg-white, .theme-aurora .bg-gray-100 { background-color: var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-aurora .shadow-sm, .theme-aurora .shadow-md, .theme-aurora .shadow-lg, .theme-aurora .shadow-xl { box-shadow:0 0 16px rgba(52,211,153,.1) !important; border:1px solid var(--border-color); }
    .theme-aurora .rounded-lg, .theme-aurora .rounded-md { border-radius:8px !important; }
    .theme-aurora .border, .theme-aurora .divide-y > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
    .theme-aurora .text-blue-600 { color: var(--accent-color) !important; }
    .theme-aurora .bg-blue-600 { background-color: var(--accent-color) !important; }
    .theme-aurora .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
    .theme-aurora input, .theme-aurora select, .theme-aurora textarea { background:#0b1220 !important; border:1px solid var(--border-color) !important; color:var(--text-color) !important; border-radius:6px !important; }
    .theme-aurora input:focus, .theme-aurora select:focus, .theme-aurora textarea:focus { border-color: var(--accent-color) !important; box-shadow:0 0 0 2px rgba(52,211,153,.25) !important; outline:none !important; }
    .theme-aurora .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

    /* Cocoa */
    .theme-cocoa { --bg-color:#f7efe7; --card-bg-color:#fffaf5; --text-color:#3e2c20; --subtle-text-color:#a16207; --border-color:#f3e0d0; --accent-color:#b45309; --accent-hover-color:#92400e; }
    .theme-cocoa body, .theme-cocoa .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-cocoa .bg-white, .theme-cocoa .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-cocoa .shadow-sm, .theme-cocoa .shadow-md, .theme-cocoa .shadow-lg, .theme-cocoa .shadow-xl { box-shadow:0 2px 4px rgba(180,83,9,.08) !important; border:1px solid var(--border-color); }
    .theme-cocoa .rounded-lg, .theme-cocoa .rounded-md { border-radius:10px !important; }
    .theme-cocoa .border, .theme-cocoa .divide-y > :not([hidden]) ~ :not([hidden]) { border-color:var(--border-color) !important; }
    .theme-cocoa .text-blue-600 { color: var(--accent-color) !important; }
    .theme-cocoa .bg-blue-600 { background: var(--accent-color) !important; color:#fff !important; }
    .theme-cocoa .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-cocoa input, .theme-cocoa select, .theme-cocoa textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; color:var(--text-color) !important; }
    .theme-cocoa input:focus, .theme-cocoa select:focus, .theme-cocoa textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(180,83,9,.2) !important; outline:none !important; }
    .theme-cocoa .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Denim */
    .theme-denim { --bg-color:#eaf2ff; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#1d4ed8; --border-color:#bfdbfe; --accent-color:#2563eb; --accent-hover-color:#1d4ed8; }
    .theme-denim body, .theme-denim .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-denim .bg-white, .theme-denim .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-denim .shadow-sm, .theme-denim .shadow-md, .theme-denim .shadow-lg, .theme-denim .shadow-xl { box-shadow:0 1px 3px rgba(37,99,235,.12) !important; border:1px solid var(--border-color); }
    .theme-denim .rounded-lg, .theme-denim .rounded-md { border-radius:8px !important; }
    .theme-denim .border, .theme-denim .divide-y > :not([hidden]) ~ :not([hidden]) { border-color:var(--border-color) !important; }
    .theme-denim .text-blue-600 { color: var(--accent-color) !important; }
    .theme-denim .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-denim .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-denim input, .theme-denim select, .theme-denim textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:6px !important; }
    .theme-denim input:focus, .theme-denim select:focus, .theme-denim textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(37,99,235,.2) !important; outline:none !important; }
    .theme-denim .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Lime */
    .theme-lime { --bg-color:#f7fee7; --card-bg-color:#ffffff; --text-color:#1a2e05; --subtle-text-color:#84cc16; --border-color:#d9f99d; --accent-color:#65a30d; --accent-hover-color:#4d7c0f; }
    .theme-lime body, .theme-lime .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-lime .bg-white, .theme-lime .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-lime .shadow-sm, .theme-lime .shadow-md, .theme-lime .shadow-lg, .theme-lime .shadow-xl { box-shadow:0 1px 3px rgba(101,163,13,.12) !important; border:1px solid var(--border-color); }
    .theme-lime .rounded-lg, .theme-lime .rounded-md { border-radius:8px !important; }
    .theme-lime .text-blue-600 { color: var(--accent-color) !important; }
    .theme-lime .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-lime .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-lime input, .theme-lime select, .theme-lime textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-lime input:focus, .theme-lime select:focus, .theme-lime textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(101,163,13,.22) !important; outline:none !important; }
    .theme-lime .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Coral */
    .theme-coral { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#4a1d1d; --subtle-text-color:#fb7185; --border-color:#fecdd3; --accent-color:#f43f5e; --accent-hover-color:#e11d48; }
    .theme-coral body, .theme-coral .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-coral .bg-white, .theme-coral .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-coral .shadow-sm, .theme-coral .shadow-md, .theme-coral .shadow-lg, .theme-coral .shadow-xl { box-shadow:0 2px 6px rgba(244,63,94,.12) !important; border:1px solid var(--border-color); }
    .theme-coral .rounded-lg, .theme-coral .rounded-md { border-radius:10px !important; }
    .theme-coral .text-blue-600 { color: var(--accent-color) !important; }
    .theme-coral .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-coral .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-coral input, .theme-coral select, .theme-coral textarea { background:#fff7f8 !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-coral input:focus, .theme-coral select:focus, .theme-coral textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(244,63,94,.22) !important; outline:none !important; }
    .theme-coral .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Plum */
    .theme-plum { --bg-color:#faf5ff; --card-bg-color:#ffffff; --text-color:#2e1065; --subtle-text-color:#a78bfa; --border-color:#e9d5ff; --accent-color:#8b5cf6; --accent-hover-color:#7c3aed; }
    .theme-plum body, .theme-plum .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-plum .bg-white, .theme-plum .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-plum .shadow-sm, .theme-plum .shadow-md, .theme-plum .shadow-lg, .theme-plum .shadow-xl { box-shadow:0 2px 6px rgba(139,92,246,.12) !important; border:1px solid var(--border-color); }
    .theme-plum .rounded-lg, .theme-plum .rounded-md { border-radius:8px !important; }
    .theme-plum .text-blue-600 { color: var(--accent-color) !important; }
    .theme-plum .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-plum .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-plum input, .theme-plum select, .theme-plum textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-plum input:focus, .theme-plum select:focus, .theme-plum textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(139,92,246,.22) !important; outline:none !important; }
    .theme-plum .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Sky */
    .theme-sky { --bg-color:#e0f2fe; --card-bg-color:#ffffff; --text-color:#0c4a6e; --subtle-text-color:#38bdf8; --border-color:#bae6fd; --accent-color:#0ea5e9; --accent-hover-color:#0284c7; }
    .theme-sky body, .theme-sky .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-sky .bg-white, .theme-sky .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-sky .shadow-sm, .theme-sky .shadow-md, .theme-sky .shadow-lg, .theme-sky .shadow-xl { box-shadow:0 1px 3px rgba(14,165,233,.12) !important; border:1px solid var(--border-color); }
    .theme-sky .rounded-lg, .theme-sky .rounded-md { border-radius:8px !important; }
    .theme-sky .text-blue-600 { color: var(--accent-color) !important; }
    .theme-sky .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-sky .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-sky input, .theme-sky select, .theme-sky textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-sky input:focus, .theme-sky select:focus, .theme-sky textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(14,165,233,.22) !important; outline:none !important; }
    .theme-sky .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Graphite */
    .theme-graphite { --bg-color:#0f1115; --card-bg-color:#181b22; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2b2f37; --accent-color:#60a5fa; --accent-hover-color:#3b82f6; }
    .theme-graphite body, .theme-graphite .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-graphite .bg-white, .theme-graphite .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-graphite .shadow-sm, .theme-graphite .shadow-md, .theme-graphite .shadow-lg, .theme-graphite .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.35) !important; border:1px solid var(--border-color); }
    .theme-graphite .rounded-lg, .theme-graphite .rounded-md { border-radius:6px !important; }
    .theme-graphite .text-blue-600 { color: var(--accent-color) !important; }
    .theme-graphite .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-graphite .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-graphite input, .theme-graphite select, .theme-graphite textarea { background:#181b22 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-graphite input:focus, .theme-graphite select:focus, .theme-graphite textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(96,165,250,.22) !important; outline:none !important; }
    .theme-graphite .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Pearl */
    .theme-pearl { --bg-color:#fbfbfb; --card-bg-color:#ffffff; --text-color:#111827; --subtle-text-color:#6b7280; --border-color:#e5e7eb; --accent-color:#10b981; --accent-hover-color:#059669; }
    .theme-pearl body, .theme-pearl .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-pearl .bg-white, .theme-pearl .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-pearl .shadow-sm, .theme-pearl .shadow-md, .theme-pearl .shadow-lg, .theme-pearl .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-pearl .rounded-lg, .theme-pearl .rounded-md { border-radius:10px !important; }
    .theme-pearl .text-blue-600 { color: var(--accent-color) !important; }
    .theme-pearl .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-pearl .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-pearl input, .theme-pearl select, .theme-pearl textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-pearl input:focus, .theme-pearl select:focus, .theme-pearl textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(16,185,129,.2) !important; outline:none !important; }
    .theme-pearl .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Rust */
    .theme-rust { --bg-color:#fff7ed; --card-bg-color:#fffbeb; --text-color:#7c2d12; --subtle-text-color:#ea580c; --border-color:#fed7aa; --accent-color:#f97316; --accent-hover-color:#ea580c; }
    .theme-rust body, .theme-rust .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-rust .bg-white, .theme-rust .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-rust .shadow-sm, .theme-rust .shadow-md, .theme-rust .shadow-lg, .theme-rust .shadow-xl { box-shadow:0 1px 3px rgba(249,115,22,.12) !important; border:1px solid var(--border-color); }
    .theme-rust .rounded-lg, .theme-rust .rounded-md { border-radius:8px !important; }
    .theme-rust .text-blue-600 { color: var(--accent-color) !important; }
    .theme-rust .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-rust .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-rust input, .theme-rust select, .theme-rust textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-rust input:focus, .theme-rust select:focus, .theme-rust textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(249,115,22,.22) !important; outline:none !important; }
    .theme-rust .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Berry */
    .theme-berry { --bg-color:#fdf2f8; --card-bg-color:#ffffff; --text-color:#4a044e; --subtle-text-color:#f472b6; --border-color:#fce7f3; --accent-color:#db2777; --accent-hover-color:#be185d; }
    .theme-berry body, .theme-berry .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-berry .bg-white, .theme-berry .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-berry .shadow-sm, .theme-berry .shadow-md, .theme-berry .shadow-lg, .theme-berry .shadow-xl { box-shadow:0 1px 3px rgba(219,39,119,.12) !important; border:1px solid var(--border-color); }
    .theme-berry .rounded-lg, .theme-berry .rounded-md { border-radius:8px !important; }
    .theme-berry .text-blue-600 { color: var(--accent-color) !important; }
    .theme-berry .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-berry .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-berry input, .theme-berry select, .theme-berry textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-berry input:focus, .theme-berry select:focus, .theme-berry textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(219,39,119,.22) !important; outline:none !important; }
    .theme-berry .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Moss */
    .theme-moss { --bg-color:#ecfdf5; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#34d399; --border-color:#d1fae5; --accent-color:#10b981; --accent-hover-color:#059669; }
    .theme-moss body, .theme-moss .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-moss .bg-white, .theme-moss .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-moss .shadow-sm, .theme-moss .shadow-md, .theme-moss .shadow-lg, .theme-moss .shadow-xl { box-shadow:0 1px 3px rgba(16,185,129,.12) !important; border:1px solid var(--border-color); }
    .theme-moss .rounded-lg, .theme-moss .rounded-md { border-radius:10px !important; }
    .theme-moss .text-blue-600 { color: var(--accent-color) !important; }
    .theme-moss .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-moss .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-moss input, .theme-moss select, .theme-moss textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-moss input:focus, .theme-moss select:focus, .theme-moss textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(16,185,129,.22) !important; outline:none !important; }
    .theme-moss .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Teal */
    .theme-teal { --bg-color:#f0fdfa; --card-bg-color:#ffffff; --text-color:#134e4a; --subtle-text-color:#14b8a6; --border-color:#ccfbf1; --accent-color:#0d9488; --accent-hover-color:#0f766e; }
    .theme-teal body, .theme-teal .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-teal .bg-white, .theme-teal .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-teal .shadow-sm, .theme-teal .shadow-md, .theme-teal .shadow-lg, .theme-teal .shadow-xl { box-shadow:0 1px 3px rgba(13,148,136,.12) !important; border:1px solid var(--border-color); }
    .theme-teal .rounded-lg, .theme-teal .rounded-md { border-radius:8px !important; }
    .theme-teal .text-blue-600 { color: var(--accent-color) !important; }
    .theme-teal .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-teal .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-teal input, .theme-teal select, .theme-teal textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-teal input:focus, .theme-teal select:focus, .theme-teal textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(13,148,136,.22) !important; outline:none !important; }
    .theme-teal .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Sepia */
    .theme-sepia { --bg-color:#fdf6e3; --card-bg-color:#fffaf0; --text-color:#3f2d1c; --subtle-text-color:#b08968; --border-color:#f1e3c6; --accent-color:#d97706; --accent-hover-color:#b45309; }
    .theme-sepia body, .theme-sepia .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-sepia .bg-white, .theme-sepia .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-sepia .shadow-sm, .theme-sepia .shadow-md, .theme-sepia .shadow-lg, .theme-sepia .shadow-xl { box-shadow:0 1px 3px rgba(217,119,6,.1) !important; border:1px solid var(--border-color); }
    .theme-sepia .rounded-lg, .theme-sepia .rounded-md { border-radius:10px !important; }
    .theme-sepia .text-blue-600 { color: var(--accent-color) !important; }
    .theme-sepia .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-sepia .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-sepia input, .theme-sepia select, .theme-sepia textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-sepia input:focus, .theme-sepia select:focus, .theme-sepia textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(217,119,6,.22) !important; outline:none !important; }
    .theme-sepia .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Charcoal */
    .theme-charcoal { --bg-color:#0b0c10; --card-bg-color:#151820; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2e3340; --accent-color:#22d3ee; --accent-hover-color:#06b6d4; }
    .theme-charcoal body, .theme-charcoal .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-charcoal .bg-white, .theme-charcoal .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-charcoal .shadow-sm, .theme-charcoal .shadow-md, .theme-charcoal .shadow-lg, .theme-charcoal .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.4) !important; border:1px solid var(--border-color); }
    .theme-charcoal .rounded-lg, .theme-charcoal .rounded-md { border-radius:6px !important; }
    .theme-charcoal .text-blue-600 { color: var(--accent-color) !important; }
    .theme-charcoal .bg-blue-600 { background: var(--accent-color) !important; color:#0b0c10 !important; }
    .theme-charcoal .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-charcoal input, .theme-charcoal select, .theme-charcoal textarea { background:#151820 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-charcoal input:focus, .theme-charcoal select:focus, .theme-charcoal textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(34,211,238,.28) !important; outline:none !important; }
    .theme-charcoal .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Ivory */
    .theme-ivory { --bg-color:#fffef8; --card-bg-color:#ffffff; --text-color:#1f2937; --subtle-text-color:#6b7280; --border-color:#f3f4f6; --accent-color:#0ea5e9; --accent-hover-color:#0284c7; }
    .theme-ivory body, .theme-ivory .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-ivory .bg-white, .theme-ivory .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-ivory .shadow-sm, .theme-ivory .shadow-md, .theme-ivory .shadow-lg, .theme-ivory .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-ivory .rounded-lg, .theme-ivory .rounded-md { border-radius:10px !important; }
    .theme-ivory .text-blue-600 { color: var(--accent-color) !important; }
    .theme-ivory .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-ivory .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-ivory input, .theme-ivory select, .theme-ivory textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-ivory input:focus, .theme-ivory select:focus, .theme-ivory textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(14,165,233,.22) !important; outline:none !important; }
    .theme-ivory .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Azure */
    .theme-azure { --bg-color:#eff6ff; --card-bg-color:#ffffff; --text-color:#0c4a6e; --subtle-text-color:#60a5fa; --border-color:#dbeafe; --accent-color:#3b82f6; --accent-hover-color:#2563eb; }
    .theme-azure body, .theme-azure .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-azure .bg-white, .theme-azure .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-azure .shadow-sm, .theme-azure .shadow-md, .theme-azure .shadow-lg, .theme-azure .shadow-xl { box-shadow:0 1px 3px rgba(59,130,246,.12) !important; border:1px solid var(--border-color); }
    .theme-azure .rounded-lg, .theme-azure .rounded-md { border-radius:8px !important; }
    .theme-azure .text-blue-600 { color: var(--accent-color) !important; }
    .theme-azure .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-azure .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-azure input, .theme-azure select, .theme-azure textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-azure input:focus, .theme-azure select:focus, .theme-azure textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(59,130,246,.22) !important; outline:none !important; }
    .theme-azure .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Blush */
    .theme-blush { --bg-color:#fff1f2; --card-bg-color:#fff7f8; --text-color:#4a1d2b; --subtle-text-color:#f472b6; --border-color:#fecdd3; --accent-color:#ec4899; --accent-hover-color:#db2777; }
    .theme-blush body, .theme-blush .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-blush .bg-white, .theme-blush .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-blush .shadow-sm, .theme-blush .shadow-md, .theme-blush .shadow-lg, .theme-blush .shadow-xl { box-shadow:0 1px 3px rgba(236,72,153,.12) !important; border:1px solid var(--border-color); }
    .theme-blush .rounded-lg, .theme-blush .rounded-md { border-radius:10px !important; }
    .theme-blush .text-blue-600 { color: var(--accent-color) !important; }
    .theme-blush .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-blush .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-blush input, .theme-blush select, .theme-blush textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-blush input:focus, .theme-blush select:focus, .theme-blush textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(236,72,153,.22) !important; outline:none !important; }
    .theme-blush .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Saffron */
    .theme-saffron { --bg-color:#fffbeb; --card-bg-color:#ffffff; --text-color:#7c2d12; --subtle-text-color:#f59e0b; --border-color:#fde68a; --accent-color:#f59e0b; --accent-hover-color:#d97706; }
    .theme-saffron body, .theme-saffron .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-saffron .bg-white, .theme-saffron .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-saffron .shadow-sm, .theme-saffron .shadow-md, .theme-saffron .shadow-lg, .theme-saffron .shadow-xl { box-shadow:0 1px 3px rgba(245,158,11,.12) !important; border:1px solid var(--border-color); }
    .theme-saffron .rounded-lg, .theme-saffron .rounded-md { border-radius:8px !important; }
    .theme-saffron .text-blue-600 { color: var(--accent-color) !important; }
    .theme-saffron .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-saffron .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-saffron input, .theme-saffron select, .theme-saffron textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-saffron input:focus, .theme-saffron select:focus, .theme-saffron textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(245,158,11,.22) !important; outline:none !important; }
    .theme-saffron .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Indigo */
    .theme-indigo { --bg-color:#eef2ff; --card-bg-color:#ffffff; --text-color:#312e81; --subtle-text-color:#6366f1; --border-color:#c7d2fe; --accent-color:#4f46e5; --accent-hover-color:#4338ca; }
    .theme-indigo body, .theme-indigo .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-indigo .bg-white, .theme-indigo .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-indigo .shadow-sm, .theme-indigo .shadow-md, .theme-indigo .shadow-lg, .theme-indigo .shadow-xl { box-shadow:0 1px 3px rgba(79,70,229,.12) !important; border:1px solid var(--border-color); }
    .theme-indigo .rounded-lg, .theme-indigo .rounded-md { border-radius:8px !important; }
    .theme-indigo .text-blue-600 { color: var(--accent-color) !important; }
    .theme-indigo .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-indigo .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-indigo input, .theme-indigo select, .theme-indigo textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-indigo input:focus, .theme-indigo select:focus, .theme-indigo textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(79,70,229,.22) !important; outline:none !important; }
    .theme-indigo .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Copper */
    .theme-copper { --bg-color:#fff7ed; --card-bg-color:#ffffff; --text-color:#4a2c1a; --subtle-text-color:#ea580c; --border-color:#fed7aa; --accent-color:#c2410c; --accent-hover-color:#9a3412; }
    .theme-copper body, .theme-copper .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-copper .bg-white, .theme-copper .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-copper .shadow-sm, .theme-copper .shadow-md, .theme-copper .shadow-lg, .theme-copper .shadow-xl { box-shadow:0 1px 3px rgba(194,65,12,.12) !important; border:1px solid var(--border-color); }
    .theme-copper .rounded-lg, .theme-copper .rounded-md { border-radius:8px !important; }
    .theme-copper .text-blue-600 { color: var(--accent-color) !important; }
    .theme-copper .bg-blue-600 { background: var(--accent-color) !important; color:#fff !important; }
    .theme-copper .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-copper input, .theme-copper select, .theme-copper textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-copper input:focus, .theme-copper select:focus, .theme-copper textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(194,65,12,.22) !important; outline:none !important; }
    .theme-copper .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Lavender */
    .theme-lavender { --bg-color:#faf5ff; --card-bg-color:#ffffff; --text-color:#4c1d95; --subtle-text-color:#a78bfa; --border-color:#e9d5ff; --accent-color:#8b5cf6; --accent-hover-color:#7c3aed; }
    .theme-lavender body, .theme-lavender .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-lavender .bg-white, .theme-lavender .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-lavender .shadow-sm, .theme-lavender .shadow-md, .theme-lavender .shadow-lg, .theme-lavender .shadow-xl { box-shadow:0 1px 3px rgba(139,92,246,.12) !important; border:1px solid var(--border-color); }
    .theme-lavender .rounded-lg, .theme-lavender .rounded-md { border-radius:10px !important; }
    .theme-lavender .text-blue-600 { color: var(--accent-color) !important; }
    .theme-lavender .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-lavender .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-lavender input, .theme-lavender select, .theme-lavender textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-lavender input:focus, .theme-lavender select:focus, .theme-lavender textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(139,92,246,.22) !important; outline:none !important; }
    .theme-lavender .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Steel */
    .theme-steel { --bg-color:#f1f5f9; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#475569; --accent-hover-color:#334155; }
    .theme-steel body, .theme-steel .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-steel .bg-white, .theme-steel .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-steel .shadow-sm, .theme-steel .shadow-md, .theme-steel .shadow-lg, .theme-steel .shadow-xl { box-shadow:0 1px 3px rgba(15,23,42,.08) !important; border:1px solid var(--border-color); }
    .theme-steel .rounded-lg, .theme-steel .rounded-md { border-radius:8px !important; }
    .theme-steel .text-blue-600 { color: var(--accent-color) !important; }
    .theme-steel .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-steel .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-steel input, .theme-steel select, .theme-steel textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:6px !important; }
    .theme-steel input:focus, .theme-steel select:focus, .theme-steel textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(71,85,105,.2) !important; outline:none !important; }
    .theme-steel .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Clay */
    .theme-clay { --bg-color:#f9f5f2; --card-bg-color:#ffffff; --text-color:#3f2d20; --subtle-text-color:#a16207; --border-color:#eadbd1; --accent-color:#9a3412; --accent-hover-color:#7c2d12; }
    .theme-clay body, .theme-clay .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-clay .bg-white, .theme-clay .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-clay .shadow-sm, .theme-clay .shadow-md, .theme-clay .shadow-lg, .theme-clay .shadow-xl { box-shadow:0 1px 3px rgba(154,52,18,.10) !important; border:1px solid var(--border-color); }
    .theme-clay .rounded-lg, .theme-clay .rounded-md { border-radius:10px !important; }
    .theme-clay .text-blue-600 { color: var(--accent-color) !important; }
    .theme-clay .bg-blue-600 { background: var(--accent-color) !important; color:#fff !important; }
    .theme-clay .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-clay input, .theme-clay select, .theme-clay textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-clay input:focus, .theme-clay select:focus, .theme-clay textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(154,52,18,.22) !important; outline:none !important; }
    .theme-clay .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Cyan */
    .theme-cyan { --bg-color:#ecfeff; --card-bg-color:#ffffff; --text-color:#164e63; --subtle-text-color:#22d3ee; --border-color:#cffafe; --accent-color:#06b6d4; --accent-hover-color:#0891b2; }
    .theme-cyan body, .theme-cyan .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-cyan .bg-white, .theme-cyan .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-cyan .shadow-sm, .theme-cyan .shadow-md, .theme-cyan .shadow-lg, .theme-cyan .shadow-xl { box-shadow:0 1px 3px rgba(6,182,212,.12) !important; border:1px solid var(--border-color); }
    .theme-cyan .rounded-lg, .theme-cyan .rounded-md { border-radius:8px !important; }
    .theme-cyan .text-blue-600 { color: var(--accent-color) !important; }
    .theme-cyan .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-cyan .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-cyan input, .theme-cyan select, .theme-cyan textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-cyan input:focus, .theme-cyan select:focus, .theme-cyan textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(6,182,212,.22) !important; outline:none !important; }
    .theme-cyan .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Olive */
    .theme-olive { --bg-color:#f7fee7; --card-bg-color:#ffffff; --text-color:#1a2e05; --subtle-text-color:#84cc16; --border-color:#d9f99d; --accent-color:#4d7c0f; --accent-hover-color:#3f6212; }
    .theme-olive body, .theme-olive .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-olive .bg-white, .theme-olive .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-olive .shadow-sm, .theme-olive .shadow-md, .theme-olive .shadow-lg, .theme-olive .shadow-xl { box-shadow:0 1px 3px rgba(77,124,15,.12) !important; border:1px solid var(--border-color); }
    .theme-olive .rounded-lg, .theme-olive .rounded-md { border-radius:8px !important; }
    .theme-olive .text-blue-600 { color: var(--accent-color) !important; }
    .theme-olive .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-olive .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-olive input, .theme-olive select, .theme-olive textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-olive input:focus, .theme-olive select:focus, .theme-olive textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(77,124,15,.22) !important; outline:none !important; }
    .theme-olive .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Marigold */
    .theme-marigold { --bg-color:#fff7ed; --card-bg-color:#ffffff; --text-color:#7c2d12; --subtle-text-color:#f59e0b; --border-color:#fed7aa; --accent-color:#f97316; --accent-hover-color:#ea580c; }
    .theme-marigold body, .theme-marigold .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-marigold .bg-white, .theme-marigold .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-marigold .shadow-sm, .theme-marigold .shadow-md, .theme-marigold .shadow-lg, .theme-marigold .shadow-xl { box-shadow:0 1px 3px rgba(249,115,22,.12) !important; border:1px solid var(--border-color); }
    .theme-marigold .rounded-lg, .theme-marigold .rounded-md { border-radius:10px !important; }
    .theme-marigold .text-blue-600 { color: var(--accent-color) !important; }
    .theme-marigold .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-marigold .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-marigold input, .theme-marigold select, .theme-marigold textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-marigold input:focus, .theme-marigold select:focus, .theme-marigold textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(249,115,22,.22) !important; outline:none !important; }
    .theme-marigold .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Orchid */
    .theme-orchid { --bg-color:#fdf4ff; --card-bg-color:#ffffff; --text-color:#4a044e; --subtle-text-color:#d946ef; --border-color:#f5d0fe; --accent-color:#a21caf; --accent-hover-color:#86198f; }
    .theme-orchid body, .theme-orchid .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-orchid .bg-white, .theme-orchid .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-orchid .shadow-sm, .theme-orchid .shadow-md, .theme-orchid .shadow-lg, .theme-orchid .shadow-xl { box-shadow:0 1px 3px rgba(162,28,175,.12) !important; border:1px solid var(--border-color); }
    .theme-orchid .rounded-lg, .theme-orchid .rounded-md { border-radius:10px !important; }
    .theme-orchid .text-blue-600 { color: var(--accent-color) !important; }
    .theme-orchid .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-orchid .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-orchid input, .theme-orchid select, .theme-orchid textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-orchid input:focus, .theme-orchid select:focus, .theme-orchid textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(162,28,175,.22) !important; outline:none !important; }
    .theme-orchid .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Flamingo */
    .theme-flamingo { --bg-color:#fff0f6; --card-bg-color:#ffffff; --text-color:#3f1d2b; --subtle-text-color:#fb7185; --border-color:#ffe4e6; --accent-color:#f43f5e; --accent-hover-color:#e11d48; }
    .theme-flamingo body, .theme-flamingo .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-flamingo .bg-white, .theme-flamingo .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-flamingo .shadow-sm, .theme-flamingo .shadow-md, .theme-flamingo .shadow-lg, .theme-flamingo .shadow-xl { box-shadow:0 1px 3px rgba(244,63,94,.12) !important; border:1px solid var(--border-color); }
    .theme-flamingo .rounded-lg, .theme-flamingo .rounded-md { border-radius:10px !important; }
    .theme-flamingo .text-blue-600 { color: var(--accent-color) !important; }
    .theme-flamingo .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-flamingo .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-flamingo input, .theme-flamingo select, .theme-flamingo textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-flamingo input:focus, .theme-flamingo select:focus, .theme-flamingo textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(244,63,94,.22) !important; outline:none !important; }
    .theme-flamingo .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Iceberg */
    .theme-iceberg { --bg-color:#e0f2fe; --card-bg-color:#f0f9ff; --text-color:#0c4a6e; --subtle-text-color:#38bdf8; --border-color:#bae6fd; --accent-color:#0ea5e9; --accent-hover-color:#0284c7; }
    .theme-iceberg body, .theme-iceberg .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-iceberg .bg-white, .theme-iceberg .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-iceberg .shadow-sm, .theme-iceberg .shadow-md, .theme-iceberg .shadow-lg, .theme-iceberg .shadow-xl { box-shadow:0 1px 3px rgba(14,165,233,.12) !important; border:1px solid var(--border-color); }
    .theme-iceberg .rounded-lg, .theme-iceberg .rounded-md { border-radius:8px !important; }
    .theme-iceberg .text-blue-600 { color: var(--accent-color) !important; }
    .theme-iceberg .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-iceberg .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-iceberg input, .theme-iceberg select, .theme-iceberg textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-iceberg input:focus, .theme-iceberg select:focus, .theme-iceberg textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(14,165,233,.22) !important; outline:none !important; }
    .theme-iceberg .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* === 50 More Themes === */
    /* helper skeleton
    .theme-NAME { --bg-color:; --card-bg-color:; --text-color:; --subtle-text-color:; --border-color:; --accent-color:; --accent-hover-color:; }
    .theme-NAME body, .theme-NAME .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-NAME .bg-white, .theme-NAME .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-NAME .shadow-sm, .theme-NAME .shadow-md, .theme-NAME .shadow-lg, .theme-NAME .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.08) !important; border:1px solid var(--border-color); }
    .theme-NAME .rounded-lg, .theme-NAME .rounded-md { border-radius:8px !important; }
    .theme-NAME .text-blue-600 { color: var(--accent-color) !important; }
    .theme-NAME .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-NAME .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-NAME input, .theme-NAME select, .theme-NAME textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; color:var(--text-color) !important; }
    .theme-NAME input:focus, .theme-NAME select:focus, .theme-NAME textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(0,0,0,.12) !important; outline:none !important; }
    .theme-NAME .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }
    */

    .theme-blossom { --bg-color:#fff5f7; --card-bg-color:#ffffff; --text-color:#4a1d2b; --subtle-text-color:#f472b6; --border-color:#fde2e7; --accent-color:#ec4899; --accent-hover-color:#db2777; }
    .theme-blossom body, .theme-blossom .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-blossom .bg-white, .theme-blossom .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-blossom .shadow-sm, .theme-blossom .shadow-md, .theme-blossom .shadow-lg, .theme-blossom .shadow-xl { box-shadow:0 2px 6px rgba(236,72,153,.10) !important; border:1px solid var(--border-color); }
    .theme-blossom .rounded-lg, .theme-blossom .rounded-md { border-radius:10px !important; }
    .theme-blossom .text-blue-600 { color: var(--accent-color) !important; }
    .theme-blossom .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-blossom .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-blossom input, .theme-blossom select, .theme-blossom textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; color:var(--text-color) !important; }
    .theme-blossom input:focus, .theme-blossom select:focus, .theme-blossom textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(236,72,153,.20) !important; outline:none !important; }
    .theme-blossom .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-jade { --bg-color:#ecfdf5; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#34d399; --border-color:#d1fae5; --accent-color:#10b981; --accent-hover-color:#059669; }
    .theme-jade body, .theme-jade .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-jade .bg-white, .theme-jade .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-jade .shadow-sm, .theme-jade .shadow-md, .theme-jade .shadow-lg, .theme-jade .shadow-xl { box-shadow:0 1px 3px rgba(16,185,129,.12) !important; border:1px solid var(--border-color); }
    .theme-jade .rounded-lg, .theme-jade .rounded-md { border-radius:10px !important; }
    .theme-jade .text-blue-600 { color: var(--accent-color) !important; }
    .theme-jade .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-jade .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-jade input, .theme-jade select, .theme-jade textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; color:var(--text-color) !important; }
    .theme-jade input:focus, .theme-jade select:focus, .theme-jade textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(16,185,129,.22) !important; outline:none !important; }
    .theme-jade .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-cinder { --bg-color:#0f1115; --card-bg-color:#181b22; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2b2f37; --accent-color:#f59e0b; --accent-hover-color:#d97706; }
    .theme-cinder body, .theme-cinder .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-cinder .bg-white, .theme-cinder .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-cinder .shadow-sm, .theme-cinder .shadow-md, .theme-cinder .shadow-lg, .theme-cinder .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.35) !important; border:1px solid var(--border-color); }
    .theme-cinder .rounded-lg, .theme-cinder .rounded-md { border-radius:6px !important; }
    .theme-cinder .text-blue-600 { color: var(--accent-color) !important; }
    .theme-cinder .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-cinder .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-cinder input, .theme-cinder select, .theme-cinder textarea { background:#181b22 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-cinder input:focus, .theme-cinder select:focus, .theme-cinder textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(245,158,11,.22) !important; outline:none !important; }
    .theme-cinder .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-fern { --bg-color:#f0fdf4; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#22c55e; --border-color:#dcfce7; --accent-color:#16a34a; --accent-hover-color:#15803d; }
    .theme-fern body, .theme-fern .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-fern .bg-white, .theme-fern .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-fern .shadow-sm, .theme-fern .shadow-md, .theme-fern .shadow-lg, .theme-fern .shadow-xl { box-shadow:0 1px 3px rgba(22,163,74,.12) !important; border:1px solid var(--border-color); }
    .theme-fern .rounded-lg, .theme-fern .rounded-md { border-radius:8px !important; }
    .theme-fern .text-blue-600 { color: var(--accent-color) !important; }
    .theme-fern .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-fern .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-fern input, .theme-fern select, .theme-fern textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-fern input:focus, .theme-fern select:focus, .theme-fern textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(22,163,74,.22) !important; outline:none !important; }
    .theme-fern .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-glacier { --bg-color:#e0f2fe; --card-bg-color:#f0f9ff; --text-color:#0c4a6e; --subtle-text-color:#38bdf8; --border-color:#bae6fd; --accent-color:#0ea5e9; --accent-hover-color:#0284c7; }
    .theme-glacier body, .theme-glacier .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-glacier .bg-white, .theme-glacier .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-glacier .shadow-sm, .theme-glacier .shadow-md, .theme-glacier .shadow-lg, .theme-glacier .shadow-xl { box-shadow:0 1px 3px rgba(14,165,233,.12) !important; border:1px solid var(--border-color); }
    .theme-glacier .rounded-lg, .theme-glacier .rounded-md { border-radius:8px !important; }
    .theme-glacier .text-blue-600 { color: var(--accent-color) !important; }
    .theme-glacier .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-glacier .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-glacier input, .theme-glacier select, .theme-glacier textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-glacier input:focus, .theme-glacier select:focus, .theme-glacier textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(14,165,233,.22) !important; outline:none !important; }
    .theme-glacier .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-ember { --bg-color:#fff7ed; --card-bg-color:#ffffff; --text-color:#7c2d12; --subtle-text-color:#f97316; --border-color:#fed7aa; --accent-color:#ea580c; --accent-hover-color:#c2410c; }
    .theme-ember body, .theme-ember .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-ember .bg-white, .theme-ember .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-ember .shadow-sm, .theme-ember .shadow-md, .theme-ember .shadow-lg, .theme-ember .shadow-xl { box-shadow:0 1px 3px rgba(234,88,12,.12) !important; border:1px solid var(--border-color); }
    .theme-ember .rounded-lg, .theme-ember .rounded-md { border-radius:8px !important; }
    .theme-ember .text-blue-600 { color: var(--accent-color) !important; }
    .theme-ember .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-ember .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-ember input, .theme-ember select, .theme-ember textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-ember input:focus, .theme-ember select:focus, .theme-ember textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(234,88,12,.22) !important; outline:none !important; }
    .theme-ember .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-horizon { --bg-color:#f1f5f9; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#3b82f6; --accent-hover-color:#2563eb; }
    .theme-horizon body, .theme-horizon .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-horizon .bg-white, .theme-horizon .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-horizon .shadow-sm, .theme-horizon .shadow-md, .theme-horizon .shadow-lg, .theme-horizon .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-horizon .rounded-lg, .theme-horizon .rounded-md { border-radius:10px !important; }
    .theme-horizon .text-blue-600 { color: var(--accent-color) !important; }
    .theme-horizon .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-horizon .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-horizon input, .theme-horizon select, .theme-horizon textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-horizon input:focus, .theme-horizon select:focus, .theme-horizon textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(59,130,246,.22) !important; outline:none !important; }
    .theme-horizon .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-canyon { --bg-color:#fff7ed; --card-bg-color:#fffbeb; --text-color:#7c2d12; --subtle-text-color:#f59e0b; --border-color:#fde68a; --accent-color:#d97706; --accent-hover-color:#b45309; }
    .theme-canyon body, .theme-canyon .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-canyon .bg-white, .theme-canyon .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-canyon .shadow-sm, .theme-canyon .shadow-md, .theme-canyon .shadow-lg, .theme-canyon .shadow-xl { box-shadow:0 1px 3px rgba(217,119,6,.12) !important; border:1px solid var(--border-color); }
    .theme-canyon .rounded-lg, .theme-canyon .rounded-md { border-radius:8px !important; }
    .theme-canyon .text-blue-600 { color: var(--accent-color) !important; }
    .theme-canyon .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-canyon .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-canyon input, .theme-canyon select, .theme-canyon textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-canyon input:focus, .theme-canyon select:focus, .theme-canyon textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(217,119,6,.22) !important; outline:none !important; }
    .theme-canyon .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-lagoon { --bg-color:#ecfeff; --card-bg-color:#ffffff; --text-color:#164e63; --subtle-text-color:#22d3ee; --border-color:#cffafe; --accent-color:#06b6d4; --accent-hover-color:#0891b2; }
    .theme-lagoon body, .theme-lagoon .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-lagoon .bg-white, .theme-lagoon .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-lagoon .shadow-sm, .theme-lagoon .shadow-md, .theme-lagoon .shadow-lg, .theme-lagoon .shadow-xl { box-shadow:0 1px 3px rgba(6,182,212,.12) !important; border:1px solid var(--border-color); }
    .theme-lagoon .rounded-lg, .theme-lagoon .rounded-md { border-radius:8px !important; }
    .theme-lagoon .text-blue-600 { color: var(--accent-color) !important; }
    .theme-lagoon .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-lagoon .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-lagoon input, .theme-lagoon select, .theme-lagoon textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-lagoon input:focus, .theme-lagoon select:focus, .theme-lagoon textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(6,182,212,.22) !important; outline:none !important; }
    .theme-lagoon .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-meadow { --bg-color:#f0fdf4; --card-bg-color:#ffffff; --text-color:#14532d; --subtle-text-color:#22c55e; --border-color:#dcfce7; --accent-color:#65a30d; --accent-hover-color:#4d7c0f; }
    .theme-meadow body, .theme-meadow .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-meadow .bg-white, .theme-meadow .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-meadow .shadow-sm, .theme-meadow .shadow-md, .theme-meadow .shadow-lg, .theme-meadow .shadow-xl { box-shadow:0 1px 3px rgba(101,163,13,.12) !important; border:1px solid var(--border-color); }
    .theme-meadow .rounded-lg, .theme-meadow .rounded-md { border-radius:8px !important; }
    .theme-meadow .text-blue-600 { color: var(--accent-color) !important; }
    .theme-meadow .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-meadow .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-meadow input, .theme-meadow select, .theme-meadow textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-meadow input:focus, .theme-meadow select:focus, .theme-meadow textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(101,163,13,.22) !important; outline:none !important; }
    .theme-meadow .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-tundra { --bg-color:#f8fafc; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#0ea5e9; --accent-hover-color:#0284c7; }
    .theme-tundra body, .theme-tundra .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-tundra .bg-white, .theme-tundra .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-tundra .shadow-sm, .theme-tundra .shadow-md, .theme-tundra .shadow-lg, .theme-tundra .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-tundra .rounded-lg, .theme-tundra .rounded-md { border-radius:10px !important; }
    .theme-tundra .text-blue-600 { color: var(--accent-color) !important; }
    .theme-tundra .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-tundra .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-tundra input, .theme-tundra select, .theme-tundra textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-tundra input:focus, .theme-tundra select:focus, .theme-tundra textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(14,165,233,.22) !important; outline:none !important; }
    .theme-tundra .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-dune { --bg-color:#fdf6e3; --card-bg-color:#fffaf0; --text-color:#3f2d1c; --subtle-text-color:#b08968; --border-color:#f1e3c6; --accent-color:#d97706; --accent-hover-color:#b45309; }
    .theme-dune body, .theme-dune .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-dune .bg-white, .theme-dune .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-dune .shadow-sm, .theme-dune .shadow-md, .theme-dune .shadow-lg, .theme-dune .shadow-xl { box-shadow:0 1px 3px rgba(217,119,6,.10) !important; border:1px solid var(--border-color); }
    .theme-dune .rounded-lg, .theme-dune .rounded-md { border-radius:10px !important; }
    .theme-dune .text-blue-600 { color: var(--accent-color) !important; }
    .theme-dune .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-dune .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-dune input, .theme-dune select, .theme-dune textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-dune input:focus, .theme-dune select:focus, .theme-dune textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(217,119,6,.22) !important; outline:none !important; }
    .theme-dune .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-willow { --bg-color:#f0fdf4; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#34d399; --border-color:#dcfce7; --accent-color:#22c55e; --accent-hover-color:#16a34a; }
    .theme-willow body, .theme-willow .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-willow .bg-white, .theme-willow .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-willow .shadow-sm, .theme-willow .shadow-md, .theme-willow .shadow-lg, .theme-willow .shadow-xl { box-shadow:0 1px 3px rgba(34,197,94,.12) !important; border:1px solid var(--border-color); }
    .theme-willow .rounded-lg, .theme-willow .rounded-md { border-radius:10px !important; }
    .theme-willow .text-blue-600 { color: var(--accent-color) !important; }
    .theme-willow .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-willow .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-willow input, .theme-willow select, .theme-willow textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-willow input:focus, .theme-willow select:focus, .theme-willow textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(34,197,94,.22) !important; outline:none !important; }
    .theme-willow .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* 多彩主題 - 基於訪客資料與新增申請單的色彩設計 */
    .theme-colorful {
        --bg-color: #D9F3FD; /* 淡藍色背景 */
        --card-bg-color: #ffffff;
        --text-color: #2C3E50; /* 深藍灰色文字 */
        --subtle-text-color: #34495E;
        --border-color: #AEBFED; /* 淡紫藍邊框 */
        --accent-color: #E74C3C; /* 紅色強調 */
        --accent-hover-color: #C0392B;
        --secondary-green: #C7E2B2; /* 淡綠色 */
        --secondary-pink: #FFB2C8; /* 淡粉色 */
        --secondary-purple: #AEBFED; /* 淡紫色 */

        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-green) 25%, var(--secondary-pink) 50%, var(--secondary-purple) 75%, var(--bg-color) 100%) !important;
        color: var(--text-color) !important;
        font-family: 'Noto Sans TC', sans-serif !important;
    }
    .theme-colorful body, .theme-colorful .bg-gray-50 { 
        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-green) 25%, var(--secondary-pink) 50%, var(--secondary-purple) 75%, var(--bg-color) 100%) !important; 
    }
    .theme-colorful .bg-white, .theme-colorful .bg-gray-100 { 
        background: var(--card-bg-color) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 15px !important;
        box-shadow: 0 8px 25px rgba(174, 191, 237, 0.3) !important;
    }
    .theme-colorful .shadow-sm, .theme-colorful .shadow-md, .theme-colorful .shadow-lg, .theme-colorful .shadow-xl { 
        box-shadow: 0 8px 25px rgba(174, 191, 237, 0.3) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 15px !important;
    }
    .theme-colorful .rounded-lg, .theme-colorful .rounded-md { border-radius: 15px !important; }
    .theme-colorful .border, .theme-colorful .border-gray-300, .theme-colorful .border-gray-200, .theme-colorful .divide-y > :not([hidden]) ~ :not([hidden]), .theme-colorful .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
        border-color: var(--border-color) !important;
        border-width: 2px !important;
    }
    .theme-colorful .text-gray-900, .theme-colorful .text-gray-800, .theme-colorful .text-gray-700 { color: var(--text-color) !important; font-weight: 600 !important; }
    .theme-colorful .text-gray-600, .theme-colorful .text-gray-500 { color: var(--subtle-text-color) !important; }
    .theme-colorful .text-blue-600 { color: var(--accent-color) !important; font-weight: bold !important; }
    .theme-colorful .bg-blue-600 { 
        background: linear-gradient(45deg, var(--accent-color), var(--accent-hover-color)) !important; 
        border-radius: 10px !important;
        transition: all 0.3s ease !important;
    }
    .theme-colorful .bg-blue-600:hover { 
        background: linear-gradient(45deg, var(--accent-hover-color), var(--accent-color)) !important; 
        transform: translateY(-2px) !important;
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4) !important;
    }
    .theme-colorful input, .theme-colorful select, .theme-colorful textarea { 
        background: rgba(255, 255, 255, 0.9) !important; 
        border: 2px solid var(--border-color) !important; 
        border-radius: 12px !important; 
        padding: 8px 12px !important;
        transition: all 0.3s ease !important;
    }
    .theme-colorful input:focus, .theme-colorful select:focus, .theme-colorful textarea:focus { 
        border-color: var(--accent-color) !important; 
        box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.2) !important; 
        outline: none !important; 
        transform: scale(1.02) !important;
    }
    .theme-colorful .tab-button.active { 
        border-color: var(--accent-color) !important; 
        color: var(--accent-color) !important; 
        background: rgba(231, 76, 60, 0.1) !important;
        border-radius: 8px !important;
        font-weight: bold !important;
    }
    .theme-colorful .hover\:bg-gray-50:hover { 
        background: linear-gradient(45deg, var(--secondary-green), var(--secondary-pink)) !important; 
        transition: all 0.3s ease !important;
    }
    .theme-colorful button { 
        transition: all 0.3s ease !important; 
        border-radius: 8px !important;
    }
    .theme-colorful button:hover { 
        transform: translateY(-1px) !important; 
    }
    .theme-willow .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* 多彩主題：flatpickr 視覺整合 */
    .theme-colorful .flatpickr-calendar { 
        background: #ffffff !important; 
        border: 2px solid var(--border-color) !important; 
        box-shadow: 0 8px 25px rgba(174, 191, 237, 0.3) !important; 
        border-radius: 12px !important; 
        overflow: hidden; 
    }
    .theme-colorful .flatpickr-weekday { color: var(--subtle-text-color) !important; font-weight: 600; }
    .theme-colorful .flatpickr-day.selected, 
    .theme-colorful .flatpickr-day.startRange, 
    .theme-colorful .flatpickr-day.endRange { 
        background: linear-gradient(45deg, var(--accent-color), var(--accent-hover-color)) !important; 
        border-color: transparent !important; color:#fff !important; 
    }

    /* 防止標題列搜尋框聚焦時放大造成換行（多彩/魯紅/魯綠）*/
    .theme-colorful .header-toolbar input:focus,
    .theme-colorful .header-toolbar select:focus,
    .theme-colorful .header-toolbar textarea:focus { transform: none !important; }

    /* 魯紅主題：flatpickr 視覺整合 */
    .theme-luhong .flatpickr-calendar { 
        background: #ffffff !important; 
        border: 2px solid var(--border-color) !important; 
        box-shadow: 0 4px 20px rgba(182, 73, 78, 0.15) !important; 
        border-radius: 12px !important; 
        overflow: hidden; 
    }
    .theme-luhong .flatpickr-weekday { color: var(--subtle-text-color) !important; font-weight: 600; }
    .theme-luhong .flatpickr-day.selected, 
    .theme-luhong .flatpickr-day.startRange, 
    .theme-luhong .flatpickr-day.endRange { 
        background: linear-gradient(45deg, var(--accent-color), var(--secondary-dark)) !important; 
        border-color: transparent !important; color:#fff !important; 
    }
    .theme-luhong .header-toolbar input:focus,
    .theme-luhong .header-toolbar select:focus,
    .theme-luhong .header-toolbar textarea:focus { transform: none !important; }

    /* 魯綠主題：flatpickr 視覺整合 */
    .theme-lugreen .flatpickr-calendar { 
        background: #ffffff !important; 
        border: 2px solid var(--border-color) !important; 
        box-shadow: 0 4px 20px rgba(44, 193, 133, 0.15) !important; 
        border-radius: 12px !important; 
        overflow: hidden; 
    }
    .theme-lugreen .flatpickr-weekday { color: var(--subtle-text-color) !important; font-weight: 600; }
    .theme-lugreen .flatpickr-day.selected, 
    .theme-lugreen .flatpickr-day.startRange, 
    .theme-lugreen .flatpickr-day.endRange { 
        background: linear-gradient(45deg, var(--accent-color), var(--secondary-dark)) !important; 
        border-color: transparent !important; color:#fff !important; 
    }
    .theme-lugreen .header-toolbar input:focus,
    .theme-lugreen .header-toolbar select:focus,
    .theme-lugreen .header-toolbar textarea:focus { transform: none !important; }

    /* --- 修復：多彩 / 魯紅 / 魯綠 主題下「版面風格」選取框被放大 --- */
    .theme-colorful #app-header .theme-switcher select,
    .theme-colorful #app-header .theme-switcher select:focus,
    .theme-luhong #app-header .theme-switcher select,
    .theme-luhong #app-header .theme-switcher select:focus,
    .theme-lugreen #app-header .theme-switcher select,
    .theme-lugreen #app-header .theme-switcher select:focus {
        border: 1px solid var(--border-color) !important;
        border-radius: 6px !important;
        padding: 0.25rem 0.5rem !important; /* 與原本 p-1 對齊 */
        height: 2rem !important;            /* h-8 */
        line-height: 1.5rem !important;
        box-shadow: none !important;
        transform: none !important;
        background: #fff !important;
    }

    /* --- 修復：多彩 / 魯紅 / 魯綠 主題下「檢視權限」與「日期區間」高度一致（以日期區間 h-10 為基準）--- */
    .theme-colorful #dashboard-filters select[data-filter="permission"],
    .theme-luhong   #dashboard-filters select[data-filter="permission"],
    .theme-lugreen  #dashboard-filters select[data-filter="permission"] {
        height: 2.5rem !important;          /* h-10 */
        line-height: 2.5rem !important;     /* 文字垂直置中 */
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        padding-left: 0.75rem !important;   /* px-3 */
        padding-right: 0.75rem !important;
        transform: none !important;         /* 避免 focus 時放大 */
    }
    .theme-colorful #dashboard-filters select[data-filter="permission"]:focus,
    .theme-luhong   #dashboard-filters select[data-filter="permission"]:focus,
    .theme-lugreen  #dashboard-filters select[data-filter="permission"]:focus {
        transform: none !important;
    }

    .theme-bronze { --bg-color:#fff7ed; --card-bg-color:#ffffff; --text-color:#4a2c1a; --subtle-text-color:#ea580c; --border-color:#fed7aa; --accent-color:#b45309; --accent-hover-color:#92400e; }
    .theme-bronze body, .theme-bronze .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-bronze .bg-white, .theme-bronze .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-bronze .shadow-sm, .theme-bronze .shadow-md, .theme-bronze .shadow-lg, .theme-bronze .shadow-xl { box-shadow:0 1px 3px rgba(180,83,9,.12) !important; border:1px solid var(--border-color); }
    .theme-bronze .rounded-lg, .theme-bronze .rounded-md { border-radius:8px !important; }
    .theme-bronze .text-blue-600 { color: var(--accent-color) !important; }
    .theme-bronze .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-bronze .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-bronze input, .theme-bronze select, .theme-bronze textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-bronze input:focus, .theme-bronze select:focus, .theme-bronze textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(180,83,9,.22) !important; outline:none !important; }
    .theme-bronze .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-silver { --bg-color:#f8fafc; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#64748b; --accent-hover-color:#475569; }
    .theme-silver body, .theme-silver .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-silver .bg-white, .theme-silver .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-silver .shadow-sm, .theme-silver .shadow-md, .theme-silver .shadow-lg, .theme-silver .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-silver .rounded-lg, .theme-silver .rounded-md { border-radius:8px !important; }
    .theme-silver .text-blue-600 { color: var(--accent-color) !important; }
    .theme-silver .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-silver .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-silver input, .theme-silver select, .theme-silver textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-silver input:focus, .theme-silver select:focus, .theme-silver textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(100,116,139,.22) !important; outline:none !important; }
    .theme-silver .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-gold { --bg-color:#fffbeb; --card-bg-color:#ffffff; --text-color:#713f12; --subtle-text-color:#f59e0b; --border-color:#fde68a; --accent-color:#d97706; --accent-hover-color:#b45309; }
    .theme-gold body, .theme-gold .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-gold .bg-white, .theme-gold .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-gold .shadow-sm, .theme-gold .shadow-md, .theme-gold .shadow-lg, .theme-gold .shadow-xl { box-shadow:0 1px 3px rgba(245,158,11,.12) !important; border:1px solid var(--border-color); }
    .theme-gold .rounded-lg, .theme-gold .rounded-md { border-radius:10px !important; }
    .theme-gold .text-blue-600 { color: var(--accent-color) !important; }
    .theme-gold .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-gold .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-gold input, .theme-gold select, .theme-gold textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-gold input:focus, .theme-gold select:focus, .theme-gold textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(217,119,6,.22) !important; outline:none !important; }
    .theme-gold .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-amethyst { --bg-color:#f5f3ff; --card-bg-color:#ffffff; --text-color:#3730a3; --subtle-text-color:#a78bfa; --border-color:#ddd6fe; --accent-color:#8b5cf6; --accent-hover-color:#7c3aed; }
    .theme-amethyst body, .theme-amethyst .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-amethyst .bg-white, .theme-amethyst .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-amethyst .shadow-sm, .theme-amethyst .shadow-md, .theme-amethyst .shadow-lg, .theme-amethyst .shadow-xl { box-shadow:0 1px 3px rgba(139,92,246,.12) !important; border:1px solid var(--border-color); }
    .theme-amethyst .rounded-lg, .theme-amethyst .rounded-md { border-radius:8px !important; }
    .theme-amethyst .text-blue-600 { color: var(--accent-color) !important; }
    .theme-amethyst .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-amethyst .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-amethyst input, .theme-amethyst select, .theme-amethyst textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-amethyst input:focus, .theme-amethyst select:focus, .theme-amethyst textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(139,92,246,.22) !important; outline:none !important; }
    .theme-amethyst .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-sapphire { --bg-color:#eff6ff; --card-bg-color:#ffffff; --text-color:#1e3a8a; --subtle-text-color:#60a5fa; --border-color:#dbeafe; --accent-color:#2563eb; --accent-hover-color:#1d4ed8; }
    .theme-sapphire body, .theme-sapphire .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-sapphire .bg-white, .theme-sapphire .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-sapphire .shadow-sm, .theme-sapphire .shadow-md, .theme-sapphire .shadow-lg, .theme-sapphire .shadow-xl { box-shadow:0 1px 3px rgba(37,99,235,.12) !important; border:1px solid var(--border-color); }
    .theme-sapphire .rounded-lg, .theme-sapphire .rounded-md { border-radius:8px !important; }
    .theme-sapphire .text-blue-600 { color: var(--accent-color) !important; }
    .theme-sapphire .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-sapphire .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-sapphire input, .theme-sapphire select, .theme-sapphire textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-sapphire input:focus, .theme-sapphire select:focus, .theme-sapphire textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(37,99,235,.22) !important; outline:none !important; }
    .theme-sapphire .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-ruby { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#7f1d1d; --subtle-text-color:#f87171; --border-color:#fecaca; --accent-color:#ef4444; --accent-hover-color:#dc2626; }
    .theme-ruby body, .theme-ruby .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-ruby .bg-white, .theme-ruby .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-ruby .shadow-sm, .theme-ruby .shadow-md, .theme-ruby .shadow-lg, .theme-ruby .shadow-xl { box-shadow:0 1px 3px rgba(239,68,68,.12) !important; border:1px solid var(--border-color); }
    .theme-ruby .rounded-lg, .theme-ruby .rounded-md { border-radius:10px !important; }
    .theme-ruby .text-blue-600 { color: var(--accent-color) !important; }
    .theme-ruby .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-ruby .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-ruby input, .theme-ruby select, .theme-ruby textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-ruby input:focus, .theme-ruby select:focus, .theme-ruby textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(239,68,68,.22) !important; outline:none !important; }
    .theme-ruby .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-emerald { --bg-color:#ecfdf5; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#34d399; --border-color:#d1fae5; --accent-color:#10b981; --accent-hover-color:#059669; }
    .theme-emerald body, .theme-emerald .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-emerald .bg-white, .theme-emerald .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-emerald .shadow-sm, .theme-emerald .shadow-md, .theme-emerald .shadow-lg, .theme-emerald .shadow-xl { box-shadow:0 1px 3px rgba(16,185,129,.12) !important; border:1px solid var(--border-color); }
    .theme-emerald .rounded-lg, .theme-emerald .rounded-md { border-radius:10px !important; }
    .theme-emerald .text-blue-600 { color: var(--accent-color) !important; }
    .theme-emerald .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-emerald .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-emerald input, .theme-emerald select, .theme-emerald textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-emerald input:focus, .theme-emerald select:focus, .theme-emerald textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(16,185,129,.22) !important; outline:none !important; }
    .theme-emerald .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-topaz { --bg-color:#fffbeb; --card-bg-color:#ffffff; --text-color:#78350f; --subtle-text-color:#f59e0b; --border-color:#fde68a; --accent-color:#f59e0b; --accent-hover-color:#d97706; }
    .theme-topaz body, .theme-topaz .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-topaz .bg-white, .theme-topaz .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-topaz .shadow-sm, .theme-topaz .shadow-md, .theme-topaz .shadow-lg, .theme-topaz .shadow-xl { box-shadow:0 1px 3px rgba(245,158,11,.12) !important; border:1px solid var(--border-color); }
    .theme-topaz .rounded-lg, .theme-topaz .rounded-md { border-radius:8px !important; }
    .theme-topaz .text-blue-600 { color: var(--accent-color) !important; }
    .theme-topaz .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-topaz .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-topaz input, .theme-topaz select, .theme-topaz textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-topaz input:focus, .theme-topaz select:focus, .theme-topaz textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(245,158,11,.22) !important; outline:none !important; }
    .theme-topaz .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-garnet { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#701a1a; --subtle-text-color:#fb7185; --border-color:#fecdd3; --accent-color:#e11d48; --accent-hover-color:#be123c; }
    .theme-garnet body, .theme-garnet .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-garnet .bg-white, .theme-garnet .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-garnet .shadow-sm, .theme-garnet .shadow-md, .theme-garnet .shadow-lg, .theme-garnet .shadow-xl { box-shadow:0 1px 3px rgba(225,29,72,.12) !important; border:1px solid var(--border-color); }
    .theme-garnet .rounded-lg, .theme-garnet .rounded-md { border-radius:10px !important; }
    .theme-garnet .text-blue-600 { color: var(--accent-color) !important; }
    .theme-garnet .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-garnet .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-garnet input, .theme-garnet select, .theme-garnet textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-garnet input:focus, .theme-garnet select:focus, .theme-garnet textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(225,29,72,.22) !important; outline:none !important; }
    .theme-garnet .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-quartz { --bg-color:#f8fafc; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#14b8a6; --accent-hover-color:#0d9488; }
    .theme-quartz body, .theme-quartz .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-quartz .bg-white, .theme-quartz .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-quartz .shadow-sm, .theme-quartz .shadow-md, .theme-quartz .shadow-lg, .theme-quartz .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-quartz .rounded-lg, .theme-quartz .rounded-md { border-radius:8px !important; }
    .theme-quartz .text-blue-600 { color: var(--accent-color) !important; }
    .theme-quartz .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-quartz .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-quartz input, .theme-quartz select, .theme-quartz textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-quartz input:focus, .theme-quartz select:focus, .theme-quartz textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(20,184,166,.22) !important; outline:none !important; }
    .theme-quartz .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-onyx { --bg-color:#0b0c10; --card-bg-color:#151820; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2e3340; --accent-color:#a3a3a3; --accent-hover-color:#737373; }
    .theme-onyx body, .theme-onyx .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-onyx .bg-white, .theme-onyx .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-onyx .shadow-sm, .theme-onyx .shadow-md, .theme-onyx .shadow-lg, .theme-onyx .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.4) !important; border:1px solid var(--border-color); }
    .theme-onyx .rounded-lg, .theme-onyx .rounded-md { border-radius:6px !important; }
    .theme-onyx .text-blue-600 { color: var(--accent-color) !important; }
    .theme-onyx .bg-blue-600 { background: var(--accent-color) !important; color:#0b0c10 !important; }
    .theme-onyx .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-onyx input, .theme-onyx select, .theme-onyx textarea { background:#151820 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-onyx input:focus, .theme-onyx select:focus, .theme-onyx textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(163,163,163,.28) !important; outline:none !important; }
    .theme-onyx .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-obsidian { --bg-color:#0f1115; --card-bg-color:#181b22; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2b2f37; --accent-color:#22d3ee; --accent-hover-color:#06b6d4; }
    .theme-obsidian body, .theme-obsidian .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-obsidian .bg-white, .theme-obsidian .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-obsidian .shadow-sm, .theme-obsidian .shadow-md, .theme-obsidian .shadow-lg, .theme-obsidian .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.35) !important; border:1px solid var(--border-color); }
    .theme-obsidian .rounded-lg, .theme-obsidian .rounded-md { border-radius:6px !important; }
    .theme-obsidian .text-blue-600 { color: var(--accent-color) !important; }
    .theme-obsidian .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-obsidian .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-obsidian input, .theme-obsidian select, .theme-obsidian textarea { background:#181b22 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-obsidian input:focus, .theme-obsidian select:focus, .theme-obsidian textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(34,211,238,.28) !important; outline:none !important; }
    .theme-obsidian .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-smoke { --bg-color:#f3f4f6; --card-bg-color:#ffffff; --text-color:#111827; --subtle-text-color:#6b7280; --border-color:#e5e7eb; --accent-color:#9ca3af; --accent-hover-color:#6b7280; }
    .theme-smoke body, .theme-smoke .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-smoke .bg-white, .theme-smoke .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-smoke .shadow-sm, .theme-smoke .shadow-md, .theme-smoke .shadow-lg, .theme-smoke .shadow-xl { box-shadow:0 1px 2px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-smoke .rounded-lg, .theme-smoke .rounded-md { border-radius:6px !important; }
    .theme-smoke .text-blue-600 { color: var(--accent-color) !important; }
    .theme-smoke .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-smoke .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-smoke input, .theme-smoke select, .theme-smoke textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:6px !important; }
    .theme-smoke input:focus, .theme-smoke select:focus, .theme-smoke textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(156,163,175,.22) !important; outline:none !important; }
    .theme-smoke .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-cloud { --bg-color:#f8fafc; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#94a3b8; --border-color:#e2e8f0; --accent-color:#38bdf8; --accent-hover-color:#0ea5e9; }
    .theme-cloud body, .theme-cloud .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-cloud .bg-white, .theme-cloud .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-cloud .shadow-sm, .theme-cloud .shadow-md, .theme-cloud .shadow-lg, .theme-cloud .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-cloud .rounded-lg, .theme-cloud .rounded-md { border-radius:10px !important; }
    .theme-cloud .text-blue-600 { color: var(--accent-color) !important; }
    .theme-cloud .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-cloud .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-cloud input, .theme-cloud select, .theme-cloud textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-cloud input:focus, .theme-cloud select:focus, .theme-cloud textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(56,189,248,.22) !important; outline:none !important; }
    .theme-cloud .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-storm { --bg-color:#0f172a; --card-bg-color:#111827; --text-color:#e2e8f0; --subtle-text-color:#94a3b8; --border-color:#1f2937; --accent-color:#38bdf8; --accent-hover-color:#0ea5e9; }
    .theme-storm body, .theme-storm .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-storm .bg-white, .theme-storm .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-storm .shadow-sm, .theme-storm .shadow-md, .theme-storm .shadow-lg, .theme-storm .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.35) !important; border:1px solid var(--border-color); }
    .theme-storm .rounded-lg, .theme-storm .rounded-md { border-radius:6px !important; }
    .theme-storm .text-blue-600 { color: var(--accent-color) !important; }
    .theme-storm .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-storm .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-storm input, .theme-storm select, .theme-storm textarea { background:#111827 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-storm input:focus, .theme-storm select:focus, .theme-storm textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(56,189,248,.28) !important; outline:none !important; }
    .theme-storm .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-frost { --bg-color:#f1f5f9; --card-bg-color:#ffffff; --text-color:#0c4a6e; --subtle-text-color:#94a3b8; --border-color:#e2e8f0; --accent-color:#38bdf8; --accent-hover-color:#0ea5e9; }
    .theme-frost body, .theme-frost .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-frost .bg-white, .theme-frost .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-frost .shadow-sm, .theme-frost .shadow-md, .theme-frost .shadow-lg, .theme-frost .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-frost .rounded-lg, .theme-frost .rounded-md { border-radius:8px !important; }
    .theme-frost .text-blue-600 { color: var(--accent-color) !important; }
    .theme-frost .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-frost .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-frost input, .theme-frost select, .theme-frost textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-frost input:focus, .theme-frost select:focus, .theme-frost textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(56,189,248,.22) !important; outline:none !important; }
    .theme-frost .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-cherry { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#701a1a; --subtle-text-color:#fb7185; --border-color:#fecdd3; --accent-color:#f43f5e; --accent-hover-color:#e11d48; }
    .theme-cherry body, .theme-cherry .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-cherry .bg-white, .theme-cherry .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-cherry .shadow-sm, .theme-cherry .shadow-md, .theme-cherry .shadow-lg, .theme-cherry .shadow-xl { box-shadow:0 2px 6px rgba(244,63,94,.12) !important; border:1px solid var(--border-color); }
    .theme-cherry .rounded-lg, .theme-cherry .rounded-md { border-radius:10px !important; }
    .theme-cherry .text-blue-600 { color: var(--accent-color) !important; }
    .theme-cherry .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-cherry .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-cherry input, .theme-cherry select, .theme-cherry textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-cherry input:focus, .theme-cherry select:focus, .theme-cherry textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(244,63,94,.22) !important; outline:none !important; }
    .theme-cherry .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-espresso { --bg-color:#f5f5f4; --card-bg-color:#ffffff; --text-color:#1c1917; --subtle-text-color:#a8a29e; --border-color:#e7e5e4; --accent-color:#7c2d12; --accent-hover-color:#4a1d09; }
    .theme-espresso body, .theme-espresso .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-espresso .bg-white, .theme-espresso .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-espresso .shadow-sm, .theme-espresso .shadow-md, .theme-espresso .shadow-lg, .theme-espresso .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-espresso .rounded-lg, .theme-espresso .rounded-md { border-radius:8px !important; }
    .theme-espresso .text-blue-600 { color: var(--accent-color) !important; }
    .theme-espresso .bg-blue-600 { background: var(--accent-color) !important; color:#fff !important; }
    .theme-espresso .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-espresso input, .theme-espresso select, .theme-espresso textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-espresso input:focus, .theme-espresso select:focus, .theme-espresso textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(124,45,18,.22) !important; outline:none !important; }
    .theme-espresso .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-mocha { --bg-color:#f5efe6; --card-bg-color:#ffffff; --text-color:#3f2d20; --subtle-text-color:#a16207; --border-color:#eadbd1; --accent-color:#9a3412; --accent-hover-color:#7c2d12; }
    .theme-mocha body, .theme-mocha .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-mocha .bg-white, .theme-mocha .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-mocha .shadow-sm, .theme-mocha .shadow-md, .theme-mocha .shadow-lg, .theme-mocha .shadow-xl { box-shadow:0 1px 3px rgba(154,52,18,.10) !important; border:1px solid var(--border-color); }
    .theme-mocha .rounded-lg, .theme-mocha .rounded-md { border-radius:10px !important; }
    .theme-mocha .text-blue-600 { color: var(--accent-color) !important; }
    .theme-mocha .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-mocha .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-mocha input, .theme-mocha select, .theme-mocha textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-mocha input:focus, .theme-mocha select:focus, .theme-mocha textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(154,52,18,.22) !important; outline:none !important; }
    .theme-mocha .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-avocado { --bg-color:#f7fee7; --card-bg-color:#ffffff; --text-color:#1a2e05; --subtle-text-color:#84cc16; --border-color:#d9f99d; --accent-color:#65a30d; --accent-hover-color:#4d7c0f; }
    .theme-avocado body, .theme-avocado .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-avocado .bg-white, .theme-avocado .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-avocado .shadow-sm, .theme-avocado .shadow-md, .theme-avocado .shadow-lg, .theme-avocado .shadow-xl { box-shadow:0 1px 3px rgba(101,163,13,.12) !important; border:1px solid var(--border-color); }
    .theme-avocado .rounded-lg, .theme-avocado .rounded-md { border-radius:8px !important; }
    .theme-avocado .text-blue-600 { color: var(--accent-color) !important; }
    .theme-avocado .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-avocado .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-avocado input, .theme-avocado select, .theme-avocado textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-avocado input:focus, .theme-avocado select:focus, .theme-avocado textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(101,163,13,.22) !important; outline:none !important; }
    .theme-avocado .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-banana { --bg-color:#fef9c3; --card-bg-color:#ffffff; --text-color:#3f2d1c; --subtle-text-color:#facc15; --border-color:#fde68a; --accent-color:#eab308; --accent-hover-color:#ca8a04; }
    .theme-banana body, .theme-banana .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-banana .bg-white, .theme-banana .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-banana .shadow-sm, .theme-banana .shadow-md, .theme-banana .shadow-lg, .theme-banana .shadow-xl { box-shadow:0 1px 3px rgba(234,179,8,.12) !important; border:1px solid var(--border-color); }
    .theme-banana .rounded-lg, .theme-banana .rounded-md { border-radius:10px !important; }
    .theme-banana .text-blue-600 { color: var(--accent-color) !important; }
    .theme-banana .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-banana .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-banana input, .theme-banana select, .theme-banana textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-banana input:focus, .theme-banana select:focus, .theme-banana textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(234,179,8,.22) !important; outline:none !important; }
    .theme-banana .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-plumeria { --bg-color:#fff7fb; --card-bg-color:#ffffff; --text-color:#4a1d2b; --subtle-text-color:#f472b6; --border-color:#fde2f2; --accent-color:#be185d; --accent-hover-color:#9d174d; }
    .theme-plumeria body, .theme-plumeria .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-plumeria .bg-white, .theme-plumeria .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-plumeria .shadow-sm, .theme-plumeria .shadow-md, .theme-plumeria .shadow-lg, .theme-plumeria .shadow-xl { box-shadow:0 2px 6px rgba(190,24,93,.10) !important; border:1px solid var(--border-color); }
    .theme-plumeria .rounded-lg, .theme-plumeria .rounded-md { border-radius:10px !important; }
    .theme-plumeria .text-blue-600 { color: var(--accent-color) !important; }
    .theme-plumeria .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-plumeria .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-plumeria input, .theme-plumeria select, .theme-plumeria textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-plumeria input:focus, .theme-plumeria select:focus, .theme-plumeria textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(190,24,93,.20) !important; outline:none !important; }
    .theme-plumeria .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-reef { --bg-color:#ecfeff; --card-bg-color:#ffffff; --text-color:#164e63; --subtle-text-color:#22d3ee; --border-color:#cffafe; --accent-color:#06b6d4; --accent-hover-color:#0891b2; }
    .theme-reef body, .theme-reef .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-reef .bg-white, .theme-reef .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-reef .shadow-sm, .theme-reef .shadow-md, .theme-reef .shadow-lg, .theme-reef .shadow-xl { box-shadow:0 1px 3px rgba(6,182,212,.12) !important; border:1px solid var(--border-color); }
    .theme-reef .rounded-lg, .theme-reef .rounded-md { border-radius:8px !important; }
    .theme-reef .text-blue-600 { color: var(--accent-color) !important; }
    .theme-reef .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-reef .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-reef input, .theme-reef select, .theme-reef textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-reef input:focus, .theme-reef select:focus, .theme-reef textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(6,182,212,.22) !important; outline:none !important; }
    .theme-reef .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-seafoam { --bg-color:#f0fdfa; --card-bg-color:#ffffff; --text-color:#134e4a; --subtle-text-color:#14b8a6; --border-color:#ccfbf1; --accent-color:#0d9488; --accent-hover-color:#0f766e; }
    .theme-seafoam body, .theme-seafoam .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-seafoam .bg-white, .theme-seafoam .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-seafoam .shadow-sm, .theme-seafoam .shadow-md, .theme-seafoam .shadow-lg, .theme-seafoam .shadow-xl { box-shadow:0 1px 3px rgba(13,148,136,.12) !important; border:1px solid var(--border-color); }
    .theme-seafoam .rounded-lg, .theme-seafoam .rounded-md { border-radius:8px !important; }
    .theme-seafoam .text-blue-600 { color: var(--accent-color) !important; }
    .theme-seafoam .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-seafoam .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-seafoam input, .theme-seafoam select, .theme-seafoam textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-seafoam input:focus, .theme-seafoam select:focus, .theme-seafoam textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(13,148,136,.22) !important; outline:none !important; }
    .theme-seafoam .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-pine { --bg-color:#ecfdf5; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#34d399; --border-color:#d1fae5; --accent-color:#065f46; --accent-hover-color:#064e3b; }
    .theme-pine body, .theme-pine .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-pine .bg-white, .theme-pine .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-pine .shadow-sm, .theme-pine .shadow-md, .theme-pine .shadow-lg, .theme-pine .shadow-xl { box-shadow:0 1px 3px rgba(6,95,70,.12) !important; border:1px solid var(--border-color); }
    .theme-pine .rounded-lg, .theme-pine .rounded-md { border-radius:10px !important; }
    .theme-pine .text-blue-600 { color: var(--accent-color) !important; }
    .theme-pine .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-pine .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-pine input, .theme-pine select, .theme-pine textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-pine input:focus, .theme-pine select:focus, .theme-pine textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(6,95,70,.22) !important; outline:none !important; }
    .theme-pine .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-iron { --bg-color:#f1f5f9; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#475569; --accent-hover-color:#334155; }
    .theme-iron body, .theme-iron .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-iron .bg-white, .theme-iron .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-iron .shadow-sm, .theme-iron .shadow-md, .theme-iron .shadow-lg, .theme-iron .shadow-xl { box-shadow:0 1px 3px rgba(15,23,42,.08) !important; border:1px solid var(--border-color); }
    .theme-iron .rounded-lg, .theme-iron .rounded-md { border-radius:8px !important; }
    .theme-iron .text-blue-600 { color: var(--accent-color) !important; }
    .theme-iron .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-iron .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-iron input, .theme-iron select, .theme-iron textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:6px !important; }
    .theme-iron input:focus, .theme-iron select:focus, .theme-iron textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(71,85,105,.2) !important; outline:none !important; }
    .theme-iron .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-carbon { --bg-color:#0b0c10; --card-bg-color:#151820; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2e3340; --accent-color:#22c55e; --accent-hover-color:#16a34a; }
    .theme-carbon body, .theme-carbon .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-carbon .bg-white, .theme-carbon .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-carbon .shadow-sm, .theme-carbon .shadow-md, .theme-carbon .shadow-lg, .theme-carbon .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.4) !important; border:1px solid var(--border-color); }
    .theme-carbon .rounded-lg, .theme-carbon .rounded-md { border-radius:6px !important; }
    .theme-carbon .text-blue-600 { color: var(--accent-color) !important; }
    .theme-carbon .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-carbon .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-carbon input, .theme-carbon select, .theme-carbon textarea { background:#151820 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-carbon input:focus, .theme-carbon select:focus, .theme-carbon textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(34,197,94,.28) !important; outline:none !important; }
    .theme-carbon .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-navy { --bg-color:#e0e7ff; --card-bg-color:#ffffff; --text-color:#1e3a8a; --subtle-text-color:#6366f1; --border-color:#c7d2fe; --accent-color:#4f46e5; --accent-hover-color:#4338ca; }
    .theme-navy body, .theme-navy .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-navy .bg-white, .theme-navy .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-navy .shadow-sm, .theme-navy .shadow-md, .theme-navy .shadow-lg, .theme-navy .shadow-xl { box-shadow:0 1px 3px rgba(79,70,229,.12) !important; border:1px solid var(--border-color); }
    .theme-navy .rounded-lg, .theme-navy .rounded-md { border-radius:8px !important; }
    .theme-navy .text-blue-600 { color: var(--accent-color) !important; }
    .theme-navy .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-navy .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-navy input, .theme-navy select, .theme-navy textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-navy input:focus, .theme-navy select:focus, .theme-navy textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(79,70,229,.22) !important; outline:none !important; }
    .theme-navy .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-air { --bg-color:#eef2ff; --card-bg-color:#ffffff; --text-color:#0c4a6e; --subtle-text-color:#60a5fa; --border-color:#e0e7ff; --accent-color:#38bdf8; --accent-hover-color:#0ea5e9; }
    .theme-air body, .theme-air .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-air .bg-white, .theme-air .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-air .shadow-sm, .theme-air .shadow-md, .theme-air .shadow-lg, .theme-air .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-air .rounded-lg, .theme-air .rounded-md { border-radius:10px !important; }
    .theme-air .text-blue-600 { color: var(--accent-color) !important; }
    .theme-air .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-air .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-air input, .theme-air select, .theme-air textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-air input:focus, .theme-air select:focus, .theme-air textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(56,189,248,.22) !important; outline:none !important; }
    .theme-air .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-violet { --bg-color:#f5f3ff; --card-bg-color:#ffffff; --text-color:#4c1d95; --subtle-text-color:#a78bfa; --border-color:#ddd6fe; --accent-color:#8b5cf6; --accent-hover-color:#7c3aed; }
    .theme-violet body, .theme-violet .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-violet .bg-white, .theme-violet .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-violet .shadow-sm, .theme-violet .shadow-md, .theme-violet .shadow-lg, .theme-violet .shadow-xl { box-shadow:0 1px 3px rgba(139,92,246,.12) !important; border:1px solid var(--border-color); }
    .theme-violet .rounded-lg, .theme-violet .rounded-md { border-radius:8px !important; }
    .theme-violet .text-blue-600 { color: var(--accent-color) !important; }
    .theme-violet .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-violet .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-violet input, .theme-violet select, .theme-violet textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-violet input:focus, .theme-violet select:focus, .theme-violet textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(139,92,246,.22) !important; outline:none !important; }
    .theme-violet .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-caramel { --bg-color:#fff7ed; --card-bg-color:#ffffff; --text-color:#7c2d12; --subtle-text-color:#fb923c; --border-color:#fed7aa; --accent-color:#ea580c; --accent-hover-color:#c2410c; }
    .theme-caramel body, .theme-caramel .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-caramel .bg-white, .theme-caramel .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-caramel .shadow-sm, .theme-caramel .shadow-md, .theme-caramel .shadow-lg, .theme-caramel .shadow-xl { box-shadow:0 1px 3px rgba(234,88,12,.12) !important; border:1px solid var(--border-color); }
    .theme-caramel .rounded-lg, .theme-caramel .rounded-md { border-radius:8px !important; }
    .theme-caramel .text-blue-600 { color: var(--accent-color) !important; }
    .theme-caramel .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-caramel .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-caramel input, .theme-caramel select, .theme-caramel textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-caramel input:focus, .theme-caramel select:focus, .theme-caramel textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(234,88,12,.22) !important; outline:none !important; }
    .theme-caramel .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-peach { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#7c2d12; --subtle-text-color:#fb7185; --border-color:#fecdd3; --accent-color:#f97316; --accent-hover-color:#ea580c; }
    .theme-peach body, .theme-peach .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-peach .bg-white, .theme-peach .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-peach .shadow-sm, .theme-peach .shadow-md, .theme-peach .shadow-lg, .theme-peach .shadow-xl { box-shadow:0 1px 3px rgba(249,115,22,.12) !important; border:1px solid var(--border-color); }
    .theme-peach .rounded-lg, .theme-peach .rounded-md { border-radius:10px !important; }
    .theme-peach .text-blue-600 { color: var(--accent-color) !important; }
    .theme-peach .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-peach .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-peach input, .theme-peach select, .theme-peach textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-peach input:focus, .theme-peach select:focus, .theme-peach textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(249,115,22,.22) !important; outline:none !important; }
    .theme-peach .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-lilac { --bg-color:#faf5ff; --card-bg-color:#ffffff; --text-color:#4c1d95; --subtle-text-color:#c4b5fd; --border-color:#e9d5ff; --accent-color:#a78bfa; --accent-hover-color:#8b5cf6; }
    .theme-lilac body, .theme-lilac .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-lilac .bg-white, .theme-lilac .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-lilac .shadow-sm, .theme-lilac .shadow-md, .theme-lilac .shadow-lg, .theme-lilac .shadow-xl { box-shadow:0 1px 3px rgba(167,139,250,.12) !important; border:1px solid var(--border-color); }
    .theme-lilac .rounded-lg, .theme-lilac .rounded-md { border-radius:8px !important; }
    .theme-lilac .text-blue-600 { color: var(--accent-color) !important; }
    .theme-lilac .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-lilac .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-lilac input, .theme-lilac select, .theme-lilac textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-lilac input:focus, .theme-lilac select:focus, .theme-lilac textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(167,139,250,.22) !important; outline:none !important; }
    .theme-lilac .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-rose { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#4a1d2b; --subtle-text-color:#f472b6; --border-color:#fecdd3; --accent-color:#ec4899; --accent-hover-color:#db2777; }
    .theme-rose body, .theme-rose .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-rose .bg-white, .theme-rose .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-rose .shadow-sm, .theme-rose .shadow-md, .theme-rose .shadow-lg, .theme-rose .shadow-xl { box-shadow:0 1px 3px rgba(236,72,153,.12) !important; border:1px solid var(--border-color); }
    .theme-rose .rounded-lg, .theme-rose .rounded-md { border-radius:10px !important; }
    .theme-rose .text-blue-600 { color: var(--accent-color) !important; }
    .theme-rose .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-rose .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-rose input, .theme-rose select, .theme-rose textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-rose input:focus, .theme-rose select:focus, .theme-rose textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(236,72,153,.22) !important; outline:none !important; }
    .theme-rose .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-magenta { --bg-color:#fdf4ff; --card-bg-color:#ffffff; --text-color:#4a044e; --subtle-text-color:#d946ef; --border-color:#f5d0fe; --accent-color:#a21caf; --accent-hover-color:#86198f; }
    .theme-magenta body, .theme-magenta .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-magenta .bg-white, .theme-magenta .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-magenta .shadow-sm, .theme-magenta .shadow-md, .theme-magenta .shadow-lg, .theme-magenta .shadow-xl { box-shadow:0 1px 3px rgba(162,28,175,.12) !important; border:1px solid var(--border-color); }
    .theme-magenta .rounded-lg, .theme-magenta .rounded-md { border-radius:10px !important; }
    .theme-magenta .text-blue-600 { color: var(--accent-color) !important; }
    .theme-magenta .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-magenta .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-magenta input, .theme-magenta select, .theme-magenta textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-magenta input:focus, .theme-magenta select:focus, .theme-magenta textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(162,28,175,.22) !important; outline:none !important; }
    .theme-magenta .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-periwinkle { --bg-color:#eef2ff; --card-bg-color:#ffffff; --text-color:#3730a3; --subtle-text-color:#93c5fd; --border-color:#e0e7ff; --accent-color:#6366f1; --accent-hover-color:#4f46e5; }
    .theme-periwinkle body, .theme-periwinkle .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-periwinkle .bg-white, .theme-periwinkle .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-periwinkle .shadow-sm, .theme-periwinkle .shadow-md, .theme-periwinkle .shadow-lg, .theme-periwinkle .shadow-xl { box-shadow:0 1px 3px rgba(99,102,241,.12) !important; border:1px solid var(--border-color); }
    .theme-periwinkle .rounded-lg, .theme-periwinkle .rounded-md { border-radius:8px !important; }
    .theme-periwinkle .text-blue-600 { color: var(--accent-color) !important; }
    .theme-periwinkle .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-periwinkle .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-periwinkle input, .theme-periwinkle select, .theme-periwinkle textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-periwinkle input:focus, .theme-periwinkle select:focus, .theme-periwinkle textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(99,102,241,.22) !important; outline:none !important; }
    .theme-periwinkle .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-teak { --bg-color:#f9f5f2; --card-bg-color:#ffffff; --text-color:#3f2d20; --subtle-text-color:#a16207; --border-color:#eadbd1; --accent-color:#8b5e34; --accent-hover-color:#734a2e; }
    .theme-teak body, .theme-teak .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-teak .bg-white, .theme-teak .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-teak .shadow-sm, .theme-teak .shadow-md, .theme-teak .shadow-lg, .theme-teak .shadow-xl { box-shadow:0 1px 3px rgba(139,94,52,.10) !important; border:1px solid var(--border-color); }
    .theme-teak .rounded-lg, .theme-teak .rounded-md { border-radius:10px !important; }
    .theme-teak .text-blue-600 { color: var(--accent-color) !important; }
    .theme-teak .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-teak .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-teak input, .theme-teak select, .theme-teak textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-teak input:focus, .theme-teak select:focus, .theme-teak textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(139,94,52,.22) !important; outline:none !important; }
    .theme-teak .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* 魯紅主題 - 基於訪客資料與新增申請單的紅色設計 */
    .theme-luhong {
        --bg-color: #FEF6F5; /* 淡粉色背景，來自SVG */
        --card-bg-color: #ffffff;
        --text-color: #2C1B1D; /* 深色文字，與紅色主題配合 */
        --subtle-text-color: #6B2C30;
        --border-color: #E8C5C7; /* 淡紅邊框，基於主色調 */
        --accent-color: #B6494E; /* 主要紅色，直接來自SVG */
        --accent-hover-color: #A03E43;
        --secondary-light: #FDF2F2; /* 極淡粉色 */
        --secondary-dark: #8B3A3F; /* 深紅色 */

        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-light) 50%, var(--bg-color) 100%) !important;
        color: var(--text-color) !important;
        font-family: 'Noto Sans TC', sans-serif !important;
    }
    .theme-luhong body, .theme-luhong .bg-gray-50 { 
        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-light) 50%, var(--bg-color) 100%) !important; 
    }
    .theme-luhong .bg-white, .theme-luhong .bg-gray-100 { 
        background: var(--card-bg-color) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 12px !important;
        box-shadow: 0 4px 20px rgba(182, 73, 78, 0.15) !important;
    }
    .theme-luhong .shadow-sm, .theme-luhong .shadow-md, .theme-luhong .shadow-lg, .theme-luhong .shadow-xl { 
        box-shadow: 0 4px 20px rgba(182, 73, 78, 0.15) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 12px !important;
    }
    .theme-luhong .rounded-lg, .theme-luhong .rounded-md { border-radius: 12px !important; }
    .theme-luhong .border, .theme-luhong .border-gray-300, .theme-luhong .border-gray-200, .theme-luhong .divide-y > :not([hidden]) ~ :not([hidden]), .theme-luhong .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
        border-color: var(--border-color) !important;
        border-width: 2px !important;
    }
    .theme-luhong .text-gray-900, .theme-luhong .text-gray-800, .theme-luhong .text-gray-700 { color: var(--text-color) !important; font-weight: 600 !important; }
    .theme-luhong .text-gray-600, .theme-luhong .text-gray-500 { color: var(--subtle-text-color) !important; }
    .theme-luhong .text-blue-600 { color: var(--accent-color) !important; font-weight: bold !important; }
    .theme-luhong .bg-blue-600 { 
        background: linear-gradient(45deg, var(--accent-color), var(--secondary-dark)) !important; 
        border-radius: 10px !important;
        transition: all 0.3s ease !important;
    }
    .theme-luhong .bg-blue-600:hover { 
        background: linear-gradient(45deg, var(--accent-hover-color), var(--accent-color)) !important; 
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(182, 73, 78, 0.4) !important;
    }
    .theme-luhong input, .theme-luhong select, .theme-luhong textarea { 
        background: rgba(255, 255, 255, 0.95) !important; 
        border: 2px solid var(--border-color) !important; 
        border-radius: 10px !important; 
        padding: 10px 14px !important;
        transition: all 0.3s ease !important;
    }
    .theme-luhong input:focus, .theme-luhong select:focus, .theme-luhong textarea:focus { 
        border-color: var(--accent-color) !important; 
        box-shadow: 0 0 0 4px rgba(182, 73, 78, 0.2) !important; 
        outline: none !important; 
        transform: scale(1.02) !important;
        background: #ffffff !important;
    }
    .theme-luhong .tab-button.active { 
        border-color: var(--accent-color) !important; 
        color: var(--accent-color) !important; 
        background: rgba(182, 73, 78, 0.1) !important;
        border-radius: 8px !important;
        font-weight: bold !important;
    }
    .theme-luhong .hover\:bg-gray-50:hover { 
        background: linear-gradient(45deg, var(--secondary-light), var(--bg-color)) !important; 
        transition: all 0.3s ease !important;
    }
    .theme-luhong button { 
        transition: all 0.3s ease !important; 
        border-radius: 8px !important;
    }
    .theme-luhong button:hover { 
        transform: translateY(-1px) !important; 
    }

    /* 魯綠主題 - 基於訪客資料與新增申請單的綠色設計 */
    .theme-lugreen {
        --bg-color: #F0F8F5; /* 淡綠色背景 */
        --card-bg-color: #ffffff;
        --text-color: #313A46; /* 深色文字 */
        --subtle-text-color: #555E68;
        --border-color: #C5E4D6; /* 淡綠邊框 */
        --accent-color: #2CC185; /* 主要綠色 */
        --accent-hover-color: #24A36B;
        --secondary-light: #E8F5F0; /* 極淡綠色 */
        --secondary-dark: #1B7F5A; /* 深綠色 */

        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-light) 50%, var(--bg-color) 100%) !important;
        color: var(--text-color) !important;
        font-family: 'Noto Sans TC', sans-serif !important;
    }
    .theme-lugreen body, .theme-lugreen .bg-gray-50 { 
        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-light) 50%, var(--bg-color) 100%) !important; 
    }
    .theme-lugreen .bg-white, .theme-lugreen .bg-gray-100 { 
        background: var(--card-bg-color) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 12px !important;
        box-shadow: 0 4px 20px rgba(44, 193, 133, 0.15) !important;
    }
    .theme-lugreen .shadow-sm, .theme-lugreen .shadow-md, .theme-lugreen .shadow-lg, .theme-lugreen .shadow-xl { 
        box-shadow: 0 4px 20px rgba(44, 193, 133, 0.15) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 12px !important;
    }
    .theme-lugreen .rounded-lg, .theme-lugreen .rounded-md { border-radius: 12px !important; }
    .theme-lugreen .border, .theme-lugreen .border-gray-300, .theme-lugreen .border-gray-200, .theme-lugreen .divide-y > :not([hidden]) ~ :not([hidden]), .theme-lugreen .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
        border-color: var(--border-color) !important;
        border-width: 2px !important;
    }
    .theme-lugreen .text-gray-900, .theme-lugreen .text-gray-800, .theme-lugreen .text-gray-700 { color: var(--text-color) !important; font-weight: 600 !important; }
    .theme-lugreen .text-gray-600, .theme-lugreen .text-gray-500 { color: var(--subtle-text-color) !important; }
    .theme-lugreen .text-blue-600 { color: var(--accent-color) !important; font-weight: bold !important; }
    .theme-lugreen .bg-blue-600 { 
        background: linear-gradient(45deg, var(--accent-color), var(--secondary-dark)) !important; 
        border-radius: 10px !important;
        transition: all 0.3s ease !important;
    }
    .theme-lugreen .bg-blue-600:hover { 
        background: linear-gradient(45deg, var(--accent-hover-color), var(--accent-color)) !important; 
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(44, 193, 133, 0.4) !important;
    }
    .theme-lugreen input, .theme-lugreen select, .theme-lugreen textarea { 
        background: rgba(255, 255, 255, 0.95) !important; 
        border: 2px solid var(--border-color) !important; 
        border-radius: 10px !important; 
        padding: 10px 14px !important;
        transition: all 0.3s ease !important;
    }
    .theme-lugreen input:focus, .theme-lugreen select:focus, .theme-lugreen textarea:focus { 
        border-color: var(--accent-color) !important; 
        box-shadow: 0 0 0 4px rgba(44, 193, 133, 0.2) !important; 
        outline: none !important; 
        transform: scale(1.02) !important;
        background: #ffffff !important;
    }
    .theme-lugreen .tab-button.active { 
        border-color: var(--accent-color) !important; 
        color: var(--accent-color) !important; 
        background: rgba(44, 193, 133, 0.1) !important;
        border-radius: 8px !important;
        font-weight: bold !important;
    }
    .theme-lugreen .hover\:bg-gray-50:hover { 
        background: linear-gradient(45deg, var(--secondary-light), var(--bg-color)) !important; 
        transition: all 0.3s ease !important;
    }
    .theme-lugreen button { 
        transition: all 0.3s ease !important; 
        border-radius: 8px !important;
    }
    .theme-lugreen button:hover { 
        transform: translateY(-1px) !important; 
    }

    /* 修復 flatpickr 在「多彩」「魯紅」「魯綠」主題下，月份/年份選取被週標題覆蓋的問題 */
    .theme-colorful .flatpickr-calendar,
    .theme-luhong .flatpickr-calendar,
    .theme-lugreen .flatpickr-calendar { 
        z-index: 9999 !important; /* 確保日曆本體浮在其他容器之上 */
    }
    .theme-colorful .flatpickr-calendar .flatpickr-months,
    .theme-luhong .flatpickr-calendar .flatpickr-months,
    .theme-lugreen .flatpickr-calendar .flatpickr-months { 
        position: relative; 
        z-index: 3;              /* 月份/年份列優先顯示於週標題之上 */
        background: var(--card-bg-color, #ffffff); 
        padding-bottom: 6px;     /* 與週標題留間距，避免視覺堆疊 */
    }
    .theme-colorful .flatpickr-calendar .flatpickr-weekdays,
    .theme-luhong .flatpickr-calendar .flatpickr-weekdays,
    .theme-lugreen .flatpickr-calendar .flatpickr-weekdays { 
        position: relative; 
        z-index: 1;              /* 週標題層級較低，不覆蓋月份/年份 */
    }
    .theme-colorful .flatpickr-calendar .flatpickr-current-month,
    .theme-luhong .flatpickr-calendar .flatpickr-current-month,
    .theme-lugreen .flatpickr-calendar .flatpickr-current-month { 
        position: relative; 
        z-index: 4;              /* 年度輸入與月份下拉再提高一層，確保點擊區域不被遮擋 */
        line-height: 1.4;        /* 增加可讀性並避免擠壓 */
        padding-top: 2px; 
        padding-bottom: 2px; 
    }
    /* 置中月份/年份，與櫻花(預設)一致 */
    .theme-colorful .flatpickr-calendar .flatpickr-current-month { text-align: center !important; position: absolute !important; left: 0; right: 0; width: 100%; }
    .theme-luhong .flatpickr-calendar .flatpickr-current-month { text-align: center !important; position: absolute !important; left: 0; right: 0; width: 100%; }
    .theme-lugreen .flatpickr-calendar .flatpickr-current-month { text-align: center !important; position: absolute !important; left: 0; right: 0; width: 100%; }
    /* 多彩/魯紅/魯綠：讓月份/年份欄位尺寸與櫻花主題一致（回到 flatpickr 預設的精簡尺寸） */
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-colorful .flatpickr-calendar .numInputWrapper input { 
        padding: 0 !important;               /* 去除多彩主題對 input/select 的內邊距放大 */
    border: 1px solid var(--border-color) !important; /* 預設就有邊框顏色 */
        background: transparent !important;  /* 與預設一致 */
        border-radius: 0 !important;         /* 與預設一致的直角控件 */
        box-shadow: none !important;         /* 移除多彩主題可能加上的陰影 */
    text-align: center !important;       /* 明確置中文本，與櫻花一致 */
    }
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-luhong .flatpickr-calendar .numInputWrapper input { 
        padding: 0 !important;
    border: 1px solid var(--border-color) !important;
        background: transparent !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        text-align: center !important;
    }
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input { 
        padding: 0 !important;
    border: 1px solid var(--border-color) !important;
        background: transparent !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        text-align: center !important;
    }

    /* 互動過渡：聚焦邊框/陰影/背景的動畫（鍵盤友善 :focus-visible） */
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-colorful .flatpickr-calendar .numInputWrapper input,
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-luhong .flatpickr-calendar .numInputWrapper input,
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input {
        transition: border-color 0.18s ease, box-shadow 0.18s ease, background-color 0.18s ease;
    }

    /* 微調 focus ring 濃度（各主題視覺一致性） */
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-colorful .flatpickr-calendar .numInputWrapper input:focus,
    .theme-colorful .flatpickr-calendar .numInputWrapper input:focus-visible {
        box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.28) !important;
    }
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-luhong .flatpickr-calendar .numInputWrapper input:focus,
    .theme-luhong .flatpickr-calendar .numInputWrapper input:focus-visible {
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.26) !important;
    }
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input:focus,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input:focus-visible {
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.24) !important;
    }
    /* 點到月份/年份時恢復邊框效果（:focus 與 :focus-visible） */
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-colorful .flatpickr-calendar .numInputWrapper input:focus,
    .theme-colorful .flatpickr-calendar .numInputWrapper input:focus-visible {
        border-color: var(--accent-color) !important;
        box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2) !important; /* 與多彩主題整體焦點風格一致 */
        outline: none !important;
        background: #ffffff !important; /* 聚焦時更清晰 */
    }
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-luhong .flatpickr-calendar .numInputWrapper input:focus,
    .theme-luhong .flatpickr-calendar .numInputWrapper input:focus-visible {
        border-color: var(--accent-color) !important;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
        outline: none !important;
        background: #ffffff !important;
    }
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input:focus,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input:focus-visible {
        border-color: var(--accent-color) !important;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2) !important;
        outline: none !important;
        background: #ffffff !important;
    }
    /* 月份下拉與年份數字輸入的局部層級提升（不同瀏覽器行為更穩定） */
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-colorful .flatpickr-calendar .numInputWrapper,
    .theme-luhong .flatpickr-calendar .numInputWrapper,
    .theme-lugreen .flatpickr-calendar .numInputWrapper { 
        position: relative; 
        z-index: 5; 
    }
    </style>
</head>
<body class="bg-gray-50 font-sans p-0 sm:p-4 md:p-8">

    <div id="notification-container"></div>
    
    <div id="app-header" class="mb-4"></div>

    <div id="app-container">
        <div id="loading-view" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center">
            <div class="spinner-container">
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
            </div>
            <p class="mt-8 text-gray-600 text-lg">讀取資料中...</p>
        </div>

        <div id="error-view" class="view p-8 text-center"></div>

        <div id="login-view" class="view"></div>
        <div id="dashboard-view" class="view"></div>
        <div id="newRequest-view" class="view"></div>
        <div id="detailView-view" class="view"></div>
        <div id="productManagement-view" class="view"></div>
        <div id="productForm-view" class="view"></div>
        <div id="personalForms-view" class="view"></div>
        <div id="userManagement-view" class="view"></div>
    <div id="departmentManagement-view" class="view"></div>
        <div id="userForm-view" class="view"></div>
    <div id="departmentForm-view" class="view"></div>
        <div id="vendorManagement-view" class="view"></div>
        <div id="vendorForm-view" class="view"></div>
        <div id="printManagement-view" class="view"></div>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-none mx-8 max-h-full overflow-y-auto p-6" style="width: 95vw;">
            </div>
    </div>

    <script type="module">
        // --- Theme Management ---
    const applyTheme = (theme) => {
            const themeClasses = ['theme-apple','theme-scifi','theme-ghibli','theme-abstract','theme-colorful','theme-luhong','theme-lugreen','theme-forest','theme-ocean','theme-sunset','theme-midnight','theme-sakura','theme-care-soft','theme-care-fresh','theme-med-clean','theme-med-trust','theme-hotel-lux','theme-hotel-resort','theme-nord','theme-latte','theme-mint','theme-solar','theme-slate','theme-metro','theme-pastel','theme-neon','theme-retro','theme-minimal','theme-paper','theme-grape','theme-cobalt','theme-sand','theme-rosewood','theme-aurora','theme-cocoa','theme-denim','theme-lime','theme-coral','theme-plum','theme-sky','theme-graphite','theme-pearl','theme-rust','theme-berry','theme-moss','theme-teal','theme-sepia','theme-charcoal','theme-ivory','theme-azure','theme-blush','theme-saffron','theme-indigo','theme-copper','theme-lavender','theme-steel','theme-clay','theme-cyan','theme-olive','theme-marigold','theme-orchid','theme-flamingo','theme-iceberg','theme-blossom','theme-jade','theme-cinder','theme-fern','theme-glacier','theme-ember','theme-horizon','theme-canyon','theme-lagoon','theme-meadow','theme-tundra','theme-dune','theme-willow','theme-bronze','theme-silver','theme-gold','theme-amethyst','theme-sapphire','theme-ruby','theme-emerald','theme-topaz','theme-garnet','theme-quartz','theme-onyx','theme-obsidian','theme-smoke','theme-cloud','theme-storm','theme-frost','theme-cherry','theme-espresso','theme-mocha','theme-avocado','theme-banana','theme-plumeria','theme-reef','theme-seafoam','theme-pine','theme-iron','theme-carbon','theme-navy','theme-air','theme-violet','theme-caramel','theme-peach','theme-lilac','theme-rose','theme-magenta','theme-periwinkle','theme-teak'];
            document.body.classList.remove(...themeClasses);
            const allThemes = ['apple','scifi','ghibli','abstract','colorful','luhong','lugreen','forest','ocean','sunset','midnight','sakura','care-soft','care-fresh','med-clean','med-trust','hotel-lux','hotel-resort','nord','latte','mint','solar','slate','metro','pastel','neon','retro','minimal','paper','grape','cobalt','sand','rosewood','aurora','cocoa','denim','lime','coral','plum','sky','graphite','pearl','rust','berry','moss','teal','sepia','charcoal','ivory','azure','blush','saffron','indigo','copper','lavender','steel','clay','cyan','olive','marigold','orchid','flamingo','iceberg','blossom','jade','cinder','fern','glacier','ember','horizon','canyon','lagoon','meadow','tundra','dune','willow','bronze','silver','gold','amethyst','sapphire','ruby','emerald','topaz','garnet','quartz','onyx','obsidian','smoke','cloud','storm','frost','cherry','espresso','mocha','avocado','banana','plumeria','reef','seafoam','pine','iron','carbon','navy','air','violet','caramel','peach','lilac','rose','magenta','periwinkle','teak'];
            if (theme === 'random') {
        const pick = allThemes[Math.floor(Math.random() * allThemes.length)];
        document.body.classList.add('theme-' + pick);
        // 將下拉選單顯示停留在抽到的實際主題
        const sel = document.getElementById('theme-select');
        if (sel) sel.value = pick;
        localStorage.setItem('appTheme', pick);
        state.theme = pick;
        return;
            } else if (theme && theme !== 'default') {
                document.body.classList.add('theme-' + theme);
            }
            localStorage.setItem('appTheme', theme);
            state.theme = theme;
        };

        const loadTheme = () => {
            const savedTheme = localStorage.getItem('appTheme') || 'random';
            applyTheme(savedTheme);
            // 載入申請菜單版型偏好
            const savedLayout = localStorage.getItem('menuLayout');
            if (savedLayout === 'compact' || savedLayout === 'expanded') {
                state.local = { ...state.local, layoutScale: savedLayout };
            }
        };

        // --- 工具函式 ---
        const getISODateString = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getFormattedDateTime = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\//g, '-');
        };
        // 附件列表專用：YYYY/MM/DD - HH:MM:SS（顯示秒數）
        const formatAttachmentDate = (timestamp) => {
            if (!timestamp) return '';
            const d = new Date(timestamp);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            const HH = String(d.getHours()).padStart(2, '0');
            const MM = String(d.getMinutes()).padStart(2, '0');
            const SS = String(d.getSeconds()).padStart(2, '0');
            return `${yyyy}/${mm}/${dd} - ${HH}:${MM}:${SS}`;
        };
        // 初步辨識是否像 Google Drive 檔案 ID：英數/底線/連字號，長度較長，且排除 UUID 8-4-4-4-12 格式
        const isLikelyDriveId = (val) => {
            if (!val || typeof val !== 'string') return false;
            const s = val.trim();
            // 排除 UUID v4 常見格式
            if (/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s)) return false;
            // Drive ID 常見為 20~70 多字元，由 A-Za-z0-9_- 組成（實際會更彈性，這裡取寬鬆判定）
            if (!/^[A-Za-z0-9_-]{15,}$/.test(s)) return false;
            return true;
        };
    // 可選的圖片代理（例如 Supabase Edge Function URL），若設定將優先使用
    const IMAGE_PROXY_BASE = 'https://htamptcakcnlmltwdcog.supabase.co/functions/v1/drive-image';
    // 附件 Edge Function 名稱（請於 Supabase 專案建立對應函數）
    const ATTACHMENT_UPLOAD_FN = 'upload-request-attachment';
    const ATTACHMENT_SIGNED_URL_FN = 'get-request-attachment-url';
    // 新增：附件刪除 Edge Function 名稱
    const ATTACHMENT_DELETE_FN = 'delete-request-attachment';
    const MAX_FILE_SIZE_BYTES = 1 * 1024 * 1024; // 1MB 上限（單檔）
        
        const showMessage = (message, type = 'success') => {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), type === 'error' ? 8000 : 3000);
        };

        // 全域工作中覆蓋層（顯示「處理資料中…」）
        function ensureWorkingOverlay() {
            let ov = document.getElementById('working-overlay');
            if (!ov) {
                ov = document.createElement('div');
                ov.id = 'working-overlay';
                ov.style.position = 'fixed';
                ov.style.inset = '0';
                ov.style.background = 'rgba(0,0,0,0.35)';
                ov.style.display = 'none';
                ov.style.zIndex = '9999';
                ov.style.backdropFilter = 'blur(1px)';
                const inner = document.createElement('div');
                inner.style.position = 'absolute';
                inner.style.top = '50%';
                inner.style.left = '50%';
                inner.style.transform = 'translate(-50%, -50%)';
                inner.style.background = 'white';
                inner.style.color = '#111827';
                inner.style.padding = '14px 18px';
                inner.style.borderRadius = '10px';
                inner.style.boxShadow = '0 10px 25px rgba(0,0,0,0.2)';
                inner.style.fontWeight = '600';
                inner.style.fontSize = '14px';
                inner.innerText = '處理資料中...';
                ov.appendChild(inner);
                document.body.appendChild(ov);
            }
            return ov;
        }
        function showWorking(text = '處理資料中...') {
            const ov = ensureWorkingOverlay();
            if (ov.firstChild) ov.firstChild.textContent = text;
            ov.style.display = 'block';
        }
        function hideWorking() {
            const ov = document.getElementById('working-overlay');
            if (ov) ov.style.display = 'none';
        }

        // 動態載入 ExcelJS（瀏覽器版）
        const ensureExcelJSLib = () => new Promise((resolve, reject) => {
            if (window.ExcelJS) return resolve(window.ExcelJS);
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js';
            script.onload = () => resolve(window.ExcelJS);
            script.onerror = () => reject(new Error('ExcelJS 載入失敗'));
            document.head.appendChild(script);
        });

    // 匯出時的圖片快取，避免重複抓圖/轉檔
        const exportImageCache = new Map(); // key: fileId, val: { base64, ext }

        // 將 ArrayBuffer 轉為 base64（去除 data URL 前綴）
        const arrayBufferToBase64 = (buf, mime) => new Promise((resolve, reject) => {
            try {
                const blob = new Blob([buf], { type: mime || 'application/octet-stream' });
                const reader = new FileReader();
                reader.onload = () => {
                    const dataUrl = reader.result || '';
                    const commaIdx = String(dataUrl).indexOf(',');
                    resolve(commaIdx >= 0 ? String(dataUrl).slice(commaIdx + 1) : String(dataUrl));
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            } catch (e) {
                reject(e);
            }
        });

    // 單位換算
    const cmToPx = (cm) => (cm * 96) / 2.54; // 96DPI 假設

    // 兼容性：加入隱藏欄多行內容，促使 Excel 接受自訂列高
    function applyRowHeightHack(ws, targetPt = 40) {
        try {
            const hackCol = (ws.columnCount || 0) + 1;
            const col = ws.getColumn(hackCol);
            col.width = 1;
            col.hidden = true;
            const approxLine = Math.max(1, Math.ceil(targetPt / 15));
            const val = Array.from({ length: approxLine }).map(() => 'x').join('\n');
            const maxRow = ws.rowCount || 0;
            for (let rowNumber = 1; rowNumber <= maxRow; rowNumber++) {
                const cell = ws.getCell(rowNumber, hackCol);
                cell.value = val;
                cell.alignment = { wrapText: true, vertical: 'top', horizontal: 'left' };
            }
        } catch (_) {}
    }

    // 兼容性（加強）：在既有可見欄位（內容結尾）插入多行零寬字元，逼迫 Excel 實際拉高列高
    function applyRowHeightVisibleHack(ws, targetPt = 40, colIndex = 1) {
        try {
            const approxLine = Math.max(1, Math.ceil(targetPt / 15));
            const zws = '\u200B';
            const suffix = Array.from({ length: approxLine }).map(() => zws).join('\n');
            const maxRow = ws.rowCount || 0;
            for (let rowNumber = 1; rowNumber <= maxRow; rowNumber++) {
                const cell = ws.getCell(rowNumber, colIndex);
                const v = cell.value;
                if (v == null) {
                    cell.value = suffix;
                } else if (typeof v === 'string') {
                    cell.value = v + '\n' + suffix;
                } else {
                    cell.value = String(v) + '\n' + suffix;
                }
                const align = cell.alignment || {};
                cell.alignment = { ...align, wrapText: true, vertical: 'top', horizontal: 'left' };
            }
        } catch (_) {}
    }
    
    // 以固定並發數預取圖片，加速整體匯出
    async function prefetchImages(fileIds, concurrency = 6) {
        const ids = Array.from(new Set((fileIds || []).filter(Boolean)));
        const queue = ids.slice();
        const running = [];
        const launch = () => {
            if (!queue.length) return null;
            const id = queue.shift();
            const p = fetchDriveImageBuffer(id).catch(() => null).finally(() => {
                const i = running.indexOf(p);
                if (i >= 0) running.splice(i, 1);
            });
            running.push(p);
            return p;
        };
        // 初始並發
        for (let i = 0; i < concurrency; i++) launch();
        while (queue.length || running.length) {
            await Promise.race(running);
            while (running.length < concurrency && queue.length) launch();
        }
    }

    // 將任意影像 ArrayBuffer 轉成 PNG ArrayBuffer（解決 webp/gif 在 Excel 不支援的問題）
        const transcodeToPng = async (buf) => {
            const blob = new Blob([buf]);
            // 盡量使用 createImageBitmap + OffscreenCanvas（較快）
            try {
                if (typeof createImageBitmap === 'function') {
                    const bitmap = await createImageBitmap(blob);
                    if (typeof OffscreenCanvas !== 'undefined') {
                        const c = new OffscreenCanvas(bitmap.width || 1, bitmap.height || 1);
                        const ctx = c.getContext('2d');
                        ctx.drawImage(bitmap, 0, 0);
                        const pngBlob = await c.convertToBlob({ type: 'image/png', quality: 0.92 });
                        return await pngBlob.arrayBuffer();
                    } else {
                        // 瀏覽器不支援 OffscreenCanvas，退回一般 <canvas>
                        const canvas = document.createElement('canvas');
                        canvas.width = bitmap.width || 1;
                        canvas.height = bitmap.height || 1;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(bitmap, 0, 0);
                        const pngBlob = await new Promise((res) => canvas.toBlob(res, 'image/png', 0.92));
                        return pngBlob ? await pngBlob.arrayBuffer() : buf;
                    }
                }
            } catch (_) { /* 忽略，改用 <img> 方案 */ }

            // 傳統 <img> + <canvas> 方案
            const img = new Image();
            return await new Promise((resolve, reject) => {
                const url = URL.createObjectURL(blob);
                img.onload = async () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth || 1;
                        canvas.height = img.naturalHeight || 1;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        URL.revokeObjectURL(url);
                        canvas.toBlob(async (pngBlob) => {
                            resolve(pngBlob ? await pngBlob.arrayBuffer() : buf);
                        }, 'image/png', 0.92);
                    } catch (e) {
                        URL.revokeObjectURL(url);
                        resolve(buf);
                    }
                };
                img.onerror = () => {
                    URL.revokeObjectURL(url);
                    resolve(buf);
                };
                img.src = url;
            });
        };

        // 由影像 ArrayBuffer 取得原始寬高
        async function getImageDimensions(buf) {
            try {
                const blob = new Blob([buf]);
                if (typeof createImageBitmap === 'function') {
                    const bitmap = await createImageBitmap(blob);
                    return { width: bitmap.width || 0, height: bitmap.height || 0 };
                }
            } catch (_) { /* ignore */ }
            return await new Promise((resolve) => {
                const img = new Image();
                const url = URL.createObjectURL(new Blob([buf]));
                img.onload = () => {
                    const w = img.naturalWidth || 0;
                    const h = img.naturalHeight || 0;
                    URL.revokeObjectURL(url);
                    resolve({ width: w, height: h });
                };
                img.onerror = () => {
                    URL.revokeObjectURL(url);
                    resolve({ width: 0, height: 0 });
                };
                img.src = url;
            });
        }

        // 從欄位值提取 Drive id 或回傳原始 url
        const parseDriveRef = (val) => {
            if (!val) return null;
            if (/^https?:\/\//i.test(val)) {
                try {
                    const u = new URL(val);
                    const idParam = u.searchParams.get('id');
                    if (idParam) return { type: 'id', value: idParam };
                    const m1 = u.pathname.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
                    if (m1) return { type: 'id', value: m1[1] };
                    const m2 = u.hostname.includes('googleusercontent.com') && u.pathname.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
                    if (m2) return { type: 'id', value: m2[1] };
                    return { type: 'url', value: val };
                } catch { return { type: 'url', value: val }; }
            }
            return { type: 'id', value: val };
        };

        const looksLikeHtml = (buf) => {
            try {
                const view = new Uint8Array(buf.slice(0, 128));
                const text = Array.from(view).map((b) => String.fromCharCode(b)).join('');
                const lower = text.toLowerCase();
                return lower.includes('<!doctype') || lower.includes('<html');
            } catch { return false; }
        };

        // 驗證指定 Drive 檔案 id 是否真的被刪除：
        // 透過簽名網址函式嘗試取得存取連結；若仍可取回，代表尚未刪除。
        async function verifyDriveDeleted(fileId) {
            try {
                const baseUrl = (window.getSupabaseBaseUrl && window.getSupabaseBaseUrl()) || '';
                if (!baseUrl || !fileId) return true; // 無法驗證則不擋
                const session = (await supabase.auth.getSession()).data?.session;
                const token = session?.access_token || (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                const apikey = (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                const url = `${baseUrl}/functions/v1/${ATTACHMENT_SIGNED_URL_FN}?id=${encodeURIComponent(fileId)}`;
                const res = await fetch(url, { headers: { Authorization: `Bearer ${token}`, apikey } });
                if (!res.ok) return true; // 4xx/5xx 視為已刪（或不可存取）
                // 嘗試解析是否真的回傳可用連結
                let body = null;
                try { body = await res.json(); } catch {}
                const link = body && (body.url || body.signedUrl || body.downloadUrl || (typeof body === 'string' ? body : ''));
                if (!link || typeof link !== 'string') return true; // 沒有實際連結，視為已刪或不可存取
                // 若需要更嚴格，可再 fetch 該連結做 HEAD/GET；此處先以能取到連結視為仍存在
                return false; // 仍存在
            } catch {
                return true; // 驗證失敗不阻擋
            }
        }

        // 嘗試依序以多種 URL 取回 Google Drive 圖片，成功則回傳 { base64, ext, url }
        async function fetchDriveImageBuffer(imageField) {
            if (!imageField) return null;
            const parsed = parseDriveRef(imageField);
            if (!parsed) return null;
            const cacheKey = parsed.type + ':' + parsed.value;
            if (exportImageCache.has(cacheKey)) return exportImageCache.get(cacheKey);

            // 盡量使用 Edge Function（可帶尺寸參數減少體積）
            let urls = [];
            if (parsed.type === 'id') {
                const id = parsed.value;
                urls = [
                    ...(IMAGE_PROXY_BASE ? [
                        `${IMAGE_PROXY_BASE}?id=${id}&sz=800`,
                        `${IMAGE_PROXY_BASE}?id=${id}`
                    ] : []),
                    `https://drive.google.com/thumbnail?id=${id}`,
                    `https://drive.google.com/uc?export=download&id=${id}`,
                    `https://drive.google.com/uc?export=view&id=${id}`,
                    `https://drive.google.com/uc?id=${id}`
                ];
            } else {
                const urlVal = parsed.value;
                urls = [
                    ...(IMAGE_PROXY_BASE ? [
                        `${IMAGE_PROXY_BASE}?url=${encodeURIComponent(urlVal)}&sz=800`
                    ] : []),
                    urlVal
                ];
            }

            for (const url of urls) {
                try {
                    const isProxy = IMAGE_PROXY_BASE && url.startsWith(IMAGE_PROXY_BASE);
                    const anon = window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : undefined);
                    const headers = isProxy && anon ? {
                        'Authorization': `Bearer ${anon}`,
                        'apikey': anon
                    } : undefined;
                    const resp = await fetch(url, { headers });
                    if (!resp.ok) continue;
                    const ct = (resp.headers.get('content-type') || '').toLowerCase();
                    let buf = await resp.arrayBuffer();
                    // 若像 HTML（驗證頁/錯誤頁），跳過
                    if (looksLikeHtml(buf)) continue;

                    let ext = (ct.includes('jpeg') || ct.includes('jpg')) ? 'jpeg'
                             : ct.includes('png') ? 'png'
                             : (ct.includes('webp') ? 'webp' : null);
                    // 非 jpeg/png 一律轉 png（包含 webp/gif/未知）
                    if (!ext || (ext !== 'jpeg' && ext !== 'png')) {
                        buf = await transcodeToPng(buf);
                        ext = 'png';
                    }
                    // 取得寬高（以轉檔後/最終的 buf 為準）
                    const dims = await getImageDimensions(buf).catch(() => ({ width: 0, height: 0 }));
                    const base64 = await arrayBufferToBase64(buf, `image/${ext}`);
                    const out = { base64, ext, url, width: dims.width || 0, height: dims.height || 0 };
                    exportImageCache.set(cacheKey, out);
                    return out;
                } catch (_) { /* 下一個 URL */ }
            }
            return null;
        }

    // 以 ExcelJS 匯出訂單（含嵌圖）；失敗請丟出例外給呼叫端回退
        async function exportOrdersWithExcelJS(flatRows, allProducts, includeImages = true, rowHeightPt = 80) {
            await ensureExcelJSLib();
            const ExcelJS = window.ExcelJS;
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('訂單彙整', { properties: { defaultRowHeight: rowHeightPt } });
            // 更新欄位：將 "廠商" 改為 "廠商代號"，新增 "廠商簡稱" 欄位於右方，並新增 "商品編號" 於品名右方
            const headers = (includeImages ? ['圖片'] : []).concat(['申請單號','訂單類別','申請日期','申請人','申請部門','需求課室','發票開立','廠商代號','廠商簡稱','簽核狀態','經辦狀態','結案狀態','品名','商品編號','規格','單價','單位','數量','小計','簽核進度']);
            ws.addRow(headers).font = { bold: true };
            ws.getRow(1).height = rowHeightPt;
            ws.columns = (includeImages ? [{ header: '圖片', width: 12 }] : []).concat([
                { header: '申請單號', width: 16 }, { header: '訂單類別', width: 10 },
                { header: '申請日期', width: 18 }, { header: '申請人', width: 12 }, { header: '申請部門', width: 12 },
                { header: '需求課室', width: 12 }, { header: '發票開立', width: 12 }, { header: '廠商代號', width: 12 },
                { header: '廠商簡稱', width: 12 }, { header: '簽核狀態', width: 10 }, { header: '經辦狀態', width: 10 }, { header: '結案狀態', width: 10 },
                { header: '品名', width: 20 }, { header: '商品編號', width: 14 }, { header: '規格', width: 20 }, { header: '單價', width: 10 },
                { header: '單位', width: 8 }, { header: '數量', width: 8 }, { header: '小計', width: 12 }, { header: '簽核進度', width: 24 }
            ]);
            // 欄位層級對齊與格式，避免逐格設定
            ws.columns.forEach((c) => { c.alignment = { horizontal: 'left', vertical: 'top', wrapText: true }; });
            const priceCol = headers.indexOf('單價') + 1;
            const subtotalCol = headers.indexOf('小計') + 1;
            if (priceCol > 0) ws.getColumn(priceCol).numFmt = '$#,##0.00';
            if (subtotalCol > 0) ws.getColumn(subtotalCol).numFmt = '$#,##0.00';

            const productImageById = {};
            (allProducts || []).forEach(p => { if (p.id && p.image) productImageById[p.id] = p.image; });

            // 預取圖片，加速後續匯入
            if (includeImages) {
                const pimg = {};
                (allProducts || []).forEach(p => { if (p.id && p.image) pimg[p.id] = p.image; });
                const fileIds = flatRows.map(r => (r.product_id && pimg[r.product_id]) ? pimg[r.product_id] : null);
                await prefetchImages(fileIds, 8);
            }

            for (let i = 0; i < flatRows.length; i++) {
                const r = flatRows[i];
                const rowData = (includeImages ? [''] : []).concat([
                    r.id, r.type, r.date, r.applicant, r.department, r.demand_department, r.invoice, r.vendor,
                    r.vendor_short, r.approval, r.handler, r.closed, r.name, r.product_id || '', r.spec, r.price, r.unit, r.quantity, r.subtotal, r.approval_flow
                ]);
                const row = ws.addRow(rowData);
                row.height = rowHeightPt;
                // 圖片欄
                const fileId = includeImages && r.product_id ? productImageById[r.product_id] : null;
                if (fileId && includeImages) {
                    const img = await fetchDriveImageBuffer(fileId);
                    if (img) {
                        const imageId = wb.addImage({ base64: img.base64, extension: img.ext });
                        const rowIdx = row.number; // 當前 Excel 列號
                        // 縮放到最大 1.2cm（寬/高）
                        const maxPx = Math.round(cmToPx(1.2));
                        const natW = Math.max(1, img.width || 1);
                        const natH = Math.max(1, img.height || 1);
                        const ratio = Math.min(maxPx / natW, maxPx / natH, 1);
                        const targetW = Math.max(1, Math.round(natW * ratio));
                        const targetH = Math.max(1, Math.round(natH * ratio));
                        // 固定行高
                        ws.getRow(rowIdx).height = rowHeightPt;
                        const imgColZeroBased = headers.indexOf('圖片'); // 0-based already for tl.col
                        const tlCol = (imgColZeroBased >= 0 ? imgColZeroBased : 0) + 0.2;
                        ws.addImage(imageId, {
                            tl: { col: tlCol, row: rowIdx - 0.9 },
                            ext: { width: targetW, height: targetH }
                        });
                    } else {
                        const imgIdx1 = headers.indexOf('圖片') + 1;
                        if (imgIdx1 > 0) row.getCell(imgIdx1).value = `https://drive.google.com/thumbnail?id=${fileId}`;
                    }
                }
            }

            // 兼容性：加入隱藏欄多行內容，並再次全表套用列高（包含空列），commit（若可用）
            try {
                applyRowHeightHack(ws, rowHeightPt);
                const firstDataCol = includeImages ? 2 : 1;
                applyRowHeightVisibleHack(ws, rowHeightPt, firstDataCol);
                const maxRow = ws.rowCount || 0;
                for (let i = 1; i <= maxRow; i++) {
                    const rr = ws.getRow(i);
                    rr.height = rowHeightPt;
                    if (rr && rr.model) rr.model.customHeight = true;
                    rr.commit?.();
                }
            } catch (_) {}
            const buf = await wb.xlsx.writeBuffer();
            const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            document.body.appendChild(a);
            a.style.display = 'none';
            a.href = url;
            a.download = `訂單彙整_${getISODateString(new Date())}.xlsx`;
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // 以 ExcelJS 匯出依廠商彙整（含嵌圖）；失敗請丟出例外給呼叫端回退
    async function exportConsolidationWithExcelJS(consolidatedData, allProducts, includeImages = true, rowHeightPt = 80) {
            await ensureExcelJSLib();
            const ExcelJS = window.ExcelJS;
            const wb = new ExcelJS.Workbook();
            // 供彙總頁使用的商品圖片對照與預取
            const productImageById_SUM = {};
            (allProducts || []).forEach(p => { if (p.id && p.image) productImageById_SUM[p.id] = p.image; });
            if (includeImages) {
                const allIdsSUM = [];
                for (const [, vdata] of Object.entries(consolidatedData)) {
                    for (const it of Object.values(vdata.items)) {
                        if (it.id && productImageById_SUM[it.id]) allIdsSUM.push(productImageById_SUM[it.id]);
                    }
                }
                await prefetchImages(allIdsSUM, 8);
            }

            // 彙總頁（含圖片、商品編號、廠商代號、廠商簡稱、申請部門、需求課室、發票開立 等欄位）
            const summary = wb.addWorksheet('彙總', { properties: { defaultRowHeight: rowHeightPt } });
            const sHeaders = (includeImages ? ['圖片'] : []).concat(['商品編號','廠商代號','廠商簡稱','申請部門','需求課室','發票開立','品名','規格','單價','單位','總數量','小計']);
            summary.addRow(sHeaders).font = { bold: true };
            summary.getRow(1).height = rowHeightPt;
            summary.columns = (includeImages ? [{ header: '圖片', width: 12 }] : []).concat([
                { header: '商品編號', width: 14 }, { header: '廠商代號', width: 12 }, { header: '廠商簡稱', width: 12 }, { header: '申請部門', width: 12 }, { header: '需求課室', width: 12 }, { header: '發票開立', width: 12 },
                { header: '品名', width: 20 }, { header: '規格', width: 20 }, { header: '單價', width: 10 }, { header: '單位', width: 8 }, { header: '總數量', width: 10 }, { header: '小計', width: 12 }
            ]);
            summary.columns.forEach(c => { c.alignment = { horizontal: 'left', vertical: 'top', wrapText: true }; });
            // 單價與小計的格式（根據新欄位位置）
            const priceColIdx = sHeaders.indexOf('單價') + 1;
            const subtotalColIdx = sHeaders.indexOf('小計') + 1;
            if (priceColIdx > 0) summary.getColumn(priceColIdx).numFmt = '$#,##0.00';
            if (subtotalColIdx > 0) summary.getColumn(subtotalColIdx).numFmt = '$#,##0.00';

            const summaryItems = {};
            Object.entries(consolidatedData).forEach(([vendorKey, vendorData]) => {
                // 對於每個 vendor 的 items，將其屬性保留（若多廠商同一品項，先出現者的廠商/簡稱/商品編號等會被保留）
                // 由 vendorKey 推斷廠商代號/簡稱
                const vinfo = (window.state && window.state.vendors) ? window.state.vendors.find(v => v.vendor_id === vendorKey || v.short_name === vendorKey || v.name === vendorKey) : null;
                const vendorCode = vinfo ? vinfo.vendor_id : vendorKey;
                const vendorShort = vinfo ? (vinfo.short_name || vinfo.name || '') : (vendorKey || '');
                Object.values(vendorData.items).forEach(item => {
                    const key = `${item.name}|${item.spec}|${item.price}`;
                    if (!summaryItems[key]) {
                        summaryItems[key] = { ...item, quantity: 0, subtotal: 0 };
                        // 儲存首筆可用的 vendor 資訊（由 vendorKey 推斷）
                        summaryItems[key].vendor_code = vendorCode || '';
                        summaryItems[key].vendor_short = vendorShort || '';
                        summaryItems[key].product_id = item.id || '';
                        // 圖片以 product_id 查表
                        summaryItems[key].department = item.department || (vendorData.department || '');
                        summaryItems[key].demand_department = item.demand_department || '';
                        summaryItems[key].invoice = item.invoice === '其他' ? (item.custom_invoice || '其他') : (item.invoice || '');
                    }
                    summaryItems[key].quantity += Number(item.quantity || 0);
                    summaryItems[key].subtotal += Number(item.subtotal || 0);
                });
            });

            let summaryTotal = 0;
            for (const it of Object.values(summaryItems)) {
                const rowData = (includeImages ? [''] : []).concat([
                    it.product_id || '', it.vendor_code || '', it.vendor_short || '', it.department || '', it.demand_department || '', it.invoice || '',
                    it.name || '', it.spec || '', it.price || 0, it.unit || '', it.quantity || 0, it.subtotal || 0
                ]);
                const row = summary.addRow(rowData);
                if (priceColIdx > 0) row.getCell(priceColIdx).numFmt = '$#,##0.00';
                if (subtotalColIdx > 0) row.getCell(subtotalColIdx).numFmt = '$#,##0.00';
                row.height = rowHeightPt;
                // 嵌入圖片（若有）
                if (includeImages) {
                    const fileId = it.product_id ? productImageById_SUM[it.product_id] : null;
                    if (fileId) {
                        const img = await fetchDriveImageBuffer(fileId);
                        if (img) {
                            const imageId = wb.addImage({ base64: img.base64, extension: img.ext });
                            const rowIdx = row.number;
                            const maxPx = Math.round(cmToPx(1.2));
                            const natW = Math.max(1, img.width || 1);
                            const natH = Math.max(1, img.height || 1);
                            const ratio = Math.min(maxPx / natW, maxPx / natH, 1);
                            const targetW = Math.max(1, Math.round(natW * ratio));
                            const targetH = Math.max(1, Math.round(natH * ratio));
                            const imgColZeroBased = sHeaders.indexOf('圖片');
                            const tlCol = (imgColZeroBased >= 0 ? imgColZeroBased : 0) + 0.2;
                            summary.addImage(imageId, { tl: { col: tlCol, row: rowIdx - 0.9 }, ext: { width: targetW, height: targetH } });
                        } else {
                            const imgIdx1 = sHeaders.indexOf('圖片') + 1;
                            if (imgIdx1 > 0) row.getCell(imgIdx1).value = `https://drive.google.com/thumbnail?id=${fileId}`;
                        }
                    }
                }
                summaryTotal += Number(it.subtotal || 0);
            }
            const blank = summary.addRow([]);
            blank.height = rowHeightPt;
            const trow = summary.addRow([]);
            // 將 "總計" 標籤放在品名欄
            const labelCol = sHeaders.indexOf('品名') + 1;
            const qtyCol = sHeaders.indexOf('總數量') + 1;
            const subCol = sHeaders.indexOf('小計') + 1;
            if (labelCol > 0) trow.getCell(labelCol).value = '總計';
            if (qtyCol > 0) trow.getCell(qtyCol).value = Object.values(summaryItems).reduce((s, it) => s + Number(it.quantity || 0), 0);
            if (subCol > 0) trow.getCell(subCol).value = summaryTotal;
            trow.font = { bold: true };
            if (subCol > 0) trow.getCell(subCol).numFmt = '$#,##0.00';
            trow.height = rowHeightPt;

            // 各廠商頁
            const productImageById = {};
            (allProducts || []).forEach(p => { if (p.id && p.image) productImageById[p.id] = p.image; });

            // 預取所有廠商頁面可能會用到的圖片
            if (includeImages) {
                const allIds = [];
                for (const [, data] of Object.entries(consolidatedData)) {
                    for (const item of Object.values(data.items)) {
                        if (item.id && productImageById[item.id]) allIds.push(productImageById[item.id]);
                    }
                }
                await prefetchImages(allIds, 8);
            }

            const vendorSheets = [];
            for (const [vendor, data] of Object.entries(consolidatedData)) {
                const ws = wb.addWorksheet(vendor.replace(/[\/\\?*\[\]]/g, ''), { properties: { defaultRowHeight: rowHeightPt } });
                // 欄位順序：圖片, 廠商代號, 廠商簡稱, 商品編號, 品名, 規格, 單價, 總數量, 單位, 小計, 申請部門, 需求課室, 發票開立
                const vHeaders = (includeImages ? ['圖片'] : []).concat(['廠商代號','廠商簡稱','商品編號','品名','規格','單價','總數量','單位','小計','申請部門','需求課室','發票開立']);
                ws.addRow(vHeaders).font = { bold: true };
                ws.getRow(1).height = rowHeightPt;
                ws.columns = (includeImages ? [{ header: '圖片', width: 12 }] : []).concat([
                    { header: '廠商代號', width: 12 }, { header: '廠商簡稱', width: 12 }, { header: '商品編號', width: 14 }, { header: '品名', width: 20 }, { header: '規格', width: 20 }, { header: '單價', width: 10 },
                    { header: '總數量', width: 10 }, { header: '單位', width: 8 }, { header: '小計', width: 12 }, { header: '申請部門', width: 12 }, { header: '需求課室', width: 12 }, { header: '發票開立', width: 12 }
                ]);
                ws.columns.forEach(c => { c.alignment = { horizontal: 'left', vertical: 'top', wrapText: true }; });
                const priceIdxV = vHeaders.indexOf('單價') + 1;
                const subtotalIdxV = vHeaders.indexOf('小計') + 1;
                if (priceIdxV > 0) ws.getColumn(priceIdxV).numFmt = '$#,##0.00';
                if (subtotalIdxV > 0) ws.getColumn(subtotalIdxV).numFmt = '$#,##0.00';
                // 嘗試從 state.vendors 找到廠商代號與簡稱（vendor 是 consolidated 的 key，可能為 vendor_id 或 short_name/name）
                const vendorInfo = (window.state && window.state.vendors) ? window.state.vendors.find(v => v.vendor_id === vendor || v.short_name === vendor || v.name === vendor) : null;
                const vendorCode = vendorInfo ? vendorInfo.vendor_id : vendor;
                const vendorShort = vendorInfo ? (vendorInfo.short_name || vendorInfo.name) : (vendor || '');

                let vendorQtyTotal = 0;
                for (const item of Object.values(data.items)) {
                    const rowData = (includeImages ? [''] : []).concat([
                        vendorCode, vendorShort, item.id || '', item.name, item.spec || '', item.price, item.quantity, item.unit, item.subtotal, item.department || (data.department || ''), item.demand_department || '', item.invoice === '其他' ? (item.custom_invoice || '其他') : (item.invoice || '')
                    ]);
                    const row = ws.addRow(rowData);
                    row.height = rowHeightPt;
                    vendorQtyTotal += Number(item.quantity || 0);
                    const fileId = item.id ? productImageById[item.id] : null;
                    if (fileId && includeImages) {
                        const img = await fetchDriveImageBuffer(fileId);
                        if (img) {
                            const imageId = wb.addImage({ base64: img.base64, extension: img.ext });
                            const rowIdx = row.number;
                            const maxPx = Math.round(cmToPx(1.2));
                            const natW = Math.max(1, img.width || 1);
                            const natH = Math.max(1, img.height || 1);
                            const ratio = Math.min(maxPx / natW, maxPx / natH, 1);
                            const targetW = Math.max(1, Math.round(natW * ratio));
                            const targetH = Math.max(1, Math.round(natH * ratio));
                            ws.getRow(rowIdx).height = rowHeightPt;
                            const imgColZeroBased = vHeaders.indexOf('圖片');
                            const tlCol = (imgColZeroBased >= 0 ? imgColZeroBased : 0) + 0.2;
                            ws.addImage(imageId, {
                                tl: { col: tlCol, row: rowIdx - 0.9 },
                                ext: { width: targetW, height: targetH }
                            });
                        } else {
                            const imgIdxV = vHeaders.indexOf('圖片') + 1;
                            if (imgIdxV > 0) row.getCell(imgIdxV).value = `https://drive.google.com/thumbnail?id=${fileId}`;
                        }
                    }
                }
                // 加入總計列：空列 + 總計（數量與金額）
                try {
                    const blank = ws.addRow([]);
                    blank.height = rowHeightPt;
                    const labelCol = vHeaders.indexOf('品名') + 1;
                    const qtyCol = vHeaders.indexOf('總數量') + 1;
                    const subtotalCol = vHeaders.indexOf('小計') + 1;
                    const trow = ws.addRow([]);
                    trow.getCell(labelCol).value = '總計';
                    trow.getCell(qtyCol).value = vendorQtyTotal;
                    trow.getCell(subtotalCol).value = Number(data.total || 0);
                    trow.font = { bold: true };
                    if (subtotalCol > 0) trow.getCell(subtotalCol).numFmt = '$#,##0.00';
                    trow.height = rowHeightPt;
                } catch (_) {}

                vendorSheets.push(ws);
            }

            // 兼容性：加入隱藏欄與可見欄多行內容，並對彙總與各廠商表全表套用列高（包含空列）與 commit
            try {
                applyRowHeightHack(summary, rowHeightPt);
                applyRowHeightVisibleHack(summary, rowHeightPt, 1);
                for (let i = 1; i <= (summary.rowCount || 0); i++) {
                    const rr = summary.getRow(i);
                    rr.height = rowHeightPt; if (rr && rr.model) rr.model.customHeight = true; rr.commit?.();
                }
                vendorSheets.forEach(s => {
                    applyRowHeightHack(s, rowHeightPt);
                    const firstDataCol = includeImages ? 2 : 1;
                    applyRowHeightVisibleHack(s, rowHeightPt, firstDataCol);
                    for (let i = 1; i <= (s.rowCount || 0); i++) {
                        const rr = s.getRow(i);
                        rr.height = rowHeightPt; if (rr && rr.model) rr.model.customHeight = true; rr.commit?.();
                    }
                });
            } catch (_) {}

            const buf = await wb.xlsx.writeBuffer();
            const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            document.body.appendChild(a);
            a.style.display = 'none';
            a.href = url;
            a.download = `廠商彙總訂單_${getISODateString(new Date())}.xlsx`;
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        

        const saveFavoritesToDb = async (userId, favoritesSet) => {
            const favoritesArray = Array.from(favoritesSet);
            const { error } = await supabase
                .from('users')
                .update({ favorite_products: favoritesArray })
                .eq('id', userId);
            
            if (error) {
                console.error("Error updating favorites:", error);
                showMessage('更新我的最愛失敗: ' + error.message, 'error');
            }
        };

        const validateTaxId = (taxId) => {
            if (!/^\d{8}$/.test(taxId)) return false;
            const multipliers = [1, 2, 1, 2, 1, 2, 4, 1];
            let sum = 0;
            for (let i = 0; i < 8; i++) {
                const product = parseInt(taxId[i]) * multipliers[i];
                sum += Math.floor(product / 10) + (product % 10);
            }
            if (sum % 10 === 0) return true;
            if (taxId[6] === '7' && (sum + 1) % 10 === 0) return true;
            return false;
        };

        // --- 全域常數 ---
        const DEMAND_DEPARTMENTS = [
            "本館生福課", "8C清福", "7C清氣", "6C清心", "5C清平", "3C清安", "2C清護", 
            "2D清護", "8D清春", "7D清日", "6D清照", "5D清風", "3D清景", "8E清山", 
            "7E清泉", "6E清水", "8E清清", "3E清涼", "法人館生福課", "7G一館", "7H一館", 
            "7K一館", "6G一館", "6H一館", "6K一館", "5G二館", "5H二館", "5K二館", 
            "3G三館", "3H三館", "3K三館", "2G三館", "2H三館", "2K三館"
        ];

        // --- 應用程式狀態與設定 ---
        let state = {
            theme: 'default',
            view: 'login',
            requests: [],
            products: {}, // 分類後的產品
            allProducts: [], // 所有產品列表
            vendors: [], // 廠商列表
            users: {}, // key 是 user uuid
            categories: [],
            departments: {},
            applicantNotifications: [],
            currentUser: null, // 包含從 users 表來的 profile
            selectedRequest: null,
            editingRequest: null, // *** NEW: 正在編輯的草稿 ***
            editingProduct: null,
            editingUser: null,
            editingVendor: null, 
            loading: true,
            error: null,
            local: {
                dashboardFilters: {
                    vendors: new Set(),
                    statuses: new Set(),
                    handlerStatuses: new Set(),
                    closedStatuses: new Set(),
                },
                personalForms: {
                    activeTab: 'inbox', 
                    inbox: { searchTerm: '' },
                    sent: { status: 'all', searchTerm: '', dateFrom: '', dateTo: '' },
                    history: { status: 'all', searchTerm: '', dateFrom: '', dateTo: '' },
                    handler: { status: 'all', handlerStatus: 'all', searchTerm: '', dateFrom: '', dateTo: '' },
                    closed: { status: 'all', searchTerm: '', dateFrom: '', dateTo: '' },
                },
                userManagementFilters: {
                    department: 'all',
                    searchTerm: ''
                },
                departmentManagementSearchTerm: '',
                vendorManagementSearchTerm: '',
                newRequestCart: [],
                activeProductCategory: '我的最愛',
                activeProductManagementCategory: '全品項',
                selectedRequestIds: new Set(),
                currentPage: 1,
                itemsPerPage: 10,
                permissionFilter: 'my', 
                consolidatedData: null,
                sortKey: 'request_date', 
                sortDirection: 'desc',
                productManagementSearchTerm: '',
                newRequestSearchTerm: '',
                newRequestSearchAll: false,
                newRequestCurrentPage: 1,
                productSortKey: 'id',
                productSortDirection: 'asc',
                productFilters: {},
                favoriteProductIds: new Set(),
                layoutScale: 'expanded', // 'expanded' = 3:2 (+), 'compact' = 2:3 (-)
                // 申請單附件（在送出/儲存前的本地暫存）
                newRequestAttachments: []
            }
        };

        // --- Supabase API 呼叫函式 ---
        const { supabase } = window;
        
        let channels = []; // 用來存放 real-time channel
        let tempSelections = {
            vendors: new Set(),
            statuses: new Set()
        };

        const loadDashboardData = async (shouldNavigateToDashboard = false, useCache = true) => {
            // 檢查緩存
            const cacheKey = 'dashboard_data';
            if (useCache) {
                const cachedData = CacheManager.get(cacheKey);
                if (cachedData) {
                    console.log('使用緩存的儀表板資料');
                    Object.assign(state, cachedData);
                    if (shouldNavigateToDashboard) {
                        state.view = 'dashboard';
                    }
                    updateState({ loading: false }); // 確保重置載入狀態
                    render();
                    return;
                }
            }

            updateState({ loading: true });
            
            // 清理舊的即時連接
            channels.forEach(channel => {
                try {
                    supabase.removeChannel(channel);
                } catch (e) {
                    console.warn('清理頻道時發生錯誤:', e);
                }
            });
            channels = [];

            // 重試機制
            const maxRetries = 3;
            let retryCount = 0;
            
            const loadDataWithRetry = async () => {
                try {
                    // 批量載入，但添加超時控制
                    const loadPromises = [
                        Promise.race([
                            supabase.from('users').select('*'),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Users timeout')), 10000))
                        ]),
                        Promise.race([
                            supabase.from('categories').select('name'),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Categories timeout')), 10000))
                        ]),
                        Promise.race([
                            supabase.from('departments').select('department, director_threshold'),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Departments timeout')), 10000))
                        ]),
                        Promise.race([
                            supabase.from('products').select('*'),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Products timeout')), 15000))
                        ]),
                        Promise.race([
                            supabase.from('requests').select('*').order('request_date', { ascending: false }).limit(1000), // 限制載入筆數
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Requests timeout')), 15000))
                        ]),
                        Promise.race([
                            supabase.from('notifications').select('*').eq('user_id', state.currentUser.id).order('timestamp', { ascending: false }).limit(50), // 限制通知數量
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Notifications timeout')), 10000))
                        ]),
                        Promise.race([
                            supabase.from('vendors').select('*').order('vendor_id', { ascending: true }),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Vendors timeout')), 10000))
                        ])
                    ];

                    const [usersRes, categoriesRes, departmentsRes, productsRes, requestsRes, notificationsRes, vendorsRes] = await Promise.all(loadPromises);

                    const results = [usersRes, categoriesRes, departmentsRes, productsRes, requestsRes, notificationsRes, vendorsRes];
                    for (const res of results) {
                        if (res.error) throw res.error;
                    }
                    
                    // 處理資料
                    const usersData = {};
                    usersRes.data.forEach(user => {
                        usersData[user.id] = user;
                    });

                    const categoriesData = categoriesRes.data.map(cat => cat.name);

                    const departmentsData = {};
                    departmentsRes.data.forEach(dept => {
                        departmentsData[dept.department] = dept.director_threshold;
                    });

                    const productsData = {};
                    const allProducts = productsRes.data;
                    allProducts.forEach(product => {
                        const category = product.category;
                        if (!productsData[category]) productsData[category] = [];
                        productsData[category].push(product);
                    });

                    const requests = requestsRes.data;
                    const applicantNotifications = notificationsRes.data;
                    const vendors = vendorsRes.data;

                    const finalStateUpdate = { 
                        users: usersData, 
                        categories: categoriesData, 
                        departments: departmentsData,
                        products: productsData,
                        allProducts,
                        vendors,
                        requests,
                        applicantNotifications,
                        loading: false,
                        error: null
                    };

                    if (shouldNavigateToDashboard) {
                        finalStateUpdate.view = 'dashboard';
                    }

                    // 緩存成功載入的資料
                    CacheManager.set(cacheKey, {
                        users: usersData,
                        categories: categoriesData,
                        departments: departmentsData,
                        products: productsData,
                        allProducts,
                        vendors,
                        requests,
                        applicantNotifications
                    }, 180000); // 3分鐘緩存

                    updateState(finalStateUpdate);
                    setupRealtimeListeners();

                } catch (err) {
                    console.error(`載入儀表板資料失敗 (嘗試 ${retryCount + 1}/${maxRetries}):`, err);
                    
                    if (retryCount < maxRetries - 1) {
                        retryCount++;
                        const delay = Math.min(1000 * Math.pow(2, retryCount), 5000); // 指數退避，最大5秒
                        console.log(`${delay}ms 後重試...`);
                        setTimeout(loadDataWithRetry, delay);
                        return;
                    }
                    
                    // 最終失敗
                    updateState({ 
                        error: `載入資料失敗: ${err.message}. 請檢查網路連線或重新整理頁面。`, 
                        loading: false 
                    });
                }
            };

            await loadDataWithRetry();
        };
        
        function setupRealtimeListeners() {
            // 添加重連邏輯
            const setupChannelWithRetry = (channelConfig, maxRetries = 3) => {
                let retryCount = 0;
                
                const createChannel = () => {
                    try {
                        const channel = supabase.channel(channelConfig.name)
                            .on('postgres_changes', channelConfig.config, (payload) => {
                                try {
                                    channelConfig.handler(payload);
                                } catch (err) {
                                    console.error(`處理 ${channelConfig.name} 變更時發生錯誤:`, err);
                                }
                            })
                            .subscribe((status) => {
                                if (status === 'SUBSCRIBED') {
                                    console.log(`${channelConfig.name} 即時監聽已連接`);
                                    retryCount = 0; // 重置重試計數
                                } else if (status === 'CHANNEL_ERROR') {
                                    console.error(`${channelConfig.name} 頻道錯誤`);
                                    if (retryCount < maxRetries) {
                                        retryCount++;
                                        const delay = 1000 * Math.pow(2, retryCount);
                                        console.log(`${delay}ms 後重試連接 ${channelConfig.name}...`);
                                        setTimeout(createChannel, delay);
                                    }
                                } else if (status === 'TIMED_OUT') {
                                    console.warn(`${channelConfig.name} 連接超時`);
                                    if (retryCount < maxRetries) {
                                        retryCount++;
                                        setTimeout(createChannel, 2000);
                                    }
                                }
                            });
                        
                        channels.push(channel);
                        return channel;
                    } catch (err) {
                        console.error(`建立 ${channelConfig.name} 頻道時發生錯誤:`, err);
                        if (retryCount < maxRetries) {
                            retryCount++;
                            setTimeout(createChannel, 2000);
                        }
                    }
                };
                
                return createChannel();
            };

            // 設定各種監聽器
            const channelConfigs = [
                {
                    name: 'public:requests',
                    config: { event: '*', schema: 'public', table: 'requests' },
                    handler: (payload) => {
                        console.log('Request change received!', payload);
                        handleRealtimeUpdate(payload, 'requests', 'id');
                    }
                },
                {
                    name: 'public:products',
                    config: { event: '*', schema: 'public', table: 'products' },
                    handler: async (payload) => {
                        console.log('Product change received!', payload);
                        try {
                            // 使用緩存的節流更新
                            if (!setupRealtimeListeners.productUpdateThrottle) {
                                setupRealtimeListeners.productUpdateThrottle = throttle(async () => {
                                    const { data, error } = await supabase.from('products').select('*');
                                    if (error) {
                                        console.error("即時重新載入產品失敗:", error);
                                        return;
                                    }
                                    
                                    const allProducts = data;
                                    const productsData = {};
                                    allProducts.forEach(product => {
                                        const category = product.category;
                                        if (!productsData[category]) productsData[category] = [];
                                        productsData[category].push(product);
                                    });
                                    
                                    updateState({ allProducts, products: productsData });
                                    
                                    // 更新緩存
                                    const cachedData = CacheManager.get('dashboard_data');
                                    if (cachedData) {
                                        cachedData.allProducts = allProducts;
                                        cachedData.products = productsData;
                                        CacheManager.set('dashboard_data', cachedData);
                                    }
                                }, 1000);
                            }
                            setupRealtimeListeners.productUpdateThrottle();
                        } catch (err) {
                            console.error("處理產品變更時發生錯誤:", err);
                        }
                    }
                },
                {
                    name: `public:notifications:user_id=eq.${state.currentUser.id}`,
                    config: { event: '*', schema: 'public', table: 'notifications', filter: `user_id=eq.${state.currentUser.id}` },
                    handler: (payload) => {
                        console.log('Notification change received!', payload);
                        handleRealtimeUpdate(payload, 'applicantNotifications', 'id');
                    }
                }
            ];

            // 批量設定監聽器
            channelConfigs.forEach(config => {
                setupChannelWithRetry(config);
            });
        }

        function handleRealtimeUpdate(payload, stateKey, idField) {
            const currentItems = [...state[stateKey]];
            switch (payload.eventType) {
                case 'INSERT':
                    currentItems.unshift(payload.new);
                    break;
                case 'UPDATE':
                    const indexToUpdate = currentItems.findIndex(item => item[idField] === payload.new[idField]);
                    if (indexToUpdate > -1) {
                        currentItems[indexToUpdate] = payload.new;
                    } else {
                        currentItems.unshift(payload.new);
                    }
                    break;
                case 'DELETE':
                    const indexToDelete = currentItems.findIndex(item => item[idField] === payload.old[idField]);
                    if (indexToDelete > -1) {
                        currentItems.splice(indexToDelete, 1);
                    }
                    break;
            }
            if (stateKey === 'requests') {
                currentItems.sort((a, b) => new Date(b.request_date) - new Date(a.request_date));
            }
            if (stateKey === 'applicantNotifications') {
                currentItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
            updateState({ [stateKey]: currentItems });
        }

        // --- 狀態管理優化 ---
        const updateState = (newState) => {
            const oldView = state.view;
            
            if (newState.local) {
                newState.local = { ...state.local, ...newState.local };
            }

            Object.assign(state, newState);

            if (newState.view && newState.view !== oldView) {
                state.local.selectedRequestIds.clear();
                state.local.currentPage = 1;
                state.local.newRequestCurrentPage = 1;
                // Only clear editingRequest if not navigating to newRequest view
                if (newState.view !== 'newRequest') {
                    state.editingRequest = null; 
                }
                // 使用 requestAnimationFrame 批量處理視圖更新
                requestAnimationFrame(() => {
                    render();
                });
            } else {
                // 使用節流來限制重複渲染
                if (!updateState.renderScheduled) {
                    updateState.renderScheduled = true;
                    requestAnimationFrame(() => {
                        render();
                        updateState.renderScheduled = false;
                    });
                }
            }
        };

        // --- 優化後的全域渲染函式 ---
        const render = (() => {
            let isRendering = false;
            
            return () => {
                // 防止重複渲染
                if (isRendering) return;
                isRendering = true;
                
                try {
                    const { view, loading, error, currentUser } = state;
                    
                    // 批量 DOM 更新
                    const updates = [];
                    
                    const loadingView = document.getElementById('loading-view');
                    if (loadingView) {
                        updates.push(() => {
                            loadingView.style.display = loading ? 'flex' : 'none';
                        });
                    }
                    
                    const errorView = document.getElementById('error-view');
                    if (error && errorView) {
                        updates.push(() => {
                            errorView.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">發生錯誤！</strong><span class="block sm:inline">${error}</span><div class="mt-4"><button onclick="location.reload()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">重新載入</button></div></div>`;
                            errorView.style.display = 'block';
                        });
                    } else if (errorView) {
                        updates.push(() => {
                            errorView.style.display = 'none';
                        });
                    }

                    const views = ['login-view', 'dashboard-view', 'newRequest-view', 'detailView-view', 'productManagement-view', 'productForm-view', 'personalForms-view', 'userManagement-view', 'departmentManagement-view', 'userForm-view', 'departmentForm-view', 'vendorManagement-view', 'vendorForm-view', 'printManagement-view'];
                    updates.push(() => {
                        views.forEach(v => {
                            const el = document.getElementById(v);
                            if (el) el.style.display = 'none';
                        });
                    });

                    // 執行批量更新
                    updates.forEach(update => update());

                    if (loading || error) return;
                    
                    renderAppHeader();

                    if (!currentUser) {
                        renderLoginView();
                        return;
                    }
                    
                    const viewFnName = `render${view.charAt(0).toUpperCase() + view.slice(1)}`;
                    const renderFn = window[viewFnName];
                    
                    if (typeof renderFn === 'function') {
                        renderFn();
                    }
                } finally {
                    isRendering = false;
                }
            };
        })();
        
        const renderAppHeader = () => {
            const headerEl = document.getElementById('app-header');
            if (!state.currentUser) {
                headerEl.innerHTML = '';
                return;
            }
            headerEl.innerHTML = `
                <div class="bg-white p-2 rounded-md shadow-sm flex items-center justify-end space-x-4 text-sm">
                    <div class="theme-switcher mr-4">
                        <label for="theme-select" class="mr-2 text-gray-600">版面風格:</label>
                        <select id="theme-select" class="p-1 border rounded-md text-sm">
                            <option value="default">預設</option>
                            <option value="random">*隨機</option>
                            <option value="apple">Apple</option>
                            <option value="scifi">高科技</option>
                            <option value="ghibli">吉卜力</option>
                            <option value="abstract">藝術</option>
                            <option value="colorful">多彩</option>
                            <option value="luhong">魯紅</option>
                            <option value="lugreen">魯綠</option>
                            <option value="forest">森林</option>
                            <option value="ocean">海洋</option>
                            <option value="sunset">夕陽</option>
                            <option value="midnight">午夜</option>
                            <option value="sakura">櫻花</option>
                            <option value="care-soft">溫馨</option>
                            <option value="care-fresh">清新</option>
                            <option value="med-clean">清爽</option>
                            <option value="med-trust">信任</option>
                            <option value="hotel-lux">奢華</option>
                            <option value="hotel-resort">休閒</option>
                            <option value="nord">清冷</option>
                            <option value="latte">拿鐵</option>
                            <option value="mint">薄荷</option>
                            <option value="solar">暖陽</option>
                            <option value="slate">石板</option>
                            <option value="metro">Metro</option>
                            <option value="pastel">粉彩</option>
                            <option value="neon">霓虹</option>
                            <option value="retro">復古</option>
                            <option value="minimal">極簡</option>
                            <option value="paper">紙感</option>
                            <option value="grape">葡萄紫</option>
                            <option value="cobalt">鈷藍</option>
                            <option value="sand">沙丘</option>
                            <option value="rosewood">紅木</option>
                            <option value="aurora">極光</option>
                            <option value="cocoa">可可</option>
                            <option value="denim">丹寧</option>
                            <option value="lime">檸萊姆</option>
                            <option value="coral">珊瑚</option>
                            <option value="plum">李梅紫</option>
                            <option value="sky">晴空</option>
                            <option value="graphite">石墨</option>
                            <option value="pearl">珠光</option>
                            <option value="rust">鐵鏽</option>
                            <option value="berry">莓果</option>
                            <option value="moss">苔蘚</option>
                            <option value="teal">水鴨</option>
                            <option value="sepia">懷舊棕</option>
                            <option value="charcoal">炭黑</option>
                            <option value="ivory">象牙</option>
                            <option value="azure">天藍</option>
                            <option value="blush">腮紅</option>
                            <option value="saffron">番紅花</option>
                            <option value="indigo">靛青</option>
                            <option value="copper">銅色</option>
                            <option value="lavender">薰衣草</option>
                            <option value="steel">鋼鐵</option>
                            <option value="clay">陶土</option>
                            <option value="cyan">青色</option>
                            <option value="olive">橄欖</option>
                            <option value="marigold">萬壽菊</option>
                            <option value="orchid">蘭花</option>
                            <option value="flamingo">火鶴</option>
                            <option value="iceberg">冰山</option>
                            <option value="blossom">花漾</option>
                            <option value="jade">玉翠</option>
                            <option value="cinder">煤炭黑</option>
                            <option value="fern">蕨綠</option>
                            <option value="glacier">冰川藍</option>
                            <option value="ember">餘燼橙</option>
                            <option value="horizon">天際藍</option>
                            <option value="canyon">峽谷橙</option>
                            <option value="lagoon">礁湖青</option>
                            <option value="meadow">草甸綠</option>
                            <option value="tundra">苔原藍灰</option>
                            <option value="dune">沙漠棕</option>
                            <option value="willow">垂柳綠</option>
                            <option value="bronze">古銅</option>
                            <option value="silver">銀霜</option>
                            <option value="gold">鎏金</option>
                            <option value="amethyst">紫水晶</option>
                            <option value="sapphire">藍寶石</option>
                            <option value="ruby">紅寶石</option>
                            <option value="emerald">翠玉</option>
                            <option value="topaz">黃玉</option>
                            <option value="garnet">石榴紅</option>
                            <option value="quartz">石英青</option>
                            <option value="onyx">縞瑪瑙</option>
                            <option value="obsidian">黑曜石</option>
                            <option value="smoke">煙灰</option>
                            <option value="cloud">雲白</option>
                            <option value="storm">風暴灰</option>
                            <option value="frost">霜藍</option>
                            <option value="cherry">櫻桃粉</option>
                            <option value="espresso">濃縮咖啡</option>
                            <option value="mocha">摩卡</option>
                            <option value="avocado">酪梨綠</option>
                            <option value="banana">香蕉黃</option>
                            <option value="plumeria">雞蛋花</option>
                            <option value="reef">珊瑚礁藍</option>
                            <option value="seafoam">海沫綠</option>
                            <option value="pine">松針綠</option>
                            <option value="iron">鐵灰</option>
                            <option value="carbon">碳黑</option>
                            <option value="navy">海軍藍</option>
                            <option value="air">空氣藍</option>
                            <option value="violet">紫羅蘭</option>
                            <option value="caramel">焦糖</option>
                            <option value="peach">蜜桃</option>
                            <option value="lilac">丁香紫</option>
                            <option value="rose">玫瑰</option>
                            <option value="magenta">洋紅</option>
                            <option value="periwinkle">長春花</option>
                            <option value="teak">柚木</option>
                        </select>
                    </div>
                    <button data-view="personalForms" class="view-switch-btn text-blue-600 hover:underline">個人表單管理</button>
                    <div id="notification-bell-container" class="flex items-center space-x-2 relative"></div>
                    <span class="text-gray-600">歡迎, ${state.currentUser.name} (${state.currentUser.role})</span>
                    <button data-action="edit-profile" class="text-blue-600 hover:underline">個人設定</button>
                    <button id="change-password-btn" class="text-blue-600 hover:underline">修改密碼</button>
                    <button id="logout-btn" class="text-red-600 hover:underline">登出</button>
                </div>`;
            renderNotifications();
            document.getElementById('theme-select').value = state.theme;
        };

        const renderNotifications = () => {
            const bellContainer = document.getElementById('notification-bell-container');
            if (!bellContainer) return;

            const pendingForMe = state.requests.filter(req => {
                if (!req.approvers) return false;
                const nextApprover = req.approvers.find(a => a.status === 'pending');
                return req.status === '待審核' && nextApprover && nextApprover.userId === state.currentUser.id;
            });
            // 待我經辦：已核准且待經辦，角色或指派允許，且未結案
            const toHandle = state.requests.filter(req => {
                const effective = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                const roleOk = (state.currentUser.id === req.handler_id) || state.currentUser.is_admin || ['採購','採購主管'].includes(state.currentUser.role);
                const notClosed = req.closed_status !== '結案';
                return req.status === '已核准' && effective === '待經辦' && roleOk && notClosed;
            });
            // 待我結案：已核准且已經辦，角色允許，且未結案
            const toClose = state.requests.filter(req => {
                const effective = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                const roleOk = state.currentUser.is_admin || ['採購','採購主管'].includes(state.currentUser.role);
                const notClosed = req.closed_status !== '結案';
                return req.status === '已核准' && effective === '已經辦' && roleOk && notClosed;
            });
            
            const myNotifications = state.applicantNotifications.filter(n => n.user_id === state.currentUser.id);
            const unreadMyNotifications = myNotifications.filter(n => !n.is_read);

            const totalUnreadCount = pendingForMe.length + toHandle.length + toClose.length + unreadMyNotifications.length;

            let bellHTML = `
                <div id="notification-bell" class="relative cursor-pointer">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    ${totalUnreadCount > 0 ? `<span class="absolute top-0 right-0 -mt-1 -mr-1 flex justify-center items-center h-4 w-4 rounded-full bg-red-500 text-white text-xs pointer-events-none"></span>` : ''}
                </div>
            `;
            
            if (totalUnreadCount > 0) {
                bellHTML += `<span class="text-red-500 font-bold text-xs">${totalUnreadCount}</span>`;
            }

            if (pendingForMe.length > 0 || toHandle.length > 0 || toClose.length > 0 || myNotifications.length > 0) {
                let dropdownHTML = `<div id="notification-dropdown" class="hidden absolute right-0 top-full mt-2 w-80 bg-white rounded-md shadow-lg z-20 border max-h-96 overflow-y-auto"><ul>`;
                
                if (pendingForMe.length > 0) {
                    dropdownHTML += `<li class="p-2 bg-gray-100 font-bold text-gray-800">待我簽核 (${pendingForMe.length})</li>`;
                    pendingForMe.forEach(req => {
                        dropdownHTML += `
                            <li class="p-2 border-b hover:bg-gray-100 flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full bg-blue-500 flex-shrink-0"></span>
                                <a href="#" data-action="view-notification-detail" data-id="${req.id}" class="min-w-0 flex-grow">
                                    <p class="text-sm text-gray-800 whitespace-normal">${req.id}</p>
                                    <span class="text-xs font-normal text-gray-600">來自 ${state.users[req.applicant_id]?.name || '未知'} の申請</span>
                                </a>
                            </li>`;
                    });
                }

                if (toHandle.length > 0) {
                    dropdownHTML += `<li class="p-2 bg-gray-100 font-bold text-gray-800">待我經辦 (${toHandle.length})</li>`;
                    toHandle.forEach(req => {
                        dropdownHTML += `
                            <li class="p-2 border-b hover:bg-gray-100 flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full bg-amber-500 flex-shrink-0"></span>
                                <a href="#" data-action="view-notification-detail" data-id="${req.id}" class="min-w-0 flex-grow">
                                    <p class="text-sm text-gray-800 whitespace-normal">${req.id}</p>
                                    <span class="text-xs font-normal text-gray-600">已核准，待您經辦</span>
                                </a>
                            </li>`;
                    });
                }

                if (toClose.length > 0) {
                    dropdownHTML += `<li class="p-2 bg-gray-100 font-bold text-gray-800">待我結案 (${toClose.length})</li>`;
                    toClose.forEach(req => {
                        dropdownHTML += `
                            <li class="p-2 border-b hover:bg-gray-100 flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full bg-purple-500 flex-shrink-0"></span>
                                <a href="#" data-action="view-notification-detail" data-id="${req.id}" class="min-w-0 flex-grow">
                                    <p class="text-sm text-gray-800 whitespace-normal">${req.id}</p>
                                    <span class="text-xs font-normal text-gray-600">已經辦，待您結案</span>
                                </a>
                            </li>`;
                    });
                }

                if (myNotifications.length > 0) {
                    const unreadCount = myNotifications.filter(n => !n.is_read).length;
                    dropdownHTML += `<li class="p-2 bg-gray-100 font-bold text-gray-800 flex items-center justify-between">
                        <span>表單進度更新</span>
                        ${unreadCount > 0 ? `<button class="text-xs text-blue-600 hover:underline" data-action="mark-all-read-updates">一鍵全讀 (${unreadCount})</button>` : ''}
                    </li>`;
                    myNotifications.forEach(n => {
                        dropdownHTML += `
                            <li class="p-2 border-b hover:bg-gray-100 flex items-start space-x-2">
                                <span class="w-2 h-2 rounded-full ${!n.is_read ? 'bg-blue-500' : 'bg-transparent'} mt-1.5 flex-shrink-0"></span>
                                <a href="#" data-action="view-notification-detail" data-id="${n.request_id}" data-notification-id="${n.id}" class="min-w-0 flex-grow">
                                    <p class="whitespace-normal text-sm text-gray-800">${n.message}</p>
                                    <span class="text-xs text-gray-400">${getFormattedDateTime(n.timestamp)}</span>
                                </a>
                            </li>`;
                    });
                }

                dropdownHTML += `</ul></div>`;
                bellHTML += dropdownHTML;
            }
            bellContainer.innerHTML = bellHTML;
        };


        const renderLoginView = () => {
            const viewEl = document.getElementById('login-view');
            viewEl.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold text-center mb-6">特採系統登入</h2>
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="account" class="block text-sm font-medium text-gray-700">帳號 (工號、ID 或 Email)</label>
                                <input type="text" id="account" name="account" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" autocomplete="email">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-gray-700">密碼</label>
                                <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" autocomplete="current-password">
                            </div>
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="remember-me" class="ml-2 block text-sm text-gray-900">記住我</label>
                                </div>
                                <div class="text-sm">
                                    <a href="#" id="forgot-password-link" class="font-medium text-blue-600 hover:text-blue-500">忘記密碼？</a>
                                </div>
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">登入</button>
                        </form>
                    </div>
                </div>`;
            viewEl.style.display = 'block';
            // Pre-fill account if it was remembered
            const rememberedAccount = localStorage.getItem('rememberedAccount');
            if (rememberedAccount) {
                const accountInput = document.getElementById('account');
                const rememberMeCheckbox = document.getElementById('remember-me');
                if (accountInput) accountInput.value = rememberedAccount;
                if (rememberMeCheckbox) rememberMeCheckbox.checked = true;
            }
        };

        // --- 視圖渲染器 ---
        window.renderDashboard = () => {
            const viewEl = document.getElementById('dashboard-view');
            const { currentUser } = state;
            const isPurchasing = currentUser.role === '採購' || currentUser.role === '採購主管' || currentUser.is_admin;
            const isAdmin = currentUser.is_admin;
            const isPendingForMeView = state.local.dashboardFilters.permission === 'pending_for_me';
            const hasSelection = state.local.selectedRequestIds.size > 0;
            
            if (!state.local.dashboardFilters.dateFrom) {
                const now = new Date();
                const firstDay = new Date(2025, 6, 1); // July is month 6
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                state.local.dashboardFilters.dateFrom = getISODateString(firstDay);
                state.local.dashboardFilters.dateTo = getISODateString(lastDay);
            }

            if (!state.local.dashboardFilters.permission) {
                state.local.dashboardFilters.permission = 'pending_for_me';
            }

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex flex-nowrap justify-between items-center sticky top-0 z-10 gap-4">
                    <h1 class="text-2xl font-bold text-gray-700 whitespace-nowrap flex-shrink-0">特別採購單</h1>
                    <div class="header-toolbar flex items-center flex-nowrap space-x-4 overflow-x-auto whitespace-nowrap flex-1 min-w-0">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="dashboard-search-input" placeholder="搜尋所有欄位..." class="h-10 w-40 md:w-56 lg:w-64 px-3 border border-gray-300 rounded-l-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" value="${state.local.dashboardFilters.searchTerm || ''}" autocomplete="off" spellcheck="false" />
                            <button data-action="search-dashboard" class="h-10 px-4 bg-blue-600 text-white rounded-r-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition-colors duration-200">GO</button>
                        </div>
                        ${isPendingForMeView ? `
                            <button data-action="batch-approve" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" ${!hasSelection ? 'disabled' : ''}>批次核准</button>
                            <button data-action="batch-reject" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed" ${!hasSelection ? 'disabled' : ''}>批次退回</button>
                        ` : ''}
                        ${isPurchasing ? `
                            <button data-action="batch-close" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-500 text-white hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed" ${!hasSelection ? 'disabled' : ''}>批次結案</button>
                        ` : ''}
                        <button data-action="refresh" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-500 text-white hover:bg-indigo-600">重新整理</button>
                        ${(isPurchasing || currentUser.is_admin) ? `
                            <button data-action="consolidate-by-vendor" class="px-4 py-2 rounded-md font-semibold text-sm bg-teal-600 text-white hover:bg-teal-700">依廠商彙整</button>
                            <button data-action="export" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">匯出訂單</button>
                        ` : ''}
                        ${isAdmin ? '<button data-view="departmentManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">部門管理</button>' : ''}
                        ${isAdmin ? '<button data-view="userManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">使用者管理</button>' : ''}
                        ${(isPurchasing || currentUser.is_admin) ? `
                            <button data-view="vendorManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">廠商管理</button>
                            <button data-view="productManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">商品管理</button>
                            <button data-view="printManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-purple-600 text-white hover:bg-purple-700">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                </svg>
                                表單列印作業
                            </button>
                        ` : ''}
                        <button data-view="newRequest" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            新增申請
                        </button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div id="dashboard-filters" class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6 pb-6 border-b border-gray-200"></div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"></thead>
                            <tbody id="dashboard-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                        <div id="dashboard-hover-popover" class="hover-popover"></div>
                    </div>
                    <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm"></div>
                </div>`;
            
            renderDashboardFilters();
            renderDashboardTable();
            viewEl.style.display = 'block';
            
            // 優化搜尋功能
            setTimeout(() => {
                const searchInput = document.getElementById('dashboard-search-input');
                if (searchInput && !searchInput.dataset.optimized) {
                    searchInput.dataset.optimized = 'true';
                    
                    // 防抖搜尋處理器
                    if (!window.dashboardSearchDebounce) {
                        window.dashboardSearchDebounce = debounce((searchTerm) => {
                            state.local.selectedRequestIds.clear();
                            state.local.currentPage = 1;
                            state.local.dashboardFilters.searchTerm = searchTerm;
                            renderDashboardTable();
                        }, 300);
                    }
                    
                    // 即時搜尋功能
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.trim();
                        window.dashboardSearchDebounce(searchTerm);
                    });
                    
                    // Enter 鍵快速搜尋
                    searchInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const searchTerm = e.target.value.trim();
                            state.local.selectedRequestIds.clear();
                            state.local.currentPage = 1;
                            state.local.dashboardFilters.searchTerm = searchTerm;
                            renderDashboardTable();
                        }
                        
                        // ESC 鍵清空搜尋
                        if (e.key === 'Escape') {
                            e.target.value = '';
                            state.local.dashboardFilters.searchTerm = '';
                            renderDashboardTable();
                        }
                    });
                    
                    // 搜尋框獲得焦點時的優化
                    searchInput.addEventListener('focus', () => {
                        searchInput.select();
                    });
                }
            }, 0);
        };

        const renderMultiSelect = (filterKey, placeholder, options) => {
            const selectedItems = state.local.dashboardFilters[filterKey] || new Set();
            
            const selectedLabels = options
                .filter(opt => selectedItems.has(opt.value))
                .map(opt => opt.label);

            const displayValue = selectedItems.size > 2 
                ? `${placeholder} (${selectedItems.size} 已選)` 
                : (selectedItems.size > 0 ? selectedLabels.join(', ') : placeholder);

            return `
                <div class="relative multi-select-container">
                    <button data-filter-key="${filterKey}" class="multi-select-toggle w-full p-2 border border-gray-300 rounded-md shadow-sm text-left truncate">${displayValue}</button>
                    <div class="multi-select-dropdown hidden absolute z-10 w-full bg-white border rounded-md shadow-lg mt-1">
                        <input type="text" class="multi-select-search w-full p-2 border-b" placeholder="搜尋...">
                        <ul class="max-h-40 overflow-y-auto">
                            ${options.map(option => `
                                <li>
                                    <label class="flex items-center p-2 hover:bg-gray-100">
                                        <input type="checkbox" class="multi-select-checkbox" data-filter-key="${filterKey}" value="${option.value}">
                                        <span class="ml-2 text-sm">${option.label}</span>
                                    </label>
                                </li>
                            `).join('')}
                        </ul>
                        <div class="p-2 border-t flex justify-between items-center bg-gray-50">
                            <div>
                                <button data-action="select-all-multi" data-filter-key="${filterKey}" class="text-xs text-blue-600 hover:underline">全選</button>
                                <button data-action="deselect-all-multi" data-filter-key="${filterKey}" class="text-xs text-blue-600 hover:underline ml-2">全不選</button>
                            </div>
                            <div>
                                <button data-action="cancel-multi-select" class="px-3 py-1 text-xs rounded-md bg-gray-200 hover:bg-gray-300">取消</button>
                                <button data-action="confirm-multi-select" data-filter-key="${filterKey}" class="px-3 py-1 text-xs rounded-md bg-blue-600 text-white hover:bg-blue-700 ml-2">確定</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        const renderDashboardFilters = () => {
            const container = document.getElementById('dashboard-filters');
            if(!container) return;
            const filters = state.local.dashboardFilters;
            const dateFrom = filters.dateFrom;
            const dateTo = filters.dateTo;

            const { currentUser } = state;
            const isPurchasing = currentUser.role === '採購' || currentUser.role === '採購主管' || currentUser.is_admin;
            const isBasicUser = currentUser.role === '使用者';
            let permissionOptions = `
                <option value="my">我申請的訂單</option>
                <option value="pending_for_me">待我簽核的單據</option>
                <option value="approved_by_me">我簽核過的</option>
                <option value="rejected_by_me">我退回簽核的</option>
            `;
            if (currentUser.is_department_head) {
                permissionOptions += `<option value="department">我的部門訂單</option>`;
            }
            if (isPurchasing || currentUser.is_admin) {
                permissionOptions += `<option value="to_handle">待我經辦的表單</option>`;
                permissionOptions += `<option value="to_close">待我結案的表單</option>`;
                permissionOptions += `<option value="all">所有訂單</option>`;
            }

            const vendorOptions = state.vendors.map(v => ({
                value: v.vendor_id,
                label: `${v.short_name || v.name || v.vendor_id}`
            }));
            const allStatuses = ['待送出', '待審核', '已核准', '已退回'].map(s => ({ value: s, label: s }));

            // 系統管理員需可見廠商篩選；即便角色為「使用者」但 is_admin 為真也顯示
            const vendorFilterHTML = (isBasicUser && !currentUser.is_admin) ? '' : `
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">廠商</label>
                    ${renderMultiSelect('vendors', '選擇廠商', vendorOptions)}
                </div>`;

            container.innerHTML = `
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">檢視權限</label>
                    <select data-filter="permission" class="filter-change w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        ${permissionOptions}
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">日期區間</label>
                    <div class="flex items-center">
                        <input type="text" id="dashboard-date-range" class="w-full h-10 px-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="選擇日期區間" autocomplete="off" />
                    </div>
                </div>
                ${vendorFilterHTML}
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">簽核狀態</label>
                     ${renderMultiSelect('statuses', '選擇簽核狀態', allStatuses)}
                </div>
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">經辦狀態</label>
                     ${renderMultiSelect('handlerStatuses', '選擇經辦狀態', [
                         { value: '未經辦', label: '未經辦' },
                         { value: '待經辦', label: '待經辦' },
                         { value: '已經辦', label: '已經辦' }
                     ])}
                </div>
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">結案狀態</label>
                     ${renderMultiSelect('closedStatuses', '選擇結案狀態', [
                         { value: '結案', label: '結案' },
                         { value: '未結案', label: '未結案' }
                     ])}
                </div>
                
            `;
            container.querySelector('[data-filter="permission"]').value = filters.permission || 'my';

            // 初始化日期區間 flatpickr（動態載入，避免外部依賴失敗）
            (function initDateRangePicker() {
                const input = container.querySelector('#dashboard-date-range');
                if (!input) return;

                // 如果已有值，顯示成友善格式；初始化交由 flatpickr altInput 處理
                const { dateFrom, dateTo } = filters;

                function loadScript(src, id) {
                    return new Promise((resolve, reject) => {
                        if (id && document.getElementById(id)) return resolve();
                        const s = document.createElement('script');
                        s.src = src; s.async = true; if (id) s.id = id;
                        s.onload = resolve; s.onerror = () => reject(new Error('Failed to load ' + src));
                        document.head.appendChild(s);
                    });
                }
                function loadStyle(href, id) {
                    return new Promise((resolve, reject) => {
                        if (id && document.getElementById(id)) return resolve();
                        const l = document.createElement('link');
                        l.rel = 'stylesheet'; l.href = href; if (id) l.id = id;
                        l.onload = resolve; l.onerror = () => reject(new Error('Failed to load ' + href));
                        document.head.appendChild(l);
                    });
                }

                function boot() {
                    try {
                        const localeObj = (window.flatpickr && window.flatpickr.l10ns && window.flatpickr.l10ns.zh_tw) ? window.flatpickr.l10ns.zh_tw : 'zh_tw';
                        const fp = window.flatpickr(input, {
                            mode: 'range',
                            locale: localeObj,
                            dateFormat: 'Y-m-d',         // 存入值（內部）
                            altInput: true,
                            altFormat: 'Y年n月j日',       // 顯示用（繁中）
                            altInputClass: 'w-full h-10 px-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200',
                            allowInput: true,
                            clickOpens: true,
                            showMonths: 1,               // 單欄
                            defaultDate: (dateFrom && dateTo) ? [dateFrom, dateTo] : null,
                            onOpen: (selectedDates, dateStr, instance) => {
                                // 每次打開都從新選取起訖
                                instance.clear();
                            },
                            onChange: (selectedDates) => {
                                // 僅在選滿起訖兩日後套用篩選
                                if (selectedDates.length === 2) {
                                    const [start, end] = selectedDates;
                                    state.local.dashboardFilters.dateFrom = getISODateString(start);
                                    state.local.dashboardFilters.dateTo = getISODateString(end);
                                    state.local.currentPage = 1;
                                    renderDashboard();
                                }
                            }
                        });
                    } catch (err) {
                        console.error('flatpickr 初始化失敗:', err);
                    }
                }

                const tasks = [];
                if (!window.flatpickr) {
                    tasks.push(loadStyle('https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css', 'flatpickr-css'));
                    tasks.push(loadScript('https://cdn.jsdelivr.net/npm/flatpickr', 'flatpickr-js'));
                }
                Promise.all(tasks).then(() => {
                    // 一律嘗試載入繁中在地化，再初始化
                    loadScript('https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js', 'flatpickr-zh-tw')
                        .then(boot)
                        .catch(() => boot());
                }).catch(() => {
                    // 若載入失敗，退回原生日期欄位（最小改動）
                    input.type = 'date';
                    input.value = dateFrom || '';
                    input.classList.add('filter-change');
                    input.dataset.filter = 'dateFrom';
                });
            })();
        };

    const getFilteredRequests = (() => {
            let lastFilters = null;
            let lastResult = [];

            const func = () => {
                const { currentUser, requests } = state;
                const { dashboardFilters, sortKey, sortDirection } = state.local;
                
                const filtersForCache = {
                    ...dashboardFilters,
                    vendors: [...(dashboardFilters.vendors || [])].sort(),
                    statuses: [...(dashboardFilters.statuses || [])].sort(),
                    closedStatuses: [...(dashboardFilters.closedStatuses || [])].sort(),
                    handlerStatuses: [...(dashboardFilters.handlerStatuses || [])].sort(),
                };

                const currentFilters = JSON.stringify({
                    filters: filtersForCache,
                    sortKey,
                    sortDirection,
                    reqCount: requests.length,
                    userId: currentUser.id
                });

                if (currentFilters === lastFilters) {
                    return lastResult;
                }

                let baseRequests;
                const permission = dashboardFilters.permission || 'my';

                switch(permission) {
                    case 'my': baseRequests = requests.filter(req => req.applicant_id === currentUser.id); break;
                    case 'pending_for_me': 
                        baseRequests = requests.filter(req => {
                            if (!req.approvers) return false;
                            const nextApprover = req.approvers.find(a => a.status === 'pending');
                            return req.status === '待審核' && nextApprover && nextApprover.userId === currentUser.id;
                        });
                        break;
                    case 'approved_by_me': baseRequests = requests.filter(req => (req.approvers || []).some(a => a.userId === currentUser.id && a.status === 'approved')); break;
                    case 'rejected_by_me': baseRequests = requests.filter(req => (req.approvers || []).some(a => a.userId === currentUser.id && a.status === 'rejected')); break;
                    case 'to_handle':
                        baseRequests = requests.filter(req => {
                            // 已核准且待經辦，且使用者是被指派經辦或採購/管理者
                            const effective = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                            const roleOk = (currentUser.id === req.handler_id) || currentUser.role === '採購' || currentUser.role === '採購主管' || currentUser.is_admin;
                            const notClosed = req.closed_status !== '結案';
                            return effective === '待經辦' && roleOk && notClosed;
                        });
                        break;
                    case 'to_close':
                        baseRequests = requests.filter(req => {
                            // 已經辦且未結案，通常由採購角色或管理者結案
                            const effective = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                            const roleOk = currentUser.role === '採購' || currentUser.role === '採購主管' || currentUser.is_admin;
                            const notClosed = req.closed_status !== '結案';
                            return effective === '已經辦' && notClosed && roleOk;
                        });
                        break;
                    case 'department': baseRequests = currentUser.is_department_head ? requests.filter(req => req.department === currentUser.department) : requests.filter(req => req.applicant_id === currentUser.id); break;
                    case 'all': 
                        // 管理者、採購主管的"所有訂單"權限與採購相同
                        const canSeeAllOrders = currentUser.role === '採購' || currentUser.role === '採購主管' || currentUser.is_admin;
                        baseRequests = canSeeAllOrders ? requests : requests.filter(req => req.applicant_id === currentUser.id); 
                        break;
                    default: baseRequests = requests.filter(req => req.applicant_id === currentUser.id);
                }

                const { dateFrom, dateTo, vendors: selectedVendorIds = new Set(), statuses = new Set(), closedStatuses = new Set(), handlerStatuses = new Set(), searchTerm = '' } = dashboardFilters;
                const lowerCaseSearchTerm = searchTerm.toLowerCase();


                // 只用 vendor_id 做篩選
                let filtered = baseRequests.filter(req => {
                    const requestDate = req.request_date ? getISODateString(req.request_date) : '';
                    if (dateFrom && dateTo && (requestDate < dateFrom || requestDate > dateTo)) return false;
                    if (selectedVendorIds.size > 0) {
                        const hasMatchingVendor = (req.items || []).some(item => selectedVendorIds.has(item.vendor));
                        if (!hasMatchingVendor) return false;
                    }
                    if (statuses.size > 0 && !statuses.has(req.status)) return false;
                    if (closedStatuses.size > 0) {
                        let hasMatchingClosedStatus = false;
                        for (const closedStatus of closedStatuses) {
                            if (closedStatus === '結案' && req.closed_status === '結案') {
                                hasMatchingClosedStatus = true;
                                break;
                            } else if (closedStatus === '未結案' && (req.closed_status !== '結案' || !req.closed_status)) {
                                hasMatchingClosedStatus = true;
                                break;
                            }
                        }
                        if (!hasMatchingClosedStatus) return false;
                    }
                    if (handlerStatuses.size > 0) {
                        const effectiveHandler = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                        if (!handlerStatuses.has(effectiveHandler)) return false;
                    }
                    if (lowerCaseSearchTerm && !JSON.stringify(req).toLowerCase().includes(lowerCaseSearchTerm)) return false;
                    return true;
                });

                if (sortKey) {
                    filtered.sort((a, b) => {
                        let valA = a[sortKey];
                        let valB = b[sortKey];

                        if (sortKey === 'applicant_id') {
                            valA = state.users[valA]?.name || '';
                            valB = state.users[valB]?.name || '';
                        } else if (sortKey === 'type') {
                            // 訂單類別排序：特採 < 專案，其餘依字母
                            const order = { '特採': 0, '專案': 1 };
                            valA = order[a.type] ?? 9;
                            valB = order[b.type] ?? 9;
                        } else if (sortKey === 'handler_status') {
                            const order = { '未經辦': 0, '待經辦': 1, '已經辦': 2 };
                            const effA = a.handler_status || (a.status === '已核准' ? '待經辦' : '未經辦');
                            const effB = b.handler_status || (b.status === '已核准' ? '待經辦' : '未經辦');
                            valA = order[effA] ?? 0;
                            valB = order[effB] ?? 0;
                        } else if (sortKey === 'closed_status') {
                            // 未結案 < 結案
                            const map = (v) => (v === '結案' ? 1 : 0);
                            valA = map(a.closed_status);
                            valB = map(b.closed_status);
                        }

                        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                lastFilters = currentFilters;
                lastResult = filtered;
                return filtered;
            };

            func.resetCache = () => {
                lastFilters = null;
            };

            return func;
        })();

    const renderDashboardTable = () => {
            const tableBody = document.getElementById('dashboard-table-body');
            if (!tableBody) return;
            const tableHead = tableBody.previousElementSibling;
            
            // 效能優化：使用緩存的過濾結果
            const filteredRequests = getFilteredRequests();
            const { currentPage, itemsPerPage } = state.local;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedRequests = filteredRequests.slice(startIndex, endIndex);

            const renderSortIcon = (key) => {
                if (state.local.sortKey !== key) return `<span class="sort-icon">▲▼</span>`;
                return state.local.sortDirection === 'asc' ? `<span class="sort-icon">▲</span>` : `<span class="sort-icon">▼</span>`;
            };

            // 每次都重繪表頭，確保排序箭頭正確
            if (tableHead) {
                tableHead.innerHTML = `
                    <tr>
                        <th class="p-4 relative">
                            <div class="group inline-block">
                                <button class="border px-2 py-1 rounded transition-colors duration-200 hover:bg-gray-50">選取</button>
                                <div class="absolute hidden group-hover:block bg-white shadow-md rounded-md mt-1 border z-10">
                                    <a href="#" data-action="select-page" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150">全選此頁</a>
                                    <a href="#" data-action="select-all-filtered" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150">全選所有</a>
                                    <a href="#" data-action="deselect-all" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150">取消選取</a>
                                </div>
                            </div>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'id' ? 'active' : ''}" data-action="sort" data-sort-key="id">申請單號 ${renderSortIcon('id')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'applicant_id' ? 'active' : ''}" data-action="sort" data-sort-key="applicant_id">申請人 ${renderSortIcon('applicant_id')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'request_date' ? 'active' : ''}" data-action="sort" data-sort-key="request_date">申請日期 ${renderSortIcon('request_date')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'department' ? 'active' : ''}" data-action="sort" data-sort-key="department">科室 ${renderSortIcon('department')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'type' ? 'active' : ''}" data-action="sort" data-sort-key="type">訂單類別 ${renderSortIcon('type')}</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'total_amount' ? 'active' : ''}" data-action="sort" data-sort-key="total_amount">總金額 ${renderSortIcon('total_amount')}</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'status' ? 'active' : ''}" data-action="sort" data-sort-key="status">簽核狀態 ${renderSortIcon('status')}</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'handler_status' ? 'active' : ''}" data-action="sort" data-sort-key="handler_status">經辦狀態 ${renderSortIcon('handler_status')}</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'closed_status' ? 'active' : ''}" data-action="sort" data-sort-key="closed_status">結案狀態 ${renderSortIcon('closed_status')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">簽核進度</th>
                    </tr>
                `;
            }

            // 優化表格行渲染 - 使用批量處理和預構建樣式
            const statusStylesCache = {
                '待送出': 'bg-gray-100 text-gray-800', 
                '待審核': 'bg-yellow-100 text-yellow-800', 
                '已核准': 'bg-green-100 text-green-800', 
                '已退回': 'bg-red-100 text-red-800'
            };
            const closedStatusStylesCache = {
                '未結案': 'bg-blue-100 text-blue-800', 
                '結案': 'bg-gray-300 text-gray-800'
            };
            const handlerStatusStylesCache = {
                '未經辦': 'bg-neutral-100 text-neutral-800',
                '待經辦': 'bg-amber-100 text-amber-800',
                '已經辦': 'bg-green-100 text-green-800'
            };
            const orderTypeStylesCache = {
                '特採': 'bg-pink-100 text-pink-800',
                '專案': 'bg-teal-100 text-teal-800'
            };

            // 使用 DocumentFragment 進行批量 DOM 更新
            if (paginatedRequests.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="11" class="text-center py-10 text-gray-500">無符合條件的申請單</td></tr>`;
            } else {
                // 預處理數據以避免重複計算
                        const processedRows = paginatedRequests.map(req => {
                    const approvers = req.approvers || [];
                    const approverStatus = approvers.map(a => `${a.role}: ${a.status === 'approved' ? '✔️' : a.status === 'rejected' ? '❌' : '…'}`).join(' | ');
                    const approverTooltip = approvers.map(a => {
                        const userName = state.users[a.userId]?.name || (a.userId ? a.userId.substring(0,8) : '');
                        const stat = a.status === 'approved' ? '已核准' : (a.status === 'rejected' ? '已退回' : '待簽核');
                        const t = a.date ? `（${getFormattedDateTime(a.date)}）` : '';
                        return `${a.role} - ${stat}${t}${userName ? ` by ${userName}` : ''}`;
                    }).join('\n');
                    const isChecked = state.local.selectedRequestIds.has(req.id);
                    const userName = state.users[req.applicant_id]?.name || '未知';
                    const formattedAmount = Number(req.total_amount).toLocaleString();
                    const formattedDate = getFormattedDateTime(req.request_date);
                    
                    // 檢查是否可以簽核
                    const nextApprover = approvers.find(a => a.status === 'pending');
                    const canApprove = req.status === '待審核' && 
                                      nextApprover && 
                                      nextApprover.userId === state.currentUser.id;
                    
                    return {
                        id: req.id,
                        userName,
                        formattedDate,
                        department: req.department,
                        orderType: req.type || '特採',
                        formattedAmount,
                        status: req.status,
                        hasAttachments: Array.isArray(req.attachments) && req.attachments.length > 0,
                        handlerStatus: req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦'),
                        closedStatus: req.closed_status || '未結案',
                        approverStatus,
                        approverTooltip,
                        isChecked,
                        canApprove,
                        statusStyle: statusStylesCache[req.status] || 'bg-gray-100 text-gray-800',
                        handlerStatusStyle: handlerStatusStylesCache[req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦')] || 'bg-gray-100 text-gray-800',
                        closedStatusStyle: closedStatusStylesCache[req.closed_status] || '',
                        orderTypeStyle: orderTypeStylesCache[req.type || '特採'] || 'bg-gray-100 text-gray-800'
                    };
                });

                // 批量生成 HTML
                const rowsHTML = processedRows.map(row => `
                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                        <td class="p-4"><input type="checkbox" class="request-checkbox rounded focus:ring-2 focus:ring-blue-500" data-id="${row.id}" ${row.isChecked ? 'checked' : ''} /></td>
                        <td class="px-6 py-4 text-sm text-blue-600 font-medium">
                            <a href="#" data-id="${row.id}" data-action="view-detail" class="hover:text-blue-900 transition-colors duration-150 inline-flex items-center whitespace-nowrap align-middle">
                                <span class="request-id-hover" data-request-id="${row.id}">${row.id}</span>
                                ${row.hasAttachments ? '<span class="ml-1 text-gray-500" title="含附件">📎</span>' : ''}
                            </a>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">${row.userName}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${row.formattedDate}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${row.department}</td>
                        <td class="px-6 py-4 text-left">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${row.orderTypeStyle}">${row.orderType}</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 text-right font-medium">$${row.formattedAmount}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${row.statusStyle}">${row.status}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${row.handlerStatusStyle}">${row.handlerStatus}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${row.closedStatusStyle}">${row.closedStatus}</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500"><span title="${row.approverTooltip}">${row.approverStatus}</span></td>
                    </tr>
                `).join('');

                // 使用 requestAnimationFrame 來優化渲染
                requestAnimationFrame(() => {
                    tableBody.innerHTML = rowsHTML;
                });
            }

            // 分頁控制項渲染優化
            requestAnimationFrame(() => {
                renderPaginationControls(filteredRequests.length);
            });
        };

        const renderPaginationControls = (totalItems) => {
            const controlsContainer = document.getElementById('pagination-controls');
            if (!controlsContainer) return;

            const { currentPage, itemsPerPage } = state.local;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (totalPages <= 1) {
                controlsContainer.innerHTML = '';
                return;
            }

            let buttonsHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const isCurrent = i === currentPage;
                buttonsHTML += `<button data-action="go-to-page" data-page="${i}" class="${isCurrent ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'} px-3 py-1 border border-gray-300 rounded-md">${i}</button>`;
            }

            controlsContainer.innerHTML = `
                <div class="text-gray-600">
                    共 ${totalItems} 筆資料，目前在第 ${currentPage} / ${totalPages} 頁
                </div>
                <div class="flex items-center space-x-2">
                    <button data-action="go-to-page" data-page="${currentPage - 1}" class="px-3 py-1 border rounded-md disabled:opacity-50" ${currentPage === 1 ? 'disabled' : ''}>上一頁</button>
                    ${buttonsHTML}
                    <button data-action="go-to-page" data-page="${currentPage + 1}" class="px-3 py-1 border rounded-md disabled:opacity-50" ${currentPage === totalPages ? 'disabled' : ''}>下一頁</button>
                </div>
            `;
        };
        
        window.renderNewRequest = function() {
            const viewEl = document.getElementById('newRequest-view');
            const categories = ['我的最愛', '購買過的', '全品項', ...Object.keys(state.products)];
            const activeCategory = state.local.activeProductCategory || '我的最愛';
            const isEditingDraft = !!state.editingRequest;
            const layoutScale = state.local.layoutScale || 'expanded';
            // 若為編輯草稿且本地附件清單為空，預填草稿附件
            if (isEditingDraft && (!state.local.newRequestAttachments || state.local.newRequestAttachments.length === 0)) {
                state.local.newRequestAttachments = [...(state.editingRequest.attachments || [])];
            }
            
            // 根據縮放狀態設定寬度比例
            const leftWidth = layoutScale === 'expanded' ? 'lg:w-2/3' : 'lg:w-1/3';
            const rightWidth = layoutScale === 'expanded' ? 'lg:w-1/3' : 'lg:w-2/3';

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-4">
                        <h1 class="text-2xl font-bold text-gray-700">${isEditingDraft ? `編輯草稿: ${state.editingRequest.id}` : '特採物品申請菜單'}</h1>
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl font-bold text-blue-700">版型:</span>
                            <button data-action="toggle-layout-scale" data-scale="expanded" class="flex items-center gap-2 px-3 py-1 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors ${layoutScale === 'expanded' ? 'bg-blue-600 text-white' : 'bg-white text-blue-700 border border-blue-300 hover:bg-blue-50'}" title="展開商品清單 (左 2/3 | 右 1/3)">
                                <svg width="24" height="16" viewBox="0 0 24 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <rect x="1" y="1" width="14" height="14" rx="2" fill="currentColor" opacity="0.35"/>
                                    <rect x="17" y="1" width="6" height="14" rx="2" fill="currentColor" opacity="0.8"/>
                                </svg>
                                <span>清單較寬</span>
                            </button>
                            <button data-action="toggle-layout-scale" data-scale="compact" class="flex items-center gap-2 px-3 py-1 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-300 transition-colors ${layoutScale === 'compact' ? 'bg-amber-600 text-white' : 'bg-white text-amber-700 border border-amber-300 hover:bg-amber-50'}" title="壓縮商品清單 (左 1/3 | 右 2/3)">
                                <svg width="24" height="16" viewBox="0 0 24 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <rect x="1" y="1" width="6" height="14" rx="2" fill="currentColor" opacity="0.8"/>
                                    <rect x="9" y="1" width="14" height="14" rx="2" fill="currentColor" opacity="0.35"/>
                                </svg>
                                <span>清單較窄</span>
                            </button>
                        </div>
                    </div>
                    <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="${leftWidth}">
                        <div class="bg-white shadow-md rounded-lg p-6">
                        <div class="mb-4 border-b border-gray-200">
                            <nav class="product-categories -mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                                ${categories.map(cat => `<button data-category="${cat}" data-action="switch-category" class="product-category-btn ${cat === activeCategory ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">${cat}</button>`).join('')}
                            </nav>
                        </div>
                            <div class="flex items-center gap-4 mb-4">
                                <input type="text" id="new-request-product-search" placeholder="搜尋商品..." class="w-full p-2 border border-gray-300 rounded-md" value="${state.local.newRequestSearchTerm || ''}">
                                <button data-action="search-new-request-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">搜尋</button>
                                <label class="flex items-center text-sm whitespace-nowrap">
                                    <input type="checkbox" id="new-request-search-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${state.local.newRequestSearchAll ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-700">搜尋全分類</span>
                                </label>
                            </div>
                            <div class="product-list grid ${layoutScale === 'compact' ? 'grid-cols-2' : 'grid-cols-4'} gap-6"></div>
                            <div id="product-list-pagination" class="mt-6 flex justify-center items-center"></div>
                        </div>
                    </div>
                    <div class="${rightWidth}">
                        <div id="new-request-sidebar" class="bg-white shadow-md rounded-lg p-6 sticky top-24"></div>
                    </div>
                </div>`;
            renderProductList();
            renderNewRequestSidebar();
            viewEl.style.display = 'block';
        };

        const renderProductList = () => {
            const productListEl = document.querySelector('#newRequest-view .product-list');
            if (!productListEl) return;
            
            const { activeProductCategory, newRequestSearchTerm, newRequestSearchAll, layoutScale } = state.local;
            const searchTerm = (newRequestSearchTerm || '').toLowerCase();

            let productsToSearch = [];
            if (newRequestSearchAll) {
                productsToSearch = state.allProducts;
            } else {
                if (activeProductCategory === '我的最愛') {
                    productsToSearch = state.allProducts.filter(p => state.local.favoriteProductIds.has(p.id));
                } else if (activeProductCategory === '購買過的') {
                    const purchasedProductIds = new Set();
                    state.requests
                        .filter(req => req.applicant_id === state.currentUser.id && req.status === '已核准')
                        .forEach(req => {
                            (req.items || []).forEach(item => purchasedProductIds.add(item.id));
                        });
                    productsToSearch = state.allProducts.filter(p => purchasedProductIds.has(p.id));
                } else if (activeProductCategory === '全品項' || !activeProductCategory) {
                    productsToSearch = state.allProducts;
                } else {
                    productsToSearch = state.products[activeProductCategory] || [];
                }
            }

            let displayProducts = productsToSearch;
            if (searchTerm) {
                displayProducts = productsToSearch.filter(p => {
                    const { image, ...searchableProduct } = p; // Exclude image URL from search
                    return Object.values(searchableProduct).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                });
            }

            const paginationEl = document.getElementById('product-list-pagination');

            if (displayProducts.length === 0) {
                productListEl.innerHTML = `<p class="text-gray-500 col-span-full text-center">找不到符合條件的商品</p>`;
                if (paginationEl) paginationEl.innerHTML = '';
                return;
            }

            const { newRequestCurrentPage = 1 } = state.local;
            const itemsPerPage = 12;
            const totalItems = displayProducts.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (newRequestCurrentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedProducts = displayProducts.slice(startIndex, endIndex);

            productListEl.innerHTML = paginatedProducts.map(p => {
                const imageUrl = p.image 
                    ? `https://drive.google.com/thumbnail?id=${p.image}` 
                    : 'https://placehold.co/150x150?text=無圖片';
                const vendorName = state.vendors.find(v => v.vendor_id === p.vendor)?.short_name || p.vendor || 'N/A';
                return `
                <div class="border rounded-lg p-4 flex flex-col items-center text-center shadow-sm relative">
                    <button data-action="toggle-favorite" data-product-id="${p.id}" class="absolute top-2 right-2 text-gray-300 hover:text-yellow-500">
                        <svg class="w-5 h-5 ${state.local.favoriteProductIds.has(p.id) ? 'text-yellow-400' : ''}" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                        </svg>
                    </button>
                    <img src="${imageUrl}" alt="${p.name}" class="w-24 h-24 object-cover mb-2 rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/150x150?text=圖片錯誤';"/>
                    <h3 class="font-semibold text-sm">${p.name}</h3>
                    <p class="text-xs text-gray-500">${p.spec || ''}</p>
                    <p class="text-xs text-gray-500">廠商: ${vendorName}</p>
                    <p class="text-sm font-bold my-1">${p.price || 0}/${p.unit}</p>
                    <div class="flex items-center mt-2">
                        <input type="number" min="1" data-id="${p.id}" class="product-quantity-input w-16 text-center border-gray-300 rounded-md shadow-sm" value="1" />
                        <button data-product='${JSON.stringify(p)}' data-action="add-to-cart" class="add-to-cart-btn ml-2 p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">+</button>
                    </div>
                </div>`}).join('');
            
            if (paginationEl) {
                if (totalPages <= 1) {
                    paginationEl.innerHTML = '';
                } else {
                    paginationEl.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <button data-action="product-page-change" data-page="${newRequestCurrentPage - 1}" class="px-4 py-2 border rounded-md disabled:opacity-50" ${newRequestCurrentPage === 1 ? 'disabled' : ''}>
                                上一頁
                            </button>
                            <span class="text-gray-700">
                                第 ${newRequestCurrentPage} / ${totalPages} 頁
                            </span>
                            <button data-action="product-page-change" data-page="${newRequestCurrentPage + 1}" class="px-4 py-2 border rounded-md disabled:opacity-50" ${newRequestCurrentPage === totalPages ? 'disabled' : ''}>
                                下一頁
                            </button>
                        </div>
                    `;
                }
            }
        };

        const renderNewRequestSidebar = () => {
            const sidebarEl = document.getElementById('new-request-sidebar');
            if (!sidebarEl) return;
            const cart = state.local.newRequestCart;
            const totalAmount = Math.round(cart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)) + (item.freight || 0) + (item.discount || 0), 0));
            const isEditingDraft = !!state.editingRequest;
            const layoutScale = state.local.layoutScale || 'expanded';
            const itemCount = cart.length;
            const totalQuantity = cart.reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);
            // 訂單類別（預設特採；草稿沿用原值；如有本地選擇則覆蓋）
            const orderType = (state.local.newRequestOrderType !== undefined)
                ? state.local.newRequestOrderType
                : (isEditingDraft ? (state.editingRequest.type || '特採') : '特採');
            const orderTypeBadgeClass = orderType === '特採' ? 'bg-pink-100 text-pink-800' : 'bg-teal-100 text-teal-800';

            const cartItemsHTML = () => {
                if (cart.length === 0) return `<p class="text-gray-500 text-center py-8">購物車是空的</p>`;
                // 單一項目的內容（不含 li/div 外層）
                const renderCartItemInner = (item) => {
                    const reasonOptions = ['新增', '修繕', '報廢', '其他'];
                    return `
                        <div class="flex items-start w-full">
                            <div class="w-1/3 flex items-start space-x-2">
                                <div class="flex flex-col items-start space-y-2">
                                    <img src="${state.allProducts.find(p => p.id === item.id)?.image ? `https://drive.google.com/thumbnail?id=${state.allProducts.find(p => p.id === item.id).image}` : 'https://placehold.co/50x50?text=無圖片'}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/50x50?text=錯誤';"/>
                                    <input type="number" min="1" value="${item.quantity}" data-id="${item.id}" data-action="update-cart-quantity" class="w-16 text-center border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold">${item.name}</p>
                                    <p class="text-sm text-gray-500">${item.price} / ${item.unit}</p>
                                    <button data-id="${item.id}" data-action="remove-from-cart" class="mt-1 text-red-500 hover:text-red-700 p-1"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                            </div>
                            <div class="w-1/2 flex space-x-2">
                                <div class="w-1/2">
                                    <label class="block text-xs font-medium text-gray-700">需求課室</label>
                                    <select data-id="${item.id}" data-action="update-item-demand-dept" class="mt-1 block w-full p-1 text-sm rounded-md border-gray-300 shadow-sm">
                                        <option value="">-- 請選擇 --</option>
                                        ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}" ${(item.demand_department || state.currentUser.demand_department || '') === d ? 'selected' : ''}>${d}</option>`).join('')}
                                    </select>
                                    <label class="block text-xs font-medium text-gray-700 mt-2">申請原因</label>
                                    <select data-id="${item.id}" data-action="update-item-reason" class="mt-1 block w-full p-1 text-sm rounded-md border-gray-300 shadow-sm">
                                        ${reasonOptions.map(opt => `<option value="${opt}" ${item.reason === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/2">
                                    <label class="block text-xs font-medium text-gray-700">發票開立</label>
                                    <div class="flex space-x-2">
                                        <select data-id="${item.id}" data-action="update-item-invoice" class="mt-1 block ${item.invoice === '其他' ? 'w-1/3' : 'w-full'} p-1 text-sm rounded-md border-gray-300 shadow-sm">
                                            <option value="">-- 請選擇 --</option>
                                            ${[
                                                "8C清福", "7C清氣", "6C清心", "5C清平", "3C清安", "2CD清護",
                                                "8D清春", "7D清日", "6D清照", "5D清風", "3D清景", "8E清山",
                                                "7E清泉", "6E清水", "8E清清", "3E清涼", "清福法人", "一館",
                                                "二館", "三館", "含笑", "清福幼兒園", "其他"
                                            ].map(opt => `<option value="${opt}" ${item.invoice === opt ? 'selected' : item.invoice === undefined && opt === state.currentUser.default_invoice ? 'selected' : ''}>${opt}</option>`).join('')}
                                        </select>
                                        <input type="text" data-id="${item.id}" data-action="update-item-custom-invoice" class="mt-1 ${item.invoice === '其他' ? 'block w-2/3' : 'hidden'} p-1 text-sm rounded-md border-gray-300 shadow-sm" value="${item.custom_invoice || ''}" placeholder="請輸入發票開立...">
                                    </div>
                                    <label class="block text-xs font-medium text-gray-700 mt-2">說明</label>
                                    <input type="text" data-id="${item.id}" data-action="update-item-description" class="mt-1 block w-full p-1 text-sm rounded-md border-gray-300 shadow-sm" placeholder="如：新增設備、某某物品損壞..." value="${item.description || ''}">
                                </div>
                            </div>
                            <div class="w-1/6 ml-auto">
                                <div class="flex flex-col items-end text-right">
                                    <label class="flex items-center justify-end text-xs font-medium text-gray-700">
                                        <input type="checkbox" data-id="${item.id}" data-action="toggle-item-scrap" class="h-4 w-4 rounded border-gray-300 text-blue-600" ${item.is_scrap_work_order ? 'checked' : ''} ${item.reason === '報廢' ? '' : 'disabled'}>
                                        <span class="ml-2 text-gray-700">報廢財編</span>
                                    </label>
                                    <input type="text" data-id="${item.id}" data-action="update-item-work-order" class="self-end block w-20 mt-1 p-1 text-sm rounded-md border-gray-300 shadow-sm ${item.is_scrap_work_order ? '' : 'invisible'}" value="${item.work_order_number || ''}">
                                    ${(() => {
                                        const shouldShow = item.reason === '報廢' && !(item.is_scrap_work_order && (item.work_order_number || '').trim());
                                        return `
                                        <div id="scrap-reminder-${item.id}" class="${shouldShow ? '' : 'hidden'} mt-1 p-2 bg-yellow-100 border border-yellow-400 text-yellow-700 text-xs rounded transition-opacity duration-300 w-20 text-center self-end">
                                            <div>請勾選填寫</div>
                                            <div>報廢財編</div>
                                        </div>`;
                                    })()}
                                </div>
                            </div>
                        </div>
                    `;
                };

                // 依版型切換列表呈現：expanded 使用單欄列表；compact 使用雙欄網格
                if (layoutScale === 'compact') {
                    return `<ul class="grid grid-cols-2 gap-4">${cart.map(item => `
                        <li class="border rounded-md p-3">${renderCartItemInner(item)}</li>
                    `).join('')}</ul>`;
                }
                return `<ul class="divide-y divide-gray-200">${cart.map(item => `
                    <li class="py-3">${renderCartItemInner(item)}</li>
                `).join('')}</ul>`;
            };

            // 取得總說明（選填）的暫存值：優先顯示本地非空值，否則顯示草稿裡的值
            const requestReasonValue = (state.local.requestReason !== undefined && state.local.requestReason !== '')
                ? state.local.requestReason
                : (isEditingDraft ? state.editingRequest.reason || '' : '');

            sidebarEl.innerHTML = `
                <div class="flex items-end justify-between mb-3 border-b pb-2">
                    <div class="flex items-center gap-3 flex-wrap">
                        <h2 class="text-lg font-bold">檢視清單</h2>
                        <div class="flex items-center text-sm">
                            <span class="mr-2 text-gray-700">訂單類別</span>
                            <label class="inline-flex items-center mr-4">
                                <input type="radio" name="order-type" value="特採" data-action="update-order-type" class="h-4 w-4 text-pink-600" ${orderType === '特採' ? 'checked' : ''}>
                                <span class="ml-2">特採</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="order-type" value="專案" data-action="update-order-type" class="h-4 w-4 text-teal-600" ${orderType === '專案' ? 'checked' : ''}>
                                <span class="ml-2">專案</span>
                            </label>
                        </div>
                    </div>
                    <span class="text-sm text-gray-600">您所訂購物品有 <b class="text-base text-indigo-600">${itemCount}</b> 項共 <b class="text-base text-emerald-600">${totalQuantity}</b> 個</span>
                </div>
                <div class="mb-4 p-2 bg-gray-100 rounded-md">
                    <div class="flex items-start gap-4">
                        <div class="w-56 shrink-0">
                            <div class="text-sm font-medium text-gray-700">申請人</div>
                            <div class="text-base font-semibold text-gray-900">${state.currentUser.name} (${state.currentUser.department})</div>
                        </div>
                        <div class="flex-1">
                            <label for="request-reason" class="block text-sm font-medium text-gray-700">總說明 (選填)</label>
                            <input type="text" id="request-reason" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" placeholder="可填寫此張申請單的整體目的..." value="${requestReasonValue}">
                        </div>
                    </div>
                </div>
                <div class="mb-4 p-2 bg-gray-50 rounded-md border">
                    <div class="flex items-start gap-4">
                        <div class="w-56 shrink-0">
                            <div class="text-sm font-medium text-gray-700">附件</div>
                            <div class="text-xs text-gray-500">支援多檔上傳（每個檔案上限1MB)</div>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="request-attachment-input" class="hidden" multiple>
                            <div class="flex items-center gap-2">
                                <label for="request-attachment-input" class="cursor-pointer px-3 py-1.5 text-sm bg-gray-200 rounded-md hover:bg-gray-300">選擇附件</label>
                                <button type="button" data-action="upload-attachments" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50" disabled>上傳附件</button>
                                <span id="request-attachment-filename" class="text-xs text-gray-500">未選擇檔案</span>
                            </div>
                            <ul class="mt-3 space-y-2" id="request-attachments-list">
                                ${(state.local.newRequestAttachments || []).map((f, idx) => {
                                    const ts = f.uploaded_at ? formatAttachmentDate(f.uploaded_at) : '';
                                    const sizeText = typeof f.size === 'number' ? `${f.size.toLocaleString()} bytes` : '';
                                    const info = [sizeText, ts].filter(Boolean).join('，');
                                    return `
                                    <li class="flex items-center justify-between p-2 bg-white border rounded">
                                        <div class="min-w-0">
                                            <div class="text-sm font-medium text-gray-700 truncate" title="${f.name}">${f.name}</div>
                                            <div class="text-xs text-gray-500">${info}</div>
                                        </div>
                                        <button data-action="remove-attachment" data-index="${idx}" class="ml-3 text-red-600 hover:text-red-700 text-sm">移除</button>
                                    </li>`;
                                }).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="border-t pt-4 mb-4">
                    <div class="flex justify-between items-center font-bold text-lg">
                        <span>總金額</span>
                        <span class="cart-total">$${totalAmount.toLocaleString()}</span>
                    </div>
                    <div class="flex space-x-2 mt-4">
                   ${isEditingDraft && state.editingRequest.status === '待送出' ? `
                        <button data-id="${state.editingRequest.id}" data-action="delete-draft" class="w-full px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">刪除草稿</button>
                    ` : ''}
                    <button data-action="save-request" class="w-full px-4 py-2 rounded-md font-semibold text-sm bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50" ${cart.length === 0 ? 'disabled' : ''}>${isEditingDraft ? '更新草稿' : '儲存草稿'}</button>
                    <button data-action="submit-request" class="w-full px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50" ${cart.length === 0 ? 'disabled' : ''}>送出申請</button>
                </div>
                </div>
                <div class="cart-items max-h-[calc(100vh-34rem)] overflow-y-auto border-t pt-2">${cartItemsHTML()}</div>
                `;
        };
        
        window.renderDetailView = function() {
            const viewEl = document.getElementById('detailView-view');
            const request = state.selectedRequest;
            if (!request) {
                viewEl.innerHTML = `<p>找不到申請單</p>`;
                viewEl.style.display = 'block';
                return;
            }

            const getApproverStatusUI = (approver) => {
                let statusHTML = '';
                const approverUser = state.users[approver.userId];
                const approverInfo = approverUser ? `(${approverUser.email} ${approverUser.name})` : `(${approver.userId.substring(0,8)})`;
                
                // 檢查是否為修改當下的簽核列：從 modification_history 中找此用戶的編輯操作紀錄
                let modificationMark = '';
                if (request.modification_history && request.modification_history.length > 0) {
                    // 使用 user 欄位（姓名）或 userId 欄位來比對，只檢查編輯相關操作
                    const userToMatch = approverUser ? approverUser.name : approver.userId;
                    const hasEditModification = request.modification_history.some(h => 
                        ((h.userId === approver.userId) || (h.user === userToMatch)) && 
                        (h.action === 'handled_edit' || (h.changes && h.changes.length > 0))
                    );
                    
                    if (hasEditModification) {
                        modificationMark = ' <span class="text-orange-600 font-bold">有修改過</span>';
                    }
                }

                if (approver.status === 'approved') statusHTML = `<span class="text-green-600">✔️ 已核准 (${getFormattedDateTime(approver.date)}) by ${approver.role} ${approverInfo}</span>${modificationMark}`;
                else if (approver.status === 'rejected') statusHTML = `<span class="text-red-600">❌ 已退回 (${getFormattedDateTime(approver.date)}) by ${approver.role} ${approverInfo}</span>${modificationMark}`;
                else statusHTML = `<span class="text-gray-500">… 待簽核 by ${approver.role} ${approverInfo}</span>`;
                
                if(approver.comment) statusHTML += `<p class="text-xs text-gray-500 pl-4">意見: ${approver.comment}</p>`;
                if(approver.reason) statusHTML += `<p class="text-xs text-red-500 pl-4">退回原因: ${approver.reason}</p>`;
                return statusHTML;
            };
            
            const nextApprover = (request.approvers || []).find(a => a.status === 'pending');
            const canApprove = state.currentUser && nextApprover && state.currentUser.id === nextApprover.userId;
            const isPurchaser = state.currentUser.role.includes('採購');
            const isPurchaserEditing = canApprove && isPurchaser;
            const effectiveHandlerStatus = request.handler_status || (request.status === '已核准' ? '待經辦' : '未經辦');
            const isHandlerEditing = effectiveHandlerStatus === '待經辦' && (state.currentUser.id === request.handler_id || state.currentUser.role === '採購' || state.currentUser.role === '採購主管' || state.currentUser.is_admin);

            const itemsHTML = (request.items || []).map((item, index) => {
                const subtotal = (item.price || 0) * (item.quantity || 0) + (item.freight || 0) + (item.discount || 0);
                const workOrderNumber = item.is_scrap_work_order && item.work_order_number ? item.work_order_number : '';
                
                const product = state.allProducts.find(p => p.id === item.id);
                const imageUrl = product?.image 
                    ? `https://drive.google.com/thumbnail?id=${product.image}` 
                    : 'https://placehold.co/64x64?text=無圖片';
                const vendorName = state.vendors.find(v => v.vendor_id === item.vendor)?.short_name || item.vendor || '';

                if (isPurchaserEditing || isHandlerEditing) {
                    return `
                        <tr class="border-b item-row">
                            <td class="px-4 py-2 align-top"><img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64?text=錯誤';"/></td>
                            <td class="px-4 py-2 align-top">${item.id || ''}</td>
                            <td class="px-4 py-2 align-top">
                                ${item.name}
                                <div class="text-xs text-gray-500 mt-2 space-y-1">
                                    <div>
                                        <label class="text-gray-600 mr-2">原因</label>
                                        <select name="reason_${index}" class="p-1 border rounded">
                                            ${['新增','修繕','報廢','其他'].map(r => `<option value="${r}" ${item.reason === r ? 'selected' : ''}>${r}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label class="text-gray-600">說明</label>
                                        <input type="text" name="description_${index}" class="p-1 border rounded w-64" value="${item.description || ''}" placeholder="輸入說明...">
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <select name="demand_department_${index}" class="w-full p-1 border rounded">
                                    <option value="">-- 請選擇 --</option>
                                    ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}" ${(item.demand_department || '') === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <div class="flex items-center gap-2">
                                    <select name="invoice_${index}" class="p-1 border rounded ${item.invoice === '其他' ? 'w-1/3' : 'w-full'}">
                                        <option value="">-- 請選擇 --</option>
                                        ${[
                                            "8C清福", "7C清氣", "6C清心", "5C清平", "3C清安", "2CD清護",
                                            "8D清春", "7D清日", "6D清照", "5D清風", "3D清景", "8E清山",
                                            "7E清泉", "6E清水", "8E清清", "3E清涼", "清福法人", "一館",
                                            "二館", "三館", "含笑", "清福幼兒園", "其他"
                                        ].map(opt => `<option value="${opt}" ${item.invoice === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                    <input type="text" name="custom_invoice_${index}" class="p-1 border rounded ${item.invoice === '其他' ? 'block w-2/3' : 'hidden'}" value="${item.custom_invoice || ''}" placeholder="請輸入發票開立...">
                                </div>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <select name="vendor_${index}" class="w-full p-1 border rounded">
                                    <option value="">-- 請選擇廠商 --</option>
                                    ${state.vendors.map(v => `<option value="${v.vendor_id}" ${item.vendor === v.vendor_id ? 'selected' : ''}>${v.short_name || v.name}</option>`).join('')}
                                </select>
                            </td>
                            <td class="px-4 py-2 text-right align-top"><input name="price_${index}" type="number" data-index="${index}" class="item-input w-24 p-1 border rounded text-right" value="${item.price || 0}"></td>
                            <td class="px-4 py-2 text-right align-top">
                                <input name="quantity_${index}" type="number" data-index="${index}" class="item-input w-16 p-1 border rounded text-right" value="${item.quantity || 0}">
                                <input name="unit_${index}" class="w-12 p-1 border rounded text-right" value="${item.unit || ''}">
                            </td>
                            <td class="px-4 py-2 text-right align-top"><input name="freight_${index}" type="number" data-index="${index}" class="item-input w-20 p-1 border rounded text-right" value="${item.freight || 0}"></td>
                            <td class="px-4 py-2 text-right align-top"><input name="discount_${index}" type="number" data-index="${index}" class="item-input w-20 p-1 border rounded text-right" value="${item.discount || 0}"></td>
                            <td class="px-4 py-2 text-right align-top subtotal-cell" data-index="${index}">$${subtotal.toLocaleString()}</td>
                            <td class="px-4 py-2 align-top">
                                <input type="checkbox" name="scrap_${index}" class="block mx-auto" ${item.reason === '報廢' ? '' : 'disabled'} ${item.is_scrap_work_order ? 'checked' : ''}>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <input name="asset_number_${index}" class="p-1 border rounded w-24 ${item.is_scrap_work_order ? '' : 'opacity-50'}" ${item.is_scrap_work_order ? '' : 'disabled'} value="${workOrderNumber}" placeholder="請輸入財產編號">
                            </td>
                        </tr>`;
                }
                return `
                    <tr class="border-b">
                        <td class="px-4 py-2 align-top"><img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64?text=錯誤';"/></td>
                        <td class="px-4 py-2 align-top">${item.id || ''}</td>
                        <td class="px-4 py-2 align-top">
                            ${item.name}
                            <div class="text-xs text-gray-500 mt-1">
                                <p><b>原因:</b> ${item.reason || 'N/A'}</p>
                                <p><b>說明:</b> ${item.description || 'N/A'}</p>
                            </div>
                        </td>
                        <td class="px-4 py-2 align-top">${item.demand_department || ''}</td>
                        <td class="px-4 py-2 align-top">${item.invoice === '其他' ? (item.custom_invoice || '') : (item.invoice || '')}</td>
                        <td class="px-4 py-2 align-top">${vendorName}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.price || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">${item.quantity} ${item.unit}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.freight || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.discount || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">$${subtotal.toLocaleString()}</td>
                        <td class="px-4 py-2 text-center align-top">${item.is_scrap_work_order ? '✔️' : ''}</td>
                        <td class="px-4 py-2 align-top">${workOrderNumber}</td>
                    </tr>`;
            }).join('');
            
            const modificationHistoryHTML = (() => {
                const fieldNameMap = { reason: '原因', description: '說明', demand_department: '需求課室', invoice: '發票開立', custom_invoice: '自訂發票', vendor: '廠商', price: '單價', quantity: '數量', unit: '單位', freight: '運費', discount: '折扣', is_scrap_work_order: '報廢', work_order_number: '財產編號' };
                const hist = [...(request.modification_history || [])].reverse();
                return hist.map((entry, i) => {
                    const changes = Array.isArray(entry.changes) ? entry.changes : [];
                    const changesHTML = changes.length ? `
                        <div class="mt-1 space-y-2">
                            ${changes.map(c => `
                                <div class="border rounded p-2 bg-gray-50">
                                    <div class="text-xs text-gray-500">品項：${c.name || c.item_id || ''}</div>
                                    <ul class="mt-1 text-xs list-disc list-inside">
                                        ${(c.changes || []).map(ch => `<li><span class="text-gray-600">${fieldNameMap[ch.field] || ch.field}：</span><span class="line-through text-gray-400">${ch.from === '' ? '（空）' : ch.from}</span> → <span class="text-gray-800">${ch.to === '' ? '（空）' : ch.to}</span></li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>` : '<div class="text-xs text-gray-500">無欄位變更明細</div>';
                    return `
                        <div class="text-xs text-gray-600 border-t pt-2 mt-2">
                            <div class="font-semibold">#${i + 1} 修改人: ${entry.user} (${entry.role}) 於 ${getFormattedDateTime(entry.date)}</div>
                            <div><strong>修改原因:</strong> ${entry.reason || '（未填）'}</div>
                            ${changesHTML}
                        </div>
                    `;
                }).join('');
            })();

            const readonlyBadge = (isPurchaserEditing || isHandlerEditing)
                ? `<span class="ml-2 inline-block align-middle text-[10px] px-2 py-0.5 rounded border border-gray-300 text-gray-600 bg-gray-50">唯讀</span>`
                : '';

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-bold text-gray-700">申請單詳情: ${request.id} ${Array.isArray(request.attachments) && request.attachments.length ? '📎' : ''}</h1>
                        <button data-action="view-mod-history" class="px-4 py-2 rounded-md text-sm font-bold ${(() => {
                            // 檢查是否有編輯相關的修改歷程
                            const hasEditHistory = request.modification_history && request.modification_history.some(h => 
                                h.action === 'handled_edit' || (h.changes && h.changes.length > 0)
                            );
                            return hasEditHistory ? 'bg-orange-600 hover:bg-orange-700 text-white border-2 border-orange-800' : 'bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300';
                        })()}">
                            ${(() => {
                                const hasEditHistory = request.modification_history && request.modification_history.some(h => 
                                    h.action === 'handled_edit' || (h.changes && h.changes.length > 0)
                                );
                                return hasEditHistory ? '⚠️ 修改歷程' : '修改歷程';
                            })()}
                        </button>
                    </div>
                    <div class="flex space-x-2">
                        <button data-action="print-request" data-request-id="${request.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                            </svg>
                            列印
                        </button>
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div><span class="font-bold text-gray-600">申請單號:</span> ${request.id} ${Array.isArray(request.attachments) && request.attachments.length ? '📎' : ''}</div>
                        <div><span class="font-bold text-gray-600">申請日期:</span> ${getFormattedDateTime(request.request_date)}</div>
                        <div><span class="font-bold text-gray-600">訂單類別:</span> <span class="px-3 py-1 rounded-full text-xs font-medium ${(request.type || '特採') === '特採' ? 'bg-pink-100 text-pink-800' : 'bg-teal-100 text-teal-800'}">${request.type || '特採'}</span></div>
                        <div>
                            <span class="font-bold text-gray-600">簽核狀態:</span>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${{'待審核': 'bg-yellow-100 text-yellow-800', '已核准': 'bg-green-100 text-green-800', '已退回': 'bg-red-100 text-red-800'}[request.status] || 'bg-gray-100 text-gray-800'}">${request.status}</span>
                            ${(() => {
                                const lastApproved = (request.approvers || []).filter(a => a.status === 'approved').slice(-1)[0];
                                if (!lastApproved) return '';
                                const n = state.users[lastApproved.userId]?.name || (lastApproved.userId ? lastApproved.userId.substring(0,8) : '');
                                return `<span class="text-xs text-gray-500 ml-2">最新簽核：${getFormattedDateTime(lastApproved.date)} by ${n}</span>`;
                            })()}
                        </div>
                        <div>
                            <span class="font-bold text-gray-600">經辦狀態:</span>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${{'未經辦': 'bg-neutral-100 text-neutral-800','待經辦': 'bg-amber-100 text-amber-800','已經辦': 'bg-green-100 text-green-800'}[request.handler_status || (request.status === '已核准' ? '待經辦' : '未經辦')]}"">${request.handler_status || (request.status === '已核准' ? '待經辦' : '未經辦')}</span>
                            ${(() => {
                                // 以 approvers 中含「採購」且已approved者作為經辦完成資訊來源；或 modification_history 中 action==='handled'
                                const handledFromApprover = (request.approvers || []).filter(a => (a.role || '').includes('採購') && a.status === 'approved').slice(-1)[0];
                                const hist = (request.modification_history || []).filter(h => h.action === 'handled').slice(-1)[0];
                                const stamp = hist?.date || handledFromApprover?.date;
                                const whoId = handledFromApprover?.userId;
                                const who = hist?.user || (whoId ? (state.users[whoId]?.name || whoId.substring(0,8)) : '');
                                if (!stamp || !who) return '';
                                return `<span class=\"text-xs text-gray-500 ml-2\">最新經辦：${getFormattedDateTime(stamp)} by ${who}</span>`;
                            })()}
                        </div>
                        <div><span class="font-bold text-gray-600">申請人:</span> ${state.users[request.applicant_id]?.name || '未知'}</div>
                        <div><span class="font-bold text-gray-600">申請部門:</span> ${request.department}</div>
                        <div>
                            <span class="font-bold text-gray-600">結案狀態:</span>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${request.closed_status === '結案' ? 'bg-gray-300 text-gray-800' : 'bg-blue-100 text-blue-800'}">${request.closed_status || '未結案'}</span>
                            ${(() => {
                                const hist = (request.modification_history || []).filter(h => h.action === 'closed').slice(-1)[0];
                                if (!hist) return '';
                                return `<span class=\"text-xs text-gray-500 ml-2\">最新結案：${getFormattedDateTime(hist.date)} by ${hist.user}</span>`;
                            })()}
                        </div>
                        <div class="md:col-span-3"><span class="font-bold text-gray-600">總說明:</span> <span class="text-gray-800 whitespace-pre-wrap">${request.reason || '無'}</span></div>
                        <div class="md:col-span-3">
                            <span class="font-bold text-gray-600">附件:</span>
                            ${(() => {
                                const atts = request.attachments || [];
                                if (!atts.length) return '<span class="text-gray-500 ml-2">無</span>';
                                return `<ul class=\"mt-2 space-y-2\">${atts.map(a => {
                                    const ts = a.uploaded_at ? formatAttachmentDate(a.uploaded_at) : '';
                                    const sizeText = typeof a.size === 'number' ? `${(a.size||0).toLocaleString()} bytes` : '';
                                    const info = [sizeText, ts].filter(Boolean).join('，');
                                    return `
                                    <li class=\"flex items-center justify-between p-2 bg-gray-50 border rounded\">
                                        <div class=\"min-w-0\"> 
                                            <div class=\"text-sm font-medium text-gray-700 truncate\" title=\"${a.name}\">${a.name}</div>
                                            <div class=\"text-xs text-gray-500\">${info}</div>
                                        </div>
                                        <div class=\"flex items-center gap-2\"> 
                                            <button data-action=\"download-attachment\" data-file-id=\"${a.id}\" class=\"px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700\">下載</button>
                                        </div>
                                    </li>`;
                                }).join('')}</ul>`;
                            })()}
                        </div>
                    </div>
                    <h3 class="text-lg font-bold border-b pb-2 mb-4">申請項目</h3>
                    <form id="edit-request-form">
                        <div class="overflow-x-auto mb-6">
                            <table class="min-w-full">
                                <thead class="bg-gray-100"><tr>
                                    <th class="px-4 py-2 text-left">圖片</th>
                                    <th class="px-4 py-2 text-left">商品編號</th>
                                    <th class="px-4 py-2 text-left">品名/說明 ${readonlyBadge}</th>
                                    <th class="px-4 py-2 text-left">需求課室</th>
                                    <th class="px-4 py-2 text-left">發票開立</th>
                                    <th class="px-4 py-2 text-left">廠商</th>
                                    <th class="px-4 py-2 text-right">單價</th>
                                    <th class="px-4 py-2 text-right">數量</th>
                                    <th class="px-4 py-2 text-right">運費</th>
                                    <th class="px-4 py-2 text-right">折扣</th>
                                    <th class="px-4 py-2 text-right">小計</th>
                                    <th class="px-4 py-2 text-center">報廢</th>
                                    <th class="px-4 py-2 text-left">財產編號</th>
                                </tr></thead>
                                <tbody>${itemsHTML}</tbody>
                                <tfoot><tr class="font-bold"><td colspan="10" class="px-4 py-2 text-right">總金額:</td><td id="grand-total" class="px-4 py-2 text-right">$${Number(request.total_amount).toLocaleString()}</td><td colspan="2"></td></tr></tfoot>
                            </table>
                        </div>
                    </form>
                    
                                        <h3 class="text-lg font-bold border-b pb-2 mb-2">簽核流程</h3>
                                        <div class="space-y-4 mb-6">
                                                ${(() => {
                                                        const list = request.approvers || [];
                                                        const stage1 = list.filter(a => ['申請人直屬主管','申請人第二主管','申請人第三主管'].includes(a.role));
                                                        const stage2 = list.filter(a => a.role === '院長');
                                                        // 第三階段顯示：採購本人 + 採購的主管鏈（直屬/第二/第三主管）
                                                        const stage3 = list.filter(a => ['採購','採購直屬主管','採購第二主管','採購第三主管'].includes(a.role));
                                                        const section = (title, arr) => arr.length ? `
                                                            <div class="mt-2">
                                                                <div class="text-sm text-gray-600 font-semibold mb-1">${title}</div>
                                                                ${arr.map(approver => `<div class=\"flex items-start\"><div class=\"font-bold w-48 flex-shrink-0\">${approver.role}:</div><div>${getApproverStatusUI(approver)}</div></div>`).join('')}
                                                            </div>` : '';
                                                        // 第二階段顯示邏輯：未達門檻仍顯示階段並提示免簽
                                                        const departmentThreshold = (state.departments && state.departments[request.department]) ?? Infinity;
                                                        const needsDirector = (request.total_amount || 0) > departmentThreshold;
                                                        const stage2HTML = needsDirector
                                                            ? section('第二階段-院長簽核', stage2)
                                                            : `
                                                                <div class="mt-2">
                                                                    <div class="text-sm text-gray-600 font-semibold mb-1">第二階段-院長簽核</div>
                                                                    <div class="text-sm text-gray-500">未達院長簽核金額不需簽核</div>
                                                                </div>`;
                                                        const stage4 = (() => {
                                                            const effective = request.handler_status || (request.status === '已核准' ? '待經辦' : '未經辦');
                                                            const closed = request.closed_status || '未結案';
                                                            
                                                            // 建立類似第一階段的顯示格式
                                                            const handlerUser = state.users[request.handler_id];
                                                            const handlerInfo = handlerUser ? `(${handlerUser.email} ${handlerUser.name})` : `(${request.handler_id || '未指派'})`;
                                                            
                                                            // 經辦狀態顯示 - 加入日期時間和人員資訊
                                                            let handlerStatusHTML = '';
                                                            if (effective === '已經辦') {
                                                                // 查找經辦日期和人員
                                                                const handledFromApprover = (request.approvers || []).filter(a => (a.role || '').includes('採購') && a.status === 'approved').slice(-1)[0];
                                                                const hist = (request.modification_history || []).filter(h => h.action === 'handled').slice(-1)[0];
                                                                const handlerDate = hist?.date || handledFromApprover?.date;
                                                                const handlerUserId = hist?.userId || handledFromApprover?.userId;
                                                                
                                                                if (handlerDate) {
                                                                    const handlerUserInfo = handlerUserId ? state.users[handlerUserId] : null;
                                                                    if (handlerUserInfo) {
                                                                        handlerStatusHTML = `<span class="text-green-600">✔️ 已經辦 (${getFormattedDateTime(handlerDate)}) by 經辦者 (${handlerUserInfo.email} ${handlerUserInfo.name})</span>`;
                                                                    } else if (hist?.user) {
                                                                        // 如果沒有 userId，嘗試用姓名匹配
                                                                        const userByName = Object.values(state.users).find(u => u.name === hist.user);
                                                                        if (userByName) {
                                                                            handlerStatusHTML = `<span class="text-green-600">✔️ 已經辦 (${getFormattedDateTime(handlerDate)}) by 經辦者 (${userByName.email} ${userByName.name})</span>`;
                                                                        } else {
                                                                            handlerStatusHTML = `<span class="text-green-600">✔️ 已經辦 (${getFormattedDateTime(handlerDate)}) by ${hist.user}</span>`;
                                                                        }
                                                                    } else {
                                                                        handlerStatusHTML = `<span class="text-green-600">✔️ 已經辦 (${getFormattedDateTime(handlerDate)}) ${handlerInfo}</span>`;
                                                                    }
                                                                } else {
                                                                    handlerStatusHTML = `<span class="text-green-600">✔️ 已經辦 ${handlerInfo}</span>`;
                                                                }
                                                            } else if (effective === '待經辦') {
                                                                handlerStatusHTML = `<span class="text-gray-500">… 待經辦 ${handlerInfo}</span>`;
                                                            } else {
                                                                // 如果沒有指派經辦（handler_id 為空或為未指派），顯示 "… 未經辦"，不顯示括號的未指派字樣
                                                                if (!request.handler_id) {
                                                                    handlerStatusHTML = `<span class="text-gray-500">… 未經辦</span>`;
                                                                } else {
                                                                    handlerStatusHTML = `<span class="text-gray-400">未經辦 ${handlerInfo}</span>`;
                                                                }
                                                            }
                                                            
                                                            // 結案狀態顯示 - 加入日期時間和人員資訊
                                                            let closeStatusHTML = '';
                                                            if (closed === '結案') {
                                                                // 查找結案日期和人員
                                                                const closeHist = (request.modification_history || []).filter(h => h.action === 'closed').slice(-1)[0];
                                                                
                                                                if (closeHist && closeHist.date) {
                                                                    // 使用新的 userId 欄位或舊的 user 欄位
                                                                    const closeUserInfo = closeHist.userId ? state.users[closeHist.userId] : null;
                                                                    if (closeUserInfo) {
                                                                        closeStatusHTML = `<span class="text-green-600">✔️ 已結案 (${getFormattedDateTime(closeHist.date)}) by 結案者 (${closeUserInfo.email} ${closeUserInfo.name})</span>`;
                                                                    } else if (closeHist.user) {
                                                                        // 如果沒有 userId，嘗試用姓名匹配
                                                                        const userByName = Object.values(state.users).find(u => u.name === closeHist.user);
                                                                        if (userByName) {
                                                                            closeStatusHTML = `<span class="text-green-600">✔️ 已結案 (${getFormattedDateTime(closeHist.date)}) by 結案者 (${userByName.email} ${userByName.name})</span>`;
                                                                        } else {
                                                                            closeStatusHTML = `<span class="text-green-600">✔️ 已結案 (${getFormattedDateTime(closeHist.date)}) by ${closeHist.user}</span>`;
                                                                        }
                                                                    } else {
                                                                        closeStatusHTML = `<span class="text-green-600">✔️ 已結案 (${getFormattedDateTime(closeHist.date)})</span>`;
                                                                    }
                                                                } else {
                                                                    closeStatusHTML = `<span class="text-green-600">✔️ 已結案</span>`;
                                                                }
                                                            } else {
                                                                closeStatusHTML = `<span class="text-gray-500">… 未結案</span>`;
                                                            }
                                                            
                                                            return `
                                                                <div class="mt-2">
                                                                    <div class="text-sm text-gray-600 font-semibold mb-1">第四階段-經辦結案階段</div>
                                                                    <div class="flex items-start"><div class="font-bold w-48 flex-shrink-0">經辦:</div><div>${handlerStatusHTML}</div></div>
                                                                    <div class="flex items-start"><div class="font-bold w-48 flex-shrink-0">結案:</div><div>${closeStatusHTML}</div></div>
                                                                </div>`;
                                                        })();
                                                        return [
                                                            section('第一階段-請購階段簽核', stage1),
                                                            stage2HTML,
                                                            section('第三階段-採購階段簽核', stage3),
                                                            stage4
                                                        ].join('');
                                                })()}
                                        </div>
                    <div class="border-t pt-6 flex justify-end space-x-4">
                        ${ (isPurchaser && request.status === '已核准' && (request.handler_status || '未經辦') === '已經辦') ? `
                            <button data-action="close-request" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-700 text-white hover:bg-green-800">
                                ${request.closed_status === '結案' ? '已結案' : '將此單結案'}
                            </button>
                        ` : (isPurchaser && request.status === '已核准' && request.closed_status === '結案' ? `
                            <button class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-400 text-white cursor-not-allowed" disabled>已結案</button>
                        ` : '')}
                        ${ isHandlerEditing ? `
                            <div class="flex-grow flex justify-end space-x-4">
                                <div class="flex-grow">
                                    <label for="handler-modification-reason" class="block text-sm font-medium text-gray-700">經辦修改原因</label>
                                    <textarea id="handler-modification-reason" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                                </div>
                                <div class="flex-grow">
                                    <label for="handler-comment" class="block text-sm font-medium text-gray-700">經辦意見 (選填)</label>
                                    <textarea id="handler-comment" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="可填寫補充說明，將一併紀錄於歷程"></textarea>
                                </div>
                                <div class="flex items-end space-x-4">
                                    <button data-action="handler-save-changes" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">儲存修改並經辦</button>
                                    <button data-action="handler-reject-options" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">退單</button>
                                    <button data-action="mark-handled" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">經辦</button>
                                </div>
                            </div>
                        ` : ''}
                        ${ canApprove ? `
                        <div class="flex-grow flex justify-end space-x-4">
                            ${isPurchaserEditing ? `
                            <div class="flex-grow">
                                <label for="modification-reason" class="block text-sm font-medium text-gray-700">修改原因</label>
                                <textarea id="modification-reason" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                            </div>` : ''}
                            <div class="flex-grow">
                                <label for="approval-comment" class="block text-sm font-medium text-gray-700">簽核意見 (選填)</label>
                                <textarea id="approval-comment" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                            </div>
                            <div class="flex items-end space-x-4">
                                ${isPurchaserEditing ? '<button data-action="save-changes" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">儲存修改並核准</button>' : ''}
                                <button data-action="reject" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">退回</button>
                                <button data-action="approve" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">核准</button>
                            </div>
                        </div>` : ''}
                    </div>
                </div>`;
             viewEl.style.display = 'block';
        };
        
        window.renderProductManagement = function() {
            const viewEl = document.getElementById('productManagement-view');
            const categories = ['全品項', ...Object.keys(state.products)];
            const activeCategory = state.local.activeProductManagementCategory || '全品項';
            
            const filteredProducts = getFilteredProducts();

            const renderSortIcon = (key) => {
                if (state.local.productSortKey !== key) return `<span class="sort-icon">▲▼</span>`;
                return state.local.productSortDirection === 'asc' ? `<span class="sort-icon">▲</span>` : `<span class="sort-icon">▼</span>`;
            };

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">商品管理</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                        <button data-action="add-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">新增產品</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-4 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                            ${categories.map(cat => `<button data-category="${cat}" data-action="switch-product-category" class="product-category-btn ${cat === activeCategory ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">${cat}</button>`).join('')}
                        </nav>
                    </div>
                     <div class="mb-4 flex items-center gap-4">
                        <input type="text" id="product-search-input" placeholder="搜尋商品..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm" value="${state.local.productManagementSearchTerm || ''}">
                        <button data-action="search-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">搜尋</button>
                        <label class="flex items-center text-sm whitespace-nowrap">
                            <input type="checkbox" id="product-management-search-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${state.local.productManagementSearchAll ? 'checked' : ''}>
                            <span class="ml-2 text-gray-700">搜尋全分類</span>
                        </label>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'id' ? 'active' : ''}" data-action="sort-product" data-sort-key="id">商品編號 ${renderSortIcon('id')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'name' ? 'active' : ''}" data-action="sort-product" data-sort-key="name">品名 ${renderSortIcon('name')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'vendor' ? 'active' : ''}" data-action="sort-product" data-sort-key="vendor">廠商 ${renderSortIcon('vendor')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'spec' ? 'active' : ''}" data-action="sort-product" data-sort-key="spec">規格 ${renderSortIcon('spec')}</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'price' ? 'active' : ''}" data-action="sort-product" data-sort-key="price">單價 ${renderSortIcon('price')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">訂購系統</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">功能</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredProducts.map(p => {
                                    const spec = p.spec || '';
                                    const displaySpec = spec.length > 10 ? spec.substring(0, 10) + '...' : spec;
                                    const vendorName = state.vendors.find(v => v.vendor_id === p.vendor)?.short_name || p.vendor || '';
                                    return `
                                    <tr key="${p.id}">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.id}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${vendorName}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span title="${spec}">${displaySpec}</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">$${Number(p.price || 0).toLocaleString()}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.ordering_system || '特採'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-id="${p.id}" data-action="edit-product" class="text-blue-600 hover:text-blue-900">編輯</button>
                                            <button data-id="${p.id}" data-name="${p.name}" data-action="delete-product" class="text-red-600 hover:text-red-900 ml-4">刪除</button>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            viewEl.style.display = 'block';
        };

        // 列印相關函數
        window.printRequest = function(requestId) {
            const request = state.requests.find(r => r.id === requestId);
            if (!request) {
                showMessage('找不到對應的申請單。', 'error');
                return;
            }

            const getApproverStatusUI = (approver) => {
                const approverUser = state.users[approver.userId];
                const approverInfo = approverUser ? `${approverUser.name}` : `${approver.userId.substring(0,8)}`;
                
                // 檢查是否為修改當下的簽核列（列印版本）
                let modificationMark = '';
                if (request.modification_history && request.modification_history.length > 0) {
                    const userToMatch = approverUser ? approverUser.name : approver.userId;
                    const hasEditModification = request.modification_history.some(h => 
                        ((h.userId === approver.userId) || (h.user === userToMatch)) && 
                        (h.action === 'handled_edit' || (h.changes && h.changes.length > 0))
                    );
                    
                    if (hasEditModification) {
                        modificationMark = ' (有修改過)';
                    }
                }
                
                if (approver.status === 'approved') return `✔️ 已核准 (${getFormattedDateTime(approver.date)}) by ${approverInfo}${modificationMark}`;
                else if (approver.status === 'rejected') return `❌ 已退回 (${getFormattedDateTime(approver.date)}) by ${approverInfo}${modificationMark}`;
                else return `⏳ 待簽核 by ${approverInfo}`;
            };

            const itemsHTML = (request.items || []).map(item => {
                const subtotal = (item.price || 0) * (item.quantity || 0) + (item.freight || 0) + (item.discount || 0);
                const vendorName = state.vendors.find(v => v.vendor_id === item.vendor)?.short_name || item.vendor || '';
                const product = state.allProducts?.find(p => p.id === item.id);
                const imageUrl = product?.image ? `https://drive.google.com/thumbnail?id=${product.image}` : 'https://placehold.co/48x48?text=無';
                const invoiceDisplay = item.invoice === '其他' ? (item.custom_invoice || '') : (item.invoice || '');
                return `
                    <tr style="border-bottom: 1px solid #e5e5e5;">
                        <td style="padding: 8px; border: 1px solid #ddd; width: 56px; text-align:center;">
                            <img src="${imageUrl}" alt="${item.name}" style="width:48px; height:48px; object-fit:cover; border-radius:4px;" onerror="this.onerror=null;this.src='https://placehold.co/48x48?text=無';" />
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.id || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            ${item.name}
                            <div style="font-size: 10px; color: #666; margin-top: 4px;">
                                <div><strong>原因:</strong> ${item.reason || 'N/A'}</div>
                                <div><strong>說明:</strong> ${item.description || 'N/A'}</div>
                            </div>
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.demand_department || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${invoiceDisplay}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${vendorName}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.price || 0).toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${item.quantity} ${item.unit}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.freight || 0).toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.discount || 0).toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${subtotal.toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.is_scrap_work_order ? '✔️' : ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.work_order_number || ''}</td>
                    </tr>`;
            }).join('');

            const handlerStatus = request.handler_status || (request.status === '已核准' ? '待經辦' : '未經辦');
            const lastHandled = (() => {
                const fromApprover = (request.approvers || []).filter(a => (a.role||'').includes('採購') && a.status === 'approved').slice(-1)[0];
                const hist = (request.modification_history || []).filter(h => h.action === 'handled').slice(-1)[0];
                const stamp = hist?.date || fromApprover?.date;
                const who = hist?.user || (fromApprover?.userId ? (state.users[fromApprover.userId]?.name || fromApprover.userId.substring(0,8)) : '');
                return stamp && who ? `${getFormattedDateTime(stamp)} by ${who}` : '';
            })();
            const lastClosed = (() => {
                const hist = (request.modification_history || []).filter(h => h.action === 'closed').slice(-1)[0];
                return hist ? `${getFormattedDateTime(hist.date)} by ${hist.user}` : '';
            })();

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>申請單 - ${request.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header h1 { margin: 0; font-size: 20px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
                        .info-item { padding: 5px 0; }
                        .info-label { font-weight: bold; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th { background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        .total-row { font-weight: bold; background-color: #f9f9f9; }
                        .approval-section { margin-top: 20px; }
                        .approval-item { margin-bottom: 10px; display: flex; }
                        .approval-role { font-weight: bold; width: 150px; }
                        .approval-status { flex: 1; }
                        .reason-section { margin-top: 20px; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>採購申請單</h1>
                        <p>申請單號: ${request.id} ${Array.isArray(request.attachments) && request.attachments.length ? '📎' : ''}</p>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">申請人:</div>
                            <div>${state.users[request.applicant_id]?.name || '未知'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">申請日期:</div>
                            <div>${getFormattedDateTime(request.request_date)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">申請部門:</div>
                            <div>${request.department}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">簽核狀態:</div>
                            <div>${request.status}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">經辦狀態:</div>
                            <div>${handlerStatus}${lastHandled ? `（${lastHandled}）` : ''}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">結案狀態:</div>
                            <div>${request.closed_status || '未結案'}${lastClosed ? `（${lastClosed}）` : ''}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">總金額:</div>
                            <div>$${Number(request.total_amount).toLocaleString()}</div>
                        </div>
                        <div class="info-item" style="grid-column: span 3;">
                            <div class="info-label">總說明:</div>
                            <div style="white-space: pre-wrap;">${request.reason || ''}</div>
                        </div>
                    </div>

                    ${request.reason ? `` : ''}

                    <h3>申請項目</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>商品圖片</th>
                                <th>商品編號</th>
                                <th>品名/說明</th>
                                <th>需求課室</th>
                                <th>發票開立</th>
                                <th>廠商</th>
                                <th>單價</th>
                                <th>數量</th>
                                <th>運費</th>
                                <th>折扣</th>
                                <th>小計</th>
                                <th>報廢</th>
                                <th>財產編號</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                            <tr class="total-row">
                                <td colspan="10" style="text-align: right; font-weight: bold;">總金額:</td>
                                <td style="text-align: right; font-weight: bold;">$${Number(request.total_amount).toLocaleString()}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="approval-section">
                        <h3>簽核流程</h3>
                        ${(request.approvers || []).map(approver => {
                            let displayRole = approver.role;
                            if (approver.role === '使用者') {
                                if (approver.step === 1) displayRole = '申請人主管';
                                else if (approver.step === 2) displayRole = '申請人主管的主管';
                                else if (approver.step === 3) displayRole = '第三主管';
                            }
                            return `
                                <div class="approval-item">
                                    <div class="approval-role">${displayRole}:</div>
                                    <div class="approval-status">${getApproverStatusUI(approver)}</div>
                                </div>
                                ${approver.comment ? `<div style="margin-left: 150px; font-size: 10px; color: #666;">意見: ${approver.comment}</div>` : ''}
                                ${approver.reason ? `<div style="margin-left: 150px; font-size: 10px; color: #d32f2f;">退回原因: ${approver.reason}</div>` : ''}
                            `;
                        }).join('')}
                    </div>

                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">列印</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background-color: #757575; color: white; border: none; border-radius: 4px; cursor: pointer;">關閉</button>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
        };

        window.printMultipleRequests = function(requestIds) {
            const requests = requestIds.map(id => state.requests.find(r => r.id === id)).filter(r => r);
            
            if (requests.length === 0) {
                showMessage('找不到要列印的申請單。', 'error');
                return;
            }

            const getApproverStatusUI = (approver, request) => {
                const approverUser = state.users[approver.userId];
                const approverInfo = approverUser ? `${approverUser.name}` : `${approver.userId.substring(0,8)}`;
                
                // 檢查是否為修改當下的簽核列（多單列印版本）
                let modificationMark = '';
                if (request.modification_history && request.modification_history.length > 0) {
                    const userToMatch = approverUser ? approverUser.name : approver.userId;
                    const hasEditModification = request.modification_history.some(h => 
                        ((h.userId === approver.userId) || (h.user === userToMatch)) && 
                        (h.action === 'handled_edit' || (h.changes && h.changes.length > 0))
                    );
                    
                    if (hasEditModification) {
                        modificationMark = ' (有修改過)';
                    }
                }
                
                if (approver.status === 'approved') return `✔️ 已核准 (${getFormattedDateTime(approver.date)}) by ${approverInfo}${modificationMark}`;
                else if (approver.status === 'rejected') return `❌ 已退回 (${getFormattedDateTime(approver.date)}) by ${approverInfo}${modificationMark}`;
                else return `⏳ 待簽核 by ${approverInfo}`;
            };

            // 為每個申請單生成 HTML 內容
            const requestsHTML = requests.map((request, index) => {
                const itemsHTML = (request.items || []).map(item => {
                    const subtotal = (item.price || 0) * (item.quantity || 0) + (item.freight || 0) + (item.discount || 0);
                    const vendorName = state.vendors.find(v => v.vendor_id === item.vendor)?.short_name || item.vendor || '';
                    const product = state.allProducts?.find(p => p.id === item.id);
                    const imageUrl = product?.image ? `https://drive.google.com/thumbnail?id=${product.image}` : 'https://placehold.co/48x48?text=無';
                    const invoiceDisplay = item.invoice === '其他' ? (item.custom_invoice || '') : (item.invoice || '');
                    return `
                        <tr style="border-bottom: 1px solid #e5e5e5;">
                            <td style="padding: 8px; border: 1px solid #ddd; width:56px; text-align:center;">
                                <img src="${imageUrl}" alt="${item.name}" style="width:48px; height:48px; object-fit:cover; border-radius:4px;" onerror="this.onerror=null;this.src='https://placehold.co/48x48?text=無';" />
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${item.id || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">
                                ${item.name}
                                <div style="font-size: 10px; color: #666; margin-top: 4px;">
                                    <div><strong>原因:</strong> ${item.reason || 'N/A'}</div>
                                    <div><strong>說明:</strong> ${item.description || 'N/A'}</div>
                                </div>
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${item.demand_department || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${invoiceDisplay}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${vendorName}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.price || 0).toLocaleString()}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${item.quantity} ${item.unit}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.freight || 0).toLocaleString()}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.discount || 0).toLocaleString()}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${subtotal.toLocaleString()}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.is_scrap_work_order ? '✔️' : ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${item.work_order_number || ''}</td>
                        </tr>`;
                }).join('');

                const handlerStatus = request.handler_status || (request.status === '已核准' ? '待經辦' : '未經辦');
                const lastHandled = (() => {
                    const fromApprover = (request.approvers || []).filter(a => (a.role||'').includes('採購') && a.status === 'approved').slice(-1)[0];
                    const hist = (request.modification_history || []).filter(h => h.action === 'handled').slice(-1)[0];
                    const stamp = hist?.date || fromApprover?.date;
                    const who = hist?.user || (fromApprover?.userId ? (state.users[fromApprover.userId]?.name || fromApprover.userId.substring(0,8)) : '');
                    return stamp && who ? `${getFormattedDateTime(stamp)} by ${who}` : '';
                })();
                const lastClosed = (() => {
                    const hist = (request.modification_history || []).filter(h => h.action === 'closed').slice(-1)[0];
                    return hist ? `${getFormattedDateTime(hist.date)} by ${hist.user}` : '';
                })();

                return `
                    <div class="request-page" style="page-break-after: ${index < requests.length - 1 ? 'always' : 'auto'}; margin-bottom: 40px;">
                        <div class="header" style="text-align: center; margin-bottom: 20px;">
                            <h1 style="margin: 0; font-size: 20px;">採購申請單</h1>
                            <p style="margin: 5px 0;">申請單號: ${request.id} ${Array.isArray(request.attachments) && request.attachments.length ? '📎' : ''}</p>
                        </div>
                        
                        <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">申請人:</div>
                                <div>${state.users[request.applicant_id]?.name || '未知'}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">申請日期:</div>
                                <div>${getFormattedDateTime(request.request_date)}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">申請部門:</div>
                                <div>${request.department}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">簽核狀態:</div>
                                <div>${request.status}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">經辦狀態:</div>
                                <div>${handlerStatus}${lastHandled ? `（${lastHandled}）` : ''}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">結案狀態:</div>
                                <div>${request.closed_status || '未結案'}${lastClosed ? `（${lastClosed}）` : ''}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">總金額:</div>
                                <div>$${Number(request.total_amount).toLocaleString()}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0; grid-column: span 3;">
                                <div class="info-label" style="font-weight: bold;">總說明:</div>
                                <div style="white-space: pre-wrap;">${request.reason || ''}</div>
                            </div>
                        </div>

                        ${request.reason ? `
                        <div class="reason-section" style="margin-top: 20px;">
                            <div class="info-label" style="font-weight: bold;">總說明:</div>
                            <div style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9; white-space: pre-wrap;">${request.reason}</div>
                        </div>
                        ` : ''}

                        <h3>申請項目</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                            <thead>
                                <tr>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">商品圖片</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">商品編號</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">品名/說明</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">需求課室</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">發票開立</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">廠商</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">單價</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">數量</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">運費</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">折扣</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">小計</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">報廢</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">財產編號</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                                <tr class="total-row" style="font-weight: bold; background-color: #f9f9f9;">
                                    <td colspan="10" style="text-align: right; font-weight: bold; padding: 8px; border: 1px solid #ddd;">總金額:</td>
                                    <td style="text-align: right; font-weight: bold; padding: 8px; border: 1px solid #ddd;">$${Number(request.total_amount).toLocaleString()}</td>
                                    <td colspan="2" style="padding: 8px; border: 1px solid #ddd;"></td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="approval-section" style="margin-top: 20px;">
                            <h3>簽核流程</h3>
                            ${(request.approvers || []).map(approver => {
                                let displayRole = approver.role;
                                if (approver.role === '使用者') {
                                    if (approver.step === 1) displayRole = '申請人主管';
                                    else if (approver.step === 2) displayRole = '申請人主管的主管';
                                }
                                return `
                                    <div class="approval-item" style="margin-bottom: 10px; display: flex;">
                                        <div class="approval-role" style="font-weight: bold; width: 150px;">${displayRole}:</div>
                                        <div class="approval-status" style="flex: 1;">${getApproverStatusUI(approver, request)}</div>
                                    </div>
                                    ${approver.comment ? `<div style="margin-left: 150px; font-size: 10px; color: #666;">意見: ${approver.comment}</div>` : ''}
                                    ${approver.reason ? `<div style="margin-left: 150px; font-size: 10px; color: #d32f2f;">退回原因: ${approver.reason}</div>` : ''}
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>批量列印申請單 (${requests.length}張)</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header h1 { margin: 0; font-size: 20px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
                        .info-item { padding: 5px 0; }
                        .info-label { font-weight: bold; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th { background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        .total-row { font-weight: bold; background-color: #f9f9f9; }
                        .approval-section { margin-top: 20px; }
                        .approval-item { margin-bottom: 10px; display: flex; }
                        .approval-role { font-weight: bold; width: 150px; }
                        .approval-status { flex: 1; }
                        .reason-section { margin-top: 20px; }
                        .request-page { margin-bottom: 40px; }
                        .summary-header { 
                            background-color: #e3f2fd; 
                            padding: 15px; 
                            margin-bottom: 30px; 
                            border-radius: 5px; 
                            text-align: center;
                            border: 2px solid #2196F3;
                        }
                        .summary-header h2 { margin: 0; color: #1976d2; }
                        .summary-stats { 
                            display: grid; 
                            grid-template-columns: repeat(4, 1fr); 
                            gap: 15px; 
                            margin-top: 10px; 
                        }
                        .summary-stat { 
                            background: white; 
                            padding: 10px; 
                            border-radius: 3px; 
                            text-align: center;
                            border: 1px solid #ccc;
                        }
                        .summary-stat .number { font-size: 18px; font-weight: bold; color: #1976d2; }
                        .summary-stat .label { font-size: 11px; color: #666; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                            .request-page { page-break-after: always; }
                            .request-page:last-child { page-break-after: auto; }
                        }
                    </style>
                </head>
                <body>
                    <div class="summary-header no-print">
                        <h2>批量列印申請單匯總</h2>
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="number">${requests.length}</div>
                                <div class="label">申請單數量</div>
                            </div>
                            <div class="summary-stat">
                                <div class="number">$${requests.reduce((sum, r) => sum + Number(r.total_amount || 0), 0).toLocaleString()}</div>
                                <div class="label">總金額</div>
                            </div>
                            <div class="summary-stat">
                                <div class="number">${requests.reduce((sum, r) => sum + (r.items || []).length, 0)}</div>
                                <div class="label">申請項目總數</div>
                            </div>
                            <div class="summary-stat">
                                <div class="number">${new Set(requests.map(r => r.applicant_id)).size}</div>
                                <div class="label">申請人數</div>
                            </div>
                        </div>
                    </div>

                    ${requestsHTML}

                    <div class="no-print" style="margin-top: 30px; text-align: center; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <button onclick="window.print()" style="padding: 12px 24px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px;">列印全部</button>
                        <button onclick="window.close()" style="padding: 12px 24px; background-color: #757575; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">關閉</button>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
        };

        window.renderPrintManagement = function() {
            const viewEl = document.getElementById('printManagement-view');
            const currentDate = new Date();
            const lastMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            const thisMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            
            const formatDateForInput = (date) => {
                return date.toISOString().split('T')[0];
            };

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">表單列印作業</h1>
                    <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-4">列印條件設定</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">開始日期</label>
                                <input type="date" id="print-start-date" class="w-full rounded-md border-gray-300 shadow-sm" value="${formatDateForInput(lastMonth)}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">結束日期</label>
                                <input type="date" id="print-end-date" class="w-full rounded-md border-gray-300 shadow-sm" value="${formatDateForInput(currentDate)}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">申請單狀態</label>
                                <select id="print-status-filter" class="w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">全部</option>
                                    <option value="待審核">待審核</option>
                                    <option value="已核准">已核准</option>
                                    <option value="已退回">已退回</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">申請人</label>
                                <select id="print-applicant-filter" class="w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">全部</option>
                                    ${Object.values(state.users).map(user => 
                                        `<option value="${user.id}">${user.name} (${user.department})</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button data-action="search-print-requests" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">搜尋申請單</button>
                            <button data-action="print-selected-requests" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700" disabled>列印選取的申請單</button>
                        </div>
                    </div>

                    <div id="print-search-results" class="hidden">
                        <h3 class="text-lg font-bold mb-4">搜尋結果</h3>
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="select-all-print" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-700">全選</span>
                            </label>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">選取</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申請單號</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申請人</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申請日期</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">部門</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">簽核狀態</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總金額</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="print-results-table" class="bg-white divide-y divide-gray-200">
                                    <!-- 搜尋結果將在這裡顯示 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            viewEl.style.display = 'block';
        };

        window.renderProductForm = function() {
            const viewEl = document.getElementById('productForm-view');
            const product = state.editingProduct;
            const isEditing = !!product;
            const formData = product || { id: '', name: '', category: '', vendor: '', spec: '', price: 0, unit: '', ordering_system: '特採', image: '' };
            const imageUrl = formData.image ? `https://drive.google.com/thumbnail?id=${formData.image}` : 'https://placehold.co/200x200?text=無圖片';
            
            const vendorOptions = state.vendors.map(v => 
                `<option value="${v.vendor_id}" ${formData.vendor === v.vendor_id ? 'selected' : ''}>${v.short_name || v.name} (${v.vendor_id})</option>`
            ).join('');

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? '編輯商品' : '新增商品'}</h1>
                    <button data-view="productManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-4xl mx-auto">
                    <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 flex flex-col items-center">
                            <img id="product-form-image-preview" src="${imageUrl}" alt="Product Image" class="w-48 h-48 object-cover mb-4 rounded-md border" onerror="this.onerror=null;this.src='https://placehold.co/200x200?text=圖片錯誤';"/>
                            <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                            <label for="image-upload-input" class="cursor-pointer px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">選擇圖片</label>
                            <span id="image-upload-filename" class="text-xs text-gray-500 mt-2">尚未選擇檔案</span>
                            <button type="button" id="image-upload-button" data-action="upload-image" class="mt-2 px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50" disabled>上傳圖片</button>
                            <input type="hidden" name="image" value="${formData.image || ''}">
                        </div>

                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">商品編號</label>
                                <input type="text" name="id" value="${formData.id}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100" ${isEditing ? 'readonly' : 'required'}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">品名</label>
                                <input type="text" name="name" value="${formData.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">分類</label>
                                <input type="text" name="category" value="${formData.category}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">廠商</label>
                                <select name="vendor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 請選擇廠商 --</option>
                                    ${vendorOptions}
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">規格</label>
                                <textarea name="spec" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${formData.spec || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">單價</label>
                                <input type="number" name="price" step="any" value="${formData.price}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">單位</label>
                                <input type="text" name="unit" value="${formData.unit}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">訂購系統</label>
                                <input type="text" name="ordering_system" value="${formData.ordering_system}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                        </div>
                        
                        <div class="md:col-span-3 flex justify-end mt-4">
                            <button type="button" data-action="save-product" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">儲存</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderPersonalForms = function() {
            const viewEl = document.getElementById('personalForms-view');
            const { activeTab } = state.local.personalForms;
            
            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">個人專區</h1>
                    <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回主儀表板</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button data-tab="inbox" class="tab-button ${activeTab === 'inbox' ? 'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">收件資料夾</button>
                            <button data-tab="sent" class="tab-button ${activeTab === 'sent' ? 'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">原稿資料夾</button>
                            <button data-tab="history" class="tab-button ${activeTab === 'history' ?'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">逐級通知資料夾</button>
                            <button data-tab="handler" class="tab-button ${activeTab === 'handler' ?'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">已經辦資料夾</button>
                            <button data-tab="closed" class="tab-button ${activeTab === 'closed' ?'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">結案資料夾</button>
                        </nav>
                    </div>
                    <div id="personal-forms-content" class="mt-6">
                    </div>
                </div>`;
            
            renderPersonalFormsContent();
            viewEl.style.display = 'block';
        };
        
        const renderPersonalFormsContent = () => {
            const contentEl = document.getElementById('personal-forms-content');
            if (!contentEl) return;

            const { activeTab } = state.local.personalForms;
            const filters = state.local.personalForms[activeTab];
            const { currentUser, requests, applicantNotifications } = state;
            
            let items = [];
            let isRequestList = true;

            if (activeTab === 'inbox') {
                isRequestList = false;
                items = [...applicantNotifications].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                 if (filters.searchTerm) {
                    const lowerSearchTerm = filters.searchTerm.toLowerCase();
                    items = items.filter(n => JSON.stringify(n).toLowerCase().includes(lowerSearchTerm));
                }
            } else if (['sent','history'].includes(activeTab)) {
                let baseRequests = [];
                if (activeTab === 'sent') {
                    baseRequests = requests.filter(req => req.applicant_id === currentUser.id);
                } else if (activeTab === 'history') {
                    baseRequests = requests.filter(req => (req.approvers || []).some(a => a.userId === currentUser.id && (a.status === 'approved' || a.status === 'rejected')));
                }

                items = baseRequests.filter(req => {
                    if (filters.status !== 'all' && req.status !== filters.status) return false;
                    if (filters.searchTerm && !JSON.stringify(req).toLowerCase().includes(filters.searchTerm.toLowerCase())) return false;
                    
                    if (activeTab === 'sent' || activeTab === 'history') {
                        const requestDate = getISODateString(req.request_date);
                        if (filters.dateFrom && requestDate < filters.dateFrom) return false;
                        if (filters.dateTo && requestDate > filters.dateTo) return false;
                    }
                    return true;
                });
            } else if (activeTab === 'handler') {
                // 經辦資料夾：使用者是 handler，未結案優先顯示；可依經辦狀態與日期/狀態/關鍵字過濾
                let baseRequests = requests.filter(req => req.handler_id === currentUser.id || state.currentUser.is_admin || ['採購','採購主管'].includes(state.currentUser.role));
                items = baseRequests.filter(req => {
                    if (filters.status !== 'all' && req.status !== filters.status) return false;
                    // 僅顯示已經辦
                    const eff = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                    if (eff !== '已經辦') return false;
                    if (filters.searchTerm && !JSON.stringify(req).toLowerCase().includes(filters.searchTerm.toLowerCase())) return false;
                    const requestDate = getISODateString(req.request_date);
                    if (filters.dateFrom && requestDate < filters.dateFrom) return false;
                    if (filters.dateTo && requestDate > filters.dateTo) return false;
                    // 預設只顯示未結案（已結案在結案資料夾）
                    return req.closed_status !== '結案';
                });
                // 依經辦狀態排序：待經辦優先
                const order = { '未經辦': 0, '待經辦': 1, '已經辦': 2 };
                items.sort((a,b) => {
                    const ea = a.handler_status || (a.status === '已核准' ? '待經辦' : '未經辦');
                    const eb = b.handler_status || (b.status === '已核准' ? '待經辦' : '未經辦');
                    if (order[ea] !== order[eb]) return order[ea] - order[eb];
                    return new Date(b.request_date) - new Date(a.request_date);
                });
            } else if (activeTab === 'closed') {
                // 結案資料夾：所有已結案的單據，預設只顯示申請人或曾經辦過者關聯，可再依狀態/日期/搜尋
                let baseRequests = requests.filter(req => req.closed_status === '結案' && (
                    req.applicant_id === currentUser.id || req.handler_id === currentUser.id || (req.approvers||[]).some(a => a.userId === currentUser.id)
                ));
                items = baseRequests.filter(req => {
                    if (filters.status !== 'all' && req.status !== filters.status) return false;
                    if (filters.searchTerm && !JSON.stringify(req).toLowerCase().includes(filters.searchTerm.toLowerCase())) return false;
                    const requestDate = getISODateString(req.request_date);
                    if (filters.dateFrom && requestDate < filters.dateFrom) return false;
                    if (filters.dateTo && requestDate > filters.dateTo) return false;
                    return true;
                }).sort((a,b) => new Date(b.request_date) - new Date(a.request_date));
            }

            const itemsHTML = items.length > 0 ? items.map(item => {
                if (isRequestList) {
                    const req = item;
                    // Add this debug log
                    if (req.id === undefined || req.id === null || req.id === '') {
                        console.warn(`DEBUG: Found request with invalid ID in personal forms:`, req);
                    }
                    const canDelete = req.status === '待送出' && (req.applicant_id === state.currentUser.id || state.currentUser.is_admin);
                    console.log(`Request ID: ${req.id}, Status: ${req.status}, Applicant ID: ${req.applicant_id}, Current User ID: ${state.currentUser.id}, Is Admin: ${state.currentUser.is_admin}, Can Delete: ${canDelete}`);
                    const effHandler = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                    const handlerChipCls = ({'未經辦': 'bg-neutral-100 text-neutral-800','待經辦': 'bg-amber-100 text-amber-800','已經辦': 'bg-green-100 text-green-800'})[effHandler] || 'bg-gray-100 text-gray-800';
                    const closedChipCls = ({'未結案': 'bg-gray-100 text-gray-800','結案': 'bg-purple-100 text-purple-800'})[req.closed_status || '未結案'] || 'bg-gray-100 text-gray-800';
                    return `
                        <li class="border p-4 rounded-lg hover:bg-gray-50">
                            <div class="flex justify-between items-center">
                                <a href="#" data-action="view-detail" data-id="${req.id}" class="block flex-grow">
                                    <div class="flex justify-between items-center">
                                        <p class="font-bold text-blue-600">${req.id}</p>
                                        <div class="flex items-center gap-2">
                                            <span class="px-3 py-1 rounded-full text-xs font-medium ${{'待送出': 'bg-gray-100 text-gray-800', '待審核': 'bg-yellow-100 text-yellow-800', '已核准': 'bg-green-100 text-green-800', '已退回': 'bg-red-100 text-red-800'}[req.status] || 'bg-gray-100 text-gray-800'}">${req.status}</span>
                                            <span class="px-3 py-1 rounded-full text-xs font-medium ${handlerChipCls}">${effHandler}</span>
                                            <span class="px-3 py-1 rounded-full text-xs font-medium ${closedChipCls}">${req.closed_status || '未結案'}</span>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-2">申請日期: ${getFormattedDateTime(req.request_date)}</p>
                                    <p class="text-sm text-gray-600">總金額: ${Number(req.total_amount).toLocaleString()}</p>
                                    <p class="text-sm text-gray-500 mt-1 truncate">原因: ${req.reason || '無'}</p>
                                </a>
                                ${canDelete && req.id ? `<button data-id="${req.id}" data-action="delete-draft" class="text-red-600 hover:text-red-900 ml-4">刪除</button>` : ''}
                            </div>
                        </li>`;
                } else {
                    const n = item;
                    // 修正：點擊通知連結時，若 request 存在才可開啟
                    const requestExists = state.requests.some(r => r.id == n.request_id);
                    return `
                        <li class="p-4 rounded-lg ${n.is_read ? 'bg-gray-50' : 'bg-blue-50'}">
                            <a href="#" data-action="view-notification-detail" data-id="${n.request_id}" data-notification-id="${n.id}" class="block ${requestExists ? '' : 'pointer-events-none opacity-50'}">
                                <div class="flex justify-between items-center">
                                    <p class="text-sm text-gray-800 ${!n.is_read ? 'font-bold' : ''}">${n.message}</p>
                                    <span class="text-xs text-gray-500 whitespace-nowrap">${getFormattedDateTime(n.timestamp)}</span>
                                </div>
                            </a>
                        </li>`;
                }
            }).join('') : `<p class="text-center text-gray-500 py-8">此資料夾中沒有任何項目。</p>`;

            let dateFilterHTML = '';
            if (activeTab === 'sent' || activeTab === 'history' || activeTab === 'handler' || activeTab === 'closed') {
                const dateFrom = filters.dateFrom || '';
                const dateTo = filters.dateTo || '';
                dateFilterHTML = `
                    <div class="flex items-center space-x-2">
                        <input type="date" data-filter-type="dateFrom" value="${dateFrom}" class="personal-forms-filter p-2 border border-gray-300 rounded-md shadow-sm" />
                        <span>~</span>
                        <input type="date" data-filter-type="dateTo" value="${dateTo}" class="personal-forms-filter p-2 border border-gray-300 rounded-md shadow-sm" />
                    </div>
                `;
            }

            contentEl.innerHTML = `
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    ${dateFilterHTML}
                    ${['sent','history','handler','closed'].includes(activeTab) ? `
                    <select data-filter-type="status" class="personal-forms-filter p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="all" ${filters.status === 'all' ? 'selected' : ''}>所有狀態</option>
                        <option value="待送出" ${filters.status === '待送出' ? 'selected' : ''}>待送出</option>
                        <option value="待審核" ${filters.status === '待審核' ? 'selected' : ''}>待審核</option>
                        <option value="已核准" ${filters.status === '已核准' ? 'selected' : ''}>已核准</option>
                        <option value="已退回" ${filters.status === '已退回' ? 'selected' : ''}>已退回</option>
                    </select>` : ''}
                    ${activeTab === 'handler' ? '' : ''}
                    <input type="text" data-filter-type="searchTerm" placeholder="搜尋..." class="personal-forms-filter flex-grow p-2 border border-gray-300 rounded-md shadow-sm" value="${filters.searchTerm || ''}">
                </div>
                <ul class="space-y-4">${itemsHTML}</ul>
            `;
        };

        window.renderUserManagement = function() {
            const viewEl = document.getElementById('userManagement-view');
            const { department, searchTerm } = state.local.userManagementFilters;
            const allDepartments = ['all', ...Object.keys(state.departments)];

            const filteredUsers = Object.values(state.users).filter(user => {
                if (department !== 'all' && user.department !== department) return false;
                if (searchTerm && !JSON.stringify(user).toLowerCase().includes(searchTerm.toLowerCase())) return false;
                return true;
            });

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">使用者管理</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                        <button data-action="add-user" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">新增使用者</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select id="user-dept-filter" class="p-2 border border-gray-300 rounded-md shadow-sm">
                            ${allDepartments.map(d => `<option value="${d}" ${department === d ? 'selected' : ''}>${d === 'all' ? '所有部門' : d}</option>`).join('')}
                        </select>
                        <input type="text" id="user-search-input" placeholder="搜尋姓名、Email、工號..." class="md:col-span-2 p-2 border border-gray-300 rounded-md shadow-sm" value="${searchTerm}">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">姓名</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">部門</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">發票開立</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">角色</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">簽核狀態</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">功能</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredUsers.map(user => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.department || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.default_invoice || ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.role} ${user.is_admin ?'(管理員)' : ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center">
                                            <button data-action="toggle-user-enabled" data-id="${user.id}" data-enabled="${user.is_enabled}" class="px-3 py-1 rounded-full text-xs font-medium ${user.is_enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${user.is_enabled ? '啟用' : '停用'}
                                            </button>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-id="${user.id}" data-action="edit-user" class="text-blue-600 hover:text-blue-900">編輯</button>
                                            <button data-id="${user.id}" data-name="${user.name}" data-action="reset-password" class="text-yellow-600 hover:text-yellow-900 ml-4">重設密碼</button>
                                            <button data-id="${user.id}" data-name="${user.name}" data-action="delete-user" class="text-red-600 hover:text-red-900 ml-4">刪除</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderUserForm = function() {
            const viewEl = document.getElementById('userForm-view');
            const user = state.editingUser;
            const formData = user || { email: '', name: '', employee_id: '', role: '使用者', department: '', demand_department: '', default_invoice: '', is_admin: false, is_department_head: false, is_enabled: true, manager_id: null, manager_id2: null, manager_id3: null, is_handler: false };
            const isEditing = !!user;
            
            const allUsers = Object.values(state.users);
            const allDepartments = Object.keys(state.departments);
            const allRoles = ['使用者', '採購', '採購主管', '院長'];

            const userOptions = allUsers
                .filter(u => !isEditing || u.id !== user.id)
                .map(u => `<option value="${u.id}" ${ (isEditing && (u.id === formData.manager_id || u.id === formData.manager_id2)) ? 'selected' : '' }>${u.name} (${u.email})</option>`).join('');

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? '編輯使用者' : '新增使用者'}</h1>
                    <button data-view="userManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-2xl mx-auto">
                    <form id="user-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" name="email" value="${formData.email}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">姓名</label>
                                <input type="text" name="name" value="${formData.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">工號</label>
                                <input type="text" name="employee_id" value="${formData.employee_id || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                            </div>
                            ${!isEditing ? `
                            <div>
                                <label class="block text-sm font-medium text-gray-700">密碼</label>
                                <input type="password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required placeholder="至少6位數" />
                            </div>` : ''}
                            <div>
                                <label class="block text-sm font-medium text-gray-700">角色</label>
                                <select name="role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    ${allRoles.map(r => `<option value="${r}" ${formData.role === r ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">部門</label>
                                <select name="department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 請選擇 --</option>
                                    ${allDepartments.map(d => `<option value="${d}" ${formData.department === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">預設需求課室</label>
                                <select name="demand_department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 請選擇 --</option>
                                    ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}" ${formData.demand_department === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">預設發票開立</label>
                                <select name="default_invoice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 請選擇 --</option>
                                    ${[
                                        "8C清福", "7C清氣", "6C清心", "5C清平", "3C清安", "2CD清護",
                                        "8D清春", "7D清日", "6D清照", "5D清風", "3D清景", "8E清山",
                                        "7E清泉", "6E清水", "8E清清", "3E清涼", "清福法人", "一館",
                                        "二館", "三館", "含笑", "清福幼兒園", "其他"
                                    ].map(opt => `<option value="${opt}" ${formData.default_invoice === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">直屬主管</label>
                                <select name="manager_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 無 --</option>
                                    ${allUsers.map(u => `<option value="${u.id}" ${formData.manager_id === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">第二主管</label>
                                <select name="manager_id2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 無 --</option>
                                    ${allUsers.map(u => `<option value="${u.id}" ${formData.manager_id2 === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">第三主管</label>
                                <select name="manager_id3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 無 --</option>
                                    ${allUsers.map(u => `<option value="${u.id}" ${formData.manager_id3 === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                            </div>
                            ${isEditing ? `
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">重設密碼</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <input type="password" name="new_password" placeholder="輸入新密碼（留空則不修改）" class="block w-full rounded-md border-gray-300 shadow-sm">
                                    <button type="button" id="show-password-btn" class="px-3 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">顯示</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">如需重設此使用者的登入密碼，請輸入新密碼。密碼長度至少6位。</p>
                            </div>
                            ` : ''}
                            <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_admin" name="is_admin" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_admin ? 'checked' : ''} />
                                <label for="is_admin" class="ml-2 block text-sm text-gray-900">設為系統管理員</label>
                            </div>
                            <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_handler" name="is_handler" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_handler ? 'checked' : ''} />
                                <label for="is_handler" class="ml-2 block text-sm text-gray-900">設為經辦人員</label>
                            </div>
                             <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_department_head" name="is_department_head" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_department_head ? 'checked' : ''} />
                                <label for="is_department_head" class="ml-2 block text-sm text-gray-900">設為部門主管</label>
                            </div>
                            <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_enabled" name="is_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_enabled ? 'checked' : ''} />
                                <label for="is_enabled" class="ml-2 block text-sm text-gray-900">啟用此帳號</label>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="button" data-action="save-user" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">儲存</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        // 部門管理列表
        window.renderDepartmentManagement = function() {
            const viewEl = document.getElementById('departmentManagement-view');
            const search = (state.local.departmentManagementSearchTerm || '').toLowerCase();
            const rows = Object.entries(state.departments)
                .map(([department, director_threshold]) => ({ department, director_threshold }))
                .filter(d => JSON.stringify(d).toLowerCase().includes(search))
                .sort((a,b) => a.department.localeCompare(b.department, 'zh-Hant'));

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">部門管理</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                        <button data-action="add-department" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">新增部門</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-4">
                        <input type="text" id="department-search-input" placeholder="搜尋部門..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm" value="${state.local.departmentManagementSearchTerm || ''}">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">部門名稱</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">主管簽核門檻</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">功能</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${rows.map(d => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${d.department}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${d.director_threshold ?? ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-dept="${d.department}" data-action="edit-department" class="text-blue-600 hover:text-blue-900">編輯</button>
                                            <button data-dept="${d.department}" data-action="delete-department" class="text-red-600 hover:text-red-900 ml-4">刪除</button>
                                        </td>
                                    </tr>
                                `).join('') || `<tr><td colspan="3" class="text-center py-10 text-gray-500">尚無部門資料</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        // 部門表單
        window.renderDepartmentForm = function() {
            const viewEl = document.getElementById('departmentForm-view');
            const dept = state.editingDepartment || null;
            const isEditing = !!dept;
            const formData = dept || { department: '', director_threshold: '' };

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? '編輯部門' : '新增部門'}</h1>
                    <button data-view="departmentManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-2xl mx-auto">
                    <form id="department-form">
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">部門名稱*</label>
                                <input type="text" name="department" value="${formData.department || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm ${isEditing ? 'bg-gray-100' : ''}" ${isEditing ? 'readonly' : 'required'}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">主管簽核門檻(金額)</label>
                                <input type="number" name="director_threshold" value="${formData.director_threshold ?? ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0" step="1">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="button" data-action="save-department" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">儲存</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderVendorManagement = function() {
            const viewEl = document.getElementById('vendorManagement-view');
            const searchTerm = state.local.vendorManagementSearchTerm.toLowerCase();
            const filteredVendors = state.vendors.filter(v => 
                JSON.stringify(v).toLowerCase().includes(searchTerm)
            );

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">廠商管理</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                        <button data-action="add-vendor" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">新增廠商</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-4">
                        <input type="text" id="vendor-search-input" placeholder="搜尋廠商..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm" value="${state.local.vendorManagementSearchTerm}">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">廠商代號</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">廠商簡稱</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">聯絡人</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">連絡電話</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">功能</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredVendors.map(v => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.vendor_id}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.short_name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.contact_person || ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.phone || ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-id="${v.vendor_id}" data-action="edit-vendor" class="text-blue-600 hover:text-blue-900">編輯</button>
                                            <button data-id="${v.vendor_id}" data-name="${v.name}" data-action="delete-vendor" class="text-red-600 hover:text-red-900 ml-4">刪除</button>
                                        </td>
                                    </tr>
                                `).join('') || `<tr><td colspan="5" class="text-center py-10 text-gray-500">找不到廠商</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderVendorForm = function() {
            const viewEl = document.getElementById('vendorForm-view');
            const vendor = state.editingVendor;
            const isEditing = !!vendor;
            const formData = vendor || { tax_id: '', address: '', invoice_address: '', mailing_address: '' };

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? '編輯廠商' : '新增廠商'}</h1>
                    <button data-view="vendorManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">返回列表</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-4xl mx-auto">
                    <form id="vendor-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Column 1 -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">廠商代號*</label>
                                    <input type="text" name="vendor_id" value="${formData.vendor_id || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100" ${isEditing ? 'readonly' : 'required'}>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">廠商名稱*</label>
                                    <input type="text" name="name" value="${formData.name || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">廠商簡稱*</label>
                                    <input type="text" name="short_name" value="${formData.short_name || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">統一編號</label>
                                    <input type="text" name="tax_id" value="${formData.tax_id || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <p id="tax-id-error" class="text-xs text-red-500 mt-1 hidden">統一編號格式錯誤</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">聯絡人</label>
                                    <input type="text" name="contact_person" value="${formData.contact_person || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                            </div>
                            <!-- Column 2 -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">連絡電話</label>
                                    <input type="text" name="phone" value="${formData.phone || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">手機號碼</label>
                                    <input type="text" name="mobile_phone" value="${formData.mobile_phone || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">傳真</label>
                                    <input type="text" name="fax" value="${formData.fax || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">付款方式</label>
                                    <select name="payment_method" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <option ${!formData.payment_method ? 'selected' : ''} disabled value="">請選擇</option>
                                        ${['電匯即期', '電匯30天', '電匯60天', '電匯90天', '每月20日', '現金'].map(o => `<option value="${o}" ${formData.payment_method === o ? 'selected' : ''}>${o}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">稅別</label>
                                    <select name="tax_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <option ${!formData.tax_type ? 'selected' : ''} disabled value="">請選擇</option>
                                        ${['含稅', '未稅', '零稅', '免稅'].map(o => `<option value="${o}" ${formData.tax_type === o ? 'selected' : ''}>${o}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <!-- Column 3 -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">公司地址</label>
                                    <input type="text" name="address" value="${formData.address || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">發票地址</label>
                                    <label class="flex items-center text-xs mt-1"><input type="checkbox" id="copy-invoice-address"> 同公司地址</label>
                                    <input type="text" name="invoice_address" value="${formData.invoice_address || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">寄款地址</label>
                                    <label class="flex items-center text-xs mt-1"><input type="checkbox" id="copy-mailing-address"> 同公司地址</label>
                                    <input type="text" name="mailing_address" value="${formData.mailing_address || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                            </div>
                            <!-- Full Width -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">備註</label>
                                <textarea name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${formData.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="button" data-action="save-vendor" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">儲存</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        // --- 模態框 ---
        const renderModal = (content, options = {}) => {
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = content;
            // 控制視窗寬度（半寬或預設）
            if (options.size === 'half') {
                modalContent.style.width = '50vw';
            } else {
                modalContent.style.width = '95vw';
            }
            document.getElementById('modal-container').style.display = 'flex';
        };

        const closeModal = () => {
            document.getElementById('modal-container').style.display = 'none';
            document.getElementById('modal-content').innerHTML = '';
            state.local.consolidatedData = null;
        };

        // 簽核彈窗功能
        window.openApprovalModal = function(requestId) {
            const request = state.requests.find(r => r.id === requestId);
            if (!request) {
                showMessage('找不到對應的申請單。', 'error');
                return;
            }

            const approvers = request.approvers || [];
            const nextApprover = approvers.find(a => a.status === 'pending');
            
            // 驗證權限
            if (request.status !== '待審核' || !nextApprover || nextApprover.userId !== state.currentUser.id) {
                showMessage('您沒有權限簽核此申請單。', 'error');
                return;
            }

            const getApproverStatusUI = (approver) => {
                let statusHTML = '';
                const approverUser = state.users[approver.userId];
                const approverInfo = approverUser ? `(${approverUser.email} ${approverUser.name})` : `(${approver.userId.substring(0,8)})`;
                
                // 檢查是否為修改當下的簽核列（簽核頁面版本）
                let modificationMark = '';
                if (request.modification_history && request.modification_history.length > 0) {
                    const userToMatch = approverUser ? approverUser.name : approver.userId;
                    const hasEditModification = request.modification_history.some(h => 
                        ((h.userId === approver.userId) || (h.user === userToMatch)) && 
                        (h.action === 'handled_edit' || (h.changes && h.changes.length > 0))
                    );
                    
                    if (hasEditModification) {
                        modificationMark = ' <span class="text-orange-600 font-bold">有修改過</span>';
                    }
                }

                if (approver.status === 'approved') statusHTML = `<span class="text-green-600">✔️ 已核准 (${getFormattedDateTime(approver.date)}) by ${approver.role} ${approverInfo}</span>${modificationMark}`;
                else if (approver.status === 'rejected') statusHTML = `<span class="text-red-600">❌ 已退回 (${getFormattedDateTime(approver.date)}) by ${approver.role} ${approverInfo}</span>${modificationMark}`;
                else statusHTML = `<span class="text-gray-500">… 待簽核 by ${approver.role} ${approverInfo}</span>`;
                
                if(approver.comment) statusHTML += `<p class="text-xs text-gray-500 pl-4">意見: ${approver.comment}</p>`;
                if(approver.reason) statusHTML += `<p class="text-xs text-red-500 pl-4">退回原因: ${approver.reason}</p>`;
                return statusHTML;
            };

            const canApprove = state.currentUser && nextApprover && state.currentUser.id === nextApprover.userId;
            const isPurchaser = state.currentUser.role.includes('採購');
            const isPurchaserEditing = canApprove && isPurchaser;

            const itemsHTML = (request.items || []).map((item, index) => {
                const subtotal = (item.price || 0) * (item.quantity || 0) + (item.freight || 0) + (item.discount || 0);
                const workOrderNumber = item.is_scrap_work_order && item.work_order_number ? item.work_order_number : '';
                
                const product = state.allProducts.find(p => p.id === item.id);
                const imageUrl = product?.image 
                    ? `https://drive.google.com/thumbnail?id=${product.image}` 
                    : 'https://placehold.co/64x64?text=無圖片';
                const vendorName = state.vendors.find(v => v.vendor_id === item.vendor)?.short_name || item.vendor || '';

                if (isPurchaserEditing) {
                    return `
                        <tr class="border-b item-row">
                            <td class="px-4 py-2 align-top"><img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64?text=錯誤';"/></td>
                            <td class="px-4 py-2 align-top">${item.id || ''}</td>
                            <td class="px-4 py-2 align-top">
                                ${item.name}
                                <div class="text-xs text-gray-700 mt-2 space-y-1">
                                    <div>
                                        <label class="text-gray-600 mr-2">原因</label>
                                        <select name="reason_${index}" class="p-1 border rounded">
                                            ${['新增','修繕','報廢','其他'].map(r => `<option value="${r}" ${item.reason === r ? 'selected' : ''}>${r}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-gray-600 mr-2">說明</label>
                                        <input type="text" name="description_${index}" class="p-1 border rounded w-64" value="${item.description || ''}" placeholder="輸入說明...">
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <select name="demand_department_${index}" class="w-full p-1 border rounded">
                                    <option value="">-- 請選擇 --</option>
                                    ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}" ${(item.demand_department || '') === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <div class="flex items-center gap-2">
                                    <select name="invoice_${index}" class="p-1 border rounded ${item.invoice === '其他' ? 'w-1/3' : 'w-full'}">
                                        <option value="">-- 請選擇 --</option>
                                        ${[
                                            "8C清福", "7C清氣", "6C清心", "5C清平", "3C清安", "2CD清護",
                                            "8D清春", "7D清日", "6D清照", "5D清風", "3D清景", "8E清山",
                                            "7E清泉", "6E清水", "8E清清", "3E清涼", "清福法人", "一館",
                                            "二館", "三館", "含笑", "清福幼兒園", "其他"
                                        ].map(opt => `<option value="${opt}" ${item.invoice === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                    <input type="text" name="custom_invoice_${index}" class="p-1 border rounded ${item.invoice === '其他' ? 'block w-2/3' : 'hidden'}" value="${item.custom_invoice || ''}" placeholder="請輸入發票開立...">
                                </div>
                            </td>
                            <td class="px-4 py-2 align-top">${vendorName}</td>
                            <td class="px-4 py-2 text-right align-top">$${Number(item.price || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-right align-top">${item.quantity} ${item.unit || ''}</td>
                            <td class="px-4 py-2 text-right align-top">$${Number(item.freight || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-right align-top">$${Number(item.discount || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-right align-top subtotal-cell" data-index="${index}">$${subtotal.toLocaleString()}</td>
                            <td class="px-4 py-2 align-top">
                                <label class="inline-flex items-center gap-2">
                                    <input type="checkbox" name="scrap_${index}" ${item.reason === '報廢' ? '' : 'disabled'} ${item.is_scrap_work_order ? 'checked' : ''}>
                                    <span>報廢</span>
                                </label>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <input name="asset_number_${index}" class="w-full p-1 border rounded ${item.is_scrap_work_order ? '' : 'opacity-50'}" ${item.is_scrap_work_order ? '' : 'disabled'} value="${workOrderNumber}" placeholder="請輸入財產編號">
                            </td>
                        </tr>`;
                }
                return `
                    <tr class="border-b">
                        <td class="px-4 py-2 align-top"><img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64?text=錯誤';"/></td>
                        <td class="px-4 py-2 align-top">${item.id || ''}</td>
                        <td class="px-4 py-2 align-top">
                            ${item.name}
                            <div class="text-xs text-gray-500 mt-1">
                                <p><b>原因:</b> ${item.reason || 'N/A'}</p>
                                <p><b>說明:</b> ${item.description || 'N/A'}</p>
                            </div>
                        </td>
                        <td class="px-4 py-2 align-top">${item.demand_department || ''}</td>
                        <td class="px-4 py-2 align-top">${item.invoice === '其他' ? (item.custom_invoice || '') : (item.invoice || '')}</td>
                        <td class="px-4 py-2 align-top">${vendorName}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.price || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">${item.quantity} ${item.unit}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.freight || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.discount || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">$${subtotal.toLocaleString()}</td>
                        <td class="px-4 py-2 text-center align-top">${item.is_scrap_work_order ? '✔️' : ''}</td>
                        <td class="px-4 py-2 align-top">${workOrderNumber}</td>
                    </tr>`;
            }).join('');
            
            const modificationHistoryHTML = (() => {
                const fieldNameMap = { reason: '原因', description: '說明', demand_department: '需求課室', invoice: '發票開立', custom_invoice: '自訂發票', vendor: '廠商', price: '單價', quantity: '數量', unit: '單位', freight: '運費', discount: '折扣', is_scrap_work_order: '報廢', work_order_number: '財產編號' };
                const hist = [...(request.modification_history || [])].reverse();
                return hist.map((entry, i) => `
                    <div class="text-xs text-gray-500 border-t pt-2 mt-2">
                        <p><strong>#${i + 1} 修改人:</strong> ${entry.user} (${entry.role}) 於 ${getFormattedDateTime(entry.date)}</p>
                        <p><strong>修改原因:</strong> ${entry.reason || '（未填）'}</p>
                    </div>
                `).join('');
            })();

            renderModal(`
                <div class="space-y-6">
                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="text-lg font-medium text-gray-900">申請單詳情: ${request.id}</h3>
                        <p class="mt-1 text-sm text-gray-600">請審核以下申請單的內容</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><span class="font-bold text-gray-600">申請單號:</span> ${request.id} ${Array.isArray(request.attachments) && request.attachments.length ? '📎' : ''}</div>
                        <div><span class="font-bold text-gray-600">申請日期:</span> ${getFormattedDateTime(request.request_date)}</div>
                        <div><span class="font-bold text-gray-600">狀態:</span> <span class="px-3 py-1 rounded-full text-xs font-medium ${{'待審核': 'bg-yellow-100 text-yellow-800', '已核准': 'bg-green-100 text-green-800', '已退回': 'bg-red-100 text-red-800'}[request.status] || 'bg-gray-100 text-gray-800'}">${request.status}</span></div>
                        <div><span class="font-bold text-gray-600">申請人:</span> ${state.users[request.applicant_id]?.name || '未知'}</div>
                        <div><span class="font-bold text-gray-600">申請部門:</span> ${request.department}</div>
                        <div><span class="font-bold text-gray-600">結案狀態:</span> <span class="px-3 py-1 rounded-full text-xs font-medium ${request.closed_status === '結案' ? 'bg-gray-300 text-gray-800' : 'bg-blue-100 text-blue-800'}">${request.closed_status || '未結案'}</span></div>
                        <div class="md:col-span-3"><span class="font-bold text-gray-600">總說明:</span> <span class="text-gray-800 whitespace-pre-wrap">${request.reason || '無'}</span></div>
                    </div>

                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-3">申請項目</h4>
                        <form id="edit-request-form-modal">
                            <div class="overflow-x-auto mb-6" style="max-height: 300px; overflow-y: auto;">
                                <table class="min-w-full">
                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2 text-left">圖片</th>
                                            <th class="px-4 py-2 text-left">商品編號</th>
                        <th class="px-4 py-2 text-left">品名/說明 ${isPurchaserEditing ? '<span class="ml-2 inline-block align-middle text-[10px] px-2 py-0.5 rounded border border-gray-300 text-gray-600 bg-gray-50">唯讀</span>' : ''}</th>
                                            <th class="px-4 py-2 text-left">需求課室</th>
                                            <th class="px-4 py-2 text-left">發票開立</th>
                                            <th class="px-4 py-2 text-left">廠商</th>
                                            <th class="px-4 py-2 text-right">單價</th>
                                            <th class="px-4 py-2 text-right">數量</th>
                                            <th class="px-4 py-2 text-right">運費</th>
                                            <th class="px-4 py-2 text-right">折扣</th>
                                            <th class="px-4 py-2 text-right">小計</th>
                                            <th class="px-4 py-2 text-center">報廢</th>
                                            <th class="px-4 py-2 text-left">財產編號</th>
                                        </tr>
                                    </thead>
                                    <tbody>${itemsHTML}</tbody>
                                    <tfoot>
                                        <tr class="font-bold">
                                            <td colspan="10" class="px-4 py-2 text-right">總金額:</td>
                                            <td id="grand-total-modal" class="px-4 py-2 text-right">$${Number(request.total_amount).toLocaleString()}</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </form>
                    </div>

                    ${modificationHistoryHTML ? `
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-3">修改歷史</h4>
                        <div class="space-y-2 mb-6">${modificationHistoryHTML}</div>
                    </div>` : ''}

                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-3">簽核流程</h4>
                        <div class="space-y-4 mb-6">
                            ${(request.approvers || []).map(approver => {
                                let displayRole = approver.role;
                                if (approver.role === '使用者') {
                                    if (approver.step === 1) displayRole = '申請人主管';
                                    else if (approver.step === 2) displayRole = '申請人主管的主管';
                                    else if (approver.step === 3) displayRole = '第三主管';
                                }
                                return `<div class="flex items-start"><div class="font-bold w-48 flex-shrink-0">${displayRole}:</div><div>${getApproverStatusUI(approver)}</div></div>`;
                            }).join('')}
                        </div>
                    </div>

                    <div class="border-t pt-6">
                        ${canApprove ? `
                        <div class="flex-grow flex justify-end space-x-4">
                            ${isPurchaserEditing ? `
                            <div class="flex-grow">
                                <label for="modification-reason-modal" class="block text-sm font-medium text-gray-700">修改原因</label>
                                <textarea id="modification-reason-modal" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                            </div>` : ''}
                            <div class="flex-grow">
                                <label for="approval-comment-modal" class="block text-sm font-medium text-gray-700">簽核意見（選填）</label>
                                <textarea id="approval-comment-modal" rows="3" 
                                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                          placeholder="請填寫簽核意見..."></textarea>
                            </div>
                        </div>` : ''}
                    </div>

                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        ${canApprove ? `
                            ${isPurchaserEditing ? '<button data-action="modal-save-changes" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">儲存修改並核准</button>' : ''}
                            <button data-action="modal-reject-options" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">退回</button>
                            <button data-action="modal-approve" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">核准</button>
                        ` : ''}
                    </div>
                </div>
            `);

            // 如果是採購人員編輯模式，添加動態計算功能
            if (isPurchaserEditing) {
                setTimeout(() => {
                    const itemInputs = document.querySelectorAll('.item-input');
                    itemInputs.forEach(input => {
                        input.addEventListener('input', () => {
                            updateSubtotalModal(input.dataset.index);
                            updateGrandTotalModal();
                        });
                    });
                }, 100);
            }
        };

        // 輔助函數：更新彈窗中的小計
        function updateSubtotalModal(index) {
            const price = parseFloat(document.querySelector(`input[name="price_${index}"]`).value) || 0;
            const quantity = parseFloat(document.querySelector(`input[name="quantity_${index}"]`).value) || 0;
            const freight = parseFloat(document.querySelector(`input[name="freight_${index}"]`).value) || 0;
            const discount = parseFloat(document.querySelector(`input[name="discount_${index}"]`).value) || 0;
            const subtotal = price * quantity + freight + discount;
            document.querySelector(`.subtotal-cell[data-index="${index}"]`).textContent = `$${subtotal.toLocaleString()}`;
        }

        // 輔助函數：更新彈窗中的總金額
        function updateGrandTotalModal() {
            const subtotalCells = document.querySelectorAll('.subtotal-cell');
            let grandTotal = 0;
            subtotalCells.forEach(cell => {
                const value = cell.textContent.replace(/[$,]/g, '');
                grandTotal += parseFloat(value) || 0;
            });
            const grandTotalElement = document.getElementById('grand-total-modal');
            if (grandTotalElement) {
                grandTotalElement.textContent = `$${grandTotal.toLocaleString()}`;
            }
        };

        // --- 事件處理器 ---
        
        document.body.addEventListener('click', (e) => {
            const detailLink = e.target.closest('[data-action="view-detail"]');
            if (detailLink) {
                e.preventDefault();
                const requestId = detailLink.dataset.id;
                const request = state.requests.find(r => r.id == requestId);
                if (request) {
                    updateState({ view: 'detailView', selectedRequest: request });
                } else {
                    showMessage('找不到對應的申請單。', 'error');
                }
                return;
            }

            const notificationLink = e.target.closest('[data-action="view-notification-detail"]');
            if (notificationLink) {
                e.preventDefault();
                const requestId = notificationLink.dataset.id;
                const notificationId = notificationLink.dataset.notificationId;
                const request = state.requests.find(r => r.id == requestId);

                if (request) {
                    if (notificationId) {
                        const notification = state.applicantNotifications.find(n => n.id == notificationId);
                        if (notification && !notification.is_read) {
                            supabase.from('notifications').update({ is_read: true }).eq('id', notificationId).then(({error}) => {
                                if (error) console.error("更新通知狀態失敗:", error);
                            });
                        }
                    }
                    
                    const dropdown = document.getElementById('notification-dropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                    updateState({ view: 'detailView', selectedRequest: request });
                }
                return;
            }

            const viewSwitchBtn = e.target.closest('.view-switch-btn');
            if (viewSwitchBtn) {
                state.local.newRequestCart = [];
                 if (viewSwitchBtn.dataset.view === 'newRequest') {
                    updateState({ 
                        view: viewSwitchBtn.dataset.view
                    });
                } else {
                    updateState({ view: viewSwitchBtn.dataset.view });
                }
                return;
            }
            if (e.target.id === 'logout-btn') {
                // Clear the remembered account on manual logout
                localStorage.removeItem('rememberedAccount');
                await supabase.auth.signOut();
                return;
            }
            if (button.id === 'forgot-password-link') {
                e.preventDefault();
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">重設密碼</h3>
                    <p class="mb-4 text-sm text-gray-600">請輸入您的電子郵件地址，我們將會發送一封包含密碼重設連結的信件給您。</p>
                    <form id="forgot-password-form">
                        <label for="reset-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="reset-email" name="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        <div class="mt-6 flex justify-end space-x-4">
                            <button type="button" data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                            <button type="submit" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white">發送重設信件</button>
                        </div>
                    </form>
                `, { size: 'half' });
            }
            if (e.target.id === 'change-password-btn') {
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">修改密碼</h3>
                    <p class="mb-4">為 ${state.currentUser.name} 設定新密碼：</p>
                    <label for="new-password" class="block text-sm font-medium text-gray-700">新密碼</label>
                    <input type="password" id="new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                        <button data-action="confirm-change-password" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white">確認修改</button>
                    </div>`);
                return;
            }

            const bell = e.target.closest('#notification-bell');
            const dropdown = document.getElementById('notification-dropdown');

            if (bell && dropdown) {
                dropdown.classList.toggle('hidden');
            } else if (e.target && e.target.dataset && e.target.dataset.action === 'mark-all-read-updates') {
                // 將屬於當前使用者的未讀通知批次設為已讀
                const ids = state.applicantNotifications.filter(n => n.user_id === state.currentUser.id && !n.is_read).map(n => n.id);
                if (ids.length) {
                    supabase.from('notifications').update({ is_read: true }).in('id', ids).then(({ error }) => {
                        if (error) {
                            console.error('批次設為已讀失敗:', error);
                            showMessage('設為已讀失敗', 'error');
                        } else {
                            // 本地更新狀態
                            const updated = state.applicantNotifications.map(n => ids.includes(n.id) ? { ...n, is_read: true } : n);
                            updateState({ applicantNotifications: updated });
                            showMessage('已將表單進度更新全部設為已讀', 'success');
                        }
                    });
                }
            } else if (!e.target.closest('.multi-select-container') && !e.target.closest('#notification-dropdown')) {
                 document.querySelectorAll('.multi-select-dropdown').forEach(el => el.classList.add('hidden'));
                 if(dropdown) dropdown.classList.add('hidden');
            }
        });

        document.getElementById('dashboard-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button, a, th');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'sort') {
                const key = button.dataset.sortKey;
                if (state.local.sortKey === key) {
                    state.local.sortDirection = state.local.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    state.local.sortKey = key;
                    state.local.sortDirection = 'asc';
                }
                renderDashboardTable();
            } else if (action === 'select-page') {
                e.preventDefault();
                const visibleIds = getFilteredRequests().slice((state.local.currentPage - 1) * state.local.itemsPerPage, state.local.currentPage * state.local.itemsPerPage).map(req => req.id);
                visibleIds.forEach(id => state.local.selectedRequestIds.add(id));
                renderDashboard();
            } else if (action === 'select-all-filtered') {
                e.preventDefault();
                const allFilteredIds = getFilteredRequests().map(req => req.id);
                allFilteredIds.forEach(id => state.local.selectedRequestIds.add(id));
                renderDashboard();
            } else if (action === 'deselect-all') {
                e.preventDefault();
                state.local.selectedRequestIds.clear();
                renderDashboard();
            
            } else if (action === 'search-dashboard') {
                const searchTerm = document.getElementById('dashboard-search-input').value;
                state.local.selectedRequestIds.clear();
                state.local.currentPage = 1;
                state.local.dashboardFilters.searchTerm = searchTerm;
                renderDashboardTable();
            } else if (action === 'batch-approve' || action === 'batch-reject' || action === 'batch-close') {
                const selectedIds = Array.from(state.local.selectedRequestIds);
                let requestsToProcess = [];
                let modalTitle = '';
                let modalAction = '';

                if (action === 'batch-approve' || action === 'batch-reject') {
                    requestsToProcess = state.requests.filter(req => 
                        selectedIds.includes(req.id) &&
                        req.status === '待審核' &&
                        (req.approvers || []).find(a => a.status === 'pending')?.userId === state.currentUser.id
                    );
                } else if (action === 'batch-close') {
                    requestsToProcess = state.requests.filter(req => 
                        selectedIds.includes(req.id) &&
                        req.status === '已核准' &&
                        (req.closed_status === '未結案' || !req.closed_status)
                    );
                }

                if (requestsToProcess.length === 0) {
                    showMessage('沒有可供操作的已選取單據。', 'error');
                    return;
                }

                if (action === 'batch-approve') {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">批次核准</h3>
                        <p class="mb-4">您確定要核准 ${requestsToProcess.length} 筆申請單嗎？</p>
                        <label for="batch-approval-comment" class="block text-sm font-medium text-gray-700">簽核意見 (選填，將套用至所有單據)</label>
                        <textarea id="batch-approval-comment" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                            <button data-action="confirm-batch-approve" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white">確認核准</button>
                        </div>
                    `);
                } else if (action === 'batch-reject') {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">批次退回</h3>
                        <p class="mb-4">您確定要退回 ${requestsToProcess.length} 筆申請單嗎？</p>
                        <label for="batch-rejection-reason" class="block text-sm font-medium text-gray-700">退回理由 (必填，將套用至所有單据)</label>
                        <textarea id="batch-rejection-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                            <button data-action="confirm-batch-reject" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">確認退回</button>
                        </div>
                    `);
                } else if (action === 'batch-close') {
                     renderModal(`
                        <h3 class="text-lg font-bold mb-4">批次結案</h3>
                        <p class="mb-4">您確定要將 ${requestsToProcess.length} 筆已核准的申請單結案嗎？</p>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                            <button data-action="confirm-batch-close" data-ids='${JSON.stringify(requestsToProcess.map(r => r.id))}' class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-600 text-white">確認結案</button>
                        </div>
                    `);
                }
            } else if (action === 'consolidate-by-vendor') {
                let requestsToProcess;
                if (state.local.selectedRequestIds.size > 0) {
                    requestsToProcess = state.requests.filter(req => state.local.selectedRequestIds.has(req.id));
                } else {
                    requestsToProcess = getFilteredRequests();
                }

                if (requestsToProcess.length === 0) {
                    showMessage('沒有可彙整的訂單', 'error');
                    return;
                }

                renderModal(`
                    <h3 class="text-xl font-bold mb-4">選擇要彙整的訂單狀態</h3>
                    <p class="text-sm text-gray-600 mb-6">勾選欲納入的條件；各區塊可獨立選擇，未勾選者則不套用該條件。</p>
                    <div class="space-y-3 mb-8">
                        <label class="flex items-center"><input type="checkbox" value="待審核" class="consolidation-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">待審核</span></label>
                        <label class="flex items-center"><input type="checkbox" value="已核准" class="consolidation-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">已核准</span></label>
                        <label class="flex items-center"><input type="checkbox" value="已退回" class="consolidation-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">已退回</span></label>
                    </div>
                    <h4 class="text-md font-bold mb-2">篩選經辦狀態</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="未經辦" class="consolidation-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">未經辦</span></label>
                        <label class="flex items-center"><input type="checkbox" value="待經辦" class="consolidation-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">待經辦</span></label>
                        <label class="flex items-center"><input type="checkbox" value="已經辦" class="consolidation-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">已經辦</span></label>
                    </div>
                    <h4 class="text-md font-bold mb-2">篩選結案狀態</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="未結案" class="consolidation-closed-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">未結案</span></label>
                        <label class="flex items-center"><input type="checkbox" value="結案" class="consolidation-closed-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">結案</span></label>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-action="confirm-consolidation" class="px-4 py-2 rounded-md font-semibold text-sm bg-teal-600 text-white hover:bg-teal-700">確認彙整</button>
                    </div>
                `);
            } else if (action === 'export') {
                // 先彈出條件篩選視窗，再由確認按鈕匯出
                renderModal(`
                    <h3 class="text-xl font-bold mb-4">匯出訂單 - 篩選條件</h3>
                    <p class="text-sm text-gray-600 mb-6">勾選欲納入的條件；各區塊可獨立選擇，未勾選者則不套用該條件。</p>
                    <h4 class="text-md font-bold mb-2">篩選簽核狀態</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="待審核" class="export-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">待審核</span></label>
                        <label class="flex items-center"><input type="checkbox" value="已核准" class="export-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">已核准</span></label>
                        <label class="flex items-center"><input type="checkbox" value="已退回" class="export-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">已退回</span></label>
                    </div>
                    <h4 class="text-md font-bold mb-2">篩選經辦狀態</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="未經辦" class="export-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">未經辦</span></label>
                        <label class="flex items-center"><input type="checkbox" value="待經辦" class="export-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">待經辦</span></label>
                        <label class="flex items-center"><input type="checkbox" value="已經辦" class="export-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">已經辦</span></label>
                    </div>
                    <h4 class="text-md font-bold mb-2">篩選結案狀態</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="未結案" class="export-closed-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">未結案</span></label>
                        <label class="flex items-center"><input type="checkbox" value="結案" class="export-closed-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">結案</span></label>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-action="confirm-export-orders-preview" class="px-4 py-2 rounded-md font-semibold text-sm bg-teal-600 text-white hover:bg-teal-700">確認彙整</button>
                    </div>
                `);
            } else if (action === 'go-to-page') {
                state.local.currentPage = parseInt(button.dataset.page, 10);
                renderDashboardTable();
            } else if (action === 'refresh') {
                // 強制重新整理 - 清除所有緩存並重新載入資料
                updateState({ loading: true });
                try {
                    // 清除所有相關緩存
                    CacheManager.clear('dashboard_data');
                    CacheManager.clear(); // 清除所有緩存
                    
                    // 關閉現有的即時連接
                    channels.forEach(channel => {
                        try {
                            supabase.removeChannel(channel);
                        } catch (e) {
                            console.warn('清理頻道時發生錯誤:', e);
                        }
                    });
                    channels = [];
                    
                    // 強制重新載入資料，不使用任何緩存
                    await loadDashboardData(false, false);
                    
                    // 重置篩選緩存
                    getFilteredRequests.resetCache();
                    
                    // 強制完整重新渲染
                    render();
                    
                    showMessage('資料已重新整理完成！');
                } catch (err) {
                    console.error('重新整理失敗:', err);
                    showMessage('重新整理失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (e.target.closest('.multi-select-toggle')) {
                const toggle = e.target.closest('.multi-select-toggle');
                e.preventDefault();
                
                document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                    if (d !== toggle.nextElementSibling) {
                        d.classList.add('hidden');
                    }
                });

                const dropdown = toggle.nextElementSibling;
                const filterKey = toggle.dataset.filterKey;

                if (dropdown.classList.contains('hidden')) {
                    tempSelections[filterKey] = new Set(state.local.dashboardFilters[filterKey] || []);
                    const checkboxes = dropdown.querySelectorAll('.multi-select-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = tempSelections[filterKey].has(cb.value);
                    });
                }
                
                dropdown.classList.toggle('hidden');
            } else if (action === 'select-all-multi') {
                const filterKey = button.dataset.filterKey;
                const dropdown = button.closest('.multi-select-dropdown');
                const checkboxes = dropdown.querySelectorAll('.multi-select-checkbox');
                checkboxes.forEach(cb => {
                    if (cb.closest('li').style.display !== 'none') {
                        cb.checked = true;
                        tempSelections[filterKey].add(cb.value);
                    }
                });
            } else if (action === 'deselect-all-multi') {
                const filterKey = button.dataset.filterKey;
                const dropdown = button.closest('.multi-select-dropdown');
                const checkboxes = dropdown.querySelectorAll('.multi-select-checkbox');
                checkboxes.forEach(cb => {
                     if (cb.closest('li').style.display !== 'none') {
                        cb.checked = false;
                        tempSelections[filterKey].delete(cb.value);
                    }
                });
            } else if (action === 'cancel-multi-select') {
                button.closest('.multi-select-dropdown').classList.add('hidden');
            } else if (action === 'confirm-multi-select') {
                const filterKey = button.dataset.filterKey;
                state.local.dashboardFilters[filterKey] = new Set(tempSelections[filterKey]);
                button.closest('.multi-select-dropdown').classList.add('hidden');
                renderDashboardFilters();
                renderDashboardTable();
            }
        });

        // Hover popover for request id quick info/actions
        (function initDashboardHoverPopover(){
            const container = document.getElementById('dashboard-view');
            if (!container) return;

            let hideTimer = null;
            let suppressHover = false;
            let lastShownReqId = null;
            let lastAnchorEl = null;
            const popoverPageByReqId = Object.create(null);

            const hideLater = () => {
                const pop = document.getElementById('dashboard-hover-popover');
                if (!pop) return;
                if (hideTimer) clearTimeout(hideTimer);
                hideTimer = setTimeout(() => {
                    pop.classList.remove('show');
                    pop.style.visibility = 'hidden';
                    pop.style.display = 'none';
                }, 5000);
            };

            const showPopover = (target, reqId) => {
                const req = state.requests.find(r => r.id === reqId);
                if (!req) return;
                const applicant = state.users[req.applicant_id]?.name || '未知';
                const dept = req.department || '';
                const amount = Number(req.total_amount || 0).toLocaleString();
                const status = req.status || '';
                const handlerStatus = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                const closedStatus = req.closed_status || '未結案';
                const orderType = req.type || '特採';
                const itemsAll = (req.items || []).map(item => {
                    const product = state.allProducts?.find(p => p.id === item.id);
                    const imageUrl = product?.image ? `https://drive.google.com/thumbnail?id=${product.image}` : 'https://placehold.co/48x48?text=無';
                    const price = Number(item.price || 0);
                    return { imageUrl, name: item.name || '', qty: item.quantity || 0, unit: item.unit || '', price };
                });
                const pageSize = 5;
                const totalPages = Math.max(1, Math.ceil(itemsAll.length / pageSize));
                const currentPage = Math.min(totalPages, Math.max(1, popoverPageByReqId[req.id] || 1));
                const pageStart = (currentPage - 1) * pageSize;
                const items = itemsAll.slice(pageStart, pageStart + pageSize);
                const isCurrentApprover = (req.status === '待審核') && (req.approvers || []).find(a => a.status === 'pending')?.userId === state.currentUser.id;

                const pop = document.getElementById('dashboard-hover-popover');
                if (!pop) return;
                lastShownReqId = req.id;
                lastAnchorEl = target;
                pop.innerHTML = `
                    <button class="close-btn" data-action="close-popover" aria-label="關閉">×</button>
                    <div class="title">申請單 ${req.id}</div>
                    <div class="kv">
                        <div>申請人</div><div>${applicant}</div>
                        <div>部門</div><div>${dept}</div>
                        <div>申請日期</div><div>${getFormattedDateTime(req.request_date)}</div>
                        <div>訂單類別</div><div><span class="px-2 py-0.5 rounded-full text-[10px] font-medium ${orderType === '特採' ? 'bg-pink-100 text-pink-800' : 'bg-teal-100 text-teal-800'}">${orderType}</span></div>
                        <div>簽核狀態</div><div>${status}</div>
                        <div>經辦狀態</div><div>${handlerStatus}</div>
                        <div>結案狀態</div><div>${closedStatus}</div>
                        <div>總金額</div><div>$${amount}</div>
                    </div>
                    ${itemsAll.length ? `
                    <div class="mt-2">
                        <div class="text-xs text-gray-500 mb-1">品項</div>
                        <div class="space-y-2">
                            ${items.map(it => `
                                <div class="flex items-center space-x-2">
                                    <img src="${it.imageUrl}" alt="${it.name}" class="w-10 h-10 rounded object-cover border" onerror="this.onerror=null;this.src='https://placehold.co/48x48?text=無';"/>
                                    <div class="flex-1">
                                        <div class="text-sm truncate" title="${it.name}">${it.name}</div>
                                        <div class="text-xs text-gray-500">${it.qty} ${it.unit} · 單價 $${Number(it.price || 0).toLocaleString()}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${totalPages > 1 ? `
                        <div class="mt-2 flex items-center justify-start gap-2">
                            <span class="text-xs text-gray-500">檢視分頁</span>
                            ${Array.from({length: totalPages}).map((_, i) => {
                                const p = i + 1;
                                const isCurrent = p === currentPage;
                                return `<button class=\"btn ${isCurrent ? 'bg-blue-500 text-white' : ''}\" data-action=\"popover-page\" data-id=\"${req.id}\" data-page=\"${p}\">${p}</button>`;
                            }).join('')}
                        </div>` : ''}
                    </div>` : ''}
                    <div class="actions">
                        <div class="flex gap-2 flex-wrap w-full">
                            <button class="btn" data-action="view-detail" data-id="${req.id}">開啟</button>
                            <button class="btn" data-action="print-request" data-id="${req.id}">列印</button>
                            <button class="btn" data-action="copy-id" data-id="${req.id}">複製單號</button>
                        </div>
                        <div class="flex gap-2 flex-wrap w-full mt-1">
                            ${isCurrentApprover ? `<button class="btn" data-action="quick-approve" data-id="${req.id}">核准</button>` : ''}
                            ${isCurrentApprover ? `<button class="btn" data-action="quick-reject" data-id="${req.id}">退回</button>` : ''}
                            ${(() => {
                                const canHandle = (handlerStatus === '待經辦') && ((state.currentUser.id === req.handler_id) || state.currentUser.role === '採購' || state.currentUser.role === '採購主管' || state.currentUser.is_admin) && closedStatus !== '結案';
                                return canHandle ? `<button class=\"btn\" data-action=\"quick-handle\" data-id=\"${req.id}\">經辦</button>` : '';
                            })()}
                            ${(() => {
                                const canClose = (handlerStatus === '已經辦') && (state.currentUser.role === '採購' || state.currentUser.role === '採購主管' || state.currentUser.is_admin) && closedStatus !== '結案' && status === '已核准';
                                return canClose ? `<button class=\"btn\" data-action=\"quick-close\" data-id=\"${req.id}\">結案</button>` : '';
                            })()}
                        </div>
                    </div>`;

                // 暫時顯示以量測寬度，再定位
                pop.style.visibility = 'hidden';
                pop.style.display = 'block';
                const rect = target.getBoundingClientRect();
                const measuredWidth = pop.offsetWidth || 340;
                const measuredHeight = pop.offsetHeight || 200;
                // 預設顯示在目標右側，若超出視窗則顯示在左側；垂直位置置中（固定定位，不使用捲動偏移）
                let top = Math.max(12, (window.innerHeight - measuredHeight) / 2);
                let left = rect.right + 8;
                const overflowRight = left + measuredWidth > window.innerWidth - 12;
                if (overflowRight) {
                    left = rect.left - measuredWidth - 8;
                }
                // 垂直位置限制在可視範圍內
                const minTop = 12;
                const maxTop = window.innerHeight - measuredHeight - 12;
                top = Math.max(minTop, Math.min(top, maxTop));
                pop.style.top = `${top}px`;
                pop.style.left = `${left}px`;
                pop.style.visibility = 'visible';
                pop.classList.add('show');
            };

            container.addEventListener('mouseover', (e) => {
                const overPopover = e.target.closest('#dashboard-hover-popover');
                if (overPopover) {
                    if (hideTimer) clearTimeout(hideTimer);
                    return;
                }
                const t = e.target.closest('.request-id-hover');
                if (!t) return;
                if (suppressHover && t.dataset.requestId === lastShownReqId) return;
                if (hideTimer) clearTimeout(hideTimer);
                showPopover(t, t.dataset.requestId);
            });

            container.addEventListener('mouseout', (e) => {
                const pop = document.getElementById('dashboard-hover-popover');
                if (!pop) { return; }
                const leavingTo = e.relatedTarget;
                const goingIntoPopover = leavingTo && pop.contains(leavingTo);
                const goingIntoTrigger = leavingTo && leavingTo.closest && leavingTo.closest('.request-id-hover');
                if (goingIntoPopover || goingIntoTrigger) {
                    if (hideTimer) clearTimeout(hideTimer);
                    return;
                }
                // 滑鼠離開觸發元素與 Popover，3 秒後自動關閉（若期間又移入則取消）
                hideLater();
                suppressHover = false;
            });

            // Handle actions inside popover via delegation
            container.addEventListener('click', async (e) => {
                const closeBtn = e.target.closest('#dashboard-hover-popover .close-btn');
                if (closeBtn) {
                    const pop = document.getElementById('dashboard-hover-popover');
                    if (pop) {
                        pop.classList.remove('show');
                        pop.style.visibility = 'hidden';
                        pop.style.display = 'none';
                    }
                    suppressHover = true;
                    return;
                }
                const pageBtn = e.target.closest('#dashboard-hover-popover [data-action="popover-page"]');
                if (pageBtn) {
                    const id = pageBtn.getAttribute('data-id');
                    const page = parseInt(pageBtn.getAttribute('data-page'), 10) || 1;
                    popoverPageByReqId[id] = page;
                    if (lastAnchorEl) {
                        showPopover(lastAnchorEl, id);
                    }
                    return;
                }
                const btn = e.target.closest('#dashboard-hover-popover .btn');
                if (!btn) return;
                const act = btn.dataset.action;
                const id = btn.dataset.id;
                if (act === 'copy-id') {
                    try {
                        await navigator.clipboard.writeText(id);
                        showMessage('已複製單號');
                    } catch (err) {
                        try {
                            const ta = document.createElement('textarea');
                            ta.value = id;
                            ta.style.position = 'fixed';
                            ta.style.top = '-9999px';
                            ta.setAttribute('readonly', '');
                            document.body.appendChild(ta);
                            ta.select();
                            ta.setSelectionRange(0, ta.value.length);
                            const ok = document.execCommand('copy');
                            document.body.removeChild(ta);
                            if (ok) {
                                showMessage('已複製單號');
                            } else {
                                throw new Error('execCommand copy failed');
                            }
                        } catch (err2) {
                            showMessage('複製失敗，請手動複製。', 'error');
                        }
                    }
                } else if (act === 'view-detail') {
                    const req = state.requests.find(r => r.id === id);
                    if (req) {
                        updateState({ view: 'detailView', selectedRequest: req });
                    }
                } else if (act === 'print-request') {
                    printRequest(id);
                } else if (act === 'quick-approve') {
                    // 直接核准當前步驟（若符合資格）
                    const req = state.requests.find(r => r.id === id);
                    if (!req) return;
                    const current = (req.approvers || []).find(a => a.status === 'pending');
                    if (!(req.status === '待審核' && current?.userId === state.currentUser.id)) {
                        showMessage('您不是此單目前的簽核人。', 'error');
                        return;
                    }
                    try {
                        const approvers = [...req.approvers];
                        const idx = approvers.findIndex(a => a.status === 'pending');
                        if (idx === -1) return;
                        approvers[idx].status = 'approved';
                        approvers[idx].date = new Date().toISOString();
                        approvers[idx].comment = '';
                        const isFinal = idx === approvers.length - 1;
                        const updateData = {
                            approvers,
                            status: isFinal ? '已核准' : '待審核',
                            ...(isFinal ? (() => {
                                const handlerUser = Object.values(state.users).find(u => u.is_handler);
                                return { handler_status: '待經辦', handler_id: handlerUser ? handlerUser.id : null };
                            })() : {})
                        };
                        const { data: updated, error } = await supabase.from('requests').update(updateData).eq('id', id).select().single();
                        if (error) throw error;
                        // 通知申請人與（若是最後一關）經辦
                        try {
                            const msg = isFinal ? `您的申請單 ${id} 已全數簽核完成！` : `您的申請單 ${id} 已由 ${state.currentUser.name} 核准。`;
                            await supabase.from('notifications').insert({ user_id: req.applicant_id, request_id: id, message: msg, is_read: false });
                            if (isFinal && updateData.handler_id) {
                                await supabase.from('notifications').insert({ user_id: updateData.handler_id, request_id: id, message: `您被指派經辦申請單 ${id}，請儘速處理。`, is_read: false });
                            }
                        } catch {}
                        const newRequests = state.requests.map(r => r.id === id ? updated : r);
                        getFilteredRequests.resetCache?.();
                        updateState({ requests: newRequests });
                        showMessage('已核准');
                    } catch (err) {
                        showMessage('核准失敗: ' + err.message, 'error');
                    }
                } else if (act === 'quick-reject') {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">退回申請</h3>
                        <label for="popover-rejection-reason" class="block text-sm font-medium text-gray-700">退回理由：</label>
                        <textarea id="popover-rejection-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                            <button data-action="confirm-popover-reject-previous" data-id="${id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-yellow-500 text-white">退回上一層</button>
                            <button data-action="confirm-popover-reject-all" data-id="${id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">整筆退單</button>
                        </div>
                    `);
                } else if (act === 'quick-handle') {
                    const req = state.requests.find(r => r.id === id);
                    if (!req) return;
                    const effectiveHandlerStatus = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                    const canHandle = (req.status === '已核准') && (effectiveHandlerStatus === '待經辦') && ((state.currentUser.id === req.handler_id) || state.currentUser.is_admin || ['採購','採購主管'].includes(state.currentUser.role)) && (req.closed_status !== '結案');
                    if (!canHandle) { showMessage('目前狀態不可經辦或您無權限。', 'error'); return; }
                    try {
                        const newHistoryEntry = { 
                            user: state.currentUser.name, 
                            userId: state.currentUser.id,
                            role: state.currentUser.role, 
                            date: new Date().toISOString(), 
                            reason: '經辦完成', 
                            action: 'handled', 
                            comment: '' 
                        };
                        const patch = { handler_status: '已經辦', modification_history: [...(req.modification_history || []), newHistoryEntry] };
                        const { data: updated, error } = await supabase.from('requests').update(patch).eq('id', id).select().single();
                        if (error) throw error;
                        // 通知申請人與經辦群組
                        const notifs = [];
                        notifs.push({ user_id: req.applicant_id, request_id: req.id, message: `您的申請單 ${req.id} 已由 ${state.currentUser.name} 完成經辦。`, is_read: false });
                        const handlerUsers = Object.values(state.users).filter(u => u.is_handler);
                        handlerUsers.forEach(u => notifs.push({ user_id: u.id, request_id: req.id, message: `申請單 ${req.id} 已由 ${state.currentUser.name} 完成經辦。`, is_read: false }));
                        if (notifs.length) { await supabase.from('notifications').insert(notifs); }
                        const newRequests = state.requests.map(r => r.id === id ? updated : r);
                        getFilteredRequests.resetCache?.();
                        updateState({ requests: newRequests });
                        showMessage('已完成經辦');
                        // 關閉 Popover
                        const pop = document.getElementById('dashboard-hover-popover');
                        if (pop) { pop.classList.remove('show'); pop.style.visibility = 'hidden'; pop.style.display = 'none'; }
                    } catch (err) {
                        showMessage('經辦失敗: ' + err.message, 'error');
                    }
                } else if (act === 'quick-close') {
                    const req = state.requests.find(r => r.id === id);
                    if (!req) return;
                    const effectiveHandlerStatus = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                    const canClose = (req.status === '已核准') && (effectiveHandlerStatus === '已經辦') && (req.closed_status !== '結案') && (state.currentUser.is_admin || ['採購','採購主管'].includes(state.currentUser.role));
                    if (!canClose) { showMessage('目前狀態不可結案或您無權限。', 'error'); return; }
                    try {
                        const newHistoryEntry = { 
                            user: state.currentUser.name, 
                            userId: state.currentUser.id,
                            role: state.currentUser.role, 
                            date: new Date().toISOString(), 
                            reason: '結案', 
                            action: 'closed' 
                        };
                        const patch = { closed_status: '結案', modification_history: [...(req.modification_history || []), newHistoryEntry] };
                        const { data: updated, error } = await supabase.from('requests').update(patch).eq('id', id).select().single();
                        if (error) throw error;
                        const newRequests = state.requests.map(r => r.id === id ? updated : r);
                        getFilteredRequests.resetCache?.();
                        updateState({ requests: newRequests });
                        showMessage('已結案');
                        const pop = document.getElementById('dashboard-hover-popover');
                        if (pop) { pop.classList.remove('show'); pop.style.visibility = 'hidden'; pop.style.display = 'none'; }
                    } catch (err) {
                        showMessage('結案失敗: ' + err.message, 'error');
                    }
                }
            });
        })();

        document.getElementById('dashboard-view').addEventListener('change', (e) => {
            const target = e.target;
            if (target.matches('.filter-change')) {
                state.local.selectedRequestIds.clear();
                state.local.currentPage = 1;
                state.local.dashboardFilters[target.dataset.filter] = target.value;
                renderDashboard();
            } else if (target.matches('.request-checkbox')) {
                const id = target.dataset.id;
                if (target.checked) {
                    state.local.selectedRequestIds.add(id);
                } else {
                    state.local.selectedRequestIds.delete(id);
                }
                renderDashboard();
            } else if (target.matches('.multi-select-checkbox')) {
                const filterKey = target.dataset.filterKey;
                const value = target.value;
                if (target.checked) {
                    tempSelections[filterKey].add(value);
                } else {
                    tempSelections[filterKey].delete(value);
                }
            }
        });

        document.getElementById('dashboard-view').addEventListener('keyup', (e) => {
            if (e.target.matches('.multi-select-search')) {
                const searchTerm = e.target.value.toLowerCase();
                const listItems = e.target.nextElementSibling.querySelectorAll('li');
                listItems.forEach(li => {
                    const label = li.querySelector('span').textContent.toLowerCase();
                    const value = li.querySelector('input').value.toLowerCase();
                    if (label.includes(searchTerm) || value.includes(searchTerm)) {
                        li.style.display = '';
                    } else {
                        li.style.display = 'none';
                    }
                });
            }
        });

        document.getElementById('newRequest-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'switch-category') {
                state.local.activeProductCategory = button.dataset.category;
                state.local.newRequestSearchTerm = '';
                state.local.newRequestCurrentPage = 1; // Reset page on category change
                const searchInput = document.getElementById('new-request-product-search');
                if (searchInput) searchInput.value = '';
                
                document.querySelectorAll('#newRequest-view .product-category-btn').forEach(btn => {
                    btn.classList.toggle('border-blue-500', btn === button);
                    btn.classList.toggle('text-blue-600', btn === button);
                });
                renderProductList();
            } else if (action === 'toggle-layout-scale') {
                const scale = button.dataset.scale;
                state.local.layoutScale = scale;
                renderNewRequest(); // 重新渲染整個頁面以應用新的布局
            } else if (action === 'product-page-change') {
                const page = parseInt(button.dataset.page, 10);
                if (page) {
                    updateState({ local: { ...state.local, newRequestCurrentPage: page } });
                }
            } else if (action === 'add-to-cart') {
                const product = JSON.parse(button.dataset.product);
                const quantityInput = button.previousElementSibling;
                const quantity = parseInt(quantityInput.value, 10);
                if (quantity > 0) {
                    const existingItem = state.local.newRequestCart.find(item => item.id === product.id);
                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        state.local.newRequestCart.push({ 
                            ...product, 
                            quantity, 
                            is_scrap_work_order: false, 
                            work_order_number: '',
                            demand_department: state.currentUser.demand_department || state.currentUser.department || '',
                            // 預先帶入預設發票開立，確保未操作也能正確寫入
                            invoice: state.currentUser.default_invoice || '',
                            custom_invoice: '',
                            reason: '新增',
                            description: ''
                        });
                    }
                    quantityInput.value = 1;
                    renderNewRequestSidebar();
                } else {
                    showMessage('請輸入品項數量', 'error');
                }
            } else if (action === 'upload-attachments') {
                const fileInput = document.getElementById('request-attachment-input');
                const files = Array.from(fileInput.files || []);
                if (!files.length) {
                    showMessage('請先選擇要上傳的附件。', 'error');
                    return;
                }
                // 檔案大小檢查（每檔 1MB）
                const overs = files.filter(f => f.size > MAX_FILE_SIZE_BYTES);
                if (overs.length) {
                    const names = overs.map(f => `${f.name}（${f.size.toLocaleString()} bytes）`).join(', ');
                    showMessage(`以下檔案超過 1MB 上限，請移除後再上傳：${names}`, 'error');
                    return;
                }
                button.disabled = true;
                button.textContent = '上傳中...';
                try {
                    const baseUrl = (window.getSupabaseBaseUrl && window.getSupabaseBaseUrl()) || '';
                    if (!baseUrl) throw new Error('未設定 SUPABASE_URL');
                    const session = (await supabase.auth.getSession()).data?.session;
                    const token = session?.access_token || (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                    const apikey = (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));

                    const uploaded = [];
                    const tryUploadViaFetch = async (formData, attempt = 1) => {
                        const urlPrimary = `${baseUrl}/functions/v1/${ATTACHMENT_UPLOAD_FN}`;
                        // 另一路徑：functions 子網域（某些部署允許僅此來源）
                        const projectRef = (() => {
                            try { return new URL(baseUrl).hostname.split('.')[0]; } catch { return null; }
                        })();
                        const altUrl = projectRef ? `https://${projectRef}.functions.supabase.co/${ATTACHMENT_UPLOAD_FN}` : null;
                        const endpoints = [urlPrimary, altUrl].filter(Boolean);
                        let lastErr;
                        for (const ep of endpoints) {
                            try {
                                // 1) 嘗試簡單請求（不帶自訂標頭，避免預檢）
                                try {
                                    const resSimple = await fetch(ep, {
                                        method: 'POST',
                                        mode: 'cors',
                                        cache: 'no-store',
                                        body: formData,
                                    });
                                    if (resSimple.ok) return await resSimple.json();
                                } catch (simpleErr) {
                                    // 記錄但不立即拋出，進入帶授權重試
                                    lastErr = simpleErr;
                                }

                                // 2) 攜帶授權標頭再試一次
                                const resAuth = await fetch(ep, {
                                    method: 'POST',
                                    headers: { Authorization: `Bearer ${token}`, apikey },
                                    mode: 'cors',
                                    cache: 'no-store',
                                    body: formData,
                                });
                                if (!resAuth.ok) {
                                    const text = await resAuth.text().catch(() => '');
                                    throw new Error(`HTTP ${resAuth.status} ${text}`);
                                }
                                return await resAuth.json();
                            } catch (e) {
                                lastErr = e;
                            }
                        }
                        // 短暫退避重試
                        if (attempt < 2) {
                            await new Promise(r => setTimeout(r, 600));
                            return tryUploadViaFetch(formData, attempt + 1);
                        }
                        throw lastErr || new Error('無法連線 Edge Function');
                    };

                    for (const file of files) {
                        if (file.size > MAX_FILE_SIZE_BYTES) {
                            // 加倍保險（理論上前面已篩掉）
                            continue;
                        }
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('applicant_id', state.currentUser?.id || '');
                        let data;
                        try {
                            // 1) 先走 fetch（最可控，避免 invoke 與 multipart 不相容情況）
                            data = await tryUploadViaFetch(formData);
                        } catch (fetchErr) {
                            console.warn('fetch 上傳失敗，嘗試 invoke 後備：', fetchErr);
                            try {
                                const inv = await supabase.functions.invoke(ATTACHMENT_UPLOAD_FN, { body: formData });
                                if (inv.error) throw inv.error;
                                data = inv.data;
                            } catch (invokeErr) {
                                // 彙整錯誤訊息
                                const reason = (fetchErr && fetchErr.message) ? fetchErr.message : (invokeErr?.message || '未知錯誤');
                                // 常見：CORS/Preflight 未允許 Authorization/apikey/POST/OPTIONS
                                throw new Error(`上傳失敗，可能為跨域/權限設定問題：${reason}`);
                            }
                        }
                        // 後端可能回傳多種欄位；以看起來像 Drive 檔案 id 的值為準，避免把資料庫 id 誤當檔案 id
                        const urlCandidates = [
                            data?.url,
                            data?.signedUrl,
                            data?.downloadUrl,
                            data?.link,
                            data?.webViewLink,
                            data?.webContentLink,
                            data?.file?.url,
                            data?.result?.url,
                        ].filter((v) => typeof v === 'string');
                        let driveIdFromUrl = '';
                        for (const u of urlCandidates) {
                            const parsed = parseDriveRef(u);
                            if (parsed?.type === 'id' && isLikelyDriveId(parsed.value)) { driveIdFromUrl = parsed.value; break; }
                        }

                        const candidates = [
                            data?.fileId,
                            data?.driveFileId,
                            data?.drive_id,
                            data?.result?.id,
                            data?.file?.id,
                            data?.id,
                            driveIdFromUrl,
                        ].filter((v) => typeof v === 'string');
                        const driveId = candidates.find(isLikelyDriveId) || '';
                        // 為保相容性，若後端僅回傳資料庫主鍵（UUID），仍保留該 id，但另存 driveId（若有）
                        const fallbackId = data?.id || data?.file?.id || data?.result?.id || data?.fileId || '';
                        const chosenId = driveId || fallbackId;
                        if (!chosenId) throw new Error('上傳失敗：未取得檔案 ID');
                        const fileMeta = (data && (data.file || data)) || {};
                        const name = fileMeta.name || file.name;
                        const size = fileMeta.size || file.size;
                        const mimeType = fileMeta.mimeType || file.type;
                        const attObj = { id: chosenId, name, size, mimeType, uploaded_at: new Date().toISOString() };
                        if (driveId) attObj.driveId = driveId;
                        uploaded.push(attObj);
                    }

                    state.local.newRequestAttachments = [...(state.local.newRequestAttachments || []), ...uploaded];
                    // 清空檔案選擇
                    fileInput.value = '';
                    const filenameSpan = document.getElementById('request-attachment-filename');
                    filenameSpan.textContent = '未選擇檔案';
                    button.textContent = '上傳附件';
                    showMessage(`已上傳 ${uploaded.length} 個附件`);
                    renderNewRequestSidebar();
                } catch (err) {
                    console.error('附件上傳失敗:', err);
                    let msg = String(err?.message || err || '未知錯誤');
                    const lower = msg.toLowerCase();
                    if (lower.includes('storagequotaexceeded') || lower.includes('service accounts do not have storage quota')) {
                        msg += '\n建議：\n1) 將 Service Account 加入 Google 共用雲端硬碟並給予至少「內容管理員」權限；\n2) 將 DRIVE_FOLDER_ID 設為該共用雲端硬碟中的資料夾 ID；\n3) 後端上傳請求加上 supportsAllDrives=true；\n或採用網域委派（Domain-wide Delegation）並以使用者身分上傳。';
                    }
                    showMessage('附件上傳失敗：' + msg, 'error');
                    button.textContent = '上傳附件';
                } finally {
                    button.disabled = false;
                }
            } else if (action === 'remove-attachment') {
                const idx = parseInt(button.dataset.index, 10);
                if (!isNaN(idx)) {
                    const att = (state.local.newRequestAttachments || [])[idx];
                    // 先樂觀更新 UI
                    const removed = state.local.newRequestAttachments.splice(idx, 1);
                    renderNewRequestSidebar();

                    // 僅對已上傳至雲端且具有 id 的檔案發出刪除請求
                    if (att && (att.driveId || att.id)) {
                        (async () => {
                            const rollback = () => {
                                if (removed && removed.length) {
                                    state.local.newRequestAttachments.splice(idx, 0, removed[0]);
                                    renderNewRequestSidebar();
                                }
                            };
                            try {
                                const baseUrl = (window.getSupabaseBaseUrl && window.getSupabaseBaseUrl()) || '';
                                if (!baseUrl) throw new Error('未設定 SUPABASE_URL');
                                const session = (await supabase.auth.getSession()).data?.session;
                                const token = session?.access_token || (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                                const apikey = (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));

                                // 解析出應刪除的 Drive 檔案 ID（優先 driveId，其次 att.id 若像 Drive ID，最後嘗試從 URL 提取）
                                const toDeleteId = (() => {
                                    if (att.driveId && isLikelyDriveId(att.driveId)) return att.driveId;
                                    if (att.id && isLikelyDriveId(att.id)) return att.id;
                                    // 嘗試從 URL 類字串抽取 /?id= 或 /d/{id}
                                    if (att.url && typeof att.url === 'string') {
                                        try {
                                            const u = new URL(att.url);
                                            const qid = u.searchParams.get('id');
                                            if (qid && isLikelyDriveId(qid)) return qid;
                                            const m = u.pathname.match(/\/d\/([A-Za-z0-9_-]{15,})/);
                                            if (m && m[1] && isLikelyDriveId(m[1])) return m[1];
                                        } catch {}
                                    }
                                    return att.id; // 退回原值（後端若能兼容會自行判斷）
                                })();

                                const projectRef = (() => { try { return new URL(baseUrl).hostname.split('.')[0]; } catch { return null; } })();
                                const primary = `${baseUrl}/functions/v1/${ATTACHMENT_DELETE_FN}?id=${encodeURIComponent(toDeleteId)}`;
                                const alt = projectRef ? `https://${projectRef}.functions.supabase.co/${ATTACHMENT_DELETE_FN}?id=${encodeURIComponent(toDeleteId)}` : null;
                                const endpoints = [primary, alt].filter(Boolean);

                                let lastErr;
                                const errs = [];
                                // 1) 嘗試 DELETE（帶授權）
                                for (const ep of endpoints) {
                                    try {
                                        const res = await fetch(ep, { method: 'DELETE', headers: { Authorization: `Bearer ${token}`, apikey } });
                                        if (res.ok) {
                                            // 追加驗證：檢查是否真的刪除
                                            const stillExists = !(await verifyDriveDeleted(toDeleteId));
                                            if (stillExists) {
                                                console.warn('後端回覆成功，但檔案仍可取用：', toDeleteId);
                                                showMessage(`注意：刪除回覆成功，但檔案仍可存取（id: ${toDeleteId}）。請檢查後端是否以 Drive 檔案 ID 刪除。`, 'error');
                                            }
                                            return; // 成功
                                        }
                                        // 盡量解析錯誤內容，協助除錯（例如 Edge Function 轉出 Drive 錯誤細節）
                                        let t = '';
                                        try { t = await res.text(); } catch {}
                                        let brief = '';
                                        try {
                                            const j = t ? JSON.parse(t) : null;
                                            if (j) {
                                                // 常見欄位：message / error / driveError { status, body }
                                                const drv = j.driveError || j.drive_error || j.drive;
                                                if (drv && (drv.status || drv.body)) {
                                                    const bodyStr = typeof drv.body === 'string' ? drv.body : JSON.stringify(drv.body || {});
                                                    brief = `Drive ${drv.status || ''} ${bodyStr}`.trim();
                                                } else if (j.message || j.error) {
                                                    brief = String(j.message || j.error);
                                                } else {
                                                    brief = JSON.stringify(j);
                                                }
                                            }
                                        } catch (_) {
                                            brief = (t || '').slice(0, 300);
                                        }
                                        const rid = res.headers?.get?.('sb_request_id') || res.headers?.get?.('x-sb-request-id') || '';
                                        const host = (() => { try { return new URL(ep).host; } catch { return ep; } })();
                                        const msg = `${host}: HTTP ${res.status}${brief ? ' - ' + brief : ''}${rid ? ` (sb_request_id: ${rid})` : ''}`;
                                        errs.push(msg);
                                        throw new Error(msg);
                                    } catch (e) {
                                        lastErr = e;
                                    }
                                }
                                // 2) 後備：使用 invoke 以 POST 傳遞（需後端允許 POST 刪除）
                                try {
                                    const inv = await supabase.functions.invoke(ATTACHMENT_DELETE_FN, { body: { id: toDeleteId } });
                                    if (inv.error) {
                                        // 盡量擷取錯誤訊息
                                        const invMsg = inv.error?.message || inv.error?.name || 'invoke error';
                                        errs.push(`invoke: ${invMsg}`);
                                        throw new Error(invMsg);
                                    }
                                    return; // 成功
                                } catch (e) {
                                    lastErr = e;
                                }

                                // 將所有錯誤彙整輸出，避免遺失較早的 4xx/5xx 訊息
                                const combined = errs.length ? `刪除失敗：\n- ${errs.join('\n- ')}` : (lastErr?.message || '刪除失敗（無可用端點）');
                                throw new Error(combined);
                            } catch (err) {
                                console.error('刪除附件檔案失敗：', err);
                                // 將關鍵錯誤碼/片段呈現給使用者，利於回報（避免過長）
                                const m = String(err?.message || err || '未知錯誤');
                                const short = m.length > 240 ? m.slice(0, 240) + '…' : m;
                                showMessage(`雲端附件刪除失敗：${short}`, 'error');
                                rollback();
                            }
                        })();
                    }
                }
            } else if (action === 'submit-request' || action === 'save-request') {
                const isSubmitting = action === 'submit-request';
                const { newRequestCart } = state.local;

                if (newRequestCart.length > 0) {
                    updateState({ loading: true });
                    try {
                        const totalAmount = Math.round(newRequestCart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)) + (item.freight || 0) + (item.discount || 0), 0));
                        // 讀 DOM 可確保最新輸入；若無 DOM 則退回本地暫存
                        const reasonInputEl = document.getElementById('request-reason');
                        const reason = reasonInputEl ? reasonInputEl.value : (state.local.requestReason || '');
                        
                        const applicant = state.currentUser;
                        const allUsers = state.users;
                        const approvers = [];
                        
                        if (isSubmitting) {
                            let step = 1;
                            // 第一階段：請購階段簽核（申請人主管鏈）
                            if (applicant && applicant.manager_id) {
                                const m1 = Object.values(allUsers).find(u => u.id === applicant.manager_id);
                                if (m1) approvers.push({ step: step++, role: '申請人直屬主管', userId: m1.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            if (applicant && applicant.manager_id2) {
                                const m2 = Object.values(allUsers).find(u => u.id === applicant.manager_id2);
                                if (m2) approvers.push({ step: step++, role: '申請人第二主管', userId: m2.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            if (applicant && applicant.manager_id3) {
                                const m3 = Object.values(allUsers).find(u => u.id === applicant.manager_id3);
                                if (m3) approvers.push({ step: step++, role: '申請人第三主管', userId: m3.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            // 第二階段：院長簽核（依部門門檻金額）
                            const departmentThreshold = state.departments[applicant.department] || Infinity;
                            if (totalAmount > departmentThreshold) {
                                const director = Object.values(allUsers).find(u => u.role === '院長');
                                if (director) approvers.push({ step: step++, role: '院長', userId: director.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            // 第三階段：採購階段簽核
                            // a. 第一關角色 = 採購
                            // b. 第二關 ~ 第四關依「採購」的 manager_id/manager_id2/manager_id3 產生：採購直屬主管、採購第二主管、採購第三主管
                            const purchasingStaff = Object.values(allUsers).find(u => u.role === '採購');
                            if (purchasingStaff) {
                                // 第三階段-第一關：採購
                                approvers.push({ step: step++, role: '採購', userId: purchasingStaff.id, status: 'pending', date: '', reason: '', comment: '' });
                                // 採購直屬主管
                                if (purchasingStaff.manager_id) {
                                    const pm1 = Object.values(allUsers).find(u => u.id === purchasingStaff.manager_id);
                                    if (pm1) approvers.push({ step: step++, role: '採購直屬主管', userId: pm1.id, status: 'pending', date: '', reason: '', comment: '' });
                                }
                                // 採購第二主管
                                if (purchasingStaff.manager_id2) {
                                    const pm2 = Object.values(allUsers).find(u => u.id === purchasingStaff.manager_id2);
                                    if (pm2) approvers.push({ step: step++, role: '採購第二主管', userId: pm2.id, status: 'pending', date: '', reason: '', comment: '' });
                                }
                                // 採購第三主管
                                if (purchasingStaff.manager_id3) {
                                    const pm3 = Object.values(allUsers).find(u => u.id === purchasingStaff.manager_id3);
                                    if (pm3) approvers.push({ step: step++, role: '採購第三主管', userId: pm3.id, status: 'pending', date: '', reason: '', comment: '' });
                                }
                            }
                            // 第四階段：經辦/結案（不加入 approvers，由經辦狀態與結案狀態驅動）
                        }

                        // 確保每個品項的發票資訊正確寫入（若未選擇則帶入個人預設）
                        const itemsToSave = newRequestCart.map(item => {
                            const invoiceVal = (item.invoice === undefined || item.invoice === null || item.invoice === '')
                                ? (state.currentUser.default_invoice || '')
                                : item.invoice;
                            const customVal = invoiceVal === '其他' ? (item.custom_invoice || '') : '';
                            return { ...item, invoice: invoiceVal, custom_invoice: customVal };
                        });

                        const requestData = {
                            applicant_id: state.currentUser.id, 
                            applicant_name: state.currentUser.name,
                            department: state.currentUser.department,
                            items: itemsToSave, 
                            type: state.local.newRequestOrderType || (state.editingRequest?.type) || '特採', 
                            status: isSubmitting ? '待審核' : '待送出', 
                            total_amount: totalAmount,
                            reason: reason,
                            approvers: approvers,
                            attachments: state.local.newRequestAttachments || [],
                            request_date: new Date().toISOString()
                        };

                        if (state.editingRequest) {
                            // 更新草稿
                            const { data, error } = await supabase.from('requests').update(requestData).eq('id', state.editingRequest.id).select();
                            if(error) throw error;
                            console.log('草稿更新成功:', data);
                        } else {
                            // 新增申請 - 生成 SPYYYYMMDDXXX 格式的 ID
                            try {
                                // 先嘗試不設定 ID
                                const { data, error } = await supabase.from('requests').insert(requestData).select();
                                if(error) throw error;
                                console.log('新申請創建成功:', data);
                            } catch (err) {
                                if (err.message.includes('null value in column "id"')) {
                                    // 資料庫需要手動設定 ID，生成 SPYYYYMMDDXXX 格式
                                    const now = new Date();
                                    const year = now.getFullYear();
                                    const month = String(now.getMonth() + 1).padStart(2, '0');
                                    const day = String(now.getDate()).padStart(2, '0');
                                    const datePrefix = `SP${year}${month}${day}`;
                                    
                                    // 查詢今天已有的申請單，找出最大流水號
                                    const { data: todayRequests, error: queryError } = await supabase
                                        .from('requests')
                                        .select('id')
                                        .like('id', `${datePrefix}%`)
                                        .order('id', { ascending: false })
                                        .limit(1);
                                    
                                    if (queryError) throw queryError;
                                    
                                    let sequenceNumber = 1;
                                    if (todayRequests && todayRequests.length > 0) {
                                        const lastId = todayRequests[0].id;
                                        const lastSequence = parseInt(lastId.substring(datePrefix.length));
                                        sequenceNumber = isNaN(lastSequence) ? 1 : lastSequence + 1;
                                    }
                                    
                                    const newId = `${datePrefix}${String(sequenceNumber).padStart(3, '0')}`;
                                    requestData.id = newId;
                                    
                                    const { data, error } = await supabase.from('requests').insert(requestData).select();
                                    if(error) throw error;
                                    console.log('新申請創建成功 (SPYYYYMMDDXXX格式):', data);
                                } else {
                                    throw err;
                                }
                            }
                        }
                        
                        // 清空購物車並重置編輯狀態
                        state.local.newRequestCart = [];
                        state.editingRequest = null;
                        
                        // 清空本地「總說明(選填)」暫存，避免成為下一張新單的預設值（草稿內容已寫入資料庫）
            updateState({ 
                            loading: false,
                            local: { 
                                ...state.local, 
                                newRequestCart: [], 
                requestReason: '',
                newRequestOrderType: undefined,
                newRequestAttachments: []
                            }
                        });
                        showMessage(isSubmitting ? '申請單已成功送出！' : '草稿已儲存！');
                        
                        // 清除緩存並重新載入資料，確保顯示最新的申請單
                        CacheManager.clear('dashboard_data');
                        await loadDashboardData(true, false); // 強制不使用緩存
                        
                        // 重置篩選緩存
                        getFilteredRequests.resetCache();
                        
                        // 確保重新渲染，無論視圖是否改變
                        requestAnimationFrame(() => {
                            render();
                        });

                    } catch (err) {
                        console.error("Error saving/submitting request:", err);
                        showMessage('操作失敗: ' + err.message, 'error');
                        updateState({ loading: false });
                    }
                } else {
                    showMessage('請先添加品項到申請單中', 'error');
                }
            } else if (action === 'remove-from-cart') {
                // 找到真正的滾動容器
                const cartItemsContainer = document.querySelector('.cart-items');
                const currentScrollTop = cartItemsContainer ? cartItemsContainer.scrollTop : 0;
                
                const productId = button.dataset.id;
                state.local.newRequestCart = state.local.newRequestCart.filter(item => item.id != productId);
                
                renderNewRequestSidebar();
                
                // 正確的滾動位置恢復機制
                const restoreScrollPosition = () => {
                    const newCartItemsContainer = document.querySelector('.cart-items');
                    if (newCartItemsContainer) {
                        newCartItemsContainer.scrollTop = currentScrollTop;
                    }
                };
                
                // 多次嘗試恢復，確保成功
                requestAnimationFrame(() => {
                    restoreScrollPosition();
                    setTimeout(restoreScrollPosition, 0);
                    setTimeout(restoreScrollPosition, 10);
                    setTimeout(restoreScrollPosition, 50);
                    setTimeout(restoreScrollPosition, 100);
                });
            } else if (action === 'search-new-request-product') {
                const searchTerm = document.getElementById('new-request-product-search').value;
                const searchAll = document.getElementById('new-request-search-all-checkbox').checked;
                updateState({ local: { ...state.local, newRequestSearchTerm: searchTerm, newRequestSearchAll: searchAll, newRequestCurrentPage: 1 } });
            } else if (action === 'toggle-favorite') {
                const productId = button.dataset.productId;
                const favorites = state.local.favoriteProductIds;
                if (favorites.has(productId)) {
                    favorites.delete(productId);
                } else {
                    favorites.add(productId);
                }
                saveFavoritesToDb(state.currentUser.id, favorites);
                renderProductList();
            }
        });

        document.getElementById('newRequest-view').addEventListener('change', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const itemId = target.dataset.id;
            const itemInCart = state.local.newRequestCart.find(item => item.id == itemId);

            // 附件選擇
            if (target.id === 'request-attachment-input') {
                const files = Array.from(target.files || []);
                const filenameSpan = document.getElementById('request-attachment-filename');
                const uploadBtn = document.querySelector('[data-action="upload-attachments"]');
                if (files.length) {
                    const overs = files.filter(f => f.size > MAX_FILE_SIZE_BYTES);
                    filenameSpan.textContent = files.map(f => f.name).join(', ');
                    if (overs.length) {
                        const overNames = overs.map(f => `${f.name}（>${(MAX_FILE_SIZE_BYTES/1024/1024).toFixed(0)}MB）`).join(', ');
                        filenameSpan.textContent += ` ｜ 超出上限：${overNames}`;
                        if (uploadBtn) uploadBtn.disabled = true;
                        showMessage('有檔案超過 1MB，上傳已停用。請移除超大檔案後再試。', 'error');
                    } else {
                        if (uploadBtn) uploadBtn.disabled = false;
                    }
                } else {
                    filenameSpan.textContent = '未選擇檔案';
                    if (uploadBtn) uploadBtn.disabled = true;
                }
                return;
            }

            if (!itemInCart) return;

            if (action === 'update-cart-quantity') {
                // 找到真正的滾動容器
                const cartItemsContainer = document.querySelector('.cart-items');
                const currentScrollTop = cartItemsContainer ? cartItemsContainer.scrollTop : 0;
                
                const newQuantity = parseInt(target.value, 10);
                if (newQuantity > 0) {
                    itemInCart.quantity = newQuantity;
                } else {
                    state.local.newRequestCart = state.local.newRequestCart.filter(item => item.id != itemId);
                }
                
                renderNewRequestSidebar();
                
                // 正確的滾動位置恢復機制
                const restoreScrollPosition = () => {
                    const newCartItemsContainer = document.querySelector('.cart-items');
                    if (newCartItemsContainer) {
                        newCartItemsContainer.scrollTop = currentScrollTop;
                    }
                };
                
                // 多次嘗試恢復，確保成功
                requestAnimationFrame(() => {
                    restoreScrollPosition();
                    setTimeout(restoreScrollPosition, 0);
                    setTimeout(restoreScrollPosition, 10);
                    setTimeout(restoreScrollPosition, 50);
                    setTimeout(restoreScrollPosition, 100);
                });
            } else if (action === 'toggle-item-scrap') {
                // 找到真正的滾動容器
                const cartItemsContainer = document.querySelector('.cart-items');
                const currentScrollTop = cartItemsContainer ? cartItemsContainer.scrollTop : 0;
                
                itemInCart.is_scrap_work_order = target.checked;
                if (!target.checked) {
                    itemInCart.work_order_number = '';
                }
                
                // 防止預設行為和事件冒泡
                e.preventDefault();
                e.stopPropagation();
                
                // 重新渲染並保持滾動位置
                renderNewRequestSidebar();

                // 渲染後依條件更新提醒顯示
                const reminderElement = document.getElementById(`scrap-reminder-${itemId}`);
                if (reminderElement) {
                    const shouldShow = itemInCart.reason === '報廢' && !(itemInCart.is_scrap_work_order && (itemInCart.work_order_number || '').trim());
                    reminderElement.classList.toggle('hidden', !shouldShow);
                }
                
                // 正確的滾動位置恢復機制
                const restoreScrollPosition = () => {
                    const newCartItemsContainer = document.querySelector('.cart-items');
                    if (newCartItemsContainer) {
                        newCartItemsContainer.scrollTop = currentScrollTop;
                    }
                };
                
                // 多次嘗試恢復，確保成功
                requestAnimationFrame(() => {
                    restoreScrollPosition();
                    setTimeout(restoreScrollPosition, 0);
                    setTimeout(restoreScrollPosition, 10);
                    setTimeout(restoreScrollPosition, 50);
                    setTimeout(restoreScrollPosition, 100);
                });
            } else if (action === 'update-item-reason') {
                itemInCart.reason = target.value;
                
                // 動態顯示/隱藏提醒訊息：
                // 報廢且未同時勾選報廢財編與填寫工單 -> 顯示；其餘隱藏
                const reminderId = `scrap-reminder-${itemId}`;
                const reminderElement = document.getElementById(reminderId);
                if (target.value !== '報廢') {
                    // 非報廢：自動反勾選並清空，且提醒隱藏
                    itemInCart.is_scrap_work_order = false;
                    itemInCart.work_order_number = '';
                }
                // 重新渲染側邊欄以套用 checkbox disabled 狀態與輸入框隱藏
                const cartItemsContainer = document.querySelector('.cart-items');
                const currentScrollTop = cartItemsContainer ? cartItemsContainer.scrollTop : 0;
                renderNewRequestSidebar();
                requestAnimationFrame(() => {
                    const newCartItemsContainer = document.querySelector('.cart-items');
                    if (newCartItemsContainer) newCartItemsContainer.scrollTop = currentScrollTop;
                });
            }
        });
        
    document.getElementById('newRequest-view').addEventListener('input', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const itemId = target.dataset.id;
            const itemInCart = state.local.newRequestCart.find(item => item.id == itemId);

            if (itemInCart && action === 'update-item-work-order') {
                itemInCart.work_order_number = target.value;
                // 依條件更新提醒顯示
                const reminderElement = document.getElementById(`scrap-reminder-${itemId}`);
                if (reminderElement) {
                    const shouldShow = itemInCart.reason === '報廢' && !(itemInCart.is_scrap_work_order && (itemInCart.work_order_number || '').trim());
                    reminderElement.classList.toggle('hidden', !shouldShow);
                }
            } else if (target.id === 'request-reason') {
                // 即時保存總說明，避免重渲染造成內容消失
                state.local.requestReason = target.value;
            } else if (action === 'update-order-type') {
                // 即時保存訂單類別（特採/專案）
                state.local.newRequestOrderType = target.value;
            } else if (itemInCart && action === 'update-item-demand-dept') {
                itemInCart.demand_department = target.value;
            } else if (itemInCart && action === 'update-item-description') {
                itemInCart.description = target.value;
            } else if (itemInCart && action === 'update-item-invoice') {
                // 找到真正的滾動容器
                const cartItemsContainer = document.querySelector('.cart-items');
                const currentScrollTop = cartItemsContainer ? cartItemsContainer.scrollTop : 0;
                
                itemInCart.invoice = target.value;
                itemInCart.custom_invoice = '';
                
                // 保留總說明的值
                const currentReason = document.getElementById('request-reason')?.value ?? state.local.requestReason ?? '';
                state.local.requestReason = currentReason;
                renderNewRequestSidebar();
                
                // 正確的滾動位置恢復機制
                const restoreScrollPosition = () => {
                    const newCartItemsContainer = document.querySelector('.cart-items');
                    if (newCartItemsContainer) {
                        newCartItemsContainer.scrollTop = currentScrollTop;
                    }
                };
                
                // 多次嘗試恢復，確保成功
                requestAnimationFrame(() => {
                    restoreScrollPosition();
                    setTimeout(restoreScrollPosition, 0);
                    setTimeout(restoreScrollPosition, 10);
                    setTimeout(restoreScrollPosition, 50);
                    setTimeout(restoreScrollPosition, 100);
                });
            } else if (itemInCart && action === 'update-item-custom-invoice') {
                itemInCart.custom_invoice = target.value;
            }
        });

        document.getElementById('detailView-view').addEventListener('input', (e) => {
            if (e.target.classList.contains('item-input')) {
                const form = document.getElementById('edit-request-form');
                const formData = new FormData(form);
                let grandTotal = 0;
                state.selectedRequest.items.forEach((item, index) => {
                    const price = parseFloat(formData.get(`price_${index}`)) || 0;
                    const quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                    const freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                    const discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                    const subtotal = price * quantity + freight + discount;
                    grandTotal += subtotal;
                    const subtotalCell = document.querySelector(`.subtotal-cell[data-index="${index}"]`);
                    if (subtotalCell) subtotalCell.textContent = `$${subtotal.toLocaleString()}`;
                });
                const grandTotalCell = document.getElementById('grand-total');
                if (grandTotalCell) grandTotalCell.textContent = `$${Math.round(grandTotal).toLocaleString()}`;
            }
        });

        // 詳情頁：切換發票開立的「其他」自訂欄位顯示，以及報廢 -> 財產編號啟用狀態
    document.getElementById('detailView-view').addEventListener('change', (e) => {
            const target = e.target;
            if (!target.name) return;
            if (target.name.startsWith('invoice_')) {
                const idx = target.name.split('_')[1];
                const custom = document.querySelector(`input[name="custom_invoice_${idx}"]`);
                if (custom) {
                    if (target.value === '其他') {
                        custom.classList.remove('hidden');
                        custom.classList.add('block', 'w-2/3');
                    } else {
                        custom.classList.add('hidden');
                        custom.classList.remove('block', 'w-2/3');
                        custom.value = '';
                    }
                }
            } else if (target.name.startsWith('scrap_')) {
                const idx = target.name.split('_')[1];
                const asset = document.querySelector(`input[name="asset_number_${idx}"]`);
                if (asset) {
                    const enabled = target.checked;
                    asset.disabled = !enabled;
                    asset.classList.toggle('opacity-50', !enabled);
                    if (!enabled) asset.value = '';
                }
            } else if (target.name.startsWith('reason_')) {
                const idx = target.name.split('_')[1];
                const scrap = document.querySelector(`input[name="scrap_${idx}"]`);
                const asset = document.querySelector(`input[name="asset_number_${idx}"]`);
                if (scrap && asset) {
                    const isScrapReason = target.value === '報廢';
                    scrap.disabled = !isScrapReason;
                    if (!isScrapReason) {
                        scrap.checked = false;
                        asset.value = '';
                        asset.disabled = true;
                        asset.classList.add('opacity-50');
                    }
                }
            }
        });

        document.getElementById('detailView-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'download-attachment') {
                const fileId = button.dataset.fileId;
                if (!fileId) return;
                try {
                    button.disabled = true;
                    button.textContent = '下載中...';

                    // 以帶授權標頭的 fetch 下載 blob，避免 window.open 缺少 Authorization 造成 401
                    const baseUrl = (window.getSupabaseBaseUrl && window.getSupabaseBaseUrl()) || '';
                    if (!baseUrl) throw new Error('未設定 SUPABASE_URL');
                    const session = (await supabase.auth.getSession()).data?.session;
                    const token = session?.access_token || (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                    const apikey = (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                    const url = `${baseUrl}/functions/v1/${ATTACHMENT_SIGNED_URL_FN}?id=${encodeURIComponent(fileId)}`;

            const res = await fetch(url, {
                        method: 'GET',
                        headers: {
                            Authorization: `Bearer ${token}`,
                apikey
                        },
                        mode: 'cors',
                        cache: 'no-store'
                    });
                    if (!res.ok) {
                        const txt = await res.text().catch(() => '');
                        throw new Error(`下載失敗（${res.status}）：${txt || '請稍後再試'}`);
                    }
                    const blob = await res.blob();
                    // 先優先使用詳情頁附件清單中的名稱（a.name），再回退到 Content-Disposition
                    const reqId = state.selectedRequest?.id || '';
                    const attFromState = (state.selectedRequest?.attachments || []).find(a => String(a.id) === String(fileId));
                    let originalName = attFromState?.name || '';
                    if (!originalName) {
                        const cd = res.headers.get('content-disposition') || '';
                        const m1 = cd.match(/filename\*=UTF-8''([^;]+)$/i);
                        const m2 = cd.match(/filename="?([^";]+)"?/i);
                        if (m1) {
                            try { originalName = decodeURIComponent(m1[1]); } catch (_) { originalName = m1[1]; }
                        } else if (m2) {
                            originalName = m2[1];
                        }
                    }
                    let filename = '附件';
                    if (reqId && originalName) {
                        filename = `${reqId} - ${originalName}`;
                    } else if (originalName) {
                        filename = originalName;
                    } else if (reqId) {
                        filename = `${reqId}-${fileId}`;
                    }
                    const blobUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(blobUrl);
                    document.body.removeChild(a);
                } catch (err) {
                    console.error('下載附件錯誤:', err);
                    showMessage('下載附件失敗：' + err.message, 'error');
                } finally {
                    button.disabled = false;
                    button.textContent = '下載';
                }
                return;
            }

            if (action === 'view-mod-history') {
                const req = state.selectedRequest;
                // 只顯示編輯相關的操作，過濾掉單純的經辦、結案等操作
                const editRelatedHistory = (req?.modification_history || []).filter(h => {
                    // 保留所有編輯操作（handled_edit 和其他有 changes 的操作）
                    return h.action === 'handled_edit' || (h.changes && h.changes.length > 0);
                });
                
                if (!editRelatedHistory.length) {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">修改歷程</h3>
                        <p class="text-sm text-gray-600">目前沒有任何修改紀錄。</p>
                        <div class="mt-6 flex justify-end">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">關閉</button>
                        </div>
                    `, { size: 'half' });
                    return;
                }
                const fieldNameMap = {
                    reason: '原因',
                    description: '說明',
                    demand_department: '需求課室',
                    invoice: '發票開立',
                    custom_invoice: '自訂發票',
                    vendor: '廠商',
                    price: '單價',
                    quantity: '數量',
                    unit: '單位',
                    freight: '運費',
                    discount: '折扣',
                    is_scrap_work_order: '報廢',
                    work_order_number: '財產編號'
                };
                const ordered = [...editRelatedHistory].reverse(); // 最新在上
                const body = ordered.map((entry, i) => {
                    const changes = Array.isArray(entry.changes) ? entry.changes : [];
                    const changesHTML = changes.length ? `
                        <div class="mt-2 space-y-2">
                            ${changes.map(c => `
                                <div class="border rounded p-2 bg-gray-50">
                                    <div class="text-xs text-gray-500">品項：${c.name || c.item_id || ''}</div>
                                    <ul class="mt-1 text-sm list-disc list-inside">
                                        ${(c.changes || []).map(ch => `<li><span class="text-gray-600">${fieldNameMap[ch.field] || ch.field}：</span><span class="line-through text-gray-400">${ch.from === '' ? '（空）' : ch.from}</span> → <span class="text-gray-800">${ch.to === '' ? '（空）' : ch.to}</span></li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>` : '<div class="text-sm text-gray-500">無欄位變更明細</div>';
                    return `
                        <div class="mb-4 border-b pb-3">
                            <div class="text-sm font-semibold">#${ordered.length - i} 修改人：${entry.user}（${entry.role}）</div>
                            <div class="text-xs text-gray-500">時間：${getFormattedDateTime(entry.date)}</div>
                            <div class="mt-1 text-sm"><span class="text-gray-600">原因：</span>${entry.reason || '（未填）'}</div>
                            ${changesHTML}
                        </div>
                    `;
                }).join('');
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">修改歷程</h3>
                    <div class="max-h-[70vh] overflow-y-auto pr-1">${body}</div>
                    <div class="mt-4 flex justify-end">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">關閉</button>
                    </div>
                `, { size: 'half' });
                return;
            }

            // 若按下核准且有資料變更，先詢問是否同時儲存修改
            if (action === 'approve') {
                const currentRequest = state.selectedRequest;
                const nextApprover = (currentRequest.approvers || []).find(a => a.status === 'pending');
                const canApprove = state.currentUser && nextApprover && state.currentUser.id === nextApprover.userId;
                const isPurchaser = state.currentUser.role.includes('採購');
                const isPurchaserEditing = canApprove && isPurchaser;
                const form = document.getElementById('edit-request-form');
                if (isPurchaserEditing && form) {
                    const formData = new FormData(form);
                    let hasChanges = false;
                    for (let index = 0; index < (currentRequest.items || []).length; index++) {
                        const item = currentRequest.items[index];
                        const newReason = (formData.get(`reason_${index}`) || '').toString();
                        const newDescription = (formData.get(`description_${index}`) || '').toString();
                        const demandDept = formData.get(`demand_department_${index}`) || '';
                        const invoice = formData.get(`invoice_${index}`) || '';
                        const customInvoice = formData.get(`custom_invoice_${index}`) || '';
                        const vendor = formData.get(`vendor_${index}`) || '';
                        const price = parseFloat(formData.get(`price_${index}`)) || 0;
                        const quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                        const unit = formData.get(`unit_${index}`) || '';
                        const freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                        const discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                        let newScrap = item.is_scrap_work_order;
                        let newAsset = item.work_order_number || '';
                        if (newReason === '報廢') {
                            newScrap = !!formData.get(`scrap_${index}`);
                            newAsset = newScrap ? (formData.get(`asset_number_${index}`) || '') : '';
                        } else {
                            newScrap = false;
                            newAsset = '';
                        }
                        if (
                            (item.reason || '') !== newReason ||
                            (item.description || '') !== newDescription ||
                            (item.demand_department || '') !== demandDept ||
                            (item.invoice || '') !== invoice ||
                            (item.custom_invoice || '') !== (invoice === '其他' ? customInvoice : '') ||
                            (item.vendor || '') !== vendor ||
                            Number(item.price || 0) !== price ||
                            Number(item.quantity || 0) !== quantity ||
                            (item.unit || '') !== unit ||
                            Number(item.freight || 0) !== freight ||
                            Number(item.discount || 0) !== discount ||
                            Boolean(item.is_scrap_work_order) !== Boolean(newScrap) ||
                            (item.work_order_number || '') !== newAsset
                        ) {
                            hasChanges = true;
                            break;
                        }
                    }
                    if (hasChanges) {
                        // 快照詳情頁的表單與欄位值，避免彈出確認後 DOM 被覆蓋導致找不到資料
                        (window).__approvePendingContext = {
                            scope: 'detail',
                            requestId: currentRequest.id,
                            formSelector: '#edit-request-form',
                            commentSelector: '#approval-comment',
                            reasonSelector: '#modification-reason'
                        };
            renderModal(`
                            <h3 class="text-lg font-bold mb-4">請確認是否進行單據資料修改</h3>
                            <p class="mb-6 text-sm text-gray-700">偵測到您對單據內容做了變更，是否一併儲存修改後再核准？</p>
                            <div class="flex justify-end space-x-3">
                                <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                <button data-action="modal-confirm-approve-without-save" data-request-id="${currentRequest.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">否，直接核准</button>
                <button data-action="modal-confirm-approve-with-save" data-request-id="${currentRequest.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">是，儲存修改後核准</button>
                            </div>
                        `, { size: 'half' });
                        return; // 先不進入原核准流程
                    }
                }
            }

            if (action === 'approve' || action === 'save-changes' || action === 'confirm-approve-with-save' || action === 'confirm-approve-without-save') {
                if (action === 'save-changes') {
                    const modificationReason = document.getElementById('modification-reason').value;
                    if (!modificationReason.trim()) {
                        showMessage('修改訂單內容時，必須填寫修改原因。', 'error');
                        return;
                    }
                }
                // 若是「確認-儲存修改後核准」，視同 save-changes
                const treatAsSave = action === 'save-changes' || action === 'confirm-approve-with-save';

                updateState({ loading: true });
                try {
                    const currentRequest = state.selectedRequest;
                    const approvers = [...currentRequest.approvers];
                    const currentStepIndex = approvers.findIndex(a => a.status === 'pending');

                    if (currentStepIndex !== -1) {
                        approvers[currentStepIndex].status = 'approved';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].comment = document.getElementById('approval-comment').value || '';
                        
                        const isFinal = currentStepIndex === approvers.length - 1;
                        const newStatus = isFinal ? '已核准' : '待審核';

                        let updateData = { approvers, status: newStatus };
                        if (isFinal) {
                            const handlerUser = Object.values(state.users).find(u => u.is_handler);
                            updateData.handler_status = '待經辦';
                            updateData.handler_id = handlerUser ? handlerUser.id : null;
                        }
                        if (isFinal) {
                            // 指派經辦與狀態
                            const handlerUser = Object.values(state.users).find(u => u.is_handler);
                            updateData.handler_status = '待經辦';
                            updateData.handler_id = handlerUser ? handlerUser.id : null;
                        }

                        if (treatAsSave) {
                            const modificationReason = document.getElementById('modification-reason').value;
                            const form = document.getElementById('edit-request-form');
                            const formData = new FormData(form);
                            const newItems = currentRequest.items.map((item, index) => {
                                const updated = { ...item };
                                // 允許：原因/說明
                                const reasonVal = formData.get(`reason_${index}`);
                                if (reasonVal !== null) updated.reason = (reasonVal || '').toString();
                                const descVal = formData.get(`description_${index}`);
                                if (descVal !== null) updated.description = (descVal || '').toString();
                                // 允許：需求課室
                                const demandDept = formData.get(`demand_department_${index}`);
                                if (demandDept !== null) updated.demand_department = demandDept || '';
                                // 允許：發票開立
                                const invoice = formData.get(`invoice_${index}`);
                                const customInvoice = formData.get(`custom_invoice_${index}`);
                                if (invoice !== null) {
                                    updated.invoice = invoice || '';
                                    updated.custom_invoice = invoice === '其他' ? (customInvoice || '') : '';
                                }
                                // 允許：廠商
                                const vendor = formData.get(`vendor_${index}`);
                                if (vendor !== null) updated.vendor = vendor || '';
                                // 允許：價格/數量/單位/運費/折扣
                                updated.price = parseFloat(formData.get(`price_${index}`)) || 0;
                                updated.quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                                updated.unit = formData.get(`unit_${index}`) || '';
                                updated.freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                                updated.discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                                // 允許：報廢/財產編號（僅原因為報廢時；否則自動清空）
                                if (updated.reason === '報廢') {
                                    updated.is_scrap_work_order = !!formData.get(`scrap_${index}`);
                                    updated.work_order_number = updated.is_scrap_work_order ? (formData.get(`asset_number_${index}`) || '') : '';
                                } else {
                                    updated.is_scrap_work_order = false;
                                    updated.work_order_number = '';
                                }
                                // 不允許修改：品名
                                return updated;
                            });
                            const newTotalAmount = Math.round(newItems.reduce((sum, item) => sum + (item.price * item.quantity) + (item.freight || 0) + (item.discount || 0), 0));
                            // 建立變更明細供後續查閱比對
                            const fieldsToCompare = ['reason','description','demand_department','invoice','custom_invoice','vendor','price','quantity','unit','freight','discount','is_scrap_work_order','work_order_number'];
                            const changesLog = [];
                            for (let i = 0; i < currentRequest.items.length; i++) {
                                const before = currentRequest.items[i] || {};
                                const after = newItems[i] || {};
                                const itemChanges = [];
                                fieldsToCompare.forEach(field => {
                                    const a = (before[field] === undefined || before[field] === null) ? '' : before[field];
                                    const b = (after[field] === undefined || after[field] === null) ? '' : after[field];
                                    if (String(a) !== String(b)) {
                                        itemChanges.push({ field, from: a, to: b });
                                    }
                                });
                                if (itemChanges.length > 0) {
                                    changesLog.push({ item_id: before.id, name: before.name, changes: itemChanges });
                                }
                            }
                            
                            const newHistoryEntry = {
                                user: state.currentUser.name,
                                role: state.currentUser.role,
                                date: new Date().toISOString(),
                                reason: modificationReason,
                                changes: changesLog
                            };
                            
                            updateData.items = newItems;
                            updateData.total_amount = newTotalAmount;
                            updateData.modification_history = [...(currentRequest.modification_history || []), newHistoryEntry];
                        }
                        
                        let notificationMessage = `您的申請單 ${currentRequest.id} 已由 ${state.currentUser.name} 核准。`;
                        if (isFinal) {
                            notificationMessage = `您的申請單 ${currentRequest.id} 已全數簽核完成！`;
                        }
                        
                        await supabase.from('notifications').insert({
                            user_id: currentRequest.applicant_id,
                            request_id: currentRequest.id,
                            message: notificationMessage,
                            is_read: false
                        });
                        if (isFinal && updateData.handler_id) {
                            await supabase.from('notifications').insert({
                                user_id: updateData.handler_id,
                                request_id: currentRequest.id,
                                message: `您被指派經辦申請單 ${currentRequest.id}，請儘速處理。`,
                                is_read: false
                            });
                        }

                        const { data: updatedRequest, error } = await supabase.from('requests').update(updateData).eq('id', currentRequest.id).select().single();
                        if (error) throw error;

                        const newRequests = state.requests.map(r => r.id === updatedRequest.id ? updatedRequest : r);
                        getFilteredRequests.resetCache();
                        
                        showMessage('申請單已核准');
                        // 回到特別採購單列表畫面
                        updateState({ view: 'dashboard', loading: false, requests: newRequests });
                        closeModal(); // 若是從確認視窗來的，順手關閉
                    }
                } catch (err) {
                    console.error("核准失敗:", err);
                    showMessage('核准失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'reject') {
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">退回申請</h3>
                    <label for="rejection-reason" class="block text-sm font-medium text-gray-700">退回理由：</label>
                    <textarea id="rejection-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                        <button data-action="confirm-reject-previous" class="px-4 py-2 rounded-md font-semibold text-sm bg-yellow-500 text-white">退回上一層</button>
                        <button data-action="confirm-reject-all" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">整筆退單</button>
                    </div>`);
            } else if (action === 'close-request') {
                updateState({ loading: true });
                try {
                    const req = state.selectedRequest;
                    const newHistoryEntry = {
                        user: state.currentUser.name,
                        role: state.currentUser.role,
                        date: new Date().toISOString(),
                        reason: '結案',
                        action: 'closed'
                    };
                    const patch = {
                        closed_status: '結案',
                        modification_history: [...(req.modification_history || []), newHistoryEntry]
                    };
                    const { data, error } = await supabase.from('requests').update(patch).eq('id', req.id).select().single();
                    if (error) throw error;
                    
                    showMessage('申請單已結案');
                    updateState({ selectedRequest: data, loading: false });
                } catch (err) {
                    showMessage('結案失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'mark-handled') {
                const req = state.selectedRequest;
                if (!req) return;
                const isHandler = state.currentUser.id === req.handler_id;
                const isPurchasing = state.currentUser.role === '採購' || state.currentUser.role === '採購主管' || state.currentUser.is_admin;
                const effectiveHandlerStatus = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                if (req.status !== '已核准' || effectiveHandlerStatus !== '待經辦') {
                    showMessage('目前狀態不可經辦。', 'error');
                    return;
                }
                if (!isHandler && !isPurchasing) {
                    showMessage('僅被指派的經辦或採購/管理員可執行經辦', 'error');
                    return;
                }

                // 防呆：如表單有未儲存變更，提示是否先儲存再經辦
                const form = document.getElementById('edit-request-form');
                let hasChanges = false;
                if (form) {
                    const formData = new FormData(form);
                    for (let index = 0; index < (req.items || []).length; index++) {
                        const item = req.items[index];
                        const newReason = (formData.get(`reason_${index}`) || '').toString();
                        const newDescription = (formData.get(`description_${index}`) || '').toString();
                        const demandDept = formData.get(`demand_department_${index}`) || '';
                        const invoice = formData.get(`invoice_${index}`) || '';
                        const customInvoice = formData.get(`custom_invoice_${index}`) || '';
                        const vendor = formData.get(`vendor_${index}`) || '';
                        const price = parseFloat(formData.get(`price_${index}`)) || 0;
                        const quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                        const unit = formData.get(`unit_${index}`) || '';
                        const freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                        const discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                        let newScrap = item.is_scrap_work_order;
                        let newAsset = item.work_order_number || '';
                        if (newReason === '報廢') {
                            newScrap = !!formData.get(`scrap_${index}`);
                            newAsset = newScrap ? (formData.get(`asset_number_${index}`) || '') : '';
                        } else {
                            newScrap = false;
                            newAsset = '';
                        }
                        if (
                            (item.reason || '') !== newReason ||
                            (item.description || '') !== newDescription ||
                            (item.demand_department || '') !== demandDept ||
                            (item.invoice || '') !== invoice ||
                            (item.custom_invoice || '') !== (invoice === '其他' ? customInvoice : '') ||
                            (item.vendor || '') !== vendor ||
                            Number(item.price || 0) !== price ||
                            Number(item.quantity || 0) !== quantity ||
                            (item.unit || '') !== unit ||
                            Number(item.freight || 0) !== freight ||
                            Number(item.discount || 0) !== discount ||
                            Boolean(item.is_scrap_work_order) !== Boolean(newScrap) ||
                            (item.work_order_number || '') !== newAsset
                        ) { hasChanges = true; break; }
                    }
                }

                if (hasChanges) {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">請確認是否進行單據資料修改</h3>
                        <p class="mb-6 text-sm text-gray-700">偵測到您對單據內容做了變更，是否一併儲存修改後再經辦？</p>
                        <div class="flex justify-end space-x-3">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                            <button data-action="modal-confirm-handle-without-save" data-request-id="${req.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">否，直接經辦</button>
                            <button data-action="modal-confirm-handle-with-save" data-request-id="${req.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">是，儲存修改後經辦</button>
                        </div>
                    `, { size: 'half' });
                    return;
                }

                // 無變更，直接經辦
                updateState({ loading: true });
                try {
                    const comment = (document.getElementById('handler-comment')?.value || '').trim();
                    const newHistoryEntry = {
                        user: state.currentUser.name,
                        userId: state.currentUser.id,
                        role: state.currentUser.role,
                        date: new Date().toISOString(),
                        reason: '經辦完成',
                        action: 'handled',
                        comment
                    };
                    const patch = {
                        handler_status: '已經辦',
                        modification_history: [...(req.modification_history || []), newHistoryEntry]
                    };
                    const { data, error } = await supabase.from('requests').update(patch).eq('id', req.id).select().single();
                    if (error) throw error;

                    // 通知申請人與經辦群組
                    const notifs = [];
                    notifs.push({ user_id: req.applicant_id, request_id: req.id, message: `您的申請單 ${req.id} 已由 ${state.currentUser.name} 完成經辦。`, is_read: false });
                    const handlerUsers = Object.values(state.users).filter(u => u.is_handler);
                    handlerUsers.forEach(u => notifs.push({ user_id: u.id, request_id: req.id, message: `申請單 ${req.id} 已由 ${state.currentUser.name} 完成經辦。`, is_read: false }));
                    if (notifs.length) { await supabase.from('notifications').insert(notifs); }

                    const newRequests = state.requests.map(r => r.id === req.id ? { ...r, handler_status: '已經辦', modification_history: patch.modification_history } : r);
                    showMessage('已完成經辦');
                    updateState({ selectedRequest: data, requests: newRequests, loading: false });
                    closeModal();
                } catch (err) {
                    showMessage('經辦失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'print-request') {
                const requestId = state.selectedRequest?.id;
                if (requestId) {
                    printRequest(requestId);
                } else {
                    showMessage('找不到要列印的申請單。', 'error');
                }
            } else if (action === 'handler-save-changes') {
                const req = state.selectedRequest;
                if (!req) return;
                if ((req.handler_status || '未經辦') !== '待經辦') { showMessage('僅待經辦狀態可修改。', 'error'); return; }
                if (state.currentUser.id !== req.handler_id && !state.currentUser.is_admin && !['採購','採購主管'].includes(state.currentUser.role)) { showMessage('您無權限執行此操作。', 'error'); return; }
                const reason = (document.getElementById('handler-modification-reason')?.value || '').trim();
                if (!reason) { showMessage('請填寫經辦修改原因。', 'error'); return; }
                const comment = (document.getElementById('handler-comment')?.value || '').trim();
                updateState({ loading: true });
                try {
                    const form = document.getElementById('edit-request-form');
                    const formData = new FormData(form);
                    const newItems = (req.items || []).map((item, index) => {
                        const updated = { ...item };
                        const reasonVal = formData.get(`reason_${index}`);
                        if (reasonVal !== null) updated.reason = (reasonVal || '').toString();
                        const descVal = formData.get(`description_${index}`);
                        if (descVal !== null) updated.description = (descVal || '').toString();
                        const demandDept = formData.get(`demand_department_${index}`);
                        if (demandDept !== null) updated.demand_department = demandDept || '';
                        const invoice = formData.get(`invoice_${index}`);
                        const customInvoice = formData.get(`custom_invoice_${index}`);
                        if (invoice !== null) {
                            updated.invoice = invoice || '';
                            updated.custom_invoice = invoice === '其他' ? (customInvoice || '') : '';
                        }
                        const vendor = formData.get(`vendor_${index}`);
                        if (vendor !== null) updated.vendor = vendor || '';
                        updated.price = parseFloat(formData.get(`price_${index}`)) || 0;
                        updated.quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                        updated.unit = formData.get(`unit_${index}`) || '';
                        updated.freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                        updated.discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                        if ((updated.reason || '') === '報廢') {
                            updated.is_scrap_work_order = !!formData.get(`scrap_${index}`);
                            updated.work_order_number = updated.is_scrap_work_order ? (formData.get(`asset_number_${index}`) || '') : '';
                        } else {
                            updated.is_scrap_work_order = false;
                            updated.work_order_number = '';
                        }
                        return updated;
                    });
                    const newTotalAmount = Math.round(newItems.reduce((sum, item) => sum + (item.price * item.quantity) + (item.freight || 0) + (item.discount || 0), 0));
                    const fieldsToCompare = ['reason','description','demand_department','invoice','custom_invoice','vendor','price','quantity','unit','freight','discount','is_scrap_work_order','work_order_number'];
                    const changesLog = [];
                    for (let i = 0; i < (req.items || []).length; i++) {
                        const before = req.items[i] || {};
                        const after = newItems[i] || {};
                        const itemChanges = [];
                        fieldsToCompare.forEach(field => {
                            const a = (before[field] ?? '') + '';
                            const b = (after[field] ?? '') + '';
                            if (a !== b) itemChanges.push({ field, from: before[field] ?? '', to: after[field] ?? '' });
                        });
                        if (itemChanges.length) changesLog.push({ item_id: before.id, name: before.name, changes: itemChanges });
                    }
                    const newHistoryEntry = { 
                        user: state.currentUser.name, 
                        userId: state.currentUser.id,
                        role: state.currentUser.role, 
                        date: new Date().toISOString(), 
                        reason, 
                        action: 'handled_edit', 
                        comment, 
                        changes: changesLog 
                    };
                    const patch = { items: newItems, total_amount: newTotalAmount, handler_status: '已經辦', modification_history: [...(req.modification_history || []), newHistoryEntry] };
                    const { data, error } = await supabase.from('requests').update(patch).eq('id', req.id).select().single();
                    if (error) throw error;
                    // 通知申請人與經辦群組
                    const notifs = [];
                    notifs.push({ user_id: req.applicant_id, request_id: req.id, message: `您的申請單 ${req.id} 已由 ${state.currentUser.name} 完成經辦。`, is_read: false });
                    const handlerUsers = Object.values(state.users).filter(u => u.is_handler);
                    handlerUsers.forEach(u => notifs.push({ user_id: u.id, request_id: req.id, message: `申請單 ${req.id} 已由 ${state.currentUser.name} 完成經辦。`, is_read: false }));
                    if (notifs.length) { await supabase.from('notifications').insert(notifs); }
                    const newRequests = state.requests.map(r => r.id === req.id ? data : r);
                    showMessage('已儲存經辦修改並完成經辦');
                    updateState({ selectedRequest: data, requests: newRequests, loading: false });
                } catch (err) {
                    showMessage('儲存失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'modal-confirm-handle-with-save') {
                // 視同按下「儲存修改並經辦」
                const trigger = document.querySelector('[data-action="handler-save-changes"]');
                if (trigger) trigger.click();
            } else if (action === 'modal-confirm-handle-without-save') {
                // 視同按下「經辦」但不儲存修改
                const req = state.selectedRequest;
                if (!req) return;
                updateState({ loading: true });
                try {
                    const comment = (document.getElementById('handler-comment')?.value || '').trim();
                    const newHistoryEntry = { 
                        user: state.currentUser.name, 
                        userId: state.currentUser.id,
                        role: state.currentUser.role, 
                        date: new Date().toISOString(), 
                        reason: '經辦完成', 
                        action: 'handled', 
                        comment 
                    };
                    const patch = { handler_status: '已經辦', modification_history: [...(req.modification_history || []), newHistoryEntry] };
                    const { data, error } = await supabase.from('requests').update(patch).eq('id', req.id).select().single();
                    if (error) throw error;
                    const notifs = [];
                    notifs.push({ user_id: req.applicant_id, request_id: req.id, message: `您的申請單 ${req.id} 已由 ${state.currentUser.name} 完成經辦。`, is_read: false });
                    const handlerUsers = Object.values(state.users).filter(u => u.is_handler);
                    handlerUsers.forEach(u => notifs.push({ user_id: u.id, request_id: req.id, message: `申請單 ${req.id} 已由 ${state.currentUser.name} 完成經辦。`, is_read: false }));
                    if (notifs.length) { await supabase.from('notifications').insert(notifs); }
                    const newRequests = state.requests.map(r => r.id === req.id ? { ...r, handler_status: '已經辦', modification_history: patch.modification_history } : r);
                    showMessage('已完成經辦');
                    updateState({ selectedRequest: data, requests: newRequests, loading: false });
                    closeModal();
                } catch (err) {
                    showMessage('經辦失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'handler-reject-options') {
                const req = state.selectedRequest;
                if (!req) return;
                if (state.currentUser.id !== req.handler_id && !state.currentUser.is_admin && !['採購','採購主管'].includes(state.currentUser.role)) { showMessage('您無權限執行此操作。', 'error'); return; }
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">經辦退單</h3>
                    <label for="handler-reject-reason" class="block text-sm font-medium text-gray-700">退單理由：</label>
                    <textarea id="handler-reject-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                        <button data-action="confirm-handler-reject-all" data-id="${req.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">整筆退單</button>
                    </div>`);
            }
        });

        document.getElementById('productManagement-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button, th');
            if (!button) return;
            const action = button.dataset.action;
            const productId = button.dataset.id;

            if (action === 'sort-product') {
                const key = button.dataset.sortKey;
                if (state.local.productSortKey === key) {
                    state.local.productSortDirection = state.local.productSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    state.local.productSortKey = key;
                    state.local.productSortDirection = 'asc';
                }
                render();
            } else if (action === 'add-product') {
                state.editingProduct = null;
                updateState({ view: 'productForm' });
            } else if (action === 'edit-product') {
                const product = state.allProducts.find(p => p.id == productId);
                state.editingProduct = product;
                updateState({ view: 'productForm' });
            } else if (action === 'delete-product') {
                const productName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">確認刪除</h3>
                    <p class="mb-6">您確定要刪除商品 "${productName}" 嗎？此操作無法復原。</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-id="${productId}" data-action="confirm-delete-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">確認刪除</button>
                    </div>
                `);
            } else if (action === 'switch-product-category') {
                updateState({ local: { ...state.local, activeProductManagementCategory: button.dataset.category, productManagementSearchTerm: '' } });
            } else if (action === 'search-product') {
                const searchTerm = document.getElementById('product-search-input').value;
                const searchAll = document.getElementById('product-management-search-all-checkbox').checked;
                updateState({ local: { ...state.local, productManagementSearchTerm: searchTerm, productManagementSearchAll: searchAll } });
            }
        });

        document.getElementById('productManagement-view').addEventListener('change', (e) => {
            if (e.target.id === 'product-management-search-all-checkbox') {
                updateState({ local: { ...state.local, productManagementSearchAll: e.target.checked } });
            }
        });

        document.getElementById('productForm-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'save-product') {
                const form = document.getElementById('product-form');
                if (!form.reportValidity()) return;

                const formData = new FormData(form);
                const productData = Object.fromEntries(formData.entries());
                productData.price = parseFloat(productData.price) || 0;
                
                updateState({ loading: true });
                // 供後續本地狀態更新使用的變更快照（只在儲存修改時填入）
                let savedPatch = null;
                try {
                    const { data: savedProduct, error } = await supabase
                        .from('products')
                        .upsert(productData, { onConflict: 'id' })
                        .select()
                        .single();

                    if (error) {
                        if (error.code === '23505') { 
                            throw new Error(`商品編號 "${productData.id}" 已存在。`);
                        }
                        throw error;
                    }

                    const productIndex = state.allProducts.findIndex(p => p.id === savedProduct.id);
                    if (productIndex > -1) {
                        state.allProducts[productIndex] = savedProduct;
                    } else {
                        state.allProducts.push(savedProduct);
                    }

                    const productsData = {};
                    state.allProducts.forEach(product => {
                        const category = product.category;
                        if (!productsData[category]) productsData[category] = [];
                        productsData[category].push(product);
                    });
                    
                    showMessage('商品已儲存');
                    updateState({ view: 'productManagement', loading: false, products: productsData });

                } catch (err) {
                    showMessage('儲存失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'upload-image') {
                const fileInput = document.getElementById('image-upload-input');
                const file = fileInput.files[0];
                if (!file) {
                    showMessage('請先選擇一個圖片檔案。', 'error');
                    return;
                }

                const uploadButton = e.target;
                uploadButton.textContent = '上傳中...';
                uploadButton.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const { data, error } = await supabase.functions.invoke('upload-product-image', {
                        body: formData,
                    });

                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    const imageId = data.fileId;
                    
                    const hiddenImageInput = document.querySelector('#product-form input[name="image"]');
                    hiddenImageInput.value = imageId;

                    const preview = document.getElementById('product-form-image-preview');
                    preview.src = `https://drive.google.com/thumbnail?id=${imageId}`;
                    
                    showMessage('圖片上傳成功！請記得點擊「儲存」以完成更新。');
                    uploadButton.textContent = '上傳完成';

                } catch (err) {
                    console.error("圖片上傳失敗:", err);
                    showMessage(`圖片上傳失敗: ${err.message}`, 'error');
                    uploadButton.textContent = '上傳圖片';
                    uploadButton.disabled = false;
                }
            }
        });
        
        document.getElementById('productForm-view').addEventListener('change', (e) => {
            const target = e.target;
            if (target.id === 'image-upload-input') {
                const file = target.files[0];
                const filenameSpan = document.getElementById('image-upload-filename');
                const uploadButton = document.getElementById('image-upload-button');
                if (file) {
                    filenameSpan.textContent = file.name;
                    uploadButton.disabled = false;
                    uploadButton.textContent = '上傳圖片';
                } else {
                    filenameSpan.textContent = '尚未選擇檔案';
                    uploadButton.disabled = true;
                }
            }
        });

        document.getElementById('personalForms-view').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const tab = button.dataset.tab;
            if(tab) {
                updateState({ local: { ...state.local, personalForms: { ...state.local.personalForms, activeTab: tab } } });
            }
        });
        
        document.getElementById('personalForms-view').addEventListener('input', (e) => {
            const target = e.target;
            if (target.matches('.personal-forms-filter')) {
                clearTimeout(window.personalFormsSearchTimeout);
                window.personalFormsSearchTimeout = setTimeout(() => {
                    const filterType = target.dataset.filterType;
                    const activeTab = state.local.personalForms.activeTab;
                    
                    const updatedFilters = {
                        ...state.local.personalForms,
                        [activeTab]: {
                            ...state.local.personalForms[activeTab],
                            [filterType]: target.value
                        }
                    };
                    updateState({ local: { ...state.local, personalForms: updatedFilters } });
                }, 300);
            }
        });

        document.getElementById('userManagement-view').addEventListener('change', (e) => {
            if (e.target.id === 'user-dept-filter') {
                updateState({ local: { ...state.local, userManagementFilters: { ...state.local.userManagementFilters, department: e.target.value } } });
            }
        });

        document.getElementById('userManagement-view').addEventListener('keyup', (e) => {
            if (e.target.id === 'user-search-input') {
                clearTimeout(window.userSearchTimeout);
                window.userSearchTimeout = setTimeout(() => {
                    updateState({ local: { ...state.local, userManagementFilters: { ...state.local.userManagementFilters, searchTerm: e.target.value } } });
                }, 300);
            }
        });

        document.getElementById('userManagement-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const userId = button.dataset.id;

            if (action === 'add-user') {
                updateState({ editingUser: null, view: 'userForm' });
            } else if (action === 'edit-user') {
                const user = state.users[userId];
                updateState({ editingUser: user, view: 'userForm' });
            } else if (action === 'reset-password') {
                const userName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">重設使用者密碼</h3>
                    <p class="mb-4">為使用者 <strong>${userName}</strong> 設定新密碼：</p>
                    <div class="space-y-4">
                        <div>
                            <label for="reset-new-password" class="block text-sm font-medium text-gray-700">新密碼</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="password" id="reset-new-password" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="輸入新密碼（至少6位）">
                                <button type="button" id="reset-show-password-btn" class="px-3 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">顯示</button>
                            </div>
                        </div>
                        <div>
                            <label for="reset-confirm-password" class="block text-sm font-medium text-gray-700">確認新密碼</label>
                            <input type="password" id="reset-confirm-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="再次輸入新密碼">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-user-id="${userId}" data-action="confirm-reset-password" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">確認重設</button>
                    </div>
                `);
            } else if (action === 'delete-user') {
                const userName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">確認刪除使用者</h3>
                    <p class="mb-6">您確定要刪除使用者 "${userName}" 嗎？此操作將會從系統中永久移除該使用者及其認證資料，且無法復原。</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-id="${userId}" data-action="confirm-delete-user" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">確認刪除</button>
                    </div>
                `);
            } else if (action === 'toggle-user-enabled') {
                const currentStatus = button.dataset.enabled === 'true';
                const newStatus = !currentStatus;
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .update({ is_enabled: newStatus })
                        .eq('id', userId)
                        .select()
                        .single();
                    if (error) throw error;
                    state.users[userId] = data;
                    showMessage(`使用者狀態已更新為 ${newStatus ? '啟用' : '停用'}`);
                    render();
                } catch (err) {
                    showMessage(`更新使用者狀態失敗: ${err.message}`, 'error');
                }
            }
        });

        // 部門管理事件: 搜尋、按鈕
        document.getElementById('departmentManagement-view').addEventListener('keyup', (e) => {
            if (e.target.id === 'department-search-input') {
                updateState({ local: { ...state.local, departmentManagementSearchTerm: e.target.value } });
            }
        });
        document.getElementById('departmentManagement-view').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.dataset.action;
            if (action === 'add-department') {
                updateState({ editingDepartment: null, view: 'departmentForm' });
                return;
            }
            if (action === 'edit-department') {
                const deptName = btn.dataset.dept;
                const director_threshold = state.departments[deptName] ?? null;
                updateState({ editingDepartment: { department: deptName, director_threshold }, view: 'departmentForm' });
                return;
            }
            if (action === 'delete-department') {
                const deptName = btn.dataset.dept;
                if (!confirm(`確定要刪除部門「${deptName}」嗎？此動作無法復原。`)) return;
                try {
                    updateState({ loading: true });
                    const { error } = await supabase.from('departments').delete().eq('department', deptName);
                    if (error) throw error;
                    const newDepartments = { ...state.departments };
                    delete newDepartments[deptName];
                    updateState({ departments: newDepartments, loading: false });
                    showMessage('已刪除部門。', 'success');
                    renderDepartmentManagement();
                } catch (err) {
                    console.error(err);
                    updateState({ loading: false });
                    showMessage('刪除部門失敗：' + (err.message || err), 'error');
                }
            }
        });

        // 部門表單事件
        document.getElementById('departmentForm-view').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.dataset.action;
            if (action === 'save-department') {
                const form = document.getElementById('department-form');
                const formData = new FormData(form);
                const department = (formData.get('department') || '').trim();
                const director_threshold_raw = formData.get('director_threshold');
                const director_threshold = director_threshold_raw === '' ? null : Number(director_threshold_raw);
                if (!department) {
                    showMessage('請輸入部門名稱。', 'error');
                    return;
                }
                try {
                    updateState({ loading: true });
                    const payload = { department, director_threshold };
                    const { error } = await supabase.from('departments').upsert(payload, { onConflict: 'department' });
                    if (error) throw error;
                    const newDepartments = { ...state.departments, [department]: director_threshold };
                    updateState({ departments: newDepartments, loading: false, view: 'departmentManagement', editingDepartment: null });
                    showMessage('部門已儲存。', 'success');
                } catch (err) {
                    console.error(err);
                    updateState({ loading: false });
                    showMessage('儲存失敗：' + (err.message || err), 'error');
                }
            }
        });

        document.getElementById('userForm-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'save-user') {
                const form = document.getElementById('user-form');
                if (!form.reportValidity()) return;

                const formData = new FormData(form);
                const isEditing = !!state.editingUser;

                const userData = {
                    ...Object.fromEntries(formData.entries()),
                    is_admin: form.elements.is_admin.checked,
                    is_department_head: form.elements.is_department_head.checked,
                    is_enabled: form.elements.is_enabled.checked,
                    is_handler: form.elements.is_handler ? form.elements.is_handler.checked : false,
                };
                
                if (userData.manager_id === '') userData.manager_id = null;
                if (userData.manager_id2 === '') userData.manager_id2 = null;
                if (userData.manager_id3 === '') userData.manager_id3 = null;
                if (userData.department === '') userData.department = null;
                if (userData.demand_department === '') userData.demand_department = null;
                if (userData.default_invoice === '') userData.default_invoice = null;

                // 處理密碼欄位
                const shouldUpdatePassword = isEditing && userData.new_password;
                if (shouldUpdatePassword && userData.new_password.length < 6) {
                    showMessage('新密碼長度至少需要6位字元。', 'error');
                    return;
                }
                
                const newPassword = userData.new_password;
                delete userData.new_password; // 移除新密碼欄位，避免傳送到後端

                updateState({ loading: true });

                try {
                    if (isEditing) {
                        const userId = state.editingUser.id;
                        
                        // 更新使用者資料（不包含密碼）
                        const { data, error } = await supabase.functions.invoke('update-user-admin', {
                            body: { user_id: userId, userData: userData }
                        });
                        if (error) throw error;
                        if (data.error) throw new Error(data.error);

                        // 如果需要更新密碼，單獨處理
                        if (shouldUpdatePassword) {
                            const { data: passwordData, error: passwordError } = await supabase.functions.invoke('reset-user-password', {
                                body: { user_id: userId, new_password: newPassword }
                            });
                            if (passwordError) throw passwordError;
                            if (passwordData.error) throw new Error(passwordData.error);
                        }

                        state.users[userId] = data.user;
                        showMessage(shouldUpdatePassword ? '使用者資料和密碼更新成功！' : '使用者資料更新成功！');
                        updateState({ view: 'userManagement', loading: false, users: { ...state.users } });

                    } else {
                        const { password, ...profileData } = userData;
                        const { data, error: functionError } = await supabase.functions.invoke('create-user', {
                            body: {
                                email: userData.email,
                                password: password,
                                profileData: profileData
                            }
                        });

                        if (functionError) throw functionError;
                        if (data && data.error) throw new Error(data.error);
                        if (!data || !data.user) throw new Error('Edge Function 回傳了無效的資料格式。');

                        const newUserProfile = data.user;
                        state.users[newUserProfile.id] = newUserProfile;
                        showMessage('使用者新增成功！');
                        updateState({ view: 'userManagement', loading: false, users: { ...state.users } });
                    }
                } catch (err) {
                    console.error("儲存使用者失敗:", err);
                    let detailedErrorMessage;

                    if (isEditing) {
                        detailedErrorMessage = `更新使用者資料失敗.\n(原始錯誤: ${err.message})`;
                        detailedErrorMessage += "\n\n請檢查後端 'update-user-admin' 函數的日誌。";
                    } else {
                        detailedErrorMessage = `後端函數 'create-user' 執行失敗.\n(原始錯誤: ${err.message})`;
                        detailedErrorMessage += "\n\n請檢查您 Supabase 專案中該函數的日誌(Logs)以尋找根本原因。";
                    }

                    showMessage(detailedErrorMessage, 'error');
                    updateState({ loading: false });
                }
            } else if (button.id === 'show-password-btn') {
                // 切換密碼顯示/隱藏
                const passwordInput = button.previousElementSibling;
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    button.textContent = '隱藏';
                } else {
                    passwordInput.type = 'password';
                    button.textContent = '顯示';
                }
            }
        });

        document.getElementById('vendorManagement-view').addEventListener('keyup', (e) => {
            if (e.target.id === 'vendor-search-input') {
                clearTimeout(window.vendorSearchTimeout);
                window.vendorSearchTimeout = setTimeout(() => {
                    updateState({ local: { ...state.local, vendorManagementSearchTerm: e.target.value } });
                }, 300);
            }
        });

        document.getElementById('vendorManagement-view').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const vendorId = button.dataset.id;

            if (action === 'add-vendor') {
                updateState({ editingVendor: null, view: 'vendorForm' });
            } else if (action === 'edit-vendor') {
                const vendor = state.vendors.find(v => v.vendor_id === vendorId);
                updateState({ editingVendor: vendor, view: 'vendorForm' });
            } else if (action === 'delete-vendor') {
                const vendorName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">確認刪除廠商</h3>
                    <p class="mb-6">您確定要刪除廠商 "${vendorName}" 嗎？此操作無法復原。</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-id="${vendorId}" data-action="confirm-delete-vendor" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">確認刪除</button>
                    </div>
                `);
            }
        });

        document.getElementById('vendorForm-view').addEventListener('change', (e) => {
            const target = e.target;
            const form = document.getElementById('vendor-form');
            if (!form) return;

            if (target.id === 'copy-invoice-address') {
                form.elements.invoice_address.value = target.checked ? form.elements.address.value : '';
            } else if (target.id === 'copy-mailing-address') {
                form.elements.mailing_address.value = target.checked ? form.elements.address.value : '';
            }
        });

        document.getElementById('vendorForm-view').addEventListener('input', (e) => {
            const target = e.target;
            if (target.name === 'tax_id') {
                const errorEl = document.getElementById('tax-id-error');
                if (target.value && !validateTaxId(target.value)) {
                    errorEl.classList.remove('hidden');
                } else {
                    errorEl.classList.add('hidden');
                }
            }
        });

        document.getElementById('vendorForm-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || button.dataset.action !== 'save-vendor') return;

            const form = document.getElementById('vendor-form');
            if (!form.reportValidity()) return;

            const taxId = form.elements.tax_id.value;
            if (taxId && !validateTaxId(taxId)) {
                showMessage('統一編號格式錯誤，請檢查後再儲存。', 'error');
                return;
            }

            const formData = new FormData(form);
            const vendorData = Object.fromEntries(formData.entries());
            
            updateState({ loading: true });

            try {
                // 確認使用者有權限新增/修改廠商
                if (!state.currentUser) {
                    throw new Error('請先登入');
                }
                
                // 調試：輸出當前使用者資訊
                console.log('Current User Info:', {
                    name: state.currentUser.name,
                    role: state.currentUser.role,
                    is_admin: state.currentUser.is_admin,
                    id: state.currentUser.id
                });
                
                // 檢查使用者角色權限 - 暫時放寬條件
                const allowedRoles = ['採購', '採購主管', '院長'];
                const hasPermission = allowedRoles.includes(state.currentUser.role) || 
                                    state.currentUser.is_admin === true || 
                                    state.currentUser.role.includes('採購');
                
                console.log('Permission check:', {
                    userRole: state.currentUser.role,
                    isAdmin: state.currentUser.is_admin,
                    allowedRoles: allowedRoles,
                    hasPermission: hasPermission
                });
                
                if (!hasPermission) {
                    throw new Error(`您的角色 "${state.currentUser.role}" 沒有權限新增或修改廠商資料。需要以下角色之一：${allowedRoles.join(', ')} 或管理員權限。`);
                }
                
                const { data, error } = await supabase.from('vendors').upsert(vendorData, { onConflict: 'vendor_id' }).select().single();
                if (error) {
                    console.error('Vendor upsert error:', error);
                    if (error.code === '23505') throw new Error(`廠商代號 "${vendorData.vendor_id}" 已存在。`);
                    if (error.message.includes('row-level security')) {
                        // 臨時解決方案：提供更詳細的錯誤訊息和建議
                        console.error('RLS Policy Error:', error);
                        throw new Error(`資料庫安全策略阻止了此操作。
                        
可能的解決方案：
1. 請確認您的 Supabase vendors 資料表 RLS 策略允許您的使用者角色 "${state.currentUser.role}" 進行 INSERT/UPDATE 操作
2. 暫時關閉 vendors 資料表的 RLS：ALTER TABLE vendors DISABLE ROW LEVEL SECURITY;
3. 或建立允許策略：
   CREATE POLICY "Allow all authenticated users" ON vendors FOR ALL TO authenticated USING (true) WITH CHECK (true);

錯誤詳情: ${error.message}`);
                    }
                    throw error;
                }

                const index = state.vendors.findIndex(v => v.vendor_id === data.vendor_id);
                if (index > -1) {
                    state.vendors[index] = data;
                } else {
                    state.vendors.push(data);
                    state.vendors.sort((a, b) => a.vendor_id.localeCompare(b.vendor_id));
                }

                showMessage('廠商資料已儲存');
                updateState({ view: 'vendorManagement', loading: false, vendors: [...state.vendors] });
            } catch (err) {
                showMessage('儲存廠商失敗: ' + err.message, 'error');
                updateState({ loading: false });
            }
        });

        // 列印管理事件處理
        document.getElementById('printManagement-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'search-print-requests') {
                console.log('搜尋按鈕被點擊'); // 調試訊息
                
                const startDate = document.getElementById('print-start-date').value;
                const endDate = document.getElementById('print-end-date').value;
                const status = document.getElementById('print-status-filter').value;
                const applicant = document.getElementById('print-applicant-filter').value;

                console.log('搜尋條件:', { startDate, endDate, status, applicant }); // 調試訊息

                if (!startDate || !endDate) {
                    showMessage('請選擇開始和結束日期。', 'error');
                    return;
                }

                console.log('可用的申請單總數:', state.requests.length); // 調試訊息

                let filteredRequests = state.requests.filter(request => {
                    const requestDate = new Date(request.request_date);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999); // 包含結束日期當天

                    if (requestDate < start || requestDate > end) return false;
                    if (status && request.status !== status) return false;
                    if (applicant && request.applicant_id !== applicant) return false;

                    return true;
                });

                console.log('篩選後的申請單數量:', filteredRequests.length); // 調試訊息

                const tableBody = document.getElementById('print-results-table');
                const searchResults = document.getElementById('print-search-results');
                const printSelectedBtn = document.querySelector('[data-action="print-selected-requests"]');

                if (filteredRequests.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">查無符合條件的申請單</td></tr>';
                    printSelectedBtn.disabled = true;
                } else {
                    tableBody.innerHTML = filteredRequests.map(request => {
                        const applicantName = state.users[request.applicant_id]?.name || '未知';
                        return `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input type="checkbox" class="request-checkbox rounded border-gray-300 text-blue-600" value="${request.id}">
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.id}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${applicantName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${getFormattedDateTime(request.request_date)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.department}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.status}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${Number(request.total_amount).toLocaleString()}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button data-action="print-single-request" data-id="${request.id}" class="text-blue-600 hover:text-blue-900">預覽列印</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    printSelectedBtn.disabled = false;
                }

                searchResults.classList.remove('hidden');
            } else if (action === 'print-selected-requests') {
                const checkedBoxes = document.querySelectorAll('.request-checkbox:checked');
                if (checkedBoxes.length === 0) {
                    showMessage('請至少選擇一張申請單。', 'error');
                    return;
                }

                // 批量列印選取的申請單 - 彙總在一個視窗
                const selectedRequestIds = Array.from(checkedBoxes).map(cb => cb.value);
                printMultipleRequests(selectedRequestIds);
            } else if (action === 'print-single-request') {
                const requestId = button.dataset.id;
                printRequest(requestId);
            }
        });

        // 全選功能
        document.getElementById('printManagement-view').addEventListener('change', (e) => {
            if (e.target.id === 'select-all-print') {
                const checkboxes = document.querySelectorAll('.request-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            }
        });


    document.getElementById('modal-container').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            
            if(action === 'cancel-modal') {
                closeModal();
            } else if (button.id === 'reset-show-password-btn') {
                // 切換重設密碼的顯示/隱藏
                const passwordInput = document.getElementById('reset-new-password');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    button.textContent = '隱藏';
                } else {
                    passwordInput.type = 'password';
                    button.textContent = '顯示';
                }
                return; // 防止繼續執行其他邏輯
            } else if (action === 'confirm-change-password') {
                const newPassword = document.getElementById('new-password').value;
                if (!newPassword || newPassword.length < 6) {
                    showMessage('密碼長度至少需要6位字元。', 'error');
                    return;
                }

                updateState({ loading: true });
                try {
                    const { data, error } = await supabase.functions.invoke('reset-user-password', {
                        body: { 
                            user_id: state.currentUser.id, 
                            new_password: newPassword
                        }
                    });
                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    showMessage('密碼修改成功！下次登入時請使用新密碼。');
                    closeModal();
                } catch (err) {
                    showMessage('密碼修改失敗: ' + err.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            } else if (action === 'confirm-reset-password') {
                const newPassword = document.getElementById('reset-new-password').value;
                const confirmPassword = document.getElementById('reset-confirm-password').value;
                const targetUserId = button.dataset.userId;

                if (!newPassword || newPassword.length < 6) {
                    showMessage('密碼長度至少需要6位字元。', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showMessage('新密碼與確認密碼不符，請重新輸入。', 'error');
                    return;
                }

                updateState({ loading: true });
                try {
                    const { data, error } = await supabase.functions.invoke('reset-user-password', {
                        body: { 
                            user_id: targetUserId, 
                            new_password: newPassword
                        }
                    });
                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    showMessage('使用者密碼重設成功！');
                    closeModal();
                } catch (err) {
                    showMessage('密碼重設失敗: ' + err.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            } else if (action === 'confirm-handler-reject-all') {
                const requestId = button.dataset.id;
                const reason = (document.getElementById('handler-reject-reason')?.value || '').trim();
                if (!reason) { showMessage('請填寫退單理由。', 'error'); return; }
                updateState({ loading: true });
                try {
                    const req = state.requests.find(r => r.id === requestId);
                    if (!req) throw new Error('找不到單據');
                    const patch = { status: '已退回', handler_status: null, handler_id: null };
                    const { data: updated, error } = await supabase.from('requests').update(patch).eq('id', requestId).select().single();
                    if (error) throw error;
                    try {
                        await supabase.from('notifications').insert({ user_id: req.applicant_id, request_id: requestId, message: `您的申請單 ${requestId} 已被經辦退單。原因：${reason}`, is_read: false });
                    } catch {}
                    const newRequests = state.requests.map(r => r.id === requestId ? updated : r);
                    closeModal();
                    showMessage('已退單');
                    getFilteredRequests.resetCache?.();
                    updateState({ requests: newRequests, selectedRequest: updated, loading: false });
                } catch (err) {
                    updateState({ loading: false });
                    showMessage('退單失敗: ' + err.message, 'error');
                }
            } else if (action === 'confirm-reject-all' || action === 'confirm-reject-previous') {
                const reason = document.getElementById('rejection-reason').value;
                if (!reason.trim()) {
                    showMessage('請填寫退回理由。', 'error');
                    return;
                }

                updateState({ loading: true });
                try {
                    const currentRequest = state.selectedRequest;
                    const approvers = JSON.parse(JSON.stringify(currentRequest.approvers)); // Deep copy
                    const currentStepIndex = approvers.findIndex(a => a.status === 'pending');

                    if (currentStepIndex !== -1) {
                        let newStatus = '待審核';
                        let notificationMessage = '';
                        
                        if (action === 'confirm-reject-previous' && currentStepIndex > 0) {
                            // Revert previous approver to pending
                            approvers[currentStepIndex - 1].status = 'pending';
                            approvers[currentStepIndex - 1].date = '';
                            approvers[currentStepIndex - 1].reason = '';
                            approvers[currentStepIndex - 1].comment = `由 ${state.currentUser.name} 退回，請重新審核。`;
                            
                            // Mark current approver's rejection in their comment field, but keep them pending for the future
                            approvers[currentStepIndex].comment = `於 ${getFormattedDateTime(new Date())} 退回。原因: ${reason}`;

                            notificationMessage = `您的申請單 ${currentRequest.id} 已由 ${state.currentUser.name} 退回至上一層簽核。原因：${reason}`;
                            
                            // Notify the previous approver as well
                             await supabase.from('notifications').insert({
                                user_id: approvers[currentStepIndex - 1].userId,
                                request_id: currentRequest.id,
                                message: `申請單 ${currentRequest.id} 已被退回給您重新簽核。原因：${reason}`,
                                is_read: false
                            });

                        } else { // This handles 'confirm-reject-all' and 'confirm-reject-previous' on first step
                            approvers[currentStepIndex].status = 'rejected';
                            approvers[currentStepIndex].date = new Date().toISOString();
                            approvers[currentStepIndex].reason = reason;
                            newStatus = '已退回';
                            notificationMessage = `您的申請單 ${currentRequest.id} 已被 ${state.currentUser.name} 整筆退回。原因：${reason}`;
                        }
                        
                        const { data: updatedRequest, error } = await supabase
                            .from('requests')
                            .update({ approvers, status: newStatus })
                            .eq('id', currentRequest.id)
                            .select()
                            .single();
                        
                        if (error) throw error;

                        // Notify applicant
                        await supabase.from('notifications').insert({
                            user_id: currentRequest.applicant_id,
                            request_id: currentRequest.id,
                            message: notificationMessage,
                            is_read: false
                        });

                        const newRequests = state.requests.map(r => r.id === updatedRequest.id ? updatedRequest : r);
                        getFilteredRequests.resetCache();
                        
                        showMessage('申請單已退回');
                        closeModal();
                        updateState({ view: 'dashboard', loading: false, requests: newRequests });

                    } else {
                         throw new Error("找不到待簽核的步驟。");
                    }
                } catch (err) {
                    console.error("退回失敗:", err);
                    showMessage('退回失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'confirm-delete-vendor') {
                const vendorId = button.dataset.id;
                try {
                    const { error } = await supabase.from('vendors').delete().eq('vendor_id', vendorId);
                    if (error) throw error;
                    
                    const newVendors = state.vendors.filter(v => v.vendor_id !== vendorId);
                    showMessage('廠商已成功刪除');
                    closeModal();
                    updateState({ vendors: newVendors, view: 'vendorManagement' });
                } catch (err) {
                    console.error("刪除廠商失敗:", err);
                    showMessage('刪除廠商失敗: ' + err.message, 'error');
                    closeModal();
                }
            } else if (action === 'confirm-delete-product') {
                const productId = button.dataset.id;
                if (productId) {
                    try {
                        const { error } = await supabase.from('products').delete().eq('id', productId);
                        if(error) throw error;
                        
                        const newAllProducts = state.allProducts.filter(p => p.id != productId);
                        
                        const newProductsData = {};
                        newAllProducts.forEach(product => {
                            const category = product.category;
                            if (!newProductsData[category]) newProductsData[category] = [];
                            newProductsData[category].push(product);
                        });
                        
                        showMessage('商品已成功刪除');
                        closeModal();
                        
                        updateState({ allProducts: newAllProducts, products: newProductsData });

                    } catch (err) {
                        console.error("刪除商品失敗:", err);
                        showMessage('刪除失敗: ' + err.message, 'error');
                        closeModal();
                    }
                }
            } else if (action === 'confirm-delete-user') {
                const userId = button.dataset.id;
                if (userId === state.currentUser.id) {
                    showMessage('無法刪除您自己。', 'error');
                    return;
                }

                try {
                    const { data, error } = await supabase.functions.invoke('delete-user-admin', {
                        body: { user_id: userId }
                    });

                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    delete state.users[userId];
                    showMessage('使用者已成功刪除');
                    closeModal();
                    updateState({ users: { ...state.users } });

                } catch (err) {
                    console.error("刪除使用者失敗:", err);
                    showMessage('刪除使用者失敗: ' + err.message, 'error');
                    closeModal();
                }
            } else if (action === 'confirm-consolidation') {
                const selectedStatuses = [...document.querySelectorAll('.consolidation-status-checkbox:checked')].map(cb => cb.value);
                const selectedClosedStatuses = [...document.querySelectorAll('.consolidation-closed-checkbox:checked')].map(cb => cb.value);
                const selectedHandlerStatuses = [...document.querySelectorAll('.consolidation-handler-checkbox:checked')].map(cb => cb.value);
                if (selectedStatuses.length === 0 && selectedClosedStatuses.length === 0 && selectedHandlerStatuses.length === 0) {
                    showMessage('請至少在任一區塊選擇一種條件', 'error');
                    return;
                }

                let requestsToProcess;
                if (state.local.selectedRequestIds.size > 0) {
                    requestsToProcess = state.requests.filter(req => state.local.selectedRequestIds.has(req.id));
                } else {
                    requestsToProcess = getFilteredRequests();
                }

                const filteredByStatus = requestsToProcess.filter(req => {
                    const passApproval = selectedStatuses.length === 0 ? true : selectedStatuses.includes(req.status);
                    const passClosed = selectedClosedStatuses.length === 0 ? true : selectedClosedStatuses.includes(req.closed_status || '未結案');
                    // 經辦狀態回推：若尚未有 handler_status，且簽核為已核准則視作待經辦；否則未經辦
                    const effectiveHandler = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                    const passHandler = selectedHandlerStatuses.length === 0 ? true : selectedHandlerStatuses.includes(effectiveHandler);
                    return passApproval && passClosed && passHandler;
                });

                if (filteredByStatus.length === 0) {
                    showMessage('沒有符合選取狀態的訂單可彙整', 'error');
                    closeModal();
                    return;
                }

                const consolidated = {};
                filteredByStatus.forEach(req => {
                    (req.items || []).forEach(item => {
                        const vendorId = item.vendor || '未指定廠商';
                        const vendorInfo = state.vendors.find(v => v.vendor_id === vendorId);
                        const vendorKey = vendorInfo ? (vendorInfo.short_name || vendorInfo.name) : vendorId;

                        if (!consolidated[vendorKey]) {
                            consolidated[vendorKey] = { items: {}, total: 0 };
                        }
                        const itemKey = item.id || item.name;
                                if (!consolidated[vendorKey].items[itemKey]) {
                                    // 保留來源申請單的申請部門，若 item 已有 department 使用 item.department
                                    consolidated[vendorKey].items[itemKey] = { ...item, quantity: 0, subtotal: 0, department: req.department || (item.department || '') };
                                }
                        consolidated[vendorKey].items[itemKey].quantity += item.quantity;
                        consolidated[vendorKey].items[itemKey].subtotal += item.quantity * item.price;
                        consolidated[vendorKey].total += item.quantity * item.price;
                    });
                });
                
                state.local.consolidatedData = consolidated;

                let modalHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">廠商彙總採購單</h2>
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center text-sm select-none">
                                <input id="consolidation-include-images" type="checkbox" class="mr-2" checked /> 是否顯示圖片
                            </label>
                            <label class="inline-flex items-center text-sm select-none">
                                行高(pt)
                                <input id="consolidation-row-height" type="number" min="10" max="200" step="1" value="80" class="ml-2 w-20 border rounded px-2 py-1" />
                            </label>
                            <button data-action="export-consolidation-xlsx" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">匯出 XLSX</button>
                            <button data-action="cancel-modal" class="ml-2 px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">關閉</button>
                        </div>
                    </div>
                `;

                Object.entries(consolidated).forEach(([vendor, data]) => {
                    modalHTML += `
                        <div class="mb-6 border rounded-lg p-4">
                            <h3 class="text-lg font-bold mb-2 bg-gray-100 p-2 rounded">${vendor} - 總金額: ${data.total.toLocaleString()}</h3>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left">品名</th>
                                        <th class="px-4 py-2 text-left">規格</th>
                                        <th class="px-4 py-2 text-right">單價</th>
                                        <th class="px-4 py-2 text-right">總數量</th>
                                        <th class="px-4 py-2 text-right">小計</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${Object.values(data.items).map(item => `
                                        <tr>
                                            <td class="px-4 py-2">${item.name}</td>
                                            <td class="px-4 py-2">${item.spec || ''}</td>
                                            <td class="px-4 py-2 text-right">${item.price.toLocaleString()}</td>
                                            <td class="px-4 py-2 text-right">${item.quantity} ${item.unit}</td>
                                            <td class="px-4 py-2 text-right">${item.subtotal.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                renderModal(modalHTML);

            } else if (action === 'export-consolidation-xlsx') {
                if (!state.local.consolidatedData) {
                    showMessage('沒有可匯出的彙整資料', 'error');
                    return;
                }
                // UX: 鎖定按鈕並提示進度
                const prevText_CON = button.textContent;
                button.disabled = true;
                button.textContent = '匯出中...';
                showWorking();
                try {
                    const includeImages = !!document.getElementById('consolidation-include-images')?.checked;
                    const rowHeightPt = Math.max(10, Math.min(200, parseInt(document.getElementById('consolidation-row-height')?.value || '80', 10)));
                    // 優先嘗試 ExcelJS（更穩定的嵌圖）
                    try {
                        await exportConsolidationWithExcelJS(state.local.consolidatedData, state.allProducts, includeImages, rowHeightPt);
                        showMessage('匯出完成');
                        closeModal();
                        return;
                    } catch (_) {
                        // ignore -> fallback
                    }

                    const workbook = await XlsxPopulate.fromBlankAsync();
                    const imageTasks = [];
                    const consolidatedData = state.local.consolidatedData;

                    // 彙總的工作表
                    const summarySheet = workbook.addSheet("彙總");
                    // headers: 圖片, 商品編號, 廠商代號, 廠商簡稱, 申請部門, 需求課室, 發票開立, 品名, 規格, 單價, 單位, 總數量, 小計
                    summarySheet.cell("A1").value("圖片");
                    summarySheet.cell("B1").value("商品編號");
                    summarySheet.cell("C1").value("廠商代號");
                    summarySheet.cell("D1").value("廠商簡稱");
                    summarySheet.cell("E1").value("申請部門");
                    summarySheet.cell("F1").value("需求課室");
                    summarySheet.cell("G1").value("發票開立");
                    summarySheet.cell("H1").value("品名");
                    summarySheet.cell("I1").value("規格");
                    summarySheet.cell("J1").value("單價");
                    summarySheet.cell("K1").value("單位");
                    summarySheet.cell("L1").value("總數量");
                    summarySheet.cell("M1").value("小計");
                    summarySheet.row(1).style("bold", true);
                    summarySheet.row(1).height(40);

                    const summaryItems = {};
                    Object.values(consolidatedData).forEach(vendorData => {
                        Object.values(vendorData.items).forEach(item => {
                            const key = `${item.name}|${item.spec}|${item.price}`;
                            if (!summaryItems[key]) {
                                summaryItems[key] = { ...item, quantity: 0, subtotal: 0 };
                            }
                            summaryItems[key].quantity += item.quantity;
                            summaryItems[key].subtotal += item.subtotal;
                        });
                    });

                    let summaryRowIndex = 2;
                    let summaryTotal = 0;
                    Object.values(summaryItems).forEach(item => {
                        // 圖片：寫入 thumbnail 連結（若 item.image 可用）
                        const r = summaryRowIndex;
                        summarySheet.cell(`A${r}`).value(item.image ? `https://drive.google.com/thumbnail?id=${item.image}` : '');
                        summarySheet.cell(`B${r}`).value(item.product_id || '');
                        summarySheet.cell(`C${r}`).value(item.vendor_code || '');
                        summarySheet.cell(`D${r}`).value(item.vendor_short || '');
                        summarySheet.cell(`E${r}`).value(item.department || '');
                        summarySheet.cell(`F${r}`).value(item.demand_department || '');
                        summarySheet.cell(`G${r}`).value(item.invoice || '');
                        summarySheet.cell(`H${r}`).value(item.name || '');
                        summarySheet.cell(`I${r}`).value(item.spec || '');
                        summarySheet.cell(`J${r}`).value(item.price).style("numberFormat", "$#,##0.00");
                        summarySheet.cell(`K${r}`).value(item.unit || '');
                        summarySheet.cell(`L${r}`).value(item.quantity || 0);
                        summarySheet.cell(`M${r}`).value(item.subtotal || 0).style("numberFormat", "$#,##0.00");
                        summarySheet.row(r).height(40);
                        summaryTotal += Number(item.subtotal || 0);
                        summaryRowIndex++;
                    });

                    // summary totals row
                    summarySheet.cell(`H${summaryRowIndex + 1}`).value("總計").style("bold", true);
                    summarySheet.cell(`L${summaryRowIndex + 1}`).value(Object.values(summaryItems).reduce((s, it) => s + Number(it.quantity || 0), 0)).style("bold", true);
                    summarySheet.cell(`M${summaryRowIndex + 1}`).value(summaryTotal).style({bold: true, numberFormat: "$#,##0.00"});
                    summarySheet.row(summaryRowIndex + 1).height(40);


                    // 各廠商的工作表
                    Object.entries(consolidatedData).forEach(([vendor, data]) => {
                        const sheet = workbook.addSheet(vendor.replace(/[\/\\?*[\]]/g, ''));
                        // 欄位：圖片、廠商代號、廠商簡稱、商品編號、品名、規格、單價、總數量、單位、小計、申請部門、需求課室、發票開立
                        sheet.cell("A1").value("圖片");
                        sheet.cell("B1").value("廠商代號");
                        sheet.cell("C1").value("廠商簡稱");
                        sheet.cell("D1").value("商品編號");
                        sheet.cell("E1").value("品名");
                        sheet.cell("F1").value("規格");
                        sheet.cell("G1").value("單價");
                        sheet.cell("H1").value("總數量");
                        sheet.cell("I1").value("單位");
                        sheet.cell("J1").value("小計");
                        sheet.cell("K1").value("申請部門");
                        sheet.cell("L1").value("需求課室");
                        sheet.cell("M1").value("發票開立");
                        sheet.row(1).style("bold", true);
                        sheet.row(1).height(40);

                        let vendorQtyTotal = 0;
                        Object.values(data.items).forEach((item, index) => {
                            const row = index + 2;
                            // 圖片：嘗試嵌入圖片，失敗則退回連結文字
                            let fileId = '';
                            try {
                                const prod = (state.allProducts || []).find(p => p.id === item.id);
                                if (prod && prod.image) fileId = prod.image;
                            } catch {}
                            if (fileId && typeof sheet.addImage === 'function') {
                                // 使用 thumbnail 端點提升跨域成功率
                                const url = `https://drive.google.com/thumbnail?id=${fileId}`;
                                imageTasks.push((async () => {
                                    try {
                                        const resp = await fetch(url);
                                        const buf = await resp.arrayBuffer();
                                        const ct = (resp.headers.get('content-type') || '').toLowerCase();
                                        const imgType = ct.includes('jpeg') || ct.includes('jpg') ? 'image/jpeg' : 'image/png';
                                        try {
                                            const img = typeof workbook.addImage === 'function'
                                                ? await workbook.addImage({ image: buf, type: imgType })
                                                : null;
                                            sheet.row(row).height(60);
                                            if (img) {
                                                sheet.addImage(img, {
                                                    tl: { col: 0.2, row: row - 0.8 },
                                                    br: { col: 1.8, row: row - 0.05 },
                                                    editAs: 'oneCell'
                                                });
                                            } else {
                                                // 一些版本可能直接支援 sheet.addImage(buffer,...)
                                                sheet.addImage({ image: buf, type: imgType }, {
                                                    tl: { col: 0.2, row: row - 0.8 },
                                                    br: { col: 1.8, row: row - 0.05 },
                                                    editAs: 'oneCell'
                                                });
                                            }
                                        } catch (e2) {
                                            sheet.cell(`A${row}`).value(url);
                                        }
                                    } catch (e) {
                                        sheet.cell(`A${row}`).value(url);
                                    }
                                })());
                            } else {
                                sheet.cell(`A${row}`).value(fileId ? `https://drive.google.com/thumbnail?id=${fileId}` : '');
                            }
                            // 廠商代號與簡稱：嘗試從 consolidated key 或 state.vendors 推斷
                            const vendorInfoForSheet = (state && state.vendors) ? state.vendors.find(v => v.vendor_id === vendor || v.short_name === vendor || v.name === vendor) : null;
                            const vendorCodeForSheet = vendorInfoForSheet ? vendorInfoForSheet.vendor_id : vendor;
                            const vendorShortForSheet = vendorInfoForSheet ? (vendorInfoForSheet.short_name || vendorInfoForSheet.name) : (vendor || '');

                            sheet.cell(`B${row}`).value(vendorCodeForSheet);
                            sheet.cell(`C${row}`).value(vendorShortForSheet);
                            sheet.cell(`D${row}`).value(item.id || '');
                            sheet.cell(`E${row}`).value(item.name);
                            sheet.cell(`F${row}`).value(item.spec);
                            sheet.cell(`G${row}`).value(item.price).style("numberFormat", "$#,##0.00");
                            sheet.cell(`H${row}`).value(item.quantity);
                            vendorQtyTotal += Number(item.quantity || 0);
                            sheet.cell(`I${row}`).value(item.unit);
                            sheet.cell(`J${row}`).value(item.subtotal).style("numberFormat", "$#,##0.00");
                            sheet.row(row).height(40);
                            // 申請/需求/發票：來源於彙整時不同單據可能不同，這裡以項目或彙整時記錄的 department 為主
                            sheet.cell(`K${row}`).value(item.department || (data.department || '') );
                            sheet.cell(`L${row}`).value(item.demand_department || '');
                            const inv = item.invoice === '其他' ? (item.custom_invoice || '其他') : (item.invoice || '');
                            sheet.cell(`M${row}`).value(inv);
                        });
                        const itemCount = Object.values(data.items).length;
                        const blankRowIdx = itemCount + 2;
                        const totalRow = itemCount + 3;
                        sheet.row(blankRowIdx).height(40);
                        // 總計：label 放在品名欄(E)，數量總計放在 H，金額總計放在 J
                        sheet.cell(`E${totalRow}`).value("總計").style("bold", true);
                        sheet.cell(`H${totalRow}`).value(vendorQtyTotal).style("bold", true);
                        sheet.cell(`J${totalRow}`).value(data.total).style({bold: true, numberFormat: "$#,##0.00"});
                        sheet.row(totalRow).height(40);
                    });

                    // 確保所有圖片都已插入
                    if (imageTasks.length) {
                        try { await Promise.all(imageTasks); } catch {}
                    }

                    workbook.deleteSheet("Sheet1"); // Delete default sheet
                    const blob = await workbook.outputAsync();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    document.body.appendChild(a);
                    a.style = "display: none";
                    a.href = url;
                    a.download = `廠商彙總訂單_${getISODateString(new Date())}.xlsx`;
                    a.click();
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showMessage('匯出完成');
                    closeModal();
                } catch (err) {
                    console.error("匯出 Excel 失敗:", err);
                    showMessage("匯出 Excel 失敗: " + err.message, 'error');
                } finally {
                    hideWorking();
                    // 還原按鈕（若尚未關閉視窗）
                    if (document.body.contains(button)) {
                        button.disabled = false;
                        button.textContent = prevText_CON;
                    }
                }
            } else if (action === 'confirm-export-orders-preview') {
                // 讀取勾選條件
                const selectedStatuses = [...document.querySelectorAll('.export-status-checkbox:checked')].map(cb => cb.value);
                const selectedClosedStatuses = [...document.querySelectorAll('.export-closed-checkbox:checked')].map(cb => cb.value);
                const selectedHandlerStatuses = [...document.querySelectorAll('.export-handler-checkbox:checked')].map(cb => cb.value);

                // 收集資料來源：優先使用使用者選取的多選，其次使用目前篩選的全部
                let requestsToProcess;
                if (state.local.selectedRequestIds.size > 0) {
                    requestsToProcess = state.requests.filter(req => state.local.selectedRequestIds.has(req.id));
                } else {
                    requestsToProcess = getFilteredRequests();
                }

                const filtered = requestsToProcess.filter(req => {
                    const passApproval = selectedStatuses.length === 0 ? true : selectedStatuses.includes(req.status);
                    const passClosed = selectedClosedStatuses.length === 0 ? true : selectedClosedStatuses.includes(req.closed_status || '未結案');
                    const effectiveHandler = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                    const passHandler = selectedHandlerStatuses.length === 0 ? true : selectedHandlerStatuses.includes(effectiveHandler);
                    return passApproval && passClosed && passHandler;
                });

                if (filtered.length === 0) { showMessage('沒有符合條件的資料可彙整', 'error'); return; }

                // 整備平面資料供預覽與後續 XLSX
                    const flatRows = [];
                filtered.forEach(req => {
                    const orderType = req.type || '特採';
                    const applicant = state.users[req.applicant_id]?.name || req.applicant_id;
                    const approval = (req.approvers || []).map(a => `${a.role}:${a.status}`).join('; ');
                    const handler = req.handler_status || (req.status === '已核准' ? '待經辦' : '未經辦');
                    const closed = req.closed_status || '未結案';
                            if ((req.items || []).length > 0) {
                        (req.items || []).forEach(item => flatRows.push({
                            id: req.id,
                            type: orderType,
                            date: getFormattedDateTime(req.request_date),
                            applicant,
                            department: req.department || '',
                            demand_department: item.demand_department || (state.users[req.applicant_id]?.demand_department || ''),
                            invoice: item.invoice === '其他' ? (item.custom_invoice || '其他') : (item.invoice || (state.users[req.applicant_id]?.default_invoice || '')),
                            vendor: item.vendor || '',
                            // 新增廠商簡稱欄位（匯出時使用）
                            vendor_short: (state.vendors.find(v => v.vendor_id === item.vendor)?.short_name) || (item.vendor || ''),
                            approval: req.status,
                            handler,
                            closed,
                            name: item.name || '',
                            // 新增商品編號欄位（來自 item.id）
                            product_id: item.id || null,
                            spec: item.spec || '',
                            price: item.price || 0,
                            unit: item.unit || '',
                            quantity: item.quantity || 0,
                            subtotal: (item.price || 0) * (item.quantity || 0),
                            approval_flow: approval
                        }));
                    } else {
                        flatRows.push({ id: req.id, type: orderType, date: getFormattedDateTime(req.request_date), applicant, department: req.department || '', demand_department: '', invoice: '', vendor: '', approval: req.status, handler, closed, name: '', spec: '', price: 0, unit: '', quantity: 0, subtotal: 0, approval_flow: approval, product_id: null });
                    }
                });
                state.local.exportOrdersFlatRows = flatRows;

        const previewHead = ['申請單號','訂單類別','申請日期','申請人','申請部門','需求課室','發票開立','廠商代號','廠商簡稱','簽核狀態','經辦狀態','結案狀態','品名','商品編號','規格','單價','單位','數量','小計','簽核進度'];
        const previewRows = flatRows.slice(0, 200).map(r => `
                    <tr>
                        <td class="px-2 py-1">${r.id}</td>
                        <td class="px-2 py-1">${r.type}</td>
                        <td class="px-2 py-1 whitespace-nowrap">${r.date}</td>
                        <td class="px-2 py-1">${r.applicant}</td>
                        <td class="px-2 py-1">${r.department}</td>
                        <td class="px-2 py-1">${r.demand_department}</td>
                        <td class="px-2 py-1">${r.invoice}</td>
            <td class="px-2 py-1">${r.vendor}</td>
            <td class="px-2 py-1">${r.vendor_short || ''}</td>
                        <td class="px-2 py-1">${r.approval}</td>
                        <td class="px-2 py-1">${r.handler}</td>
                        <td class="px-2 py-1">${r.closed}</td>
            <td class="px-2 py-1">${r.name}</td>
            <td class="px-2 py-1">${r.product_id || ''}</td>
            <td class="px-2 py-1">${r.spec}</td>
                        <td class="px-2 py-1 text-right">${r.price}</td>
                        <td class="px-2 py-1">${r.unit}</td>
                        <td class="px-2 py-1 text-right">${r.quantity}</td>
                        <td class="px-2 py-1 text-right">${r.subtotal}</td>
                        <td class="px-2 py-1">${r.approval_flow}</td>
                    </tr>
                `).join('');

                renderModal(`
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold">匯出訂單 - 彙整預覽（僅顯示前200筆）</h3>
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center text-sm select-none">
                                <input id="orders-include-images" type="checkbox" class="mr-2" checked /> 是否顯示圖片
                            </label>
                            <label class="inline-flex items-center text-sm select-none">
                                行高(pt)
                                <input id="orders-row-height" type="number" min="10" max="200" step="1" value="80" class="ml-2 w-20 border rounded px-2 py-1" />
                            </label>
                            <button data-action="export-orders-xlsx" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">匯出 XLSX</button>
                            <button data-action="cancel-modal" class="ml-2 px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">關閉</button>
                        </div>
                    </div>
                    <div class="max-h-[60vh] overflow-auto border rounded">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>${previewHead.map(h => `<th class='px-2 py-2 text-left'>${h}</th>`).join('')}</tr>
                            </thead>
                            <tbody class="bg-white divide-y">${previewRows}</tbody>
                        </table>
                    </div>
                `);
            } else if (action === 'export-orders-xlsx') {
                const flatRows = state.local.exportOrdersFlatRows || [];
                if (!flatRows.length) { showMessage('沒有可匯出的資料', 'error'); return; }
                // UX: 鎖定按鈕並提示進度
                const prevText_ORD = button.textContent;
                button.disabled = true;
                button.textContent = '匯出中...';
                showWorking();
                try {
                    const includeImages = !!document.getElementById('orders-include-images')?.checked;
                    const rowHeightPt = Math.max(10, Math.min(200, parseInt(document.getElementById('orders-row-height')?.value || '80', 10)));
                    // 優先嘗試 ExcelJS（更穩定的嵌圖）
                    try {
                        await exportOrdersWithExcelJS(flatRows, state.allProducts, includeImages, rowHeightPt);
                        showMessage('匯出完成');
                        closeModal();
                        return;
                    } catch (_) {
                        // ignore -> fallback
                    }

                    const workbook = await XlsxPopulate.fromBlankAsync();
                    const sheet = workbook.addSheet('訂單彙整');
                    const headers = ['圖片','申請單號','訂單類別','申請日期','申請人','申請部門','需求課室','發票開立','廠商代號','廠商簡稱','簽核狀態','經辦狀態','結案狀態','品名','商品編號','規格','單價','單位','數量','小計','簽核進度'];
                    headers.forEach((h, i) => sheet.cell(1, i+1).value(h));
                    sheet.row(1).style('bold', true);
                    sheet.row(1).height(40);
                    const colWidths = [12, 16, 10, 18, 12, 12, 12, 12, 12, 12, 10, 10, 10, 20, 14, 20, 10, 8, 8, 12, 24];
                    colWidths.forEach((w, i) => sheet.column(i+1).width(w));

                    const productImageById = {};
                    (state.allProducts || []).forEach(p => { if (p.id && p.image) productImageById[p.id] = p.image; });

                    let rowIndex = 2;
                    for (const r of flatRows) {
                        // 資料欄
                        sheet.cell(rowIndex, 2).value(r.id);
                        sheet.cell(rowIndex, 3).value(r.type);
                        sheet.cell(rowIndex, 4).value(r.date);
                        sheet.cell(rowIndex, 5).value(r.applicant);
                        sheet.cell(rowIndex, 6).value(r.department);
                        sheet.cell(rowIndex, 7).value(r.demand_department);
                        sheet.cell(rowIndex, 8).value(r.invoice);
                        sheet.cell(rowIndex, 9).value(r.vendor);
                        // 廠商簡稱
                        sheet.cell(rowIndex, 10).value(r.vendor_short || '');
                        sheet.cell(rowIndex, 11).value(r.approval);
                        sheet.cell(rowIndex, 12).value(r.handler);
                        sheet.cell(rowIndex, 13).value(r.closed);
                        sheet.cell(rowIndex, 14).value(r.name);
                        // 商品編號
                        sheet.cell(rowIndex, 15).value(r.product_id || '');
                        sheet.cell(rowIndex, 16).value(r.spec);
                        sheet.cell(rowIndex, 17).value(r.price).style('numberFormat', '$#,##0.00');
                        sheet.cell(rowIndex, 18).value(r.unit);
                        sheet.cell(rowIndex, 19).value(r.quantity);
                        sheet.cell(rowIndex, 20).value(r.subtotal).style('numberFormat', '$#,##0.00');
                        sheet.cell(rowIndex, 21).value(r.approval_flow);
                        sheet.row(rowIndex).height(40);

                        // 圖片（如有）：嘗試嵌入，失敗則連結
                        const fileId = r.product_id ? productImageById[r.product_id] : null;
                        if (fileId) {
                            // 使用 thumbnail 端點提升跨域成功率
                            const url = `https://drive.google.com/thumbnail?id=${fileId}`;
                            try {
                                const resp = await fetch(url);
                                const buf = await resp.arrayBuffer();
                                const ct = (resp.headers.get('content-type') || '').toLowerCase();
                                const imgType = ct.includes('jpeg') || ct.includes('jpg') ? 'image/jpeg' : 'image/png';
                                sheet.row(rowIndex).height(60);
                                if (typeof workbook.addImage === 'function') {
                                    try {
                                        const img = await workbook.addImage({ image: buf, type: imgType });
                                        sheet.addImage(img, {
                                            tl: { col: 0.2, row: rowIndex - 0.8 },
                                            br: { col: 1.8, row: rowIndex - 0.05 },
                                            editAs: 'oneCell'
                                        });
                                    } catch {
                                        if (typeof sheet.addImage === 'function') {
                                            sheet.addImage({ image: buf, type: imgType }, {
                                                tl: { col: 0.2, row: rowIndex - 0.8 },
                                                br: { col: 1.8, row: rowIndex - 0.05 },
                                                editAs: 'oneCell'
                                            });
                                        } else {
                                            sheet.cell(rowIndex, 1).value(url);
                                        }
                                    }
                                } else if (typeof sheet.addImage === 'function') {
                                    sheet.addImage({ image: buf, type: imgType }, {
                                        tl: { col: 0.2, row: rowIndex - 0.8 },
                                        br: { col: 1.8, row: rowIndex - 0.05 },
                                        editAs: 'oneCell'
                                    });
                                } else {
                                    sheet.cell(rowIndex, 1).value(url);
                                }
                            } catch (e) {
                                sheet.cell(rowIndex, 1).value(url);
                            }
                        }

                        rowIndex++;
                    }

                    workbook.deleteSheet('Sheet1');
                    const blob = await workbook.outputAsync();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    document.body.appendChild(a);
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `訂單彙整_${getISODateString(new Date())}.xlsx`;
                    a.click();
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showMessage('匯出完成');
                    closeModal();
                } catch (err) {
                    console.error('匯出 XLSX 失敗:', err);
                    showMessage('匯出 XLSX 失敗: ' + err.message, 'error');
                } finally {
                    hideWorking();
                    // 還原按鈕（若尚未關閉視窗）
                    if (document.body.contains(button)) {
                        button.disabled = false;
                        button.textContent = prevText_ORD;
                    }
                }
            } else if (action === 'confirm-batch-close') {
                const idsToClose = JSON.parse(button.dataset.ids);
                updateState({ loading: true });
                try {
                    // 逐筆附加結案歷程
                    for (const id of idsToClose) {
                        const req = state.requests.find(r => r.id === id);
                        if (!req) continue;
                        const newEntry = {
                            user: state.currentUser.name,
                            role: state.currentUser.role,
                            date: new Date().toISOString(),
                            reason: '結案',
                            action: 'closed'
                        };
                        const patch = { closed_status: '結案', modification_history: [...(req.modification_history || []), newEntry] };
                        const { error: upErr } = await supabase.from('requests').update(patch).eq('id', id);
                        if (upErr) throw upErr;
                    }
                    
                    showMessage(`${idsToClose.length} 筆訂單已成功結案。`);
                    closeModal();
                    
                    // 清除緩存並重新載入資料
                    CacheManager.clear('dashboard_data');
                    await loadDashboardData(false, false); // 強制不使用緩存
                    
                    // 重置篩選緩存
                    getFilteredRequests.resetCache();
                    
                    state.local.selectedRequestIds.clear();
                    render();
                } catch (err) {
                    showMessage('批次結案失敗: ' + err.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            } else if (action === 'confirm-batch-approve') {
                const comment = document.getElementById('batch-approval-comment').value;
                const selectedIds = Array.from(state.local.selectedRequestIds);
                const requestsToProcess = state.requests.filter(req => 
                    selectedIds.includes(req.id) &&
                    req.status === '待審核' &&
                    (req.approvers || []).find(a => a.status === 'pending')?.userId === state.currentUser.id
                );

                if (requestsToProcess.length === 0) {
                    showMessage('沒有可核准的單據。', 'error');
                    closeModal();
                    return;
                }

                updateState({ loading: true });
                try {
                    for (const request of requestsToProcess) {
                        const approvers = [...request.approvers];
                        const currentStepIndex = approvers.findIndex(a => a.status === 'pending');
                        if (currentStepIndex === -1) continue;

                        approvers[currentStepIndex].status = 'approved';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].comment = comment;

                        const isFinal = currentStepIndex === approvers.length - 1;
                        const newStatus = isFinal ? '已核准' : '待審核';

                        const { error: updateError } = await supabase.from('requests').update({ approvers, status: newStatus }).eq('id', request.id);
                        if(updateError) throw updateError;
                        
                        let notificationMessage = `您的申請單 ${request.id} 已由 ${state.currentUser.name} 核准。`;
                        if (isFinal) {
                            notificationMessage = `您的申請單 ${request.id} 已全數簽核完成！`;
                        }
                        const { error: notificationError } = await supabase.from('notifications').insert({
                            user_id: request.applicant_id,
                            request_id: request.id,
                            message: notificationMessage,
                            is_read: false
                        });
                        if(notificationError) console.error("Failed to create notification:", notificationError);
                    }
                    showMessage(`${requestsToProcess.length} 筆單據已成功核准。`);
                } catch (err) {
                    showMessage('批次核准失敗: ' + err.message, 'error');
                } finally {
                    closeModal();
                    state.local.selectedRequestIds.clear();
                    
                    // 清除緩存並重新載入資料
                    CacheManager.clear('dashboard_data');
                    await loadDashboardData(false, false); // 強制不使用緩存
                    
                    // 重置篩選緩存
                    getFilteredRequests.resetCache();
                    
                    updateState({ loading: false });
                }
            } else if (action === 'save-profile') {
                const form = document.getElementById('edit-profile-form');
                if (!form) return;

                const demandDepartment = document.getElementById('edit-profile-demand-department').value;
                const defaultInvoice = document.getElementById('edit-profile-invoice').value;
                const themePref = document.getElementById('edit-profile-theme').value;
                const menuLayout = document.getElementById('edit-profile-menu-layout').value; // 'expanded' or 'compact'

                updateState({ loading: true });
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .update({
                            demand_department: demandDepartment || null,
                            default_invoice: defaultInvoice || null,
                            theme_preference: themePref || null,
                            menu_layout: menuLayout || null
                        })
                        .eq('id', state.currentUser.id)
                        .select()
                        .single();

                    if (error) throw error;

                    state.currentUser = data;
                    // 立即套用主題與版型
                    if (themePref) {
                        applyTheme(themePref);
                        const sel = document.getElementById('theme-select');
                        if (sel) sel.value = state.theme; // applyTheme已處理隨機情況
                    }
                    if (menuLayout) {
                        state.local.layoutScale = menuLayout === 'compact' ? 'compact' : 'expanded';
                        localStorage.setItem('menuLayout', state.local.layoutScale);
                    }

                    showMessage('個人設定已更新');
                    closeModal();
                    render();
                } catch (err) {
                    showMessage('更新設定失敗: ' + err.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            } else if (action === 'confirm-batch-reject') {
                const reason = document.getElementById('batch-rejection-reason').value;
                if (!reason.trim()) {
                    showMessage('請填寫退回理由。', 'error');
                    return;
                }
            } else if (action === 'confirm-popover-reject-all' || action === 'confirm-popover-reject-previous') {
                const requestId = button.dataset.id;
                const reason = document.getElementById('popover-rejection-reason').value;
                if (!reason || !reason.trim()) { showMessage('請填寫退回理由。', 'error'); return; }

                const req = state.requests.find(r => r.id === requestId);
                if (!req) { showMessage('找不到單據', 'error'); return; }
                const approvers = [...(req.approvers || [])];
                const currentStepIndex = approvers.findIndex(a => a.status === 'pending');
                if (currentStepIndex === -1 || approvers[currentStepIndex].userId !== state.currentUser.id) {
                    showMessage('您不是此單目前的簽核人。', 'error');
                    return;
                }
                updateState({ loading: true });
                try {
                    let newStatus = '已退回';
                    let notificationMessage = '';
                    if (action === 'confirm-popover-reject-previous' && currentStepIndex > 0) {
                        approvers[currentStepIndex - 1].status = 'pending';
                        approvers[currentStepIndex - 1].date = '';
                        approvers[currentStepIndex - 1].comment = '';
                        newStatus = '待審核';
                        approvers[currentStepIndex].status = 'rejected';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].reason = reason;
                        approvers[currentStepIndex].comment = `由 ${state.currentUser.name} 退回上一層。`;
                        notificationMessage = `您的申請單 ${requestId} 已由 ${state.currentUser.name} 退回至上一層簽核。原因：${reason}`;
                    } else {
                        approvers[currentStepIndex].status = 'rejected';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].reason = reason;
                        approvers[currentStepIndex].comment = `於 ${getFormattedDateTime(new Date())} 退回。原因: ${reason}`;
                        newStatus = '已退回';
                        notificationMessage = `您的申請單 ${requestId} 已被 ${state.currentUser.name} 整筆退回。原因：${reason}`;
                    }

                    const { data: updated, error: updateErr } = await supabase.from('requests')
                        .update({ approvers, status: newStatus })
                        .eq('id', requestId)
                        .select()
                        .single();
                    if (updateErr) throw updateErr;

                    try {
                        await supabase.from('notifications').insert({ user_id: req.applicant_id, request_id: requestId, message: notificationMessage, is_read: false });
                    } catch {}

                    const newRequests = state.requests.map(r => r.id === requestId ? updated : r);
                    getFilteredRequests.resetCache?.();
                    updateState({ requests: newRequests, loading: false });
                    closeModal();
                    showMessage('已退回');
                } catch (err) {
                    updateState({ loading: false });
                    showMessage('退回失敗: ' + err.message, 'error');
                }
                const selectedIds = Array.from(state.local.selectedRequestIds);
                const requestsToProcess = state.requests.filter(req => 
                    selectedIds.includes(req.id) &&
                    req.status === '待審核' &&
                    (req.approvers || []).find(a => a.status === 'pending')?.userId === state.currentUser.id
                );

                if (requestsToProcess.length === 0) {
                    showMessage('沒有可退回的單據。', 'error');
                    closeModal();
                    return;
                }

                updateState({ loading: true });
                try {
                    for (const request of requestsToProcess) {
                        const approvers = [...request.approvers];
                        const currentStepIndex = approvers.findIndex(a => a.status === 'pending');
                        if (currentStepIndex === -1) continue;

                        approvers[currentStepIndex].status = 'rejected';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].reason = reason;

                        const { error: updateError } = await supabase.from('requests').update({ approvers, status: '已退回' }).eq('id', request.id);
                        if(updateError) throw updateError;

                        const { error: notificationError } = await supabase.from('notifications').insert({
                            user_id: request.applicant_id,
                            request_id: request.id,
                            message: `您的申請單 ${request.id} 已被 ${state.currentUser.name} 退回。原因：${reason}`,
                            is_read: false
                        });
                        if(notificationError) console.error("Failed to create notification:", notificationError);
                    }
                    showMessage(`${requestsToProcess.length} 筆單據已成功退回。`);
                } catch (err) {
                    showMessage('批次退回失敗: ' + err.message, 'error');
                } finally {
                    closeModal();
                    state.local.selectedRequestIds.clear();
                    
                    // 清除緩存並重新載入資料
                    CacheManager.clear('dashboard_data');
                    await loadDashboardData(false, false); // 強制不使用緩存
                    
                    // 重置篩選緩存
                    getFilteredRequests.resetCache();
                    
                    updateState({ loading: false });
                }
            } else if (action === 'modal-reject-options') {
                // 顯示退回選項彈窗
                const requestId = button.dataset.requestId;
                const currentComment = document.getElementById('approval-comment-modal').value || '';
                
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">退回申請</h3>
                    <label for="rejection-reason-modal" class="block text-sm font-medium text-gray-700">退回理由：</label>
                    <textarea id="rejection-reason-modal" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${currentComment}</textarea>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                        <button data-action="modal-confirm-reject-previous" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-yellow-500 text-white">退回上一層</button>
                        <button data-action="modal-confirm-reject-all" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">整筆退單</button>
                    </div>`);
            } else if (action === 'modal-confirm-reject-all' || action === 'modal-confirm-reject-previous') {
                // 處理退回確認
                const requestId = button.dataset.requestId;
                const request = state.requests.find(r => r.id === requestId);
                const reason = document.getElementById('rejection-reason-modal').value;
                
                if (!reason.trim()) {
                    showMessage('請填寫退回理由。', 'error');
                    return;
                }

                updateState({ loading: true });
                try {
                    const approvers = JSON.parse(JSON.stringify(request.approvers)); // Deep copy
                    const currentStepIndex = approvers.findIndex(a => a.status === 'pending');

                    if (currentStepIndex !== -1) {
                        let newStatus = '待審核';
                        let notificationMessage = '';
                        
                        if (action === 'modal-confirm-reject-previous' && currentStepIndex > 0) {
                            // Revert previous approver to pending
                            approvers[currentStepIndex - 1].status = 'pending';
                            approvers[currentStepIndex - 1].date = '';
                            approvers[currentStepIndex - 1].reason = '';
                            approvers[currentStepIndex - 1].comment = `由 ${state.currentUser.name} 退回，請重新審核。`;
                            
                            // Mark current approver's rejection in their comment field, but keep them pending for the future
                            approvers[currentStepIndex].comment = `於 ${getFormattedDateTime(new Date())} 退回。原因: ${reason}`;

                            notificationMessage = `您的申請單 ${request.id} 已由 ${state.currentUser.name} 退回至上一層簽核。原因：${reason}`;
                            
                            // Notify the previous approver as well
                             await supabase.from('notifications').insert({
                                user_id: approvers[currentStepIndex - 1].userId,
                                request_id: request.id,
                                message: `申請單 ${request.id} 已被退回給您重新簽核。原因：${reason}`,
                                is_read: false
                            });

                        } else { // This handles 'modal-confirm-reject-all' and 'modal-confirm-reject-previous' on first step
                            approvers[currentStepIndex].status = 'rejected';
                            approvers[currentStepIndex].date = new Date().toISOString();
                            approvers[currentStepIndex].reason = reason;
                            newStatus = '已退回';
                            notificationMessage = `您的申請單 ${request.id} 已被 ${state.currentUser.name} 整筆退回。原因：${reason}`;
                        }
                        
                        const { error } = await supabase
                            .from('requests')
                            .update({ approvers, status: newStatus })
                            .eq('id', request.id);
                        
                        if (error) throw error;

                        // Notify applicant
                        await supabase.from('notifications').insert({
                            user_id: request.applicant_id,
                            request_id: request.id,
                            message: notificationMessage,
                            is_read: false
                        });

                        // 更新本地狀態
                        const updatedRequest = { ...request, approvers, status: newStatus };
                        const newRequests = state.requests.map(r => r.id === request.id ? updatedRequest : r);
                        
                        // 清除緩存並關閉模態框
                        CacheManager.clear('dashboard_data');
                        getFilteredRequests.resetCache();
                        
                        showMessage('申請單已退回');
                        closeModal();
                        updateState({ view: 'dashboard', loading: false, requests: newRequests });
                        render();

                    } else {
                         throw new Error("找不到待簽核的步驟。");
                    }
                } catch (err) {
                    showMessage('退回失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'modal-approve' || action === 'modal-reject' || action === 'modal-save-changes' || action === 'modal-confirm-approve-with-save' || action === 'modal-confirm-approve-without-save') {
                // 處理單個申請單的簽核
                let requestId = button.dataset.requestId;
                // 若從詳情頁彈出確認視窗，優先採用快照中的 requestId
                if (!requestId && window.__approvePendingContext && window.__approvePendingContext.requestId) {
                    requestId = window.__approvePendingContext.requestId;
                }
                const request = state.requests.find(r => r.id === requestId);
                if (!request) {
                    showMessage('找不到對應的申請單。', 'error');
                    return;
                }

                // 在彈窗按核准時，若有變更，先詢問是否儲存
                if (action === 'modal-approve') {
                    const form = document.getElementById('edit-request-form-modal');
                    if (form) {
                        const formData = new FormData(form);
                        let hasChanges = false;
                        for (let index = 0; index < (request.items || []).length; index++) {
                            const item = request.items[index];
                            const newReason = (formData.get(`reason_${index}`) || '').toString();
                            const newDescription = (formData.get(`description_${index}`) || '').toString();
                            const demandDept = formData.get(`demand_department_${index}`) || '';
                            const invoice = formData.get(`invoice_${index}`) || '';
                            const customInvoice = formData.get(`custom_invoice_${index}`) || '';
                            const vendor = formData.get(`vendor_${index}`) || '';
                            const price = parseFloat(formData.get(`price_${index}`)) || 0;
                            const quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                            const unit = formData.get(`unit_${index}`) || '';
                            const freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                            const discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                            let newScrap = item.is_scrap_work_order;
                            let newAsset = item.work_order_number || '';
                            if (newReason === '報廢') {
                                newScrap = !!formData.get(`scrap_${index}`);
                                newAsset = newScrap ? (formData.get(`asset_number_${index}`) || '') : '';
                            } else {
                                newScrap = false;
                                newAsset = '';
                            }
                            if (
                                (item.reason || '') !== newReason ||
                                (item.description || '') !== newDescription ||
                                (item.demand_department || '') !== demandDept ||
                                (item.invoice || '') !== invoice ||
                                (item.custom_invoice || '') !== (invoice === '其他' ? customInvoice : '') ||
                                (item.vendor || '') !== vendor ||
                                Number(item.price || 0) !== price ||
                                Number(item.quantity || 0) !== quantity ||
                                (item.unit || '') !== unit ||
                                Number(item.freight || 0) !== freight ||
                                Number(item.discount || 0) !== discount ||
                                Boolean(item.is_scrap_work_order) !== Boolean(newScrap) ||
                                (item.work_order_number || '') !== newAsset
                            ) {
                                hasChanges = true;
                                break;
                            }
                        }
                        if (hasChanges) {
                            // 快照 modal 來源的表單內容（因為等下會覆蓋 modal 內容）
                            (window).__approvePendingContext = {
                                scope: 'modal',
                                requestId,
                                // 存成物件以便後續使用
                                formData: Object.fromEntries(formData.entries()),
                                comment: document.getElementById('approval-comment-modal')?.value || '',
                                reason: document.getElementById('modification-reason-modal')?.value || ''
                            };
                            renderModal(`
                                <h3 class="text-lg font-bold mb-4">請確認是否進行單據資料修改</h3>
                                <p class="mb-6 text-sm text-gray-700">偵測到您對單據內容做了變更，是否一併儲存修改後再核准？</p>
                                <div class="flex justify-end space-x-3">
                                    <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                                    <button data-action="modal-confirm-approve-without-save" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">否，直接核准</button>
                                    <button data-action="modal-confirm-approve-with-save" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">是，儲存修改後核准</button>
                                </div>
                            `, { size: 'half' });
                            return; // 先不進入原核准流程
                        }
                    }
                }

                if (action === 'modal-save-changes' || action === 'modal-confirm-approve-with-save') {
                    // 從快照或現有欄位取得修改原因（優先快照）
                    let modificationReason = '';
                    if (window.__approvePendingContext && typeof window.__approvePendingContext.reason !== 'undefined') {
                        modificationReason = window.__approvePendingContext.reason || '';
                    } else if (window.__approvePendingContext && window.__approvePendingContext.scope === 'detail') {
                        const reasonEl = document.querySelector(window.__approvePendingContext.reasonSelector);
                        modificationReason = reasonEl ? reasonEl.value : '';
                    } else {
                        const el = document.getElementById('modification-reason-modal');
                        modificationReason = el ? el.value : '';
                    }
                    if (!modificationReason.trim()) {
                        showMessage('修改訂單內容時，必須填寫修改原因。', 'error');
                        return;
                    }
                }

                // 從快照或現有欄位取得簽核意見
                let comment = '';
                if (window.__approvePendingContext && typeof window.__approvePendingContext.comment !== 'undefined') {
                    comment = window.__approvePendingContext.comment || '';
                } else if (window.__approvePendingContext && window.__approvePendingContext.scope === 'detail') {
                    const cmtEl = document.querySelector(window.__approvePendingContext.commentSelector);
                    comment = cmtEl ? (cmtEl.value || '') : '';
                } else {
                    const cmtEl = document.getElementById('approval-comment-modal');
                    comment = cmtEl ? (cmtEl.value || '') : '';
                }
                updateState({ loading: true });
                // 供後續本地狀態更新使用的變更快照（只在儲存修改時填入）
                let savedPatch = null;
                
                try {
                    const approvers = [...request.approvers];
                    const currentStepIndex = approvers.findIndex(a => a.status === 'pending');
                    
                    if (currentStepIndex === -1) {
                        showMessage('找不到待簽核的步驟。', 'error');
                        return;
                    }

                    if (action === 'modal-approve' || action === 'modal-save-changes' || action === 'modal-confirm-approve-with-save' || action === 'modal-confirm-approve-without-save') {
                        // 核准邏輯
                        approvers[currentStepIndex].status = 'approved';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].comment = comment;
                        
                        const isFinal = currentStepIndex === approvers.length - 1;
                        const newStatus = isFinal ? '已核准' : '待審核';

                        let updateData = { approvers, status: newStatus };

                        if (action === 'modal-save-changes' || action === 'modal-confirm-approve-with-save') {
                            // 取用對應表單資料：詳情頁讀 DOM；modal 用快照
                            let modificationReason = '';
                            let getVal = (name) => null;
                            if (window.__approvePendingContext && window.__approvePendingContext.scope === 'detail') {
                                const reasonEl = document.querySelector(window.__approvePendingContext.reasonSelector);
                                modificationReason = reasonEl ? reasonEl.value : '';
                                const form = document.querySelector(window.__approvePendingContext.formSelector);
                                const formData = new FormData(form);
                                getVal = (name) => formData.get(name);
                            } else {
                                modificationReason = (window.__approvePendingContext && window.__approvePendingContext.reason) ? window.__approvePendingContext.reason : '';
                                const saved = (window.__approvePendingContext && window.__approvePendingContext.formData) ? window.__approvePendingContext.formData : {};
                                getVal = (name) => (name in saved ? saved[name] : null);
                            }
                            const newItems = request.items.map((item, index) => {
                                const updated = { ...item };
                                // 允許：原因/說明
                                const reasonVal = getVal(`reason_${index}`);
                                if (reasonVal !== null) updated.reason = (reasonVal || '').toString();
                                const descVal = getVal(`description_${index}`);
                                if (descVal !== null) updated.description = (descVal || '').toString();
                                // 允許：需求課室
                                const demandDept = getVal(`demand_department_${index}`);
                                if (demandDept !== null) updated.demand_department = demandDept || '';
                                // 允許：發票開立 + 自訂發票
                                const invoice = getVal(`invoice_${index}`);
                                const customInvoice = getVal(`custom_invoice_${index}`);
                                if (invoice !== null) {
                                    updated.invoice = invoice || '';
                                    updated.custom_invoice = invoice === '其他' ? (customInvoice || '') : '';
                                }
                                // 允許：廠商
                                const vendor = getVal(`vendor_${index}`);
                                if (vendor !== null) updated.vendor = vendor || '';
                                // 允許：價格/數量/單位/運費/折扣
                                updated.price = parseFloat(getVal(`price_${index}`)) || 0;
                                updated.quantity = parseInt(getVal(`quantity_${index}`), 10) || 0;
                                updated.unit = getVal(`unit_${index}`) || '';
                                updated.freight = parseFloat(getVal(`freight_${index}`)) || 0;
                                updated.discount = parseFloat(getVal(`discount_${index}`)) || 0;
                                // 允許：報廢/財產編號（僅原因為報廢時；否則自動清空）
                                if (updated.reason === '報廢') {
                                    const scrapChecked = !!getVal(`scrap_${index}`);
                                    updated.is_scrap_work_order = scrapChecked;
                                    updated.work_order_number = scrapChecked ? (getVal(`asset_number_${index}`) || '') : '';
                                } else {
                                    updated.is_scrap_work_order = false;
                                    updated.work_order_number = '';
                                }
                                return updated;
                            });
                            const newTotalAmount = Math.round(newItems.reduce((sum, item) => sum + (item.price * item.quantity) + (item.freight || 0) + (item.discount || 0), 0));
                            // 建立變更明細供後續查閱比對
                            const fieldsToCompare = ['reason','description','demand_department','invoice','custom_invoice','vendor','price','quantity','unit','freight','discount','is_scrap_work_order','work_order_number'];
                            const changesLog = [];
                            for (let i = 0; i < request.items.length; i++) {
                                const before = request.items[i] || {};
                                const after = newItems[i] || {};
                                const itemChanges = [];
                                fieldsToCompare.forEach(field => {
                                    const a = (before[field] === undefined || before[field] === null) ? '' : before[field];
                                    const b = (after[field] === undefined || after[field] === null) ? '' : after[field];
                                    if (String(a) !== String(b)) {
                                        itemChanges.push({ field, from: a, to: b });
                                    }
                                });
                                if (itemChanges.length > 0) {
                                    changesLog.push({ item_id: before.id, name: before.name, changes: itemChanges });
                                }
                            }
                            
                            const newHistoryEntry = {
                                user: state.currentUser.name,
                                role: state.currentUser.role,
                                date: new Date().toISOString(),
                                reason: modificationReason,
                                changes: changesLog
                            };
                            
                            updateData.items = newItems;
                            updateData.total_amount = newTotalAmount;
                            updateData.modification_history = [...(request.modification_history || []), newHistoryEntry];
                            savedPatch = { items: newItems, total_amount: newTotalAmount, modification_history: updateData.modification_history };
                        }

                        const { error: updateError } = await supabase
                            .from('requests')
                            .update(updateData)
                            .eq('id', requestId);
                        
                        if (updateError) throw updateError;
                        
                        // 發送通知
                        let notificationMessage = `您的申請單 ${requestId} 已由 ${state.currentUser.name} 核准。`;
                        if (isFinal) {
                            notificationMessage = `您的申請單 ${requestId} 已全數簽核完成！`;
                        }
                        // 通知申請人
                        await supabase.from('notifications').insert({
                            user_id: request.applicant_id,
                            request_id: requestId,
                            message: notificationMessage,
                            is_read: false
                        });
                        // 若已指派經辦，發送經辦通知
                        if (isFinal && updateData.handler_id) {
                            await supabase.from('notifications').insert({
                                user_id: updateData.handler_id,
                                request_id: requestId,
                                message: `您被指派經辦申請單 ${requestId}，請儘速處理。`,
                                is_read: false
                            });
                        }

                        showMessage((action === 'modal-save-changes' || action === 'modal-confirm-approve-with-save') ? '申請單已修改並核准。' : '申請單已成功核准。');
                    } else {
                        // 退回邏輯
                        if (!comment.trim()) {
                            showMessage('退回時必須填寫意見。', 'error');
                            return;
                        }

                        approvers[currentStepIndex].status = 'rejected';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].reason = comment;

                        const { error: updateError } = await supabase
                            .from('requests')
                            .update({ approvers, status: '已退回' })
                            .eq('id', requestId);
                        
                        if (updateError) throw updateError;

                        // 發送通知
                        await supabase.from('notifications').insert({
                            user_id: request.applicant_id,
                            request_id: requestId,
                            message: `您的申請單 ${requestId} 已被 ${state.currentUser.name} 退回。原因：${comment}`,
                            is_read: false
                        });

                        showMessage('申請單已退回。');
                    }

                    // 更新本地狀態
                    const updatedStatus = action === 'modal-reject' ? '已退回' : (currentStepIndex === approvers.length - 1 ? '已核准' : '待審核');
                    const updatedRequest = { 
                        ...request, 
                        approvers, 
                        status: updatedStatus,
                        ...(currentStepIndex === approvers.length - 1 ? { handler_status: '待經辦', handler_id: Object.values(state.users).find(u => u.is_handler)?.id || null } : {}),
                        ...(savedPatch ? savedPatch : {})
                    };
                    const newRequests = state.requests.map(r => r.id === requestId ? updatedRequest : r);
                    
                    // 清除緩存並關閉模態框並回到列表
                    CacheManager.clear('dashboard_data');
                    getFilteredRequests.resetCache();
                    closeModal();
                    // 清理快照
                    if (window.__approvePendingContext) delete window.__approvePendingContext;
                    updateState({ requests: newRequests, loading: false, view: 'dashboard' });
                    render();

                } catch (err) {
                    showMessage('簽核處理失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            }
        });

        // Modal 內的欄位互動（發票開立、自訂發票、報廢/財產編號）
    document.getElementById('modal-container').addEventListener('change', (e) => {
            const target = e.target;
            if (!target.name) return;
            if (target.name.startsWith('invoice_')) {
                const idx = target.name.split('_')[1];
                const custom = document.querySelector(`input[name="custom_invoice_${idx}"]`);
                if (custom) {
                    if (target.value === '其他') {
                        custom.classList.remove('hidden');
                        custom.classList.add('block', 'w-2/3');
                    } else {
                        custom.classList.add('hidden');
                        custom.classList.remove('block', 'w-2/3');
                        custom.value = '';
                    }
                }
            } else if (target.name.startsWith('scrap_')) {
                const idx = target.name.split('_')[1];
                const asset = document.querySelector(`input[name="asset_number_${idx}"]`);
                if (asset) {
                    const enabled = target.checked;
                    asset.disabled = !enabled;
                    asset.classList.toggle('opacity-50', !enabled);
                    if (!enabled) asset.value = '';
                }
            } else if (target.name.startsWith('reason_')) {
                const idx = target.name.split('_')[1];
                const scrap = document.querySelector(`input[name="scrap_${idx}"]`);
                const asset = document.querySelector(`input[name="asset_number_${idx}"]`);
                if (scrap && asset) {
                    const isScrapReason = target.value === '報廢';
                    scrap.disabled = !isScrapReason;
                    if (!isScrapReason) {
                        scrap.checked = false;
                        asset.value = '';
                        asset.disabled = true;
                        asset.classList.add('opacity-50');
                    }
                }
            }
        });
        
        document.body.addEventListener('click', async (e) => {
            const button = e.target.closest('button, a');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'edit-profile') {
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">個人設定</h3>
                    <form id="edit-profile-form">
                        <div class="space-y-4">
                            <div>
                                <label for="edit-profile-name" class="block text-sm font-medium text-gray-700">姓名</label>
                                <input type="text" id="edit-profile-name" value="${state.currentUser.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly>
                            </div>
                            <div>
                                <label for="edit-profile-email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="edit-profile-email" value="${state.currentUser.email}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly>
                            </div>
                            <div>
                                <label for="edit-profile-demand-department" class="block text-sm font-medium text-gray-700">預設需求課室</label>
                                <select id="edit-profile-demand-department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 請選擇 --</option>
                                    ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}" ${state.currentUser.demand_department === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="edit-profile-invoice" class="block text-sm font-medium text-gray-700">預設發票開立</label>
                                <select id="edit-profile-invoice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- 請選擇 --</option>
                                    ${[
                                        "8C清福", "7C清氣", "6C清心", "5C清平", "3C清安", "2CD清護",
                                        "8D清春", "7D清日", "6D清照", "5D清風", "3D清景", "8E清山",
                                        "7E清泉", "6E清水", "8E清清", "3E清涼", "清福法人", "一館",
                                        "二館", "三館", "含笑", "清福幼兒園", "其他"
                                    ].map(opt => `<option value="${opt}" ${state.currentUser.default_invoice === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="edit-profile-theme" class="block text-sm font-medium text-gray-700">預設風格</label>
                                <select id="edit-profile-theme" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    ${(() => { const cur = state.currentUser.theme_preference || localStorage.getItem('appTheme') || 'random'; return `
                                    <option value="default" ${cur==='default'?'selected':''}>預設</option>
                                    <option value="random" ${cur==='random'?'selected':''}>*隨機</option>
                                    <option value="apple" ${cur==='apple'?'selected':''}>Apple</option>
                                    <option value="scifi" ${cur==='scifi'?'selected':''}>高科技</option>
                                    <option value="ghibli" ${cur==='ghibli'?'selected':''}>吉卜力</option>
                                    <option value="abstract" ${cur==='abstract'?'selected':''}>藝術</option>
                                    <option value="colorful" ${cur==='colorful'?'selected':''}>多彩</option>
                                    <option value="luhong" ${cur==='luhong'?'selected':''}>魯紅</option>
                                    <option value="lugreen" ${cur==='lugreen'?'selected':''}>魯綠</option>
                                    <option value="forest" ${cur==='forest'?'selected':''}>森林</option>
                                    <option value="ocean" ${cur==='ocean'?'selected':''}>海洋</option>
                                    <option value="sunset" ${cur==='sunset'?'selected':''}>夕陽</option>
                                    <option value="midnight" ${cur==='midnight'?'selected':''}>午夜</option>
                                    <option value="sakura" ${cur==='sakura'?'selected':''}>櫻花</option>
                                    <option value="care-soft" ${cur==='care-soft'?'selected':''}>溫馨</option>
                                    <option value="care-fresh" ${cur==='care-fresh'?'selected':''}>清新</option>
                                    <option value="med-clean" ${cur==='med-clean'?'selected':''}>清爽</option>
                                    <option value="med-trust" ${cur==='med-trust'?'selected':''}>信任</option>
                                    <option value="hotel-lux" ${cur==='hotel-lux'?'selected':''}>奢華</option>
                                    <option value="hotel-resort" ${cur==='hotel-resort'?'selected':''}>休閒</option>
                                    <option value="nord" ${cur==='nord'?'selected':''}>清冷</option>
                                    <option value="latte" ${cur==='latte'?'selected':''}>拿鐵</option>
                                    <option value="mint" ${cur==='mint'?'selected':''}>薄荷</option>
                                    <option value="solar" ${cur==='solar'?'selected':''}>暖陽</option>
                                    <option value="slate" ${cur==='slate'?'selected':''}>石板</option>
                                    <option value="metro" ${cur==='metro'?'selected':''}>Metro</option>
                                    <option value="pastel" ${cur==='pastel'?'selected':''}>粉彩</option>
                                    <option value="neon" ${cur==='neon'?'selected':''}>霓虹</option>
                                    <option value="retro" ${cur==='retro'?'selected':''}>復古</option>
                                    <option value="minimal" ${cur==='minimal'?'selected':''}>極簡</option>
                                    <option value="paper" ${cur==='paper'?'selected':''}>紙感</option>
                                    <option value="grape" ${cur==='grape'?'selected':''}>葡萄紫</option>
                                    <option value="cobalt" ${cur==='cobalt'?'selected':''}>鈷藍</option>
                                    <option value="sand" ${cur==='sand'?'selected':''}>沙丘</option>
                                    <option value="rosewood" ${cur==='rosewood'?'selected':''}>紅木</option>
                                    <option value="aurora" ${cur==='aurora'?'selected':''}>極光</option>
                                    <option value="cocoa" ${cur==='cocoa'?'selected':''}>可可</option>
                                    <option value="denim" ${cur==='denim'?'selected':''}>丹寧</option>
                                    <option value="lime" ${cur==='lime'?'selected':''}>檸萊姆</option>
                                    <option value="coral" ${cur==='coral'?'selected':''}>珊瑚</option>
                                    <option value="plum" ${cur==='plum'?'selected':''}>李梅紫</option>
                                    <option value="sky" ${cur==='sky'?'selected':''}>晴空</option>
                                    <option value="graphite" ${cur==='graphite'?'selected':''}>石墨</option>
                                    <option value="pearl" ${cur==='pearl'?'selected':''}>珠光</option>
                                    <option value="rust" ${cur==='rust'?'selected':''}>鐵鏽</option>
                                    <option value="berry" ${cur==='berry'?'selected':''}>莓果</option>
                                    <option value="moss" ${cur==='moss'?'selected':''}>苔蘚</option>
                                    <option value="teal" ${cur==='teal'?'selected':''}>水鴨</option>
                                    <option value="sepia" ${cur==='sepia'?'selected':''}>懷舊棕</option>
                                    <option value="charcoal" ${cur==='charcoal'?'selected':''}>炭黑</option>
                                    <option value="ivory" ${cur==='ivory'?'selected':''}>象牙</option>
                                    <option value="azure" ${cur==='azure'?'selected':''}>天藍</option>
                                    <option value="blush" ${cur==='blush'?'selected':''}>腮紅</option>
                                    <option value="saffron" ${cur==='saffron'?'selected':''}>番紅花</option>
                                    <option value="indigo" ${cur==='indigo'?'selected':''}>靛青</option>
                                    <option value="copper" ${cur==='copper'?'selected':''}>銅色</option>
                                    <option value="lavender" ${cur==='lavender'?'selected':''}>薰衣草</option>
                                    <option value="steel" ${cur==='steel'?'selected':''}>鋼鐵</option>
                                    <option value="clay" ${cur==='clay'?'selected':''}>陶土</option>
                                    <option value="cyan" ${cur==='cyan'?'selected':''}>青色</option>
                                    <option value="olive" ${cur==='olive'?'selected':''}>橄欖</option>
                                    <option value="marigold" ${cur==='marigold'?'selected':''}>萬壽菊</option>
                                    <option value="orchid" ${cur==='orchid'?'selected':''}>蘭花</option>
                                    <option value="flamingo" ${cur==='flamingo'?'selected':''}>火鶴</option>
                                    <option value="iceberg" ${cur==='iceberg'?'selected':''}>冰山</option>
                                    <option value="blossom" ${cur==='blossom'?'selected':''}>花漾</option>
                                    <option value="jade" ${cur==='jade'?'selected':''}>玉翠</option>
                                    <option value="cinder" ${cur==='cinder'?'selected':''}>煤炭黑</option>
                                    <option value="fern" ${cur==='fern'?'selected':''}>蕨綠</option>
                                    <option value="glacier" ${cur==='glacier'?'selected':''}>冰川藍</option>
                                    <option value="ember" ${cur==='ember'?'selected':''}>餘燼橙</option>
                                    <option value="horizon" ${cur==='horizon'?'selected':''}>天際藍</option>
                                    <option value="canyon" ${cur==='canyon'?'selected':''}>峽谷橙</option>
                                    <option value="lagoon" ${cur==='lagoon'?'selected':''}>礁湖青</option>
                                    <option value="meadow" ${cur==='meadow'?'selected':''}>草甸綠</option>
                                    <option value="tundra" ${cur==='tundra'?'selected':''}>苔原藍灰</option>
                                    <option value="dune" ${cur==='dune'?'selected':''}>沙漠棕</option>
                                    <option value="willow" ${cur==='willow'?'selected':''}>垂柳綠</option>
                                    <option value="bronze" ${cur==='bronze'?'selected':''}>古銅</option>
                                    <option value="silver" ${cur==='silver'?'selected':''}>銀霜</option>
                                    <option value="gold" ${cur==='gold'?'selected':''}>鎏金</option>
                                    <option value="amethyst" ${cur==='amethyst'?'selected':''}>紫水晶</option>
                                    <option value="sapphire" ${cur==='sapphire'?'selected':''}>藍寶石</option>
                                    <option value="ruby" ${cur==='ruby'?'selected':''}>紅寶石</option>
                                    <option value="emerald" ${cur==='emerald'?'selected':''}>翠玉</option>
                                    <option value="topaz" ${cur==='topaz'?'selected':''}>黃玉</option>
                                    <option value="garnet" ${cur==='garnet'?'selected':''}>石榴紅</option>
                                    <option value="quartz" ${cur==='quartz'?'selected':''}>石英青</option>
                                    <option value="onyx" ${cur==='onyx'?'selected':''}>縞瑪瑙</option>
                                    <option value="obsidian" ${cur==='obsidian'?'selected':''}>黑曜石</option>
                                    <option value="smoke" ${cur==='smoke'?'selected':''}>煙灰</option>
                                    <option value="cloud" ${cur==='cloud'?'selected':''}>雲白</option>
                                    <option value="storm" ${cur==='storm'?'selected':''}>風暴灰</option>
                                    <option value="frost" ${cur==='frost'?'selected':''}>霜藍</option>
                                    <option value="cherry" ${cur==='cherry'?'selected':''}>櫻桃粉</option>
                                    <option value="espresso" ${cur==='espresso'?'selected':''}>濃縮咖啡</option>
                                    <option value="mocha" ${cur==='mocha'?'selected':''}>摩卡</option>
                                    <option value="avocado" ${cur==='avocado'?'selected':''}>酪梨綠</option>
                                    <option value="banana" ${cur==='banana'?'selected':''}>香蕉黃</option>
                                    <option value="plumeria" ${cur==='plumeria'?'selected':''}>雞蛋花</option>
                                    <option value="reef" ${cur==='reef'?'selected':''}>珊瑚礁藍</option>
                                    <option value="seafoam" ${cur==='seafoam'?'selected':''}>海沫綠</option>
                                    <option value="pine" ${cur==='pine'?'selected':''}>松針綠</option>
                                    <option value="iron" ${cur==='iron'?'selected':''}>鐵灰</option>
                                    <option value="carbon" ${cur==='carbon'?'selected':''}>碳黑</option>
                                    <option value="navy" ${cur==='navy'?'selected':''}>海軍藍</option>
                                    <option value="air" ${cur==='air'?'selected':''}>空氣藍</option>
                                    <option value="violet" ${cur==='violet'?'selected':''}>紫羅蘭</option>
                                    <option value="caramel" ${cur==='caramel'?'selected':''}>焦糖</option>
                                    <option value="peach" ${cur==='peach'?'selected':''}>蜜桃</option>
                                    <option value="lilac" ${cur==='lilac'?'selected':''}>丁香紫</option>
                                    <option value="rose" ${cur==='rose'?'selected':''}>玫瑰</option>
                                    <option value="magenta" ${cur==='magenta'?'selected':''}>洋紅</option>
                                    <option value="periwinkle" ${cur==='periwinkle'?'selected':''}>長春花</option>
                                    <option value="teak" ${cur==='teak'?'selected':''}>柚木</option>
                                    `; })()}
                                </select>
                            </div>
                            <div>
                                <label for="edit-profile-menu-layout" class="block text-sm font-medium text-gray-700">申請菜單版型</label>
                                <div class="mt-1 flex items-center gap-4">
                                    <select id="edit-profile-menu-layout" class="block w-48 rounded-md border-gray-300 shadow-sm">
                                        ${(() => { const cur = state.currentUser.menu_layout || localStorage.getItem('menuLayout') || (state.local.layoutScale || 'expanded'); return `
                                        <option value="expanded" ${cur==='expanded'?'selected':''}>清單較寬（左 2/3｜右 1/3）</option>
                                        <option value="compact" ${cur==='compact'?'selected':''}>清單較窄（左 1/3｜右 2/3）</option>
                                        `; })()}
                                    </select>
                                    <div id="menu-layout-preview" class="flex items-center text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">取消</button>
                        <button data-action="save-profile" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white">儲存</button>
                    </div>
                `);
                                // 初始化版型預覽
                                const preview = document.getElementById('menu-layout-preview');
                                const select = document.getElementById('edit-profile-menu-layout');
                                const renderPreview = (val) => {
                                        if (!preview) return;
                                        if (val === 'compact') {
                                                preview.innerHTML = `
                                                    <svg width="72" height="24" viewBox="0 0 24 8" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <rect x="0.5" y="0.5" width="7" height="7" rx="1" fill="currentColor" opacity="0.9"/>
                                                        <rect x="8.5" y="0.5" width="15" height="7" rx="1" fill="currentColor" opacity="0.35"/>
                                                    </svg>`;
                                        } else {
                                                preview.innerHTML = `
                                                    <svg width="72" height="24" viewBox="0 0 24 8" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <rect x="0.5" y="0.5" width="15" height="7" rx="1" fill="currentColor" opacity="0.35"/>
                                                        <rect x="16.5" y="0.5" width="7" height="7" rx="1" fill="currentColor" opacity="0.9"/>
                                                    </svg>`;
                                        }
                                };
                                renderPreview(select.value);
                                select.addEventListener('change', (ev) => renderPreview(ev.target.value));
            } else if (action === 'save-profile') {
                const form = document.getElementById('edit-profile-form');
                if (!form) return;

                // 取得表單值
                const demandDepartment = form.querySelector('#edit-profile-demand-department').value;
                const defaultInvoice = form.querySelector('#edit-profile-invoice').value;

                // 驗證資料不為空
                if (!demandDepartment && !defaultInvoice) {
                    showMessage('請至少填寫一個設定項目', 'error');
                    return;
                }

                // 準備更新資料物件，兩個欄位都帶入
                const updateData = {
                    demand_department: demandDepartment,
                    default_invoice: defaultInvoice
                };

                // 如果兩個欄位都沒變更，直接關閉
                if (
                    demandDepartment === state.currentUser.demand_department &&
                    defaultInvoice === state.currentUser.default_invoice
                ) {
                    showMessage('沒有資料被變更');
                    closeModal();
                    return;
                }

                updateState({ loading: true });
                try {
                    // 先取得最新的使用者資料
                    const { data: currentUserData, error: fetchError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', state.currentUser.id)
                        .single();

                    if (fetchError) throw fetchError;

                    // 執行更新
                    const { error: updateError } = await supabase
                        .from('users')
                        .update(updateData)
                        .eq('id', state.currentUser.id);

                    if (updateError) throw updateError;

                    // 更新成功後，更新本地狀態
                    state.currentUser = {
                        ...state.currentUser,
                        ...updateData
                    };
                    showMessage('個人設定已更新！');
                    closeModal();
                } catch (err) {
                    console.error('更新個人設定失敗:', err);
                    showMessage('更新失敗: ' + err.message, 'error');
                }
                updateState({ loading: false });
            } else if (action === 'view-detail') {
                const requestId = button.dataset.id;
                const request = state.requests.find(r => r.id == requestId);
                if (request.status === '待送出' && request.applicant_id === state.currentUser.id) {
                    // 編輯草稿
                    updateState({ 
                        view: 'newRequest', 
                        editingRequest: request, 
                        local: { ...state.local, newRequestCart: request.items || [] } 
                    });
                } else {
                    // 檢視或簽核
                    updateState({ selectedRequest: request, view: 'detailView' });
                }
            } else if (action === 'view-notification-detail') {
                e.preventDefault();
                const requestId = button.dataset.id;
                const notificationId = button.dataset.notificationId;
                const request = state.requests.find(r => r.id == requestId);

                if (request) {
                    if (notificationId) {
                        const notification = state.applicantNotifications.find(n => n.id == notificationId);
                        if (notification && !notification.is_read) {
                            supabase.from('notifications').update({ is_read: true }).eq('id', notificationId).then(({error}) => {
                                if (error) console.error("更新通知狀態失敗:", error);
                            });
                        }
                    }
                    
                    const dropdown = document.getElementById('notification-dropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                    updateState({ view: 'detailView', selectedRequest: request });
                }
            } else if (action === 'delete-draft') {
                const button = e.target.closest('button[data-action="delete-draft"]'); // Be more specific
                const requestId = button ? button.dataset.id : undefined;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">確認刪除草稿</h3>
                    <p class="mb-6">您確定要刪除此草稿申請單 ${requestId} 嗎？此操作無法復原。</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">取消</button>
                        <button data-id="${requestId}" data-action="confirm-delete-draft" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">確認刪除</button>
                    </div>
                `);
            } else if (action === 'confirm-delete-draft') {
                const requestId = button.dataset.id;
                const requestToDelete = state.requests.find(r => r.id == requestId);

                if (!requestToDelete) {
                    showMessage('找不到要刪除的申請單。', 'error');
                    closeModal();
                    return;
                }

                // 檢查權限
                const canDelete = state.currentUser.is_admin ||
                                  (requestToDelete.applicant_id === state.currentUser.id && requestToDelete.status === '待送出');

                if (!canDelete) {
                    showMessage('您沒有權限刪除此申請單。', 'error');
                    closeModal();
                    return;
                }

                updateState({ loading: true });
                try {
                    const { error } = await supabase.from('requests').delete().eq('id', requestId);
                    if (error) throw error;
                    showMessage('申請單已成功刪除！');
                    closeModal();
                    
                    // 清除緩存並重新載入資料
                    CacheManager.clear('dashboard_data');
                    await loadDashboardData(false, false); // 強制不使用緩存
                    
                    // 重置篩選緩存
                    getFilteredRequests.resetCache();
                    
                    updateState({ 
                        loading: false,
                        view: 'personalForms', 
                        local: { ...state.local, personalForms: { ...state.local.personalForms, activeTab: 'sent' } } 
                    });
                } catch (err) {
                    console.error("刪除申請單失敗:", err);
                    showMessage('刪除申請單失敗: ' + err.message, 'error');
                    updateState({ loading: false });
                    closeModal();
                }
            }
        });
        
        document.body.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (e.target.id === 'login-form') {
                const account = e.target.elements.account.value;
                const password = e.target.elements.password.value;
                let email = account;

                // Store remember-me choice
                const rememberMe = e.target.elements['remember-me'].checked;
                state.local.rememberMe = rememberMe;
                if (rememberMe) {
                    localStorage.setItem('rememberedAccount', account);
                } else {
                    localStorage.removeItem('rememberedAccount');
                }

                updateState({ loading: true, error: null }); 

                try {
                    if (!account.includes('@')) {
                        const { data, error } = await supabase.functions.invoke('find-email-by-id', {
                            body: { id: account }
                        });

                        if (error) throw error;
                        if (data.error) throw new Error(data.error);

                        if (data.emails.length === 0) {
                            throw new Error('Invalid login credentials');
                        } else if (data.emails.length > 1) {
                            throw new Error(`帳號 "${account}" 存在於多個網域，請輸入完整的 Email 登入。`);
                        }
                        email = data.emails[0];
                    }

                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;

                } catch (error) {
                    let message = "登入失敗，請檢查您的帳號和密碼。";
                    if (error.message.includes('Invalid login credentials')) {
                        message = "帳號或密碼錯誤。";
                    } else if (error.message.includes('User account is disabled')) {
                        message = "此帳號已被停用，請聯繫管理員。";
                    } else {
                        message = error.message;
                    }
                    showMessage(message, 'error');
                    updateState({ loading: false });
                }
            } else if (e.target.id === 'forgot-password-form') {
                const email = e.target.elements.email.value;
                updateState({ loading: true });
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin, // Redirect back to the app after password reset
                    });
                    if (error) throw error;
                    showMessage('密碼重設信件已寄出，請檢查您的信箱。');
                    closeModal();
                } catch (error) {
                    showMessage('發送密碼重設信件失敗：' + error.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            }
        });

        // --- 初始載入與驗證狀態監聽 ---
        document.addEventListener('DOMContentLoaded', loadTheme);
        document.body.addEventListener('change', (e) => {
            if (e.target.id === 'theme-select') {
                applyTheme(e.target.value);
            }
        });
        
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                if (event === 'SIGNED_IN') {
                    // Clear the temporary state after login
                    delete state.local.rememberMe;
                }

                if (state.currentUser && state.currentUser.id === session.user.id) {
                    return; 
                }

                updateState({ loading: true });
                const user = session.user;
                const { data: userProfile, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (error || !userProfile) {
                    console.error("找不到使用者設定檔:", error);
                    await supabase.auth.signOut();
                    updateState({ error: "認證成功，但在資料庫中找不到您的設定檔。請聯繫管理員。", loading: false });
                } else {
                    state.currentUser = userProfile;
                    state.local.dashboardFilters.permission = 'pending_for_me'; 
                    if (userProfile.favorite_products && Array.isArray(userProfile.favorite_products)) {
                        state.local.favoriteProductIds = new Set(userProfile.favorite_products);
                    } else {
                        state.local.favoriteProductIds = new Set();
                    }
                    // 套用個人預設主題與菜單版型
                    if (userProfile.theme_preference) {
                        applyTheme(userProfile.theme_preference);
                        const sel = document.getElementById('theme-select');
                        if (sel) sel.value = state.theme;
                    }
                    if (userProfile.menu_layout) {
                        state.local.layoutScale = userProfile.menu_layout === 'compact' ? 'compact' : 'expanded';
                        localStorage.setItem('menuLayout', state.local.layoutScale);
                    }
                    await loadDashboardData(true);
                }
            } 
            else {
                channels.forEach(channel => supabase.removeChannel(channel));
                channels = [];
                Object.assign(state, {
                    requests: [], products: {}, users: {}, categories: [], applicantNotifications: [],
                    currentUser: null,
                    loading: false, 
                    error: null
                });
                updateState({ view: 'login' });
            }
        });
        

        // --- Get Filtered Products ---
        const getFilteredProducts = () => {
            const { allProducts, products } = state;
            const { activeProductManagementCategory, productManagementSearchTerm, productManagementSearchAll, productSortKey, productSortDirection } = state.local;
            
            let productsToFilter = [];
            if (productManagementSearchAll || activeProductManagementCategory === '全品項' || !activeProductManagementCategory) {
                productsToFilter = allProducts;
            } else {
                productsToFilter = products[activeProductManagementCategory] || [];
            }

            const lowerCaseSearchTerm = (productManagementSearchTerm || '').toLowerCase();
            let filtered = productsToFilter;
            if (lowerCaseSearchTerm) {
                filtered = filtered.filter(p => {
                    const { image, ...searchableProduct } = p;
                    return JSON.stringify(searchableProduct).toLowerCase().includes(lowerCaseSearchTerm);
                });
            }
            
            if (productSortKey) {
                filtered.sort((a, b) => {
                    let valA = a[productSortKey];
                    let valB = b[productSortKey];

                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();

                    if (valA < valB) return productSortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return productSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            return filtered;
        };

        // 性能監控
        function setupPerformanceMonitoring() {
            if ('performance' in window) {
                // 監控資源載入時間
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        const navigation = performance.getEntriesByType('navigation')[0];
                        const paintEntries = performance.getEntriesByType('paint');
                        
                        console.log('性能統計:', {
                            loadTime: navigation.loadEventEnd - navigation.loadEventStart,
                            domContentLoaded: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
                            firstPaint: paintEntries.find(entry => entry.name === 'first-paint')?.startTime,
                            firstContentfulPaint: paintEntries.find(entry => entry.name === 'first-contentful-paint')?.startTime
                        });
                    }, 0);
                });
            }
        }

        // 內存優化
        function setupMemoryOptimization() {
            // 定期清理快取
            setInterval(() => {
                if (window.CacheManager) {
                    window.CacheManager.cleanup();
                }
                if (window.resourceOptimizer) {
                    window.resourceOptimizer.cleanupCache();
                }
            }, 300000); // 每 5 分鐘清理一次
        }

        // 初始化所有優化功能
        document.addEventListener('DOMContentLoaded', () => {
            setupPerformanceMonitoring();
            setupMemoryOptimization();
            
            // 初始化時預載入關鍵資源
            if (window.resourceOptimizer) {
                window.resourceOptimizer.preloadCriticalResources();
            }
            
            console.log('所有效能優化已啟用');
        });
    </script>
</body>
</html>
