<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰¹æ¡ç³»çµ± (Supabase ç‰ˆ)</title>
    
    <!-- DNS é è§£æå’Œè³‡æºé è¼‰å…¥ -->
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//htamptcakcnlmltwdcog.supabase.co">
    
    <!-- é è¼‰å…¥é—œéµå­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- éåŒæ­¥è¼‰å…¥å¤–éƒ¨è³‡æº -->
    <!-- å»ºç«‹å…¨åŸŸ state ä»¥ä¾›éæ¨¡çµ„ç¨‹å¼æˆ–ç¬¬ä¸‰æ–¹å›å‘¼å­˜å– -->
    <script>
        // å»ºç«‹çœŸæ­£çš„å…¨åŸŸ stateï¼ˆä½¿ç”¨ var ä»¥è®“éåš´æ ¼æ¨¡å¼èˆ‡ç¬¬ä¸‰æ–¹ç¨‹å¼èƒ½å­˜å–ï¼‰
        if (!window.state) window.state = {};
        try {
            if (typeof state === 'undefined') { var state = window.state; }
        } catch (e) {
            window.state = window.state || {};
            var state = window.state;
        }
    </script>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script type="module">
        // æ‚¨çš„ Supabase è¨­å®š
    const supabaseUrl = 'https://htamptcakcnlmltwdcog.supabase.co';
    // å°‡ URL èˆ‡é‡‘é‘°æ›åˆ° windowï¼Œä¾›å…¶ä»–æ¨¡çµ„/å‚™æ´æµç¨‹å–ç”¨
        window.SUPABASE_URL = supabaseUrl;
        // å…¼å®¹èˆŠç¨‹å¼ç¢¼ï¼ˆè‹¥æœ‰è™•åƒè€ƒ window.supabaseUrl æˆ–å…¨åŸŸ supabaseUrlï¼‰ï¼š
        window.supabaseUrl = supabaseUrl;
        // è¼”åŠ©ï¼šçµ±ä¸€å–å¾— Functions åŸºåº• URL
        window.getSupabaseBaseUrl = function() {
            return window.SUPABASE_URL || window.supabaseUrl || '';
        };
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0YW1wdGNha2NubG1sdHdkY29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0ODM2MzAsImV4cCI6MjA2OTA1OTYzMH0.Pt94WOX9lX9svYrq02s27Dvm1El1K2DktAxR9o9nhOE';
    // è®“å…¶ä»– module script å¯å®‰å…¨å­˜å–ï¼ˆé¿å…è·¨æ¨¡çµ„ä½œç”¨åŸŸå•é¡Œï¼‰
    window.SUPABASE_ANON_KEY = supabaseAnonKey;

    // ç­‰å¾…ä¾è³´è¼‰å…¥å®Œæˆ
        const waitForDependencies = () => {
            return new Promise((resolve) => {
                const checkDependencies = () => {
                    if (window.supabase && window.XlsxPopulate) {
                        resolve();
                    } else {
                        setTimeout(checkDependencies, 50);
                    }
                };
                checkDependencies();
            });
        };

    // --- å…¨åŸŸç‹€æ…‹ç®¡ç† ---
    // æŒ‡æ´¾åˆ°å·²å­˜åœ¨çš„å…¨åŸŸ stateï¼ˆé¿å… module scope èˆ‡å…¨åŸŸ scope ä¸ä¸€è‡´ï¼‰
    state = {
            theme: 'default',
            view: 'login',
            requests: [],
            products: {}, // åˆ†é¡å¾Œçš„ç”¢å“
            allProducts: [], // æ‰€æœ‰ç”¢å“åˆ—è¡¨
            vendors: [], // å» å•†åˆ—è¡¨
            users: {}, // key æ˜¯ user uuid
            categories: [],
            departments: {},
            applicantNotifications: [],
            currentUser: null, // åŒ…å«å¾ users è¡¨ä¾†çš„ profile
            selectedRequest: null,
            editingRequest: null, // *** NEW: æ­£åœ¨ç·¨è¼¯çš„è‰ç¨¿ ***
            editingProduct: null,
            editingUser: null,
            editingVendor: null,
            loading: true,
            error: null,
            local: {
                dashboardFilters: {
                    vendors: new Set(),
                    statuses: new Set(),
                    handlerStatuses: new Set(),
                    closedStatuses: new Set(),
                },
                personalForms: {
                    activeTab: 'inbox',
                    inbox: { searchTerm: '' },
                    sent: { status: 'all', searchTerm: '', dateFrom: '', dateTo: '' },
                    history: { status: 'all', searchTerm: '', dateFrom: '', dateTo: '' },
                    handler: { status: 'all', handlerStatus: 'all', searchTerm: '', dateFrom: '', dateTo: '' },
                    closed: { status: 'all', searchTerm: '', dateFrom: '', dateTo: '' },
                },
                userManagementFilters: {
                    department: 'all',
                    searchTerm: ''
                },
                departmentManagementSearchTerm: '',
                vendorManagementSearchTerm: '',
                newRequestCart: [],
                activeProductCategory: 'æˆ‘çš„æœ€æ„›',
                activeProductManagementCategory: 'å…¨å“é …',
                selectedRequestIds: new Set(),
                currentPage: 1,
                itemsPerPage: 10,
                permissionFilter: 'my',
                consolidatedData: null,
                sortKey: 'request_date',
                sortDirection: 'desc',
                productManagementSearchTerm: '',
                newRequestSearchTerm: '',
                newRequestSearchAll: false,
                newRequestCurrentPage: 1,
                productSortKey: 'id',
                productSortDirection: 'asc',
                productFilters: {},
                favoriteProductIds: new Set(),
                layoutScale: 'expanded', // 'expanded' = 3:2 (+), 'compact' = 2:3 (-)
                // ç”³è«‹å–®é™„ä»¶ï¼ˆåœ¨é€å‡º/å„²å­˜å‰çš„æœ¬åœ°æš«å­˜ï¼‰
                newRequestAttachments: []
            }
        };

        // åˆå§‹åŒ– Supabaseï¼ˆå»¶é²è¼‰å…¥ï¼‰
        const initSupabase = async () => {
            if (typeof supabase !== 'undefined') {
                const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
                window.supabase = supabaseClient;
            } else {
                // å¦‚æœ supabase é‚„æœªè¼‰å…¥ï¼Œç­‰å¾…
                setTimeout(initSupabase, 100);
            }
        };

        // ç•¶é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSupabase);
        } else {
            initSupabase();
        }

        // åœ¨ä»¥ file:// é–‹å•Ÿæ™‚æç¤º CORS é¢¨éšªï¼Œå»ºè­°æ”¹ç”¨æœ¬æ©Ÿ HTTP ä¼ºæœå™¨
        const ensureTopWarningBanner = () => {
            if (location.protocol !== 'file:') return;
            if (document.getElementById('file-protocol-warning')) return;
            const bar = document.createElement('div');
            bar.id = 'file-protocol-warning';
            bar.style.position = 'fixed';
            bar.style.top = '0';
            bar.style.left = '0';
            bar.style.right = '0';
            bar.style.zIndex = '10000';
            bar.style.background = '#b91c1c';
            bar.style.color = 'white';
            bar.style.padding = '8px 12px';
            bar.style.fontSize = '13px';
            bar.style.textAlign = 'center';
            bar.textContent = 'åµæ¸¬åˆ°ä»¥æª”æ¡ˆè·¯å¾‘ (file://) é–‹å•Ÿæœ¬é ï¼Œç€è¦½å™¨å°‡å°é–è·¨åŸŸè«‹æ±‚ï¼Œå¯èƒ½å°è‡´ Edge Function ä¸Šå‚³/ä¸‹è¼‰å¤±æ•—ã€‚è«‹æ”¹ä»¥æœ¬æ©Ÿä¼ºæœå™¨ï¼ˆhttp://localhostï¼‰é–‹å•Ÿæ­¤å°ˆæ¡ˆã€‚';
            document.body.appendChild(bar);
            // æ¨ä¸‹æ•´é«”å…§å®¹é¿å…è¢«é®ä½
            document.body.style.paddingTop = '36px';
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', ensureTopWarningBanner);
        } else {
            ensureTopWarningBanner();
        }
    </script>

    <script type="module">
        // === æ•ˆèƒ½å„ªåŒ–å·¥å…·å‡½æ•¸ ===
        
        // é˜²æŠ–å‹•å‡½æ•¸
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // ç¯€æµå‡½æ•¸
        const throttle = (func, limit) => {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        };

        // ç·©å­˜ç®¡ç†å™¨
        const CacheManager = {
            cache: new Map(),
            maxSize: 100,
            
            set(key, value, ttl = 300000) { // 5åˆ†é˜é»˜èªTTL
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    value,
                    timestamp: Date.now(),
                    ttl
                });
            },
            
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                if (Date.now() - item.timestamp > item.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.value;
            },
            
            clear(key = null) {
                if (key) {
                    this.cache.delete(key);
                } else {
                    this.cache.clear();
                }
            }
        };

        // å°‡å·¥å…·å‡½æ•¸æ›è¼‰åˆ°å…¨åŸŸ
        window.debounce = debounce;
        window.throttle = throttle;

        // è³‡æºè¼‰å…¥å„ªåŒ–ç®¡ç†å™¨
        class ResourceOptimizer {
            constructor() {
                this.loadedImages = new Set();
                this.imageCache = new Map();
                this.loadQueue = [];
                this.isProcessing = false;
            }

            // æ‡¶è¼‰å…¥åœ–ç‰‡
            lazyLoadImage(imgElement, src, fallbackSrc = '/api/placeholder/300/200') {
                if (this.loadedImages.has(src)) {
                    imgElement.src = src;
                    return Promise.resolve();
                }

                return new Promise((resolve, reject) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        this.loadedImages.add(src);
                        this.imageCache.set(src, img);
                        imgElement.src = src;
                        imgElement.classList.add('loaded');
                        resolve();
                    };
                    
                    img.onerror = () => {
                        console.warn(`åœ–ç‰‡è¼‰å…¥å¤±æ•—: ${src}`);
                        if (fallbackSrc && src !== fallbackSrc) {
                            this.lazyLoadImage(imgElement, fallbackSrc).then(resolve).catch(reject);
                        } else {
                            imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzZiNzI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWclueJh+aXoOazleS4reaIlui8ieWFpTwvdGV4dD48L3N2Zz4=';
                            imgElement.classList.add('error');
                            reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—'));
                        }
                    };
                    
                    // è¨­ç½®è¼‰å…¥è¶…æ™‚
                    setTimeout(() => {
                        if (!img.complete) {
                            img.onerror();
                        }
                    }, 10000);
                    
                    img.src = src;
                });
            }

            // é è¼‰å…¥é—œéµè³‡æº
            preloadCriticalResources() {
                const criticalImages = [
                    // å¯ä»¥æ·»åŠ éœ€è¦é è¼‰å…¥çš„é—œéµåœ–ç‰‡ URL
                ];

                return Promise.all(
                    criticalImages.map(src => {
                        if (this.loadedImages.has(src)) return Promise.resolve();
                        
                        return new Promise((resolve) => {
                            const img = new Image();
                            img.onload = () => {
                                this.loadedImages.add(src);
                                this.imageCache.set(src, img);
                                resolve();
                            };
                            img.onerror = () => resolve(); // å³ä½¿å¤±æ•—ä¹Ÿç¹¼çºŒ
                            img.src = src;
                        });
                    })
                );
            }

            // æ¸…ç†æœªä½¿ç”¨çš„åœ–ç‰‡å¿«å–
            cleanupCache() {
                const maxCacheSize = 50;
                if (this.imageCache.size > maxCacheSize) {
                    const entries = Array.from(this.imageCache.entries());
                    const toRemove = entries.slice(0, entries.length - maxCacheSize);
                    
                    toRemove.forEach(([src]) => {
                        this.imageCache.delete(src);
                        this.loadedImages.delete(src);
                    });
                }
            }

            // æ‰¹é‡è™•ç†åœ–ç‰‡è¼‰å…¥
            batchLoadImages(images) {
                this.loadQueue.push(...images);
                if (!this.isProcessing) {
                    this.processQueue();
                }
            }

            async processQueue() {
                this.isProcessing = true;
                const batchSize = 3; // åŒæ™‚è¼‰å…¥çš„åœ–ç‰‡æ•¸é‡
                
                while (this.loadQueue.length > 0) {
                    const batch = this.loadQueue.splice(0, batchSize);
                    
                    await Promise.allSettled(
                        batch.map(({ element, src, fallback }) => 
                            this.lazyLoadImage(element, src, fallback)
                        )
                    );
                    
                    // åœ¨æ‰¹æ¬¡é–“åŠ å…¥å°å»¶é²é¿å…é˜»å¡ä¸»ç·šç¨‹
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                this.isProcessing = false;
                this.cleanupCache();
            }
        }

        // å‰µå»ºå…¨åŸŸè³‡æºå„ªåŒ–å™¨å¯¦ä¾‹
        window.resourceOptimizer = new ResourceOptimizer();

        // Intersection Observer ç”¨æ–¼åœ–ç‰‡æ‡¶è¼‰å…¥
        const createImageObserver = () => {
            if (!window.IntersectionObserver) return null;

            return new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const src = img.dataset.src;
                        const fallback = img.dataset.fallback;
                        
                        if (src) {
                            window.resourceOptimizer.lazyLoadImage(img, src, fallback)
                                .finally(() => {
                                    imageObserver.unobserve(img);
                                });
                        }
                    }
                });
            }, {
                rootMargin: '50px 0px', // æå‰ 50px é–‹å§‹è¼‰å…¥
                threshold: 0.1
            });
        };

        const imageObserver = createImageObserver();

        // å„ªåŒ–çš„åœ–ç‰‡å…ƒç´ å‰µå»ºå‡½æ•¸
        window.createOptimizedImage = (src, alt = '', className = '', fallbackSrc) => {
            const img = document.createElement('img');
            img.alt = alt;
            img.className = `lazy-image transition-opacity duration-300 opacity-0 ${className}`;
            img.dataset.src = src;
            if (fallbackSrc) img.dataset.fallback = fallbackSrc;
            
            // è¨­ç½®è¼‰å…¥ä¸­çš„ä½”ä½ç¬¦
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PGNpcmNsZSBjeD0iNTAlIiBjeT0iNTAlIiByPSIyMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZDFkNWRiIiBzdHJva2Utd2lkdGg9IjIiPjxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiBmcm9tPSIwIDUwIDUwIiB0bz0iMzYwIDUwIDUwIiBkdXI9IjFzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPjwvY2lyY2xlPjx0ZXh0IHg9IjUwJSIgeT0iNjUlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM2YjcyODAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPui8ieWFpeS4rTwvdGV4dD48L3N2Zz4=';
            
            // ç•¶åœ–ç‰‡æˆåŠŸè¼‰å…¥æ™‚æ·»åŠ è¼‰å…¥å®Œæˆçš„æ¨£å¼
            img.addEventListener('load', () => {
                img.classList.add('opacity-100');
                img.classList.remove('opacity-0');
            });
            
            // å¦‚æœæ”¯æ´ Intersection Observerï¼Œä½¿ç”¨æ‡¶è¼‰å…¥
            if (imageObserver) {
                imageObserver.observe(img);
            } else {
                // é™ç´šæ–¹æ¡ˆï¼šç«‹å³è¼‰å…¥
                window.resourceOptimizer.lazyLoadImage(img, src, fallbackSrc);
            }
            
            return img;
        };

        window.CacheManager = CacheManager;

        // === LocalStorage ç®¡ç†èˆ‡è‡ªå‹•ç™»å…¥åŠŸèƒ½ï¼ˆé©ç”¨æ–¼Google Sitesï¼‰===
        
        // Google Sites æœƒè©±ç®¡ç†å™¨ - å®Œå…¨ä¾è³´ä¼ºæœå™¨ç«¯
        class GoogleSitesSessionManager {
            constructor() {
                this.sessionKey = 'current_session';
                this.isGoogleSites = this.detectGoogleSites();
                this.deviceId = this.generateDeviceId();
                console.log(`ğŸ”§ Google Sites æœƒè©±ç®¡ç†å™¨åˆå§‹åŒ–: ${this.isGoogleSites ? 'å·²å•Ÿç”¨' : 'æœªå•Ÿç”¨'}`);
                console.log(`ğŸ“± è¨­å‚™ID: ${this.deviceId}`);
            }

            detectGoogleSites() {
                // è‡¨æ™‚å¼·åˆ¶å•Ÿç”¨ Google Sites æ¨¡å¼ç”¨æ–¼æ¸¬è©¦
                const forceGoogleSites = true; // è¨­ç‚º true ä¾†æ¸¬è©¦
                
                const realDetection = window.location.hostname.includes('sites.google.com') || 
                                    document.referrer.includes('sites.google.com') ||
                                    window.parent !== window; // åœ¨ iframe ä¸­
                
                const result = forceGoogleSites || realDetection;
                console.log(`ğŸ” [GoogleSitesSessionManager] Google Sites æª¢æ¸¬: force=${forceGoogleSites}, real=${realDetection}, result=${result}`);
                return result;
            }

            // ç”Ÿæˆè¨­å‚™æŒ‡ç´‹ä½œç‚ºå”¯ä¸€è­˜åˆ¥
            generateDeviceId() {
                // é¦–å…ˆå˜—è©¦å¾ localStorage è®€å–å·²å­˜åœ¨çš„è¨­å‚™ID
                let storedDeviceId = localStorage.getItem('device_fingerprint_id');
                
                // å¦‚æœ localStorage è¢«æ¸…é™¤äº†ï¼Œå˜—è©¦å¾ sessionStorage è®€å–
                if (!storedDeviceId) {
                    storedDeviceId = sessionStorage.getItem('device_fingerprint_id');
                    if (storedDeviceId) {
                        // å¦‚æœåœ¨ sessionStorage ä¸­æ‰¾åˆ°äº†ï¼Œé‡æ–°ä¿å­˜åˆ° localStorage
                        try {
                            localStorage.setItem('device_fingerprint_id', storedDeviceId);
                            console.log(`ğŸ”„ [è¨­å‚™æŒ‡ç´‹] å¾ sessionStorage æ¢å¾©è¨­å‚™ID: ${storedDeviceId}`);
                        } catch (error) {
                            console.warn(`âš ï¸ [è¨­å‚™æŒ‡ç´‹] ç„¡æ³•ä¿å­˜åˆ° localStorage:`, error);
                        }
                    }
                }
                
                if (storedDeviceId) {
                    console.log(`ğŸ” [è¨­å‚™æŒ‡ç´‹] ä½¿ç”¨å·²å­˜å„²çš„è¨­å‚™ID: ${storedDeviceId}`);
                    return storedDeviceId;
                }

                // å¦‚æœæ²’æœ‰å­˜å„²çš„IDï¼Œä½¿ç”¨æ›´ç©©å®šçš„æŒ‡ç´‹è¦ç´ 
                const fingerprint = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height + 'x' + screen.colorDepth,
                    new Date().getTimezoneOffset(),
                    navigator.platform,
                    navigator.hardwareConcurrency || 'unknown',
                    // ç§»é™¤æ‰€æœ‰å‹•æ…‹å±¬æ€§
                ].filter(Boolean).join('|');
                
                console.log(`ğŸ” [è¨­å‚™æŒ‡ç´‹] åŸå§‹æ•¸æ“š: ${fingerprint.substring(0, 100)}...`);
                
                // ç”Ÿæˆç°¡çŸ­çš„è¨­å‚™ID
                let hash = 0;
                for (let i = 0; i < fingerprint.length; i++) {
                    const char = fingerprint.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // è½‰æ›ç‚º32ä½æ•´æ•¸
                }
                
                const deviceId = Math.abs(hash).toString(36);
                console.log(`ğŸ” [è¨­å‚™æŒ‡ç´‹] ç”Ÿæˆçš„è¨­å‚™ID: ${deviceId}`);
                
                // å°‡è¨­å‚™IDå­˜å„²åˆ° localStorage å’Œ sessionStorage ä»¥ä¿æŒç©©å®šæ€§
                try {
                    localStorage.setItem('device_fingerprint_id', deviceId);
                    sessionStorage.setItem('device_fingerprint_id', deviceId);
                    console.log(`âœ… [è¨­å‚™æŒ‡ç´‹] è¨­å‚™IDå·²ä¿å­˜åˆ° localStorage å’Œ sessionStorage`);
                } catch (error) {
                    console.warn(`âš ï¸ [è¨­å‚™æŒ‡ç´‹] ç„¡æ³•ä¿å­˜è¨­å‚™ID:`, error);
                }
                
                return deviceId;
            }

            // ç”Ÿæˆè‡ªå‹•ç™»å…¥ä»¤ç‰Œ
            generateAutoLoginToken() {
                const array = new Uint8Array(32);
                window.crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            // ä¿å­˜ç™»å…¥æœƒè©±ï¼ˆå®Œå…¨ä¾è³´è³‡æ–™åº«ï¼‰
            async saveLoginSession(userId, rememberLogin = false) {
                console.log(`ğŸ”„ [Google Sites] é–‹å§‹ä¿å­˜æœƒè©±: ä½¿ç”¨è€…=${userId}, è¨˜ä½ç™»å…¥=${rememberLogin}, è¨­å‚™=${this.deviceId}`);
                
                if (!rememberLogin) {
                    console.log('âŒ æœªå‹¾é¸è¨˜ä½ç™»å…¥ï¼Œè·³éæœƒè©±ä¿å­˜');
                    return false;
                }

                try {
                    // ç”Ÿæˆè‡ªå‹•ç™»å…¥ä»¤ç‰Œ
                    const autoLoginToken = this.generateAutoLoginToken();
                    const expiryDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000); // 30å¤©å¾ŒéæœŸ

                    // æ¸…é™¤è©²è¨­å‚™çš„èˆŠæœƒè©±
                    console.log('ğŸ§¹ [Google Sites] æ¸…é™¤èˆŠæœƒè©±...');
                    await supabase
                        .from('login_sessions')
                        .delete()
                        .eq('device_id', this.deviceId);

                    // ä¹Ÿæ¸…é™¤è©²ä½¿ç”¨è€…çš„å…¶ä»–æœƒè©±ï¼ˆé¿å…å”¯ä¸€ç´„æŸå•é¡Œï¼‰
                    console.log('ğŸ§¹ [Google Sites] æ¸…é™¤ä½¿ç”¨è€…çš„å…¶ä»–æœƒè©±...');
                    await supabase
                        .from('login_sessions')
                        .delete()
                        .eq('user_id', userId);

                    // å‰µå»ºæ–°çš„æœƒè©±è¨˜éŒ„
                    console.log('ğŸ“ [Google Sites] å˜—è©¦æ’å…¥æœƒè©±è¨˜éŒ„...');
                    const sessionData = {
                        user_id: userId,
                        auto_login_token: autoLoginToken,
                        device_id: this.deviceId,
                        expires_at: expiryDate.toISOString(),
                        is_active: true,
                        created_at: new Date().toISOString()
                    };
                    
                    console.log('ğŸ“Š [Google Sites] æ’å…¥çš„æœƒè©±è³‡æ–™:', {
                        user_id: sessionData.user_id,
                        token_preview: autoLoginToken.substring(0, 16) + '...',
                        device_id: sessionData.device_id,
                        expires_at: sessionData.expires_at,
                        is_active: sessionData.is_active,
                        created_at: sessionData.created_at
                    });
                    
                    const { data, error } = await supabase
                        .from('login_sessions')
                        .insert([sessionData])
                        .select(); // è¿”å›æ’å…¥çš„è¨˜éŒ„

                    if (error) {
                        console.error('âŒ ä¿å­˜æœƒè©±åˆ°è³‡æ–™åº«å¤±æ•—:', error);
                        console.error('éŒ¯èª¤è©³æƒ…:', error.message);
                        if (error.message.includes('device_id')) {
                            console.error('âš ï¸ è«‹åœ¨ Supabase SQL ç·¨è¼¯å™¨ä¸­åŸ·è¡Œ: ALTER TABLE login_sessions ADD COLUMN device_id text;');
                        }
                        return false;
                    }

                    console.log('âœ… [Google Sites] æœƒè©±å·²ä¿å­˜åˆ°è³‡æ–™åº«');
                    console.log('ğŸ“‹ [Google Sites] æ’å…¥æˆåŠŸçš„è¨˜éŒ„:', data);
                    console.log(`ğŸ” ä»¤ç‰Œ: ${autoLoginToken.substring(0, 16)}...`);
                    console.log(`ğŸ“± è¨­å‚™: ${this.deviceId}`);
                    console.log(`â° éæœŸæ™‚é–“: ${expiryDate.toLocaleString('zh-TW')}`);
                    
                    // ç«‹å³é©—è­‰æ’å…¥æ˜¯å¦æˆåŠŸ
                    console.log('ğŸ” [é©—è­‰] ç«‹å³æŸ¥è©¢å‰›æ’å…¥çš„è¨˜éŒ„...');
                    const verifyResult = await supabase
                        .from('login_sessions')
                        .select('*')
                        .eq('device_id', this.deviceId)
                        .eq('auto_login_token', autoLoginToken)
                        .single();
                    
                    if (verifyResult.error) {
                        console.error('âŒ [é©—è­‰] æŸ¥è©¢å‰›æ’å…¥çš„è¨˜éŒ„å¤±æ•—:', verifyResult.error);
                    } else {
                        console.log('âœ… [é©—è­‰] æ‰¾åˆ°å‰›æ’å…¥çš„è¨˜éŒ„:', verifyResult.data);
                    }
                    console.log(`ğŸ“± è¨­å‚™: ${this.deviceId}`);
                    console.log(`â° éæœŸæ™‚é–“: ${expiryDate.toLocaleString()}`);
                    
                    return true;
                } catch (error) {
                    console.error('âŒ ä¿å­˜æœƒè©±æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    return false;
                }
            }

            // æª¢æŸ¥è‡ªå‹•ç™»å…¥ï¼ˆå®Œå…¨ä¾è³´è³‡æ–™åº«ï¼‰
            async checkAutoLogin() {
                console.log(`ğŸ” [Google Sites] é–‹å§‹æª¢æŸ¥è‡ªå‹•ç™»å…¥: è¨­å‚™=${this.deviceId}`);

                try {
                    // å…ˆæª¢æŸ¥ Supabase å®¢æˆ¶ç«¯ç‹€æ…‹
                    console.log('ğŸ”§ [èª¿è©¦] Supabase å®¢æˆ¶ç«¯ç‹€æ…‹:');
                    console.log('  - supabase å°è±¡:', typeof supabase);
                    console.log('  - supabase.auth:', typeof supabase?.auth);
                    console.log('  - supabase.from:', typeof supabase?.from);
                    console.log('  - supabase.supabaseUrl:', supabase?.supabaseUrl);
                    console.log('  - supabase.supabaseKey:', supabase?.supabaseKey?.substring(0, 20) + '...');
                    
                    // åœ¨ Google Sites ç’°å¢ƒä¸­è·³é Supabase auth æª¢æŸ¥ï¼Œå› ç‚ºå¯èƒ½æœƒå¡ä½
                    console.log('ğŸŒ [Google Sites] è·³é Supabase auth æª¢æŸ¥ï¼Œç›´æ¥æŸ¥è©¢æœƒè©±è¨˜éŒ„');
                    console.log('ï¿½ [èªªæ˜] Google Sites ç’°å¢ƒä¸­ Supabase auth API å¯èƒ½è¢«é˜»æ­¢ï¼Œä½¿ç”¨è³‡æ–™åº«æŸ¥è©¢ä»£æ›¿');
                    
                    // ç›´æ¥æŸ¥è©¢æœƒè©±è¨˜éŒ„ï¼Œä¸æª¢æŸ¥èªè­‰ç‹€æ…‹
                    
                    const currentTime = new Date().toISOString();
                    const currentTimeLocal = new Date().toLocaleString('zh-TW');
                    console.log(`ğŸ” [Google Sites] æŸ¥è©¢æ¢ä»¶:`);
                    console.log(`  - device_id: "${this.deviceId}"`);
                    console.log(`  - is_active: true`);
                    console.log(`  - expires_at > "${currentTime}"`);
                    console.log(`  - ç•¶å‰æ™‚é–“: ${currentTimeLocal}`);
                    
                    // å˜—è©¦å‰µå»ºä¸€å€‹è‡¨æ™‚çš„ service client ä¾†ç¹é RLS
                    console.log('ğŸ”§ [ç¹éRLS] å˜—è©¦ä½¿ç”¨ service role æŸ¥è©¢...');
                    
                    // ä½¿ç”¨ rpc èª¿ç”¨ä¾†ç¹é RLS é™åˆ¶
                    const { data: sessions, error } = await supabase.rpc('get_login_session_by_device', {
                        p_device_id: this.deviceId,
                        p_current_time: currentTime
                    });

                    if (error) {
                        console.error('âŒ [RPC] RPC èª¿ç”¨å¤±æ•—ï¼Œå˜—è©¦æ™®é€šæŸ¥è©¢:', error);
                        
                        // å¦‚æœ RPC å¤±æ•—ï¼Œå›åˆ°æ™®é€šæŸ¥è©¢
                        const fallbackQuery = await supabase
                            .from('login_sessions')
                            .select('*')
                            .eq('device_id', this.deviceId)
                            .eq('is_active', true)
                            .order('created_at', { ascending: false })
                            .limit(5);
                        
                        console.log(`ï¿½ [Google Sites] æ™®é€šæŸ¥è©¢çµæœ:`, fallbackQuery.data);
                        console.log(`ğŸ“Š [Google Sites] æ‰¾åˆ° ${fallbackQuery.data?.length || 0} å€‹æœƒè©±è¨˜éŒ„`);
                        
                        if (!fallbackQuery.data || fallbackQuery.data.length === 0) {
                            console.log('âŒ æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æœƒè©±è¨˜éŒ„');

                            // å˜—è©¦ localStorage å›é€€ï¼ˆåŠ é€Ÿ UI æ¢å¾©ï¼Œé¿å…å¡ä½è¼‰å…¥ç•«é¢ï¼‰
                            try {
                                const cacheRaw = localStorage.getItem('sps_autologin_cache');
                                if (cacheRaw) {
                                    const cache = JSON.parse(cacheRaw);
                                    const now = Date.now();
                                    if (cache.expiresAt && new Date(cache.expiresAt).getTime() > now) {
                                        console.log('ğŸ” [å¿«å–å›é€€] ä½¿ç”¨ localStorage çš„è‡ªå‹•ç™»å…¥å¿«å–ï¼Œç«‹å³æ¢å¾© UI');
                                        // è¨­å®š window.currentUser èˆ‡ state.currentUser
                                        window.currentUser = cache.userInfo;
                                        if (state) {
                                            state.currentUser = cache.userInfo;
                                            state.loading = false;
                                            state.view = 'dashboard';
                                        }
                                        // ç«‹å³æ¸²æŸ“ UI
                                        if (typeof render === 'function') render();

                                        // åœ¨èƒŒæ™¯é©—è­‰ token æ˜¯å¦ä»æœ‰æ•ˆï¼ˆéé˜»å¡ï¼‰
                                        (async () => {
                                            try {
                                                console.log('ğŸ” [å¿«å–å›é€€] èƒŒæ™¯é©—è­‰å¿«å–çš„è‡ªå‹•ç™»å…¥ token');
                                                const valid = await this.performAutoLogin(cache.userInfo.id || cache.userInfo.user_id, cache.token);
                                                if (!valid) {
                                                    console.log('âš ï¸ [å¿«å–å›é€€] èƒŒæ™¯é©—è­‰å¤±æ•—ï¼šæ¸…é™¤ localStorage å¿«å–');
                                                    localStorage.removeItem('sps_autologin_cache');
                                                    // è‹¥é©—è­‰å¤±æ•—ï¼Œåˆ‡å›ç™»å…¥é é¢
                                                    updateState({ view: 'login', loading: false });
                                                } else {
                                                    console.log('âœ… [å¿«å–å›é€€] èƒŒæ™¯é©—è­‰æˆåŠŸ');
                                                }
                                            } catch (e) {
                                                console.warn('âš ï¸ [å¿«å–å›é€€] èƒŒæ™¯é©—è­‰éç¨‹å‡ºéŒ¯:', e);
                                            }
                                        })();

                                        return cache.userInfo.user_id || cache.userInfo.id;
                                    } else {
                                        console.log('ğŸ”’ [å¿«å–å›é€€] localStorage å¿«å–ä¸å­˜åœ¨æˆ–å·²éæœŸ');
                                    }
                                }
                            } catch (e) {
                                console.warn('âš ï¸ è®€å– localStorage è‡ªå‹•ç™»å…¥å¿«å–ç™¼ç”ŸéŒ¯èª¤:', e);
                            }

                            return null;
                        }

                        const session = fallbackQuery.data[0];
                        return await this.performAutoLogin(session.user_id, session.auto_login_token);
                    }

                    console.log(`ğŸ“‹ [RPC] RPC æŸ¥è©¢çµæœ:`, sessions);
                    console.log(`ğŸ“Š [RPC] æ‰¾åˆ° ${sessions?.length || 0} å€‹æœƒè©±è¨˜éŒ„`);

                    if (!sessions || sessions.length === 0) {
                        console.log('âŒ RPC æŸ¥è©¢ï¼šæ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æœƒè©±è¨˜éŒ„');
                        return null;
                    }

                    const session = sessions[0];
                    console.log('âœ… [RPC] æ‰¾åˆ°æœ‰æ•ˆæœƒè©±:', {
                        userId: session.user_id,
                        expires: new Date(session.expires_at).toLocaleString()
                    });

                    // å˜—è©¦ä½¿ç”¨ä»¤ç‰Œè‡ªå‹•ç™»å…¥
                    const loginResult = await this.performAutoLogin(session.user_id, session.auto_login_token);
                    
                    if (loginResult) {
                        console.log('ğŸ‰ è‡ªå‹•ç™»å…¥æˆåŠŸ!');
                        return session.user_id;
                    } else {
                        console.log('âŒ è‡ªå‹•ç™»å…¥å¤±æ•—ï¼Œæ¸…é™¤ç„¡æ•ˆæœƒè©±');
                        await this.clearInvalidSession(session.auto_login_token);
                        return null;
                    }

                } catch (error) {
                    console.error('âŒ [Google Sites] æª¢æŸ¥è‡ªå‹•ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    return null;
                }
            }

            // åŸ·è¡Œè‡ªå‹•ç™»å…¥
            async performAutoLogin(userId, token) {
                try {
                    console.log(`ğŸ” [è‡ªå‹•ç™»å…¥] é–‹å§‹åŸ·è¡Œ: ä½¿ç”¨è€…=${userId.substring(0, 8)}..., ä»¤ç‰Œ=${token.substring(0, 16)}...`);
                    
                    // ç›´æ¥é©—è­‰ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆï¼ˆä¸ä¾è³´å¤–éƒ¨ users è¡¨ï¼‰
                    const { data: sessionData, error: sessionError } = await supabase
                        .from('login_sessions')
                        .select('user_id, auto_login_token, expires_at')
                        .eq('auto_login_token', token)
                        .eq('user_id', userId)
                        .eq('is_active', true)
                        .gt('expires_at', new Date().toISOString())
                        .single();

                    if (sessionError || !sessionData) {
                        console.log('âŒ [è‡ªå‹•ç™»å…¥] ä»¤ç‰Œç„¡æ•ˆæˆ–å·²éæœŸ:', sessionError);
                        return { success: false, error: 'ä»¤ç‰Œç„¡æ•ˆæˆ–å·²éæœŸ' };
                    }

                    console.log('âœ… [è‡ªå‹•ç™»å…¥] ä»¤ç‰Œé©—è­‰æˆåŠŸ');
                    
                    // è¨­ç½®ä½¿ç”¨è€…ç‹€æ…‹ï¼ˆé¿å…ä¾è³´å¤–éƒ¨è¡¨ï¼‰
                    const userInfo = {
                        id: userId,
                        user_id: userId,
                        username: userId.substring(0, 8), // è‡¨æ™‚ç”¨æˆ¶å
                        name: `ä½¿ç”¨è€… ${userId.substring(0, 8)}`, // è‡¨æ™‚å§“å
                        role: 'ä½¿ç”¨è€…', // é è¨­è§’è‰²
                        department: 'æœªçŸ¥éƒ¨é–€',
                        is_admin: false,
                        loginMethod: 'auto_login',
                        loginTime: new Date()
                    };
                    
                    // åŒæ™‚è¨­ç½® window.currentUser å’Œ state.currentUser
                    window.currentUser = userInfo;
                    
                    // ç¢ºä¿ state ç‰©ä»¶å­˜åœ¨ä¸¦è¨­ç½® currentUser
                    if (typeof state !== 'undefined' && state) {
                        state.currentUser = userInfo;
                        console.log('âœ… [è‡ªå‹•ç™»å…¥] state.currentUser å·²è¨­ç½®');
                    } else {
                        console.warn('âš ï¸ [è‡ªå‹•ç™»å…¥] state ç‰©ä»¶ä¸å­˜åœ¨ï¼Œåªè¨­ç½® window.currentUser');
                    }
                    
                    console.log('ğŸ‰ [è‡ªå‹•ç™»å…¥] ä½¿ç”¨è€…ç‹€æ…‹å·²è¨­ç½®:', userInfo);
                    
                    // æ›´æ–°ç‹€æ…‹ä¸¦æ¸²æŸ“UI
                    try {
                        if (typeof state !== 'undefined' && state) {
                            // è¨­ç½®ç‹€æ…‹ï¼šåœæ­¢è¼‰å…¥ï¼Œåˆ‡æ›åˆ°dashboardè¦–åœ–
                            state.loading = false;
                            state.view = 'dashboard';
                            state.error = null;
                            console.log('âœ… [è‡ªå‹•ç™»å…¥] ç‹€æ…‹å·²æ›´æ–°: loading=false, view=dashboard');
                        }
                        
                        // èª¿ç”¨æ¸²æŸ“å‡½æ•¸æ›´æ–°UI
                        if (typeof render === 'function') {
                            render();
                            console.log('âœ… [è‡ªå‹•ç™»å…¥] UIå·²é‡æ–°æ¸²æŸ“');
                        } else {
                            console.warn('âš ï¸ [è‡ªå‹•ç™»å…¥] render å‡½æ•¸ä¸å­˜åœ¨');
                        }
                    } catch (uiError) {
                        console.log('âš ï¸ [è‡ªå‹•ç™»å…¥] UIæ›´æ–°å¤±æ•—ï¼Œä½†ç™»å…¥æˆåŠŸ:', uiError);
                    }
                    
                    return { success: true, userId: userId };
                } catch (error) {
                    console.error('âŒ [è‡ªå‹•ç™»å…¥] åŸ·è¡Œå¤±æ•—:', error);
                    return { success: false, error: error.message };
                }
            }

            // æ¸…é™¤ç„¡æ•ˆæœƒè©±
            async clearInvalidSession(token) {
                try {
                    await supabase
                        .from('login_sessions')
                        .delete()
                        .eq('auto_login_token', token);
                    console.log('ğŸ—‘ï¸ å·²æ¸…é™¤ç„¡æ•ˆæœƒè©±');
                } catch (error) {
                    console.error('âŒ æ¸…é™¤ç„¡æ•ˆæœƒè©±å¤±æ•—:', error);
                }
            }

            // æ¸…é™¤ç™»å…¥æœƒè©±
            async clearLoginSession() {
                console.log(`ğŸ§¹ [Google Sites] é–‹å§‹æ¸…é™¤æœƒè©±: è¨­å‚™=${this.deviceId}`);
                
                try {
                    // æ¸…é™¤è©²è¨­å‚™çš„æ‰€æœ‰æœƒè©±
                    const { error } = await supabase
                        .from('login_sessions')
                        .delete()
                        .eq('device_id', this.deviceId);

                    if (error) {
                        console.error('âŒ æ¸…é™¤æœƒè©±å¤±æ•—:', error);
                        return false;
                    }

                    console.log('âœ… [Google Sites] æœƒè©±å·²æ¸…é™¤');
                    return true;
                } catch (error) {
                    console.error('âŒ æ¸…é™¤æœƒè©±æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    return false;
                }
            }
        }

        // å»ºç«‹ Google Sites æœƒè©±ç®¡ç†å™¨å¯¦ä¾‹
        const googleSitesSession = new GoogleSitesSessionManager();
        
        // ç¢ºä¿è³‡æ–™åº« schema åŒ…å« device_id æ¬„ä½
        async function ensureDeviceIdColumn() {
            try {
                // æª¢æŸ¥ device_id æ¬„ä½æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡æ·»åŠ 
                const { data, error } = await supabase
                    .from('login_sessions')
                    .select('device_id')
                    .limit(1);
                
                if (error && error.message.includes('column "device_id" does not exist')) {
                    console.log('âš¡ æ·»åŠ  device_id æ¬„ä½åˆ° login_sessions è³‡æ–™è¡¨...');
                    // æ³¨æ„ï¼šåœ¨ Supabase ä¸­ï¼Œä½ éœ€è¦åœ¨ SQL ç·¨è¼¯å™¨ä¸­æ‰‹å‹•åŸ·è¡Œä»¥ä¸‹ SQLï¼š
                    // ALTER TABLE login_sessions ADD COLUMN device_id text;
                    console.warn('âš ï¸ è«‹åœ¨ Supabase SQL ç·¨è¼¯å™¨ä¸­åŸ·è¡Œ: ALTER TABLE login_sessions ADD COLUMN device_id text;');
                }
            } catch (error) {
                console.log('ğŸ“‹ device_id æ¬„ä½æª¢æŸ¥å®Œæˆ');
            }
        }
        
        // åœ¨é é¢è¼‰å…¥æ™‚æª¢æŸ¥è³‡æ–™åº« schema
        ensureDeviceIdColumn();
        
        // è¶…ç´šæŒä¹…åŒ–å­˜å„²æ–¹æ¡ˆï¼ˆé‡å°Google Siteså„ªåŒ–ï¼‰
        class SuperPersistentStorage {
            constructor() {
                this.methods = ['indexedDB', 'localStorage', 'sessionStorage', 'urlParams', 'document'];
                this.prefix = 'sps_';
            }

            // URL åƒæ•¸å„²å­˜ï¼ˆæœ€å¾Œæ‰‹æ®µï¼‰
            saveToURL(key, value, days = 30) {
                try {
                    // å–å¾—ç¾æœ‰çš„ URL è³‡æ–™
                    let existingData = {};
                    const currentHash = location.hash;
                    if (currentHash.includes('data=')) {
                        try {
                            const dataMatch = currentHash.match(/data=([^&]*)/);
                            if (dataMatch) {
                                existingData = JSON.parse(atob(dataMatch[1]));
                            }
                        } catch (e) {
                            console.warn('è§£æç¾æœ‰ URL è³‡æ–™å¤±æ•—ï¼Œå°‡å‰µå»ºæ–°çš„');
                        }
                    }
                    
                    // æ·»åŠ æ–°è³‡æ–™
                    const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).getTime();
                    existingData[key] = { value, expires };
                    
                    const urlData = btoa(JSON.stringify(existingData));
                    
                    // æ›´æ–° hash
                    let newHash = currentHash;
                    if (newHash.includes('data=')) {
                        newHash = newHash.replace(/data=[^&]*/, `data=${urlData}`);
                    } else {
                        const separator = newHash.includes('?') ? '&' : (newHash === '#' ? '?' : '&');
                        newHash = (newHash || '#') + separator + `data=${urlData}`;
                    }
                    
                    // éœé»˜æ›´æ–° URL
                    if (history.replaceState) {
                        history.replaceState(null, '', location.pathname + location.search + newHash);
                        console.log('ğŸ”— URL åƒæ•¸å„²å­˜æˆåŠŸ:', key);
                        return true;
                    }
                } catch (error) {
                    console.error('âŒ URL åƒæ•¸å„²å­˜å¤±æ•—:', error);
                }
                return false;
            }

            // å¾ URL åƒæ•¸è®€å–
            getFromURL(key) {
                try {
                    const hash = location.hash;
                    console.log(`ğŸ” URL Hash: "${hash}"`);
                    
                    const dataMatch = hash.match(/data=([^&]*)/);
                    if (!dataMatch) {
                        console.log('âŒ URL ä¸­æ²’æœ‰æ‰¾åˆ° data åƒæ•¸');
                        return null;
                    }
                    
                    console.log(`ğŸ” æ‰¾åˆ° data åƒæ•¸:`, dataMatch[1].substring(0, 50) + '...');
                    const urlData = JSON.parse(atob(dataMatch[1]));
                    console.log(`ğŸ” è§£æå¾Œçš„ URL è³‡æ–™:`, urlData);
                    
                    const item = urlData[key];
                    if (!item) {
                        console.log(`âŒ URL è³‡æ–™ä¸­æ²’æœ‰æ‰¾åˆ°éµ: ${key}`);
                        return null;
                    }
                    
                    // æª¢æŸ¥éæœŸ
                    if (item.expires && item.expires < Date.now()) {
                        console.log('â° URL åƒæ•¸è³‡æ–™å·²éæœŸ:', key);
                        return null;
                    }
                    
                    console.log('ğŸ”— å¾ URL åƒæ•¸æ¢å¾©è³‡æ–™:', key);
                    return item.value;
                } catch (error) {
                    console.error('âŒ URL åƒæ•¸è®€å–å¤±æ•—:', error);
                }
                return null;
            }

            // Document title éš±è—å„²å­˜ï¼ˆæ¥µç«¯å‚™ç”¨ï¼‰
            saveToDocument(key, value) {
                try {
                    const originalTitle = document.title;
                    
                    // æª¢æŸ¥æ˜¯å¦å·²æœ‰éš±è—è³‡æ–™
                    let existingData = {};
                    const hiddenDataMatch = originalTitle.match(/\u200B(.+)$/);
                    if (hiddenDataMatch) {
                        try {
                            existingData = JSON.parse(atob(hiddenDataMatch[1]));
                        } catch (e) {
                            console.warn('è§£æç¾æœ‰ Document è³‡æ–™å¤±æ•—ï¼Œå°‡å‰µå»ºæ–°çš„');
                        }
                    }
                    
                    // æ·»åŠ æ–°è³‡æ–™
                    existingData[key] = value;
                    const hiddenData = btoa(JSON.stringify(existingData));
                    
                    // ç§»é™¤èˆŠçš„éš±è—è³‡æ–™ä¸¦æ·»åŠ æ–°çš„
                    const cleanTitle = originalTitle.replace(/\u200B.*$/, '');
                    document.title = cleanTitle + '\u200B' + hiddenData; // ä½¿ç”¨é›¶å¯¬å­—ç¬¦
                    console.log('ğŸ“„ Document éš±è—å„²å­˜æˆåŠŸ:', key);
                    return true;
                } catch (error) {
                    console.error('âŒ Document å„²å­˜å¤±æ•—:', error);
                }
                return false;
            }

            getFromDocument(key) {
                try {
                    const title = document.title;
                    console.log(`ğŸ” Document æ¨™é¡Œ: "${title}"`);
                    
                    const hiddenDataMatch = title.match(/\u200B(.+)$/);
                    if (!hiddenDataMatch) {
                        console.log('âŒ Document æ¨™é¡Œä¸­æ²’æœ‰æ‰¾åˆ°éš±è—è³‡æ–™');
                        return null;
                    }
                    
                    console.log(`ğŸ” æ‰¾åˆ°éš±è—è³‡æ–™:`, hiddenDataMatch[1].substring(0, 50) + '...');
                    const hiddenData = JSON.parse(atob(hiddenDataMatch[1]));
                    console.log(`ğŸ” è§£æå¾Œçš„ Document è³‡æ–™:`, hiddenData);
                    
                    const value = hiddenData[key];
                    if (value) {
                        console.log('ğŸ“„ å¾ Document æ¢å¾©è³‡æ–™:', key);
                        return value;
                    } else {
                        console.log(`âŒ Document è³‡æ–™ä¸­æ²’æœ‰æ‰¾åˆ°éµ: ${key}`);
                    }
                } catch (error) {
                    console.error('âŒ Document è®€å–å¤±æ•—:', error);
                }
                return null;
            }

            // è¶…ç´šä¿å­˜ï¼šåŒæ™‚ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ–¹æ³•
            async superSave(key, value, days = 30) {
                const results = [];
                
                console.log(`ğŸš€ é–‹å§‹è¶…ç´šä¿å­˜: ${key}`);
                
                // æ–¹æ³•1ï¼šåŸæœ‰çš„å¤šé‡ LocalStorage
                try {
                    const success = await setLocalData(key, value, days);
                    results.push({ method: 'localStorage', success });
                } catch (error) {
                    results.push({ method: 'localStorage', success: false, error });
                }
                
                // æ–¹æ³•2ï¼šURL åƒæ•¸
                try {
                    const success = this.saveToURL(key, value, days);
                    results.push({ method: 'urlParams', success });
                } catch (error) {
                    results.push({ method: 'urlParams', success: false, error });
                }
                
                // æ–¹æ³•3ï¼šDocument éš±è—å„²å­˜
                try {
                    const success = this.saveToDocument(key, value);
                    results.push({ method: 'document', success });
                } catch (error) {
                    results.push({ method: 'document', success: false, error });
                }
                
                const successCount = results.filter(r => r.success).length;
                console.log(`ğŸ“Š è¶…ç´šä¿å­˜çµæœ: ${successCount}/${results.length} æ–¹æ³•æˆåŠŸ`);
                
                // è©³ç´°çµæœ
                results.forEach(result => {
                    const status = result.success ? 'âœ…' : 'âŒ';
                    console.log(`  ${status} ${result.method}: ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
                });
                
                return successCount > 0;
            }

            // è¶…ç´šè®€å–ï¼šå¾æ‰€æœ‰å¯èƒ½çš„åœ°æ–¹æ¢å¾©è³‡æ–™
            async superGet(key) {
                console.log(`ğŸ” é–‹å§‹è¶…ç´šè®€å–: ${key}`);
                
                // æ–¹æ³•1ï¼šåŸæœ‰çš„å¤šé‡ LocalStorage + IndexedDB
                try {
                    const value = await getLocalData(key);
                    if (value) {
                        console.log(`âœ… å¾ LocalStorage/IndexedDB æ¢å¾©: ${key}`);
                        return value;
                    }
                } catch (error) {
                    console.error('LocalStorage/IndexedDB è®€å–å¤±æ•—:', error);
                }
                
                // æ–¹æ³•2ï¼šURL åƒæ•¸
                try {
                    console.log('ğŸ” æª¢æŸ¥ URL åƒæ•¸...', location.hash);
                    const value = this.getFromURL(key);
                    if (value) {
                        console.log(`âœ… å¾ URL åƒæ•¸æ¢å¾©: ${key}`);
                        // æ¢å¾©åˆ° LocalStorage
                        await setLocalData(key, value, 30);
                        return value;
                    }
                } catch (error) {
                    console.error('URL åƒæ•¸è®€å–å¤±æ•—:', error);
                }
                
                // æ–¹æ³•3ï¼šDocument éš±è—å„²å­˜
                try {
                    console.log('ğŸ” æª¢æŸ¥ Document æ¨™é¡Œ...', document.title);
                    const value = this.getFromDocument(key);
                    if (value) {
                        console.log(`âœ… å¾ Document æ¢å¾©: ${key}`);
                        // æ¢å¾©åˆ° LocalStorage
                        await setLocalData(key, value, 30);
                        return value;
                    }
                } catch (error) {
                    console.error('Document è®€å–å¤±æ•—:', error);
                }
                
                console.log(`âŒ æ‰€æœ‰æ–¹æ³•éƒ½ç„¡æ³•æ‰¾åˆ°: ${key}`);
                return null;
            }

            // è¶…ç´šæ¸…é™¤
            async superClear(key) {
                console.log(`ğŸ§¹ é–‹å§‹è¶…ç´šæ¸…é™¤: ${key}`);
                
                // æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„å„²å­˜ä½ç½®
                try {
                    await deleteLocalData(key);
                } catch (error) {
                    console.error('LocalStorage æ¸…é™¤å¤±æ•—:', error);
                }
                
                // æ¸…é™¤ URL åƒæ•¸ä¸­çš„è³‡æ–™
                try {
                    const hash = location.hash;
                    if (hash.includes('data=')) {
                        const newHash = hash.replace(/[?&]data=[^&]*/, '');
                        if (history.replaceState) {
                            history.replaceState(null, '', location.pathname + location.search + newHash);
                        }
                    }
                } catch (error) {
                    console.error('URL åƒæ•¸æ¸…é™¤å¤±æ•—:', error);
                }
                
                // æ¸…é™¤ Document è³‡æ–™
                try {
                    const title = document.title;
                    const cleanTitle = title.replace(/\u200B.+$/, '');
                    document.title = cleanTitle;
                } catch (error) {
                    console.error('Document æ¸…é™¤å¤±æ•—:', error);
                }
                
                console.log(`âœ… è¶…ç´šæ¸…é™¤å®Œæˆ: ${key}`);
            }
        }

        // å‰µå»ºè¶…ç´šæŒä¹…åŒ–å­˜å„²å¯¦ä¾‹
        const superStorage = new SuperPersistentStorage();

        // LocalStorage æ“ä½œå·¥å…·ï¼ˆå¸¶ IndexedDB å‚™ç”¨ï¼‰
        window.setLocalData = async (name, value, days = 30) => {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            
            const data = {
                value: value,
                expires: expires.toISOString(),
                created: new Date().toISOString()
            };
            
            let success = false;
            
            try {
                // æ–¹æ¡ˆ1ï¼šLocalStorageï¼ˆä¸»è¦ï¼‰
                const fullKey = 'sps_' + name;
                const jsonData = JSON.stringify(data);
                localStorage.setItem(fullKey, jsonData);
                console.log(`ï¿½ LocalStorageå·²è¨­ç½®: ${name} = ${value} (å®Œæ•´éµå: ${fullKey})`);
                
                // é©—è­‰å„²å­˜
                const verification = localStorage.getItem(fullKey);
                if (verification === jsonData) {
                    success = true;
                    console.log(`âœ… LocalStorageå„²å­˜é©—è­‰æˆåŠŸ: ${name}`);
                } else {
                    console.error(`âŒ LocalStorageå„²å­˜é©—è­‰å¤±æ•—: ${name}`);
                }
                
                // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥éµå
                try {
                    const backupKey1 = `SPS_${name.toUpperCase()}`;
                    localStorage.setItem(backupKey1, jsonData);
                    console.log(`ğŸ”„ å‚™ç”¨å„²å­˜1: ${backupKey1}`);
                    
                    const simpleKey = `simple_${name}`;
                    localStorage.setItem(simpleKey, value);
                    console.log(`ğŸ”„ å‚™ç”¨å„²å­˜2: ${simpleKey} = ${value}`);
                } catch (backupError) {
                    console.error('å‚™ç”¨ LocalStorage å¤±æ•—:', backupError);
                }
                
            } catch (error) {
                console.error('âŒ LocalStorageè¨­ç½®å¤±æ•—:', error);
            }
            
            // æ–¹æ¡ˆ2ï¼šSessionStorageï¼ˆè‡¨æ™‚å‚™ç”¨ï¼‰
            try {
                sessionStorage.setItem('sps_' + name, JSON.stringify(data));
                console.log(`âš¡ SessionStorageå‚™ç”¨: ${name}`);
            } catch (sessionError) {
                console.error('âŒ SessionStorageè¨­ç½®å¤±æ•—:', sessionError);
            }
            
            // æ–¹æ¡ˆ3ï¼šSessionStorageï¼ˆè‡¨æ™‚å‚™ç”¨ï¼‰
            try {
                sessionStorage.setItem('sps_' + name, JSON.stringify(data));
                console.log(`âš¡ SessionStorageå‚™ç”¨: ${name}`);
            } catch (sessionError) {
                console.error('âŒ SessionStorageè¨­ç½®å¤±æ•—:', sessionError);
            }
            
            return success;
        };

        window.getLocalData = async (name) => {
            try {
                const fullKey = 'sps_' + name;
                
                // æ–¹æ¡ˆ1ï¼šæª¢æŸ¥ LocalStorage
                const exists = localStorage.hasOwnProperty(fullKey) || (fullKey in localStorage);
                console.log(`ğŸ” æª¢æŸ¥éµæ˜¯å¦å­˜åœ¨: ${fullKey} = ${exists}`);
                
                let dataStr = localStorage.getItem(fullKey);
                let source = 'ä¸»è¦å„²å­˜';
                
                // å¦‚æœä¸»è¦å„²å­˜æ²’æœ‰è³‡æ–™ï¼Œå˜—è©¦å‚™ç”¨æ–¹æ¡ˆ
                if (!dataStr) {
                    console.log(`ğŸ“­ ä¸»è¦å„²å­˜ç„¡è³‡æ–™ï¼Œæª¢æŸ¥å‚™ç”¨æ–¹æ¡ˆ...`);
                    
                    // å‚™ç”¨æ–¹æ¡ˆ1ï¼šä¸åŒéµåæ ¼å¼
                    const backupKey1 = `SPS_${name.toUpperCase()}`;
                    dataStr = localStorage.getItem(backupKey1);
                    if (dataStr) {
                        source = 'å‚™ç”¨å„²å­˜1';
                        console.log(`ğŸ”„ å¾å‚™ç”¨å„²å­˜1æ‰¾åˆ°è³‡æ–™: ${backupKey1}`);
                    }
                    
                    // å‚™ç”¨æ–¹æ¡ˆ2ï¼šç°¡å–®å€¼å„²å­˜
                    if (!dataStr) {
                        const simpleKey = `simple_${name}`;
                        const simpleValue = localStorage.getItem(simpleKey);
                        if (simpleValue) {
                            console.log(`ğŸ”„ å¾å‚™ç”¨å„²å­˜2æ‰¾åˆ°è³‡æ–™: ${simpleKey} = ${simpleValue}`);
                            return simpleValue;
                        }
                    }
                    
                    // å‚™ç”¨æ–¹æ¡ˆ3ï¼šsessionStorage
                    if (!dataStr) {
                        dataStr = sessionStorage.getItem('sps_' + name);
                        if (dataStr) {
                            source = 'SessionStorage';
                            console.log(`âš¡ å¾ SessionStorage æ‰¾åˆ°è³‡æ–™`);
                        }
                    }
                }
                
                console.log(`ğŸ“‹ åŸå§‹è³‡æ–™ (${source}): ${fullKey} = ${dataStr ? dataStr.substring(0, 100) + (dataStr.length > 100 ? '...' : '') : 'null'}`);
                
                // å¦‚æœ LocalStorage éƒ½æ²’æœ‰ï¼Œå˜—è©¦ IndexedDB
                if (!dataStr) {
                    console.log(`ï¿½ï¸ æª¢æŸ¥ IndexedDB...`);
                    try {
                        const idbValue = "removed";
                        if (false) {
                            console.log(`âœ… å¾ IndexedDB æ‰¾åˆ°è³‡æ–™: ${name} = ${idbValue}`);
                            return idbValue;
                        }
                    } catch (idbError) {
                        console.error('âŒ IndexedDB è®€å–å¤±æ•—:', idbError);
                    }
                }
                
                if (!dataStr) {
                    console.log(`ï¿½ğŸ“­ LocalStorageç„¡è³‡æ–™: ${name} (å®Œæ•´éµå: ${fullKey})`);
                    
                    // é¡å¤–æª¢æŸ¥ï¼šåˆ—å‡ºæ‰€æœ‰ç›¸é—œçš„éµ
                    console.log('ğŸ” æª¢æŸ¥æ‰€æœ‰ç›¸é—œéµ:');
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.includes('sps_') || key.includes(name) || key.includes('SPS_') || key.includes('simple_')) {
                            console.log(`  æ‰¾åˆ°ç›¸é—œéµ: ${key}`);
                        }
                    }
                    return null;
                }
                
                const data = JSON.parse(dataStr);
                
                // æª¢æŸ¥æ˜¯å¦éæœŸ
                if (data.expires && new Date(data.expires) < new Date()) {
                    localStorage.removeItem(fullKey);
                    console.log(`â° LocalStorageè³‡æ–™å·²éæœŸä¸¦æ¸…é™¤: ${name}`);
                    return null;
                }
                
                console.log(`ğŸ“¤ LocalStorageè®€å–æˆåŠŸ (${source}): ${name} = ${data.value}`);
                return data.value;
            } catch (error) {
                console.error('âŒ LocalStorageè®€å–å¤±æ•—:', error);
                return null;
            }
        };

        window.deleteLocalData = async (name) => {
            try {
                const fullKey = 'sps_' + name;
                
                // æ¸…é™¤ LocalStorage çš„æ‰€æœ‰ç‰ˆæœ¬
                localStorage.removeItem(fullKey);
                localStorage.removeItem(`SPS_${name.toUpperCase()}`);
                localStorage.removeItem(`simple_${name}`);
                sessionStorage.removeItem('sps_' + name);
                
                console.log(`ğŸ—‘ï¸ LocalStorageå·²åˆªé™¤: ${name} (å®Œæ•´éµå: ${fullKey})`);
                
                return true;
            } catch (error) {
                console.error('âŒ LocalStorageåˆªé™¤å¤±æ•—:', error);
                return false;
            }
        };

        // åŒæ­¥ç‰ˆæœ¬çš„ getCookieï¼ˆå‚™ç”¨ï¼Œåƒ…æ”¯æ´ LocalStorageï¼‰
        window.getCookieSync = (name) => {
            try {
                const fullKey = 'sps_' + name;
                const dataStr = localStorage.getItem(fullKey);
                if (!dataStr) return null;
                
                const data = JSON.parse(dataStr);
                if (data.expires && new Date(data.expires) < new Date()) {
                    localStorage.removeItem(fullKey);
                    return null;
                }
                
                return data.value;
            } catch (error) {
                return null;
            }
        };

        // å‘å¾Œç›¸å®¹çš„Cookie APIï¼ˆç•°æ­¥ç‰ˆæœ¬å„ªå…ˆï¼ŒåŒæ­¥ç‰ˆæœ¬å‚™ç”¨ï¼‰
        window.setCookie = window.setLocalData;
        window.getCookie = window.getLocalData;
        window.deleteCookie = window.deleteLocalData;

        // ç™»å…¥æœƒè©±ç®¡ç†ï¼ˆé‡å°Google Siteså„ªåŒ–ï¼‰
        class LoginSessionManager {
            constructor() {
                this.sessionKey = 'sps_login_session';
                this.accountKey = 'rememberedAccount';
                this.autoLoginKey = 'auto_login_token'; // ä¿®æ­£ï¼šç§»é™¤é‡è¤‡çš„sps_å‰ç¶´
                this.isAutoLoggedIn = false; // æ¨™è¨˜æ˜¯å¦ç‚ºè‡ªå‹•ç™»å…¥
                this.isGoogleSites = this.detectGoogleSites();
                
                if (this.isGoogleSites) {
                    console.log('ğŸŒ Google Sites ç’°å¢ƒï¼šä½¿ç”¨ä¼ºæœå™¨ç«¯æœƒè©±ç®¡ç†');
                } else {
                    console.log('ğŸ“± ä¸€èˆ¬ç’°å¢ƒï¼šä½¿ç”¨å®¢æˆ¶ç«¯å­˜å„²');
                }
            }

            detectGoogleSites() {
                // è‡¨æ™‚å¼·åˆ¶å•Ÿç”¨ Google Sites æ¨¡å¼ç”¨æ–¼æ¸¬è©¦
                const forceGoogleSites = true; // è¨­ç‚º true ä¾†æ¸¬è©¦
                
                const realDetection = window.location.hostname.includes('sites.google.com') || 
                                    document.referrer.includes('sites.google.com') ||
                                    window.parent !== window; // åœ¨ iframe ä¸­
                
                const result = forceGoogleSites || realDetection;
                console.log(`ğŸ” [LoginSessionManager] Google Sites æª¢æ¸¬: force=${forceGoogleSites}, real=${realDetection}, result=${result}`);
                return result;
            }

            // ä¿å­˜ç™»å…¥æœƒè©±
            async saveLoginSession(userInfo, rememberMe = false) {
                console.log(`ğŸ”„ é–‹å§‹ä¿å­˜ç™»å…¥æœƒè©±: ä½¿ç”¨è€…=${userInfo?.account || userInfo?.user_id || 'Unknown'}, è¨˜ä½ç™»å…¥=${rememberMe}`);
                
                // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ userInfo å­˜åœ¨ä¸”æœ‰å¿…è¦çš„å±¬æ€§
                if (!userInfo) {
                    console.error('âŒ [éŒ¯èª¤] userInfo ç‚º null æˆ– undefined');
                    return false;
                }
                
                if (!userInfo.id && !userInfo.user_id) {
                    console.error('âŒ [éŒ¯èª¤] userInfo ç¼ºå°‘ id æˆ– user_id å±¬æ€§:', userInfo);
                    return false;
                }
                
                // æ¨™æº–åŒ– user ID
                const userId = userInfo.id || userInfo.user_id;
                
                // å¦‚æœæ˜¯ Google Sites ç’°å¢ƒï¼Œä½¿ç”¨æ–°çš„æœƒè©±ç®¡ç†å™¨
                if (this.isGoogleSites) {
                    console.log('ğŸŒ [Google Sites] ä½¿ç”¨ä¼ºæœå™¨ç«¯æœƒè©±ç®¡ç†');
                    if (rememberMe) {
                        const success = await googleSitesSession.saveLoginSession(userId, rememberMe);
                        if (success) {
                            console.log('ğŸ‰ [Google Sites] è¨˜æ†¶ç™»å…¥è¨­ç½®å®Œæˆï¼');
                        }
                    } else {
                        console.log('âŒ [Google Sites] æœªå‹¾é¸è¨˜ä½ç™»å…¥ï¼Œè·³éæœƒè©±ä¿å­˜');
                    }
                    this.isAutoLoggedIn = false; // é€™æ˜¯æ­£å¸¸ç™»å…¥ï¼Œä¸æ˜¯è‡ªå‹•ç™»å…¥
                    return true; // Google Sites ç’°å¢ƒä¸‹ç¸½æ˜¯è¿”å›æˆåŠŸ
                }
                
                console.log('ğŸ“± [ä¸€èˆ¬ç’°å¢ƒ] ä½¿ç”¨å®¢æˆ¶ç«¯å­˜å„²');
                // ä¸€èˆ¬ç’°å¢ƒçš„é‚è¼¯ä¿æŒä¸è®Š
                const sessionData = {
                    userId: userId,
                    email: userInfo.email,
                    account: userInfo.account || userInfo.user_id,
                    loginTime: new Date().toISOString(),
                    rememberMe: rememberMe,
                    environment: this.isGoogleSites ? 'google-sites' : 'standard'
                };

                // ä¿å­˜æœƒè©±åˆ° localStorage
                try {
                    localStorage.setItem(this.sessionKey, JSON.stringify(sessionData));
                    console.log('âœ… ç™»å…¥æœƒè©±å·²ä¿å­˜åˆ° LocalStorage');
                } catch (error) {
                    console.error('âŒ ä¿å­˜ç™»å…¥æœƒè©±å¤±æ•—:', error);
                }

                if (rememberMe) {
                    console.log('ğŸ” é–‹å§‹è¨­ç½®è¨˜æ†¶ç™»å…¥åŠŸèƒ½...');
                    
                    // ä½¿ç”¨è¶…ç´šå­˜å„²ä¿å­˜å¸³è™Ÿ (30å¤©)
                    try {
                        const accountSaved = await superStorage.superSave(this.accountKey, sessionData.account, 30);
                        console.log(`${accountSaved ? 'âœ…' : 'âŒ'} å¸³è™Ÿè¨˜æ†¶è¶…ç´šä¿å­˜: ${this.accountKey} = ${sessionData.account}`);
                    } catch (error) {
                        console.error('âŒ ä¿å­˜å¸³è™Ÿè¨˜æ†¶å¤±æ•—:', error);
                    }
                    
                    // ç”Ÿæˆè‡ªå‹•ç™»å…¥ä»¤ç‰Œä¸¦ä½¿ç”¨è¶…ç´šå­˜å„²ä¿å­˜
                    const autoLoginToken = this.generateAutoLoginToken();
                    try {
                        const tokenSaved = await superStorage.superSave(this.autoLoginKey, autoLoginToken, 30);
                        console.log(`${tokenSaved ? 'âœ…' : 'âŒ'} ä»¤ç‰Œè¶…ç´šä¿å­˜: ${this.autoLoginKey} = ${autoLoginToken.substring(0, 16)}...`);
                        
                        // ä¿å­˜åˆ°è³‡æ–™åº«
                        await this.saveAutoLoginToken(userInfo.id, autoLoginToken);
                        console.log('âœ… è‡ªå‹•ç™»å…¥ä»¤ç‰Œå·²ä¿å­˜åˆ°è³‡æ–™åº«');
                        
                        console.log('ğŸ‰ è¨˜æ†¶ç™»å…¥è¨­ç½®å®Œæˆï¼');
                    } catch (error) {
                        console.error('âŒ ä¿å­˜è‡ªå‹•ç™»å…¥ä»¤ç‰Œå¤±æ•—:', error);
                    }
                } else {
                    console.log('âš ï¸ æœªå‹¾é¸è¨˜ä½ç™»å…¥ï¼Œæ¸…é™¤ç›¸é—œè³‡æ–™...');
                    // ä¸è¨˜ä½ç™»å…¥æ™‚ï¼Œæ¸…é™¤ç›¸é—œè³‡æ–™
                    try {
                        await superStorage.superClear(this.accountKey);
                        await superStorage.superClear(this.autoLoginKey);
                    } catch (error) {
                        console.error('âŒ æ¸…é™¤è¨˜æ†¶è³‡æ–™å¤±æ•—:', error);
                    }
                }

                // æ¸…é™¤è‡ªå‹•ç™»å…¥æ¨™è¨˜ï¼ˆå› ç‚ºé€™æ˜¯æ­£å¸¸ç™»å…¥ï¼‰
                this.isAutoLoggedIn = false;
            }

            // ç”Ÿæˆè‡ªå‹•ç™»å…¥ä»¤ç‰Œ
            generateAutoLoginToken() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            // ä¿å­˜è‡ªå‹•ç™»å…¥ä»¤ç‰Œåˆ°è³‡æ–™åº«
            async saveAutoLoginToken(userId, token) {
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + 30); // 30å¤©éæœŸ

                const { error } = await supabase
                    .from('login_sessions')
                    .upsert({
                        user_id: userId,
                        auto_login_token: token,
                        expires_at: expiresAt.toISOString(),
                        created_at: new Date().toISOString(),
                        last_used: new Date().toISOString(),
                        user_agent: navigator.userAgent,
                        ip_address: null, // å¦‚æœéœ€è¦è¨˜éŒ„IPï¼Œå¯ä»¥é€šéAPIç²å–
                        is_active: true
                    }, {
                        onConflict: 'user_id'
                    });

                if (error) throw error;
            }

            // æª¢æŸ¥ä¸¦åŸ·è¡Œè‡ªå‹•ç™»å…¥
            async checkAutoLogin() {
                console.log('ğŸ” é–‹å§‹æª¢æŸ¥è‡ªå‹•ç™»å…¥...');
                
                // å¦‚æœæ˜¯ Google Sites ç’°å¢ƒï¼Œä½¿ç”¨æ–°çš„æœƒè©±ç®¡ç†å™¨
                if (this.isGoogleSites) {
                    const result = await googleSitesSession.checkAutoLogin();
                    if (result && result.success) {
                        this.isAutoLoggedIn = true;
                        return true;
                    }
                    return false;
                }
                
                // ä¸€èˆ¬ç’°å¢ƒçš„é‚è¼¯ä¿æŒä¸è®Š
                const autoLoginToken = await superStorage.superGet(this.autoLoginKey);
                if (!autoLoginToken) {
                    console.log('âŒ æ²’æœ‰æ‰¾åˆ°è‡ªå‹•ç™»å…¥ä»¤ç‰Œ');
                    return false;
                }

                console.log(`âœ… æ‰¾åˆ°è‡ªå‹•ç™»å…¥ä»¤ç‰Œ: ${autoLoginToken.substring(0, 16)}...`);
                console.log('ğŸ”„ é–‹å§‹é©—è­‰ä»¤ç‰Œ...');

                try {
                    // é©—è­‰è‡ªå‹•ç™»å…¥ä»¤ç‰Œ
                    const { data, error } = await supabase
                        .from('login_sessions')
                        .select('user_id, expires_at, users(email)')
                        .eq('auto_login_token', autoLoginToken)
                        .eq('is_active', true)
                        .single();

                    if (error || !data) {
                        console.log('âŒ è‡ªå‹•ç™»å…¥ä»¤ç‰Œç„¡æ•ˆæˆ–ä¸å­˜åœ¨:', error?.message);
                        await superStorage.superClear(this.autoLoginKey);
                        return false;
                    }

                    console.log('âœ… ä»¤ç‰Œé©—è­‰æˆåŠŸ');

                    // æª¢æŸ¥ä»¤ç‰Œæ˜¯å¦éæœŸ
                    if (new Date(data.expires_at) < new Date()) {
                        console.log('âŒ è‡ªå‹•ç™»å…¥ä»¤ç‰Œå·²éæœŸ');
                        await superStorage.superClear(this.autoLoginKey);
                        await this.clearExpiredSession(autoLoginToken);
                        return false;
                    }

                    console.log('âœ… ä»¤ç‰ŒæœªéæœŸï¼Œç²å–ä½¿ç”¨è€…è³‡è¨Š...');

                    // ç²å–ä½¿ç”¨è€…è³‡è¨Šä¸¦è‡ªå‹•ç™»å…¥
                    const { data: userProfile, error: userError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', data.user_id)
                        .single();

                    if (userError || !userProfile) {
                        console.error('âŒ è‡ªå‹•ç™»å…¥å¤±æ•—ï¼šæ‰¾ä¸åˆ°ä½¿ç”¨è€…', userError);
                        return false;
                    }

                    console.log(`âœ… ä½¿ç”¨è€…è³‡è¨Šç²å–æˆåŠŸ: ${userProfile.name}`);

                    // æ›´æ–°æœ€å¾Œä½¿ç”¨æ™‚é–“
                    await supabase
                        .from('login_sessions')
                        .update({ last_used: new Date().toISOString() })
                        .eq('auto_login_token', autoLoginToken);

                    // è¨­ç½®æœ¬åœ°ç‹€æ…‹ï¼ˆæ¨¡æ“¬ç™»å…¥ï¼‰
                    state.currentUser = userProfile;
                    state.local.dashboardFilters.permission = 'pending_for_me';
                    
                    if (userProfile.favorite_products && Array.isArray(userProfile.favorite_products)) {
                        state.local.favoriteProductIds = new Set(userProfile.favorite_products);
                    } else {
                        state.local.favoriteProductIds = new Set();
                    }

                    // å¥—ç”¨å€‹äººè¨­å®š
                    if (userProfile.theme_preference) {
                        applyTheme(userProfile.theme_preference);
                    }
                    if (userProfile.menu_layout) {
                        state.local.layoutScale = userProfile.menu_layout === 'compact' ? 'compact' : 'expanded';
                        localStorage.setItem('menuLayout', state.local.layoutScale);
                    }

                    console.log(`ğŸ‰ ${this.isGoogleSites ? '[Google Sites]' : ''} è‡ªå‹•ç™»å…¥æˆåŠŸ: ${userProfile.name}`);
                    this.isAutoLoggedIn = true; // è¨­ç½®è‡ªå‹•ç™»å…¥æ¨™è¨˜
                    return true;

                } catch (error) {
                    console.error('âŒ è‡ªå‹•ç™»å…¥æª¢æŸ¥å¤±æ•—:', error);
                    await superStorage.superClear(this.autoLoginKey);
                    return false;
                }
            }

            // æ¸…é™¤éæœŸçš„æœƒè©±
            async clearExpiredSession(token) {
                try {
                    await supabase
                        .from('login_sessions')
                        .delete()
                        .eq('auto_login_token', token);
                } catch (error) {
                    console.error('æ¸…é™¤éæœŸæœƒè©±å¤±æ•—:', error);
                }
            }

            // æ¸…é™¤ç™»å…¥æœƒè©±
            async clearLoginSession() {
                const autoLoginToken = await superStorage.superGet(this.autoLoginKey);
                
                // å¾è³‡æ–™åº«æ¸…é™¤æœƒè©±
                if (autoLoginToken) {
                    try {
                        await supabase
                            .from('login_sessions')
                            .delete()
                            .eq('auto_login_token', autoLoginToken);
                        console.log('è³‡æ–™åº«æœƒè©±å·²æ¸…é™¤');
                    } catch (error) {
                        console.error('æ¸…é™¤è³‡æ–™åº«æœƒè©±å¤±æ•—:', error);
                    }
                }

                // æ¸…é™¤æœ¬åœ°å­˜å„²
                try {
                    localStorage.removeItem(this.sessionKey);
                    await superStorage.superClear(this.autoLoginKey);
                    await superStorage.superClear(this.accountKey);
                    console.log(`${this.isGoogleSites ? '[Google Sites]' : ''} æœ¬åœ°æœƒè©±å·²æ¸…é™¤`);
                } catch (error) {
                    console.error('æ¸…é™¤æœ¬åœ°å­˜å„²å¤±æ•—:', error);
                }
                
                // æ¸…é™¤è‡ªå‹•ç™»å…¥æ¨™è¨˜
                this.isAutoLoggedIn = false;
            }

            // ç²å–ç•¶å‰æœƒè©±è³‡è¨Š
            getSessionInfo() {
                const sessionStr = localStorage.getItem(this.sessionKey);
                return sessionStr ? JSON.parse(sessionStr) : null;
            }
        }

        // å‰µå»ºå…¨åŸŸç™»å…¥æœƒè©±ç®¡ç†å™¨
        window.loginSessionManager = new LoginSessionManager();
    </script>

    <style>
        /* åŸºç¤è®Šæ•¸å®šç¾© */
        :root {
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --shadow-light: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-normal: 0 4px 6px rgba(0,0,0,0.1);
            --border-radius: 0.5rem;
        }

        /* æ•ˆèƒ½å„ªåŒ–çš„å‹•ç•« */
        .spinner-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            will-change: transform;
        }
        .spinner-dot { 
            width: 1.5rem; 
            height: 1.5rem; 
            background-color: #3b82f6; 
            border-radius: 50%; 
            margin: 0 0.5rem; 
            animation: bounce-delay 1.4s infinite ease-in-out both;
            will-change: transform;
        }
        .spinner-dot:nth-child(1) { animation-delay: -0.32s; }
        .spinner-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce-delay { 
            0%, 80%, 100% { transform: scale(0); } 
            40% { transform: scale(1.0); } 
        }
        
        .view { 
            display: none; 
            animation: fadeIn var(--transition-normal);
            will-change: opacity;
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        /* é€šçŸ¥ç³»çµ±å„ªåŒ– */
        #notification-container { 
            position: fixed; 
            top: 1rem; 
            right: 1rem; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 0.5rem;
            pointer-events: none;
        }
        
        .notification { 
            padding: 1rem; 
            border-radius: var(--border-radius); 
            color: white; 
            box-shadow: var(--shadow-normal); 
            animation: slideIn var(--transition-normal) ease-out, fadeOut 0.5s ease-in 2.5s forwards; 
            white-space: pre-wrap;
            pointer-events: auto;
            will-change: transform, opacity;
        }
        
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        
        @keyframes slideIn { 
            from { transform: translateX(100%); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }
        
        @keyframes fadeOut { 
            from { opacity: 1; } 
            to { opacity: 0; transform: scale(0.95); } 
        }
        
        /* äº’å‹•å…ƒç´ å„ªåŒ– */
        .tab-button.active { 
            border-color: #3b82f6; 
            color: #3b82f6;
            transition: all var(--transition-fast);
        }
        
        .sortable {
            transition: background-color var(--transition-fast);
            cursor: pointer;
        }
        
        .sortable:hover { 
            background-color: #f9fafb; 
        }
        
        .sort-icon { 
            opacity: 0.4; 
            display: inline-block; 
            margin-left: 4px;
            transition: opacity var(--transition-fast);
        }
        
        .sortable.active .sort-icon { 
            opacity: 1; 
            color: #3b82f6; 
        }

        /* Hover popover for dashboard request ID */
        .request-id-hover {
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: help;
        }
        .hover-popover {
            position: fixed;
            z-index: 50;
            width: 320px;
            max-width: calc(100vw - 24px);
            background: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            border-radius: 0.5rem;
            padding: 12px;
            display: none;
        }
        .hover-popover.show { display: block; }
        .hover-popover .title { font-weight: 700; font-size: 14px; color: #111827; }
        .hover-popover .kv { display: grid; grid-template-columns: 90px 1fr; gap: 6px 8px; margin-top: 8px; font-size: 12px; color: #374151; }
        .hover-popover .actions { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .hover-popover .btn { padding: 4px 8px; border-radius: 6px; font-size: 12px; border: 1px solid #e5e7eb; background: #f9fafb; color: #111827; }
        .hover-popover .btn:hover { background: #f3f4f6; }
    .hover-popover .close-btn { position: absolute; top: 8px; right: 8px; width: 22px; height: 22px; line-height: 22px; text-align: center; border-radius: 9999px; border: 1px solid #e5e7eb; background: #ffffff; color: #6b7280; }
    .hover-popover .close-btn:hover { background: #f3f4f6; color: #111827; }

        /* ä¸»é¡Œæ¨£å¼å„ªåŒ– - ä½¿ç”¨ CSS è‡ªè¨‚å±¬æ€§æå‡æ•ˆèƒ½ */
    
        /* Apple Theme Styles */
        .theme-apple {
            --bg-color: #f5f5f7;
            --card-bg-color: #ffffff;
            --text-color: #1d1d1f;
            --subtle-text-color: #6e6e73;
            --border-color: #d2d2d7;
            --accent-color: #007aff;
            --accent-hover-color: #0071e3;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            background-color: var(--bg-color) !important;
            font-family: var(--font-family) !important;
            color: var(--text-color) !important;
        }
        .theme-apple body, .theme-apple .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-apple .bg-white, .theme-apple .bg-gray-100 { background-color: var(--card-bg-color) !important; }
        .theme-apple .shadow-sm, .theme-apple .shadow-md, .theme-apple .shadow-lg, .theme-apple .shadow-xl {
             box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.04), 0 1px 2px -1px rgba(0, 0, 0, 0.04) !important;
             border: 1px solid var(--border-color);
        }
        .theme-apple .rounded-lg { border-radius: 12px !important; }
        .theme-apple .rounded-md { border-radius: 8px !important; }
        .theme-apple .border, .theme-apple .border-gray-300, .theme-apple .border-gray-200, .theme-apple .divide-y > :not([hidden]) ~ :not([hidden]), .theme-apple .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-apple .text-gray-900, .theme-apple .text-gray-800, .theme-apple .text-gray-700 { color: var(--text-color) !important; }
        .theme-apple .text-gray-600, .theme-apple .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-apple .text-blue-600 { color: var(--accent-color) !important; }
        .theme-apple .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-apple .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-apple input, .theme-apple select, .theme-apple textarea {
            background-color: #f0f0f0 !important;
            border-radius: 8px !important;
            border: 1px solid var(--border-color) !important;
        }
        .theme-apple input:focus, .theme-apple select:focus, .theme-apple textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2) !important;
            outline: none !important;
        }
        .theme-apple .tab-button.active {
            border-color: var(--accent-color) !important;
            color: var(--accent-color) !important;
        }

        /* Sci-Fi Theme Styles */
        .theme-scifi {
            --bg-color: #0a0f1a;
            --card-bg-color: #1a202c;
            --text-color: #00f7ff;
            --subtle-text-color: #8a9ecb;
            --border-color: #2d3748;
            --accent-color: #00f7ff;
            --accent-hover-color: #00d1db;
            --font-family: 'Orbitron', sans-serif;

            background-color: var(--bg-color) !important;
            font-family: var(--font-family) !important;
            color: var(--text-color) !important;
        }
        .theme-scifi body, .theme-scifi .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-scifi .bg-white, .theme-scifi .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-scifi .shadow-sm, .theme-scifi .shadow-md, .theme-scifi .shadow-lg, .theme-scifi .shadow-xl {
             box-shadow: 0 0 15px rgba(0, 247, 255, 0.1), 0 0 5px rgba(0, 247, 255, 0.05) !important;
             border: 1px solid var(--border-color);
        }
        .theme-scifi .rounded-lg, .theme-scifi .rounded-md { border-radius: 4px !important; }
        .theme-scifi .border, .theme-scifi .border-gray-300, .theme-scifi .border-gray-200, .theme-scifi .divide-y > :not([hidden]) ~ :not([hidden]), .theme-scifi .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-scifi .text-gray-900, .theme-scifi .text-gray-800, .theme-scifi .text-gray-700 { color: var(--text-color) !important; }
        .theme-scifi .text-gray-600, .theme-scifi .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-scifi .text-blue-600 { color: var(--accent-color) !important; }
        .theme-scifi .bg-blue-600 { background-color: var(--accent-color) !important; color: #0a0f1a !important; }
        .theme-scifi .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-scifi input, .theme-scifi select, .theme-scifi textarea {
            background-color: #0a0f1a !important;
            border-radius: 4px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-scifi input:focus, .theme-scifi select:focus, .theme-scifi textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(0, 247, 255, 0.3) !important;
            outline: none !important;
        }
        .theme-scifi .tab-button.active {
            border-color: var(--accent-color) !important;
            color: var(--accent-color) !important;
        }

        /* Ghibli Theme Styles */
        .theme-ghibli {
            --bg-color: #fbf1c7;
            --card-bg-color: #fdf6e3;
            --text-color: #3c3836;
            --subtle-text-color: #7c6f64;
            --border-color: #d5c4a1;
            --accent-color: #458588;
            --accent-hover-color: #076678;
            --font-family: 'Noto Sans TC', sans-serif;

            background-color: var(--bg-color) !important;
            font-family: var(--font-family) !important;
            color: var(--text-color) !important;
        }
        .theme-ghibli body, .theme-ghibli .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-ghibli .bg-white, .theme-ghibli .bg-gray-100 { background-color: var(--card-bg-color) !important; }
        .theme-ghibli .shadow-sm, .theme-ghibli .shadow-md, .theme-ghibli .shadow-lg, .theme-ghibli .shadow-xl {
             box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05) !important;
             border: 1px solid var(--border-color);
        }
        .theme-ghibli .rounded-lg { border-radius: 10px !important; }
        .theme-ghibli .rounded-md { border-radius: 6px !important; }
        .theme-ghibli .border, .theme-ghibli .border-gray-300, .theme-ghibli .border-gray-200, .theme-ghibli .divide-y > :not([hidden]) ~ :not([hidden]), .theme-ghibli .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-ghibli .text-gray-900, .theme-ghibli .text-gray-800, .theme-ghibli .text-gray-700 { color: var(--text-color) !important; }
        .theme-ghibli .text-gray-600, .theme-ghibli .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-ghibli .text-blue-600 { color: var(--accent-color) !important; }
        .theme-ghibli .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-ghibli .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-ghibli input, .theme-ghibli select, .theme-ghibli textarea {
            background-color: #f9f5d7 !important;
            border-radius: 6px !important;
            border: 1px solid var(--border-color) !important;
        }
        .theme-ghibli input:focus, .theme-ghibli select:focus, .theme-ghibli textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(69, 133, 136, 0.2) !important;
            outline: none !important;
        }
        .theme-ghibli .tab-button.active {
            border-color: var(--accent-color) !important;
            color: var(--accent-color) !important;
        }

        /* Abstract Art Theme Styles */
        .theme-abstract {
            --bg-color: #1a1a1a;
            --card-bg-color: #2a2a2a;
            --text-color: #f0f0f0;
            --subtle-text-color: #aaaaaa;
            --border-color: #444444;
            --accent-color: #ff00ff;
            --accent-hover-color: #cc00cc;
            --font-family: 'Montserrat', sans-serif;

            background-color: var(--bg-color) !important;
            font-family: var(--font-family) !important;
            color: var(--text-color) !important;
        }
        .theme-abstract body, .theme-abstract .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-abstract .bg-white, .theme-abstract .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-abstract .shadow-sm, .theme-abstract .shadow-md, .theme-abstract .shadow-lg, .theme-abstract .shadow-xl {
             box-shadow: none !important;
             border: 2px solid var(--border-color);
        }
        .theme-abstract .rounded-lg, .theme-abstract .rounded-md { border-radius: 0 !important; }
        .theme-abstract .border, .theme-abstract .border-gray-300, .theme-abstract .border-gray-200, .theme-abstract .divide-y > :not([hidden]) ~ :not([hidden]), .theme-abstract .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-abstract .text-gray-900, .theme-abstract .text-gray-800, .theme-abstract .text-gray-700 { color: var(--text-color) !important; }
        .theme-abstract .text-gray-600, .theme-abstract .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-abstract .text-blue-600 { color: var(--accent-color) !important; }
        .theme-abstract .bg-blue-600 { background-color: var(--accent-color) !important; color: #1a1a1a !important; }
        .theme-abstract .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-abstract input, .theme-abstract select, .theme-abstract textarea {
            background-color: #1a1a1a !important;
            border-radius: 0 !important;
            border: 2px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-abstract input:focus, .theme-abstract select:focus, .theme-abstract textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: none !important;
            outline: none !important;
        }
        .theme-abstract .tab-button.active {
            border-color: var(--accent-color) !important;
            color: var(--accent-color) !important;
            border-bottom-width: 4px !important;
        }

        /* Eldercare Soft Theme */
        .theme-care-soft {
            --bg-color: #fff7ed; /* orange-50 */
            --card-bg-color: #fffaf0; /* warm cream */
            --text-color: #3f2d20; /* warm brown */
            --subtle-text-color: #a16207; /* amber-700 */
            --border-color: #fed7aa; /* orange-200 */
            --accent-color: #f59e0b; /* amber-500 */
            --accent-hover-color: #d97706; /* amber-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-care-soft body, .theme-care-soft .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-care-soft .bg-white, .theme-care-soft .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-care-soft .shadow-sm, .theme-care-soft .shadow-md, .theme-care-soft .shadow-lg, .theme-care-soft .shadow-xl {
             box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05) !important;
             border: 1px solid var(--border-color);
        }
        .theme-care-soft .rounded-lg { border-radius: 12px !important; }
        .theme-care-soft .rounded-md { border-radius: 8px !important; }
        .theme-care-soft .border, .theme-care-soft .border-gray-300, .theme-care-soft .border-gray-200, .theme-care-soft .divide-y > :not([hidden]) ~ :not([hidden]), .theme-care-soft .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-care-soft .text-gray-900, .theme-care-soft .text-gray-800, .theme-care-soft .text-gray-700 { color: var(--text-color) !important; }
        .theme-care-soft .text-gray-600, .theme-care-soft .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-care-soft .text-blue-600 { color: var(--accent-color) !important; }
        .theme-care-soft .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-care-soft .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-care-soft input, .theme-care-soft select, .theme-care-soft textarea {
            background-color: #fffef9 !important;
            border-radius: 10px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-care-soft input:focus, .theme-care-soft select:focus, .theme-care-soft textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2) !important;
            outline: none !important;
        }
        .theme-care-soft .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Eldercare Fresh Theme */
        .theme-care-fresh {
            --bg-color: #ecfdf5; /* emerald-50 */
            --card-bg-color: #ffffff;
            --text-color: #064e3b; /* emerald-900 */
            --subtle-text-color: #10b981; /* emerald-500 */
            --border-color: #d1fae5; /* emerald-200 */
            --accent-color: #10b981; /* emerald-500 */
            --accent-hover-color: #059669; /* emerald-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-care-fresh body, .theme-care-fresh .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-care-fresh .bg-white, .theme-care-fresh .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-care-fresh .shadow-sm, .theme-care-fresh .shadow-md, .theme-care-fresh .shadow-lg, .theme-care-fresh .shadow-xl { box-shadow: 0 2px 4px rgba(0,0,0,0.04) !important; border: 1px solid var(--border-color); }
        .theme-care-fresh .rounded-lg { border-radius: 12px !important; }
        .theme-care-fresh .rounded-md { border-radius: 8px !important; }
        .theme-care-fresh .border, .theme-care-fresh .border-gray-300, .theme-care-fresh .border-gray-200, .theme-care-fresh .divide-y > :not([hidden]) ~ :not([hidden]), .theme-care-fresh .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-care-fresh .text-gray-900, .theme-care-fresh .text-gray-800, .theme-care-fresh .text-gray-700 { color: var(--text-color) !important; }
        .theme-care-fresh .text-gray-600, .theme-care-fresh .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-care-fresh .text-blue-600 { color: var(--accent-color) !important; }
        .theme-care-fresh .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-care-fresh .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-care-fresh input, .theme-care-fresh select, .theme-care-fresh textarea { background-color: #f7fff9 !important; border-radius: 10px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-care-fresh input:focus, .theme-care-fresh select:focus, .theme-care-fresh textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.25) !important; outline: none !important; }
        .theme-care-fresh .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Medical Clean Theme */
        .theme-med-clean {
            --bg-color: #f8fafc; /* slate-50 */
            --card-bg-color: #ffffff;
            --text-color: #0f172a; /* slate-900 */
            --subtle-text-color: #64748b; /* slate-500 */
            --border-color: #e2e8f0; /* slate-200 */
            --accent-color: #3b82f6; /* blue-500 */
            --accent-hover-color: #2563eb; /* blue-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-med-clean body, .theme-med-clean .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-med-clean .bg-white, .theme-med-clean .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-med-clean .shadow-sm, .theme-med-clean .shadow-md, .theme-med-clean .shadow-lg, .theme-med-clean .shadow-xl { box-shadow: 0 1px 3px rgba(0,0,0,0.06) !important; border: 1px solid var(--border-color); }
        .theme-med-clean .rounded-lg, .theme-med-clean .rounded-md { border-radius: 8px !important; }
        .theme-med-clean .border, .theme-med-clean .border-gray-300, .theme-med-clean .border-gray-200, .theme-med-clean .divide-y > :not([hidden]) ~ :not([hidden]), .theme-med-clean .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-med-clean .text-gray-900, .theme-med-clean .text-gray-800, .theme-med-clean .text-gray-700 { color: var(--text-color) !important; }
        .theme-med-clean .text-gray-600, .theme-med-clean .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-med-clean .text-blue-600 { color: var(--accent-color) !important; }
        .theme-med-clean .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-med-clean .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-med-clean input, .theme-med-clean select, .theme-med-clean textarea { background-color: #ffffff !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-med-clean input:focus, .theme-med-clean select:focus, .theme-med-clean textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important; outline: none !important; }
        .theme-med-clean .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Medical Trust Theme */
        .theme-med-trust {
            --bg-color: #eff6ff; /* blue-50 */
            --card-bg-color: #ffffff;
            --text-color: #0c4a6e; /* sky-900 */
            --subtle-text-color: #60a5fa; /* blue-400 */
            --border-color: #bfdbfe; /* blue-200 */
            --accent-color: #0ea5e9; /* sky-500 */
            --accent-hover-color: #0284c7; /* sky-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-med-trust body, .theme-med-trust .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-med-trust .bg-white, .theme-med-trust .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-med-trust .shadow-sm, .theme-med-trust .shadow-md, .theme-med-trust .shadow-lg, .theme-med-trust .shadow-xl { box-shadow: 0 1px 3px rgba(2,132,199,0.08) !important; border: 1px solid var(--border-color); }
        .theme-med-trust .rounded-lg, .theme-med-trust .rounded-md { border-radius: 8px !important; }
        .theme-med-trust .border, .theme-med-trust .border-gray-300, .theme-med-trust .border-gray-200, .theme-med-trust .divide-y > :not([hidden]) ~ :not([hidden]), .theme-med-trust .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-med-trust .text-gray-900, .theme-med-trust .text-gray-800, .theme-med-trust .text-gray-700 { color: var(--text-color) !important; }
        .theme-med-trust .text-gray-600, .theme-med-trust .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-med-trust .text-blue-600 { color: var(--accent-color) !important; }
        .theme-med-trust .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-med-trust .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-med-trust input, .theme-med-trust select, .theme-med-trust textarea { background-color: #ffffff !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-med-trust input:focus, .theme-med-trust select:focus, .theme-med-trust textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.25) !important; outline: none !important; }
        .theme-med-trust .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Hotel Luxury Theme */
        .theme-hotel-lux {
            --bg-color: #0f0f13; /* near black */
            --card-bg-color: #1a1a22; /* deep charcoal */
            --text-color: #f5f5f5; /* light */
            --subtle-text-color: #cbd5e1; /* slate-300 */
            --border-color: #2a2a33; /* dark border */
            --accent-color: #d4af37; /* gold */
            --accent-hover-color: #b38e1d; /* darker gold */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-hotel-lux body, .theme-hotel-lux .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-hotel-lux .bg-white, .theme-hotel-lux .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-hotel-lux .shadow-sm, .theme-hotel-lux .shadow-md, .theme-hotel-lux .shadow-lg, .theme-hotel-lux .shadow-xl { box-shadow: 0 6px 16px rgba(0,0,0,0.35) !important; border: 1px solid var(--border-color); }
        .theme-hotel-lux .rounded-lg, .theme-hotel-lux .rounded-md { border-radius: 10px !important; }
        .theme-hotel-lux .border, .theme-hotel-lux .border-gray-300, .theme-hotel-lux .border-gray-200, .theme-hotel-lux .divide-y > :not([hidden]) ~ :not([hidden]), .theme-hotel-lux .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-hotel-lux .text-gray-900, .theme-hotel-lux .text-gray-800, .theme-hotel-lux .text-gray-700 { color: var(--text-color) !important; }
        .theme-hotel-lux .text-gray-600, .theme-hotel-lux .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-hotel-lux .text-blue-600 { color: var(--accent-color) !important; }
        .theme-hotel-lux .bg-blue-600 { background-color: var(--accent-color) !important; color: #111111 !important; }
        .theme-hotel-lux .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-hotel-lux input, .theme-hotel-lux select, .theme-hotel-lux textarea { background-color: #111216 !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-hotel-lux input:focus, .theme-hotel-lux select:focus, .theme-hotel-lux textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.3) !important; outline: none !important; }
        .theme-hotel-lux .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Hotel Resort Theme */
        .theme-hotel-resort {
            --bg-color: #fef3c7; /* amber-100 sand */
            --card-bg-color: #ffffff;
            --text-color: #3b2210; /* warm brown */
            --subtle-text-color: #8b5e34; /* sand brown */
            --border-color: #fde68a; /* amber-200 */
            --accent-color: #14b8a6; /* teal-500 */
            --accent-hover-color: #0d9488; /* teal-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-hotel-resort body, .theme-hotel-resort .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-hotel-resort .bg-white, .theme-hotel-resort .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-hotel-resort .shadow-sm, .theme-hotel-resort .shadow-md, .theme-hotel-resort .shadow-lg, .theme-hotel-resort .shadow-xl { box-shadow: 0 2px 6px rgba(13,148,136,0.12) !important; border: 1px solid var(--border-color); }
        .theme-hotel-resort .rounded-lg { border-radius: 12px !important; }
        .theme-hotel-resort .rounded-md { border-radius: 8px !important; }
        .theme-hotel-resort .border, .theme-hotel-resort .border-gray-300, .theme-hotel-resort .border-gray-200, .theme-hotel-resort .divide-y > :not([hidden]) ~ :not([hidden]), .theme-hotel-resort .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-hotel-resort .text-gray-900, .theme-hotel-resort .text-gray-800, .theme-hotel-resort .text-gray-700 { color: var(--text-color) !important; }
        .theme-hotel-resort .text-gray-600, .theme-hotel-resort .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-hotel-resort .text-blue-600 { color: var(--accent-color) !important; }
        .theme-hotel-resort .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-hotel-resort .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-hotel-resort input, .theme-hotel-resort select, .theme-hotel-resort textarea { background-color: #ffffff !important; border-radius: 10px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-hotel-resort input:focus, .theme-hotel-resort select:focus, .theme-hotel-resort textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.25) !important; outline: none !important; }
        .theme-hotel-resort .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Forest Theme Styles */
        .theme-forest {
            --bg-color: #0b2e13; /* deep forest green */
            --card-bg-color: #123524; /* darker green */
            --text-color: #e8f5e9; /* minty light */
            --subtle-text-color: #a7d7c5; /* soft teal */
            --border-color: #1f4d2e; /* green border */
            --accent-color: #34d399; /* emerald-400 */
            --accent-hover-color: #10b981; /* emerald-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-forest body, .theme-forest .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-forest .bg-white, .theme-forest .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-forest .shadow-sm, .theme-forest .shadow-md, .theme-forest .shadow-lg, .theme-forest .shadow-xl {
             box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.15) !important;
             border: 1px solid var(--border-color);
        }
        .theme-forest .rounded-lg { border-radius: 12px !important; }
        .theme-forest .rounded-md { border-radius: 8px !important; }
        .theme-forest .border, .theme-forest .border-gray-300, .theme-forest .border-gray-200, .theme-forest .divide-y > :not([hidden]) ~ :not([hidden]), .theme-forest .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-forest .text-gray-900, .theme-forest .text-gray-800, .theme-forest .text-gray-700 { color: var(--text-color) !important; }
        .theme-forest .text-gray-600, .theme-forest .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-forest .text-blue-600 { color: var(--accent-color) !important; }
        .theme-forest .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-forest .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-forest input, .theme-forest select, .theme-forest textarea {
            background-color: var(--card-bg-color) !important;
            border-radius: 8px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-forest input:focus, .theme-forest select:focus, .theme-forest textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.25) !important;
            outline: none !important;
        }
        .theme-forest .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Ocean Theme Styles */
        .theme-ocean {
            --bg-color: #0b1220; /* deep navy */
            --card-bg-color: #0e2239; /* ocean deep */
            --text-color: #e0f2fe; /* sky-100 */
            --subtle-text-color: #93c5fd; /* blue-300 */
            --border-color: #1e3a8a; /* indigo-800 */
            --accent-color: #38bdf8; /* sky-400 */
            --accent-hover-color: #0ea5e9; /* sky-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-ocean body, .theme-ocean .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-ocean .bg-white, .theme-ocean .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-ocean .shadow-sm, .theme-ocean .shadow-md, .theme-ocean .shadow-lg, .theme-ocean .shadow-xl {
             box-shadow: 0 0 20px rgba(14, 165, 233, 0.08), 0 0 6px rgba(56, 189, 248, 0.05) !important;
             border: 1px solid var(--border-color);
        }
        .theme-ocean .rounded-lg, .theme-ocean .rounded-md { border-radius: 6px !important; }
        .theme-ocean .border, .theme-ocean .border-gray-300, .theme-ocean .border-gray-200, .theme-ocean .divide-y > :not([hidden]) ~ :not([hidden]), .theme-ocean .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-ocean .text-gray-900, .theme-ocean .text-gray-800, .theme-ocean .text-gray-700 { color: var(--text-color) !important; }
        .theme-ocean .text-gray-600, .theme-ocean .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-ocean .text-blue-600 { color: var(--accent-color) !important; }
        .theme-ocean .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-ocean .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-ocean input, .theme-ocean select, .theme-ocean textarea {
            background-color: #0b1220 !important;
            border-radius: 6px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-ocean input:focus, .theme-ocean select:focus, .theme-ocean textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3) !important;
            outline: none !important;
        }
        .theme-ocean .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Sunset Theme Styles */
        .theme-sunset {
            --bg-color: #2b0a1a; /* dark wine */
            --card-bg-color: #3a0e22; /* deeper rose */
            --text-color: #ffe4e6; /* rose-100 */
            --subtle-text-color: #fecdd3; /* pink-200 */
            --border-color: #7f1d1d; /* red-900 */
            --accent-color: #fb7185; /* rose-400 */
            --accent-hover-color: #f43f5e; /* rose-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-sunset body, .theme-sunset .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-sunset .bg-white, .theme-sunset .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-sunset .shadow-sm, .theme-sunset .shadow-md, .theme-sunset .shadow-lg, .theme-sunset .shadow-xl {
             box-shadow: 0 2px 6px 0 rgba(244, 63, 94, 0.15) !important;
             border: 1px solid var(--border-color);
        }
        .theme-sunset .rounded-lg { border-radius: 10px !important; }
        .theme-sunset .rounded-md { border-radius: 6px !important; }
        .theme-sunset .border, .theme-sunset .border-gray-300, .theme-sunset .border-gray-200, .theme-sunset .divide-y > :not([hidden]) ~ :not([hidden]), .theme-sunset .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-sunset .text-gray-900, .theme-sunset .text-gray-800, .theme-sunset .text-gray-700 { color: var(--text-color) !important; }
        .theme-sunset .text-gray-600, .theme-sunset .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-sunset .text-blue-600 { color: var(--accent-color) !important; }
        .theme-sunset .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-sunset .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-sunset input, .theme-sunset select, .theme-sunset textarea {
            background-color: var(--card-bg-color) !important;
            border-radius: 6px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-sunset input:focus, .theme-sunset select:focus, .theme-sunset textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(251, 113, 133, 0.25) !important;
            outline: none !important;
        }
        .theme-sunset .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Midnight Theme Styles */
        .theme-midnight {
            --bg-color: #0a0a0f; /* near black */
            --card-bg-color: #14141f; /* dark indigo */
            --text-color: #e5e7eb; /* gray-200 */
            --subtle-text-color: #9ca3af; /* gray-400 */
            --border-color: #1f2937; /* gray-800 */
            --accent-color: #8b5cf6; /* violet-500 */
            --accent-hover-color: #7c3aed; /* violet-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-midnight body, .theme-midnight .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-midnight .bg-white, .theme-midnight .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-midnight .shadow-sm, .theme-midnight .shadow-md, .theme-midnight .shadow-lg, .theme-midnight .shadow-xl {
             box-shadow: 0 1px 3px rgba(0,0,0,0.4) !important;
             border: 1px solid var(--border-color);
        }
        .theme-midnight .rounded-lg, .theme-midnight .rounded-md { border-radius: 6px !important; }
        .theme-midnight .border, .theme-midnight .border-gray-300, .theme-midnight .border-gray-200, .theme-midnight .divide-y > :not([hidden]) ~ :not([hidden]), .theme-midnight .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-midnight .text-gray-900, .theme-midnight .text-gray-800, .theme-midnight .text-gray-700 { color: var(--text-color) !important; }
        .theme-midnight .text-gray-600, .theme-midnight .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-midnight .text-blue-600 { color: var(--accent-color) !important; }
        .theme-midnight .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-midnight .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-midnight input, .theme-midnight select, .theme-midnight textarea {
            background-color: var(--card-bg-color) !important;
            border-radius: 6px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-midnight input:focus, .theme-midnight select:focus, .theme-midnight textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25) !important;
            outline: none !important;
        }
        .theme-midnight .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Sakura Theme Styles */
        .theme-sakura {
            --bg-color: #fff1f2; /* rose-50 */
            --card-bg-color: #ffe4e6; /* rose-100 */
            --text-color: #3f1d2b; /* plum */
            --subtle-text-color: #9f1239; /* rose-800 */
            --border-color: #fecdd3; /* pink-200 */
            --accent-color: #f472b6; /* pink-400 */
            --accent-hover-color: #ec4899; /* pink-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-sakura body, .theme-sakura .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-sakura .bg-white, .theme-sakura .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-sakura .shadow-sm, .theme-sakura .shadow-md, .theme-sakura .shadow-lg, .theme-sakura .shadow-xl {
             box-shadow: 0 2px 4px 0 rgba(244, 114, 182, 0.15) !important;
             border: 1px solid var(--border-color);
        }
        .theme-sakura .rounded-lg { border-radius: 10px !important; }
        .theme-sakura .rounded-md { border-radius: 6px !important; }
        .theme-sakura .border, .theme-sakura .border-gray-300, .theme-sakura .border-gray-200, .theme-sakura .divide-y > :not([hidden]) ~ :not([hidden]), .theme-sakura .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--border-color) !important;
        }
        .theme-sakura .text-gray-900, .theme-sakura .text-gray-800, .theme-sakura .text-gray-700 { color: var(--text-color) !important; }
        .theme-sakura .text-gray-600, .theme-sakura .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-sakura .text-blue-600 { color: var(--accent-color) !important; }
        .theme-sakura .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-sakura .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-sakura input, .theme-sakura select, .theme-sakura textarea {
            background-color: #fff7f8 !important;
            border-radius: 8px !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        .theme-sakura input:focus, .theme-sakura select:focus, .theme-sakura textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 2px rgba(244, 114, 182, 0.25) !important;
            outline: none !important;
        }
        .theme-sakura .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Nord Theme */
        .theme-nord {
            --bg-color: #2e3440; /* nord0 */
            --card-bg-color: #3b4252; /* nord1 */
            --text-color: #eceff4; /* nord6 */
            --subtle-text-color: #a3be8c; /* nord14 */
            --border-color: #434c5e; /* nord2 */
            --accent-color: #88c0d0; /* nord8 */
            --accent-hover-color: #81a1c1; /* nord9 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-nord body, .theme-nord .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-nord .bg-white, .theme-nord .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-nord .shadow-sm, .theme-nord .shadow-md, .theme-nord .shadow-lg, .theme-nord .shadow-xl { box-shadow: 0 2px 6px rgba(129,161,193,0.15) !important; border: 1px solid var(--border-color); }
        .theme-nord .rounded-lg, .theme-nord .rounded-md { border-radius: 8px !important; }
        .theme-nord .border, .theme-nord .border-gray-300, .theme-nord .border-gray-200, .theme-nord .divide-y > :not([hidden]) ~ :not([hidden]), .theme-nord .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-nord .text-gray-900, .theme-nord .text-gray-800, .theme-nord .text-gray-700 { color: var(--text-color) !important; }
        .theme-nord .text-gray-600, .theme-nord .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-nord .text-blue-600 { color: var(--accent-color) !important; }
        .theme-nord .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-nord .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-nord input, .theme-nord select, .theme-nord textarea { background-color: var(--card-bg-color) !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-nord input:focus, .theme-nord select:focus, .theme-nord textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(136, 192, 208, 0.25) !important; outline: none !important; }
        .theme-nord .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Latte Theme */
        .theme-latte {
            --bg-color: #faf3e0; /* warm beige */
            --card-bg-color: #fffaf0; /* ivory */
            --text-color: #3f2e1e; /* coffee */
            --subtle-text-color: #b08968; /* caramel */
            --border-color: #f1e3c6; /* light beige */
            --accent-color: #d97706; /* amber-600 */
            --accent-hover-color: #b45309; /* amber-700 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-latte body, .theme-latte .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-latte .bg-white, .theme-latte .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-latte .shadow-sm, .theme-latte .shadow-md, .theme-latte .shadow-lg, .theme-latte .shadow-xl { box-shadow: 0 2px 4px rgba(217,119,6,0.08) !important; border: 1px solid var(--border-color); }
        .theme-latte .rounded-lg, .theme-latte .rounded-md { border-radius: 10px !important; }
        .theme-latte .border, .theme-latte .border-gray-300, .theme-latte .border-gray-200, .theme-latte .divide-y > :not([hidden]) ~ :not([hidden]), .theme-latte .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-latte .text-gray-900, .theme-latte .text-gray-800, .theme-latte .text-gray-700 { color: var(--text-color) !important; }
        .theme-latte .text-gray-600, .theme-latte .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-latte .text-blue-600 { color: var(--accent-color) !important; }
        .theme-latte .bg-blue-600 { background-color: var(--accent-color) !important; color: #fff !important; }
        .theme-latte .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-latte input, .theme-latte select, .theme-latte textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-latte input:focus, .theme-latte select:focus, .theme-latte textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.2) !important; outline: none !important; }
        .theme-latte .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Mint Theme */
        .theme-mint {
            --bg-color: #f0fdf4; /* green-50 */
            --card-bg-color: #ffffff;
            --text-color: #064e3b; /* emerald-900 */
            --subtle-text-color: #10b981; /* emerald-500 */
            --border-color: #bbf7d0; /* green-200 */
            --accent-color: #34d399; /* emerald-400 */
            --accent-hover-color: #10b981; /* emerald-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-mint body, .theme-mint .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-mint .bg-white, .theme-mint .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-mint .shadow-sm, .theme-mint .shadow-md, .theme-mint .shadow-lg, .theme-mint .shadow-xl { box-shadow: 0 1px 3px rgba(16,185,129,0.12) !important; border: 1px solid var(--border-color); }
        .theme-mint .rounded-lg, .theme-mint .rounded-md { border-radius: 10px !important; }
        .theme-mint .border, .theme-mint .border-gray-300, .theme-mint .border-gray-200, .theme-mint .divide-y > :not([hidden]) ~ :not([hidden]), .theme-mint .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-mint .text-gray-900, .theme-mint .text-gray-800, .theme-mint .text-gray-700 { color: var(--text-color) 
            !important; }
        .theme-mint .text-gray-600, .theme-mint .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-mint .text-blue-600 { color: var(--accent-color) !important; }
        .theme-mint .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-mint .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-mint input, .theme-mint select, .theme-mint textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-mint input:focus, .theme-mint select:focus, .theme-mint textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.25) !important; outline: none !important; }
        .theme-mint .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Solar Theme */
        .theme-solar {
            --bg-color: #fffbea; /* warm light */
            --card-bg-color: #fffef3; /* near white */
            --text-color: #7c2d12; /* amber-900 */
            --subtle-text-color: #f59e0b; /* amber-500 */
            --border-color: #fde68a; /* amber-200 */
            --accent-color: #fb923c; /* orange-400 */
            --accent-hover-color: #f97316; /* orange-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-solar body, .theme-solar .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-solar .bg-white, .theme-solar .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-solar .shadow-sm, .theme-solar .shadow-md, .theme-solar .shadow-lg, .theme-solar .shadow-xl { box-shadow: 0 2px 4px rgba(249,115,22,0.12) !important; border: 1px solid var(--border-color); }
        .theme-solar .rounded-lg, .theme-solar .rounded-md { border-radius: 8px !important; }
        .theme-solar .border, .theme-solar .border-gray-300, .theme-solar .border-gray-200, .theme-solar .divide-y > :not([hidden]) ~ :not([hidden]), .theme-solar .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-solar .text-gray-900, .theme-solar .text-gray-800, .theme-solar .text-gray-700 { color: var(--text-color) !important; }
        .theme-solar .text-gray-600, .theme-solar .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-solar .text-blue-600 { color: var(--accent-color) !important; }
        .theme-solar .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-solar .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-solar input, .theme-solar select, .theme-solar textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-solar input:focus, .theme-solar select:focus, .theme-solar textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(251, 146, 60, 0.25) !important; outline: none !important; }
        .theme-solar .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Slate Theme */
        .theme-slate {
            --bg-color: #111827; /* gray-900 */
            --card-bg-color: #1f2937; /* gray-800 */
            --text-color: #e5e7eb; /* gray-200 */
            --subtle-text-color: #9ca3af; /* gray-400 */
            --border-color: #374151; /* gray-700 */
            --accent-color: #60a5fa; /* blue-400 */
            --accent-hover-color: #3b82f6; /* blue-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-slate body, .theme-slate .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-slate .bg-white, .theme-slate .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-slate .shadow-sm, .theme-slate .shadow-md, .theme-slate .shadow-lg, .theme-slate .shadow-xl { box-shadow: 0 1px 3px rgba(0,0,0,0.35) !important; border: 1px solid var(--border-color); }
        .theme-slate .rounded-lg, .theme-slate .rounded-md { border-radius: 6px !important; }
        .theme-slate .border, .theme-slate .border-gray-300, .theme-slate .border-gray-200, .theme-slate .divide-y > :not([hidden]) ~ :not([hidden]), .theme-slate .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-slate .text-gray-900, .theme-slate .text-gray-800, .theme-slate .text-gray-700 { color: var(--text-color) !important; }
        .theme-slate .text-gray-600, .theme-slate .text-gray-500 { color: var(--subtle-text-color) !important; }
        .theme-slate .text-blue-600 { color: var(--accent-color) !important; }
        .theme-slate .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-slate .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-slate input, .theme-slate select, .theme-slate textarea { background-color: var(--card-bg-color) !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-slate input:focus, .theme-slate select:focus, .theme-slate textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.25) !important; outline: none !important; }
        .theme-slate .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Metro Theme */
        .theme-metro {
            --bg-color: #f3f4f6; /* gray-100 */
            --card-bg-color: #ffffff;
            --text-color: #111827; /* gray-900 */
            --subtle-text-color: #6b7280; /* gray-500 */
            --border-color: #e5e7eb; /* gray-200 */
            --accent-color: #2563eb; /* blue-600 */
            --accent-hover-color: #1d4ed8; /* blue-700 */
            --font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            font-family: var(--font-family) !important;
        }
        .theme-metro body, .theme-metro .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-metro .bg-white, .theme-metro .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-metro .shadow-sm, .theme-metro .shadow-md, .theme-metro .shadow-lg, .theme-metro .shadow-xl { box-shadow: 0 1px 2px rgba(0,0,0,0.06) !important; border: 1px solid var(--border-color); }
        .theme-metro .rounded-lg, .theme-metro .rounded-md { border-radius: 4px !important; }
        .theme-metro .border, .theme-metro .divide-y > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
        .theme-metro .text-blue-600 { color: var(--accent-color) !important; }
        .theme-metro .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-metro .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-metro input, .theme-metro select, .theme-metro textarea { background-color: #f9fafb !important; border-radius: 4px !important; border: 1px solid var(--border-color) !important; }
        .theme-metro input:focus, .theme-metro select:focus, .theme-metro textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2) !important; outline: none !important; }
        .theme-metro .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Pastel Theme */
        .theme-pastel {
            --bg-color: #faf5ff; /* violet-50 */
            --card-bg-color: #ffffff;
            --text-color: #292524; /* stone-800 */
            --subtle-text-color: #6d6875; /* pastel gray */
            --border-color: #e9d5ff; /* violet-200 */
            --accent-color: #a78bfa; /* violet-400 */
            --accent-hover-color: #8b5cf6; /* violet-500 */
            --font-family: 'Noto Sans TC', sans-serif;

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            font-family: var(--font-family) !important;
        }
        .theme-pastel body, .theme-pastel .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-pastel .bg-white, .theme-pastel .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-pastel .shadow-sm, .theme-pastel .shadow-md, .theme-pastel .shadow-lg, .theme-pastel .shadow-xl { box-shadow: 0 2px 6px rgba(167,139,250,0.12) !important; border: 1px solid var(--border-color); }
        .theme-pastel .rounded-lg { border-radius: 12px !important; }
        .theme-pastel .rounded-md { border-radius: 8px !important; }
        .theme-pastel .text-blue-600 { color: var(--accent-color) !important; }
        .theme-pastel .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-pastel .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-pastel input, .theme-pastel select, .theme-pastel textarea { background-color: #ffffff !important; border-radius: 10px !important; border: 1px solid var(--border-color) !important; }
        .theme-pastel input:focus, .theme-pastel select:focus, .theme-pastel textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(167,139,250,0.25) !important; outline: none !important; }
        .theme-pastel .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Neon Theme */
        .theme-neon {
            --bg-color: #0a0a0a;
            --card-bg-color: #111827; /* gray-900 */
            --text-color: #e2e8f0; /* slate-200 */
            --subtle-text-color: #34d399; /* emerald-400 */
            --border-color: #1f2937; /* gray-800 */
            --accent-color: #22d3ee; /* cyan-400 */
            --accent-hover-color: #06b6d4; /* cyan-500 */
            --font-family: 'Orbitron', sans-serif;

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            font-family: var(--font-family) !important;
        }
        .theme-neon body, .theme-neon .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-neon .bg-white, .theme-neon .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-neon .shadow-sm, .theme-neon .shadow-md, .theme-neon .shadow-lg, .theme-neon .shadow-xl { box-shadow: 0 0 20px rgba(34, 211, 238, 0.12), 0 0 6px rgba(34, 211, 238, 0.08) !important; border: 1px solid var(--border-color); }
        .theme-neon .rounded-lg, .theme-neon .rounded-md { border-radius: 4px !important; }
        .theme-neon .text-blue-600 { color: var(--accent-color) !important; }
        .theme-neon .bg-blue-600 { background-color: var(--accent-color) !important; color: #0a0a0a !important; }
        .theme-neon .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-neon input, .theme-neon select, .theme-neon textarea { background-color: #0a0a0a !important; border-radius: 4px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-neon input:focus, .theme-neon select:focus, .theme-neon textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.3) !important; outline: none !important; }
        .theme-neon .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Retro Theme */
        .theme-retro {
            --bg-color: #fff7ed; /* orange-50 */
            --card-bg-color: #fef3c7; /* amber-100 */
            --text-color: #1f2937; /* slate-800 */
            --subtle-text-color: #b45309; /* amber-700 */
            --border-color: #fcd34d; /* amber-300 */
            --accent-color: #d97706; /* amber-600 */
            --accent-hover-color: #b45309; /* amber-700 */
            --font-family: 'Montserrat', sans-serif;

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            font-family: var(--font-family) !important;
        }
        .theme-retro body, .theme-retro .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-retro .bg-white, .theme-retro .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-retro .shadow-sm, .theme-retro .shadow-md, .theme-retro .shadow-lg, .theme-retro .shadow-xl { box-shadow: 0 2px 4px rgba(217,119,6,0.12) !important; border: 1px solid var(--border-color); }
        .theme-retro .rounded-lg { border-radius: 12px !important; }
        .theme-retro .rounded-md { border-radius: 8px !important; }
        .theme-retro .text-blue-600 { color: var(--accent-color) !important; }
        .theme-retro .bg-blue-600 { background-color: var(--accent-color) !important; color: #fff !important; }
        .theme-retro .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-retro input, .theme-retro select, .theme-retro textarea { background-color: #fffdf5 !important; border-radius: 10px !important; border: 1px solid var(--border-color) !important; }
        .theme-retro input:focus, .theme-retro select:focus, .theme-retro textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.25) !important; outline: none !important; }
        .theme-retro .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Minimal Theme */
        .theme-minimal {
            --bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-color: #111827; /* gray-900 */
            --subtle-text-color: #6b7280; /* gray-500 */
            --border-color: #e5e7eb; /* gray-200 */
            --accent-color: #111827; /* gray-900 */
            --accent-hover-color: #000000; /* black */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            font-family: var(--font-family) !important;
        }
        .theme-minimal body, .theme-minimal .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-minimal .bg-white, .theme-minimal .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-minimal .shadow-sm, .theme-minimal .shadow-md, .theme-minimal .shadow-lg, .theme-minimal .shadow-xl { box-shadow: none !important; border: 1px solid var(--border-color); }
        .theme-minimal .rounded-lg, .theme-minimal .rounded-md { border-radius: 0 !important; }
        .theme-minimal .text-blue-600 { color: var(--accent-color) !important; }
        .theme-minimal .bg-blue-600 { background-color: var(--accent-color) !important; color: #fff !important; }
        .theme-minimal .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-minimal input, .theme-minimal select, .theme-minimal textarea { background-color: #ffffff !important; border-radius: 0 !important; border: 1px solid var(--border-color) !important; }
        .theme-minimal input:focus, .theme-minimal select:focus, .theme-minimal textarea:focus { border-color: var(--accent-color) !important; box-shadow: none !important; outline: none !important; }
        .theme-minimal .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; border-bottom-width: 2px !important; }

        /* Paper Theme */
        .theme-paper {
            --bg-color: #fefcf3; /* paper */
            --card-bg-color: #ffffff;
            --text-color: #1f2937; /* slate-800 */
            --subtle-text-color: #6b7280; /* gray-500 */
            --border-color: #f3e8ff; /* violet-100 */
            --accent-color: #16a34a; /* green-600 */
            --accent-hover-color: #15803d; /* green-700 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-paper body, .theme-paper .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-paper .bg-white, .theme-paper .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-paper .shadow-sm, .theme-paper .shadow-md, .theme-paper .shadow-lg, .theme-paper .shadow-xl { box-shadow: 0 2px 4px rgba(0,0,0,0.06) !important; border: 1px solid var(--border-color); }
        .theme-paper .rounded-lg, .theme-paper .rounded-md { border-radius: 8px !important; }
        .theme-paper .text-blue-600 { color: var(--accent-color) !important; }
        .theme-paper .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-paper .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-paper input, .theme-paper select, .theme-paper textarea { background-color: #ffffff !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; }
        .theme-paper input:focus, .theme-paper select:focus, .theme-paper textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.2) !important; outline: none !important; }
        .theme-paper .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Grape Theme */
        .theme-grape {
            --bg-color: #faf5ff; /* violet-50 */
            --card-bg-color: #f5f3ff; /* violet-100 */
            --text-color: #1f2937; /* slate-800 */
            --subtle-text-color: #7c3aed; /* violet-600 */
            --border-color: #ddd6fe; /* violet-200 */
            --accent-color: #8b5cf6; /* violet-500 */
            --accent-hover-color: #7c3aed; /* violet-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-grape body, .theme-grape .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-grape .bg-white, .theme-grape .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-grape .shadow-sm, .theme-grape .shadow-md, .theme-grape .shadow-lg, .theme-grape .shadow-xl { box-shadow: 0 2px 6px rgba(139,92,246,0.12) !important; border: 1px solid var(--border-color); }
        .theme-grape .rounded-lg, .theme-grape .rounded-md { border-radius: 8px !important; }
        .theme-grape .text-blue-600 { color: var(--accent-color) !important; }
        .theme-grape .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-grape .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-grape input, .theme-grape select, .theme-grape textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; }
        .theme-grape input:focus, .theme-grape select:focus, .theme-grape textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25) !important; outline: none !important; }
        .theme-grape .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Cobalt Theme */
        .theme-cobalt {
            --bg-color: #0b1020; /* deep navy */
            --card-bg-color: #0f1b2d; /* cobalt deep */
            --text-color: #e2e8f0; /* slate-200 */
            --subtle-text-color: #60a5fa; /* blue-400 */
            --border-color: #1e3a8a; /* indigo-800 */
            --accent-color: #3b82f6; /* blue-500 */
            --accent-hover-color: #2563eb; /* blue-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-cobalt body, .theme-cobalt .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-cobalt .bg-white, .theme-cobalt .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-cobalt .shadow-sm, .theme-cobalt .shadow-md, .theme-cobalt .shadow-lg, .theme-cobalt .shadow-xl { box-shadow: 0 0 16px rgba(59,130,246,0.10) !important; border: 1px solid var(--border-color); }
        .theme-cobalt .rounded-lg, .theme-cobalt .rounded-md { border-radius: 6px !important; }
        .theme-cobalt .text-blue-600 { color: var(--accent-color) !important; }
        .theme-cobalt .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-cobalt .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-cobalt input, .theme-cobalt select, .theme-cobalt textarea { background-color: #0f1b2d !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-cobalt input:focus, .theme-cobalt select:focus, .theme-cobalt textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(59,130,246,0.25) !important; outline: none !important; }
        .theme-cobalt .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Sand Theme */
        .theme-sand {
            --bg-color: #fdf6e3; /* sand */
            --card-bg-color: #fffaf0; /* ivory */
            --text-color: #3f2d1c; /* warm brown */
            --subtle-text-color: #b08968; /* caramel */
            --border-color: #f1e3c6; /* light beige */
            --accent-color: #eab308; /* amber-500 */
            --accent-hover-color: #ca8a04; /* amber-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-sand body, .theme-sand .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-sand .bg-white, .theme-sand .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-sand .shadow-sm, .theme-sand .shadow-md, .theme-sand .shadow-lg, .theme-sand .shadow-xl { box-shadow: 0 2px 4px rgba(202,138,4,0.10) !important; border: 1px solid var(--border-color); }
        .theme-sand .rounded-lg, .theme-sand .rounded-md { border-radius: 10px !important; }
        .theme-sand .text-blue-600 { color: var(--accent-color) !important; }
        .theme-sand .bg-blue-600 { background-color: var(--accent-color) !important; color: #111827 !important; }
        .theme-sand .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-sand input, .theme-sand select, .theme-sand textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; }
        .theme-sand input:focus, .theme-sand select:focus, .theme-sand textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(234,179,8,0.25) !important; outline: none !important; }
        .theme-sand .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Rosewood Theme */
        .theme-rosewood {
            --bg-color: #1b0a0a; /* deep burgundy */
            --card-bg-color: #2a0f0f; /* darker burgundy */
            --text-color: #fde2e2; /* rose-100 */
            --subtle-text-color: #fecaca; /* rose-200 */
            --border-color: #7f1d1d; /* red-900 */
            --accent-color: #f87171; /* red-400 */
            --accent-hover-color: #ef4444; /* red-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-rosewood body, .theme-rosewood .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-rosewood .bg-white, .theme-rosewood .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-rosewood .shadow-sm, .theme-rosewood .shadow-md, .theme-rosewood .shadow-lg, .theme-rosewood .shadow-xl { box-shadow: 0 2px 6px rgba(239,68,68,0.12) !important; border: 1px solid var(--border-color); }
        .theme-rosewood .rounded-lg, .theme-rosewood .rounded-md { border-radius: 8px !important; }
        .theme-rosewood .text-blue-600 { color: var(--accent-color) !important; }
        .theme-rosewood .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-rosewood .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-rosewood input, .theme-rosewood select, .theme-rosewood textarea { background-color: #2a0f0f !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-rosewood input:focus, .theme-rosewood select:focus, .theme-rosewood textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(248,113,113,0.25) !important; outline: none !important; }
        .theme-rosewood .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Blossom Theme */
        .theme-blossom {
            --bg-color: #fff7fb; /* pink tint */
            --card-bg-color: #fff0f6; /* lighter pink */
            --text-color: #3f1d2b; /* plum */
            --subtle-text-color: #e879f9; /* fuchsia-400 */
            --border-color: #fbcfe8; /* pink-200 */
            --accent-color: #f472b6; /* pink-400 */
            --accent-hover-color: #ec4899; /* pink-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-blossom body, .theme-blossom .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-blossom .bg-white, .theme-blossom .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-blossom .shadow-sm, .theme-blossom .shadow-md, .theme-blossom .shadow-lg, .theme-blossom .shadow-xl { box-shadow: 0 2px 4px rgba(236,72,153,0.12) !important; border: 1px solid var(--border-color); }
        .theme-blossom .rounded-lg, .theme-blossom .rounded-md { border-radius: 10px !important; }
        .theme-blossom .text-blue-600 { color: var(--accent-color) !important; }
        .theme-blossom .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-blossom .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-blossom input, .theme-blossom select, .theme-blossom textarea { background-color: #fff7fb !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; }
        .theme-blossom input:focus, .theme-blossom select:focus, .theme-blossom textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(244, 114, 182, 0.25) !important; outline: none !important; }
        .theme-blossom .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Jade Theme */
        .theme-jade {
            --bg-color: #ecfdf5; /* emerald-50 */
            --card-bg-color: #f0fdf4; /* green-50 */
            --text-color: #064e3b; /* emerald-900 */
            --subtle-text-color: #10b981; /* emerald-500 */
            --border-color: #d1fae5; /* emerald-200 */
            --accent-color: #22c55e; /* green-500 */
            --accent-hover-color: #16a34a; /* green-600 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-jade body, .theme-jade .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-jade .bg-white, .theme-jade .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-jade .shadow-sm, .theme-jade .shadow-md, .theme-jade .shadow-lg, .theme-jade .shadow-xl { box-shadow: 0 2px 4px rgba(34,197,94,0.10) !important; border: 1px solid var(--border-color); }
        .theme-jade .rounded-lg, .theme-jade .rounded-md { border-radius: 10px !important; }
        .theme-jade .text-blue-600 { color: var(--accent-color) !important; }
        .theme-jade .bg-blue-600 { background-color: var(--accent-color) !important; }
        .theme-jade .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-jade input, .theme-jade select, .theme-jade textarea { background-color: #ffffff !important; border-radius: 8px !important; border: 1px solid var(--border-color) !important; }
        .theme-jade input:focus, .theme-jade select:focus, .theme-jade textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(34,197,94,0.25) !important; outline: none !important; }
        .theme-jade .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

        /* Cinder Theme */
        .theme-cinder {
            --bg-color: #0f0f10; /* near black */
            --card-bg-color: #16161a; /* dark graphite */
            --text-color: #e5e7eb; /* gray-200 */
            --subtle-text-color: #9ca3af; /* gray-400 */
            --border-color: #27272a; /* zinc-800 */
            --accent-color: #fbbf24; /* amber-400 */
            --accent-hover-color: #f59e0b; /* amber-500 */

            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
        }
        .theme-cinder body, .theme-cinder .bg-gray-50 { background-color: var(--bg-color) !important; }
        .theme-cinder .bg-white, .theme-cinder .bg-gray-100 { background-color: var(--card-bg-color) !important; border: 1px solid var(--border-color); }
        .theme-cinder .shadow-sm, .theme-cinder .shadow-md, .theme-cinder .shadow-lg, .theme-cinder .shadow-xl { box-shadow: 0 1px 3px rgba(0,0,0,0.4) !important; border: 1px solid var(--border-color); }
        .theme-cinder .rounded-lg, .theme-cinder .rounded-md { border-radius: 6px !important; }
        .theme-cinder .text-blue-600 { color: var(--accent-color) !important; }
        .theme-cinder .bg-blue-600 { background-color: var(--accent-color) !important; color: #111827 !important; }
        .theme-cinder .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
        .theme-cinder input, .theme-cinder select, .theme-cinder textarea { background-color: #16161a !important; border-radius: 6px !important; border: 1px solid var(--border-color) !important; color: var(--text-color) !important; }
        .theme-cinder input:focus, .theme-cinder select:focus, .theme-cinder textarea:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 2px rgba(251,191,36,0.25) !important; outline: none !important; }
        .theme-cinder .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

    /* === Extra 30 Themes === */
    /* Aurora */
    .theme-aurora { --bg-color:#0b1220; --card-bg-color:#102336; --text-color:#e6fffb; --subtle-text-color:#6ee7b7; --border-color:#1e3a8a; --accent-color:#34d399; --accent-hover-color:#10b981; }
    .theme-aurora body, .theme-aurora .bg-gray-50 { background-color: var(--bg-color) !important; }
    .theme-aurora .bg-white, .theme-aurora .bg-gray-100 { background-color: var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-aurora .shadow-sm, .theme-aurora .shadow-md, .theme-aurora .shadow-lg, .theme-aurora .shadow-xl { box-shadow:0 0 16px rgba(52,211,153,.1) !important; border:1px solid var(--border-color); }
    .theme-aurora .rounded-lg, .theme-aurora .rounded-md { border-radius:8px !important; }
    .theme-aurora .border, .theme-aurora .divide-y > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-color) !important; }
    .theme-aurora .text-blue-600 { color: var(--accent-color) !important; }
    .theme-aurora .bg-blue-600 { background-color: var(--accent-color) !important; }
    .theme-aurora .bg-blue-600:hover { background-color: var(--accent-hover-color) !important; }
    .theme-aurora input, .theme-aurora select, .theme-aurora textarea { background:#0b1220 !important; border:1px solid var(--border-color) !important; color:var(--text-color) !important; border-radius:6px !important; }
    .theme-aurora input:focus, .theme-aurora select:focus, .theme-aurora textarea:focus { border-color: var(--accent-color) !important; box-shadow:0 0 0 2px rgba(52,211,153,.25) !important; outline:none !important; }
    .theme-aurora .tab-button.active { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }

    /* Cocoa */
    .theme-cocoa { --bg-color:#f7efe7; --card-bg-color:#fffaf5; --text-color:#3e2c20; --subtle-text-color:#a16207; --border-color:#f3e0d0; --accent-color:#b45309; --accent-hover-color:#92400e; }
    .theme-cocoa body, .theme-cocoa .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-cocoa .bg-white, .theme-cocoa .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-cocoa .shadow-sm, .theme-cocoa .shadow-md, .theme-cocoa .shadow-lg, .theme-cocoa .shadow-xl { box-shadow:0 2px 4px rgba(180,83,9,.08) !important; border:1px solid var(--border-color); }
    .theme-cocoa .rounded-lg, .theme-cocoa .rounded-md { border-radius:10px !important; }
    .theme-cocoa .border, .theme-cocoa .divide-y > :not([hidden]) ~ :not([hidden]) { border-color:var(--border-color) !important; }
    .theme-cocoa .text-blue-600 { color: var(--accent-color) !important; }
    .theme-cocoa .bg-blue-600 { background: var(--accent-color) !important; color:#fff !important; }
    .theme-cocoa .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-cocoa input, .theme-cocoa select, .theme-cocoa textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; color:var(--text-color) !important; }
    .theme-cocoa input:focus, .theme-cocoa select:focus, .theme-cocoa textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(180,83,9,.2) !important; outline:none !important; }
    .theme-cocoa .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Denim */
    .theme-denim { --bg-color:#eaf2ff; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#1d4ed8; --border-color:#bfdbfe; --accent-color:#2563eb; --accent-hover-color:#1d4ed8; }
    .theme-denim body, .theme-denim .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-denim .bg-white, .theme-denim .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-denim .shadow-sm, .theme-denim .shadow-md, .theme-denim .shadow-lg, .theme-denim .shadow-xl { box-shadow:0 1px 3px rgba(37,99,235,.12) !important; border:1px solid var(--border-color); }
    .theme-denim .rounded-lg, .theme-denim .rounded-md { border-radius:8px !important; }
    .theme-denim .border, .theme-denim .divide-y > :not([hidden]) ~ :not([hidden]) { border-color:var(--border-color) !important; }
    .theme-denim .text-blue-600 { color: var(--accent-color) !important; }
    .theme-denim .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-denim .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-denim input, .theme-denim select, .theme-denim textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:6px !important; }
    .theme-denim input:focus, .theme-denim select:focus, .theme-denim textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(37,99,235,.2) !important; outline:none !important; }
    .theme-denim .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Lime */
    .theme-lime { --bg-color:#f7fee7; --card-bg-color:#ffffff; --text-color:#1a2e05; --subtle-text-color:#84cc16; --border-color:#d9f99d; --accent-color:#65a30d; --accent-hover-color:#4d7c0f; }
    .theme-lime body, .theme-lime .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-lime .bg-white, .theme-lime .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-lime .shadow-sm, .theme-lime .shadow-md, .theme-lime .shadow-lg, .theme-lime .shadow-xl { box-shadow:0 1px 3px rgba(101,163,13,.12) !important; border:1px solid var(--border-color); }
    .theme-lime .rounded-lg, .theme-lime .rounded-md { border-radius:8px !important; }
    .theme-lime .text-blue-600 { color: var(--accent-color) !important; }
    .theme-lime .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-lime .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-lime input, .theme-lime select, .theme-lime textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-lime input:focus, .theme-lime select:focus, .theme-lime textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(101,163,13,.22) !important; outline:none !important; }
    .theme-lime .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Coral */
    .theme-coral { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#4a1d1d; --subtle-text-color:#fb7185; --border-color:#fecdd3; --accent-color:#f43f5e; --accent-hover-color:#e11d48; }
    .theme-coral body, .theme-coral .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-coral .bg-white, .theme-coral .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-coral .shadow-sm, .theme-coral .shadow-md, .theme-coral .shadow-lg, .theme-coral .shadow-xl { box-shadow:0 2px 6px rgba(244,63,94,.12) !important; border:1px solid var(--border-color); }
    .theme-coral .rounded-lg, .theme-coral .rounded-md { border-radius:10px !important; }
    .theme-coral .text-blue-600 { color: var(--accent-color) !important; }
    .theme-coral .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-coral .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-coral input, .theme-coral select, .theme-coral textarea { background:#fff7f8 !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-coral input:focus, .theme-coral select:focus, .theme-coral textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(244,63,94,.22) !important; outline:none !important; }
    .theme-coral .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Plum */
    .theme-plum { --bg-color:#faf5ff; --card-bg-color:#ffffff; --text-color:#2e1065; --subtle-text-color:#a78bfa; --border-color:#e9d5ff; --accent-color:#8b5cf6; --accent-hover-color:#7c3aed; }
    .theme-plum body, .theme-plum .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-plum .bg-white, .theme-plum .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-plum .shadow-sm, .theme-plum .shadow-md, .theme-plum .shadow-lg, .theme-plum .shadow-xl { box-shadow:0 2px 6px rgba(139,92,246,.12) !important; border:1px solid var(--border-color); }
    .theme-plum .rounded-lg, .theme-plum .rounded-md { border-radius:8px !important; }
    .theme-plum .text-blue-600 { color: var(--accent-color) !important; }
    .theme-plum .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-plum .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-plum input, .theme-plum select, .theme-plum textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-plum input:focus, .theme-plum select:focus, .theme-plum textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(139,92,246,.22) !important; outline:none !important; }
    .theme-plum .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Sky */
    .theme-sky { --bg-color:#e0f2fe; --card-bg-color:#ffffff; --text-color:#0c4a6e; --subtle-text-color:#38bdf8; --border-color:#bae6fd; --accent-color:#0ea5e9; --accent-hover-color:#0284c7; }
    .theme-sky body, .theme-sky .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-sky .bg-white, .theme-sky .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-sky .shadow-sm, .theme-sky .shadow-md, .theme-sky .shadow-lg, .theme-sky .shadow-xl { box-shadow:0 1px 3px rgba(14,165,233,.12) !important; border:1px solid var(--border-color); }
    .theme-sky .rounded-lg, .theme-sky .rounded-md { border-radius:8px !important; }
    .theme-sky .text-blue-600 { color: var(--accent-color) !important; }
    .theme-sky .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-sky .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-sky input, .theme-sky select, .theme-sky textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-sky input:focus, .theme-sky select:focus, .theme-sky textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(14,165,233,.22) !important; outline:none !important; }
    .theme-sky .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Graphite */
    .theme-graphite { --bg-color:#0f1115; --card-bg-color:#181b22; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2b2f37; --accent-color:#60a5fa; --accent-hover-color:#3b82f6; }
    .theme-graphite body, .theme-graphite .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-graphite .bg-white, .theme-graphite .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-graphite .shadow-sm, .theme-graphite .shadow-md, .theme-graphite .shadow-lg, .theme-graphite .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.35) !important; border:1px solid var(--border-color); }
    .theme-graphite .rounded-lg, .theme-graphite .rounded-md { border-radius:6px !important; }
    .theme-graphite .text-blue-600 { color: var(--accent-color) !important; }
    .theme-graphite .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-graphite .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-graphite input, .theme-graphite select, .theme-graphite textarea { background:#181b22 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-graphite input:focus, .theme-graphite select:focus, .theme-graphite textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(96,165,250,.22) !important; outline:none !important; }
    .theme-graphite .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Pearl */
    .theme-pearl { --bg-color:#fbfbfb; --card-bg-color:#ffffff; --text-color:#111827; --subtle-text-color:#6b7280; --border-color:#e5e7eb; --accent-color:#10b981; --accent-hover-color:#059669; }
    .theme-pearl body, .theme-pearl .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-pearl .bg-white, .theme-pearl .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-pearl .shadow-sm, .theme-pearl .shadow-md, .theme-pearl .shadow-lg, .theme-pearl .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-pearl .rounded-lg, .theme-pearl .rounded-md { border-radius:10px !important; }
    .theme-pearl .text-blue-600 { color: var(--accent-color) !important; }
    .theme-pearl .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-pearl .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-pearl input, .theme-pearl select, .theme-pearl textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-pearl input:focus, .theme-pearl select:focus, .theme-pearl textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(16,185,129,.2) !important; outline:none !important; }
    .theme-pearl .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Rust */
    .theme-rust { --bg-color:#fff7ed; --card-bg-color:#fffbeb; --text-color:#7c2d12; --subtle-text-color:#ea580c; --border-color:#fed7aa; --accent-color:#f97316; --accent-hover-color:#ea580c; }
    .theme-rust body, .theme-rust .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-rust .bg-white, .theme-rust .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-rust .shadow-sm, .theme-rust .shadow-md, .theme-rust .shadow-lg, .theme-rust .shadow-xl { box-shadow:0 1px 3px rgba(249,115,22,.12) !important; border:1px solid var(--border-color); }
    .theme-rust .rounded-lg, .theme-rust .rounded-md { border-radius:8px !important; }
    .theme-rust .text-blue-600 { color: var(--accent-color) !important; }
    .theme-rust .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-rust .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-rust input, .theme-rust select, .theme-rust textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-rust input:focus, .theme-rust select:focus, .theme-rust textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(249,115,22,.22) !important; outline:none !important; }
    .theme-rust .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Berry */
    .theme-berry { --bg-color:#fdf2f8; --card-bg-color:#ffffff; --text-color:#4a044e; --subtle-text-color:#f472b6; --border-color:#fce7f3; --accent-color:#db2777; --accent-hover-color:#be185d; }
    .theme-berry body, .theme-berry .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-berry .bg-white, .theme-berry .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-berry .shadow-sm, .theme-berry .shadow-md, .theme-berry .shadow-lg, .theme-berry .shadow-xl { box-shadow:0 1px 3px rgba(219,39,119,.12) !important; border:1px solid var(--border-color); }
    .theme-berry .rounded-lg, .theme-berry .rounded-md { border-radius:8px !important; }
    .theme-berry .text-blue-600 { color: var(--accent-color) !important; }
    .theme-berry .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-berry .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-berry input, .theme-berry select, .theme-berry textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-berry input:focus, .theme-berry select:focus, .theme-berry textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(219,39,119,.22) !important; outline:none !important; }
    .theme-berry .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Moss */
    .theme-moss { --bg-color:#ecfdf5; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#34d399; --border-color:#d1fae5; --accent-color:#10b981; --accent-hover-color:#059669; }
    .theme-moss body, .theme-moss .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-moss .bg-white, .theme-moss .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-moss .shadow-sm, .theme-moss .shadow-md, .theme-moss .shadow-lg, .theme-moss .shadow-xl { box-shadow:0 1px 3px rgba(16,185,129,.12) !important; border:1px solid var(--border-color); }
    .theme-moss .rounded-lg, .theme-moss .rounded-md { border-radius:10px !important; }
    .theme-moss .text-blue-600 { color: var(--accent-color) !important; }
    .theme-moss .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-moss .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-moss input, .theme-moss select, .theme-moss textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-moss input:focus, .theme-moss select:focus, .theme-moss textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(16,185,129,.22) !important; outline:none !important; }
    .theme-moss .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Teal */
    .theme-teal { --bg-color:#f0fdfa; --card-bg-color:#ffffff; --text-color:#134e4a; --subtle-text-color:#14b8a6; --border-color:#ccfbf1; --accent-color:#0d9488; --accent-hover-color:#0f766e; }
    .theme-teal body, .theme-teal .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-teal .bg-white, .theme-teal .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-teal .shadow-sm, .theme-teal .shadow-md, .theme-teal .shadow-lg, .theme-teal .shadow-xl { box-shadow:0 1px 3px rgba(13,148,136,.12) !important; border:1px solid var(--border-color); }
    .theme-teal .rounded-lg, .theme-teal .rounded-md { border-radius:8px !important; }
    .theme-teal .text-blue-600 { color: var(--accent-color) !important; }
    .theme-teal .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-teal .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-teal input, .theme-teal select, .theme-teal textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-teal input:focus, .theme-teal select:focus, .theme-teal textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(13,148,136,.22) !important; outline:none !important; }
    .theme-teal .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Sepia */
    .theme-sepia { --bg-color:#fdf6e3; --card-bg-color:#fffaf0; --text-color:#3f2d1c; --subtle-text-color:#b08968; --border-color:#f1e3c6; --accent-color:#d97706; --accent-hover-color:#b45309; }
    .theme-sepia body, .theme-sepia .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-sepia .bg-white, .theme-sepia .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-sepia .shadow-sm, .theme-sepia .shadow-md, .theme-sepia .shadow-lg, .theme-sepia .shadow-xl { box-shadow:0 1px 3px rgba(217,119,6,.1) !important; border:1px solid var(--border-color); }
    .theme-sepia .rounded-lg, .theme-sepia .rounded-md { border-radius:10px !important; }
    .theme-sepia .text-blue-600 { color: var(--accent-color) !important; }
    .theme-sepia .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-sepia .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-sepia input, .theme-sepia select, .theme-sepia textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-sepia input:focus, .theme-sepia select:focus, .theme-sepia textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(217,119,6,.22) !important; outline:none !important; }
    .theme-sepia .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Charcoal */
    .theme-charcoal { --bg-color:#0b0c10; --card-bg-color:#151820; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2e3340; --accent-color:#22d3ee; --accent-hover-color:#06b6d4; }
    .theme-charcoal body, .theme-charcoal .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-charcoal .bg-white, .theme-charcoal .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-charcoal .shadow-sm, .theme-charcoal .shadow-md, .theme-charcoal .shadow-lg, .theme-charcoal .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.4) !important; border:1px solid var(--border-color); }
    .theme-charcoal .rounded-lg, .theme-charcoal .rounded-md { border-radius:6px !important; }
    .theme-charcoal .text-blue-600 { color: var(--accent-color) !important; }
    .theme-charcoal .bg-blue-600 { background: var(--accent-color) !important; color:#0b0c10 !important; }
    .theme-charcoal .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-charcoal input, .theme-charcoal select, .theme-charcoal textarea { background:#151820 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-charcoal input:focus, .theme-charcoal select:focus, .theme-charcoal textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(34,211,238,.28) !important; outline:none !important; }
    .theme-charcoal .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Ivory */
    .theme-ivory { --bg-color:#fffef8; --card-bg-color:#ffffff; --text-color:#1f2937; --subtle-text-color:#6b7280; --border-color:#f3f4f6; --accent-color:#0ea5e9; --accent-hover-color:#0284c7; }
    .theme-ivory body, .theme-ivory .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-ivory .bg-white, .theme-ivory .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-ivory .shadow-sm, .theme-ivory .shadow-md, .theme-ivory .shadow-lg, .theme-ivory .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-ivory .rounded-lg, .theme-ivory .rounded-md { border-radius:10px !important; }
    .theme-ivory .text-blue-600 { color: var(--accent-color) !important; }
    .theme-ivory .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-ivory .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-ivory input, .theme-ivory select, .theme-ivory textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-ivory input:focus, .theme-ivory select:focus, .theme-ivory textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(14,165,233,.22) !important; outline:none !important; }
    .theme-ivory .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Azure */
    .theme-azure { --bg-color:#eff6ff; --card-bg-color:#ffffff; --text-color:#0c4a6e; --subtle-text-color:#60a5fa; --border-color:#dbeafe; --accent-color:#3b82f6; --accent-hover-color:#2563eb; }
    .theme-azure body, .theme-azure .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-azure .bg-white, .theme-azure .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-azure .shadow-sm, .theme-azure .shadow-md, .theme-azure .shadow-lg, .theme-azure .shadow-xl { box-shadow:0 1px 3px rgba(59,130,246,.12) !important; border:1px solid var(--border-color); }
    .theme-azure .rounded-lg, .theme-azure .rounded-md { border-radius:8px !important; }
    .theme-azure .text-blue-600 { color: var(--accent-color) !important; }
    .theme-azure .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-azure .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-azure input, .theme-azure select, .theme-azure textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-azure input:focus, .theme-azure select:focus, .theme-azure textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(59,130,246,.22) !important; outline:none !important; }
    .theme-azure .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Blush */
    .theme-blush { --bg-color:#fff1f2; --card-bg-color:#fff7f8; --text-color:#4a1d2b; --subtle-text-color:#f472b6; --border-color:#fecdd3; --accent-color:#ec4899; --accent-hover-color:#db2777; }
    .theme-blush body, .theme-blush .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-blush .bg-white, .theme-blush .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-blush .shadow-sm, .theme-blush .shadow-md, .theme-blush .shadow-lg, .theme-blush .shadow-xl { box-shadow:0 1px 3px rgba(236,72,153,.12) !important; border:1px solid var(--border-color); }
    .theme-blush .rounded-lg, .theme-blush .rounded-md { border-radius:10px !important; }
    .theme-blush .text-blue-600 { color: var(--accent-color) !important; }
    .theme-blush .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-blush .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-blush input, .theme-blush select, .theme-blush textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-blush input:focus, .theme-blush select:focus, .theme-blush textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(236,72,153,.22) !important; outline:none !important; }
    .theme-blush .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Saffron */
    .theme-saffron { --bg-color:#fffbeb; --card-bg-color:#ffffff; --text-color:#7c2d12; --subtle-text-color:#f59e0b; --border-color:#fde68a; --accent-color:#f59e0b; --accent-hover-color:#d97706; }
    .theme-saffron body, .theme-saffron .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-saffron .bg-white, .theme-saffron .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-saffron .shadow-sm, .theme-saffron .shadow-md, .theme-saffron .shadow-lg, .theme-saffron .shadow-xl { box-shadow:0 1px 3px rgba(245,158,11,.12) !important; border:1px solid var(--border-color); }
    .theme-saffron .rounded-lg, .theme-saffron .rounded-md { border-radius:8px !important; }
    .theme-saffron .text-blue-600 { color: var(--accent-color) !important; }
    .theme-saffron .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-saffron .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-saffron input, .theme-saffron select, .theme-saffron textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-saffron input:focus, .theme-saffron select:focus, .theme-saffron textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(245,158,11,.22) !important; outline:none !important; }
    .theme-saffron .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Indigo */
    .theme-indigo { --bg-color:#eef2ff; --card-bg-color:#ffffff; --text-color:#312e81; --subtle-text-color:#6366f1; --border-color:#c7d2fe; --accent-color:#4f46e5; --accent-hover-color:#4338ca; }
    .theme-indigo body, .theme-indigo .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-indigo .bg-white, .theme-indigo .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-indigo .shadow-sm, .theme-indigo .shadow-md, .theme-indigo .shadow-lg, .theme-indigo .shadow-xl { box-shadow:0 1px 3px rgba(79,70,229,.12) !important; border:1px solid var(--border-color); }
    .theme-indigo .rounded-lg, .theme-indigo .rounded-md { border-radius:8px !important; }
    .theme-indigo .text-blue-600 { color: var(--accent-color) !important; }
    .theme-indigo .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-indigo .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-indigo input, .theme-indigo select, .theme-indigo textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-indigo input:focus, .theme-indigo select:focus, .theme-indigo textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(79,70,229,.22) !important; outline:none !important; }
    .theme-indigo .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Copper */
    .theme-copper { --bg-color:#fff7ed; --card-bg-color:#ffffff; --text-color:#4a2c1a; --subtle-text-color:#ea580c; --border-color:#fed7aa; --accent-color:#c2410c; --accent-hover-color:#9a3412; }
    .theme-copper body, .theme-copper .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-copper .bg-white, .theme-copper .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-copper .shadow-sm, .theme-copper .shadow-md, .theme-copper .shadow-lg, .theme-copper .shadow-xl { box-shadow:0 1px 3px rgba(194,65,12,.12) !important; border:1px solid var(--border-color); }
    .theme-copper .rounded-lg, .theme-copper .rounded-md { border-radius:8px !important; }
    .theme-copper .text-blue-600 { color: var(--accent-color) !important; }
    .theme-copper .bg-blue-600 { background: var(--accent-color) !important; color:#fff !important; }
    .theme-copper .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-copper input, .theme-copper select, .theme-copper textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-copper input:focus, .theme-copper select:focus, .theme-copper textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(194,65,12,.22) !important; outline:none !important; }
    .theme-copper .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Lavender */
    .theme-lavender { --bg-color:#faf5ff; --card-bg-color:#ffffff; --text-color:#4c1d95; --subtle-text-color:#a78bfa; --border-color:#e9d5ff; --accent-color:#8b5cf6; --accent-hover-color:#7c3aed; }
    .theme-lavender body, .theme-lavender .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-lavender .bg-white, .theme-lavender .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-lavender .shadow-sm, .theme-lavender .shadow-md, .theme-lavender .shadow-lg, .theme-lavender .shadow-xl { box-shadow:0 1px 3px rgba(139,92,246,.12) !important; border:1px solid var(--border-color); }
    .theme-lavender .rounded-lg, .theme-lavender .rounded-md { border-radius:10px !important; }
    .theme-lavender .text-blue-600 { color: var(--accent-color) !important; }
    .theme-lavender .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-lavender .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-lavender input, .theme-lavender select, .theme-lavender textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-lavender input:focus, .theme-lavender select:focus, .theme-lavender textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(139,92,246,.22) !important; outline:none !important; }
    .theme-lavender .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Steel */
    .theme-steel { --bg-color:#f1f5f9; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#475569; --accent-hover-color:#334155; }
    .theme-steel body, .theme-steel .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-steel .bg-white, .theme-steel .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-steel .shadow-sm, .theme-steel .shadow-md, .theme-steel .shadow-lg, .theme-steel .shadow-xl { box-shadow:0 1px 3px rgba(15,23,42,.08) !important; border:1px solid var(--border-color); }
    .theme-steel .rounded-lg, .theme-steel .rounded-md { border-radius:8px !important; }
    .theme-steel .text-blue-600 { color: var(--accent-color) !important; }
    .theme-steel .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-steel .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-steel input, .theme-steel select, .theme-steel textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:6px !important; }
    .theme-steel input:focus, .theme-steel select:focus, .theme-steel textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(71,85,105,.2) !important; outline:none !important; }
    .theme-steel .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Clay */
    .theme-clay { --bg-color:#f9f5f2; --card-bg-color:#ffffff; --text-color:#3f2d20; --subtle-text-color:#a16207; --border-color:#eadbd1; --accent-color:#9a3412; --accent-hover-color:#7c2d12; }
    .theme-clay body, .theme-clay .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-clay .bg-white, .theme-clay .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-clay .shadow-sm, .theme-clay .shadow-md, .theme-clay .shadow-lg, .theme-clay .shadow-xl { box-shadow:0 1px 3px rgba(154,52,18,.10) !important; border:1px solid var(--border-color); }
    .theme-clay .rounded-lg, .theme-clay .rounded-md { border-radius:10px !important; }
    .theme-clay .text-blue-600 { color: var(--accent-color) !important; }
    .theme-clay .bg-blue-600 { background: var(--accent-color) !important; color:#fff !important; }
    .theme-clay .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-clay input, .theme-clay select, .theme-clay textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-clay input:focus, .theme-clay select:focus, .theme-clay textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(154,52,18,.22) !important; outline:none !important; }
    .theme-clay .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Cyan */
    .theme-cyan { --bg-color:#ecfeff; --card-bg-color:#ffffff; --text-color:#164e63; --subtle-text-color:#22d3ee; --border-color:#cffafe; --accent-color:#06b6d4; --accent-hover-color:#0891b2; }
    .theme-cyan body, .theme-cyan .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-cyan .bg-white, .theme-cyan .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-cyan .shadow-sm, .theme-cyan .shadow-md, .theme-cyan .shadow-lg, .theme-cyan .shadow-xl { box-shadow:0 1px 3px rgba(6,182,212,.12) !important; border:1px solid var(--border-color); }
    .theme-cyan .rounded-lg, .theme-cyan .rounded-md { border-radius:8px !important; }
    .theme-cyan .text-blue-600 { color: var(--accent-color) !important; }
    .theme-cyan .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-cyan .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-cyan input, .theme-cyan select, .theme-cyan textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-cyan input:focus, .theme-cyan select:focus, .theme-cyan textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(6,182,212,.22) !important; outline:none !important; }
    .theme-cyan .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Olive */
    .theme-olive { --bg-color:#f7fee7; --card-bg-color:#ffffff; --text-color:#1a2e05; --subtle-text-color:#84cc16; --border-color:#d9f99d; --accent-color:#4d7c0f; --accent-hover-color:#3f6212; }
    .theme-olive body, .theme-olive .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-olive .bg-white, .theme-olive .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-olive .shadow-sm, .theme-olive .shadow-md, .theme-olive .shadow-lg, .theme-olive .shadow-xl { box-shadow:0 1px 3px rgba(77,124,15,.12) !important; border:1px solid var(--border-color); }
    .theme-olive .rounded-lg, .theme-olive .rounded-md { border-radius:8px !important; }
    .theme-olive .text-blue-600 { color: var(--accent-color) !important; }
    .theme-olive .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-olive .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-olive input, .theme-olive select, .theme-olive textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-olive input:focus, .theme-olive select:focus, .theme-olive textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(77,124,15,.22) !important; outline:none !important; }
    .theme-olive .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Marigold */
    .theme-marigold { --bg-color:#fff7ed; --card-bg-color:#ffffff; --text-color:#7c2d12; --subtle-text-color:#f59e0b; --border-color:#fed7aa; --accent-color:#f97316; --accent-hover-color:#ea580c; }
    .theme-marigold body, .theme-marigold .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-marigold .bg-white, .theme-marigold .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-marigold .shadow-sm, .theme-marigold .shadow-md, .theme-marigold .shadow-lg, .theme-marigold .shadow-xl { box-shadow:0 1px 3px rgba(249,115,22,.12) !important; border:1px solid var(--border-color); }
    .theme-marigold .rounded-lg, .theme-marigold .rounded-md { border-radius:10px !important; }
    .theme-marigold .text-blue-600 { color: var(--accent-color) !important; }
    .theme-marigold .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-marigold .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-marigold input, .theme-marigold select, .theme-marigold textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-marigold input:focus, .theme-marigold select:focus, .theme-marigold textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(249,115,22,.22) !important; outline:none !important; }
    .theme-marigold .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Orchid */
    .theme-orchid { --bg-color:#fdf4ff; --card-bg-color:#ffffff; --text-color:#4a044e; --subtle-text-color:#d946ef; --border-color:#f5d0fe; --accent-color:#a21caf; --accent-hover-color:#86198f; }
    .theme-orchid body, .theme-orchid .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-orchid .bg-white, .theme-orchid .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-orchid .shadow-sm, .theme-orchid .shadow-md, .theme-orchid .shadow-lg, .theme-orchid .shadow-xl { box-shadow:0 1px 3px rgba(162,28,175,.12) !important; border:1px solid var(--border-color); }
    .theme-orchid .rounded-lg, .theme-orchid .rounded-md { border-radius:10px !important; }
    .theme-orchid .text-blue-600 { color: var(--accent-color) !important; }
    .theme-orchid .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-orchid .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-orchid input, .theme-orchid select, .theme-orchid textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-orchid input:focus, .theme-orchid select:focus, .theme-orchid textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(162,28,175,.22) !important; outline:none !important; }
    .theme-orchid .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Flamingo */
    .theme-flamingo { --bg-color:#fff0f6; --card-bg-color:#ffffff; --text-color:#3f1d2b; --subtle-text-color:#fb7185; --border-color:#ffe4e6; --accent-color:#f43f5e; --accent-hover-color:#e11d48; }
    .theme-flamingo body, .theme-flamingo .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-flamingo .bg-white, .theme-flamingo .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-flamingo .shadow-sm, .theme-flamingo .shadow-md, .theme-flamingo .shadow-lg, .theme-flamingo .shadow-xl { box-shadow:0 1px 3px rgba(244,63,94,.12) !important; border:1px solid var(--border-color); }
    .theme-flamingo .rounded-lg, .theme-flamingo .rounded-md { border-radius:10px !important; }
    .theme-flamingo .text-blue-600 { color: var(--accent-color) !important; }
    .theme-flamingo .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-flamingo .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-flamingo input, .theme-flamingo select, .theme-flamingo textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-flamingo input:focus, .theme-flamingo select:focus, .theme-flamingo textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(244,63,94,.22) !important; outline:none !important; }
    .theme-flamingo .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* Iceberg */
    .theme-iceberg { --bg-color:#e0f2fe; --card-bg-color:#f0f9ff; --text-color:#0c4a6e; --subtle-text-color:#38bdf8; --border-color:#bae6fd; --accent-color:#0ea5e9; --accent-hover-color:#0284c7; }
    .theme-iceberg body, .theme-iceberg .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-iceberg .bg-white, .theme-iceberg .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-iceberg .shadow-sm, .theme-iceberg .shadow-md, .theme-iceberg .shadow-lg, .theme-iceberg .shadow-xl { box-shadow:0 1px 3px rgba(14,165,233,.12) !important; border:1px solid var(--border-color); }
    .theme-iceberg .rounded-lg, .theme-iceberg .rounded-md { border-radius:8px !important; }
    .theme-iceberg .text-blue-600 { color: var(--accent-color) !important; }
    .theme-iceberg .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-iceberg .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-iceberg input, .theme-iceberg select, .theme-iceberg textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-iceberg input:focus, .theme-iceberg select:focus, .theme-iceberg textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(14,165,233,.22) !important; outline:none !important; }
    .theme-iceberg .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* === 50 More Themes === */
    /* helper skeleton
    .theme-NAME { --bg-color:; --card-bg-color:; --text-color:; --subtle-text-color:; --border-color:; --accent-color:; --accent-hover-color:; }
    .theme-NAME body, .theme-NAME .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-NAME .bg-white, .theme-NAME .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-NAME .shadow-sm, .theme-NAME .shadow-md, .theme-NAME .shadow-lg, .theme-NAME .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.08) !important; border:1px solid var(--border-color); }
    .theme-NAME .rounded-lg, .theme-NAME .rounded-md { border-radius:8px !important; }
    .theme-NAME .text-blue-600 { color: var(--accent-color) !important; }
    .theme-NAME .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-NAME .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-NAME input, .theme-NAME select, .theme-NAME textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; color:var(--text-color) !important; }
    .theme-NAME input:focus, .theme-NAME select:focus, .theme-NAME textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(0,0,0,.12) !important; outline:none !important; }
    .theme-NAME .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }
    */

    .theme-blossom { --bg-color:#fff5f7; --card-bg-color:#ffffff; --text-color:#4a1d2b; --subtle-text-color:#f472b6; --border-color:#fde2e7; --accent-color:#ec4899; --accent-hover-color:#db2777; }
    .theme-blossom body, .theme-blossom .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-blossom .bg-white, .theme-blossom .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-blossom .shadow-sm, .theme-blossom .shadow-md, .theme-blossom .shadow-lg, .theme-blossom .shadow-xl { box-shadow:0 2px 6px rgba(236,72,153,.10) !important; border:1px solid var(--border-color); }
    .theme-blossom .rounded-lg, .theme-blossom .rounded-md { border-radius:10px !important; }
    .theme-blossom .text-blue-600 { color: var(--accent-color) !important; }
    .theme-blossom .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-blossom .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-blossom input, .theme-blossom select, .theme-blossom textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; color:var(--text-color) !important; }
    .theme-blossom input:focus, .theme-blossom select:focus, .theme-blossom textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(236,72,153,.20) !important; outline:none !important; }
    .theme-blossom .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-jade { --bg-color:#ecfdf5; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#34d399; --border-color:#d1fae5; --accent-color:#10b981; --accent-hover-color:#059669; }
    .theme-jade body, .theme-jade .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-jade .bg-white, .theme-jade .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-jade .shadow-sm, .theme-jade .shadow-md, .theme-jade .shadow-lg, .theme-jade .shadow-xl { box-shadow:0 1px 3px rgba(16,185,129,.12) !important; border:1px solid var(--border-color); }
    .theme-jade .rounded-lg, .theme-jade .rounded-md { border-radius:10px !important; }
    .theme-jade .text-blue-600 { color: var(--accent-color) !important; }
    .theme-jade .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-jade .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-jade input, .theme-jade select, .theme-jade textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; color:var(--text-color) !important; }
    .theme-jade input:focus, .theme-jade select:focus, .theme-jade textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(16,185,129,.22) !important; outline:none !important; }
    .theme-jade .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-cinder { --bg-color:#0f1115; --card-bg-color:#181b22; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2b2f37; --accent-color:#f59e0b; --accent-hover-color:#d97706; }
    .theme-cinder body, .theme-cinder .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-cinder .bg-white, .theme-cinder .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-cinder .shadow-sm, .theme-cinder .shadow-md, .theme-cinder .shadow-lg, .theme-cinder .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.35) !important; border:1px solid var(--border-color); }
    .theme-cinder .rounded-lg, .theme-cinder .rounded-md { border-radius:6px !important; }
    .theme-cinder .text-blue-600 { color: var(--accent-color) !important; }
    .theme-cinder .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-cinder .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-cinder input, .theme-cinder select, .theme-cinder textarea { background:#181b22 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-cinder input:focus, .theme-cinder select:focus, .theme-cinder textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(245,158,11,.22) !important; outline:none !important; }
    .theme-cinder .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-fern { --bg-color:#f0fdf4; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#22c55e; --border-color:#dcfce7; --accent-color:#16a34a; --accent-hover-color:#15803d; }
    .theme-fern body, .theme-fern .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-fern .bg-white, .theme-fern .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-fern .shadow-sm, .theme-fern .shadow-md, .theme-fern .shadow-lg, .theme-fern .shadow-xl { box-shadow:0 1px 3px rgba(22,163,74,.12) !important; border:1px solid var(--border-color); }
    .theme-fern .rounded-lg, .theme-fern .rounded-md { border-radius:8px !important; }
    .theme-fern .text-blue-600 { color: var(--accent-color) !important; }
    .theme-fern .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-fern .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-fern input, .theme-fern select, .theme-fern textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-fern input:focus, .theme-fern select:focus, .theme-fern textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(22,163,74,.22) !important; outline:none !important; }
    .theme-fern .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-glacier { --bg-color:#e0f2fe; --card-bg-color:#f0f9ff; --text-color:#0c4a6e; --subtle-text-color:#38bdf8; --border-color:#bae6fd; --accent-color:#0ea5e9; --accent-hover-color:#0284c7; }
    .theme-glacier body, .theme-glacier .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-glacier .bg-white, .theme-glacier .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-glacier .shadow-sm, .theme-glacier .shadow-md, .theme-glacier .shadow-lg, .theme-glacier .shadow-xl { box-shadow:0 1px 3px rgba(14,165,233,.12) !important; border:1px solid var(--border-color); }
    .theme-glacier .rounded-lg, .theme-glacier .rounded-md { border-radius:8px !important; }
    .theme-glacier .text-blue-600 { color: var(--accent-color) !important; }
    .theme-glacier .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-glacier .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-glacier input, .theme-glacier select, .theme-glacier textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-glacier input:focus, .theme-glacier select:focus, .theme-glacier textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(14,165,233,.22) !important; outline:none !important; }
    .theme-glacier .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-ember { --bg-color:#fff7ed; --card-bg-color:#ffffff; --text-color:#7c2d12; --subtle-text-color:#f97316; --border-color:#fed7aa; --accent-color:#ea580c; --accent-hover-color:#c2410c; }
    .theme-ember body, .theme-ember .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-ember .bg-white, .theme-ember .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-ember .shadow-sm, .theme-ember .shadow-md, .theme-ember .shadow-lg, .theme-ember .shadow-xl { box-shadow:0 1px 3px rgba(234,88,12,.12) !important; border:1px solid var(--border-color); }
    .theme-ember .rounded-lg, .theme-ember .rounded-md { border-radius:8px !important; }
    .theme-ember .text-blue-600 { color: var(--accent-color) !important; }
    .theme-ember .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-ember .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-ember input, .theme-ember select, .theme-ember textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-ember input:focus, .theme-ember select:focus, .theme-ember textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(234,88,12,.22) !important; outline:none !important; }
    .theme-ember .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-horizon { --bg-color:#f1f5f9; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#3b82f6; --accent-hover-color:#2563eb; }
    .theme-horizon body, .theme-horizon .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-horizon .bg-white, .theme-horizon .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-horizon .shadow-sm, .theme-horizon .shadow-md, .theme-horizon .shadow-lg, .theme-horizon .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-horizon .rounded-lg, .theme-horizon .rounded-md { border-radius:10px !important; }
    .theme-horizon .text-blue-600 { color: var(--accent-color) !important; }
    .theme-horizon .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-horizon .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-horizon input, .theme-horizon select, .theme-horizon textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-horizon input:focus, .theme-horizon select:focus, .theme-horizon textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(59,130,246,.22) !important; outline:none !important; }
    .theme-horizon .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-canyon { --bg-color:#fff7ed; --card-bg-color:#fffbeb; --text-color:#7c2d12; --subtle-text-color:#f59e0b; --border-color:#fde68a; --accent-color:#d97706; --accent-hover-color:#b45309; }
    .theme-canyon body, .theme-canyon .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-canyon .bg-white, .theme-canyon .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-canyon .shadow-sm, .theme-canyon .shadow-md, .theme-canyon .shadow-lg, .theme-canyon .shadow-xl { box-shadow:0 1px 3px rgba(217,119,6,.12) !important; border:1px solid var(--border-color); }
    .theme-canyon .rounded-lg, .theme-canyon .rounded-md { border-radius:8px !important; }
    .theme-canyon .text-blue-600 { color: var(--accent-color) !important; }
    .theme-canyon .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-canyon .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-canyon input, .theme-canyon select, .theme-canyon textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-canyon input:focus, .theme-canyon select:focus, .theme-canyon textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(217,119,6,.22) !important; outline:none !important; }
    .theme-canyon .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-lagoon { --bg-color:#ecfeff; --card-bg-color:#ffffff; --text-color:#164e63; --subtle-text-color:#22d3ee; --border-color:#cffafe; --accent-color:#06b6d4; --accent-hover-color:#0891b2; }
    .theme-lagoon body, .theme-lagoon .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-lagoon .bg-white, .theme-lagoon .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-lagoon .shadow-sm, .theme-lagoon .shadow-md, .theme-lagoon .shadow-lg, .theme-lagoon .shadow-xl { box-shadow:0 1px 3px rgba(6,182,212,.12) !important; border:1px solid var(--border-color); }
    .theme-lagoon .rounded-lg, .theme-lagoon .rounded-md { border-radius:8px !important; }
    .theme-lagoon .text-blue-600 { color: var(--accent-color) !important; }
    .theme-lagoon .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-lagoon .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-lagoon input, .theme-lagoon select, .theme-lagoon textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-lagoon input:focus, .theme-lagoon select:focus, .theme-lagoon textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(6,182,212,.22) !important; outline:none !important; }
    .theme-lagoon .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-meadow { --bg-color:#f0fdf4; --card-bg-color:#ffffff; --text-color:#14532d; --subtle-text-color:#22c55e; --border-color:#dcfce7; --accent-color:#65a30d; --accent-hover-color:#4d7c0f; }
    .theme-meadow body, .theme-meadow .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-meadow .bg-white, .theme-meadow .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-meadow .shadow-sm, .theme-meadow .shadow-md, .theme-meadow .shadow-lg, .theme-meadow .shadow-xl { box-shadow:0 1px 3px rgba(101,163,13,.12) !important; border:1px solid var(--border-color); }
    .theme-meadow .rounded-lg, .theme-meadow .rounded-md { border-radius:8px !important; }
    .theme-meadow .text-blue-600 { color: var(--accent-color) !important; }
    .theme-meadow .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-meadow .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-meadow input, .theme-meadow select, .theme-meadow textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-meadow input:focus, .theme-meadow select:focus, .theme-meadow textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(101,163,13,.22) !important; outline:none !important; }
    .theme-meadow .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-tundra { --bg-color:#f8fafc; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#0ea5e9; --accent-hover-color:#0284c7; }
    .theme-tundra body, .theme-tundra .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-tundra .bg-white, .theme-tundra .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-tundra .shadow-sm, .theme-tundra .shadow-md, .theme-tundra .shadow-lg, .theme-tundra .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-tundra .rounded-lg, .theme-tundra .rounded-md { border-radius:10px !important; }
    .theme-tundra .text-blue-600 { color: var(--accent-color) !important; }
    .theme-tundra .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-tundra .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-tundra input, .theme-tundra select, .theme-tundra textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-tundra input:focus, .theme-tundra select:focus, .theme-tundra textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(14,165,233,.22) !important; outline:none !important; }
    .theme-tundra .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-dune { --bg-color:#fdf6e3; --card-bg-color:#fffaf0; --text-color:#3f2d1c; --subtle-text-color:#b08968; --border-color:#f1e3c6; --accent-color:#d97706; --accent-hover-color:#b45309; }
    .theme-dune body, .theme-dune .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-dune .bg-white, .theme-dune .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-dune .shadow-sm, .theme-dune .shadow-md, .theme-dune .shadow-lg, .theme-dune .shadow-xl { box-shadow:0 1px 3px rgba(217,119,6,.10) !important; border:1px solid var(--border-color); }
    .theme-dune .rounded-lg, .theme-dune .rounded-md { border-radius:10px !important; }
    .theme-dune .text-blue-600 { color: var(--accent-color) !important; }
    .theme-dune .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-dune .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-dune input, .theme-dune select, .theme-dune textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-dune input:focus, .theme-dune select:focus, .theme-dune textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(217,119,6,.22) !important; outline:none !important; }
    .theme-dune .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-willow { --bg-color:#f0fdf4; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#34d399; --border-color:#dcfce7; --accent-color:#22c55e; --accent-hover-color:#16a34a; }
    .theme-willow body, .theme-willow .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-willow .bg-white, .theme-willow .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-willow .shadow-sm, .theme-willow .shadow-md, .theme-willow .shadow-lg, .theme-willow .shadow-xl { box-shadow:0 1px 3px rgba(34,197,94,.12) !important; border:1px solid var(--border-color); }
    .theme-willow .rounded-lg, .theme-willow .rounded-md { border-radius:10px !important; }
    .theme-willow .text-blue-600 { color: var(--accent-color) !important; }
    .theme-willow .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-willow .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-willow input, .theme-willow select, .theme-willow textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-willow input:focus, .theme-willow select:focus, .theme-willow textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(34,197,94,.22) !important; outline:none !important; }
    .theme-willow .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* å¤šå½©ä¸»é¡Œ - åŸºæ–¼è¨ªå®¢è³‡æ–™èˆ‡æ–°å¢ç”³è«‹å–®çš„è‰²å½©è¨­è¨ˆ */
    .theme-colorful {
        --bg-color: #D9F3FD; /* æ·¡è—è‰²èƒŒæ™¯ */
        --card-bg-color: #ffffff;
        --text-color: #2C3E50; /* æ·±è—ç°è‰²æ–‡å­— */
        --subtle-text-color: #34495E;
        --border-color: #AEBFED; /* æ·¡ç´«è—é‚Šæ¡† */
        --accent-color: #E74C3C; /* ç´…è‰²å¼·èª¿ */
        --accent-hover-color: #C0392B;
        --secondary-green: #C7E2B2; /* æ·¡ç¶ è‰² */
        --secondary-pink: #FFB2C8; /* æ·¡ç²‰è‰² */
        --secondary-purple: #AEBFED; /* æ·¡ç´«è‰² */

        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-green) 25%, var(--secondary-pink) 50%, var(--secondary-purple) 75%, var(--bg-color) 100%) !important;
        color: var(--text-color) !important;
        font-family: 'Noto Sans TC', sans-serif !important;
    }
    .theme-colorful body, .theme-colorful .bg-gray-50 { 
        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-green) 25%, var(--secondary-pink) 50%, var(--secondary-purple) 75%, var(--bg-color) 100%) !important; 
    }
    .theme-colorful .bg-white, .theme-colorful .bg-gray-100 { 
        background: var(--card-bg-color) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 15px !important;
        box-shadow: 0 8px 25px rgba(174, 191, 237, 0.3) !important;
    }
    .theme-colorful .shadow-sm, .theme-colorful .shadow-md, .theme-colorful .shadow-lg, .theme-colorful .shadow-xl { 
        box-shadow: 0 8px 25px rgba(174, 191, 237, 0.3) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 15px !important;
    }
    .theme-colorful .rounded-lg, .theme-colorful .rounded-md { border-radius: 15px !important; }
    .theme-colorful .border, .theme-colorful .border-gray-300, .theme-colorful .border-gray-200, .theme-colorful .divide-y > :not([hidden]) ~ :not([hidden]), .theme-colorful .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
        border-color: var(--border-color) !important;
        border-width: 2px !important;
    }
    .theme-colorful .text-gray-900, .theme-colorful .text-gray-800, .theme-colorful .text-gray-700 { color: var(--text-color) !important; font-weight: 600 !important; }
    .theme-colorful .text-gray-600, .theme-colorful .text-gray-500 { color: var(--subtle-text-color) !important; }
    .theme-colorful .text-blue-600 { color: var(--accent-color) !important; font-weight: bold !important; }
    .theme-colorful .bg-blue-600 { 
        background: linear-gradient(45deg, var(--accent-color), var(--accent-hover-color)) !important; 
        border-radius: 10px !important;
        transition: all 0.3s ease !important;
    }
    .theme-colorful .bg-blue-600:hover { 
        background: linear-gradient(45deg, var(--accent-hover-color), var(--accent-color)) !important; 
        transform: translateY(-2px) !important;
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4) !important;
    }
    .theme-colorful input, .theme-colorful select, .theme-colorful textarea { 
        background: rgba(255, 255, 255, 0.9) !important; 
        border: 2px solid var(--border-color) !important; 
        border-radius: 12px !important; 
        padding: 8px 12px !important;
        transition: all 0.3s ease !important;
    }
    .theme-colorful input:focus, .theme-colorful select:focus, .theme-colorful textarea:focus { 
        border-color: var(--accent-color) !important; 
        box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.2) !important; 
        outline: none !important; 
        transform: scale(1.02) !important;
    }
    .theme-colorful .tab-button.active { 
        border-color: var(--accent-color) !important; 
        color: var(--accent-color) !important; 
        background: rgba(231, 76, 60, 0.1) !important;
        border-radius: 8px !important;
        font-weight: bold !important;
    }
    .theme-colorful .hover\:bg-gray-50:hover { 
        background: linear-gradient(45deg, var(--secondary-green), var(--secondary-pink)) !important; 
        transition: all 0.3s ease !important;
    }
    .theme-colorful button { 
        transition: all 0.3s ease !important; 
        border-radius: 8px !important;
    }
    .theme-colorful button:hover { 
        transform: translateY(-1px) !important; 
    }
    .theme-willow .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* å¤šå½©ä¸»é¡Œï¼šflatpickr è¦–è¦ºæ•´åˆ */
    .theme-colorful .flatpickr-calendar { 
        background: #ffffff !important; 
        border: 2px solid var(--border-color) !important; 
        box-shadow: 0 8px 25px rgba(174, 191, 237, 0.3) !important; 
        border-radius: 12px !important; 
        overflow: hidden; 
    }
    .theme-colorful .flatpickr-weekday { color: var(--subtle-text-color) !important; font-weight: 600; }
    .theme-colorful .flatpickr-day.selected, 
    .theme-colorful .flatpickr-day.startRange, 
    .theme-colorful .flatpickr-day.endRange { 
        background: linear-gradient(45deg, var(--accent-color), var(--accent-hover-color)) !important; 
        border-color: transparent !important; color:#fff !important; 
    }

    /* é˜²æ­¢æ¨™é¡Œåˆ—æœå°‹æ¡†èšç„¦æ™‚æ”¾å¤§é€ æˆæ›è¡Œï¼ˆå¤šå½©/é­¯ç´…/é­¯ç¶ ï¼‰*/
    .theme-colorful .header-toolbar input:focus,
    .theme-colorful .header-toolbar select:focus,
    .theme-colorful .header-toolbar textarea:focus { transform: none !important; }

    /* é­¯ç´…ä¸»é¡Œï¼šflatpickr è¦–è¦ºæ•´åˆ */
    .theme-luhong .flatpickr-calendar { 
        background: #ffffff !important; 
        border: 2px solid var(--border-color) !important; 
        box-shadow: 0 4px 20px rgba(182, 73, 78, 0.15) !important; 
        border-radius: 12px !important; 
        overflow: hidden; 
    }
    .theme-luhong .flatpickr-weekday { color: var(--subtle-text-color) !important; font-weight: 600; }
    .theme-luhong .flatpickr-day.selected, 
    .theme-luhong .flatpickr-day.startRange, 
    .theme-luhong .flatpickr-day.endRange { 
        background: linear-gradient(45deg, var(--accent-color), var(--secondary-dark)) !important; 
        border-color: transparent !important; color:#fff !important; 
    }
    .theme-luhong .header-toolbar input:focus,
    .theme-luhong .header-toolbar select:focus,
    .theme-luhong .header-toolbar textarea:focus { transform: none !important; }

    /* é­¯ç¶ ä¸»é¡Œï¼šflatpickr è¦–è¦ºæ•´åˆ */
    .theme-lugreen .flatpickr-calendar { 
        background: #ffffff !important; 
        border: 2px solid var(--border-color) !important; 
        box-shadow: 0 4px 20px rgba(44, 193, 133, 0.15) !important; 
        border-radius: 12px !important; 
        overflow: hidden; 
    }
    .theme-lugreen .flatpickr-weekday { color: var(--subtle-text-color) !important; font-weight: 600; }
    .theme-lugreen .flatpickr-day.selected, 
    .theme-lugreen .flatpickr-day.startRange, 
    .theme-lugreen .flatpickr-day.endRange { 
        background: linear-gradient(45deg, var(--accent-color), var(--secondary-dark)) !important; 
        border-color: transparent !important; color:#fff !important; 
    }
    .theme-lugreen .header-toolbar input:focus,
    .theme-lugreen .header-toolbar select:focus,
    .theme-lugreen .header-toolbar textarea:focus { transform: none !important; }

    /* --- ä¿®å¾©ï¼šå¤šå½© / é­¯ç´… / é­¯ç¶  ä¸»é¡Œä¸‹ã€Œç‰ˆé¢é¢¨æ ¼ã€é¸å–æ¡†è¢«æ”¾å¤§ --- */
    .theme-colorful #app-header .theme-switcher select,
    .theme-colorful #app-header .theme-switcher select:focus,
    .theme-luhong #app-header .theme-switcher select,
    .theme-luhong #app-header .theme-switcher select:focus,
    .theme-lugreen #app-header .theme-switcher select,
    .theme-lugreen #app-header .theme-switcher select:focus {
        border: 1px solid var(--border-color) !important;
        border-radius: 6px !important;
        padding: 0.25rem 0.5rem !important; /* èˆ‡åŸæœ¬ p-1 å°é½Š */
        height: 2rem !important;            /* h-8 */
        line-height: 1.5rem !important;
        box-shadow: none !important;
        transform: none !important;
        background: #fff !important;
    }

    /* --- ä¿®å¾©ï¼šå¤šå½© / é­¯ç´… / é­¯ç¶  ä¸»é¡Œä¸‹ã€Œæª¢è¦–æ¬Šé™ã€èˆ‡ã€Œæ—¥æœŸå€é–“ã€é«˜åº¦ä¸€è‡´ï¼ˆä»¥æ—¥æœŸå€é–“ h-10 ç‚ºåŸºæº–ï¼‰--- */
    .theme-colorful #dashboard-filters select[data-filter="permission"],
    .theme-luhong   #dashboard-filters select[data-filter="permission"],
    .theme-lugreen  #dashboard-filters select[data-filter="permission"] {
        height: 2.5rem !important;          /* h-10 */
        line-height: 2.5rem !important;     /* æ–‡å­—å‚ç›´ç½®ä¸­ */
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        padding-left: 0.75rem !important;   /* px-3 */
        padding-right: 0.75rem !important;
        transform: none !important;         /* é¿å… focus æ™‚æ”¾å¤§ */
    }
    .theme-colorful #dashboard-filters select[data-filter="permission"]:focus,
    .theme-luhong   #dashboard-filters select[data-filter="permission"]:focus,
    .theme-lugreen  #dashboard-filters select[data-filter="permission"]:focus {
        transform: none !important;
    }

    .theme-bronze { --bg-color:#fff7ed; --card-bg-color:#ffffff; --text-color:#4a2c1a; --subtle-text-color:#ea580c; --border-color:#fed7aa; --accent-color:#b45309; --accent-hover-color:#92400e; }
    .theme-bronze body, .theme-bronze .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-bronze .bg-white, .theme-bronze .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-bronze .shadow-sm, .theme-bronze .shadow-md, .theme-bronze .shadow-lg, .theme-bronze .shadow-xl { box-shadow:0 1px 3px rgba(180,83,9,.12) !important; border:1px solid var(--border-color); }
    .theme-bronze .rounded-lg, .theme-bronze .rounded-md { border-radius:8px !important; }
    .theme-bronze .text-blue-600 { color: var(--accent-color) !important; }
    .theme-bronze .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-bronze .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-bronze input, .theme-bronze select, .theme-bronze textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-bronze input:focus, .theme-bronze select:focus, .theme-bronze textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(180,83,9,.22) !important; outline:none !important; }
    .theme-bronze .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-silver { --bg-color:#f8fafc; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#64748b; --accent-hover-color:#475569; }
    .theme-silver body, .theme-silver .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-silver .bg-white, .theme-silver .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-silver .shadow-sm, .theme-silver .shadow-md, .theme-silver .shadow-lg, .theme-silver .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-silver .rounded-lg, .theme-silver .rounded-md { border-radius:8px !important; }
    .theme-silver .text-blue-600 { color: var(--accent-color) !important; }
    .theme-silver .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-silver .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-silver input, .theme-silver select, .theme-silver textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-silver input:focus, .theme-silver select:focus, .theme-silver textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(100,116,139,.22) !important; outline:none !important; }
    .theme-silver .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-gold { --bg-color:#fffbeb; --card-bg-color:#ffffff; --text-color:#713f12; --subtle-text-color:#f59e0b; --border-color:#fde68a; --accent-color:#d97706; --accent-hover-color:#b45309; }
    .theme-gold body, .theme-gold .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-gold .bg-white, .theme-gold .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-gold .shadow-sm, .theme-gold .shadow-md, .theme-gold .shadow-lg, .theme-gold .shadow-xl { box-shadow:0 1px 3px rgba(245,158,11,.12) !important; border:1px solid var(--border-color); }
    .theme-gold .rounded-lg, .theme-gold .rounded-md { border-radius:10px !important; }
    .theme-gold .text-blue-600 { color: var(--accent-color) !important; }
    .theme-gold .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-gold .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-gold input, .theme-gold select, .theme-gold textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-gold input:focus, .theme-gold select:focus, .theme-gold textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(217,119,6,.22) !important; outline:none !important; }
    .theme-gold .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-amethyst { --bg-color:#f5f3ff; --card-bg-color:#ffffff; --text-color:#3730a3; --subtle-text-color:#a78bfa; --border-color:#ddd6fe; --accent-color:#8b5cf6; --accent-hover-color:#7c3aed; }
    .theme-amethyst body, .theme-amethyst .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-amethyst .bg-white, .theme-amethyst .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-amethyst .shadow-sm, .theme-amethyst .shadow-md, .theme-amethyst .shadow-lg, .theme-amethyst .shadow-xl { box-shadow:0 1px 3px rgba(139,92,246,.12) !important; border:1px solid var(--border-color); }
    .theme-amethyst .rounded-lg, .theme-amethyst .rounded-md { border-radius:8px !important; }
    .theme-amethyst .text-blue-600 { color: var(--accent-color) !important; }
    .theme-amethyst .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-amethyst .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-amethyst input, .theme-amethyst select, .theme-amethyst textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-amethyst input:focus, .theme-amethyst select:focus, .theme-amethyst textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(139,92,246,.22) !important; outline:none !important; }
    .theme-amethyst .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-sapphire { --bg-color:#eff6ff; --card-bg-color:#ffffff; --text-color:#1e3a8a; --subtle-text-color:#60a5fa; --border-color:#dbeafe; --accent-color:#2563eb; --accent-hover-color:#1d4ed8; }
    .theme-sapphire body, .theme-sapphire .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-sapphire .bg-white, .theme-sapphire .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-sapphire .shadow-sm, .theme-sapphire .shadow-md, .theme-sapphire .shadow-lg, .theme-sapphire .shadow-xl { box-shadow:0 1px 3px rgba(37,99,235,.12) !important; border:1px solid var(--border-color); }
    .theme-sapphire .rounded-lg, .theme-sapphire .rounded-md { border-radius:8px !important; }
    .theme-sapphire .text-blue-600 { color: var(--accent-color) !important; }
    .theme-sapphire .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-sapphire .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-sapphire input, .theme-sapphire select, .theme-sapphire textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-sapphire input:focus, .theme-sapphire select:focus, .theme-sapphire textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(37,99,235,.22) !important; outline:none !important; }
    .theme-sapphire .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-ruby { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#7f1d1d; --subtle-text-color:#f87171; --border-color:#fecaca; --accent-color:#ef4444; --accent-hover-color:#dc2626; }
    .theme-ruby body, .theme-ruby .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-ruby .bg-white, .theme-ruby .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-ruby .shadow-sm, .theme-ruby .shadow-md, .theme-ruby .shadow-lg, .theme-ruby .shadow-xl { box-shadow:0 1px 3px rgba(239,68,68,.12) !important; border:1px solid var(--border-color); }
    .theme-ruby .rounded-lg, .theme-ruby .rounded-md { border-radius:10px !important; }
    .theme-ruby .text-blue-600 { color: var(--accent-color) !important; }
    .theme-ruby .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-ruby .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-ruby input, .theme-ruby select, .theme-ruby textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-ruby input:focus, .theme-ruby select:focus, .theme-ruby textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(239,68,68,.22) !important; outline:none !important; }
    .theme-ruby .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-emerald { --bg-color:#ecfdf5; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#34d399; --border-color:#d1fae5; --accent-color:#10b981; --accent-hover-color:#059669; }
    .theme-emerald body, .theme-emerald .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-emerald .bg-white, .theme-emerald .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-emerald .shadow-sm, .theme-emerald .shadow-md, .theme-emerald .shadow-lg, .theme-emerald .shadow-xl { box-shadow:0 1px 3px rgba(16,185,129,.12) !important; border:1px solid var(--border-color); }
    .theme-emerald .rounded-lg, .theme-emerald .rounded-md { border-radius:10px !important; }
    .theme-emerald .text-blue-600 { color: var(--accent-color) !important; }
    .theme-emerald .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-emerald .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-emerald input, .theme-emerald select, .theme-emerald textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-emerald input:focus, .theme-emerald select:focus, .theme-emerald textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(16,185,129,.22) !important; outline:none !important; }
    .theme-emerald .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-topaz { --bg-color:#fffbeb; --card-bg-color:#ffffff; --text-color:#78350f; --subtle-text-color:#f59e0b; --border-color:#fde68a; --accent-color:#f59e0b; --accent-hover-color:#d97706; }
    .theme-topaz body, .theme-topaz .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-topaz .bg-white, .theme-topaz .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-topaz .shadow-sm, .theme-topaz .shadow-md, .theme-topaz .shadow-lg, .theme-topaz .shadow-xl { box-shadow:0 1px 3px rgba(245,158,11,.12) !important; border:1px solid var(--border-color); }
    .theme-topaz .rounded-lg, .theme-topaz .rounded-md { border-radius:8px !important; }
    .theme-topaz .text-blue-600 { color: var(--accent-color) !important; }
    .theme-topaz .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-topaz .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-topaz input, .theme-topaz select, .theme-topaz textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-topaz input:focus, .theme-topaz select:focus, .theme-topaz textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(245,158,11,.22) !important; outline:none !important; }
    .theme-topaz .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-garnet { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#701a1a; --subtle-text-color:#fb7185; --border-color:#fecdd3; --accent-color:#e11d48; --accent-hover-color:#be123c; }
    .theme-garnet body, .theme-garnet .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-garnet .bg-white, .theme-garnet .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-garnet .shadow-sm, .theme-garnet .shadow-md, .theme-garnet .shadow-lg, .theme-garnet .shadow-xl { box-shadow:0 1px 3px rgba(225,29,72,.12) !important; border:1px solid var(--border-color); }
    .theme-garnet .rounded-lg, .theme-garnet .rounded-md { border-radius:10px !important; }
    .theme-garnet .text-blue-600 { color: var(--accent-color) !important; }
    .theme-garnet .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-garnet .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-garnet input, .theme-garnet select, .theme-garnet textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-garnet input:focus, .theme-garnet select:focus, .theme-garnet textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(225,29,72,.22) !important; outline:none !important; }
    .theme-garnet .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-quartz { --bg-color:#f8fafc; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#14b8a6; --accent-hover-color:#0d9488; }
    .theme-quartz body, .theme-quartz .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-quartz .bg-white, .theme-quartz .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-quartz .shadow-sm, .theme-quartz .shadow-md, .theme-quartz .shadow-lg, .theme-quartz .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-quartz .rounded-lg, .theme-quartz .rounded-md { border-radius:8px !important; }
    .theme-quartz .text-blue-600 { color: var(--accent-color) !important; }
    .theme-quartz .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-quartz .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-quartz input, .theme-quartz select, .theme-quartz textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-quartz input:focus, .theme-quartz select:focus, .theme-quartz textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(20,184,166,.22) !important; outline:none !important; }
    .theme-quartz .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-onyx { --bg-color:#0b0c10; --card-bg-color:#151820; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2e3340; --accent-color:#a3a3a3; --accent-hover-color:#737373; }
    .theme-onyx body, .theme-onyx .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-onyx .bg-white, .theme-onyx .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-onyx .shadow-sm, .theme-onyx .shadow-md, .theme-onyx .shadow-lg, .theme-onyx .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.4) !important; border:1px solid var(--border-color); }
    .theme-onyx .rounded-lg, .theme-onyx .rounded-md { border-radius:6px !important; }
    .theme-onyx .text-blue-600 { color: var(--accent-color) !important; }
    .theme-onyx .bg-blue-600 { background: var(--accent-color) !important; color:#0b0c10 !important; }
    .theme-onyx .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-onyx input, .theme-onyx select, .theme-onyx textarea { background:#151820 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-onyx input:focus, .theme-onyx select:focus, .theme-onyx textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(163,163,163,.28) !important; outline:none !important; }
    .theme-onyx .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-obsidian { --bg-color:#0f1115; --card-bg-color:#181b22; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2b2f37; --accent-color:#22d3ee; --accent-hover-color:#06b6d4; }
    .theme-obsidian body, .theme-obsidian .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-obsidian .bg-white, .theme-obsidian .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-obsidian .shadow-sm, .theme-obsidian .shadow-md, .theme-obsidian .shadow-lg, .theme-obsidian .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.35) !important; border:1px solid var(--border-color); }
    .theme-obsidian .rounded-lg, .theme-obsidian .rounded-md { border-radius:6px !important; }
    .theme-obsidian .text-blue-600 { color: var(--accent-color) !important; }
    .theme-obsidian .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-obsidian .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-obsidian input, .theme-obsidian select, .theme-obsidian textarea { background:#181b22 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-obsidian input:focus, .theme-obsidian select:focus, .theme-obsidian textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(34,211,238,.28) !important; outline:none !important; }
    .theme-obsidian .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-smoke { --bg-color:#f3f4f6; --card-bg-color:#ffffff; --text-color:#111827; --subtle-text-color:#6b7280; --border-color:#e5e7eb; --accent-color:#9ca3af; --accent-hover-color:#6b7280; }
    .theme-smoke body, .theme-smoke .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-smoke .bg-white, .theme-smoke .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-smoke .shadow-sm, .theme-smoke .shadow-md, .theme-smoke .shadow-lg, .theme-smoke .shadow-xl { box-shadow:0 1px 2px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-smoke .rounded-lg, .theme-smoke .rounded-md { border-radius:6px !important; }
    .theme-smoke .text-blue-600 { color: var(--accent-color) !important; }
    .theme-smoke .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-smoke .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-smoke input, .theme-smoke select, .theme-smoke textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:6px !important; }
    .theme-smoke input:focus, .theme-smoke select:focus, .theme-smoke textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(156,163,175,.22) !important; outline:none !important; }
    .theme-smoke .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-cloud { --bg-color:#f8fafc; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#94a3b8; --border-color:#e2e8f0; --accent-color:#38bdf8; --accent-hover-color:#0ea5e9; }
    .theme-cloud body, .theme-cloud .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-cloud .bg-white, .theme-cloud .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-cloud .shadow-sm, .theme-cloud .shadow-md, .theme-cloud .shadow-lg, .theme-cloud .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-cloud .rounded-lg, .theme-cloud .rounded-md { border-radius:10px !important; }
    .theme-cloud .text-blue-600 { color: var(--accent-color) !important; }
    .theme-cloud .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-cloud .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-cloud input, .theme-cloud select, .theme-cloud textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-cloud input:focus, .theme-cloud select:focus, .theme-cloud textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(56,189,248,.22) !important; outline:none !important; }
    .theme-cloud .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-storm { --bg-color:#0f172a; --card-bg-color:#111827; --text-color:#e2e8f0; --subtle-text-color:#94a3b8; --border-color:#1f2937; --accent-color:#38bdf8; --accent-hover-color:#0ea5e9; }
    .theme-storm body, .theme-storm .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-storm .bg-white, .theme-storm .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-storm .shadow-sm, .theme-storm .shadow-md, .theme-storm .shadow-lg, .theme-storm .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.35) !important; border:1px solid var(--border-color); }
    .theme-storm .rounded-lg, .theme-storm .rounded-md { border-radius:6px !important; }
    .theme-storm .text-blue-600 { color: var(--accent-color) !important; }
    .theme-storm .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-storm .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-storm input, .theme-storm select, .theme-storm textarea { background:#111827 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-storm input:focus, .theme-storm select:focus, .theme-storm textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(56,189,248,.28) !important; outline:none !important; }
    .theme-storm .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-frost { --bg-color:#f1f5f9; --card-bg-color:#ffffff; --text-color:#0c4a6e; --subtle-text-color:#94a3b8; --border-color:#e2e8f0; --accent-color:#38bdf8; --accent-hover-color:#0ea5e9; }
    .theme-frost body, .theme-frost .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-frost .bg-white, .theme-frost .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-frost .shadow-sm, .theme-frost .shadow-md, .theme-frost .shadow-lg, .theme-frost .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-frost .rounded-lg, .theme-frost .rounded-md { border-radius:8px !important; }
    .theme-frost .text-blue-600 { color: var(--accent-color) !important; }
    .theme-frost .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-frost .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-frost input, .theme-frost select, .theme-frost textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-frost input:focus, .theme-frost select:focus, .theme-frost textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(56,189,248,.22) !important; outline:none !important; }
    .theme-frost .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-cherry { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#701a1a; --subtle-text-color:#fb7185; --border-color:#fecdd3; --accent-color:#f43f5e; --accent-hover-color:#e11d48; }
    .theme-cherry body, .theme-cherry .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-cherry .bg-white, .theme-cherry .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-cherry .shadow-sm, .theme-cherry .shadow-md, .theme-cherry .shadow-lg, .theme-cherry .shadow-xl { box-shadow:0 2px 6px rgba(244,63,94,.12) !important; border:1px solid var(--border-color); }
    .theme-cherry .rounded-lg, .theme-cherry .rounded-md { border-radius:10px !important; }
    .theme-cherry .text-blue-600 { color: var(--accent-color) !important; }
    .theme-cherry .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-cherry .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-cherry input, .theme-cherry select, .theme-cherry textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-cherry input:focus, .theme-cherry select:focus, .theme-cherry textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(244,63,94,.22) !important; outline:none !important; }
    .theme-cherry .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-espresso { --bg-color:#f5f5f4; --card-bg-color:#ffffff; --text-color:#1c1917; --subtle-text-color:#a8a29e; --border-color:#e7e5e4; --accent-color:#7c2d12; --accent-hover-color:#4a1d09; }
    .theme-espresso body, .theme-espresso .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-espresso .bg-white, .theme-espresso .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-espresso .shadow-sm, .theme-espresso .shadow-md, .theme-espresso .shadow-lg, .theme-espresso .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-espresso .rounded-lg, .theme-espresso .rounded-md { border-radius:8px !important; }
    .theme-espresso .text-blue-600 { color: var(--accent-color) !important; }
    .theme-espresso .bg-blue-600 { background: var(--accent-color) !important; color:#fff !important; }
    .theme-espresso .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-espresso input, .theme-espresso select, .theme-espresso textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-espresso input:focus, .theme-espresso select:focus, .theme-espresso textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(124,45,18,.22) !important; outline:none !important; }
    .theme-espresso .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-mocha { --bg-color:#f5efe6; --card-bg-color:#ffffff; --text-color:#3f2d20; --subtle-text-color:#a16207; --border-color:#eadbd1; --accent-color:#9a3412; --accent-hover-color:#7c2d12; }
    .theme-mocha body, .theme-mocha .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-mocha .bg-white, .theme-mocha .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-mocha .shadow-sm, .theme-mocha .shadow-md, .theme-mocha .shadow-lg, .theme-mocha .shadow-xl { box-shadow:0 1px 3px rgba(154,52,18,.10) !important; border:1px solid var(--border-color); }
    .theme-mocha .rounded-lg, .theme-mocha .rounded-md { border-radius:10px !important; }
    .theme-mocha .text-blue-600 { color: var(--accent-color) !important; }
    .theme-mocha .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-mocha .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-mocha input, .theme-mocha select, .theme-mocha textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-mocha input:focus, .theme-mocha select:focus, .theme-mocha textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(154,52,18,.22) !important; outline:none !important; }
    .theme-mocha .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-avocado { --bg-color:#f7fee7; --card-bg-color:#ffffff; --text-color:#1a2e05; --subtle-text-color:#84cc16; --border-color:#d9f99d; --accent-color:#65a30d; --accent-hover-color:#4d7c0f; }
    .theme-avocado body, .theme-avocado .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-avocado .bg-white, .theme-avocado .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-avocado .shadow-sm, .theme-avocado .shadow-md, .theme-avocado .shadow-lg, .theme-avocado .shadow-xl { box-shadow:0 1px 3px rgba(101,163,13,.12) !important; border:1px solid var(--border-color); }
    .theme-avocado .rounded-lg, .theme-avocado .rounded-md { border-radius:8px !important; }
    .theme-avocado .text-blue-600 { color: var(--accent-color) !important; }
    .theme-avocado .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-avocado .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-avocado input, .theme-avocado select, .theme-avocado textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-avocado input:focus, .theme-avocado select:focus, .theme-avocado textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(101,163,13,.22) !important; outline:none !important; }
    .theme-avocado .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-banana { --bg-color:#fef9c3; --card-bg-color:#ffffff; --text-color:#3f2d1c; --subtle-text-color:#facc15; --border-color:#fde68a; --accent-color:#eab308; --accent-hover-color:#ca8a04; }
    .theme-banana body, .theme-banana .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-banana .bg-white, .theme-banana .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-banana .shadow-sm, .theme-banana .shadow-md, .theme-banana .shadow-lg, .theme-banana .shadow-xl { box-shadow:0 1px 3px rgba(234,179,8,.12) !important; border:1px solid var(--border-color); }
    .theme-banana .rounded-lg, .theme-banana .rounded-md { border-radius:10px !important; }
    .theme-banana .text-blue-600 { color: var(--accent-color) !important; }
    .theme-banana .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-banana .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-banana input, .theme-banana select, .theme-banana textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-banana input:focus, .theme-banana select:focus, .theme-banana textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(234,179,8,.22) !important; outline:none !important; }
    .theme-banana .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-plumeria { --bg-color:#fff7fb; --card-bg-color:#ffffff; --text-color:#4a1d2b; --subtle-text-color:#f472b6; --border-color:#fde2f2; --accent-color:#be185d; --accent-hover-color:#9d174d; }
    .theme-plumeria body, .theme-plumeria .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-plumeria .bg-white, .theme-plumeria .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-plumeria .shadow-sm, .theme-plumeria .shadow-md, .theme-plumeria .shadow-lg, .theme-plumeria .shadow-xl { box-shadow:0 2px 6px rgba(190,24,93,.10) !important; border:1px solid var(--border-color); }
    .theme-plumeria .rounded-lg, .theme-plumeria .rounded-md { border-radius:10px !important; }
    .theme-plumeria .text-blue-600 { color: var(--accent-color) !important; }
    .theme-plumeria .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-plumeria .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-plumeria input, .theme-plumeria select, .theme-plumeria textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-plumeria input:focus, .theme-plumeria select:focus, .theme-plumeria textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(190,24,93,.20) !important; outline:none !important; }
    .theme-plumeria .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-reef { --bg-color:#ecfeff; --card-bg-color:#ffffff; --text-color:#164e63; --subtle-text-color:#22d3ee; --border-color:#cffafe; --accent-color:#06b6d4; --accent-hover-color:#0891b2; }
    .theme-reef body, .theme-reef .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-reef .bg-white, .theme-reef .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-reef .shadow-sm, .theme-reef .shadow-md, .theme-reef .shadow-lg, .theme-reef .shadow-xl { box-shadow:0 1px 3px rgba(6,182,212,.12) !important; border:1px solid var(--border-color); }
    .theme-reef .rounded-lg, .theme-reef .rounded-md { border-radius:8px !important; }
    .theme-reef .text-blue-600 { color: var(--accent-color) !important; }
    .theme-reef .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-reef .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-reef input, .theme-reef select, .theme-reef textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-reef input:focus, .theme-reef select:focus, .theme-reef textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(6,182,212,.22) !important; outline:none !important; }
    .theme-reef .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-seafoam { --bg-color:#f0fdfa; --card-bg-color:#ffffff; --text-color:#134e4a; --subtle-text-color:#14b8a6; --border-color:#ccfbf1; --accent-color:#0d9488; --accent-hover-color:#0f766e; }
    .theme-seafoam body, .theme-seafoam .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-seafoam .bg-white, .theme-seafoam .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-seafoam .shadow-sm, .theme-seafoam .shadow-md, .theme-seafoam .shadow-lg, .theme-seafoam .shadow-xl { box-shadow:0 1px 3px rgba(13,148,136,.12) !important; border:1px solid var(--border-color); }
    .theme-seafoam .rounded-lg, .theme-seafoam .rounded-md { border-radius:8px !important; }
    .theme-seafoam .text-blue-600 { color: var(--accent-color) !important; }
    .theme-seafoam .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-seafoam .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-seafoam input, .theme-seafoam select, .theme-seafoam textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-seafoam input:focus, .theme-seafoam select:focus, .theme-seafoam textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(13,148,136,.22) !important; outline:none !important; }
    .theme-seafoam .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-pine { --bg-color:#ecfdf5; --card-bg-color:#ffffff; --text-color:#064e3b; --subtle-text-color:#34d399; --border-color:#d1fae5; --accent-color:#065f46; --accent-hover-color:#064e3b; }
    .theme-pine body, .theme-pine .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-pine .bg-white, .theme-pine .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-pine .shadow-sm, .theme-pine .shadow-md, .theme-pine .shadow-lg, .theme-pine .shadow-xl { box-shadow:0 1px 3px rgba(6,95,70,.12) !important; border:1px solid var(--border-color); }
    .theme-pine .rounded-lg, .theme-pine .rounded-md { border-radius:10px !important; }
    .theme-pine .text-blue-600 { color: var(--accent-color) !important; }
    .theme-pine .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-pine .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-pine input, .theme-pine select, .theme-pine textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-pine input:focus, .theme-pine select:focus, .theme-pine textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(6,95,70,.22) !important; outline:none !important; }
    .theme-pine .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-iron { --bg-color:#f1f5f9; --card-bg-color:#ffffff; --text-color:#0f172a; --subtle-text-color:#64748b; --border-color:#e2e8f0; --accent-color:#475569; --accent-hover-color:#334155; }
    .theme-iron body, .theme-iron .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-iron .bg-white, .theme-iron .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-iron .shadow-sm, .theme-iron .shadow-md, .theme-iron .shadow-lg, .theme-iron .shadow-xl { box-shadow:0 1px 3px rgba(15,23,42,.08) !important; border:1px solid var(--border-color); }
    .theme-iron .rounded-lg, .theme-iron .rounded-md { border-radius:8px !important; }
    .theme-iron .text-blue-600 { color: var(--accent-color) !important; }
    .theme-iron .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-iron .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-iron input, .theme-iron select, .theme-iron textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:6px !important; }
    .theme-iron input:focus, .theme-iron select:focus, .theme-iron textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(71,85,105,.2) !important; outline:none !important; }
    .theme-iron .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-carbon { --bg-color:#0b0c10; --card-bg-color:#151820; --text-color:#e5e7eb; --subtle-text-color:#9ca3af; --border-color:#2e3340; --accent-color:#22c55e; --accent-hover-color:#16a34a; }
    .theme-carbon body, .theme-carbon .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-carbon .bg-white, .theme-carbon .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-carbon .shadow-sm, .theme-carbon .shadow-md, .theme-carbon .shadow-lg, .theme-carbon .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.4) !important; border:1px solid var(--border-color); }
    .theme-carbon .rounded-lg, .theme-carbon .rounded-md { border-radius:6px !important; }
    .theme-carbon .text-blue-600 { color: var(--accent-color) !important; }
    .theme-carbon .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-carbon .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-carbon input, .theme-carbon select, .theme-carbon textarea { background:#151820 !important; border:1px solid var(--border-color) !important; border-radius:6px !important; color:var(--text-color) !important; }
    .theme-carbon input:focus, .theme-carbon select:focus, .theme-carbon textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(34,197,94,.28) !important; outline:none !important; }
    .theme-carbon .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-navy { --bg-color:#e0e7ff; --card-bg-color:#ffffff; --text-color:#1e3a8a; --subtle-text-color:#6366f1; --border-color:#c7d2fe; --accent-color:#4f46e5; --accent-hover-color:#4338ca; }
    .theme-navy body, .theme-navy .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-navy .bg-white, .theme-navy .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-navy .shadow-sm, .theme-navy .shadow-md, .theme-navy .shadow-lg, .theme-navy .shadow-xl { box-shadow:0 1px 3px rgba(79,70,229,.12) !important; border:1px solid var(--border-color); }
    .theme-navy .rounded-lg, .theme-navy .rounded-md { border-radius:8px !important; }
    .theme-navy .text-blue-600 { color: var(--accent-color) !important; }
    .theme-navy .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-navy .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-navy input, .theme-navy select, .theme-navy textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-navy input:focus, .theme-navy select:focus, .theme-navy textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(79,70,229,.22) !important; outline:none !important; }
    .theme-navy .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-air { --bg-color:#eef2ff; --card-bg-color:#ffffff; --text-color:#0c4a6e; --subtle-text-color:#60a5fa; --border-color:#e0e7ff; --accent-color:#38bdf8; --accent-hover-color:#0ea5e9; }
    .theme-air body, .theme-air .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-air .bg-white, .theme-air .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-air .shadow-sm, .theme-air .shadow-md, .theme-air .shadow-lg, .theme-air .shadow-xl { box-shadow:0 1px 3px rgba(0,0,0,.06) !important; border:1px solid var(--border-color); }
    .theme-air .rounded-lg, .theme-air .rounded-md { border-radius:10px !important; }
    .theme-air .text-blue-600 { color: var(--accent-color) !important; }
    .theme-air .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-air .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-air input, .theme-air select, .theme-air textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-air input:focus, .theme-air select:focus, .theme-air textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(56,189,248,.22) !important; outline:none !important; }
    .theme-air .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-violet { --bg-color:#f5f3ff; --card-bg-color:#ffffff; --text-color:#4c1d95; --subtle-text-color:#a78bfa; --border-color:#ddd6fe; --accent-color:#8b5cf6; --accent-hover-color:#7c3aed; }
    .theme-violet body, .theme-violet .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-violet .bg-white, .theme-violet .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-violet .shadow-sm, .theme-violet .shadow-md, .theme-violet .shadow-lg, .theme-violet .shadow-xl { box-shadow:0 1px 3px rgba(139,92,246,.12) !important; border:1px solid var(--border-color); }
    .theme-violet .rounded-lg, .theme-violet .rounded-md { border-radius:8px !important; }
    .theme-violet .text-blue-600 { color: var(--accent-color) !important; }
    .theme-violet .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-violet .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-violet input, .theme-violet select, .theme-violet textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-violet input:focus, .theme-violet select:focus, .theme-violet textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(139,92,246,.22) !important; outline:none !important; }
    .theme-violet .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-caramel { --bg-color:#fff7ed; --card-bg-color:#ffffff; --text-color:#7c2d12; --subtle-text-color:#fb923c; --border-color:#fed7aa; --accent-color:#ea580c; --accent-hover-color:#c2410c; }
    .theme-caramel body, .theme-caramel .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-caramel .bg-white, .theme-caramel .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-caramel .shadow-sm, .theme-caramel .shadow-md, .theme-caramel .shadow-lg, .theme-caramel .shadow-xl { box-shadow:0 1px 3px rgba(234,88,12,.12) !important; border:1px solid var(--border-color); }
    .theme-caramel .rounded-lg, .theme-caramel .rounded-md { border-radius:8px !important; }
    .theme-caramel .text-blue-600 { color: var(--accent-color) !important; }
    .theme-caramel .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-caramel .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-caramel input, .theme-caramel select, .theme-caramel textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-caramel input:focus, .theme-caramel select:focus, .theme-caramel textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(234,88,12,.22) !important; outline:none !important; }
    .theme-caramel .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-peach { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#7c2d12; --subtle-text-color:#fb7185; --border-color:#fecdd3; --accent-color:#f97316; --accent-hover-color:#ea580c; }
    .theme-peach body, .theme-peach .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-peach .bg-white, .theme-peach .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-peach .shadow-sm, .theme-peach .shadow-md, .theme-peach .shadow-lg, .theme-peach .shadow-xl { box-shadow:0 1px 3px rgba(249,115,22,.12) !important; border:1px solid var(--border-color); }
    .theme-peach .rounded-lg, .theme-peach .rounded-md { border-radius:10px !important; }
    .theme-peach .text-blue-600 { color: var(--accent-color) !important; }
    .theme-peach .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-peach .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-peach input, .theme-peach select, .theme-peach textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-peach input:focus, .theme-peach select:focus, .theme-peach textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(249,115,22,.22) !important; outline:none !important; }
    .theme-peach .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-lilac { --bg-color:#faf5ff; --card-bg-color:#ffffff; --text-color:#4c1d95; --subtle-text-color:#c4b5fd; --border-color:#e9d5ff; --accent-color:#a78bfa; --accent-hover-color:#8b5cf6; }
    .theme-lilac body, .theme-lilac .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-lilac .bg-white, .theme-lilac .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-lilac .shadow-sm, .theme-lilac .shadow-md, .theme-lilac .shadow-lg, .theme-lilac .shadow-xl { box-shadow:0 1px 3px rgba(167,139,250,.12) !important; border:1px solid var(--border-color); }
    .theme-lilac .rounded-lg, .theme-lilac .rounded-md { border-radius:8px !important; }
    .theme-lilac .text-blue-600 { color: var(--accent-color) !important; }
    .theme-lilac .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-lilac .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-lilac input, .theme-lilac select, .theme-lilac textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-lilac input:focus, .theme-lilac select:focus, .theme-lilac textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(167,139,250,.22) !important; outline:none !important; }
    .theme-lilac .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-rose { --bg-color:#fff1f2; --card-bg-color:#ffffff; --text-color:#4a1d2b; --subtle-text-color:#f472b6; --border-color:#fecdd3; --accent-color:#ec4899; --accent-hover-color:#db2777; }
    .theme-rose body, .theme-rose .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-rose .bg-white, .theme-rose .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-rose .shadow-sm, .theme-rose .shadow-md, .theme-rose .shadow-lg, .theme-rose .shadow-xl { box-shadow:0 1px 3px rgba(236,72,153,.12) !important; border:1px solid var(--border-color); }
    .theme-rose .rounded-lg, .theme-rose .rounded-md { border-radius:10px !important; }
    .theme-rose .text-blue-600 { color: var(--accent-color) !important; }
    .theme-rose .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-rose .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-rose input, .theme-rose select, .theme-rose textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-rose input:focus, .theme-rose select:focus, .theme-rose textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(236,72,153,.22) !important; outline:none !important; }
    .theme-rose .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-magenta { --bg-color:#fdf4ff; --card-bg-color:#ffffff; --text-color:#4a044e; --subtle-text-color:#d946ef; --border-color:#f5d0fe; --accent-color:#a21caf; --accent-hover-color:#86198f; }
    .theme-magenta body, .theme-magenta .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-magenta .bg-white, .theme-magenta .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-magenta .shadow-sm, .theme-magenta .shadow-md, .theme-magenta .shadow-lg, .theme-magenta .shadow-xl { box-shadow:0 1px 3px rgba(162,28,175,.12) !important; border:1px solid var(--border-color); }
    .theme-magenta .rounded-lg, .theme-magenta .rounded-md { border-radius:10px !important; }
    .theme-magenta .text-blue-600 { color: var(--accent-color) !important; }
    .theme-magenta .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-magenta .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-magenta input, .theme-magenta select, .theme-magenta textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-magenta input:focus, .theme-magenta select:focus, .theme-magenta textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(162,28,175,.22) !important; outline:none !important; }
    .theme-magenta .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-periwinkle { --bg-color:#eef2ff; --card-bg-color:#ffffff; --text-color:#3730a3; --subtle-text-color:#93c5fd; --border-color:#e0e7ff; --accent-color:#6366f1; --accent-hover-color:#4f46e5; }
    .theme-periwinkle body, .theme-periwinkle .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-periwinkle .bg-white, .theme-periwinkle .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-periwinkle .shadow-sm, .theme-periwinkle .shadow-md, .theme-periwinkle .shadow-lg, .theme-periwinkle .shadow-xl { box-shadow:0 1px 3px rgba(99,102,241,.12) !important; border:1px solid var(--border-color); }
    .theme-periwinkle .rounded-lg, .theme-periwinkle .rounded-md { border-radius:8px !important; }
    .theme-periwinkle .text-blue-600 { color: var(--accent-color) !important; }
    .theme-periwinkle .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-periwinkle .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-periwinkle input, .theme-periwinkle select, .theme-periwinkle textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-periwinkle input:focus, .theme-periwinkle select:focus, .theme-periwinkle textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(99,102,241,.22) !important; outline:none !important; }
    .theme-periwinkle .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    .theme-teak { --bg-color:#f9f5f2; --card-bg-color:#ffffff; --text-color:#3f2d20; --subtle-text-color:#a16207; --border-color:#eadbd1; --accent-color:#8b5e34; --accent-hover-color:#734a2e; }
    .theme-teak body, .theme-teak .bg-gray-50 { background:var(--bg-color) !important; }
    .theme-teak .bg-white, .theme-teak .bg-gray-100 { background:var(--card-bg-color) !important; border:1px solid var(--border-color); }
    .theme-teak .shadow-sm, .theme-teak .shadow-md, .theme-teak .shadow-lg, .theme-teak .shadow-xl { box-shadow:0 1px 3px rgba(139,94,52,.10) !important; border:1px solid var(--border-color); }
    .theme-teak .rounded-lg, .theme-teak .rounded-md { border-radius:10px !important; }
    .theme-teak .text-blue-600 { color: var(--accent-color) !important; }
    .theme-teak .bg-blue-600 { background: var(--accent-color) !important; }
    .theme-teak .bg-blue-600:hover { background: var(--accent-hover-color) !important; }
    .theme-teak input, .theme-teak select, .theme-teak textarea { background:#ffffff !important; border:1px solid var(--border-color) !important; border-radius:8px !important; }
    .theme-teak input:focus, .theme-teak select:focus, .theme-teak textarea:focus { border-color:var(--accent-color) !important; box-shadow:0 0 0 2px rgba(139,94,52,.22) !important; outline:none !important; }
    .theme-teak .tab-button.active { border-color:var(--accent-color) !important; color:var(--accent-color) !important; }

    /* é­¯ç´…ä¸»é¡Œ - åŸºæ–¼è¨ªå®¢è³‡æ–™èˆ‡æ–°å¢ç”³è«‹å–®çš„ç´…è‰²è¨­è¨ˆ */
    .theme-luhong {
        --bg-color: #FEF6F5; /* æ·¡ç²‰è‰²èƒŒæ™¯ï¼Œä¾†è‡ªSVG */
        --card-bg-color: #ffffff;
        --text-color: #2C1B1D; /* æ·±è‰²æ–‡å­—ï¼Œèˆ‡ç´…è‰²ä¸»é¡Œé…åˆ */
        --subtle-text-color: #6B2C30;
        --border-color: #E8C5C7; /* æ·¡ç´…é‚Šæ¡†ï¼ŒåŸºæ–¼ä¸»è‰²èª¿ */
        --accent-color: #B6494E; /* ä¸»è¦ç´…è‰²ï¼Œç›´æ¥ä¾†è‡ªSVG */
        --accent-hover-color: #A03E43;
        --secondary-light: #FDF2F2; /* æ¥µæ·¡ç²‰è‰² */
        --secondary-dark: #8B3A3F; /* æ·±ç´…è‰² */

        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-light) 50%, var(--bg-color) 100%) !important;
        color: var(--text-color) !important;
        font-family: 'Noto Sans TC', sans-serif !important;
    }
    .theme-luhong body, .theme-luhong .bg-gray-50 { 
        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-light) 50%, var(--bg-color) 100%) !important; 
    }
    .theme-luhong .bg-white, .theme-luhong .bg-gray-100 { 
        background: var(--card-bg-color) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 12px !important;
        box-shadow: 0 4px 20px rgba(182, 73, 78, 0.15) !important;
    }
    .theme-luhong .shadow-sm, .theme-luhong .shadow-md, .theme-luhong .shadow-lg, .theme-luhong .shadow-xl { 
        box-shadow: 0 4px 20px rgba(182, 73, 78, 0.15) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 12px !important;
    }
    .theme-luhong .rounded-lg, .theme-luhong .rounded-md { border-radius: 12px !important; }
    .theme-luhong .border, .theme-luhong .border-gray-300, .theme-luhong .border-gray-200, .theme-luhong .divide-y > :not([hidden]) ~ :not([hidden]), .theme-luhong .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
        border-color: var(--border-color) !important;
        border-width: 2px !important;
    }
    .theme-luhong .text-gray-900, .theme-luhong .text-gray-800, .theme-luhong .text-gray-700 { color: var(--text-color) !important; font-weight: 600 !important; }
    .theme-luhong .text-gray-600, .theme-luhong .text-gray-500 { color: var(--subtle-text-color) !important; }
    .theme-luhong .text-blue-600 { color: var(--accent-color) !important; font-weight: bold !important; }
    .theme-luhong .bg-blue-600 { 
        background: linear-gradient(45deg, var(--accent-color), var(--secondary-dark)) !important; 
        border-radius: 10px !important;
        transition: all 0.3s ease !important;
    }
    .theme-luhong .bg-blue-600:hover { 
        background: linear-gradient(45deg, var(--accent-hover-color), var(--accent-color)) !important; 
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(182, 73, 78, 0.4) !important;
    }
    .theme-luhong input, .theme-luhong select, .theme-luhong textarea { 
        background: rgba(255, 255, 255, 0.95) !important; 
        border: 2px solid var(--border-color) !important; 
        border-radius: 10px !important; 
        padding: 10px 14px !important;
        transition: all 0.3s ease !important;
    }
    .theme-luhong input:focus, .theme-luhong select:focus, .theme-luhong textarea:focus { 
        border-color: var(--accent-color) !important; 
        box-shadow: 0 0 0 4px rgba(182, 73, 78, 0.2) !important; 
        outline: none !important; 
        transform: scale(1.02) !important;
        background: #ffffff !important;
    }
    .theme-luhong .tab-button.active { 
        border-color: var(--accent-color) !important; 
        color: var(--accent-color) !important; 
        background: rgba(182, 73, 78, 0.1) !important;
        border-radius: 8px !important;
        font-weight: bold !important;
    }
    .theme-luhong .hover\:bg-gray-50:hover { 
        background: linear-gradient(45deg, var(--secondary-light), var(--bg-color)) !important; 
        transition: all 0.3s ease !important;
    }
    .theme-luhong button { 
        transition: all 0.3s ease !important; 
        border-radius: 8px !important;
    }
    .theme-luhong button:hover { 
        transform: translateY(-1px) !important; 
    }

    /* é­¯ç¶ ä¸»é¡Œ - åŸºæ–¼è¨ªå®¢è³‡æ–™èˆ‡æ–°å¢ç”³è«‹å–®çš„ç¶ è‰²è¨­è¨ˆ */
    .theme-lugreen {
        --bg-color: #F0F8F5; /* æ·¡ç¶ è‰²èƒŒæ™¯ */
        --card-bg-color: #ffffff;
        --text-color: #313A46; /* æ·±è‰²æ–‡å­— */
        --subtle-text-color: #555E68;
        --border-color: #C5E4D6; /* æ·¡ç¶ é‚Šæ¡† */
        --accent-color: #2CC185; /* ä¸»è¦ç¶ è‰² */
        --accent-hover-color: #24A36B;
        --secondary-light: #E8F5F0; /* æ¥µæ·¡ç¶ è‰² */
        --secondary-dark: #1B7F5A; /* æ·±ç¶ è‰² */

        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-light) 50%, var(--bg-color) 100%) !important;
        color: var(--text-color) !important;
        font-family: 'Noto Sans TC', sans-serif !important;
    }
    .theme-lugreen body, .theme-lugreen .bg-gray-50 { 
        background: linear-gradient(135deg, var(--bg-color) 0%, var(--secondary-light) 50%, var(--bg-color) 100%) !important; 
    }
    .theme-lugreen .bg-white, .theme-lugreen .bg-gray-100 { 
        background: var(--card-bg-color) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 12px !important;
        box-shadow: 0 4px 20px rgba(44, 193, 133, 0.15) !important;
    }
    .theme-lugreen .shadow-sm, .theme-lugreen .shadow-md, .theme-lugreen .shadow-lg, .theme-lugreen .shadow-xl { 
        box-shadow: 0 4px 20px rgba(44, 193, 133, 0.15) !important; 
        border: 2px solid var(--border-color); 
        border-radius: 12px !important;
    }
    .theme-lugreen .rounded-lg, .theme-lugreen .rounded-md { border-radius: 12px !important; }
    .theme-lugreen .border, .theme-lugreen .border-gray-300, .theme-lugreen .border-gray-200, .theme-lugreen .divide-y > :not([hidden]) ~ :not([hidden]), .theme-lugreen .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
        border-color: var(--border-color) !important;
        border-width: 2px !important;
    }
    .theme-lugreen .text-gray-900, .theme-lugreen .text-gray-800, .theme-lugreen .text-gray-700 { color: var(--text-color) !important; font-weight: 600 !important; }
    .theme-lugreen .text-gray-600, .theme-lugreen .text-gray-500 { color: var(--subtle-text-color) !important; }
    .theme-lugreen .text-blue-600 { color: var(--accent-color) !important; font-weight: bold !important; }
    .theme-lugreen .bg-blue-600 { 
        background: linear-gradient(45deg, var(--accent-color), var(--secondary-dark)) !important; 
        border-radius: 10px !important;
        transition: all 0.3s ease !important;
    }
    .theme-lugreen .bg-blue-600:hover { 
        background: linear-gradient(45deg, var(--accent-hover-color), var(--accent-color)) !important; 
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(44, 193, 133, 0.4) !important;
    }
    .theme-lugreen input, .theme-lugreen select, .theme-lugreen textarea { 
        background: rgba(255, 255, 255, 0.95) !important; 
        border: 2px solid var(--border-color) !important; 
        border-radius: 10px !important; 
        padding: 10px 14px !important;
        transition: all 0.3s ease !important;
    }
    .theme-lugreen input:focus, .theme-lugreen select:focus, .theme-lugreen textarea:focus { 
        border-color: var(--accent-color) !important; 
        box-shadow: 0 0 0 4px rgba(44, 193, 133, 0.2) !important; 
        outline: none !important; 
        transform: scale(1.02) !important;
        background: #ffffff !important;
    }
    .theme-lugreen .tab-button.active { 
        border-color: var(--accent-color) !important; 
        color: var(--accent-color) !important; 
        background: rgba(44, 193, 133, 0.1) !important;
        border-radius: 8px !important;
        font-weight: bold !important;
    }
    .theme-lugreen .hover\:bg-gray-50:hover { 
        background: linear-gradient(45deg, var(--secondary-light), var(--bg-color)) !important; 
        transition: all 0.3s ease !important;
    }
    .theme-lugreen button { 
        transition: all 0.3s ease !important; 
        border-radius: 8px !important;
    }
    .theme-lugreen button:hover { 
        transform: translateY(-1px) !important; 
    }

    /* ä¿®å¾© flatpickr åœ¨ã€Œå¤šå½©ã€ã€Œé­¯ç´…ã€ã€Œé­¯ç¶ ã€ä¸»é¡Œä¸‹ï¼Œæœˆä»½/å¹´ä»½é¸å–è¢«é€±æ¨™é¡Œè¦†è“‹çš„å•é¡Œ */
    .theme-colorful .flatpickr-calendar,
    .theme-luhong .flatpickr-calendar,
    .theme-lugreen .flatpickr-calendar { 
        z-index: 9999 !important; /* ç¢ºä¿æ—¥æ›†æœ¬é«”æµ®åœ¨å…¶ä»–å®¹å™¨ä¹‹ä¸Š */
    }
    .theme-colorful .flatpickr-calendar .flatpickr-months,
    .theme-luhong .flatpickr-calendar .flatpickr-months,
    .theme-lugreen .flatpickr-calendar .flatpickr-months { 
        position: relative; 
        z-index: 3;              /* æœˆä»½/å¹´ä»½åˆ—å„ªå…ˆé¡¯ç¤ºæ–¼é€±æ¨™é¡Œä¹‹ä¸Š */
        background: var(--card-bg-color, #ffffff); 
        padding-bottom: 6px;     /* èˆ‡é€±æ¨™é¡Œç•™é–“è·ï¼Œé¿å…è¦–è¦ºå †ç–Š */
    }
    .theme-colorful .flatpickr-calendar .flatpickr-weekdays,
    .theme-luhong .flatpickr-calendar .flatpickr-weekdays,
    .theme-lugreen .flatpickr-calendar .flatpickr-weekdays { 
        position: relative; 
        z-index: 1;              /* é€±æ¨™é¡Œå±¤ç´šè¼ƒä½ï¼Œä¸è¦†è“‹æœˆä»½/å¹´ä»½ */
    }
    .theme-colorful .flatpickr-calendar .flatpickr-current-month,
    .theme-luhong .flatpickr-calendar .flatpickr-current-month,
    .theme-lugreen .flatpickr-calendar .flatpickr-current-month { 
        position: relative; 
        z-index: 4;              /* å¹´åº¦è¼¸å…¥èˆ‡æœˆä»½ä¸‹æ‹‰å†æé«˜ä¸€å±¤ï¼Œç¢ºä¿é»æ“Šå€åŸŸä¸è¢«é®æ“‹ */
        line-height: 1.4;        /* å¢åŠ å¯è®€æ€§ä¸¦é¿å…æ“ å£“ */
        padding-top: 2px; 
        padding-bottom: 2px; 
    }
    /* ç½®ä¸­æœˆä»½/å¹´ä»½ï¼Œèˆ‡æ«»èŠ±(é è¨­)ä¸€è‡´ */
    .theme-colorful .flatpickr-calendar .flatpickr-current-month { text-align: center !important; position: absolute !important; left: 0; right: 0; width: 100%; }
    .theme-luhong .flatpickr-calendar .flatpickr-current-month { text-align: center !important; position: absolute !important; left: 0; right: 0; width: 100%; }
    .theme-lugreen .flatpickr-calendar .flatpickr-current-month { text-align: center !important; position: absolute !important; left: 0; right: 0; width: 100%; }
    /* å¤šå½©/é­¯ç´…/é­¯ç¶ ï¼šè®“æœˆä»½/å¹´ä»½æ¬„ä½å°ºå¯¸èˆ‡æ«»èŠ±ä¸»é¡Œä¸€è‡´ï¼ˆå›åˆ° flatpickr é è¨­çš„ç²¾ç°¡å°ºå¯¸ï¼‰ */
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-colorful .flatpickr-calendar .numInputWrapper input { 
        padding: 0 !important;               /* å»é™¤å¤šå½©ä¸»é¡Œå° input/select çš„å…§é‚Šè·æ”¾å¤§ */
    border: 1px solid var(--border-color) !important; /* é è¨­å°±æœ‰é‚Šæ¡†é¡è‰² */
        background: transparent !important;  /* èˆ‡é è¨­ä¸€è‡´ */
        border-radius: 0 !important;         /* èˆ‡é è¨­ä¸€è‡´çš„ç›´è§’æ§ä»¶ */
        box-shadow: none !important;         /* ç§»é™¤å¤šå½©ä¸»é¡Œå¯èƒ½åŠ ä¸Šçš„é™°å½± */
    text-align: center !important;       /* æ˜ç¢ºç½®ä¸­æ–‡æœ¬ï¼Œèˆ‡æ«»èŠ±ä¸€è‡´ */
    }
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-luhong .flatpickr-calendar .numInputWrapper input { 
        padding: 0 !important;
    border: 1px solid var(--border-color) !important;
        background: transparent !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        text-align: center !important;
    }
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input { 
        padding: 0 !important;
    border: 1px solid var(--border-color) !important;
        background: transparent !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        text-align: center !important;
    }

    /* äº’å‹•éæ¸¡ï¼šèšç„¦é‚Šæ¡†/é™°å½±/èƒŒæ™¯çš„å‹•ç•«ï¼ˆéµç›¤å‹å–„ :focus-visibleï¼‰ */
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-colorful .flatpickr-calendar .numInputWrapper input,
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-luhong .flatpickr-calendar .numInputWrapper input,
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input {
        transition: border-color 0.18s ease, box-shadow 0.18s ease, background-color 0.18s ease;
    }

    /* å¾®èª¿ focus ring æ¿ƒåº¦ï¼ˆå„ä¸»é¡Œè¦–è¦ºä¸€è‡´æ€§ï¼‰ */
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-colorful .flatpickr-calendar .numInputWrapper input:focus,
    .theme-colorful .flatpickr-calendar .numInputWrapper input:focus-visible {
        box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.28) !important;
    }
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-luhong .flatpickr-calendar .numInputWrapper input:focus,
    .theme-luhong .flatpickr-calendar .numInputWrapper input:focus-visible {
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.26) !important;
    }
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input:focus,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input:focus-visible {
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.24) !important;
    }
    /* é»åˆ°æœˆä»½/å¹´ä»½æ™‚æ¢å¾©é‚Šæ¡†æ•ˆæœï¼ˆ:focus èˆ‡ :focus-visibleï¼‰ */
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-colorful .flatpickr-calendar .numInputWrapper input:focus,
    .theme-colorful .flatpickr-calendar .numInputWrapper input:focus-visible {
        border-color: var(--accent-color) !important;
        box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2) !important; /* èˆ‡å¤šå½©ä¸»é¡Œæ•´é«”ç„¦é»é¢¨æ ¼ä¸€è‡´ */
        outline: none !important;
        background: #ffffff !important; /* èšç„¦æ™‚æ›´æ¸…æ™° */
    }
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-luhong .flatpickr-calendar .numInputWrapper input:focus,
    .theme-luhong .flatpickr-calendar .numInputWrapper input:focus-visible {
        border-color: var(--accent-color) !important;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
        outline: none !important;
        background: #ffffff !important;
    }
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months:focus,
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months:focus-visible,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input:focus,
    .theme-lugreen .flatpickr-calendar .numInputWrapper input:focus-visible {
        border-color: var(--accent-color) !important;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2) !important;
        outline: none !important;
        background: #ffffff !important;
    }
    /* æœˆä»½ä¸‹æ‹‰èˆ‡å¹´ä»½æ•¸å­—è¼¸å…¥çš„å±€éƒ¨å±¤ç´šæå‡ï¼ˆä¸åŒç€è¦½å™¨è¡Œç‚ºæ›´ç©©å®šï¼‰ */
    .theme-colorful .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-luhong .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-lugreen .flatpickr-calendar .flatpickr-monthDropdown-months,
    .theme-colorful .flatpickr-calendar .numInputWrapper,
    .theme-luhong .flatpickr-calendar .numInputWrapper,
    .theme-lugreen .flatpickr-calendar .numInputWrapper { 
        position: relative; 
        z-index: 5; 
    }
    </style>
</head>
<body class="bg-gray-50 font-sans p-0 sm:p-4 md:p-8">

    <div id="notification-container"></div>
    
    <div id="app-header" class="mb-4"></div>

    <div id="app-container">
        <div id="loading-view" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center">
            <div class="spinner-container">
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
                <div class="spinner-dot"></div>
            </div>
            <p class="mt-8 text-gray-600 text-lg">è®€å–è³‡æ–™ä¸­...</p>
        </div>

        <div id="error-view" class="view p-8 text-center"></div>

        <div id="login-view" class="view"></div>
        <div id="dashboard-view" class="view"></div>
        <div id="newRequest-view" class="view"></div>
        <div id="detailView-view" class="view"></div>
        <div id="productManagement-view" class="view"></div>
        <div id="productForm-view" class="view"></div>
        <div id="personalForms-view" class="view"></div>
        <div id="userManagement-view" class="view"></div>
    <div id="departmentManagement-view" class="view"></div>
    <div id="sessionManagement-view" class="view"></div>
        <div id="userForm-view" class="view"></div>
    <div id="departmentForm-view" class="view"></div>
        <div id="vendorManagement-view" class="view"></div>
        <div id="vendorForm-view" class="view"></div>
        <div id="printManagement-view" class="view"></div>
    </div>

    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-none mx-8 max-h-full overflow-y-auto p-6" style="width: 95vw;">
            </div>
    </div>

    <script type="module">
        // --- Theme Management --- (global `state` already declared earlier)
    const applyTheme = (theme) => {
            const themeClasses = ['theme-apple','theme-scifi','theme-ghibli','theme-abstract','theme-colorful','theme-luhong','theme-lugreen','theme-forest','theme-ocean','theme-sunset','theme-midnight','theme-sakura','theme-care-soft','theme-care-fresh','theme-med-clean','theme-med-trust','theme-hotel-lux','theme-hotel-resort','theme-nord','theme-latte','theme-mint','theme-solar','theme-slate','theme-metro','theme-pastel','theme-neon','theme-retro','theme-minimal','theme-paper','theme-grape','theme-cobalt','theme-sand','theme-rosewood','theme-aurora','theme-cocoa','theme-denim','theme-lime','theme-coral','theme-plum','theme-sky','theme-graphite','theme-pearl','theme-rust','theme-berry','theme-moss','theme-teal','theme-sepia','theme-charcoal','theme-ivory','theme-azure','theme-blush','theme-saffron','theme-indigo','theme-copper','theme-lavender','theme-steel','theme-clay','theme-cyan','theme-olive','theme-marigold','theme-orchid','theme-flamingo','theme-iceberg','theme-blossom','theme-jade','theme-cinder','theme-fern','theme-glacier','theme-ember','theme-horizon','theme-canyon','theme-lagoon','theme-meadow','theme-tundra','theme-dune','theme-willow','theme-bronze','theme-silver','theme-gold','theme-amethyst','theme-sapphire','theme-ruby','theme-emerald','theme-topaz','theme-garnet','theme-quartz','theme-onyx','theme-obsidian','theme-smoke','theme-cloud','theme-storm','theme-frost','theme-cherry','theme-espresso','theme-mocha','theme-avocado','theme-banana','theme-plumeria','theme-reef','theme-seafoam','theme-pine','theme-iron','theme-carbon','theme-navy','theme-air','theme-violet','theme-caramel','theme-peach','theme-lilac','theme-rose','theme-magenta','theme-periwinkle','theme-teak'];
            document.body.classList.remove(...themeClasses);
            const allThemes = ['apple','scifi','ghibli','abstract','colorful','luhong','lugreen','forest','ocean','sunset','midnight','sakura','care-soft','care-fresh','med-clean','med-trust','hotel-lux','hotel-resort','nord','latte','mint','solar','slate','metro','pastel','neon','retro','minimal','paper','grape','cobalt','sand','rosewood','aurora','cocoa','denim','lime','coral','plum','sky','graphite','pearl','rust','berry','moss','teal','sepia','charcoal','ivory','azure','blush','saffron','indigo','copper','lavender','steel','clay','cyan','olive','marigold','orchid','flamingo','iceberg','blossom','jade','cinder','fern','glacier','ember','horizon','canyon','lagoon','meadow','tundra','dune','willow','bronze','silver','gold','amethyst','sapphire','ruby','emerald','topaz','garnet','quartz','onyx','obsidian','smoke','cloud','storm','frost','cherry','espresso','mocha','avocado','banana','plumeria','reef','seafoam','pine','iron','carbon','navy','air','violet','caramel','peach','lilac','rose','magenta','periwinkle','teak'];
            if (theme === 'random') {
        const pick = allThemes[Math.floor(Math.random() * allThemes.length)];
        document.body.classList.add('theme-' + pick);
        // å°‡ä¸‹æ‹‰é¸å–®é¡¯ç¤ºåœç•™åœ¨æŠ½åˆ°çš„å¯¦éš›ä¸»é¡Œ
        const sel = document.getElementById('theme-select');
        if (sel) sel.value = pick;
        localStorage.setItem('appTheme', pick);
        state.theme = pick;
        return;
            } else if (theme && theme !== 'default') {
                document.body.classList.add('theme-' + theme);
            }
            localStorage.setItem('appTheme', theme);
            state.theme = theme;
        };

        const loadTheme = () => {
            const savedTheme = localStorage.getItem('appTheme') || 'random';
            applyTheme(savedTheme);
            // è¼‰å…¥ç”³è«‹èœå–®ç‰ˆå‹åå¥½
            const savedLayout = localStorage.getItem('menuLayout');
            if (savedLayout === 'compact' || savedLayout === 'expanded') {
                state.local = { ...state.local, layoutScale: savedLayout };
            }
        };

        // --- å·¥å…·å‡½å¼ ---
        const getISODateString = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getFormattedDateTime = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\//g, '-');
        };
        // é™„ä»¶åˆ—è¡¨å°ˆç”¨ï¼šYYYY/MM/DD - HH:MM:SSï¼ˆé¡¯ç¤ºç§’æ•¸ï¼‰
        const formatAttachmentDate = (timestamp) => {
            if (!timestamp) return '';
            const d = new Date(timestamp);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            const HH = String(d.getHours()).padStart(2, '0');
            const MM = String(d.getMinutes()).padStart(2, '0');
            const SS = String(d.getSeconds()).padStart(2, '0');
            return `${yyyy}/${mm}/${dd} - ${HH}:${MM}:${SS}`;
        };
        // åˆæ­¥è¾¨è­˜æ˜¯å¦åƒ Google Drive æª”æ¡ˆ IDï¼šè‹±æ•¸/åº•ç·š/é€£å­—è™Ÿï¼Œé•·åº¦è¼ƒé•·ï¼Œä¸”æ’é™¤ UUID 8-4-4-4-12 æ ¼å¼
        const isLikelyDriveId = (val) => {
            if (!val || typeof val !== 'string') return false;
            const s = val.trim();
            // æ’é™¤ UUID v4 å¸¸è¦‹æ ¼å¼
            if (/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s)) return false;
            // Drive ID å¸¸è¦‹ç‚º 20~70 å¤šå­—å…ƒï¼Œç”± A-Za-z0-9_- çµ„æˆï¼ˆå¯¦éš›æœƒæ›´å½ˆæ€§ï¼Œé€™è£¡å–å¯¬é¬†åˆ¤å®šï¼‰
            if (!/^[A-Za-z0-9_-]{15,}$/.test(s)) return false;
            return true;
        };
    // å¯é¸çš„åœ–ç‰‡ä»£ç†ï¼ˆä¾‹å¦‚ Supabase Edge Function URLï¼‰ï¼Œè‹¥è¨­å®šå°‡å„ªå…ˆä½¿ç”¨
    const IMAGE_PROXY_BASE = 'https://htamptcakcnlmltwdcog.supabase.co/functions/v1/drive-image';
    // é™„ä»¶ Edge Function åç¨±ï¼ˆè«‹æ–¼ Supabase å°ˆæ¡ˆå»ºç«‹å°æ‡‰å‡½æ•¸ï¼‰
    const ATTACHMENT_UPLOAD_FN = 'upload-request-attachment';
    const ATTACHMENT_SIGNED_URL_FN = 'get-request-attachment-url';
    // æ–°å¢ï¼šé™„ä»¶åˆªé™¤ Edge Function åç¨±
    const ATTACHMENT_DELETE_FN = 'delete-request-attachment';
    const MAX_FILE_SIZE_BYTES = 1 * 1024 * 1024; // 1MB ä¸Šé™ï¼ˆå–®æª”ï¼‰
        
        const showMessage = (message, type = 'success') => {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), type === 'error' ? 8000 : 3000);
        };

        // å…¨åŸŸå·¥ä½œä¸­è¦†è“‹å±¤ï¼ˆé¡¯ç¤ºã€Œè™•ç†è³‡æ–™ä¸­â€¦ã€ï¼‰
        function ensureWorkingOverlay() {
            let ov = document.getElementById('working-overlay');
            if (!ov) {
                ov = document.createElement('div');
                ov.id = 'working-overlay';
                ov.style.position = 'fixed';
                ov.style.inset = '0';
                ov.style.background = 'rgba(0,0,0,0.35)';
                ov.style.display = 'none';
                ov.style.zIndex = '9999';
                ov.style.backdropFilter = 'blur(1px)';
                const inner = document.createElement('div');
                inner.style.position = 'absolute';
                inner.style.top = '50%';
                inner.style.left = '50%';
                inner.style.transform = 'translate(-50%, -50%)';
                inner.style.background = 'white';
                inner.style.color = '#111827';
                inner.style.padding = '14px 18px';
                inner.style.borderRadius = '10px';
                inner.style.boxShadow = '0 10px 25px rgba(0,0,0,0.2)';
                inner.style.fontWeight = '600';
                inner.style.fontSize = '14px';
                inner.innerText = 'è™•ç†è³‡æ–™ä¸­...';
                ov.appendChild(inner);
                document.body.appendChild(ov);
            }
            return ov;
        }
        function showWorking(text = 'è™•ç†è³‡æ–™ä¸­...') {
            const ov = ensureWorkingOverlay();
            if (ov.firstChild) ov.firstChild.textContent = text;
            ov.style.display = 'block';
        }
        function hideWorking() {
            const ov = document.getElementById('working-overlay');
            if (ov) ov.style.display = 'none';
        }

        // å‹•æ…‹è¼‰å…¥ ExcelJSï¼ˆç€è¦½å™¨ç‰ˆï¼‰
        const ensureExcelJSLib = () => new Promise((resolve, reject) => {
            if (window.ExcelJS) return resolve(window.ExcelJS);
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js';
            script.onload = () => resolve(window.ExcelJS);
            script.onerror = () => reject(new Error('ExcelJS è¼‰å…¥å¤±æ•—'));
            document.head.appendChild(script);
        });

    // åŒ¯å‡ºæ™‚çš„åœ–ç‰‡å¿«å–ï¼Œé¿å…é‡è¤‡æŠ“åœ–/è½‰æª”
        const exportImageCache = new Map(); // key: fileId, val: { base64, ext }

        // å°‡ ArrayBuffer è½‰ç‚º base64ï¼ˆå»é™¤ data URL å‰ç¶´ï¼‰
        const arrayBufferToBase64 = (buf, mime) => new Promise((resolve, reject) => {
            try {
                const blob = new Blob([buf], { type: mime || 'application/octet-stream' });
                const reader = new FileReader();
                reader.onload = () => {
                    const dataUrl = reader.result || '';
                    const commaIdx = String(dataUrl).indexOf(',');
                    resolve(commaIdx >= 0 ? String(dataUrl).slice(commaIdx + 1) : String(dataUrl));
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            } catch (e) {
                reject(e);
            }
        });

    // å–®ä½æ›ç®—
    const cmToPx = (cm) => (cm * 96) / 2.54; // 96DPI å‡è¨­

    // å…¼å®¹æ€§ï¼šåŠ å…¥éš±è—æ¬„å¤šè¡Œå…§å®¹ï¼Œä¿ƒä½¿ Excel æ¥å—è‡ªè¨‚åˆ—é«˜
    function applyRowHeightHack(ws, targetPt = 40) {
        try {
            const hackCol = (ws.columnCount || 0) + 1;
            const col = ws.getColumn(hackCol);
            col.width = 1;
            col.hidden = true;
            const approxLine = Math.max(1, Math.ceil(targetPt / 15));
            const val = Array.from({ length: approxLine }).map(() => 'x').join('\n');
            const maxRow = ws.rowCount || 0;
            for (let rowNumber = 1; rowNumber <= maxRow; rowNumber++) {
                const cell = ws.getCell(rowNumber, hackCol);
                cell.value = val;
                cell.alignment = { wrapText: true, vertical: 'top', horizontal: 'left' };
            }
        } catch (_) {}
    }

    // å…¼å®¹æ€§ï¼ˆåŠ å¼·ï¼‰ï¼šåœ¨æ—¢æœ‰å¯è¦‹æ¬„ä½ï¼ˆå…§å®¹çµå°¾ï¼‰æ’å…¥å¤šè¡Œé›¶å¯¬å­—å…ƒï¼Œé€¼è¿« Excel å¯¦éš›æ‹‰é«˜åˆ—é«˜
    function applyRowHeightVisibleHack(ws, targetPt = 40, colIndex = 1) {
        try {
            const approxLine = Math.max(1, Math.ceil(targetPt / 15));
            const zws = '\u200B';
            const suffix = Array.from({ length: approxLine }).map(() => zws).join('\n');
            const maxRow = ws.rowCount || 0;
            for (let rowNumber = 1; rowNumber <= maxRow; rowNumber++) {
                const cell = ws.getCell(rowNumber, colIndex);
                const v = cell.value;
                if (v == null) {
                    cell.value = suffix;
                } else if (typeof v === 'string') {
                    cell.value = v + '\n' + suffix;
                } else {
                    cell.value = String(v) + '\n' + suffix;
                }
                const align = cell.alignment || {};
                cell.alignment = { ...align, wrapText: true, vertical: 'top', horizontal: 'left' };
            }
        } catch (_) {}
    }
    
    // ä»¥å›ºå®šä¸¦ç™¼æ•¸é å–åœ–ç‰‡ï¼ŒåŠ é€Ÿæ•´é«”åŒ¯å‡º
    async function prefetchImages(fileIds, concurrency = 6) {
        const ids = Array.from(new Set((fileIds || []).filter(Boolean)));
        const queue = ids.slice();
        const running = [];
        const launch = () => {
            if (!queue.length) return null;
            const id = queue.shift();
            const p = fetchDriveImageBuffer(id).catch(() => null).finally(() => {
                const i = running.indexOf(p);
                if (i >= 0) running.splice(i, 1);
            });
            running.push(p);
            return p;
        };
        // åˆå§‹ä¸¦ç™¼
        for (let i = 0; i < concurrency; i++) launch();
        while (queue.length || running.length) {
            await Promise.race(running);
            while (running.length < concurrency && queue.length) launch();
        }
    }

    // å°‡ä»»æ„å½±åƒ ArrayBuffer è½‰æˆ PNG ArrayBufferï¼ˆè§£æ±º webp/gif åœ¨ Excel ä¸æ”¯æ´çš„å•é¡Œï¼‰
        const transcodeToPng = async (buf) => {
            const blob = new Blob([buf]);
            // ç›¡é‡ä½¿ç”¨ createImageBitmap + OffscreenCanvasï¼ˆè¼ƒå¿«ï¼‰
            try {
                if (typeof createImageBitmap === 'function') {
                    const bitmap = await createImageBitmap(blob);
                    if (typeof OffscreenCanvas !== 'undefined') {
                        const c = new OffscreenCanvas(bitmap.width || 1, bitmap.height || 1);
                        const ctx = c.getContext('2d');
                        ctx.drawImage(bitmap, 0, 0);
                        const pngBlob = await c.convertToBlob({ type: 'image/png', quality: 0.92 });
                        return await pngBlob.arrayBuffer();
                    } else {
                        // ç€è¦½å™¨ä¸æ”¯æ´ OffscreenCanvasï¼Œé€€å›ä¸€èˆ¬ <canvas>
                        const canvas = document.createElement('canvas');
                        canvas.width = bitmap.width || 1;
                        canvas.height = bitmap.height || 1;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(bitmap, 0, 0);
                        const pngBlob = await new Promise((res) => canvas.toBlob(res, 'image/png', 0.92));
                        return pngBlob ? await pngBlob.arrayBuffer() : buf;
                    }
                }
            } catch (_) { /* å¿½ç•¥ï¼Œæ”¹ç”¨ <img> æ–¹æ¡ˆ */ }

            // å‚³çµ± <img> + <canvas> æ–¹æ¡ˆ
            const img = new Image();
            return await new Promise((resolve, reject) => {
                const url = URL.createObjectURL(blob);
                img.onload = async () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth || 1;
                        canvas.height = img.naturalHeight || 1;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        URL.revokeObjectURL(url);
                        canvas.toBlob(async (pngBlob) => {
                            resolve(pngBlob ? await pngBlob.arrayBuffer() : buf);
                        }, 'image/png', 0.92);
                    } catch (e) {
                        URL.revokeObjectURL(url);
                        resolve(buf);
                    }
                };
                img.onerror = () => {
                    URL.revokeObjectURL(url);
                    resolve(buf);
                };
                img.src = url;
            });
        };

        // ç”±å½±åƒ ArrayBuffer å–å¾—åŸå§‹å¯¬é«˜
        async function getImageDimensions(buf) {
            try {
                const blob = new Blob([buf]);
                if (typeof createImageBitmap === 'function') {
                    const bitmap = await createImageBitmap(blob);
                    return { width: bitmap.width || 0, height: bitmap.height || 0 };
                }
            } catch (_) { /* ignore */ }
            return await new Promise((resolve) => {
                const img = new Image();
                const url = URL.createObjectURL(new Blob([buf]));
                img.onload = () => {
                    const w = img.naturalWidth || 0;
                    const h = img.naturalHeight || 0;
                    URL.revokeObjectURL(url);
                    resolve({ width: w, height: h });
                };
                img.onerror = () => {
                    URL.revokeObjectURL(url);
                    resolve({ width: 0, height: 0 });
                };
                img.src = url;
            });
        }

        // å¾æ¬„ä½å€¼æå– Drive id æˆ–å›å‚³åŸå§‹ url
        const parseDriveRef = (val) => {
            if (!val) return null;
            if (/^https?:\/\//i.test(val)) {
                try {
                    const u = new URL(val);
                    const idParam = u.searchParams.get('id');
                    if (idParam) return { type: 'id', value: idParam };
                    const m1 = u.pathname.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
                    if (m1) return { type: 'id', value: m1[1] };
                    const m2 = u.hostname.includes('googleusercontent.com') && u.pathname.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
                    if (m2) return { type: 'id', value: m2[1] };
                    return { type: 'url', value: val };
                } catch { return { type: 'url', value: val }; }
            }
            return { type: 'id', value: val };
        };

        const looksLikeHtml = (buf) => {
            try {
                const view = new Uint8Array(buf.slice(0, 128));
                const text = Array.from(view).map((b) => String.fromCharCode(b)).join('');
                const lower = text.toLowerCase();
                return lower.includes('<!doctype') || lower.includes('<html');
            } catch { return false; }
        };

        // é©—è­‰æŒ‡å®š Drive æª”æ¡ˆ id æ˜¯å¦çœŸçš„è¢«åˆªé™¤ï¼š
        // é€éç°½åç¶²å€å‡½å¼å˜—è©¦å–å¾—å­˜å–é€£çµï¼›è‹¥ä»å¯å–å›ï¼Œä»£è¡¨å°šæœªåˆªé™¤ã€‚
        async function verifyDriveDeleted(fileId) {
            try {
                const baseUrl = (window.getSupabaseBaseUrl && window.getSupabaseBaseUrl()) || '';
                if (!baseUrl || !fileId) return true; // ç„¡æ³•é©—è­‰å‰‡ä¸æ“‹
                const session = (await supabase.auth.getSession()).data?.session;
                const token = session?.access_token || (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                const apikey = (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                const url = `${baseUrl}/functions/v1/${ATTACHMENT_SIGNED_URL_FN}?id=${encodeURIComponent(fileId)}`;
                const res = await fetch(url, { headers: { Authorization: `Bearer ${token}`, apikey } });
                if (!res.ok) return true; // 4xx/5xx è¦–ç‚ºå·²åˆªï¼ˆæˆ–ä¸å¯å­˜å–ï¼‰
                // å˜—è©¦è§£ææ˜¯å¦çœŸçš„å›å‚³å¯ç”¨é€£çµ
                let body = null;
                try { body = await res.json(); } catch {}
                const link = body && (body.url || body.signedUrl || body.downloadUrl || (typeof body === 'string' ? body : ''));
                if (!link || typeof link !== 'string') return true; // æ²’æœ‰å¯¦éš›é€£çµï¼Œè¦–ç‚ºå·²åˆªæˆ–ä¸å¯å­˜å–
                // è‹¥éœ€è¦æ›´åš´æ ¼ï¼Œå¯å† fetch è©²é€£çµåš HEAD/GETï¼›æ­¤è™•å…ˆä»¥èƒ½å–åˆ°é€£çµè¦–ç‚ºä»å­˜åœ¨
                return false; // ä»å­˜åœ¨
            } catch {
                return true; // é©—è­‰å¤±æ•—ä¸é˜»æ“‹
            }
        }

        // å˜—è©¦ä¾åºä»¥å¤šç¨® URL å–å› Google Drive åœ–ç‰‡ï¼ŒæˆåŠŸå‰‡å›å‚³ { base64, ext, url }
        async function fetchDriveImageBuffer(imageField) {
            if (!imageField) return null;
            const parsed = parseDriveRef(imageField);
            if (!parsed) return null;
            const cacheKey = parsed.type + ':' + parsed.value;
            if (exportImageCache.has(cacheKey)) return exportImageCache.get(cacheKey);

            // ç›¡é‡ä½¿ç”¨ Edge Functionï¼ˆå¯å¸¶å°ºå¯¸åƒæ•¸æ¸›å°‘é«”ç©ï¼‰
            let urls = [];
            if (parsed.type === 'id') {
                const id = parsed.value;
                urls = [
                    ...(IMAGE_PROXY_BASE ? [
                        `${IMAGE_PROXY_BASE}?id=${id}&sz=800`,
                        `${IMAGE_PROXY_BASE}?id=${id}`
                    ] : []),
                    `https://drive.google.com/thumbnail?id=${id}`,
                    `https://drive.google.com/uc?export=download&id=${id}`,
                    `https://drive.google.com/uc?export=view&id=${id}`,
                    `https://drive.google.com/uc?id=${id}`
                ];
            } else {
                const urlVal = parsed.value;
                urls = [
                    ...(IMAGE_PROXY_BASE ? [
                        `${IMAGE_PROXY_BASE}?url=${encodeURIComponent(urlVal)}&sz=800`
                    ] : []),
                    urlVal
                ];
            }

            for (const url of urls) {
                try {
                    const isProxy = IMAGE_PROXY_BASE && url.startsWith(IMAGE_PROXY_BASE);
                    const anon = window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : undefined);
                    const headers = isProxy && anon ? {
                        'Authorization': `Bearer ${anon}`,
                        'apikey': anon
                    } : undefined;
                    const resp = await fetch(url, { headers });
                    if (!resp.ok) continue;
                    const ct = (resp.headers.get('content-type') || '').toLowerCase();
                    let buf = await resp.arrayBuffer();
                    // è‹¥åƒ HTMLï¼ˆé©—è­‰é /éŒ¯èª¤é ï¼‰ï¼Œè·³é
                    if (looksLikeHtml(buf)) continue;

                    let ext = (ct.includes('jpeg') || ct.includes('jpg')) ? 'jpeg'
                             : ct.includes('png') ? 'png'
                             : (ct.includes('webp') ? 'webp' : null);
                    // é jpeg/png ä¸€å¾‹è½‰ pngï¼ˆåŒ…å« webp/gif/æœªçŸ¥ï¼‰
                    if (!ext || (ext !== 'jpeg' && ext !== 'png')) {
                        buf = await transcodeToPng(buf);
                        ext = 'png';
                    }
                    // å–å¾—å¯¬é«˜ï¼ˆä»¥è½‰æª”å¾Œ/æœ€çµ‚çš„ buf ç‚ºæº–ï¼‰
                    const dims = await getImageDimensions(buf).catch(() => ({ width: 0, height: 0 }));
                    const base64 = await arrayBufferToBase64(buf, `image/${ext}`);
                    const out = { base64, ext, url, width: dims.width || 0, height: dims.height || 0 };
                    exportImageCache.set(cacheKey, out);
                    return out;
                } catch (_) { /* ä¸‹ä¸€å€‹ URL */ }
            }
            return null;
        }

    // ä»¥ ExcelJS åŒ¯å‡ºè¨‚å–®ï¼ˆå«åµŒåœ–ï¼‰ï¼›å¤±æ•—è«‹ä¸Ÿå‡ºä¾‹å¤–çµ¦å‘¼å«ç«¯å›é€€
        async function exportOrdersWithExcelJS(flatRows, allProducts, includeImages = true, rowHeightPt = 80) {
            await ensureExcelJSLib();
            const ExcelJS = window.ExcelJS;
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('è¨‚å–®å½™æ•´', { properties: { defaultRowHeight: rowHeightPt } });
            // æ›´æ–°æ¬„ä½ï¼šå°‡ "å» å•†" æ”¹ç‚º "å» å•†ä»£è™Ÿ"ï¼Œæ–°å¢ "å» å•†ç°¡ç¨±" æ¬„ä½æ–¼å³æ–¹ï¼Œä¸¦æ–°å¢ "å•†å“ç·¨è™Ÿ" æ–¼å“åå³æ–¹
            const headers = (includeImages ? ['åœ–ç‰‡'] : []).concat(['ç”³è«‹å–®è™Ÿ','è¨‚å–®é¡åˆ¥','ç”³è«‹æ—¥æœŸ','ç”³è«‹äºº','ç”³è«‹éƒ¨é–€','éœ€æ±‚èª²å®¤','ç™¼ç¥¨é–‹ç«‹','å» å•†ä»£è™Ÿ','å» å•†ç°¡ç¨±','ç°½æ ¸ç‹€æ…‹','ç¶“è¾¦ç‹€æ…‹','çµæ¡ˆç‹€æ…‹','å“å','å•†å“ç·¨è™Ÿ','è¦æ ¼','å–®åƒ¹','å–®ä½','æ•¸é‡','å°è¨ˆ','ç°½æ ¸é€²åº¦']);
            ws.addRow(headers).font = { bold: true };
            ws.getRow(1).height = rowHeightPt;
            ws.columns = (includeImages ? [{ header: 'åœ–ç‰‡', width: 12 }] : []).concat([
                { header: 'ç”³è«‹å–®è™Ÿ', width: 16 }, { header: 'è¨‚å–®é¡åˆ¥', width: 10 },
                { header: 'ç”³è«‹æ—¥æœŸ', width: 18 }, { header: 'ç”³è«‹äºº', width: 12 }, { header: 'ç”³è«‹éƒ¨é–€', width: 12 },
                { header: 'éœ€æ±‚èª²å®¤', width: 12 }, { header: 'ç™¼ç¥¨é–‹ç«‹', width: 12 }, { header: 'å» å•†ä»£è™Ÿ', width: 12 },
                { header: 'å» å•†ç°¡ç¨±', width: 12 }, { header: 'ç°½æ ¸ç‹€æ…‹', width: 10 }, { header: 'ç¶“è¾¦ç‹€æ…‹', width: 10 }, { header: 'çµæ¡ˆç‹€æ…‹', width: 10 },
                { header: 'å“å', width: 20 }, { header: 'å•†å“ç·¨è™Ÿ', width: 14 }, { header: 'è¦æ ¼', width: 20 }, { header: 'å–®åƒ¹', width: 10 },
                { header: 'å–®ä½', width: 8 }, { header: 'æ•¸é‡', width: 8 }, { header: 'å°è¨ˆ', width: 12 }, { header: 'ç°½æ ¸é€²åº¦', width: 24 }
            ]);
            // æ¬„ä½å±¤ç´šå°é½Šèˆ‡æ ¼å¼ï¼Œé¿å…é€æ ¼è¨­å®š
            ws.columns.forEach((c) => { c.alignment = { horizontal: 'left', vertical: 'top', wrapText: true }; });
            const priceCol = headers.indexOf('å–®åƒ¹') + 1;
            const subtotalCol = headers.indexOf('å°è¨ˆ') + 1;
            if (priceCol > 0) ws.getColumn(priceCol).numFmt = '$#,##0.00';
            if (subtotalCol > 0) ws.getColumn(subtotalCol).numFmt = '$#,##0.00';

            const productImageById = {};
            (allProducts || []).forEach(p => { if (p.id && p.image) productImageById[p.id] = p.image; });

            // é å–åœ–ç‰‡ï¼ŒåŠ é€Ÿå¾ŒçºŒåŒ¯å…¥
            if (includeImages) {
                const pimg = {};
                (allProducts || []).forEach(p => { if (p.id && p.image) pimg[p.id] = p.image; });
                const fileIds = flatRows.map(r => (r.product_id && pimg[r.product_id]) ? pimg[r.product_id] : null);
                await prefetchImages(fileIds, 8);
            }

            for (let i = 0; i < flatRows.length; i++) {
                const r = flatRows[i];
                const rowData = (includeImages ? [''] : []).concat([
                    r.id, r.type, r.date, r.applicant, r.department, r.demand_department, r.invoice, r.vendor,
                    r.vendor_short, r.approval, r.handler, r.closed, r.name, r.product_id || '', r.spec, r.price, r.unit, r.quantity, r.subtotal, r.approval_flow
                ]);
                const row = ws.addRow(rowData);
                row.height = rowHeightPt;
                // åœ–ç‰‡æ¬„
                const fileId = includeImages && r.product_id ? productImageById[r.product_id] : null;
                if (fileId && includeImages) {
                    const img = await fetchDriveImageBuffer(fileId);
                    if (img) {
                        const imageId = wb.addImage({ base64: img.base64, extension: img.ext });
                        const rowIdx = row.number; // ç•¶å‰ Excel åˆ—è™Ÿ
                        // ç¸®æ”¾åˆ°æœ€å¤§ 1.2cmï¼ˆå¯¬/é«˜ï¼‰
                        const maxPx = Math.round(cmToPx(1.2));
                        const natW = Math.max(1, img.width || 1);
                        const natH = Math.max(1, img.height || 1);
                        const ratio = Math.min(maxPx / natW, maxPx / natH, 1);
                        const targetW = Math.max(1, Math.round(natW * ratio));
                        const targetH = Math.max(1, Math.round(natH * ratio));
                        // å›ºå®šè¡Œé«˜
                        ws.getRow(rowIdx).height = rowHeightPt;
                        const imgColZeroBased = headers.indexOf('åœ–ç‰‡'); // 0-based already for tl.col
                        const tlCol = (imgColZeroBased >= 0 ? imgColZeroBased : 0) + 0.2;
                        ws.addImage(imageId, {
                            tl: { col: tlCol, row: rowIdx - 0.9 },
                            ext: { width: targetW, height: targetH }
                        });
                    } else {
                        const imgIdx1 = headers.indexOf('åœ–ç‰‡') + 1;
                        if (imgIdx1 > 0) row.getCell(imgIdx1).value = `https://drive.google.com/thumbnail?id=${fileId}`;
                    }
                }
            }

            // å…¼å®¹æ€§ï¼šåŠ å…¥éš±è—æ¬„å¤šè¡Œå…§å®¹ï¼Œä¸¦å†æ¬¡å…¨è¡¨å¥—ç”¨åˆ—é«˜ï¼ˆåŒ…å«ç©ºåˆ—ï¼‰ï¼Œcommitï¼ˆè‹¥å¯ç”¨ï¼‰
            try {
                applyRowHeightHack(ws, rowHeightPt);
                const firstDataCol = includeImages ? 2 : 1;
                applyRowHeightVisibleHack(ws, rowHeightPt, firstDataCol);
                const maxRow = ws.rowCount || 0;
                for (let i = 1; i <= maxRow; i++) {
                    const rr = ws.getRow(i);
                    rr.height = rowHeightPt;
                    if (rr && rr.model) rr.model.customHeight = true;
                    rr.commit?.();
                }
            } catch (_) {}
            const buf = await wb.xlsx.writeBuffer();
            const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            document.body.appendChild(a);
            a.style.display = 'none';
            a.href = url;
            a.download = `è¨‚å–®å½™æ•´_${getISODateString(new Date())}.xlsx`;
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // ä»¥ ExcelJS åŒ¯å‡ºä¾å» å•†å½™æ•´ï¼ˆå«åµŒåœ–ï¼‰ï¼›å¤±æ•—è«‹ä¸Ÿå‡ºä¾‹å¤–çµ¦å‘¼å«ç«¯å›é€€
    async function exportConsolidationWithExcelJS(consolidatedData, allProducts, includeImages = true, rowHeightPt = 80) {
            await ensureExcelJSLib();
            const ExcelJS = window.ExcelJS;
            const wb = new ExcelJS.Workbook();
            // ä¾›å½™ç¸½é ä½¿ç”¨çš„å•†å“åœ–ç‰‡å°ç…§èˆ‡é å–
            const productImageById_SUM = {};
            (allProducts || []).forEach(p => { if (p.id && p.image) productImageById_SUM[p.id] = p.image; });
            if (includeImages) {
                const allIdsSUM = [];
                for (const [, vdata] of Object.entries(consolidatedData)) {
                    for (const it of Object.values(vdata.items)) {
                        if (it.id && productImageById_SUM[it.id]) allIdsSUM.push(productImageById_SUM[it.id]);
                    }
                }
                await prefetchImages(allIdsSUM, 8);
            }

            // å½™ç¸½é ï¼ˆå«åœ–ç‰‡ã€å•†å“ç·¨è™Ÿã€å» å•†ä»£è™Ÿã€å» å•†ç°¡ç¨±ã€ç”³è«‹éƒ¨é–€ã€éœ€æ±‚èª²å®¤ã€ç™¼ç¥¨é–‹ç«‹ ç­‰æ¬„ä½ï¼‰
            const summary = wb.addWorksheet('å½™ç¸½', { properties: { defaultRowHeight: rowHeightPt } });
            const sHeaders = (includeImages ? ['åœ–ç‰‡'] : []).concat(['å•†å“ç·¨è™Ÿ','å» å•†ä»£è™Ÿ','å» å•†ç°¡ç¨±','ç”³è«‹éƒ¨é–€','éœ€æ±‚èª²å®¤','ç™¼ç¥¨é–‹ç«‹','å“å','è¦æ ¼','å–®åƒ¹','å–®ä½','ç¸½æ•¸é‡','å°è¨ˆ']);
            summary.addRow(sHeaders).font = { bold: true };
            summary.getRow(1).height = rowHeightPt;
            summary.columns = (includeImages ? [{ header: 'åœ–ç‰‡', width: 12 }] : []).concat([
                { header: 'å•†å“ç·¨è™Ÿ', width: 14 }, { header: 'å» å•†ä»£è™Ÿ', width: 12 }, { header: 'å» å•†ç°¡ç¨±', width: 12 }, { header: 'ç”³è«‹éƒ¨é–€', width: 12 }, { header: 'éœ€æ±‚èª²å®¤', width: 12 }, { header: 'ç™¼ç¥¨é–‹ç«‹', width: 12 },
                { header: 'å“å', width: 20 }, { header: 'è¦æ ¼', width: 20 }, { header: 'å–®åƒ¹', width: 10 }, { header: 'å–®ä½', width: 8 }, { header: 'ç¸½æ•¸é‡', width: 10 }, { header: 'å°è¨ˆ', width: 12 }
            ]);
            summary.columns.forEach(c => { c.alignment = { horizontal: 'left', vertical: 'top', wrapText: true }; });
            // å–®åƒ¹èˆ‡å°è¨ˆçš„æ ¼å¼ï¼ˆæ ¹æ“šæ–°æ¬„ä½ä½ç½®ï¼‰
            const priceColIdx = sHeaders.indexOf('å–®åƒ¹') + 1;
            const subtotalColIdx = sHeaders.indexOf('å°è¨ˆ') + 1;
            if (priceColIdx > 0) summary.getColumn(priceColIdx).numFmt = '$#,##0.00';
            if (subtotalColIdx > 0) summary.getColumn(subtotalColIdx).numFmt = '$#,##0.00';

            const summaryItems = {};
            Object.entries(consolidatedData).forEach(([vendorKey, vendorData]) => {
                // å°æ–¼æ¯å€‹ vendor çš„ itemsï¼Œå°‡å…¶å±¬æ€§ä¿ç•™ï¼ˆè‹¥å¤šå» å•†åŒä¸€å“é …ï¼Œå…ˆå‡ºç¾è€…çš„å» å•†/ç°¡ç¨±/å•†å“ç·¨è™Ÿç­‰æœƒè¢«ä¿ç•™ï¼‰
                // ç”± vendorKey æ¨æ–·å» å•†ä»£è™Ÿ/ç°¡ç¨±
                const vinfo = (window.state && window.state.vendors) ? window.state.vendors.find(v => v.vendor_id === vendorKey || v.short_name === vendorKey || v.name === vendorKey) : null;
                const vendorCode = vinfo ? vinfo.vendor_id : vendorKey;
                const vendorShort = vinfo ? (vinfo.short_name || vinfo.name || '') : (vendorKey || '');
                Object.values(vendorData.items).forEach(item => {
                    const key = `${item.name}|${item.spec}|${item.price}`;
                    if (!summaryItems[key]) {
                        summaryItems[key] = { ...item, quantity: 0, subtotal: 0 };
                        // å„²å­˜é¦–ç­†å¯ç”¨çš„ vendor è³‡è¨Šï¼ˆç”± vendorKey æ¨æ–·ï¼‰
                        summaryItems[key].vendor_code = vendorCode || '';
                        summaryItems[key].vendor_short = vendorShort || '';
                        summaryItems[key].product_id = item.id || '';
                        // åœ–ç‰‡ä»¥ product_id æŸ¥è¡¨
                        summaryItems[key].department = item.department || (vendorData.department || '');
                        summaryItems[key].demand_department = item.demand_department || '';
                        summaryItems[key].invoice = item.invoice === 'å…¶ä»–' ? (item.custom_invoice || 'å…¶ä»–') : (item.invoice || '');
                    }
                    summaryItems[key].quantity += Number(item.quantity || 0);
                    summaryItems[key].subtotal += Number(item.subtotal || 0);
                });
            });

            let summaryTotal = 0;
            for (const it of Object.values(summaryItems)) {
                const rowData = (includeImages ? [''] : []).concat([
                    it.product_id || '', it.vendor_code || '', it.vendor_short || '', it.department || '', it.demand_department || '', it.invoice || '',
                    it.name || '', it.spec || '', it.price || 0, it.unit || '', it.quantity || 0, it.subtotal || 0
                ]);
                const row = summary.addRow(rowData);
                if (priceColIdx > 0) row.getCell(priceColIdx).numFmt = '$#,##0.00';
                if (subtotalColIdx > 0) row.getCell(subtotalColIdx).numFmt = '$#,##0.00';
                row.height = rowHeightPt;
                // åµŒå…¥åœ–ç‰‡ï¼ˆè‹¥æœ‰ï¼‰
                if (includeImages) {
                    const fileId = it.product_id ? productImageById_SUM[it.product_id] : null;
                    if (fileId) {
                        const img = await fetchDriveImageBuffer(fileId);
                        if (img) {
                            const imageId = wb.addImage({ base64: img.base64, extension: img.ext });
                            const rowIdx = row.number;
                            const maxPx = Math.round(cmToPx(1.2));
                            const natW = Math.max(1, img.width || 1);
                            const natH = Math.max(1, img.height || 1);
                            const ratio = Math.min(maxPx / natW, maxPx / natH, 1);
                            const targetW = Math.max(1, Math.round(natW * ratio));
                            const targetH = Math.max(1, Math.round(natH * ratio));
                            const imgColZeroBased = sHeaders.indexOf('åœ–ç‰‡');
                            const tlCol = (imgColZeroBased >= 0 ? imgColZeroBased : 0) + 0.2;
                            summary.addImage(imageId, { tl: { col: tlCol, row: rowIdx - 0.9 }, ext: { width: targetW, height: targetH } });
                        } else {
                            const imgIdx1 = sHeaders.indexOf('åœ–ç‰‡') + 1;
                            if (imgIdx1 > 0) row.getCell(imgIdx1).value = `https://drive.google.com/thumbnail?id=${fileId}`;
                        }
                    }
                }
                summaryTotal += Number(it.subtotal || 0);
            }
            const blank = summary.addRow([]);
            blank.height = rowHeightPt;
            const trow = summary.addRow([]);
            // å°‡ "ç¸½è¨ˆ" æ¨™ç±¤æ”¾åœ¨å“åæ¬„
            const labelCol = sHeaders.indexOf('å“å') + 1;
            const qtyCol = sHeaders.indexOf('ç¸½æ•¸é‡') + 1;
            const subCol = sHeaders.indexOf('å°è¨ˆ') + 1;
            if (labelCol > 0) trow.getCell(labelCol).value = 'ç¸½è¨ˆ';
            if (qtyCol > 0) trow.getCell(qtyCol).value = Object.values(summaryItems).reduce((s, it) => s + Number(it.quantity || 0), 0);
            if (subCol > 0) trow.getCell(subCol).value = summaryTotal;
            trow.font = { bold: true };
            if (subCol > 0) trow.getCell(subCol).numFmt = '$#,##0.00';
            trow.height = rowHeightPt;

            // å„å» å•†é 
            const productImageById = {};
            (allProducts || []).forEach(p => { if (p.id && p.image) productImageById[p.id] = p.image; });

            // é å–æ‰€æœ‰å» å•†é é¢å¯èƒ½æœƒç”¨åˆ°çš„åœ–ç‰‡
            if (includeImages) {
                const allIds = [];
                for (const [, data] of Object.entries(consolidatedData)) {
                    for (const item of Object.values(data.items)) {
                        if (item.id && productImageById[item.id]) allIds.push(productImageById[item.id]);
                    }
                }
                await prefetchImages(allIds, 8);
            }

            const vendorSheets = [];
            for (const [vendor, data] of Object.entries(consolidatedData)) {
                const ws = wb.addWorksheet(vendor.replace(/[\/\\?*\[\]]/g, ''), { properties: { defaultRowHeight: rowHeightPt } });
                // æ¬„ä½é †åºï¼šåœ–ç‰‡, å» å•†ä»£è™Ÿ, å» å•†ç°¡ç¨±, å•†å“ç·¨è™Ÿ, å“å, è¦æ ¼, å–®åƒ¹, ç¸½æ•¸é‡, å–®ä½, å°è¨ˆ, ç”³è«‹éƒ¨é–€, éœ€æ±‚èª²å®¤, ç™¼ç¥¨é–‹ç«‹
                const vHeaders = (includeImages ? ['åœ–ç‰‡'] : []).concat(['å» å•†ä»£è™Ÿ','å» å•†ç°¡ç¨±','å•†å“ç·¨è™Ÿ','å“å','è¦æ ¼','å–®åƒ¹','ç¸½æ•¸é‡','å–®ä½','å°è¨ˆ','ç”³è«‹éƒ¨é–€','éœ€æ±‚èª²å®¤','ç™¼ç¥¨é–‹ç«‹']);
                ws.addRow(vHeaders).font = { bold: true };
                ws.getRow(1).height = rowHeightPt;
                ws.columns = (includeImages ? [{ header: 'åœ–ç‰‡', width: 12 }] : []).concat([
                    { header: 'å» å•†ä»£è™Ÿ', width: 12 }, { header: 'å» å•†ç°¡ç¨±', width: 12 }, { header: 'å•†å“ç·¨è™Ÿ', width: 14 }, { header: 'å“å', width: 20 }, { header: 'è¦æ ¼', width: 20 }, { header: 'å–®åƒ¹', width: 10 },
                    { header: 'ç¸½æ•¸é‡', width: 10 }, { header: 'å–®ä½', width: 8 }, { header: 'å°è¨ˆ', width: 12 }, { header: 'ç”³è«‹éƒ¨é–€', width: 12 }, { header: 'éœ€æ±‚èª²å®¤', width: 12 }, { header: 'ç™¼ç¥¨é–‹ç«‹', width: 12 }
                ]);
                ws.columns.forEach(c => { c.alignment = { horizontal: 'left', vertical: 'top', wrapText: true }; });
                const priceIdxV = vHeaders.indexOf('å–®åƒ¹') + 1;
                const subtotalIdxV = vHeaders.indexOf('å°è¨ˆ') + 1;
                if (priceIdxV > 0) ws.getColumn(priceIdxV).numFmt = '$#,##0.00';
                if (subtotalIdxV > 0) ws.getColumn(subtotalIdxV).numFmt = '$#,##0.00';
                // å˜—è©¦å¾ state.vendors æ‰¾åˆ°å» å•†ä»£è™Ÿèˆ‡ç°¡ç¨±ï¼ˆvendor æ˜¯ consolidated çš„ keyï¼Œå¯èƒ½ç‚º vendor_id æˆ– short_name/nameï¼‰
                const vendorInfo = (window.state && window.state.vendors) ? window.state.vendors.find(v => v.vendor_id === vendor || v.short_name === vendor || v.name === vendor) : null;
                const vendorCode = vendorInfo ? vendorInfo.vendor_id : vendor;
                const vendorShort = vendorInfo ? (vendorInfo.short_name || vendorInfo.name) : (vendor || '');

                let vendorQtyTotal = 0;
                for (const item of Object.values(data.items)) {
                    const rowData = (includeImages ? [''] : []).concat([
                        vendorCode, vendorShort, item.id || '', item.name, item.spec || '', item.price, item.quantity, item.unit, item.subtotal, item.department || (data.department || ''), item.demand_department || '', item.invoice === 'å…¶ä»–' ? (item.custom_invoice || 'å…¶ä»–') : (item.invoice || '')
                    ]);
                    const row = ws.addRow(rowData);
                    row.height = rowHeightPt;
                    vendorQtyTotal += Number(item.quantity || 0);
                    const fileId = item.id ? productImageById[item.id] : null;
                    if (fileId && includeImages) {
                        const img = await fetchDriveImageBuffer(fileId);
                        if (img) {
                            const imageId = wb.addImage({ base64: img.base64, extension: img.ext });
                            const rowIdx = row.number;
                            const maxPx = Math.round(cmToPx(1.2));
                            const natW = Math.max(1, img.width || 1);
                            const natH = Math.max(1, img.height || 1);
                            const ratio = Math.min(maxPx / natW, maxPx / natH, 1);
                            const targetW = Math.max(1, Math.round(natW * ratio));
                            const targetH = Math.max(1, Math.round(natH * ratio));
                            ws.getRow(rowIdx).height = rowHeightPt;
                            const imgColZeroBased = vHeaders.indexOf('åœ–ç‰‡');
                            const tlCol = (imgColZeroBased >= 0 ? imgColZeroBased : 0) + 0.2;
                            ws.addImage(imageId, {
                                tl: { col: tlCol, row: rowIdx - 0.9 },
                                ext: { width: targetW, height: targetH }
                            });
                        } else {
                            const imgIdxV = vHeaders.indexOf('åœ–ç‰‡') + 1;
                            if (imgIdxV > 0) row.getCell(imgIdxV).value = `https://drive.google.com/thumbnail?id=${fileId}`;
                        }
                    }
                }
                // åŠ å…¥ç¸½è¨ˆåˆ—ï¼šç©ºåˆ— + ç¸½è¨ˆï¼ˆæ•¸é‡èˆ‡é‡‘é¡ï¼‰
                try {
                    const blank = ws.addRow([]);
                    blank.height = rowHeightPt;
                    const labelCol = vHeaders.indexOf('å“å') + 1;
                    const qtyCol = vHeaders.indexOf('ç¸½æ•¸é‡') + 1;
                    const subtotalCol = vHeaders.indexOf('å°è¨ˆ') + 1;
                    const trow = ws.addRow([]);
                    trow.getCell(labelCol).value = 'ç¸½è¨ˆ';
                    trow.getCell(qtyCol).value = vendorQtyTotal;
                    trow.getCell(subtotalCol).value = Number(data.total || 0);
                    trow.font = { bold: true };
                    if (subtotalCol > 0) trow.getCell(subtotalCol).numFmt = '$#,##0.00';
                    trow.height = rowHeightPt;
                } catch (_) {}

                vendorSheets.push(ws);
            }

            // å…¼å®¹æ€§ï¼šåŠ å…¥éš±è—æ¬„èˆ‡å¯è¦‹æ¬„å¤šè¡Œå…§å®¹ï¼Œä¸¦å°å½™ç¸½èˆ‡å„å» å•†è¡¨å…¨è¡¨å¥—ç”¨åˆ—é«˜ï¼ˆåŒ…å«ç©ºåˆ—ï¼‰èˆ‡ commit
            try {
                applyRowHeightHack(summary, rowHeightPt);
                applyRowHeightVisibleHack(summary, rowHeightPt, 1);
                for (let i = 1; i <= (summary.rowCount || 0); i++) {
                    const rr = summary.getRow(i);
                    rr.height = rowHeightPt; if (rr && rr.model) rr.model.customHeight = true; rr.commit?.();
                }
                vendorSheets.forEach(s => {
                    applyRowHeightHack(s, rowHeightPt);
                    const firstDataCol = includeImages ? 2 : 1;
                    applyRowHeightVisibleHack(s, rowHeightPt, firstDataCol);
                    for (let i = 1; i <= (s.rowCount || 0); i++) {
                        const rr = s.getRow(i);
                        rr.height = rowHeightPt; if (rr && rr.model) rr.model.customHeight = true; rr.commit?.();
                    }
                });
            } catch (_) {}

            const buf = await wb.xlsx.writeBuffer();
            const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            document.body.appendChild(a);
            a.style.display = 'none';
            a.href = url;
            a.download = `å» å•†å½™ç¸½è¨‚å–®_${getISODateString(new Date())}.xlsx`;
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        

        const saveFavoritesToDb = async (userId, favoritesSet) => {
            const favoritesArray = Array.from(favoritesSet);
            const { error } = await supabase
                .from('users')
                .update({ favorite_products: favoritesArray })
                .eq('id', userId);
            
            if (error) {
                console.error("Error updating favorites:", error);
                showMessage('æ›´æ–°æˆ‘çš„æœ€æ„›å¤±æ•—: ' + error.message, 'error');
            }
        };

        const validateTaxId = (taxId) => {
            if (!/^\d{8}$/.test(taxId)) return false;
            const multipliers = [1, 2, 1, 2, 1, 2, 4, 1];
            let sum = 0;
            for (let i = 0; i < 8; i++) {
                const product = parseInt(taxId[i]) * multipliers[i];
                sum += Math.floor(product / 10) + (product % 10);
            }
            if (sum % 10 === 0) return true;
            if (taxId[6] === '7' && (sum + 1) % 10 === 0) return true;
            return false;
        };

        // --- å…¨åŸŸå¸¸æ•¸ ---
        const DEMAND_DEPARTMENTS = [
            "æœ¬é¤¨ç”Ÿç¦èª²", "8Cæ¸…ç¦", "7Cæ¸…æ°£", "6Cæ¸…å¿ƒ", "5Cæ¸…å¹³", "3Cæ¸…å®‰", "2Cæ¸…è­·", 
            "2Dæ¸…è­·", "8Dæ¸…æ˜¥", "7Dæ¸…æ—¥", "6Dæ¸…ç…§", "5Dæ¸…é¢¨", "3Dæ¸…æ™¯", "8Eæ¸…å±±", 
            "7Eæ¸…æ³‰", "6Eæ¸…æ°´", "8Eæ¸…æ¸…", "3Eæ¸…æ¶¼", "æ³•äººé¤¨ç”Ÿç¦èª²", "7Gä¸€é¤¨", "7Hä¸€é¤¨", 
            "7Kä¸€é¤¨", "6Gä¸€é¤¨", "6Hä¸€é¤¨", "6Kä¸€é¤¨", "5GäºŒé¤¨", "5HäºŒé¤¨", "5KäºŒé¤¨", 
            "3Gä¸‰é¤¨", "3Hä¸‰é¤¨", "3Kä¸‰é¤¨", "2Gä¸‰é¤¨", "2Hä¸‰é¤¨", "2Kä¸‰é¤¨"
        ];

        // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹èˆ‡è¨­å®š ---
        // --- Supabase API å‘¼å«å‡½å¼ ---
        const { supabase } = window;
        
        let channels = []; // ç”¨ä¾†å­˜æ”¾ real-time channel
        let tempSelections = {
            vendors: new Set(),
            statuses: new Set()
        };

        const loadDashboardData = async (shouldNavigateToDashboard = false, useCache = true) => {
            // æª¢æŸ¥ç·©å­˜
            const cacheKey = 'dashboard_data';
            if (useCache) {
                const cachedData = CacheManager.get(cacheKey);
                if (cachedData) {
                    console.log('ä½¿ç”¨ç·©å­˜çš„å„€è¡¨æ¿è³‡æ–™');
                    Object.assign(state, cachedData);
                    if (shouldNavigateToDashboard) {
                        state.view = 'dashboard';
                    }
                    updateState({ loading: false }); // ç¢ºä¿é‡ç½®è¼‰å…¥ç‹€æ…‹
                    render();
                    return;
                }
            }

            updateState({ loading: true });
            
            // æ¸…ç†èˆŠçš„å³æ™‚é€£æ¥
            channels.forEach(channel => {
                try {
                    supabase.removeChannel(channel);
                } catch (e) {
                    console.warn('æ¸…ç†é »é“æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
                }
            });
            channels = [];

            // é‡è©¦æ©Ÿåˆ¶
            const maxRetries = 3;
            let retryCount = 0;
            
            const loadDataWithRetry = async () => {
                try {
                    // æ‰¹é‡è¼‰å…¥ï¼Œä½†æ·»åŠ è¶…æ™‚æ§åˆ¶
                    const loadPromises = [
                        Promise.race([
                            supabase.from('users').select('*'),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Users timeout')), 10000))
                        ]),
                        Promise.race([
                            supabase.from('categories').select('name'),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Categories timeout')), 10000))
                        ]),
                        Promise.race([
                            supabase.from('departments').select('department, director_threshold'),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Departments timeout')), 10000))
                        ]),
                        Promise.race([
                            supabase.from('products').select('*'),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Products timeout')), 15000))
                        ]),
                        Promise.race([
                            supabase.from('requests').select('*').order('request_date', { ascending: false }).limit(1000), // é™åˆ¶è¼‰å…¥ç­†æ•¸
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Requests timeout')), 15000))
                        ]),
                        Promise.race([
                            supabase.from('notifications').select('*').eq('user_id', state.currentUser.id).order('timestamp', { ascending: false }).limit(50), // é™åˆ¶é€šçŸ¥æ•¸é‡
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Notifications timeout')), 10000))
                        ]),
                        Promise.race([
                            supabase.from('vendors').select('*').order('vendor_id', { ascending: true }),
                            new Promise((_, reject) => setTimeout(() => reject(new Error('Vendors timeout')), 10000))
                        ])
                    ];

                    const [usersRes, categoriesRes, departmentsRes, productsRes, requestsRes, notificationsRes, vendorsRes] = await Promise.all(loadPromises);

                    const results = [usersRes, categoriesRes, departmentsRes, productsRes, requestsRes, notificationsRes, vendorsRes];
                    for (const res of results) {
                        if (res.error) throw res.error;
                    }
                    
                    // è™•ç†è³‡æ–™
                    const usersData = {};
                    usersRes.data.forEach(user => {
                        usersData[user.id] = user;
                    });

                    const categoriesData = categoriesRes.data.map(cat => cat.name);

                    const departmentsData = {};
                    departmentsRes.data.forEach(dept => {
                        departmentsData[dept.department] = dept.director_threshold;
                    });

                    const productsData = {};
                    const allProducts = productsRes.data;
                    allProducts.forEach(product => {
                        const category = product.category;
                        if (!productsData[category]) productsData[category] = [];
                        productsData[category].push(product);
                    });

                    const requests = requestsRes.data;
                    const applicantNotifications = notificationsRes.data;
                    const vendors = vendorsRes.data;

                    const finalStateUpdate = { 
                        users: usersData, 
                        categories: categoriesData, 
                        departments: departmentsData,
                        products: productsData,
                        allProducts,
                        vendors,
                        requests,
                        applicantNotifications,
                        loading: false,
                        error: null
                    };

                    if (shouldNavigateToDashboard) {
                        finalStateUpdate.view = 'dashboard';
                    }

                    // ç·©å­˜æˆåŠŸè¼‰å…¥çš„è³‡æ–™
                    CacheManager.set(cacheKey, {
                        users: usersData,
                        categories: categoriesData,
                        departments: departmentsData,
                        products: productsData,
                        allProducts,
                        vendors,
                        requests,
                        applicantNotifications
                    }, 180000); // 3åˆ†é˜ç·©å­˜

                    updateState(finalStateUpdate);
                    setupRealtimeListeners();

                } catch (err) {
                    console.error(`è¼‰å…¥å„€è¡¨æ¿è³‡æ–™å¤±æ•— (å˜—è©¦ ${retryCount + 1}/${maxRetries}):`, err);
                    
                    if (retryCount < maxRetries - 1) {
                        retryCount++;
                        const delay = Math.min(1000 * Math.pow(2, retryCount), 5000); // æŒ‡æ•¸é€€é¿ï¼Œæœ€å¤§5ç§’
                        console.log(`${delay}ms å¾Œé‡è©¦...`);
                        setTimeout(loadDataWithRetry, delay);
                        return;
                    }
                    
                    // æœ€çµ‚å¤±æ•—
                    updateState({ 
                        error: `è¼‰å…¥è³‡æ–™å¤±æ•—: ${err.message}. è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢ã€‚`, 
                        loading: false 
                    });
                }
            };

            await loadDataWithRetry();
        };
        
        function setupRealtimeListeners() {
            // æ·»åŠ é‡é€£é‚è¼¯
            const setupChannelWithRetry = (channelConfig, maxRetries = 3) => {
                let retryCount = 0;
                
                const createChannel = () => {
                    try {
                        const channel = supabase.channel(channelConfig.name)
                            .on('postgres_changes', channelConfig.config, (payload) => {
                                try {
                                    channelConfig.handler(payload);
                                } catch (err) {
                                    console.error(`è™•ç† ${channelConfig.name} è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤:`, err);
                                }
                            })
                            .subscribe((status) => {
                                if (status === 'SUBSCRIBED') {
                                    console.log(`${channelConfig.name} å³æ™‚ç›£è½å·²é€£æ¥`);
                                    retryCount = 0; // é‡ç½®é‡è©¦è¨ˆæ•¸
                                } else if (status === 'CHANNEL_ERROR') {
                                    console.error(`${channelConfig.name} é »é“éŒ¯èª¤`);
                                    if (retryCount < maxRetries) {
                                        retryCount++;
                                        const delay = 1000 * Math.pow(2, retryCount);
                                        console.log(`${delay}ms å¾Œé‡è©¦é€£æ¥ ${channelConfig.name}...`);
                                        setTimeout(createChannel, delay);
                                    }
                                } else if (status === 'TIMED_OUT') {
                                    console.warn(`${channelConfig.name} é€£æ¥è¶…æ™‚`);
                                    if (retryCount < maxRetries) {
                                        retryCount++;
                                        setTimeout(createChannel, 2000);
                                    }
                                }
                            });
                        
                        channels.push(channel);
                        return channel;
                    } catch (err) {
                        console.error(`å»ºç«‹ ${channelConfig.name} é »é“æ™‚ç™¼ç”ŸéŒ¯èª¤:`, err);
                        if (retryCount < maxRetries) {
                            retryCount++;
                            setTimeout(createChannel, 2000);
                        }
                    }
                };
                
                return createChannel();
            };

            // è¨­å®šå„ç¨®ç›£è½å™¨
            const channelConfigs = [
                {
                    name: 'public:requests',
                    config: { event: '*', schema: 'public', table: 'requests' },
                    handler: (payload) => {
                        console.log('Request change received!', payload);
                        handleRealtimeUpdate(payload, 'requests', 'id');
                    }
                },
                {
                    name: 'public:products',
                    config: { event: '*', schema: 'public', table: 'products' },
                    handler: async (payload) => {
                        console.log('Product change received!', payload);
                        try {
                            // ä½¿ç”¨ç·©å­˜çš„ç¯€æµæ›´æ–°
                            if (!setupRealtimeListeners.productUpdateThrottle) {
                                setupRealtimeListeners.productUpdateThrottle = throttle(async () => {
                                    const { data, error } = await supabase.from('products').select('*');
                                    if (error) {
                                        console.error("å³æ™‚é‡æ–°è¼‰å…¥ç”¢å“å¤±æ•—:", error);
                                        return;
                                    }
                                    
                                    const allProducts = data;
                                    const productsData = {};
                                    allProducts.forEach(product => {
                                        const category = product.category;
                                        if (!productsData[category]) productsData[category] = [];
                                        productsData[category].push(product);
                                    });
                                    
                                    updateState({ allProducts, products: productsData });
                                    
                                    // æ›´æ–°ç·©å­˜
                                    const cachedData = CacheManager.get('dashboard_data');
                                    if (cachedData) {
                                        cachedData.allProducts = allProducts;
                                        cachedData.products = productsData;
                                        CacheManager.set('dashboard_data', cachedData);
                                    }
                                }, 1000);
                            }
                            setupRealtimeListeners.productUpdateThrottle();
                        } catch (err) {
                            console.error("è™•ç†ç”¢å“è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤:", err);
                        }
                    }
                },
                {
                    name: `public:notifications:user_id=eq.${state.currentUser.id}`,
                    config: { event: '*', schema: 'public', table: 'notifications', filter: `user_id=eq.${state.currentUser.id}` },
                    handler: (payload) => {
                        console.log('Notification change received!', payload);
                        handleRealtimeUpdate(payload, 'applicantNotifications', 'id');
                    }
                }
            ];

            // æ‰¹é‡è¨­å®šç›£è½å™¨
            channelConfigs.forEach(config => {
                setupChannelWithRetry(config);
            });
        }

        function handleRealtimeUpdate(payload, stateKey, idField) {
            const currentItems = [...state[stateKey]];
            switch (payload.eventType) {
                case 'INSERT':
                    currentItems.unshift(payload.new);
                    break;
                case 'UPDATE':
                    const indexToUpdate = currentItems.findIndex(item => item[idField] === payload.new[idField]);
                    if (indexToUpdate > -1) {
                        currentItems[indexToUpdate] = payload.new;
                    } else {
                        currentItems.unshift(payload.new);
                    }
                    break;
                case 'DELETE':
                    const indexToDelete = currentItems.findIndex(item => item[idField] === payload.old[idField]);
                    if (indexToDelete > -1) {
                        currentItems.splice(indexToDelete, 1);
                    }
                    break;
            }
            if (stateKey === 'requests') {
                currentItems.sort((a, b) => new Date(b.request_date) - new Date(a.request_date));
            }
            if (stateKey === 'applicantNotifications') {
                currentItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
            updateState({ [stateKey]: currentItems });
        }

        // --- ç‹€æ…‹ç®¡ç†å„ªåŒ– ---
        const updateState = (newState) => {
            const oldView = state.view;
            
            if (newState.local) {
                newState.local = { ...state.local, ...newState.local };
            }

            Object.assign(state, newState);

            if (newState.view && newState.view !== oldView) {
                state.local.selectedRequestIds.clear();
                state.local.currentPage = 1;
                state.local.newRequestCurrentPage = 1;
                // Only clear editingRequest if not navigating to newRequest view
                if (newState.view !== 'newRequest') {
                    state.editingRequest = null; 
                }
                // ä½¿ç”¨ requestAnimationFrame æ‰¹é‡è™•ç†è¦–åœ–æ›´æ–°
                requestAnimationFrame(() => {
                    render();
                });
            } else {
                // ä½¿ç”¨ç¯€æµä¾†é™åˆ¶é‡è¤‡æ¸²æŸ“
                if (!updateState.renderScheduled) {
                    updateState.renderScheduled = true;
                    requestAnimationFrame(() => {
                        render();
                        updateState.renderScheduled = false;
                    });
                }
            }
        };

        // --- å„ªåŒ–å¾Œçš„å…¨åŸŸæ¸²æŸ“å‡½å¼ ---
        const render = (() => {
            let isRendering = false;
            
            return () => {
                // é˜²æ­¢é‡è¤‡æ¸²æŸ“
                if (isRendering) return;
                isRendering = true;
                
                try {
                    const { view, loading, error, currentUser } = state;
                    
                    // æ‰¹é‡ DOM æ›´æ–°
                    const updates = [];
                    
                    const loadingView = document.getElementById('loading-view');
                    if (loadingView) {
                        updates.push(() => {
                            loadingView.style.display = loading ? 'flex' : 'none';
                        });
                    }
                    
                    const errorView = document.getElementById('error-view');
                    if (error && errorView) {
                        updates.push(() => {
                            errorView.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">ç™¼ç”ŸéŒ¯èª¤ï¼</strong><span class="block sm:inline">${error}</span><div class="mt-4"><button onclick="location.reload()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">é‡æ–°è¼‰å…¥</button></div></div>`;
                            errorView.style.display = 'block';
                        });
                    } else if (errorView) {
                        updates.push(() => {
                            errorView.style.display = 'none';
                        });
                    }

                    const views = ['login-view', 'dashboard-view', 'newRequest-view', 'detailView-view', 'productManagement-view', 'productForm-view', 'personalForms-view', 'userManagement-view', 'departmentManagement-view', 'sessionManagement-view', 'userForm-view', 'departmentForm-view', 'vendorManagement-view', 'vendorForm-view', 'printManagement-view'];
                    updates.push(() => {
                        views.forEach(v => {
                            const el = document.getElementById(v);
                            if (el) el.style.display = 'none';
                        });
                    });

                    // åŸ·è¡Œæ‰¹é‡æ›´æ–°
                    updates.forEach(update => update());

                    if (loading || error) return;
                    
                    renderAppHeader();

                    if (!currentUser) {
                        renderLoginView();
                        return;
                    }
                    
                    const viewFnName = `render${view.charAt(0).toUpperCase() + view.slice(1)}`;
                    const renderFn = window[viewFnName];
                    
                    if (typeof renderFn === 'function') {
                        renderFn();
                    }
                } finally {
                    isRendering = false;
                }
            };
        })();
        
        const renderAppHeader = () => {
            const headerEl = document.getElementById('app-header');
            if (!state.currentUser) {
                headerEl.innerHTML = '';
                return;
            }
            headerEl.innerHTML = `
                <div class="bg-white p-2 rounded-md shadow-sm flex items-center justify-end space-x-4 text-sm">
                    <div class="theme-switcher mr-4">
                        <label for="theme-select" class="mr-2 text-gray-600">ç‰ˆé¢é¢¨æ ¼:</label>
                        <select id="theme-select" class="p-1 border rounded-md text-sm">
                            <option value="default">é è¨­</option>
                            <option value="random">*éš¨æ©Ÿ</option>
                            <option value="apple">Apple</option>
                            <option value="scifi">é«˜ç§‘æŠ€</option>
                            <option value="ghibli">å‰åœåŠ›</option>
                            <option value="abstract">è—è¡“</option>
                            <option value="colorful">å¤šå½©</option>
                            <option value="luhong">é­¯ç´…</option>
                            <option value="lugreen">é­¯ç¶ </option>
                            <option value="forest">æ£®æ—</option>
                            <option value="ocean">æµ·æ´‹</option>
                            <option value="sunset">å¤•é™½</option>
                            <option value="midnight">åˆå¤œ</option>
                            <option value="sakura">æ«»èŠ±</option>
                            <option value="care-soft">æº«é¦¨</option>
                            <option value="care-fresh">æ¸…æ–°</option>
                            <option value="med-clean">æ¸…çˆ½</option>
                            <option value="med-trust">ä¿¡ä»»</option>
                            <option value="hotel-lux">å¥¢è¯</option>
                            <option value="hotel-resort">ä¼‘é–’</option>
                            <option value="nord">æ¸…å†·</option>
                            <option value="latte">æ‹¿éµ</option>
                            <option value="mint">è–„è·</option>
                            <option value="solar">æš–é™½</option>
                            <option value="slate">çŸ³æ¿</option>
                            <option value="metro">Metro</option>
                            <option value="pastel">ç²‰å½©</option>
                            <option value="neon">éœ“è™¹</option>
                            <option value="retro">å¾©å¤</option>
                            <option value="minimal">æ¥µç°¡</option>
                            <option value="paper">ç´™æ„Ÿ</option>
                            <option value="grape">è‘¡è„ç´«</option>
                            <option value="cobalt">éˆ·è—</option>
                            <option value="sand">æ²™ä¸˜</option>
                            <option value="rosewood">ç´…æœ¨</option>
                            <option value="aurora">æ¥µå…‰</option>
                            <option value="cocoa">å¯å¯</option>
                            <option value="denim">ä¸¹å¯§</option>
                            <option value="lime">æª¸èŠå§†</option>
                            <option value="coral">çŠç‘š</option>
                            <option value="plum">ææ¢…ç´«</option>
                            <option value="sky">æ™´ç©º</option>
                            <option value="graphite">çŸ³å¢¨</option>
                            <option value="pearl">ç å…‰</option>
                            <option value="rust">éµé½</option>
                            <option value="berry">è“æœ</option>
                            <option value="moss">è‹”è˜š</option>
                            <option value="teal">æ°´é´¨</option>
                            <option value="sepia">æ‡·èˆŠæ£•</option>
                            <option value="charcoal">ç‚­é»‘</option>
                            <option value="ivory">è±¡ç‰™</option>
                            <option value="azure">å¤©è—</option>
                            <option value="blush">è…®ç´…</option>
                            <option value="saffron">ç•ªç´…èŠ±</option>
                            <option value="indigo">é›é’</option>
                            <option value="copper">éŠ…è‰²</option>
                            <option value="lavender">è–°è¡£è‰</option>
                            <option value="steel">é‹¼éµ</option>
                            <option value="clay">é™¶åœŸ</option>
                            <option value="cyan">é’è‰²</option>
                            <option value="olive">æ©„æ¬–</option>
                            <option value="marigold">è¬å£½èŠ</option>
                            <option value="orchid">è˜­èŠ±</option>
                            <option value="flamingo">ç«é¶´</option>
                            <option value="iceberg">å†°å±±</option>
                            <option value="blossom">èŠ±æ¼¾</option>
                            <option value="jade">ç‰ç¿ </option>
                            <option value="cinder">ç…¤ç‚­é»‘</option>
                            <option value="fern">è•¨ç¶ </option>
                            <option value="glacier">å†°å·è—</option>
                            <option value="ember">é¤˜ç‡¼æ©™</option>
                            <option value="horizon">å¤©éš›è—</option>
                            <option value="canyon">å³½è°·æ©™</option>
                            <option value="lagoon">ç¤æ¹–é’</option>
                            <option value="meadow">è‰ç”¸ç¶ </option>
                            <option value="tundra">è‹”åŸè—ç°</option>
                            <option value="dune">æ²™æ¼ æ£•</option>
                            <option value="willow">å‚æŸ³ç¶ </option>
                            <option value="bronze">å¤éŠ…</option>
                            <option value="silver">éŠ€éœœ</option>
                            <option value="gold">éé‡‘</option>
                            <option value="amethyst">ç´«æ°´æ™¶</option>
                            <option value="sapphire">è—å¯¶çŸ³</option>
                            <option value="ruby">ç´…å¯¶çŸ³</option>
                            <option value="emerald">ç¿ ç‰</option>
                            <option value="topaz">é»ƒç‰</option>
                            <option value="garnet">çŸ³æ¦´ç´…</option>
                            <option value="quartz">çŸ³è‹±é’</option>
                            <option value="onyx">ç¸ç‘ªç‘™</option>
                            <option value="obsidian">é»‘æ›œçŸ³</option>
                            <option value="smoke">ç…™ç°</option>
                            <option value="cloud">é›²ç™½</option>
                            <option value="storm">é¢¨æš´ç°</option>
                            <option value="frost">éœœè—</option>
                            <option value="cherry">æ«»æ¡ƒç²‰</option>
                            <option value="espresso">æ¿ƒç¸®å’–å•¡</option>
                            <option value="mocha">æ‘©å¡</option>
                            <option value="avocado">é…ªæ¢¨ç¶ </option>
                            <option value="banana">é¦™è•‰é»ƒ</option>
                            <option value="plumeria">é›è›‹èŠ±</option>
                            <option value="reef">çŠç‘šç¤è—</option>
                            <option value="seafoam">æµ·æ²«ç¶ </option>
                            <option value="pine">æ¾é‡ç¶ </option>
                            <option value="iron">éµç°</option>
                            <option value="carbon">ç¢³é»‘</option>
                            <option value="navy">æµ·è»è—</option>
                            <option value="air">ç©ºæ°£è—</option>
                            <option value="violet">ç´«ç¾…è˜­</option>
                            <option value="caramel">ç„¦ç³–</option>
                            <option value="peach">èœœæ¡ƒ</option>
                            <option value="lilac">ä¸é¦™ç´«</option>
                            <option value="rose">ç«ç‘°</option>
                            <option value="magenta">æ´‹ç´…</option>
                            <option value="periwinkle">é•·æ˜¥èŠ±</option>
                            <option value="teak">æŸšæœ¨</option>
                        </select>
                    </div>
                    <button data-view="personalForms" class="view-switch-btn text-blue-600 hover:underline">å€‹äººè¡¨å–®ç®¡ç†</button>
                    <div id="notification-bell-container" class="flex items-center space-x-2 relative"></div>
                    <span class="text-gray-600">æ­¡è¿, ${state.currentUser.name} (${state.currentUser.role})</span>
                    <button data-action="edit-profile" class="text-blue-600 hover:underline">å€‹äººè¨­å®š</button>
                    <button id="change-password-btn" class="text-blue-600 hover:underline">ä¿®æ”¹å¯†ç¢¼</button>
                    <button id="logout-btn" class="text-red-600 hover:underline">ç™»å‡º</button>
                </div>`;
            renderNotifications();
            document.getElementById('theme-select').value = state.theme;
        };

        const renderNotifications = () => {
            const bellContainer = document.getElementById('notification-bell-container');
            if (!bellContainer) return;

            const pendingForMe = state.requests.filter(req => {
                if (!req.approvers) return false;
                const nextApprover = req.approvers.find(a => a.status === 'pending');
                return req.status === 'å¾…å¯©æ ¸' && nextApprover && nextApprover.userId === state.currentUser.id;
            });
            // å¾…æˆ‘ç¶“è¾¦ï¼šå·²æ ¸å‡†ä¸”å¾…ç¶“è¾¦ï¼Œè§’è‰²æˆ–æŒ‡æ´¾å…è¨±ï¼Œä¸”æœªçµæ¡ˆ
            const toHandle = state.requests.filter(req => {
                const effective = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                const roleOk = (state.currentUser.id === req.handler_id) || state.currentUser.is_admin || ['æ¡è³¼','æ¡è³¼ä¸»ç®¡'].includes(state.currentUser.role);
                const notClosed = req.closed_status !== 'çµæ¡ˆ';
                return req.status === 'å·²æ ¸å‡†' && effective === 'å¾…ç¶“è¾¦' && roleOk && notClosed;
            });
            // å¾…æˆ‘çµæ¡ˆï¼šå·²æ ¸å‡†ä¸”å·²ç¶“è¾¦ï¼Œè§’è‰²å…è¨±ï¼Œä¸”æœªçµæ¡ˆ
            const toClose = state.requests.filter(req => {
                const effective = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                const roleOk = state.currentUser.is_admin || ['æ¡è³¼','æ¡è³¼ä¸»ç®¡'].includes(state.currentUser.role);
                const notClosed = req.closed_status !== 'çµæ¡ˆ';
                return req.status === 'å·²æ ¸å‡†' && effective === 'å·²ç¶“è¾¦' && roleOk && notClosed;
            });
            
            const myNotifications = state.applicantNotifications.filter(n => n.user_id === state.currentUser.id);
            const unreadMyNotifications = myNotifications.filter(n => !n.is_read);

            const totalUnreadCount = pendingForMe.length + toHandle.length + toClose.length + unreadMyNotifications.length;

            let bellHTML = `
                <div id="notification-bell" class="relative cursor-pointer">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    ${totalUnreadCount > 0 ? `<span class="absolute top-0 right-0 -mt-1 -mr-1 flex justify-center items-center h-4 w-4 rounded-full bg-red-500 text-white text-xs pointer-events-none"></span>` : ''}
                </div>
            `;
            
            if (totalUnreadCount > 0) {
                bellHTML += `<span class="text-red-500 font-bold text-xs">${totalUnreadCount}</span>`;
            }

            if (pendingForMe.length > 0 || toHandle.length > 0 || toClose.length > 0 || myNotifications.length > 0) {
                let dropdownHTML = `<div id="notification-dropdown" class="hidden absolute right-0 top-full mt-2 w-80 bg-white rounded-md shadow-lg z-20 border max-h-96 overflow-y-auto"><ul>`;
                
                if (pendingForMe.length > 0) {
                    dropdownHTML += `<li class="p-2 bg-gray-100 font-bold text-gray-800">å¾…æˆ‘ç°½æ ¸ (${pendingForMe.length})</li>`;
                    pendingForMe.forEach(req => {
                        dropdownHTML += `
                            <li class="p-2 border-b hover:bg-gray-100 flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full bg-blue-500 flex-shrink-0"></span>
                                <a href="#" data-action="view-notification-detail" data-id="${req.id}" class="min-w-0 flex-grow">
                                    <p class="text-sm text-gray-800 whitespace-normal">${req.id}</p>
                                    <span class="text-xs font-normal text-gray-600">ä¾†è‡ª ${state.users[req.applicant_id]?.name || 'æœªçŸ¥'} ã®ç”³è«‹</span>
                                </a>
                            </li>`;
                    });
                }

                if (toHandle.length > 0) {
                    dropdownHTML += `<li class="p-2 bg-gray-100 font-bold text-gray-800">å¾…æˆ‘ç¶“è¾¦ (${toHandle.length})</li>`;
                    toHandle.forEach(req => {
                        dropdownHTML += `
                            <li class="p-2 border-b hover:bg-gray-100 flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full bg-amber-500 flex-shrink-0"></span>
                                <a href="#" data-action="view-notification-detail" data-id="${req.id}" class="min-w-0 flex-grow">
                                    <p class="text-sm text-gray-800 whitespace-normal">${req.id}</p>
                                    <span class="text-xs font-normal text-gray-600">å·²æ ¸å‡†ï¼Œå¾…æ‚¨ç¶“è¾¦</span>
                                </a>
                            </li>`;
                    });
                }

                if (toClose.length > 0) {
                    dropdownHTML += `<li class="p-2 bg-gray-100 font-bold text-gray-800">å¾…æˆ‘çµæ¡ˆ (${toClose.length})</li>`;
                    toClose.forEach(req => {
                        dropdownHTML += `
                            <li class="p-2 border-b hover:bg-gray-100 flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full bg-purple-500 flex-shrink-0"></span>
                                <a href="#" data-action="view-notification-detail" data-id="${req.id}" class="min-w-0 flex-grow">
                                    <p class="text-sm text-gray-800 whitespace-normal">${req.id}</p>
                                    <span class="text-xs font-normal text-gray-600">å·²ç¶“è¾¦ï¼Œå¾…æ‚¨çµæ¡ˆ</span>
                                </a>
                            </li>`;
                    });
                }

                if (myNotifications.length > 0) {
                    const unreadCount = myNotifications.filter(n => !n.is_read).length;
                    dropdownHTML += `<li class="p-2 bg-gray-100 font-bold text-gray-800 flex items-center justify-between">
                        <span>è¡¨å–®é€²åº¦æ›´æ–°</span>
                        ${unreadCount > 0 ? `<button class="text-xs text-blue-600 hover:underline" data-action="mark-all-read-updates">ä¸€éµå…¨è®€ (${unreadCount})</button>` : ''}
                    </li>`;
                    myNotifications.forEach(n => {
                        dropdownHTML += `
                            <li class="p-2 border-b hover:bg-gray-100 flex items-start space-x-2">
                                <span class="w-2 h-2 rounded-full ${!n.is_read ? 'bg-blue-500' : 'bg-transparent'} mt-1.5 flex-shrink-0"></span>
                                <a href="#" data-action="view-notification-detail" data-id="${n.request_id}" data-notification-id="${n.id}" class="min-w-0 flex-grow">
                                    <p class="whitespace-normal text-sm text-gray-800">${n.message}</p>
                                    <span class="text-xs text-gray-400">${getFormattedDateTime(n.timestamp)}</span>
                                </a>
                            </li>`;
                    });
                }

                dropdownHTML += `</ul></div>`;
                bellHTML += dropdownHTML;
            }
            bellContainer.innerHTML = bellHTML;
        };


        const renderLoginView = () => {
            const viewEl = document.getElementById('login-view');
            const rememberedAccount = getCookieSync('rememberedAccount') || '';
            const isGoogleSites = location.hostname.includes('sites.google.com');
            
            viewEl.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold text-center mb-6">ç‰¹æ¡ç³»çµ±ç™»å…¥</h2>
                        ${isGoogleSites ? '<div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-800">âš¡ Google Sites ç’°å¢ƒï¼šä½¿ç”¨ LocalStorage å¯¦ç¾è¨˜æ†¶ç™»å…¥åŠŸèƒ½</div>' : ''}
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="account" class="block text-sm font-medium text-gray-700">å¸³è™Ÿ (å·¥è™Ÿã€ID æˆ– Email)</label>
                                <input type="text" id="account" name="account" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value="${rememberedAccount}">
                            </div>
                            <div class="mb-4">
                                <label for="password" class="block text-sm font-medium text-gray-700">å¯†ç¢¼</label>
                                <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="mb-6 flex items-center">
                                <input type="checkbox" id="rememberMe" name="rememberMe" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" ${rememberedAccount ? 'checked' : ''}>
                                <label for="rememberMe" class="text-sm text-gray-700">è¨˜ä½æˆ‘çš„ç™»å…¥è³‡è¨Š (30å¤©)</label>
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">ç™»å…¥</button>
                            ${rememberedAccount ? '<p class="text-xs text-gray-500 mt-2 text-center">å·²è‡ªå‹•å¡«å…¥ä¸Šæ¬¡ç™»å…¥çš„å¸³è™Ÿ</p>' : ''}
                        </form>
                    </div>
                </div>`;
            viewEl.style.display = 'block';
        };

        // --- è¦–åœ–æ¸²æŸ“å™¨ ---
        window.renderDashboard = () => {
            const viewEl = document.getElementById('dashboard-view');
            
            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ currentUser å­˜åœ¨
            if (!state.currentUser) {
                console.warn('âš ï¸ [Dashboard] state.currentUser ä¸å­˜åœ¨ï¼Œä½¿ç”¨é è¨­å€¼');
                state.currentUser = {
                    id: 'auto_login_user',
                    name: 'è‡ªå‹•ç™»å…¥ä½¿ç”¨è€…',
                    role: 'ä½¿ç”¨è€…',
                    department: 'æœªçŸ¥éƒ¨é–€',
                    is_admin: false
                };
            }
            
            const { currentUser } = state;
            const isPurchasing = currentUser.role === 'æ¡è³¼' || currentUser.role === 'æ¡è³¼ä¸»ç®¡' || currentUser.is_admin;
            const isAdmin = currentUser.is_admin;
            const isPendingForMeView = state.local.dashboardFilters.permission === 'pending_for_me';
            const hasSelection = state.local.selectedRequestIds.size > 0;
            
            if (!state.local.dashboardFilters.dateFrom) {
                const now = new Date();
                const firstDay = new Date(2025, 6, 1); // July is month 6
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                state.local.dashboardFilters.dateFrom = getISODateString(firstDay);
                state.local.dashboardFilters.dateTo = getISODateString(lastDay);
            }

            if (!state.local.dashboardFilters.permission) {
                state.local.dashboardFilters.permission = 'pending_for_me';
            }

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex flex-nowrap justify-between items-center sticky top-0 z-10 gap-4">
                    <h1 class="text-2xl font-bold text-gray-700 whitespace-nowrap flex-shrink-0">ç‰¹åˆ¥æ¡è³¼å–®</h1>
                    <div class="header-toolbar flex items-center flex-nowrap space-x-4 overflow-x-auto whitespace-nowrap flex-1 min-w-0">
                        <div class="flex items-center space-x-2">
                            <input type="text" id="dashboard-search-input" placeholder="æœå°‹æ‰€æœ‰æ¬„ä½..." class="h-10 w-40 md:w-56 lg:w-64 px-3 border border-gray-300 rounded-l-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" value="${state.local.dashboardFilters.searchTerm || ''}" autocomplete="off" spellcheck="false" />
                            <button data-action="search-dashboard" class="h-10 px-4 bg-blue-600 text-white rounded-r-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition-colors duration-200">GO</button>
                        </div>
                        ${isPendingForMeView ? `
                            <button data-action="batch-approve" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" ${!hasSelection ? 'disabled' : ''}>æ‰¹æ¬¡æ ¸å‡†</button>
                            <button data-action="batch-reject" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed" ${!hasSelection ? 'disabled' : ''}>æ‰¹æ¬¡é€€å›</button>
                        ` : ''}
                        ${isPurchasing ? `
                            <button data-action="batch-close" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-500 text-white hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed" ${!hasSelection ? 'disabled' : ''}>æ‰¹æ¬¡çµæ¡ˆ</button>
                        ` : ''}
                        <button data-action="refresh" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-500 text-white hover:bg-indigo-600">é‡æ–°æ•´ç†</button>
                        ${(isPurchasing || currentUser.is_admin) ? `
                            <button data-action="consolidate-by-vendor" class="px-4 py-2 rounded-md font-semibold text-sm bg-teal-600 text-white hover:bg-teal-700">ä¾å» å•†å½™æ•´</button>
                            <button data-action="export" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">åŒ¯å‡ºè¨‚å–®</button>
                        ` : ''}
                        ${isAdmin ? '<button data-view="departmentManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">éƒ¨é–€ç®¡ç†</button>' : ''}
                        ${isAdmin ? '<button data-view="userManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">ä½¿ç”¨è€…ç®¡ç†</button>' : ''}
                        ${isAdmin ? '<button data-view="sessionManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-orange-500 text-white hover:bg-orange-600">æœƒè©±ç®¡ç†</button>' : ''}
                        ${(isPurchasing || currentUser.is_admin) ? `
                            <button data-view="vendorManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å» å•†ç®¡ç†</button>
                            <button data-view="productManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å•†å“ç®¡ç†</button>
                            <button data-view="printManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-purple-600 text-white hover:bg-purple-700">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                </svg>
                                è¡¨å–®åˆ—å°ä½œæ¥­
                            </button>
                        ` : ''}
                        <button data-view="newRequest" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            æ–°å¢ç”³è«‹
                        </button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div id="dashboard-filters" class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6 pb-6 border-b border-gray-200"></div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"></thead>
                            <tbody id="dashboard-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                        <div id="dashboard-hover-popover" class="hover-popover"></div>
                    </div>
                    <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm"></div>
                </div>`;
            
            renderDashboardFilters();
            renderDashboardTable();
            viewEl.style.display = 'block';
            
            // å„ªåŒ–æœå°‹åŠŸèƒ½
            setTimeout(() => {
                const searchInput = document.getElementById('dashboard-search-input');
                if (searchInput && !searchInput.dataset.optimized) {
                    searchInput.dataset.optimized = 'true';
                    
                    // é˜²æŠ–æœå°‹è™•ç†å™¨
                    if (!window.dashboardSearchDebounce) {
                        window.dashboardSearchDebounce = debounce((searchTerm) => {
                            state.local.selectedRequestIds.clear();
                            state.local.currentPage = 1;
                            state.local.dashboardFilters.searchTerm = searchTerm;
                            renderDashboardTable();
                        }, 300);
                    }
                    
                    // å³æ™‚æœå°‹åŠŸèƒ½
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.trim();
                        window.dashboardSearchDebounce(searchTerm);
                    });
                    
                    // Enter éµå¿«é€Ÿæœå°‹
                    searchInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const searchTerm = e.target.value.trim();
                            state.local.selectedRequestIds.clear();
                            state.local.currentPage = 1;
                            state.local.dashboardFilters.searchTerm = searchTerm;
                            renderDashboardTable();
                        }
                        
                        // ESC éµæ¸…ç©ºæœå°‹
                        if (e.key === 'Escape') {
                            e.target.value = '';
                            state.local.dashboardFilters.searchTerm = '';
                            renderDashboardTable();
                        }
                    });
                    
                    // æœå°‹æ¡†ç²å¾—ç„¦é»æ™‚çš„å„ªåŒ–
                    searchInput.addEventListener('focus', () => {
                        searchInput.select();
                    });
                }
            }, 0);
        };

        const renderMultiSelect = (filterKey, placeholder, options) => {
            const selectedItems = state.local.dashboardFilters[filterKey] || new Set();
            
            const selectedLabels = options
                .filter(opt => selectedItems.has(opt.value))
                .map(opt => opt.label);

            const displayValue = selectedItems.size > 2 
                ? `${placeholder} (${selectedItems.size} å·²é¸)` 
                : (selectedItems.size > 0 ? selectedLabels.join(', ') : placeholder);

            return `
                <div class="relative multi-select-container">
                    <button data-filter-key="${filterKey}" class="multi-select-toggle w-full p-2 border border-gray-300 rounded-md shadow-sm text-left truncate">${displayValue}</button>
                    <div class="multi-select-dropdown hidden absolute z-10 w-full bg-white border rounded-md shadow-lg mt-1">
                        <input type="text" class="multi-select-search w-full p-2 border-b" placeholder="æœå°‹...">
                        <ul class="max-h-40 overflow-y-auto">
                            ${options.map(option => `
                                <li>
                                    <label class="flex items-center p-2 hover:bg-gray-100">
                                        <input type="checkbox" class="multi-select-checkbox" data-filter-key="${filterKey}" value="${option.value}">
                                        <span class="ml-2 text-sm">${option.label}</span>
                                    </label>
                                </li>
                            `).join('')}
                        </ul>
                        <div class="p-2 border-t flex justify-between items-center bg-gray-50">
                            <div>
                                <button data-action="select-all-multi" data-filter-key="${filterKey}" class="text-xs text-blue-600 hover:underline">å…¨é¸</button>
                                <button data-action="deselect-all-multi" data-filter-key="${filterKey}" class="text-xs text-blue-600 hover:underline ml-2">å…¨ä¸é¸</button>
                            </div>
                            <div>
                                <button data-action="cancel-multi-select" class="px-3 py-1 text-xs rounded-md bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                                <button data-action="confirm-multi-select" data-filter-key="${filterKey}" class="px-3 py-1 text-xs rounded-md bg-blue-600 text-white hover:bg-blue-700 ml-2">ç¢ºå®š</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        const renderDashboardFilters = () => {
            const container = document.getElementById('dashboard-filters');
            if(!container) return;
            const filters = state.local.dashboardFilters;
            const dateFrom = filters.dateFrom;
            const dateTo = filters.dateTo;

            const { currentUser } = state;
            const isPurchasing = currentUser.role === 'æ¡è³¼' || currentUser.role === 'æ¡è³¼ä¸»ç®¡' || currentUser.is_admin;
            const isBasicUser = currentUser.role === 'ä½¿ç”¨è€…';
            let permissionOptions = `
                <option value="my">æˆ‘ç”³è«‹çš„è¨‚å–®</option>
                <option value="pending_for_me">å¾…æˆ‘ç°½æ ¸çš„å–®æ“š</option>
                <option value="approved_by_me">æˆ‘ç°½æ ¸éçš„</option>
                <option value="rejected_by_me">æˆ‘é€€å›ç°½æ ¸çš„</option>
            `;
            if (currentUser.is_department_head) {
                permissionOptions += `<option value="department">æˆ‘çš„éƒ¨é–€è¨‚å–®</option>`;
            }
            if (isPurchasing || currentUser.is_admin) {
                permissionOptions += `<option value="to_handle">å¾…æˆ‘ç¶“è¾¦çš„è¡¨å–®</option>`;
                permissionOptions += `<option value="to_close">å¾…æˆ‘çµæ¡ˆçš„è¡¨å–®</option>`;
                permissionOptions += `<option value="all">æ‰€æœ‰è¨‚å–®</option>`;
            }

            const vendorOptions = state.vendors.map(v => ({
                value: v.vendor_id,
                label: `${v.short_name || v.name || v.vendor_id}`
            }));
            const allStatuses = ['å¾…é€å‡º', 'å¾…å¯©æ ¸', 'å·²æ ¸å‡†', 'å·²é€€å›'].map(s => ({ value: s, label: s }));

            // ç³»çµ±ç®¡ç†å“¡éœ€å¯è¦‹å» å•†ç¯©é¸ï¼›å³ä¾¿è§’è‰²ç‚ºã€Œä½¿ç”¨è€…ã€ä½† is_admin ç‚ºçœŸä¹Ÿé¡¯ç¤º
            const vendorFilterHTML = (isBasicUser && !currentUser.is_admin) ? '' : `
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å» å•†</label>
                    ${renderMultiSelect('vendors', 'é¸æ“‡å» å•†', vendorOptions)}
                </div>`;

            container.innerHTML = `
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æª¢è¦–æ¬Šé™</label>
                    <select data-filter="permission" class="filter-change w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        ${permissionOptions}
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸå€é–“</label>
                    <div class="flex items-center">
                        <input type="text" id="dashboard-date-range" class="w-full h-10 px-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="é¸æ“‡æ—¥æœŸå€é–“" autocomplete="off" />
                    </div>
                </div>
                ${vendorFilterHTML}
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç°½æ ¸ç‹€æ…‹</label>
                     ${renderMultiSelect('statuses', 'é¸æ“‡ç°½æ ¸ç‹€æ…‹', allStatuses)}
                </div>
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç¶“è¾¦ç‹€æ…‹</label>
                     ${renderMultiSelect('handlerStatuses', 'é¸æ“‡ç¶“è¾¦ç‹€æ…‹', [
                         { value: 'æœªç¶“è¾¦', label: 'æœªç¶“è¾¦' },
                         { value: 'å¾…ç¶“è¾¦', label: 'å¾…ç¶“è¾¦' },
                         { value: 'å·²ç¶“è¾¦', label: 'å·²ç¶“è¾¦' }
                     ])}
                </div>
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">çµæ¡ˆç‹€æ…‹</label>
                     ${renderMultiSelect('closedStatuses', 'é¸æ“‡çµæ¡ˆç‹€æ…‹', [
                         { value: 'çµæ¡ˆ', label: 'çµæ¡ˆ' },
                         { value: 'æœªçµæ¡ˆ', label: 'æœªçµæ¡ˆ' }
                     ])}
                </div>
                
            `;
            container.querySelector('[data-filter="permission"]').value = filters.permission || 'my';

            // åˆå§‹åŒ–æ—¥æœŸå€é–“ flatpickrï¼ˆå‹•æ…‹è¼‰å…¥ï¼Œé¿å…å¤–éƒ¨ä¾è³´å¤±æ•—ï¼‰
            (function initDateRangePicker() {
                const input = container.querySelector('#dashboard-date-range');
                if (!input) return;

                // å¦‚æœå·²æœ‰å€¼ï¼Œé¡¯ç¤ºæˆå‹å–„æ ¼å¼ï¼›åˆå§‹åŒ–äº¤ç”± flatpickr altInput è™•ç†
                const { dateFrom, dateTo } = filters;

                function loadScript(src, id) {
                    return new Promise((resolve, reject) => {
                        if (id && document.getElementById(id)) return resolve();
                        const s = document.createElement('script');
                        s.src = src; s.async = true; if (id) s.id = id;
                        s.onload = resolve; s.onerror = () => reject(new Error('Failed to load ' + src));
                        document.head.appendChild(s);
                    });
                }
                function loadStyle(href, id) {
                    return new Promise((resolve, reject) => {
                        if (id && document.getElementById(id)) return resolve();
                        const l = document.createElement('link');
                        l.rel = 'stylesheet'; l.href = href; if (id) l.id = id;
                        l.onload = resolve; l.onerror = () => reject(new Error('Failed to load ' + href));
                        document.head.appendChild(l);
                    });
                }

                function boot() {
                    try {
                        const localeObj = (window.flatpickr && window.flatpickr.l10ns && window.flatpickr.l10ns.zh_tw) ? window.flatpickr.l10ns.zh_tw : 'zh_tw';
                        const fp = window.flatpickr(input, {
                            mode: 'range',
                            locale: localeObj,
                            dateFormat: 'Y-m-d',         // å­˜å…¥å€¼ï¼ˆå…§éƒ¨ï¼‰
                            altInput: true,
                            altFormat: 'Yå¹´næœˆjæ—¥',       // é¡¯ç¤ºç”¨ï¼ˆç¹ä¸­ï¼‰
                            altInputClass: 'w-full h-10 px-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200',
                            allowInput: true,
                            clickOpens: true,
                            showMonths: 1,               // å–®æ¬„
                            defaultDate: (dateFrom && dateTo) ? [dateFrom, dateTo] : null,
                            onOpen: (selectedDates, dateStr, instance) => {
                                // æ¯æ¬¡æ‰“é–‹éƒ½å¾æ–°é¸å–èµ·è¨–
                                instance.clear();
                            },
                            onChange: (selectedDates) => {
                                // åƒ…åœ¨é¸æ»¿èµ·è¨–å…©æ—¥å¾Œå¥—ç”¨ç¯©é¸
                                if (selectedDates.length === 2) {
                                    const [start, end] = selectedDates;
                                    state.local.dashboardFilters.dateFrom = getISODateString(start);
                                    state.local.dashboardFilters.dateTo = getISODateString(end);
                                    state.local.currentPage = 1;
                                    renderDashboard();
                                }
                            }
                        });
                    } catch (err) {
                        console.error('flatpickr åˆå§‹åŒ–å¤±æ•—:', err);
                    }
                }

                const tasks = [];
                if (!window.flatpickr) {
                    tasks.push(loadStyle('https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css', 'flatpickr-css'));
                    tasks.push(loadScript('https://cdn.jsdelivr.net/npm/flatpickr', 'flatpickr-js'));
                }
                Promise.all(tasks).then(() => {
                    // ä¸€å¾‹å˜—è©¦è¼‰å…¥ç¹ä¸­åœ¨åœ°åŒ–ï¼Œå†åˆå§‹åŒ–
                    loadScript('https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js', 'flatpickr-zh-tw')
                        .then(boot)
                        .catch(() => boot());
                }).catch(() => {
                    // è‹¥è¼‰å…¥å¤±æ•—ï¼Œé€€å›åŸç”Ÿæ—¥æœŸæ¬„ä½ï¼ˆæœ€å°æ”¹å‹•ï¼‰
                    input.type = 'date';
                    input.value = dateFrom || '';
                    input.classList.add('filter-change');
                    input.dataset.filter = 'dateFrom';
                });
            })();
        };

    const getFilteredRequests = (() => {
            let lastFilters = null;
            let lastResult = [];

            const func = () => {
                const { currentUser, requests } = state;
                const { dashboardFilters, sortKey, sortDirection } = state.local;
                
                const filtersForCache = {
                    ...dashboardFilters,
                    vendors: [...(dashboardFilters.vendors || [])].sort(),
                    statuses: [...(dashboardFilters.statuses || [])].sort(),
                    closedStatuses: [...(dashboardFilters.closedStatuses || [])].sort(),
                    handlerStatuses: [...(dashboardFilters.handlerStatuses || [])].sort(),
                };

                const currentFilters = JSON.stringify({
                    filters: filtersForCache,
                    sortKey,
                    sortDirection,
                    reqCount: requests.length,
                    userId: currentUser.id
                });

                if (currentFilters === lastFilters) {
                    return lastResult;
                }

                let baseRequests;
                const permission = dashboardFilters.permission || 'my';

                switch(permission) {
                    case 'my': baseRequests = requests.filter(req => req.applicant_id === currentUser.id); break;
                    case 'pending_for_me': 
                        baseRequests = requests.filter(req => {
                            if (!req.approvers) return false;
                            const nextApprover = req.approvers.find(a => a.status === 'pending');
                            return req.status === 'å¾…å¯©æ ¸' && nextApprover && nextApprover.userId === currentUser.id;
                        });
                        break;
                    case 'approved_by_me': baseRequests = requests.filter(req => (req.approvers || []).some(a => a.userId === currentUser.id && a.status === 'approved')); break;
                    case 'rejected_by_me': baseRequests = requests.filter(req => (req.approvers || []).some(a => a.userId === currentUser.id && a.status === 'rejected')); break;
                    case 'to_handle':
                        baseRequests = requests.filter(req => {
                            // å·²æ ¸å‡†ä¸”å¾…ç¶“è¾¦ï¼Œä¸”ä½¿ç”¨è€…æ˜¯è¢«æŒ‡æ´¾ç¶“è¾¦æˆ–æ¡è³¼/ç®¡ç†è€…
                            const effective = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                            const roleOk = (currentUser.id === req.handler_id) || currentUser.role === 'æ¡è³¼' || currentUser.role === 'æ¡è³¼ä¸»ç®¡' || currentUser.is_admin;
                            const notClosed = req.closed_status !== 'çµæ¡ˆ';
                            return effective === 'å¾…ç¶“è¾¦' && roleOk && notClosed;
                        });
                        break;
                    case 'to_close':
                        baseRequests = requests.filter(req => {
                            // å·²ç¶“è¾¦ä¸”æœªçµæ¡ˆï¼Œé€šå¸¸ç”±æ¡è³¼è§’è‰²æˆ–ç®¡ç†è€…çµæ¡ˆ
                            const effective = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                            const roleOk = currentUser.role === 'æ¡è³¼' || currentUser.role === 'æ¡è³¼ä¸»ç®¡' || currentUser.is_admin;
                            const notClosed = req.closed_status !== 'çµæ¡ˆ';
                            return effective === 'å·²ç¶“è¾¦' && notClosed && roleOk;
                        });
                        break;
                    case 'department': baseRequests = currentUser.is_department_head ? requests.filter(req => req.department === currentUser.department) : requests.filter(req => req.applicant_id === currentUser.id); break;
                    case 'all': 
                        // ç®¡ç†è€…ã€æ¡è³¼ä¸»ç®¡çš„"æ‰€æœ‰è¨‚å–®"æ¬Šé™èˆ‡æ¡è³¼ç›¸åŒ
                        const canSeeAllOrders = currentUser.role === 'æ¡è³¼' || currentUser.role === 'æ¡è³¼ä¸»ç®¡' || currentUser.is_admin;
                        baseRequests = canSeeAllOrders ? requests : requests.filter(req => req.applicant_id === currentUser.id); 
                        break;
                    default: baseRequests = requests.filter(req => req.applicant_id === currentUser.id);
                }

                const { dateFrom, dateTo, vendors: selectedVendorIds = new Set(), statuses = new Set(), closedStatuses = new Set(), handlerStatuses = new Set(), searchTerm = '' } = dashboardFilters;
                const lowerCaseSearchTerm = searchTerm.toLowerCase();


                // åªç”¨ vendor_id åšç¯©é¸
                let filtered = baseRequests.filter(req => {
                    const requestDate = req.request_date ? getISODateString(req.request_date) : '';
                    if (dateFrom && dateTo && (requestDate < dateFrom || requestDate > dateTo)) return false;
                    if (selectedVendorIds.size > 0) {
                        const hasMatchingVendor = (req.items || []).some(item => selectedVendorIds.has(item.vendor));
                        if (!hasMatchingVendor) return false;
                    }
                    if (statuses.size > 0 && !statuses.has(req.status)) return false;
                    if (closedStatuses.size > 0) {
                        let hasMatchingClosedStatus = false;
                        for (const closedStatus of closedStatuses) {
                            if (closedStatus === 'çµæ¡ˆ' && req.closed_status === 'çµæ¡ˆ') {
                                hasMatchingClosedStatus = true;
                                break;
                            } else if (closedStatus === 'æœªçµæ¡ˆ' && (req.closed_status !== 'çµæ¡ˆ' || !req.closed_status)) {
                                hasMatchingClosedStatus = true;
                                break;
                            }
                        }
                        if (!hasMatchingClosedStatus) return false;
                    }
                    if (handlerStatuses.size > 0) {
                        const effectiveHandler = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                        if (!handlerStatuses.has(effectiveHandler)) return false;
                    }
                    if (lowerCaseSearchTerm && !JSON.stringify(req).toLowerCase().includes(lowerCaseSearchTerm)) return false;
                    return true;
                });

                if (sortKey) {
                    filtered.sort((a, b) => {
                        let valA = a[sortKey];
                        let valB = b[sortKey];

                        if (sortKey === 'applicant_id') {
                            valA = state.users[valA]?.name || '';
                            valB = state.users[valB]?.name || '';
                        } else if (sortKey === 'type') {
                            // è¨‚å–®é¡åˆ¥æ’åºï¼šç‰¹æ¡ < å°ˆæ¡ˆï¼Œå…¶é¤˜ä¾å­—æ¯
                            const order = { 'ç‰¹æ¡': 0, 'å°ˆæ¡ˆ': 1 };
                            valA = order[a.type] ?? 9;
                            valB = order[b.type] ?? 9;
                        } else if (sortKey === 'handler_status') {
                            const order = { 'æœªç¶“è¾¦': 0, 'å¾…ç¶“è¾¦': 1, 'å·²ç¶“è¾¦': 2 };
                            const effA = a.handler_status || (a.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                            const effB = b.handler_status || (b.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                            valA = order[effA] ?? 0;
                            valB = order[effB] ?? 0;
                        } else if (sortKey === 'closed_status') {
                            // æœªçµæ¡ˆ < çµæ¡ˆ
                            const map = (v) => (v === 'çµæ¡ˆ' ? 1 : 0);
                            valA = map(a.closed_status);
                            valB = map(b.closed_status);
                        }

                        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                lastFilters = currentFilters;
                lastResult = filtered;
                return filtered;
            };

            func.resetCache = () => {
                lastFilters = null;
            };

            return func;
        })();

    const renderDashboardTable = () => {
            const tableBody = document.getElementById('dashboard-table-body');
            if (!tableBody) return;
            const tableHead = tableBody.previousElementSibling;
            
            // æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ç·©å­˜çš„éæ¿¾çµæœ
            const filteredRequests = getFilteredRequests();
            const { currentPage, itemsPerPage } = state.local;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedRequests = filteredRequests.slice(startIndex, endIndex);

            const renderSortIcon = (key) => {
                if (state.local.sortKey !== key) return `<span class="sort-icon">â–²â–¼</span>`;
                return state.local.sortDirection === 'asc' ? `<span class="sort-icon">â–²</span>` : `<span class="sort-icon">â–¼</span>`;
            };

            // æ¯æ¬¡éƒ½é‡ç¹ªè¡¨é ­ï¼Œç¢ºä¿æ’åºç®­é ­æ­£ç¢º
            if (tableHead) {
                tableHead.innerHTML = `
                    <tr>
                        <th class="p-4 relative">
                            <div class="group inline-block">
                                <button class="border px-2 py-1 rounded transition-colors duration-200 hover:bg-gray-50">é¸å–</button>
                                <div class="absolute hidden group-hover:block bg-white shadow-md rounded-md mt-1 border z-10">
                                    <a href="#" data-action="select-page" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150">å…¨é¸æ­¤é </a>
                                    <a href="#" data-action="select-all-filtered" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150">å…¨é¸æ‰€æœ‰</a>
                                    <a href="#" data-action="deselect-all" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150">å–æ¶ˆé¸å–</a>
                                </div>
                            </div>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'id' ? 'active' : ''}" data-action="sort" data-sort-key="id">ç”³è«‹å–®è™Ÿ ${renderSortIcon('id')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'applicant_id' ? 'active' : ''}" data-action="sort" data-sort-key="applicant_id">ç”³è«‹äºº ${renderSortIcon('applicant_id')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'request_date' ? 'active' : ''}" data-action="sort" data-sort-key="request_date">ç”³è«‹æ—¥æœŸ ${renderSortIcon('request_date')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'department' ? 'active' : ''}" data-action="sort" data-sort-key="department">ç§‘å®¤ ${renderSortIcon('department')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'type' ? 'active' : ''}" data-action="sort" data-sort-key="type">è¨‚å–®é¡åˆ¥ ${renderSortIcon('type')}</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'total_amount' ? 'active' : ''}" data-action="sort" data-sort-key="total_amount">ç¸½é‡‘é¡ ${renderSortIcon('total_amount')}</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'status' ? 'active' : ''}" data-action="sort" data-sort-key="status">ç°½æ ¸ç‹€æ…‹ ${renderSortIcon('status')}</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'handler_status' ? 'active' : ''}" data-action="sort" data-sort-key="handler_status">ç¶“è¾¦ç‹€æ…‹ ${renderSortIcon('handler_status')}</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable cursor-pointer hover:bg-gray-50 transition-colors duration-150 ${state.local.sortKey === 'closed_status' ? 'active' : ''}" data-action="sort" data-sort-key="closed_status">çµæ¡ˆç‹€æ…‹ ${renderSortIcon('closed_status')}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç°½æ ¸é€²åº¦</th>
                    </tr>
                `;
            }

            // å„ªåŒ–è¡¨æ ¼è¡Œæ¸²æŸ“ - ä½¿ç”¨æ‰¹é‡è™•ç†å’Œé æ§‹å»ºæ¨£å¼
            const statusStylesCache = {
                'å¾…é€å‡º': 'bg-gray-100 text-gray-800', 
                'å¾…å¯©æ ¸': 'bg-yellow-100 text-yellow-800', 
                'å·²æ ¸å‡†': 'bg-green-100 text-green-800', 
                'å·²é€€å›': 'bg-red-100 text-red-800'
            };
            const closedStatusStylesCache = {
                'æœªçµæ¡ˆ': 'bg-blue-100 text-blue-800', 
                'çµæ¡ˆ': 'bg-gray-300 text-gray-800'
            };
            const handlerStatusStylesCache = {
                'æœªç¶“è¾¦': 'bg-neutral-100 text-neutral-800',
                'å¾…ç¶“è¾¦': 'bg-amber-100 text-amber-800',
                'å·²ç¶“è¾¦': 'bg-green-100 text-green-800'
            };
            const orderTypeStylesCache = {
                'ç‰¹æ¡': 'bg-pink-100 text-pink-800',
                'å°ˆæ¡ˆ': 'bg-teal-100 text-teal-800'
            };

            // ä½¿ç”¨ DocumentFragment é€²è¡Œæ‰¹é‡ DOM æ›´æ–°
            if (paginatedRequests.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="11" class="text-center py-10 text-gray-500">ç„¡ç¬¦åˆæ¢ä»¶çš„ç”³è«‹å–®</td></tr>`;
            } else {
                // é è™•ç†æ•¸æ“šä»¥é¿å…é‡è¤‡è¨ˆç®—
                        const processedRows = paginatedRequests.map(req => {
                    const approvers = req.approvers || [];
                    const approverStatus = approvers.map(a => `${a.role}: ${a.status === 'approved' ? 'âœ”ï¸' : a.status === 'rejected' ? 'âŒ' : 'â€¦'}`).join(' | ');
                    const approverTooltip = approvers.map(a => {
                        const userName = state.users[a.userId]?.name || (a.userId ? a.userId.substring(0,8) : '');
                        const stat = a.status === 'approved' ? 'å·²æ ¸å‡†' : (a.status === 'rejected' ? 'å·²é€€å›' : 'å¾…ç°½æ ¸');
                        const t = a.date ? `ï¼ˆ${getFormattedDateTime(a.date)}ï¼‰` : '';
                        return `${a.role} - ${stat}${t}${userName ? ` by ${userName}` : ''}`;
                    }).join('\n');
                    const isChecked = state.local.selectedRequestIds.has(req.id);
                    const userName = state.users[req.applicant_id]?.name || 'æœªçŸ¥';
                    const formattedAmount = Number(req.total_amount).toLocaleString();
                    const formattedDate = getFormattedDateTime(req.request_date);
                    
                    // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç°½æ ¸
                    const nextApprover = approvers.find(a => a.status === 'pending');
                    const canApprove = req.status === 'å¾…å¯©æ ¸' && 
                                      nextApprover && 
                                      nextApprover.userId === state.currentUser.id;
                    
                    return {
                        id: req.id,
                        userName,
                        formattedDate,
                        department: req.department,
                        orderType: req.type || 'ç‰¹æ¡',
                        formattedAmount,
                        status: req.status,
                        hasAttachments: Array.isArray(req.attachments) && req.attachments.length > 0,
                        handlerStatus: req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦'),
                        closedStatus: req.closed_status || 'æœªçµæ¡ˆ',
                        approverStatus,
                        approverTooltip,
                        isChecked,
                        canApprove,
                        statusStyle: statusStylesCache[req.status] || 'bg-gray-100 text-gray-800',
                        handlerStatusStyle: handlerStatusStylesCache[req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦')] || 'bg-gray-100 text-gray-800',
                        closedStatusStyle: closedStatusStylesCache[req.closed_status] || '',
                        orderTypeStyle: orderTypeStylesCache[req.type || 'ç‰¹æ¡'] || 'bg-gray-100 text-gray-800'
                    };
                });

                // æ‰¹é‡ç”Ÿæˆ HTML
                const rowsHTML = processedRows.map(row => `
                    <tr class="hover:bg-gray-50 transition-colors duration-150">
                        <td class="p-4"><input type="checkbox" class="request-checkbox rounded focus:ring-2 focus:ring-blue-500" data-id="${row.id}" ${row.isChecked ? 'checked' : ''} /></td>
                        <td class="px-6 py-4 text-sm text-blue-600 font-medium">
                            <a href="#" data-id="${row.id}" data-action="view-detail" class="hover:text-blue-900 transition-colors duration-150 inline-flex items-center whitespace-nowrap align-middle">
                                <span class="request-id-hover" data-request-id="${row.id}">${row.id}</span>
                                ${row.hasAttachments ? '<span class="ml-1 text-gray-500" title="å«é™„ä»¶">ğŸ“</span>' : ''}
                            </a>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">${row.userName}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${row.formattedDate}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${row.department}</td>
                        <td class="px-6 py-4 text-left">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${row.orderTypeStyle}">${row.orderType}</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 text-right font-medium">$${row.formattedAmount}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${row.statusStyle}">${row.status}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${row.handlerStatusStyle}">${row.handlerStatus}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${row.closedStatusStyle}">${row.closedStatus}</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500"><span title="${row.approverTooltip}">${row.approverStatus}</span></td>
                    </tr>
                `).join('');

                // ä½¿ç”¨ requestAnimationFrame ä¾†å„ªåŒ–æ¸²æŸ“
                requestAnimationFrame(() => {
                    tableBody.innerHTML = rowsHTML;
                });
            }

            // åˆ†é æ§åˆ¶é …æ¸²æŸ“å„ªåŒ–
            requestAnimationFrame(() => {
                renderPaginationControls(filteredRequests.length);
            });
        };

        const renderPaginationControls = (totalItems) => {
            const controlsContainer = document.getElementById('pagination-controls');
            if (!controlsContainer) return;

            const { currentPage, itemsPerPage } = state.local;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (totalPages <= 1) {
                controlsContainer.innerHTML = '';
                return;
            }

            let buttonsHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const isCurrent = i === currentPage;
                buttonsHTML += `<button data-action="go-to-page" data-page="${i}" class="${isCurrent ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'} px-3 py-1 border border-gray-300 rounded-md">${i}</button>`;
            }

            controlsContainer.innerHTML = `
                <div class="text-gray-600">
                    å…± ${totalItems} ç­†è³‡æ–™ï¼Œç›®å‰åœ¨ç¬¬ ${currentPage} / ${totalPages} é 
                </div>
                <div class="flex items-center space-x-2">
                    <button data-action="go-to-page" data-page="${currentPage - 1}" class="px-3 py-1 border rounded-md disabled:opacity-50" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é </button>
                    ${buttonsHTML}
                    <button data-action="go-to-page" data-page="${currentPage + 1}" class="px-3 py-1 border rounded-md disabled:opacity-50" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é </button>
                </div>
            `;
        };
        
        window.renderNewRequest = function() {
            const viewEl = document.getElementById('newRequest-view');
            const categories = ['æˆ‘çš„æœ€æ„›', 'è³¼è²·éçš„', 'å…¨å“é …', ...Object.keys(state.products)];
            const activeCategory = state.local.activeProductCategory || 'æˆ‘çš„æœ€æ„›';
            const isEditingDraft = !!state.editingRequest;
            const layoutScale = state.local.layoutScale || 'expanded';
            // è‹¥ç‚ºç·¨è¼¯è‰ç¨¿ä¸”æœ¬åœ°é™„ä»¶æ¸…å–®ç‚ºç©ºï¼Œé å¡«è‰ç¨¿é™„ä»¶
            if (isEditingDraft && (!state.local.newRequestAttachments || state.local.newRequestAttachments.length === 0)) {
                state.local.newRequestAttachments = [...(state.editingRequest.attachments || [])];
            }
            
            // æ ¹æ“šç¸®æ”¾ç‹€æ…‹è¨­å®šå¯¬åº¦æ¯”ä¾‹
            const leftWidth = layoutScale === 'expanded' ? 'lg:w-2/3' : 'lg:w-1/3';
            const rightWidth = layoutScale === 'expanded' ? 'lg:w-1/3' : 'lg:w-2/3';

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-4">
                        <h1 class="text-2xl font-bold text-gray-700">${isEditingDraft ? `ç·¨è¼¯è‰ç¨¿: ${state.editingRequest.id}` : 'ç‰¹æ¡ç‰©å“ç”³è«‹èœå–®'}</h1>
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl font-bold text-blue-700">ç‰ˆå‹:</span>
                            <button data-action="toggle-layout-scale" data-scale="expanded" class="flex items-center gap-2 px-3 py-1 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors ${layoutScale === 'expanded' ? 'bg-blue-600 text-white' : 'bg-white text-blue-700 border border-blue-300 hover:bg-blue-50'}" title="å±•é–‹å•†å“æ¸…å–® (å·¦ 2/3 | å³ 1/3)">
                                <svg width="24" height="16" viewBox="0 0 24 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <rect x="1" y="1" width="14" height="14" rx="2" fill="currentColor" opacity="0.35"/>
                                    <rect x="17" y="1" width="6" height="14" rx="2" fill="currentColor" opacity="0.8"/>
                                </svg>
                                <span>æ¸…å–®è¼ƒå¯¬</span>
                            </button>
                            <button data-action="toggle-layout-scale" data-scale="compact" class="flex items-center gap-2 px-3 py-1 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-300 transition-colors ${layoutScale === 'compact' ? 'bg-amber-600 text-white' : 'bg-white text-amber-700 border border-amber-300 hover:bg-amber-50'}" title="å£“ç¸®å•†å“æ¸…å–® (å·¦ 1/3 | å³ 2/3)">
                                <svg width="24" height="16" viewBox="0 0 24 16" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <rect x="1" y="1" width="6" height="14" rx="2" fill="currentColor" opacity="0.8"/>
                                    <rect x="9" y="1" width="14" height="14" rx="2" fill="currentColor" opacity="0.35"/>
                                </svg>
                                <span>æ¸…å–®è¼ƒçª„</span>
                            </button>
                        </div>
                    </div>
                    <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                </div>
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="${leftWidth}">
                        <div class="bg-white shadow-md rounded-lg p-6">
                        <div class="mb-4 border-b border-gray-200">
                            <nav class="product-categories -mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                                ${categories.map(cat => `<button data-category="${cat}" data-action="switch-category" class="product-category-btn ${cat === activeCategory ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">${cat}</button>`).join('')}
                            </nav>
                        </div>
                            <div class="flex items-center gap-4 mb-4">
                                <input type="text" id="new-request-product-search" placeholder="æœå°‹å•†å“..." class="w-full p-2 border border-gray-300 rounded-md" value="${state.local.newRequestSearchTerm || ''}">
                                <button data-action="search-new-request-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">æœå°‹</button>
                                <label class="flex items-center text-sm whitespace-nowrap">
                                    <input type="checkbox" id="new-request-search-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${state.local.newRequestSearchAll ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-700">æœå°‹å…¨åˆ†é¡</span>
                                </label>
                            </div>
                            <div class="product-list grid ${layoutScale === 'compact' ? 'grid-cols-2' : 'grid-cols-4'} gap-6"></div>
                            <div id="product-list-pagination" class="mt-6 flex justify-center items-center"></div>
                        </div>
                    </div>
                    <div class="${rightWidth}">
                        <div id="new-request-sidebar" class="bg-white shadow-md rounded-lg p-6 sticky top-24"></div>
                    </div>
                </div>`;
            renderProductList();
            renderNewRequestSidebar();
            viewEl.style.display = 'block';
        };

        const renderProductList = () => {
            const productListEl = document.querySelector('#newRequest-view .product-list');
            if (!productListEl) return;
            
            const { activeProductCategory, newRequestSearchTerm, newRequestSearchAll, layoutScale } = state.local;
            const searchTerm = (newRequestSearchTerm || '').toLowerCase();

            let productsToSearch = [];
            if (newRequestSearchAll) {
                productsToSearch = state.allProducts;
            } else {
                if (activeProductCategory === 'æˆ‘çš„æœ€æ„›') {
                    productsToSearch = state.allProducts.filter(p => state.local.favoriteProductIds.has(p.id));
                } else if (activeProductCategory === 'è³¼è²·éçš„') {
                    const purchasedProductIds = new Set();
                    state.requests
                        .filter(req => req.applicant_id === state.currentUser.id && req.status === 'å·²æ ¸å‡†')
                        .forEach(req => {
                            (req.items || []).forEach(item => purchasedProductIds.add(item.id));
                        });
                    productsToSearch = state.allProducts.filter(p => purchasedProductIds.has(p.id));
                } else if (activeProductCategory === 'å…¨å“é …' || !activeProductCategory) {
                    productsToSearch = state.allProducts;
                } else {
                    productsToSearch = state.products[activeProductCategory] || [];
                }
            }

            let displayProducts = productsToSearch;
            if (searchTerm) {
                displayProducts = productsToSearch.filter(p => {
                    const { image, ...searchableProduct } = p; // Exclude image URL from search
                    return Object.values(searchableProduct).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                });
            }

            const paginationEl = document.getElementById('product-list-pagination');

            if (displayProducts.length === 0) {
                productListEl.innerHTML = `<p class="text-gray-500 col-span-full text-center">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å•†å“</p>`;
                if (paginationEl) paginationEl.innerHTML = '';
                return;
            }

            const { newRequestCurrentPage = 1 } = state.local;
            const itemsPerPage = 12;
            const totalItems = displayProducts.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (newRequestCurrentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedProducts = displayProducts.slice(startIndex, endIndex);

            productListEl.innerHTML = paginatedProducts.map(p => {
                const imageUrl = p.image 
                    ? `https://drive.google.com/thumbnail?id=${p.image}` 
                    : 'https://placehold.co/150x150?text=ç„¡åœ–ç‰‡';
                const vendorName = state.vendors.find(v => v.vendor_id === p.vendor)?.short_name || p.vendor || 'N/A';
                return `
                <div class="border rounded-lg p-4 flex flex-col items-center text-center shadow-sm relative">
                    <button data-action="toggle-favorite" data-product-id="${p.id}" class="absolute top-2 right-2 text-gray-300 hover:text-yellow-500">
                        <svg class="w-5 h-5 ${state.local.favoriteProductIds.has(p.id) ? 'text-yellow-400' : ''}" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                        </svg>
                    </button>
                    <img src="${imageUrl}" alt="${p.name}" class="w-24 h-24 object-cover mb-2 rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/150x150?text=åœ–ç‰‡éŒ¯èª¤';"/>
                    <h3 class="font-semibold text-sm">${p.name}</h3>
                    <p class="text-xs text-gray-500">${p.spec || ''}</p>
                    <p class="text-xs text-gray-500">å» å•†: ${vendorName}</p>
                    <p class="text-sm font-bold my-1">${p.price || 0}/${p.unit}</p>
                    <div class="flex items-center mt-2">
                        <input type="number" min="1" data-id="${p.id}" class="product-quantity-input w-16 text-center border-gray-300 rounded-md shadow-sm" value="1" />
                        <button data-product='${JSON.stringify(p)}' data-action="add-to-cart" class="add-to-cart-btn ml-2 p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">+</button>
                    </div>
                </div>`}).join('');
            
            if (paginationEl) {
                if (totalPages <= 1) {
                    paginationEl.innerHTML = '';
                } else {
                    paginationEl.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <button data-action="product-page-change" data-page="${newRequestCurrentPage - 1}" class="px-4 py-2 border rounded-md disabled:opacity-50" ${newRequestCurrentPage === 1 ? 'disabled' : ''}>
                                ä¸Šä¸€é 
                            </button>
                            <span class="text-gray-700">
                                ç¬¬ ${newRequestCurrentPage} / ${totalPages} é 
                            </span>
                            <button data-action="product-page-change" data-page="${newRequestCurrentPage + 1}" class="px-4 py-2 border rounded-md disabled:opacity-50" ${newRequestCurrentPage === totalPages ? 'disabled' : ''}>
                                ä¸‹ä¸€é 
                            </button>
                        </div>
                    `;
                }
            }
        };

        const renderNewRequestSidebar = () => {
            const sidebarEl = document.getElementById('new-request-sidebar');
            if (!sidebarEl) return;
            const cart = state.local.newRequestCart;
            const totalAmount = Math.round(cart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)) + (item.freight || 0) + (item.discount || 0), 0));
            const isEditingDraft = !!state.editingRequest;
            const layoutScale = state.local.layoutScale || 'expanded';
            const itemCount = cart.length;
            const totalQuantity = cart.reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);
            // è¨‚å–®é¡åˆ¥ï¼ˆé è¨­ç‰¹æ¡ï¼›è‰ç¨¿æ²¿ç”¨åŸå€¼ï¼›å¦‚æœ‰æœ¬åœ°é¸æ“‡å‰‡è¦†è“‹ï¼‰
            const orderType = (state.local.newRequestOrderType !== undefined)
                ? state.local.newRequestOrderType
                : (isEditingDraft ? (state.editingRequest.type || 'ç‰¹æ¡') : 'ç‰¹æ¡');
            const orderTypeBadgeClass = orderType === 'ç‰¹æ¡' ? 'bg-pink-100 text-pink-800' : 'bg-teal-100 text-teal-800';

            const cartItemsHTML = () => {
                if (cart.length === 0) return `<p class="text-gray-500 text-center py-8">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>`;
                // å–®ä¸€é …ç›®çš„å…§å®¹ï¼ˆä¸å« li/div å¤–å±¤ï¼‰
                const renderCartItemInner = (item) => {
                    const reasonOptions = ['æ–°å¢', 'ä¿®ç¹•', 'å ±å»¢', 'å…¶ä»–'];
                    return `
                        <div class="flex items-start w-full">
                            <div class="w-1/3 flex items-start space-x-2">
                                <div class="flex flex-col items-start space-y-2">
                                    <img src="${state.allProducts.find(p => p.id === item.id)?.image ? `https://drive.google.com/thumbnail?id=${state.allProducts.find(p => p.id === item.id).image}` : 'https://placehold.co/50x50?text=ç„¡åœ–ç‰‡'}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/50x50?text=éŒ¯èª¤';"/>
                                    <input type="number" min="1" value="${item.quantity}" data-id="${item.id}" data-action="update-cart-quantity" class="w-16 text-center border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold">${item.name}</p>
                                    <p class="text-sm text-gray-500">${item.price} / ${item.unit}</p>
                                    <button data-id="${item.id}" data-action="remove-from-cart" class="mt-1 text-red-500 hover:text-red-700 p-1"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                            </div>
                            <div class="w-1/2 flex space-x-2">
                                <div class="w-1/2">
                                    <label class="block text-xs font-medium text-gray-700">éœ€æ±‚èª²å®¤</label>
                                    <select data-id="${item.id}" data-action="update-item-demand-dept" class="mt-1 block w-full p-1 text-sm rounded-md border-gray-300 shadow-sm">
                                        <option value="">-- è«‹é¸æ“‡ --</option>
                                        ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}" ${(item.demand_department || state.currentUser.demand_department || '') === d ? 'selected' : ''}>${d}</option>`).join('')}
                                    </select>
                                    <label class="block text-xs font-medium text-gray-700 mt-2">ç”³è«‹åŸå› </label>
                                    <select data-id="${item.id}" data-action="update-item-reason" class="mt-1 block w-full p-1 text-sm rounded-md border-gray-300 shadow-sm">
                                        ${reasonOptions.map(opt => `<option value="${opt}" ${item.reason === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="w-1/2">
                                    <label class="block text-xs font-medium text-gray-700">ç™¼ç¥¨é–‹ç«‹</label>
                                    <div class="flex space-x-2">
                                        <select data-id="${item.id}" data-action="update-item-invoice" class="mt-1 block ${item.invoice === 'å…¶ä»–' ? 'w-1/3' : 'w-full'} p-1 text-sm rounded-md border-gray-300 shadow-sm">
                                            <option value="">-- è«‹é¸æ“‡ --</option>
                                            ${[
                                                "8Cæ¸…ç¦", "7Cæ¸…æ°£", "6Cæ¸…å¿ƒ", "5Cæ¸…å¹³", "3Cæ¸…å®‰", "2CDæ¸…è­·",
                                                "8Dæ¸…æ˜¥", "7Dæ¸…æ—¥", "6Dæ¸…ç…§", "5Dæ¸…é¢¨", "3Dæ¸…æ™¯", "8Eæ¸…å±±",
                                                "7Eæ¸…æ³‰", "6Eæ¸…æ°´", "8Eæ¸…æ¸…", "3Eæ¸…æ¶¼", "æ¸…ç¦æ³•äºº", "ä¸€é¤¨",
                                                "äºŒé¤¨", "ä¸‰é¤¨", "å«ç¬‘", "æ¸…ç¦å¹¼å…’åœ’", "å…¶ä»–"
                                            ].map(opt => `<option value="${opt}" ${item.invoice === opt ? 'selected' : item.invoice === undefined && opt === state.currentUser.default_invoice ? 'selected' : ''}>${opt}</option>`).join('')}
                                        </select>
                                        <input type="text" data-id="${item.id}" data-action="update-item-custom-invoice" class="mt-1 ${item.invoice === 'å…¶ä»–' ? 'block w-2/3' : 'hidden'} p-1 text-sm rounded-md border-gray-300 shadow-sm" value="${item.custom_invoice || ''}" placeholder="è«‹è¼¸å…¥ç™¼ç¥¨é–‹ç«‹...">
                                    </div>
                                    <label class="block text-xs font-medium text-gray-700 mt-2">èªªæ˜</label>
                                    <input type="text" data-id="${item.id}" data-action="update-item-description" class="mt-1 block w-full p-1 text-sm rounded-md border-gray-300 shadow-sm" placeholder="å¦‚ï¼šæ–°å¢è¨­å‚™ã€æŸæŸç‰©å“æå£..." value="${item.description || ''}">
                                </div>
                            </div>
                            <div class="w-1/6 ml-auto">
                                <div class="flex flex-col items-end text-right">
                                    <label class="flex items-center justify-end text-xs font-medium text-gray-700">
                                        <input type="checkbox" data-id="${item.id}" data-action="toggle-item-scrap" class="h-4 w-4 rounded border-gray-300 text-blue-600" ${item.is_scrap_work_order ? 'checked' : ''} ${item.reason === 'å ±å»¢' ? '' : 'disabled'}>
                                        <span class="ml-2 text-gray-700">å ±å»¢è²¡ç·¨</span>
                                    </label>
                                    <input type="text" data-id="${item.id}" data-action="update-item-work-order" class="self-end block w-20 mt-1 p-1 text-sm rounded-md border-gray-300 shadow-sm ${item.is_scrap_work_order ? '' : 'invisible'}" value="${item.work_order_number || ''}">
                                    ${(() => {
                                        const shouldShow = item.reason === 'å ±å»¢' && !(item.is_scrap_work_order && (item.work_order_number || '').trim());
                                        return `
                                        <div id="scrap-reminder-${item.id}" class="${shouldShow ? '' : 'hidden'} mt-1 p-2 bg-yellow-100 border border-yellow-400 text-yellow-700 text-xs rounded transition-opacity duration-300 w-20 text-center self-end">
                                            <div>è«‹å‹¾é¸å¡«å¯«</div>
                                            <div>å ±å»¢è²¡ç·¨</div>
                                        </div>`;
                                    })()}
                                </div>
                            </div>
                        </div>
                    `;
                };

                // ä¾ç‰ˆå‹åˆ‡æ›åˆ—è¡¨å‘ˆç¾ï¼šexpanded ä½¿ç”¨å–®æ¬„åˆ—è¡¨ï¼›compact ä½¿ç”¨é›™æ¬„ç¶²æ ¼
                if (layoutScale === 'compact') {
                    return `<ul class="grid grid-cols-2 gap-4">${cart.map(item => `
                        <li class="border rounded-md p-3">${renderCartItemInner(item)}</li>
                    `).join('')}</ul>`;
                }
                return `<ul class="divide-y divide-gray-200">${cart.map(item => `
                    <li class="py-3">${renderCartItemInner(item)}</li>
                `).join('')}</ul>`;
            };

            // å–å¾—ç¸½èªªæ˜ï¼ˆé¸å¡«ï¼‰çš„æš«å­˜å€¼ï¼šå„ªå…ˆé¡¯ç¤ºæœ¬åœ°éç©ºå€¼ï¼Œå¦å‰‡é¡¯ç¤ºè‰ç¨¿è£¡çš„å€¼
            const requestReasonValue = (state.local.requestReason !== undefined && state.local.requestReason !== '')
                ? state.local.requestReason
                : (isEditingDraft ? state.editingRequest.reason || '' : '');

            sidebarEl.innerHTML = `
                <div class="flex items-end justify-between mb-3 border-b pb-2">
                    <div class="flex items-center gap-3 flex-wrap">
                        <h2 class="text-lg font-bold">æª¢è¦–æ¸…å–®</h2>
                        <div class="flex items-center text-sm">
                            <span class="mr-2 text-gray-700">è¨‚å–®é¡åˆ¥</span>
                            <label class="inline-flex items-center mr-4">
                                <input type="radio" name="order-type" value="ç‰¹æ¡" data-action="update-order-type" class="h-4 w-4 text-pink-600" ${orderType === 'ç‰¹æ¡' ? 'checked' : ''}>
                                <span class="ml-2">ç‰¹æ¡</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="order-type" value="å°ˆæ¡ˆ" data-action="update-order-type" class="h-4 w-4 text-teal-600" ${orderType === 'å°ˆæ¡ˆ' ? 'checked' : ''}>
                                <span class="ml-2">å°ˆæ¡ˆ</span>
                            </label>
                        </div>
                    </div>
                    <span class="text-sm text-gray-600">æ‚¨æ‰€è¨‚è³¼ç‰©å“æœ‰ <b class="text-base text-indigo-600">${itemCount}</b> é …å…± <b class="text-base text-emerald-600">${totalQuantity}</b> å€‹</span>
                </div>
                <div class="mb-4 p-2 bg-gray-100 rounded-md">
                    <div class="flex items-start gap-4">
                        <div class="w-56 shrink-0">
                            <div class="text-sm font-medium text-gray-700">ç”³è«‹äºº</div>
                            <div class="text-base font-semibold text-gray-900">${state.currentUser.name} (${state.currentUser.department})</div>
                        </div>
                        <div class="flex-1">
                            <label for="request-reason" class="block text-sm font-medium text-gray-700">ç¸½èªªæ˜ (é¸å¡«)</label>
                            <input type="text" id="request-reason" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm" placeholder="å¯å¡«å¯«æ­¤å¼µç”³è«‹å–®çš„æ•´é«”ç›®çš„..." value="${requestReasonValue}">
                        </div>
                    </div>
                </div>
                <div class="mb-4 p-2 bg-gray-50 rounded-md border">
                    <div class="flex items-start gap-4">
                        <div class="w-56 shrink-0">
                            <div class="text-sm font-medium text-gray-700">é™„ä»¶</div>
                            <div class="text-xs text-gray-500">æ”¯æ´å¤šæª”ä¸Šå‚³ï¼ˆæ¯å€‹æª”æ¡ˆä¸Šé™1MB)</div>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="request-attachment-input" class="hidden" multiple>
                            <div class="flex items-center gap-2">
                                <label for="request-attachment-input" class="cursor-pointer px-3 py-1.5 text-sm bg-gray-200 rounded-md hover:bg-gray-300">é¸æ“‡é™„ä»¶</label>
                                <button type="button" data-action="upload-attachments" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50" disabled>ä¸Šå‚³é™„ä»¶</button>
                                <span id="request-attachment-filename" class="text-xs text-gray-500">æœªé¸æ“‡æª”æ¡ˆ</span>
                            </div>
                            <ul class="mt-3 space-y-2" id="request-attachments-list">
                                ${(state.local.newRequestAttachments || []).map((f, idx) => {
                                    const ts = f.uploaded_at ? formatAttachmentDate(f.uploaded_at) : '';
                                    const sizeText = typeof f.size === 'number' ? `${f.size.toLocaleString()} bytes` : '';
                                    const info = [sizeText, ts].filter(Boolean).join('ï¼Œ');
                                    return `
                                    <li class="flex items-center justify-between p-2 bg-white border rounded">
                                        <div class="min-w-0">
                                            <div class="text-sm font-medium text-gray-700 truncate" title="${f.name}">${f.name}</div>
                                            <div class="text-xs text-gray-500">${info}</div>
                                        </div>
                                        <button data-action="remove-attachment" data-index="${idx}" class="ml-3 text-red-600 hover:text-red-700 text-sm">ç§»é™¤</button>
                                    </li>`;
                                }).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="border-t pt-4 mb-4">
                    <div class="flex justify-between items-center font-bold text-lg">
                        <span>ç¸½é‡‘é¡</span>
                        <span class="cart-total">$${totalAmount.toLocaleString()}</span>
                    </div>
                    <div class="flex space-x-2 mt-4">
                   ${isEditingDraft && state.editingRequest.status === 'å¾…é€å‡º' ? `
                        <button data-id="${state.editingRequest.id}" data-action="delete-draft" class="w-full px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">åˆªé™¤è‰ç¨¿</button>
                    ` : ''}
                    <button data-action="save-request" class="w-full px-4 py-2 rounded-md font-semibold text-sm bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50" ${cart.length === 0 ? 'disabled' : ''}>${isEditingDraft ? 'æ›´æ–°è‰ç¨¿' : 'å„²å­˜è‰ç¨¿'}</button>
                    <button data-action="submit-request" class="w-full px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50" ${cart.length === 0 ? 'disabled' : ''}>é€å‡ºç”³è«‹</button>
                </div>
                </div>
                <div class="cart-items max-h-[calc(100vh-34rem)] overflow-y-auto border-t pt-2">${cartItemsHTML()}</div>
                `;
        };
        
        window.renderDetailView = function() {
            const viewEl = document.getElementById('detailView-view');
            const request = state.selectedRequest;
            if (!request) {
                viewEl.innerHTML = `<p>æ‰¾ä¸åˆ°ç”³è«‹å–®</p>`;
                viewEl.style.display = 'block';
                return;
            }

            const getApproverStatusUI = (approver) => {
                let statusHTML = '';
                const approverUser = state.users[approver.userId];
                const approverInfo = approverUser ? `(${approverUser.email} ${approverUser.name})` : `(${approver.userId.substring(0,8)})`;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºä¿®æ”¹ç•¶ä¸‹çš„ç°½æ ¸åˆ—ï¼šå¾ modification_history ä¸­æ‰¾æ­¤ç”¨æˆ¶çš„ç·¨è¼¯æ“ä½œç´€éŒ„
                let modificationMark = '';
                if (request.modification_history && request.modification_history.length > 0) {
                    // ä½¿ç”¨ user æ¬„ä½ï¼ˆå§“åï¼‰æˆ– userId æ¬„ä½ä¾†æ¯”å°ï¼Œåªæª¢æŸ¥ç·¨è¼¯ç›¸é—œæ“ä½œ
                    const userToMatch = approverUser ? approverUser.name : approver.userId;
                    const hasEditModification = request.modification_history.some(h => 
                        ((h.userId === approver.userId) || (h.user === userToMatch)) && 
                        (h.action === 'handled_edit' || (h.changes && h.changes.length > 0))
                    );
                    
                    if (hasEditModification) {
                        modificationMark = ' <span class="text-orange-600 font-bold">æœ‰ä¿®æ”¹é</span>';
                    }
                }

                if (approver.status === 'approved') statusHTML = `<span class="text-green-600">âœ”ï¸ å·²æ ¸å‡† (${getFormattedDateTime(approver.date)}) by ${approver.role} ${approverInfo}</span>${modificationMark}`;
                else if (approver.status === 'rejected') statusHTML = `<span class="text-red-600">âŒ å·²é€€å› (${getFormattedDateTime(approver.date)}) by ${approver.role} ${approverInfo}</span>${modificationMark}`;
                else statusHTML = `<span class="text-gray-500">â€¦ å¾…ç°½æ ¸ by ${approver.role} ${approverInfo}</span>`;
                
                if(approver.comment) statusHTML += `<p class="text-xs text-gray-500 pl-4">æ„è¦‹: ${approver.comment}</p>`;
                if(approver.reason) statusHTML += `<p class="text-xs text-red-500 pl-4">é€€å›åŸå› : ${approver.reason}</p>`;
                return statusHTML;
            };
            
            const nextApprover = (request.approvers || []).find(a => a.status === 'pending');
            const canApprove = state.currentUser && nextApprover && state.currentUser.id === nextApprover.userId;
            const isPurchaser = state.currentUser.role.includes('æ¡è³¼');
            const isPurchaserEditing = canApprove && isPurchaser;
            const effectiveHandlerStatus = request.handler_status || (request.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
            const isHandlerEditing = effectiveHandlerStatus === 'å¾…ç¶“è¾¦' && (state.currentUser.id === request.handler_id || state.currentUser.role === 'æ¡è³¼' || state.currentUser.role === 'æ¡è³¼ä¸»ç®¡' || state.currentUser.is_admin);

            const itemsHTML = (request.items || []).map((item, index) => {
                const subtotal = (item.price || 0) * (item.quantity || 0) + (item.freight || 0) + (item.discount || 0);
                const workOrderNumber = item.is_scrap_work_order && item.work_order_number ? item.work_order_number : '';
                
                const product = state.allProducts.find(p => p.id === item.id);
                const imageUrl = product?.image 
                    ? `https://drive.google.com/thumbnail?id=${product.image}` 
                    : 'https://placehold.co/64x64?text=ç„¡åœ–ç‰‡';
                const vendorName = state.vendors.find(v => v.vendor_id === item.vendor)?.short_name || item.vendor || '';

                if (isPurchaserEditing || isHandlerEditing) {
                    return `
                        <tr class="border-b item-row">
                            <td class="px-4 py-2 align-top"><img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64?text=éŒ¯èª¤';"/></td>
                            <td class="px-4 py-2 align-top">${item.id || ''}</td>
                            <td class="px-4 py-2 align-top">
                                ${item.name}
                                <div class="text-xs text-gray-500 mt-2 space-y-1">
                                    <div>
                                        <label class="text-gray-600 mr-2">åŸå› </label>
                                        <select name="reason_${index}" class="p-1 border rounded">
                                            ${['æ–°å¢','ä¿®ç¹•','å ±å»¢','å…¶ä»–'].map(r => `<option value="${r}" ${item.reason === r ? 'selected' : ''}>${r}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label class="text-gray-600">èªªæ˜</label>
                                        <input type="text" name="description_${index}" class="p-1 border rounded w-64" value="${item.description || ''}" placeholder="è¼¸å…¥èªªæ˜...">
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <select name="demand_department_${index}" class="w-full p-1 border rounded">
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}" ${(item.demand_department || '') === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <div class="flex items-center gap-2">
                                    <select name="invoice_${index}" class="p-1 border rounded ${item.invoice === 'å…¶ä»–' ? 'w-1/3' : 'w-full'}">
                                        <option value="">-- è«‹é¸æ“‡ --</option>
                                        ${[
                                            "8Cæ¸…ç¦", "7Cæ¸…æ°£", "6Cæ¸…å¿ƒ", "5Cæ¸…å¹³", "3Cæ¸…å®‰", "2CDæ¸…è­·",
                                            "8Dæ¸…æ˜¥", "7Dæ¸…æ—¥", "6Dæ¸…ç…§", "5Dæ¸…é¢¨", "3Dæ¸…æ™¯", "8Eæ¸…å±±",
                                            "7Eæ¸…æ³‰", "6Eæ¸…æ°´", "8Eæ¸…æ¸…", "3Eæ¸…æ¶¼", "æ¸…ç¦æ³•äºº", "ä¸€é¤¨",
                                            "äºŒé¤¨", "ä¸‰é¤¨", "å«ç¬‘", "æ¸…ç¦å¹¼å…’åœ’", "å…¶ä»–"
                                        ].map(opt => `<option value="${opt}" ${item.invoice === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                    <input type="text" name="custom_invoice_${index}" class="p-1 border rounded ${item.invoice === 'å…¶ä»–' ? 'block w-2/3' : 'hidden'}" value="${item.custom_invoice || ''}" placeholder="è«‹è¼¸å…¥ç™¼ç¥¨é–‹ç«‹...">
                                </div>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <select name="vendor_${index}" class="w-full p-1 border rounded">
                                    <option value="">-- è«‹é¸æ“‡å» å•† --</option>
                                    ${state.vendors.map(v => `<option value="${v.vendor_id}" ${item.vendor === v.vendor_id ? 'selected' : ''}>${v.short_name || v.name}</option>`).join('')}
                                </select>
                            </td>
                            <td class="px-4 py-2 text-right align-top"><input name="price_${index}" type="number" data-index="${index}" class="item-input w-24 p-1 border rounded text-right" value="${item.price || 0}"></td>
                            <td class="px-4 py-2 text-right align-top">
                                <input name="quantity_${index}" type="number" data-index="${index}" class="item-input w-16 p-1 border rounded text-right" value="${item.quantity || 0}">
                                <input name="unit_${index}" class="w-12 p-1 border rounded text-right" value="${item.unit || ''}">
                            </td>
                            <td class="px-4 py-2 text-right align-top"><input name="freight_${index}" type="number" data-index="${index}" class="item-input w-20 p-1 border rounded text-right" value="${item.freight || 0}"></td>
                            <td class="px-4 py-2 text-right align-top"><input name="discount_${index}" type="number" data-index="${index}" class="item-input w-20 p-1 border rounded text-right" value="${item.discount || 0}"></td>
                            <td class="px-4 py-2 text-right align-top subtotal-cell" data-index="${index}">$${subtotal.toLocaleString()}</td>
                            <td class="px-4 py-2 align-top">
                                <input type="checkbox" name="scrap_${index}" class="block mx-auto" ${item.reason === 'å ±å»¢' ? '' : 'disabled'} ${item.is_scrap_work_order ? 'checked' : ''}>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <input name="asset_number_${index}" class="p-1 border rounded w-24 ${item.is_scrap_work_order ? '' : 'opacity-50'}" ${item.is_scrap_work_order ? '' : 'disabled'} value="${workOrderNumber}" placeholder="è«‹è¼¸å…¥è²¡ç”¢ç·¨è™Ÿ">
                            </td>
                        </tr>`;
                }
                return `
                    <tr class="border-b">
                        <td class="px-4 py-2 align-top"><img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64?text=éŒ¯èª¤';"/></td>
                        <td class="px-4 py-2 align-top">${item.id || ''}</td>
                        <td class="px-4 py-2 align-top">
                            ${item.name}
                            <div class="text-xs text-gray-500 mt-1">
                                <p><b>åŸå› :</b> ${item.reason || 'N/A'}</p>
                                <p><b>èªªæ˜:</b> ${item.description || 'N/A'}</p>
                            </div>
                        </td>
                        <td class="px-4 py-2 align-top">${item.demand_department || ''}</td>
                        <td class="px-4 py-2 align-top">${item.invoice === 'å…¶ä»–' ? (item.custom_invoice || '') : (item.invoice || '')}</td>
                        <td class="px-4 py-2 align-top">${vendorName}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.price || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">${item.quantity} ${item.unit}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.freight || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.discount || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">$${subtotal.toLocaleString()}</td>
                        <td class="px-4 py-2 text-center align-top">${item.is_scrap_work_order ? 'âœ”ï¸' : ''}</td>
                        <td class="px-4 py-2 align-top">${workOrderNumber}</td>
                    </tr>`;
            }).join('');
            
            const modificationHistoryHTML = (() => {
                const fieldNameMap = { reason: 'åŸå› ', description: 'èªªæ˜', demand_department: 'éœ€æ±‚èª²å®¤', invoice: 'ç™¼ç¥¨é–‹ç«‹', custom_invoice: 'è‡ªè¨‚ç™¼ç¥¨', vendor: 'å» å•†', price: 'å–®åƒ¹', quantity: 'æ•¸é‡', unit: 'å–®ä½', freight: 'é‹è²»', discount: 'æŠ˜æ‰£', is_scrap_work_order: 'å ±å»¢', work_order_number: 'è²¡ç”¢ç·¨è™Ÿ' };
                const hist = [...(request.modification_history || [])].reverse();
                return hist.map((entry, i) => {
                    const changes = Array.isArray(entry.changes) ? entry.changes : [];
                    const changesHTML = changes.length ? `
                        <div class="mt-1 space-y-2">
                            ${changes.map(c => `
                                <div class="border rounded p-2 bg-gray-50">
                                    <div class="text-xs text-gray-500">å“é …ï¼š${c.name || c.item_id || ''}</div>
                                    <ul class="mt-1 text-xs list-disc list-inside">
                                        ${(c.changes || []).map(ch => `<li><span class="text-gray-600">${fieldNameMap[ch.field] || ch.field}ï¼š</span><span class="line-through text-gray-400">${ch.from === '' ? 'ï¼ˆç©ºï¼‰' : ch.from}</span> â†’ <span class="text-gray-800">${ch.to === '' ? 'ï¼ˆç©ºï¼‰' : ch.to}</span></li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>` : '<div class="text-xs text-gray-500">ç„¡æ¬„ä½è®Šæ›´æ˜ç´°</div>';
                    return `
                        <div class="text-xs text-gray-600 border-t pt-2 mt-2">
                            <div class="font-semibold">#${i + 1} ä¿®æ”¹äºº: ${entry.user} (${entry.role}) æ–¼ ${getFormattedDateTime(entry.date)}</div>
                            <div><strong>ä¿®æ”¹åŸå› :</strong> ${entry.reason || 'ï¼ˆæœªå¡«ï¼‰'}</div>
                            ${changesHTML}
                        </div>
                    `;
                }).join('');
            })();

            const readonlyBadge = (isPurchaserEditing || isHandlerEditing)
                ? `<span class="ml-2 inline-block align-middle text-[10px] px-2 py-0.5 rounded border border-gray-300 text-gray-600 bg-gray-50">å”¯è®€</span>`
                : '';

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-bold text-gray-700">ç”³è«‹å–®è©³æƒ…: ${request.id} ${Array.isArray(request.attachments) && request.attachments.length ? 'ğŸ“' : ''}</h1>
                        <button data-action="view-mod-history" class="px-4 py-2 rounded-md text-sm font-bold ${(() => {
                            // æª¢æŸ¥æ˜¯å¦æœ‰ç·¨è¼¯ç›¸é—œçš„ä¿®æ”¹æ­·ç¨‹
                            const hasEditHistory = request.modification_history && request.modification_history.some(h => 
                                h.action === 'handled_edit' || (h.changes && h.changes.length > 0)
                            );
                            return hasEditHistory ? 'bg-orange-600 hover:bg-orange-700 text-white border-2 border-orange-800' : 'bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300';
                        })()}">
                            ${(() => {
                                const hasEditHistory = request.modification_history && request.modification_history.some(h => 
                                    h.action === 'handled_edit' || (h.changes && h.changes.length > 0)
                                );
                                return hasEditHistory ? 'âš ï¸ ä¿®æ”¹æ­·ç¨‹' : 'ä¿®æ”¹æ­·ç¨‹';
                            })()}
                        </button>
                    </div>
                    <div class="flex space-x-2">
                        <button data-action="print-request" data-request-id="${request.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                            </svg>
                            åˆ—å°
                        </button>
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div><span class="font-bold text-gray-600">ç”³è«‹å–®è™Ÿ:</span> ${request.id} ${Array.isArray(request.attachments) && request.attachments.length ? 'ğŸ“' : ''}</div>
                        <div><span class="font-bold text-gray-600">ç”³è«‹æ—¥æœŸ:</span> ${getFormattedDateTime(request.request_date)}</div>
                        <div><span class="font-bold text-gray-600">è¨‚å–®é¡åˆ¥:</span> <span class="px-3 py-1 rounded-full text-xs font-medium ${(request.type || 'ç‰¹æ¡') === 'ç‰¹æ¡' ? 'bg-pink-100 text-pink-800' : 'bg-teal-100 text-teal-800'}">${request.type || 'ç‰¹æ¡'}</span></div>
                        <div>
                            <span class="font-bold text-gray-600">ç°½æ ¸ç‹€æ…‹:</span>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${{'å¾…å¯©æ ¸': 'bg-yellow-100 text-yellow-800', 'å·²æ ¸å‡†': 'bg-green-100 text-green-800', 'å·²é€€å›': 'bg-red-100 text-red-800'}[request.status] || 'bg-gray-100 text-gray-800'}">${request.status}</span>
                            ${(() => {
                                const lastApproved = (request.approvers || []).filter(a => a.status === 'approved').slice(-1)[0];
                                if (!lastApproved) return '';
                                const n = state.users[lastApproved.userId]?.name || (lastApproved.userId ? lastApproved.userId.substring(0,8) : '');
                                return `<span class="text-xs text-gray-500 ml-2">æœ€æ–°ç°½æ ¸ï¼š${getFormattedDateTime(lastApproved.date)} by ${n}</span>`;
                            })()}
                        </div>
                        <div>
                            <span class="font-bold text-gray-600">ç¶“è¾¦ç‹€æ…‹:</span>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${{'æœªç¶“è¾¦': 'bg-neutral-100 text-neutral-800','å¾…ç¶“è¾¦': 'bg-amber-100 text-amber-800','å·²ç¶“è¾¦': 'bg-green-100 text-green-800'}[request.handler_status || (request.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦')]}"">${request.handler_status || (request.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦')}</span>
                            ${(() => {
                                // ä»¥ approvers ä¸­å«ã€Œæ¡è³¼ã€ä¸”å·²approvedè€…ä½œç‚ºç¶“è¾¦å®Œæˆè³‡è¨Šä¾†æºï¼›æˆ– modification_history ä¸­ action==='handled'
                                const handledFromApprover = (request.approvers || []).filter(a => (a.role || '').includes('æ¡è³¼') && a.status === 'approved').slice(-1)[0];
                                const hist = (request.modification_history || []).filter(h => h.action === 'handled').slice(-1)[0];
                                const stamp = hist?.date || handledFromApprover?.date;
                                const whoId = handledFromApprover?.userId;
                                const who = hist?.user || (whoId ? (state.users[whoId]?.name || whoId.substring(0,8)) : '');
                                if (!stamp || !who) return '';
                                return `<span class=\"text-xs text-gray-500 ml-2\">æœ€æ–°ç¶“è¾¦ï¼š${getFormattedDateTime(stamp)} by ${who}</span>`;
                            })()}
                        </div>
                        <div><span class="font-bold text-gray-600">ç”³è«‹äºº:</span> ${state.users[request.applicant_id]?.name || 'æœªçŸ¥'}</div>
                        <div><span class="font-bold text-gray-600">ç”³è«‹éƒ¨é–€:</span> ${request.department}</div>
                        <div>
                            <span class="font-bold text-gray-600">çµæ¡ˆç‹€æ…‹:</span>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${request.closed_status === 'çµæ¡ˆ' ? 'bg-gray-300 text-gray-800' : 'bg-blue-100 text-blue-800'}">${request.closed_status || 'æœªçµæ¡ˆ'}</span>
                            ${(() => {
                                const hist = (request.modification_history || []).filter(h => h.action === 'closed').slice(-1)[0];
                                if (!hist) return '';
                                return `<span class=\"text-xs text-gray-500 ml-2\">æœ€æ–°çµæ¡ˆï¼š${getFormattedDateTime(hist.date)} by ${hist.user}</span>`;
                            })()}
                        </div>
                        <div class="md:col-span-3"><span class="font-bold text-gray-600">ç¸½èªªæ˜:</span> <span class="text-gray-800 whitespace-pre-wrap">${request.reason || 'ç„¡'}</span></div>
                        <div class="md:col-span-3">
                            <span class="font-bold text-gray-600">é™„ä»¶:</span>
                            ${(() => {
                                const atts = request.attachments || [];
                                if (!atts.length) return '<span class="text-gray-500 ml-2">ç„¡</span>';
                                return `<ul class=\"mt-2 space-y-2\">${atts.map(a => {
                                    const ts = a.uploaded_at ? formatAttachmentDate(a.uploaded_at) : '';
                                    const sizeText = typeof a.size === 'number' ? `${(a.size||0).toLocaleString()} bytes` : '';
                                    const info = [sizeText, ts].filter(Boolean).join('ï¼Œ');
                                    return `
                                    <li class=\"flex items-center justify-between p-2 bg-gray-50 border rounded\">
                                        <div class=\"min-w-0\"> 
                                            <div class=\"text-sm font-medium text-gray-700 truncate\" title=\"${a.name}\">${a.name}</div>
                                            <div class=\"text-xs text-gray-500\">${info}</div>
                                        </div>
                                        <div class=\"flex items-center gap-2\"> 
                                            <button data-action=\"download-attachment\" data-file-id=\"${a.id}\" class=\"px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700\">ä¸‹è¼‰</button>
                                        </div>
                                    </li>`;
                                }).join('')}</ul>`;
                            })()}
                        </div>
                    </div>
                    <h3 class="text-lg font-bold border-b pb-2 mb-4">ç”³è«‹é …ç›®</h3>
                    <form id="edit-request-form">
                        <div class="overflow-x-auto mb-6">
                            <table class="min-w-full">
                                <thead class="bg-gray-100"><tr>
                                    <th class="px-4 py-2 text-left">åœ–ç‰‡</th>
                                    <th class="px-4 py-2 text-left">å•†å“ç·¨è™Ÿ</th>
                                    <th class="px-4 py-2 text-left">å“å/èªªæ˜ ${readonlyBadge}</th>
                                    <th class="px-4 py-2 text-left">éœ€æ±‚èª²å®¤</th>
                                    <th class="px-4 py-2 text-left">ç™¼ç¥¨é–‹ç«‹</th>
                                    <th class="px-4 py-2 text-left">å» å•†</th>
                                    <th class="px-4 py-2 text-right">å–®åƒ¹</th>
                                    <th class="px-4 py-2 text-right">æ•¸é‡</th>
                                    <th class="px-4 py-2 text-right">é‹è²»</th>
                                    <th class="px-4 py-2 text-right">æŠ˜æ‰£</th>
                                    <th class="px-4 py-2 text-right">å°è¨ˆ</th>
                                    <th class="px-4 py-2 text-center">å ±å»¢</th>
                                    <th class="px-4 py-2 text-left">è²¡ç”¢ç·¨è™Ÿ</th>
                                </tr></thead>
                                <tbody>${itemsHTML}</tbody>
                                <tfoot><tr class="font-bold"><td colspan="10" class="px-4 py-2 text-right">ç¸½é‡‘é¡:</td><td id="grand-total" class="px-4 py-2 text-right">$${Number(request.total_amount).toLocaleString()}</td><td colspan="2"></td></tr></tfoot>
                            </table>
                        </div>
                    </form>
                    
                                        <h3 class="text-lg font-bold border-b pb-2 mb-2">ç°½æ ¸æµç¨‹</h3>
                                        <div class="space-y-4 mb-6">
                                                ${(() => {
                                                        const list = request.approvers || [];
                                                        const stage1 = list.filter(a => ['ç”³è«‹äººç›´å±¬ä¸»ç®¡','ç”³è«‹äººç¬¬äºŒä¸»ç®¡','ç”³è«‹äººç¬¬ä¸‰ä¸»ç®¡'].includes(a.role));
                                                        const stage2 = list.filter(a => a.role === 'é™¢é•·');
                                                        // ç¬¬ä¸‰éšæ®µé¡¯ç¤ºï¼šæ¡è³¼æœ¬äºº + æ¡è³¼çš„ä¸»ç®¡éˆï¼ˆç›´å±¬/ç¬¬äºŒ/ç¬¬ä¸‰ä¸»ç®¡ï¼‰
                                                        const stage3 = list.filter(a => ['æ¡è³¼','æ¡è³¼ç›´å±¬ä¸»ç®¡','æ¡è³¼ç¬¬äºŒä¸»ç®¡','æ¡è³¼ç¬¬ä¸‰ä¸»ç®¡'].includes(a.role));
                                                        const section = (title, arr) => arr.length ? `
                                                            <div class="mt-2">
                                                                <div class="text-sm text-gray-600 font-semibold mb-1">${title}</div>
                                                                ${arr.map(approver => `<div class=\"flex items-start\"><div class=\"font-bold w-48 flex-shrink-0\">${approver.role}:</div><div>${getApproverStatusUI(approver)}</div></div>`).join('')}
                                                            </div>` : '';
                                                        // ç¬¬äºŒéšæ®µé¡¯ç¤ºé‚è¼¯ï¼šæœªé”é–€æª»ä»é¡¯ç¤ºéšæ®µä¸¦æç¤ºå…ç°½
                                                        const departmentThreshold = (state.departments && state.departments[request.department]) ?? Infinity;
                                                        const needsDirector = (request.total_amount || 0) > departmentThreshold;
                                                        const stage2HTML = needsDirector
                                                            ? section('ç¬¬äºŒéšæ®µ-é™¢é•·ç°½æ ¸', stage2)
                                                            : `
                                                                <div class="mt-2">
                                                                    <div class="text-sm text-gray-600 font-semibold mb-1">ç¬¬äºŒéšæ®µ-é™¢é•·ç°½æ ¸</div>
                                                                    <div class="text-sm text-gray-500">æœªé”é™¢é•·ç°½æ ¸é‡‘é¡ä¸éœ€ç°½æ ¸</div>
                                                                </div>`;
                                                        const stage4 = (() => {
                                                            const effective = request.handler_status || (request.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                                                            const closed = request.closed_status || 'æœªçµæ¡ˆ';
                                                            
                                                            // å»ºç«‹é¡ä¼¼ç¬¬ä¸€éšæ®µçš„é¡¯ç¤ºæ ¼å¼
                                                            const handlerUser = state.users[request.handler_id];
                                                            const handlerInfo = handlerUser ? `(${handlerUser.email} ${handlerUser.name})` : `(${request.handler_id || 'æœªæŒ‡æ´¾'})`;
                                                            
                                                            // ç¶“è¾¦ç‹€æ…‹é¡¯ç¤º - åŠ å…¥æ—¥æœŸæ™‚é–“å’Œäººå“¡è³‡è¨Š
                                                            let handlerStatusHTML = '';
                                                            if (effective === 'å·²ç¶“è¾¦') {
                                                                // æŸ¥æ‰¾ç¶“è¾¦æ—¥æœŸå’Œäººå“¡
                                                                const handledFromApprover = (request.approvers || []).filter(a => (a.role || '').includes('æ¡è³¼') && a.status === 'approved').slice(-1)[0];
                                                                const hist = (request.modification_history || []).filter(h => h.action === 'handled').slice(-1)[0];
                                                                const handlerDate = hist?.date || handledFromApprover?.date;
                                                                const handlerUserId = hist?.userId || handledFromApprover?.userId;
                                                                
                                                                if (handlerDate) {
                                                                    const handlerUserInfo = handlerUserId ? state.users[handlerUserId] : null;
                                                                    if (handlerUserInfo) {
                                                                        handlerStatusHTML = `<span class="text-green-600">âœ”ï¸ å·²ç¶“è¾¦ (${getFormattedDateTime(handlerDate)}) by ç¶“è¾¦è€… (${handlerUserInfo.email} ${handlerUserInfo.name})</span>`;
                                                                    } else if (hist?.user) {
                                                                        // å¦‚æœæ²’æœ‰ userIdï¼Œå˜—è©¦ç”¨å§“ååŒ¹é…
                                                                        const userByName = Object.values(state.users).find(u => u.name === hist.user);
                                                                        if (userByName) {
                                                                            handlerStatusHTML = `<span class="text-green-600">âœ”ï¸ å·²ç¶“è¾¦ (${getFormattedDateTime(handlerDate)}) by ç¶“è¾¦è€… (${userByName.email} ${userByName.name})</span>`;
                                                                        } else {
                                                                            handlerStatusHTML = `<span class="text-green-600">âœ”ï¸ å·²ç¶“è¾¦ (${getFormattedDateTime(handlerDate)}) by ${hist.user}</span>`;
                                                                        }
                                                                    } else {
                                                                        handlerStatusHTML = `<span class="text-green-600">âœ”ï¸ å·²ç¶“è¾¦ (${getFormattedDateTime(handlerDate)}) ${handlerInfo}</span>`;
                                                                    }
                                                                } else {
                                                                    handlerStatusHTML = `<span class="text-green-600">âœ”ï¸ å·²ç¶“è¾¦ ${handlerInfo}</span>`;
                                                                }
                                                            } else if (effective === 'å¾…ç¶“è¾¦') {
                                                                handlerStatusHTML = `<span class="text-gray-500">â€¦ å¾…ç¶“è¾¦ ${handlerInfo}</span>`;
                                                            } else {
                                                                // å¦‚æœæ²’æœ‰æŒ‡æ´¾ç¶“è¾¦ï¼ˆhandler_id ç‚ºç©ºæˆ–ç‚ºæœªæŒ‡æ´¾ï¼‰ï¼Œé¡¯ç¤º "â€¦ æœªç¶“è¾¦"ï¼Œä¸é¡¯ç¤ºæ‹¬è™Ÿçš„æœªæŒ‡æ´¾å­—æ¨£
                                                                if (!request.handler_id) {
                                                                    handlerStatusHTML = `<span class="text-gray-500">â€¦ æœªç¶“è¾¦</span>`;
                                                                } else {
                                                                    handlerStatusHTML = `<span class="text-gray-400">æœªç¶“è¾¦ ${handlerInfo}</span>`;
                                                                }
                                                            }
                                                            
                                                            // çµæ¡ˆç‹€æ…‹é¡¯ç¤º - åŠ å…¥æ—¥æœŸæ™‚é–“å’Œäººå“¡è³‡è¨Š
                                                            let closeStatusHTML = '';
                                                            if (closed === 'çµæ¡ˆ') {
                                                                // æŸ¥æ‰¾çµæ¡ˆæ—¥æœŸå’Œäººå“¡
                                                                const closeHist = (request.modification_history || []).filter(h => h.action === 'closed').slice(-1)[0];
                                                                
                                                                if (closeHist && closeHist.date) {
                                                                    // ä½¿ç”¨æ–°çš„ userId æ¬„ä½æˆ–èˆŠçš„ user æ¬„ä½
                                                                    const closeUserInfo = closeHist.userId ? state.users[closeHist.userId] : null;
                                                                    if (closeUserInfo) {
                                                                        closeStatusHTML = `<span class="text-green-600">âœ”ï¸ å·²çµæ¡ˆ (${getFormattedDateTime(closeHist.date)}) by çµæ¡ˆè€… (${closeUserInfo.email} ${closeUserInfo.name})</span>`;
                                                                    } else if (closeHist.user) {
                                                                        // å¦‚æœæ²’æœ‰ userIdï¼Œå˜—è©¦ç”¨å§“ååŒ¹é…
                                                                        const userByName = Object.values(state.users).find(u => u.name === closeHist.user);
                                                                        if (userByName) {
                                                                            closeStatusHTML = `<span class="text-green-600">âœ”ï¸ å·²çµæ¡ˆ (${getFormattedDateTime(closeHist.date)}) by çµæ¡ˆè€… (${userByName.email} ${userByName.name})</span>`;
                                                                        } else {
                                                                            closeStatusHTML = `<span class="text-green-600">âœ”ï¸ å·²çµæ¡ˆ (${getFormattedDateTime(closeHist.date)}) by ${closeHist.user}</span>`;
                                                                        }
                                                                    } else {
                                                                        closeStatusHTML = `<span class="text-green-600">âœ”ï¸ å·²çµæ¡ˆ (${getFormattedDateTime(closeHist.date)})</span>`;
                                                                    }
                                                                } else {
                                                                    closeStatusHTML = `<span class="text-green-600">âœ”ï¸ å·²çµæ¡ˆ</span>`;
                                                                }
                                                            } else {
                                                                closeStatusHTML = `<span class="text-gray-500">â€¦ æœªçµæ¡ˆ</span>`;
                                                            }
                                                            
                                                            return `
                                                                <div class="mt-2">
                                                                    <div class="text-sm text-gray-600 font-semibold mb-1">ç¬¬å››éšæ®µ-ç¶“è¾¦çµæ¡ˆéšæ®µ</div>
                                                                    <div class="flex items-start"><div class="font-bold w-48 flex-shrink-0">ç¶“è¾¦:</div><div>${handlerStatusHTML}</div></div>
                                                                    <div class="flex items-start"><div class="font-bold w-48 flex-shrink-0">çµæ¡ˆ:</div><div>${closeStatusHTML}</div></div>
                                                                </div>`;
                                                        })();
                                                        return [
                                                            section('ç¬¬ä¸€éšæ®µ-è«‹è³¼éšæ®µç°½æ ¸', stage1),
                                                            stage2HTML,
                                                            section('ç¬¬ä¸‰éšæ®µ-æ¡è³¼éšæ®µç°½æ ¸', stage3),
                                                            stage4
                                                        ].join('');
                                                })()}
                                        </div>
                    <div class="border-t pt-6 flex justify-end space-x-4">
                        ${ (isPurchaser && request.status === 'å·²æ ¸å‡†' && (request.handler_status || 'æœªç¶“è¾¦') === 'å·²ç¶“è¾¦') ? `
                            <button data-action="close-request" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-700 text-white hover:bg-green-800">
                                ${request.closed_status === 'çµæ¡ˆ' ? 'å·²çµæ¡ˆ' : 'å°‡æ­¤å–®çµæ¡ˆ'}
                            </button>
                        ` : (isPurchaser && request.status === 'å·²æ ¸å‡†' && request.closed_status === 'çµæ¡ˆ' ? `
                            <button class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-400 text-white cursor-not-allowed" disabled>å·²çµæ¡ˆ</button>
                        ` : '')}
                        ${ isHandlerEditing ? `
                            <div class="flex-grow flex justify-end space-x-4">
                                <div class="flex-grow">
                                    <label for="handler-modification-reason" class="block text-sm font-medium text-gray-700">ç¶“è¾¦ä¿®æ”¹åŸå› </label>
                                    <textarea id="handler-modification-reason" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                                </div>
                                <div class="flex-grow">
                                    <label for="handler-comment" class="block text-sm font-medium text-gray-700">ç¶“è¾¦æ„è¦‹ (é¸å¡«)</label>
                                    <textarea id="handler-comment" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="å¯å¡«å¯«è£œå……èªªæ˜ï¼Œå°‡ä¸€ä½µç´€éŒ„æ–¼æ­·ç¨‹"></textarea>
                                </div>
                                <div class="flex items-end space-x-4">
                                    <button data-action="handler-save-changes" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">å„²å­˜ä¿®æ”¹ä¸¦ç¶“è¾¦</button>
                                    <button data-action="handler-reject-options" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">é€€å–®</button>
                                    <button data-action="mark-handled" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">ç¶“è¾¦</button>
                                </div>
                            </div>
                        ` : ''}
                        ${ canApprove ? `
                        <div class="flex-grow flex justify-end space-x-4">
                            ${isPurchaserEditing ? `
                            <div class="flex-grow">
                                <label for="modification-reason" class="block text-sm font-medium text-gray-700">ä¿®æ”¹åŸå› </label>
                                <textarea id="modification-reason" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                            </div>` : ''}
                            <div class="flex-grow">
                                <label for="approval-comment" class="block text-sm font-medium text-gray-700">ç°½æ ¸æ„è¦‹ (é¸å¡«)</label>
                                <textarea id="approval-comment" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                            </div>
                            <div class="flex items-end space-x-4">
                                ${isPurchaserEditing ? '<button data-action="save-changes" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">å„²å­˜ä¿®æ”¹ä¸¦æ ¸å‡†</button>' : ''}
                                <button data-action="reject" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">é€€å›</button>
                                <button data-action="approve" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">æ ¸å‡†</button>
                            </div>
                        </div>` : ''}
                    </div>
                </div>`;
             viewEl.style.display = 'block';
        };
        
        window.renderProductManagement = function() {
            const viewEl = document.getElementById('productManagement-view');
            const categories = ['å…¨å“é …', ...Object.keys(state.products)];
            const activeCategory = state.local.activeProductManagementCategory || 'å…¨å“é …';
            
            const filteredProducts = getFilteredProducts();

            const renderSortIcon = (key) => {
                if (state.local.productSortKey !== key) return `<span class="sort-icon">â–²â–¼</span>`;
                return state.local.productSortDirection === 'asc' ? `<span class="sort-icon">â–²</span>` : `<span class="sort-icon">â–¼</span>`;
            };

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">å•†å“ç®¡ç†</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                        <button data-action="add-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">æ–°å¢ç”¢å“</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-4 border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                            ${categories.map(cat => `<button data-category="${cat}" data-action="switch-product-category" class="product-category-btn ${cat === activeCategory ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">${cat}</button>`).join('')}
                        </nav>
                    </div>
                     <div class="mb-4 flex items-center gap-4">
                        <input type="text" id="product-search-input" placeholder="æœå°‹å•†å“..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm" value="${state.local.productManagementSearchTerm || ''}">
                        <button data-action="search-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">æœå°‹</button>
                        <label class="flex items-center text-sm whitespace-nowrap">
                            <input type="checkbox" id="product-management-search-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${state.local.productManagementSearchAll ? 'checked' : ''}>
                            <span class="ml-2 text-gray-700">æœå°‹å…¨åˆ†é¡</span>
                        </label>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'id' ? 'active' : ''}" data-action="sort-product" data-sort-key="id">å•†å“ç·¨è™Ÿ ${renderSortIcon('id')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'name' ? 'active' : ''}" data-action="sort-product" data-sort-key="name">å“å ${renderSortIcon('name')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'vendor' ? 'active' : ''}" data-action="sort-product" data-sort-key="vendor">å» å•† ${renderSortIcon('vendor')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'spec' ? 'active' : ''}" data-action="sort-product" data-sort-key="spec">è¦æ ¼ ${renderSortIcon('spec')}</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable ${state.local.productSortKey === 'price' ? 'active' : ''}" data-action="sort-product" data-sort-key="price">å–®åƒ¹ ${renderSortIcon('price')}</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¨‚è³¼ç³»çµ±</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">åŠŸèƒ½</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredProducts.map(p => {
                                    const spec = p.spec || '';
                                    const displaySpec = spec.length > 10 ? spec.substring(0, 10) + '...' : spec;
                                    const vendorName = state.vendors.find(v => v.vendor_id === p.vendor)?.short_name || p.vendor || '';
                                    return `
                                    <tr key="${p.id}">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.id}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${vendorName}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span title="${spec}">${displaySpec}</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right">$${Number(p.price || 0).toLocaleString()}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${p.ordering_system || 'ç‰¹æ¡'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-id="${p.id}" data-action="edit-product" class="text-blue-600 hover:text-blue-900">ç·¨è¼¯</button>
                                            <button data-id="${p.id}" data-name="${p.name}" data-action="delete-product" class="text-red-600 hover:text-red-900 ml-4">åˆªé™¤</button>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            viewEl.style.display = 'block';
        };

        // åˆ—å°ç›¸é—œå‡½æ•¸
        window.printRequest = function(requestId) {
            const request = state.requests.find(r => r.id === requestId);
            if (!request) {
                showMessage('æ‰¾ä¸åˆ°å°æ‡‰çš„ç”³è«‹å–®ã€‚', 'error');
                return;
            }

            const getApproverStatusUI = (approver) => {
                const approverUser = state.users[approver.userId];
                const approverInfo = approverUser ? `${approverUser.name}` : `${approver.userId.substring(0,8)}`;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºä¿®æ”¹ç•¶ä¸‹çš„ç°½æ ¸åˆ—ï¼ˆåˆ—å°ç‰ˆæœ¬ï¼‰
                let modificationMark = '';
                if (request.modification_history && request.modification_history.length > 0) {
                    const userToMatch = approverUser ? approverUser.name : approver.userId;
                    const hasEditModification = request.modification_history.some(h => 
                        ((h.userId === approver.userId) || (h.user === userToMatch)) && 
                        (h.action === 'handled_edit' || (h.changes && h.changes.length > 0))
                    );
                    
                    if (hasEditModification) {
                        modificationMark = ' (æœ‰ä¿®æ”¹é)';
                    }
                }
                
                if (approver.status === 'approved') return `âœ”ï¸ å·²æ ¸å‡† (${getFormattedDateTime(approver.date)}) by ${approverInfo}${modificationMark}`;
                else if (approver.status === 'rejected') return `âŒ å·²é€€å› (${getFormattedDateTime(approver.date)}) by ${approverInfo}${modificationMark}`;
                else return `â³ å¾…ç°½æ ¸ by ${approverInfo}`;
            };

            const itemsHTML = (request.items || []).map(item => {
                const subtotal = (item.price || 0) * (item.quantity || 0) + (item.freight || 0) + (item.discount || 0);
                const vendorName = state.vendors.find(v => v.vendor_id === item.vendor)?.short_name || item.vendor || '';
                const product = state.allProducts?.find(p => p.id === item.id);
                const imageUrl = product?.image ? `https://drive.google.com/thumbnail?id=${product.image}` : 'https://placehold.co/48x48?text=ç„¡';
                const invoiceDisplay = item.invoice === 'å…¶ä»–' ? (item.custom_invoice || '') : (item.invoice || '');
                return `
                    <tr style="border-bottom: 1px solid #e5e5e5;">
                        <td style="padding: 8px; border: 1px solid #ddd; width: 56px; text-align:center;">
                            <img src="${imageUrl}" alt="${item.name}" style="width:48px; height:48px; object-fit:cover; border-radius:4px;" onerror="this.onerror=null;this.src='https://placehold.co/48x48?text=ç„¡';" />
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.id || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            ${item.name}
                            <div style="font-size: 10px; color: #666; margin-top: 4px;">
                                <div><strong>åŸå› :</strong> ${item.reason || 'N/A'}</div>
                                <div><strong>èªªæ˜:</strong> ${item.description || 'N/A'}</div>
                            </div>
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.demand_department || ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${invoiceDisplay}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${vendorName}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.price || 0).toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${item.quantity} ${item.unit}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.freight || 0).toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.discount || 0).toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${subtotal.toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.is_scrap_work_order ? 'âœ”ï¸' : ''}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.work_order_number || ''}</td>
                    </tr>`;
            }).join('');

            const handlerStatus = request.handler_status || (request.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
            const lastHandled = (() => {
                const fromApprover = (request.approvers || []).filter(a => (a.role||'').includes('æ¡è³¼') && a.status === 'approved').slice(-1)[0];
                const hist = (request.modification_history || []).filter(h => h.action === 'handled').slice(-1)[0];
                const stamp = hist?.date || fromApprover?.date;
                const who = hist?.user || (fromApprover?.userId ? (state.users[fromApprover.userId]?.name || fromApprover.userId.substring(0,8)) : '');
                return stamp && who ? `${getFormattedDateTime(stamp)} by ${who}` : '';
            })();
            const lastClosed = (() => {
                const hist = (request.modification_history || []).filter(h => h.action === 'closed').slice(-1)[0];
                return hist ? `${getFormattedDateTime(hist.date)} by ${hist.user}` : '';
            })();

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>ç”³è«‹å–® - ${request.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header h1 { margin: 0; font-size: 20px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
                        .info-item { padding: 5px 0; }
                        .info-label { font-weight: bold; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th { background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        .total-row { font-weight: bold; background-color: #f9f9f9; }
                        .approval-section { margin-top: 20px; }
                        .approval-item { margin-bottom: 10px; display: flex; }
                        .approval-role { font-weight: bold; width: 150px; }
                        .approval-status { flex: 1; }
                        .reason-section { margin-top: 20px; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>æ¡è³¼ç”³è«‹å–®</h1>
                        <p>ç”³è«‹å–®è™Ÿ: ${request.id} ${Array.isArray(request.attachments) && request.attachments.length ? 'ğŸ“' : ''}</p>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">ç”³è«‹äºº:</div>
                            <div>${state.users[request.applicant_id]?.name || 'æœªçŸ¥'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ç”³è«‹æ—¥æœŸ:</div>
                            <div>${getFormattedDateTime(request.request_date)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ç”³è«‹éƒ¨é–€:</div>
                            <div>${request.department}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ç°½æ ¸ç‹€æ…‹:</div>
                            <div>${request.status}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ç¶“è¾¦ç‹€æ…‹:</div>
                            <div>${handlerStatus}${lastHandled ? `ï¼ˆ${lastHandled}ï¼‰` : ''}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">çµæ¡ˆç‹€æ…‹:</div>
                            <div>${request.closed_status || 'æœªçµæ¡ˆ'}${lastClosed ? `ï¼ˆ${lastClosed}ï¼‰` : ''}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ç¸½é‡‘é¡:</div>
                            <div>$${Number(request.total_amount).toLocaleString()}</div>
                        </div>
                        <div class="info-item" style="grid-column: span 3;">
                            <div class="info-label">ç¸½èªªæ˜:</div>
                            <div style="white-space: pre-wrap;">${request.reason || ''}</div>
                        </div>
                    </div>

                    ${request.reason ? `` : ''}

                    <h3>ç”³è«‹é …ç›®</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>å•†å“åœ–ç‰‡</th>
                                <th>å•†å“ç·¨è™Ÿ</th>
                                <th>å“å/èªªæ˜</th>
                                <th>éœ€æ±‚èª²å®¤</th>
                                <th>ç™¼ç¥¨é–‹ç«‹</th>
                                <th>å» å•†</th>
                                <th>å–®åƒ¹</th>
                                <th>æ•¸é‡</th>
                                <th>é‹è²»</th>
                                <th>æŠ˜æ‰£</th>
                                <th>å°è¨ˆ</th>
                                <th>å ±å»¢</th>
                                <th>è²¡ç”¢ç·¨è™Ÿ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                            <tr class="total-row">
                                <td colspan="10" style="text-align: right; font-weight: bold;">ç¸½é‡‘é¡:</td>
                                <td style="text-align: right; font-weight: bold;">$${Number(request.total_amount).toLocaleString()}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="approval-section">
                        <h3>ç°½æ ¸æµç¨‹</h3>
                        ${(request.approvers || []).map(approver => {
                            let displayRole = approver.role;
                            if (approver.role === 'ä½¿ç”¨è€…') {
                                if (approver.step === 1) displayRole = 'ç”³è«‹äººä¸»ç®¡';
                                else if (approver.step === 2) displayRole = 'ç”³è«‹äººä¸»ç®¡çš„ä¸»ç®¡';
                                else if (approver.step === 3) displayRole = 'ç¬¬ä¸‰ä¸»ç®¡';
                            }
                            return `
                                <div class="approval-item">
                                    <div class="approval-role">${displayRole}:</div>
                                    <div class="approval-status">${getApproverStatusUI(approver)}</div>
                                </div>
                                ${approver.comment ? `<div style="margin-left: 150px; font-size: 10px; color: #666;">æ„è¦‹: ${approver.comment}</div>` : ''}
                                ${approver.reason ? `<div style="margin-left: 150px; font-size: 10px; color: #d32f2f;">é€€å›åŸå› : ${approver.reason}</div>` : ''}
                            `;
                        }).join('')}
                    </div>

                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">åˆ—å°</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background-color: #757575; color: white; border: none; border-radius: 4px; cursor: pointer;">é—œé–‰</button>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
        };

        window.printMultipleRequests = function(requestIds) {
            const requests = requestIds.map(id => state.requests.find(r => r.id === id)).filter(r => r);
            
            if (requests.length === 0) {
                showMessage('æ‰¾ä¸åˆ°è¦åˆ—å°çš„ç”³è«‹å–®ã€‚', 'error');
                return;
            }

            const getApproverStatusUI = (approver, request) => {
                const approverUser = state.users[approver.userId];
                const approverInfo = approverUser ? `${approverUser.name}` : `${approver.userId.substring(0,8)}`;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºä¿®æ”¹ç•¶ä¸‹çš„ç°½æ ¸åˆ—ï¼ˆå¤šå–®åˆ—å°ç‰ˆæœ¬ï¼‰
                let modificationMark = '';
                if (request.modification_history && request.modification_history.length > 0) {
                    const userToMatch = approverUser ? approverUser.name : approver.userId;
                    const hasEditModification = request.modification_history.some(h => 
                        ((h.userId === approver.userId) || (h.user === userToMatch)) && 
                        (h.action === 'handled_edit' || (h.changes && h.changes.length > 0))
                    );
                    
                    if (hasEditModification) {
                        modificationMark = ' (æœ‰ä¿®æ”¹é)';
                    }
                }
                
                if (approver.status === 'approved') return `âœ”ï¸ å·²æ ¸å‡† (${getFormattedDateTime(approver.date)}) by ${approverInfo}${modificationMark}`;
                else if (approver.status === 'rejected') return `âŒ å·²é€€å› (${getFormattedDateTime(approver.date)}) by ${approverInfo}${modificationMark}`;
                else return `â³ å¾…ç°½æ ¸ by ${approverInfo}`;
            };

            // ç‚ºæ¯å€‹ç”³è«‹å–®ç”Ÿæˆ HTML å…§å®¹
            const requestsHTML = requests.map((request, index) => {
                const itemsHTML = (request.items || []).map(item => {
                    const subtotal = (item.price || 0) * (item.quantity || 0) + (item.freight || 0) + (item.discount || 0);
                    const vendorName = state.vendors.find(v => v.vendor_id === item.vendor)?.short_name || item.vendor || '';
                    const product = state.allProducts?.find(p => p.id === item.id);
                    const imageUrl = product?.image ? `https://drive.google.com/thumbnail?id=${product.image}` : 'https://placehold.co/48x48?text=ç„¡';
                    const invoiceDisplay = item.invoice === 'å…¶ä»–' ? (item.custom_invoice || '') : (item.invoice || '');
                    return `
                        <tr style="border-bottom: 1px solid #e5e5e5;">
                            <td style="padding: 8px; border: 1px solid #ddd; width:56px; text-align:center;">
                                <img src="${imageUrl}" alt="${item.name}" style="width:48px; height:48px; object-fit:cover; border-radius:4px;" onerror="this.onerror=null;this.src='https://placehold.co/48x48?text=ç„¡';" />
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${item.id || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">
                                ${item.name}
                                <div style="font-size: 10px; color: #666; margin-top: 4px;">
                                    <div><strong>åŸå› :</strong> ${item.reason || 'N/A'}</div>
                                    <div><strong>èªªæ˜:</strong> ${item.description || 'N/A'}</div>
                                </div>
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${item.demand_department || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${invoiceDisplay}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${vendorName}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.price || 0).toLocaleString()}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${item.quantity} ${item.unit}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.freight || 0).toLocaleString()}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Number(item.discount || 0).toLocaleString()}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${subtotal.toLocaleString()}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.is_scrap_work_order ? 'âœ”ï¸' : ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${item.work_order_number || ''}</td>
                        </tr>`;
                }).join('');

                const handlerStatus = request.handler_status || (request.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                const lastHandled = (() => {
                    const fromApprover = (request.approvers || []).filter(a => (a.role||'').includes('æ¡è³¼') && a.status === 'approved').slice(-1)[0];
                    const hist = (request.modification_history || []).filter(h => h.action === 'handled').slice(-1)[0];
                    const stamp = hist?.date || fromApprover?.date;
                    const who = hist?.user || (fromApprover?.userId ? (state.users[fromApprover.userId]?.name || fromApprover.userId.substring(0,8)) : '');
                    return stamp && who ? `${getFormattedDateTime(stamp)} by ${who}` : '';
                })();
                const lastClosed = (() => {
                    const hist = (request.modification_history || []).filter(h => h.action === 'closed').slice(-1)[0];
                    return hist ? `${getFormattedDateTime(hist.date)} by ${hist.user}` : '';
                })();

                return `
                    <div class="request-page" style="page-break-after: ${index < requests.length - 1 ? 'always' : 'auto'}; margin-bottom: 40px;">
                        <div class="header" style="text-align: center; margin-bottom: 20px;">
                            <h1 style="margin: 0; font-size: 20px;">æ¡è³¼ç”³è«‹å–®</h1>
                            <p style="margin: 5px 0;">ç”³è«‹å–®è™Ÿ: ${request.id} ${Array.isArray(request.attachments) && request.attachments.length ? 'ğŸ“' : ''}</p>
                        </div>
                        
                        <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">ç”³è«‹äºº:</div>
                                <div>${state.users[request.applicant_id]?.name || 'æœªçŸ¥'}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">ç”³è«‹æ—¥æœŸ:</div>
                                <div>${getFormattedDateTime(request.request_date)}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">ç”³è«‹éƒ¨é–€:</div>
                                <div>${request.department}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">ç°½æ ¸ç‹€æ…‹:</div>
                                <div>${request.status}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">ç¶“è¾¦ç‹€æ…‹:</div>
                                <div>${handlerStatus}${lastHandled ? `ï¼ˆ${lastHandled}ï¼‰` : ''}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">çµæ¡ˆç‹€æ…‹:</div>
                                <div>${request.closed_status || 'æœªçµæ¡ˆ'}${lastClosed ? `ï¼ˆ${lastClosed}ï¼‰` : ''}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0;">
                                <div class="info-label" style="font-weight: bold;">ç¸½é‡‘é¡:</div>
                                <div>$${Number(request.total_amount).toLocaleString()}</div>
                            </div>
                            <div class="info-item" style="padding: 5px 0; grid-column: span 3;">
                                <div class="info-label" style="font-weight: bold;">ç¸½èªªæ˜:</div>
                                <div style="white-space: pre-wrap;">${request.reason || ''}</div>
                            </div>
                        </div>

                        ${request.reason ? `
                        <div class="reason-section" style="margin-top: 20px;">
                            <div class="info-label" style="font-weight: bold;">ç¸½èªªæ˜:</div>
                            <div style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9; white-space: pre-wrap;">${request.reason}</div>
                        </div>
                        ` : ''}

                        <h3>ç”³è«‹é …ç›®</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                            <thead>
                                <tr>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">å•†å“åœ–ç‰‡</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">å•†å“ç·¨è™Ÿ</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">å“å/èªªæ˜</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">éœ€æ±‚èª²å®¤</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">ç™¼ç¥¨é–‹ç«‹</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">å» å•†</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">å–®åƒ¹</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">æ•¸é‡</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">é‹è²»</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">æŠ˜æ‰£</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">å°è¨ˆ</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">å ±å»¢</th>
                                    <th style="background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold;">è²¡ç”¢ç·¨è™Ÿ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                                <tr class="total-row" style="font-weight: bold; background-color: #f9f9f9;">
                                    <td colspan="10" style="text-align: right; font-weight: bold; padding: 8px; border: 1px solid #ddd;">ç¸½é‡‘é¡:</td>
                                    <td style="text-align: right; font-weight: bold; padding: 8px; border: 1px solid #ddd;">$${Number(request.total_amount).toLocaleString()}</td>
                                    <td colspan="2" style="padding: 8px; border: 1px solid #ddd;"></td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="approval-section" style="margin-top: 20px;">
                            <h3>ç°½æ ¸æµç¨‹</h3>
                            ${(request.approvers || []).map(approver => {
                                let displayRole = approver.role;
                                if (approver.role === 'ä½¿ç”¨è€…') {
                                    if (approver.step === 1) displayRole = 'ç”³è«‹äººä¸»ç®¡';
                                    else if (approver.step === 2) displayRole = 'ç”³è«‹äººä¸»ç®¡çš„ä¸»ç®¡';
                                }
                                return `
                                    <div class="approval-item" style="margin-bottom: 10px; display: flex;">
                                        <div class="approval-role" style="font-weight: bold; width: 150px;">${displayRole}:</div>
                                        <div class="approval-status" style="flex: 1;">${getApproverStatusUI(approver, request)}</div>
                                    </div>
                                    ${approver.comment ? `<div style="margin-left: 150px; font-size: 10px; color: #666;">æ„è¦‹: ${approver.comment}</div>` : ''}
                                    ${approver.reason ? `<div style="margin-left: 150px; font-size: 10px; color: #d32f2f;">é€€å›åŸå› : ${approver.reason}</div>` : ''}
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>æ‰¹é‡åˆ—å°ç”³è«‹å–® (${requests.length}å¼µ)</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header h1 { margin: 0; font-size: 20px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
                        .info-item { padding: 5px 0; }
                        .info-label { font-weight: bold; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th { background-color: #f0f0f0; padding: 8px; border: 1px solid #ddd; font-weight: bold; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        .total-row { font-weight: bold; background-color: #f9f9f9; }
                        .approval-section { margin-top: 20px; }
                        .approval-item { margin-bottom: 10px; display: flex; }
                        .approval-role { font-weight: bold; width: 150px; }
                        .approval-status { flex: 1; }
                        .reason-section { margin-top: 20px; }
                        .request-page { margin-bottom: 40px; }
                        .summary-header { 
                            background-color: #e3f2fd; 
                            padding: 15px; 
                            margin-bottom: 30px; 
                            border-radius: 5px; 
                            text-align: center;
                            border: 2px solid #2196F3;
                        }
                        .summary-header h2 { margin: 0; color: #1976d2; }
                        .summary-stats { 
                            display: grid; 
                            grid-template-columns: repeat(4, 1fr); 
                            gap: 15px; 
                            margin-top: 10px; 
                        }
                        .summary-stat { 
                            background: white; 
                            padding: 10px; 
                            border-radius: 3px; 
                            text-align: center;
                            border: 1px solid #ccc;
                        }
                        .summary-stat .number { font-size: 18px; font-weight: bold; color: #1976d2; }
                        .summary-stat .label { font-size: 11px; color: #666; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                            .request-page { page-break-after: always; }
                            .request-page:last-child { page-break-after: auto; }
                        }
                    </style>
                </head>
                <body>
                    <div class="summary-header no-print">
                        <h2>æ‰¹é‡åˆ—å°ç”³è«‹å–®åŒ¯ç¸½</h2>
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="number">${requests.length}</div>
                                <div class="label">ç”³è«‹å–®æ•¸é‡</div>
                            </div>
                            <div class="summary-stat">
                                <div class="number">$${requests.reduce((sum, r) => sum + Number(r.total_amount || 0), 0).toLocaleString()}</div>
                                <div class="label">ç¸½é‡‘é¡</div>
                            </div>
                            <div class="summary-stat">
                                <div class="number">${requests.reduce((sum, r) => sum + (r.items || []).length, 0)}</div>
                                <div class="label">ç”³è«‹é …ç›®ç¸½æ•¸</div>
                            </div>
                            <div class="summary-stat">
                                <div class="number">${new Set(requests.map(r => r.applicant_id)).size}</div>
                                <div class="label">ç”³è«‹äººæ•¸</div>
                            </div>
                        </div>
                    </div>

                    ${requestsHTML}

                    <div class="no-print" style="margin-top: 30px; text-align: center; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <button onclick="window.print()" style="padding: 12px 24px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px;">åˆ—å°å…¨éƒ¨</button>
                        <button onclick="window.close()" style="padding: 12px 24px; background-color: #757575; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">é—œé–‰</button>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
        };

        window.renderPrintManagement = function() {
            const viewEl = document.getElementById('printManagement-view');
            const currentDate = new Date();
            const lastMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            const thisMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            
            const formatDateForInput = (date) => {
                return date.toISOString().split('T')[0];
            };

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">è¡¨å–®åˆ—å°ä½œæ¥­</h1>
                    <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-4">åˆ—å°æ¢ä»¶è¨­å®š</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ—¥æœŸ</label>
                                <input type="date" id="print-start-date" class="w-full rounded-md border-gray-300 shadow-sm" value="${formatDateForInput(lastMonth)}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ—¥æœŸ</label>
                                <input type="date" id="print-end-date" class="w-full rounded-md border-gray-300 shadow-sm" value="${formatDateForInput(currentDate)}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ç”³è«‹å–®ç‹€æ…‹</label>
                                <select id="print-status-filter" class="w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="å¾…å¯©æ ¸">å¾…å¯©æ ¸</option>
                                    <option value="å·²æ ¸å‡†">å·²æ ¸å‡†</option>
                                    <option value="å·²é€€å›">å·²é€€å›</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ç”³è«‹äºº</label>
                                <select id="print-applicant-filter" class="w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">å…¨éƒ¨</option>
                                    ${Object.values(state.users).map(user => 
                                        `<option value="${user.id}">${user.name} (${user.department})</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button data-action="search-print-requests" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">æœå°‹ç”³è«‹å–®</button>
                            <button data-action="print-selected-requests" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700" disabled>åˆ—å°é¸å–çš„ç”³è«‹å–®</button>
                        </div>
                    </div>

                    <div id="print-search-results" class="hidden">
                        <h3 class="text-lg font-bold mb-4">æœå°‹çµæœ</h3>
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="select-all-print" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-700">å…¨é¸</span>
                            </label>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¸å–</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”³è«‹å–®è™Ÿ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”³è«‹äºº</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”³è«‹æ—¥æœŸ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">éƒ¨é–€</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç°½æ ¸ç‹€æ…‹</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¸½é‡‘é¡</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="print-results-table" class="bg-white divide-y divide-gray-200">
                                    <!-- æœå°‹çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            viewEl.style.display = 'block';
        };

        window.renderProductForm = function() {
            const viewEl = document.getElementById('productForm-view');
            const product = state.editingProduct;
            const isEditing = !!product;
            const formData = product || { id: '', name: '', category: '', vendor: '', spec: '', price: 0, unit: '', ordering_system: 'ç‰¹æ¡', image: '' };
            const imageUrl = formData.image ? `https://drive.google.com/thumbnail?id=${formData.image}` : 'https://placehold.co/200x200?text=ç„¡åœ–ç‰‡';
            
            const vendorOptions = state.vendors.map(v => 
                `<option value="${v.vendor_id}" ${formData.vendor === v.vendor_id ? 'selected' : ''}>${v.short_name || v.name} (${v.vendor_id})</option>`
            ).join('');

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å•†å“'}</h1>
                    <button data-view="productManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-4xl mx-auto">
                    <form id="product-form" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 flex flex-col items-center">
                            <img id="product-form-image-preview" src="${imageUrl}" alt="Product Image" class="w-48 h-48 object-cover mb-4 rounded-md border" onerror="this.onerror=null;this.src='https://placehold.co/200x200?text=åœ–ç‰‡éŒ¯èª¤';"/>
                            <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                            <label for="image-upload-input" class="cursor-pointer px-4 py-2 text-sm bg-gray-200 rounded-md hover:bg-gray-300">é¸æ“‡åœ–ç‰‡</label>
                            <span id="image-upload-filename" class="text-xs text-gray-500 mt-2">å°šæœªé¸æ“‡æª”æ¡ˆ</span>
                            <button type="button" id="image-upload-button" data-action="upload-image" class="mt-2 px-4 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50" disabled>ä¸Šå‚³åœ–ç‰‡</button>
                            <input type="hidden" name="image" value="${formData.image || ''}">
                        </div>

                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å•†å“ç·¨è™Ÿ</label>
                                <input type="text" name="id" value="${formData.id}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100" ${isEditing ? 'readonly' : 'required'}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å“å</label>
                                <input type="text" name="name" value="${formData.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">åˆ†é¡</label>
                                <input type="text" name="category" value="${formData.category}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å» å•†</label>
                                <select name="vendor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- è«‹é¸æ“‡å» å•† --</option>
                                    ${vendorOptions}
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">è¦æ ¼</label>
                                <textarea name="spec" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${formData.spec || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å–®åƒ¹</label>
                                <input type="number" name="price" step="any" value="${formData.price}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å–®ä½</label>
                                <input type="text" name="unit" value="${formData.unit}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">è¨‚è³¼ç³»çµ±</label>
                                <input type="text" name="ordering_system" value="${formData.ordering_system}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                        </div>
                        
                        <div class="md:col-span-3 flex justify-end mt-4">
                            <button type="button" data-action="save-product" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">å„²å­˜</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderPersonalForms = function() {
            const viewEl = document.getElementById('personalForms-view');
            const { activeTab } = state.local.personalForms;
            
            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">å€‹äººå°ˆå€</h1>
                    <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›ä¸»å„€è¡¨æ¿</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button data-tab="inbox" class="tab-button ${activeTab === 'inbox' ? 'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">æ”¶ä»¶è³‡æ–™å¤¾</button>
                            <button data-tab="sent" class="tab-button ${activeTab === 'sent' ? 'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">åŸç¨¿è³‡æ–™å¤¾</button>
                            <button data-tab="history" class="tab-button ${activeTab === 'history' ?'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">é€ç´šé€šçŸ¥è³‡æ–™å¤¾</button>
                            <button data-tab="handler" class="tab-button ${activeTab === 'handler' ?'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">å·²ç¶“è¾¦è³‡æ–™å¤¾</button>
                            <button data-tab="closed" class="tab-button ${activeTab === 'closed' ?'active' : ''} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">çµæ¡ˆè³‡æ–™å¤¾</button>
                        </nav>
                    </div>
                    <div id="personal-forms-content" class="mt-6">
                    </div>
                </div>`;
            
            renderPersonalFormsContent();
            viewEl.style.display = 'block';
        };
        
        const renderPersonalFormsContent = () => {
            const contentEl = document.getElementById('personal-forms-content');
            if (!contentEl) return;

            const { activeTab } = state.local.personalForms;
            const filters = state.local.personalForms[activeTab];
            const { currentUser, requests, applicantNotifications } = state;
            
            let items = [];
            let isRequestList = true;

            if (activeTab === 'inbox') {
                isRequestList = false;
                items = [...applicantNotifications].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                 if (filters.searchTerm) {
                    const lowerSearchTerm = filters.searchTerm.toLowerCase();
                    items = items.filter(n => JSON.stringify(n).toLowerCase().includes(lowerSearchTerm));
                }
            } else if (['sent','history'].includes(activeTab)) {
                let baseRequests = [];
                if (activeTab === 'sent') {
                    baseRequests = requests.filter(req => req.applicant_id === currentUser.id);
                } else if (activeTab === 'history') {
                    baseRequests = requests.filter(req => (req.approvers || []).some(a => a.userId === currentUser.id && (a.status === 'approved' || a.status === 'rejected')));
                }

                items = baseRequests.filter(req => {
                    if (filters.status !== 'all' && req.status !== filters.status) return false;
                    if (filters.searchTerm && !JSON.stringify(req).toLowerCase().includes(filters.searchTerm.toLowerCase())) return false;
                    
                    if (activeTab === 'sent' || activeTab === 'history') {
                        const requestDate = getISODateString(req.request_date);
                        if (filters.dateFrom && requestDate < filters.dateFrom) return false;
                        if (filters.dateTo && requestDate > filters.dateTo) return false;
                    }
                    return true;
                });
            } else if (activeTab === 'handler') {
                // ç¶“è¾¦è³‡æ–™å¤¾ï¼šä½¿ç”¨è€…æ˜¯ handlerï¼Œæœªçµæ¡ˆå„ªå…ˆé¡¯ç¤ºï¼›å¯ä¾ç¶“è¾¦ç‹€æ…‹èˆ‡æ—¥æœŸ/ç‹€æ…‹/é—œéµå­—éæ¿¾
                let baseRequests = requests.filter(req => req.handler_id === currentUser.id || state.currentUser.is_admin || ['æ¡è³¼','æ¡è³¼ä¸»ç®¡'].includes(state.currentUser.role));
                items = baseRequests.filter(req => {
                    if (filters.status !== 'all' && req.status !== filters.status) return false;
                    // åƒ…é¡¯ç¤ºå·²ç¶“è¾¦
                    const eff = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                    if (eff !== 'å·²ç¶“è¾¦') return false;
                    if (filters.searchTerm && !JSON.stringify(req).toLowerCase().includes(filters.searchTerm.toLowerCase())) return false;
                    const requestDate = getISODateString(req.request_date);
                    if (filters.dateFrom && requestDate < filters.dateFrom) return false;
                    if (filters.dateTo && requestDate > filters.dateTo) return false;
                    // é è¨­åªé¡¯ç¤ºæœªçµæ¡ˆï¼ˆå·²çµæ¡ˆåœ¨çµæ¡ˆè³‡æ–™å¤¾ï¼‰
                    return req.closed_status !== 'çµæ¡ˆ';
                });
                // ä¾ç¶“è¾¦ç‹€æ…‹æ’åºï¼šå¾…ç¶“è¾¦å„ªå…ˆ
                const order = { 'æœªç¶“è¾¦': 0, 'å¾…ç¶“è¾¦': 1, 'å·²ç¶“è¾¦': 2 };
                items.sort((a,b) => {
                    const ea = a.handler_status || (a.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                    const eb = b.handler_status || (b.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                    if (order[ea] !== order[eb]) return order[ea] - order[eb];
                    return new Date(b.request_date) - new Date(a.request_date);
                });
            } else if (activeTab === 'closed') {
                // çµæ¡ˆè³‡æ–™å¤¾ï¼šæ‰€æœ‰å·²çµæ¡ˆçš„å–®æ“šï¼Œé è¨­åªé¡¯ç¤ºç”³è«‹äººæˆ–æ›¾ç¶“è¾¦éè€…é—œè¯ï¼Œå¯å†ä¾ç‹€æ…‹/æ—¥æœŸ/æœå°‹
                let baseRequests = requests.filter(req => req.closed_status === 'çµæ¡ˆ' && (
                    req.applicant_id === currentUser.id || req.handler_id === currentUser.id || (req.approvers||[]).some(a => a.userId === currentUser.id)
                ));
                items = baseRequests.filter(req => {
                    if (filters.status !== 'all' && req.status !== filters.status) return false;
                    if (filters.searchTerm && !JSON.stringify(req).toLowerCase().includes(filters.searchTerm.toLowerCase())) return false;
                    const requestDate = getISODateString(req.request_date);
                    if (filters.dateFrom && requestDate < filters.dateFrom) return false;
                    if (filters.dateTo && requestDate > filters.dateTo) return false;
                    return true;
                }).sort((a,b) => new Date(b.request_date) - new Date(a.request_date));
            }

            const itemsHTML = items.length > 0 ? items.map(item => {
                if (isRequestList) {
                    const req = item;
                    // Add this debug log
                    if (req.id === undefined || req.id === null || req.id === '') {
                        console.warn(`DEBUG: Found request with invalid ID in personal forms:`, req);
                    }
                    const canDelete = req.status === 'å¾…é€å‡º' && (req.applicant_id === state.currentUser.id || state.currentUser.is_admin);
                    console.log(`Request ID: ${req.id}, Status: ${req.status}, Applicant ID: ${req.applicant_id}, Current User ID: ${state.currentUser.id}, Is Admin: ${state.currentUser.is_admin}, Can Delete: ${canDelete}`);
                    const effHandler = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                    const handlerChipCls = ({'æœªç¶“è¾¦': 'bg-neutral-100 text-neutral-800','å¾…ç¶“è¾¦': 'bg-amber-100 text-amber-800','å·²ç¶“è¾¦': 'bg-green-100 text-green-800'})[effHandler] || 'bg-gray-100 text-gray-800';
                    const closedChipCls = ({'æœªçµæ¡ˆ': 'bg-gray-100 text-gray-800','çµæ¡ˆ': 'bg-purple-100 text-purple-800'})[req.closed_status || 'æœªçµæ¡ˆ'] || 'bg-gray-100 text-gray-800';
                    return `
                        <li class="border p-4 rounded-lg hover:bg-gray-50">
                            <div class="flex justify-between items-center">
                                <a href="#" data-action="view-detail" data-id="${req.id}" class="block flex-grow">
                                    <div class="flex justify-between items-center">
                                        <p class="font-bold text-blue-600">${req.id}</p>
                                        <div class="flex items-center gap-2">
                                            <span class="px-3 py-1 rounded-full text-xs font-medium ${{'å¾…é€å‡º': 'bg-gray-100 text-gray-800', 'å¾…å¯©æ ¸': 'bg-yellow-100 text-yellow-800', 'å·²æ ¸å‡†': 'bg-green-100 text-green-800', 'å·²é€€å›': 'bg-red-100 text-red-800'}[req.status] || 'bg-gray-100 text-gray-800'}">${req.status}</span>
                                            <span class="px-3 py-1 rounded-full text-xs font-medium ${handlerChipCls}">${effHandler}</span>
                                            <span class="px-3 py-1 rounded-full text-xs font-medium ${closedChipCls}">${req.closed_status || 'æœªçµæ¡ˆ'}</span>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-2">ç”³è«‹æ—¥æœŸ: ${getFormattedDateTime(req.request_date)}</p>
                                    <p class="text-sm text-gray-600">ç¸½é‡‘é¡: ${Number(req.total_amount).toLocaleString()}</p>
                                    <p class="text-sm text-gray-500 mt-1 truncate">åŸå› : ${req.reason || 'ç„¡'}</p>
                                </a>
                                ${canDelete && req.id ? `<button data-id="${req.id}" data-action="delete-draft" class="text-red-600 hover:text-red-900 ml-4">åˆªé™¤</button>` : ''}
                            </div>
                        </li>`;
                } else {
                    const n = item;
                    // ä¿®æ­£ï¼šé»æ“Šé€šçŸ¥é€£çµæ™‚ï¼Œè‹¥ request å­˜åœ¨æ‰å¯é–‹å•Ÿ
                    const requestExists = state.requests.some(r => r.id == n.request_id);
                    return `
                        <li class="p-4 rounded-lg ${n.is_read ? 'bg-gray-50' : 'bg-blue-50'}">
                            <a href="#" data-action="view-notification-detail" data-id="${n.request_id}" data-notification-id="${n.id}" class="block ${requestExists ? '' : 'pointer-events-none opacity-50'}">
                                <div class="flex justify-between items-center">
                                    <p class="text-sm text-gray-800 ${!n.is_read ? 'font-bold' : ''}">${n.message}</p>
                                    <span class="text-xs text-gray-500 whitespace-nowrap">${getFormattedDateTime(n.timestamp)}</span>
                                </div>
                            </a>
                        </li>`;
                }
            }).join('') : `<p class="text-center text-gray-500 py-8">æ­¤è³‡æ–™å¤¾ä¸­æ²’æœ‰ä»»ä½•é …ç›®ã€‚</p>`;

            let dateFilterHTML = '';
            if (activeTab === 'sent' || activeTab === 'history' || activeTab === 'handler' || activeTab === 'closed') {
                const dateFrom = filters.dateFrom || '';
                const dateTo = filters.dateTo || '';
                dateFilterHTML = `
                    <div class="flex items-center space-x-2">
                        <input type="date" data-filter-type="dateFrom" value="${dateFrom}" class="personal-forms-filter p-2 border border-gray-300 rounded-md shadow-sm" />
                        <span>~</span>
                        <input type="date" data-filter-type="dateTo" value="${dateTo}" class="personal-forms-filter p-2 border border-gray-300 rounded-md shadow-sm" />
                    </div>
                `;
            }

            contentEl.innerHTML = `
                <div class="flex flex-wrap gap-4 items-center mb-4">
                    ${dateFilterHTML}
                    ${['sent','history','handler','closed'].includes(activeTab) ? `
                    <select data-filter-type="status" class="personal-forms-filter p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="all" ${filters.status === 'all' ? 'selected' : ''}>æ‰€æœ‰ç‹€æ…‹</option>
                        <option value="å¾…é€å‡º" ${filters.status === 'å¾…é€å‡º' ? 'selected' : ''}>å¾…é€å‡º</option>
                        <option value="å¾…å¯©æ ¸" ${filters.status === 'å¾…å¯©æ ¸' ? 'selected' : ''}>å¾…å¯©æ ¸</option>
                        <option value="å·²æ ¸å‡†" ${filters.status === 'å·²æ ¸å‡†' ? 'selected' : ''}>å·²æ ¸å‡†</option>
                        <option value="å·²é€€å›" ${filters.status === 'å·²é€€å›' ? 'selected' : ''}>å·²é€€å›</option>
                    </select>` : ''}
                    ${activeTab === 'handler' ? '' : ''}
                    <input type="text" data-filter-type="searchTerm" placeholder="æœå°‹..." class="personal-forms-filter flex-grow p-2 border border-gray-300 rounded-md shadow-sm" value="${filters.searchTerm || ''}">
                </div>
                <ul class="space-y-4">${itemsHTML}</ul>
            `;
        };

        window.renderUserManagement = function() {
            const viewEl = document.getElementById('userManagement-view');
            const { department, searchTerm } = state.local.userManagementFilters;
            const allDepartments = ['all', ...Object.keys(state.departments)];

            const filteredUsers = Object.values(state.users).filter(user => {
                if (department !== 'all' && user.department !== department) return false;
                if (searchTerm && !JSON.stringify(user).toLowerCase().includes(searchTerm.toLowerCase())) return false;
                return true;
            });

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">ä½¿ç”¨è€…ç®¡ç†</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                        <button data-action="add-user" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">æ–°å¢ä½¿ç”¨è€…</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select id="user-dept-filter" class="p-2 border border-gray-300 rounded-md shadow-sm">
                            ${allDepartments.map(d => `<option value="${d}" ${department === d ? 'selected' : ''}>${d === 'all' ? 'æ‰€æœ‰éƒ¨é–€' : d}</option>`).join('')}
                        </select>
                        <input type="text" id="user-search-input" placeholder="æœå°‹å§“åã€Emailã€å·¥è™Ÿ..." class="md:col-span-2 p-2 border border-gray-300 rounded-md shadow-sm" value="${searchTerm}">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å§“å</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">éƒ¨é–€</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç™¼ç¥¨é–‹ç«‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">è§’è‰²</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ç°½æ ¸ç‹€æ…‹</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">åŠŸèƒ½</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredUsers.map(user => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.department || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.default_invoice || ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${user.role} ${user.is_admin ?'(ç®¡ç†å“¡)' : ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center">
                                            <button data-action="toggle-user-enabled" data-id="${user.id}" data-enabled="${user.is_enabled}" class="px-3 py-1 rounded-full text-xs font-medium ${user.is_enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${user.is_enabled ? 'å•Ÿç”¨' : 'åœç”¨'}
                                            </button>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-id="${user.id}" data-action="edit-user" class="text-blue-600 hover:text-blue-900">ç·¨è¼¯</button>
                                            <button data-id="${user.id}" data-name="${user.name}" data-action="reset-password" class="text-yellow-600 hover:text-yellow-900 ml-4">é‡è¨­å¯†ç¢¼</button>
                                            <button data-id="${user.id}" data-name="${user.name}" data-action="delete-user" class="text-red-600 hover:text-red-900 ml-4">åˆªé™¤</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderUserForm = function() {
            const viewEl = document.getElementById('userForm-view');
            const user = state.editingUser;
            const formData = user || { email: '', name: '', employee_id: '', role: 'ä½¿ç”¨è€…', department: '', demand_department: '', default_invoice: '', is_admin: false, is_department_head: false, is_enabled: true, manager_id: null, manager_id2: null, manager_id3: null, is_handler: false };
            const isEditing = !!user;
            
            const allUsers = Object.values(state.users);
            const allDepartments = Object.keys(state.departments);
            const allRoles = ['ä½¿ç”¨è€…', 'æ¡è³¼', 'æ¡è³¼ä¸»ç®¡', 'é™¢é•·'];

            const userOptions = allUsers
                .filter(u => !isEditing || u.id !== user.id)
                .map(u => `<option value="${u.id}" ${ (isEditing && (u.id === formData.manager_id || u.id === formData.manager_id2)) ? 'selected' : '' }>${u.name} (${u.email})</option>`).join('');

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? 'ç·¨è¼¯ä½¿ç”¨è€…' : 'æ–°å¢ä½¿ç”¨è€…'}</h1>
                    <button data-view="userManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-2xl mx-auto">
                    <form id="user-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" name="email" value="${formData.email}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å§“å</label>
                                <input type="text" name="name" value="${formData.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å·¥è™Ÿ</label>
                                <input type="text" name="employee_id" value="${formData.employee_id || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                            </div>
                            ${!isEditing ? `
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å¯†ç¢¼</label>
                                <input type="password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required placeholder="è‡³å°‘6ä½æ•¸" />
                            </div>` : ''}
                            <div>
                                <label class="block text-sm font-medium text-gray-700">è§’è‰²</label>
                                <select name="role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    ${allRoles.map(r => `<option value="${r}" ${formData.role === r ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">éƒ¨é–€</label>
                                <select name="department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    ${allDepartments.map(d => `<option value="${d}" ${formData.department === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">é è¨­éœ€æ±‚èª²å®¤</label>
                                <select name="demand_department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}" ${formData.demand_department === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">é è¨­ç™¼ç¥¨é–‹ç«‹</label>
                                <select name="default_invoice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    ${[
                                        "8Cæ¸…ç¦", "7Cæ¸…æ°£", "6Cæ¸…å¿ƒ", "5Cæ¸…å¹³", "3Cæ¸…å®‰", "2CDæ¸…è­·",
                                        "8Dæ¸…æ˜¥", "7Dæ¸…æ—¥", "6Dæ¸…ç…§", "5Dæ¸…é¢¨", "3Dæ¸…æ™¯", "8Eæ¸…å±±",
                                        "7Eæ¸…æ³‰", "6Eæ¸…æ°´", "8Eæ¸…æ¸…", "3Eæ¸…æ¶¼", "æ¸…ç¦æ³•äºº", "ä¸€é¤¨",
                                        "äºŒé¤¨", "ä¸‰é¤¨", "å«ç¬‘", "æ¸…ç¦å¹¼å…’åœ’", "å…¶ä»–"
                                    ].map(opt => `<option value="${opt}" ${formData.default_invoice === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ç›´å±¬ä¸»ç®¡</label>
                                <select name="manager_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- ç„¡ --</option>
                                    ${allUsers.map(u => `<option value="${u.id}" ${formData.manager_id === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ç¬¬äºŒä¸»ç®¡</label>
                                <select name="manager_id2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- ç„¡ --</option>
                                    ${allUsers.map(u => `<option value="${u.id}" ${formData.manager_id2 === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ç¬¬ä¸‰ä¸»ç®¡</label>
                                <select name="manager_id3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- ç„¡ --</option>
                                    ${allUsers.map(u => `<option value="${u.id}" ${formData.manager_id3 === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                            </div>
                            ${isEditing ? `
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">é‡è¨­å¯†ç¢¼</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <input type="password" name="new_password" placeholder="è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆç•™ç©ºå‰‡ä¸ä¿®æ”¹ï¼‰" class="block w-full rounded-md border-gray-300 shadow-sm">
                                    <button type="button" id="show-password-btn" class="px-3 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">é¡¯ç¤º</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">å¦‚éœ€é‡è¨­æ­¤ä½¿ç”¨è€…çš„ç™»å…¥å¯†ç¢¼ï¼Œè«‹è¼¸å…¥æ–°å¯†ç¢¼ã€‚å¯†ç¢¼é•·åº¦è‡³å°‘6ä½ã€‚</p>
                            </div>
                            ` : ''}
                            <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_admin" name="is_admin" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_admin ? 'checked' : ''} />
                                <label for="is_admin" class="ml-2 block text-sm text-gray-900">è¨­ç‚ºç³»çµ±ç®¡ç†å“¡</label>
                            </div>
                            <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_handler" name="is_handler" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_handler ? 'checked' : ''} />
                                <label for="is_handler" class="ml-2 block text-sm text-gray-900">è¨­ç‚ºç¶“è¾¦äººå“¡</label>
                            </div>
                             <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_department_head" name="is_department_head" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_department_head ? 'checked' : ''} />
                                <label for="is_department_head" class="ml-2 block text-sm text-gray-900">è¨­ç‚ºéƒ¨é–€ä¸»ç®¡</label>
                            </div>
                            <div class="md:col-span-2 flex items-center">
                                <input type="checkbox" id="is_enabled" name="is_enabled" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${formData.is_enabled ? 'checked' : ''} />
                                <label for="is_enabled" class="ml-2 block text-sm text-gray-900">å•Ÿç”¨æ­¤å¸³è™Ÿ</label>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="button" data-action="save-user" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">å„²å­˜</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        // éƒ¨é–€ç®¡ç†åˆ—è¡¨
        window.renderDepartmentManagement = function() {
            const viewEl = document.getElementById('departmentManagement-view');
            const search = (state.local.departmentManagementSearchTerm || '').toLowerCase();
            const rows = Object.entries(state.departments)
                .map(([department, director_threshold]) => ({ department, director_threshold }))
                .filter(d => JSON.stringify(d).toLowerCase().includes(search))
                .sort((a,b) => a.department.localeCompare(b.department, 'zh-Hant'));

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">éƒ¨é–€ç®¡ç†</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                        <button data-action="add-department" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">æ–°å¢éƒ¨é–€</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-4">
                        <input type="text" id="department-search-input" placeholder="æœå°‹éƒ¨é–€..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm" value="${state.local.departmentManagementSearchTerm || ''}">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">éƒ¨é–€åç¨±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¸»ç®¡ç°½æ ¸é–€æª»</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">åŠŸèƒ½</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${rows.map(d => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${d.department}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${d.director_threshold ?? ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-dept="${d.department}" data-action="edit-department" class="text-blue-600 hover:text-blue-900">ç·¨è¼¯</button>
                                            <button data-dept="${d.department}" data-action="delete-department" class="text-red-600 hover:text-red-900 ml-4">åˆªé™¤</button>
                                        </td>
                                    </tr>
                                `).join('') || `<tr><td colspan="3" class="text-center py-10 text-gray-500">å°šç„¡éƒ¨é–€è³‡æ–™</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        // æœƒè©±ç®¡ç†åˆ—è¡¨
        window.renderSessionManagement = async function() {
            const viewEl = document.getElementById('sessionManagement-view');
            
            try {
                // ç²å–æ‰€æœ‰æ´»èºçš„ç™»å…¥æœƒè©±
                const { data: sessions, error } = await supabase
                    .from('login_sessions')
                    .select(`
                        *,
                        users (name, email, user_id, department)
                    `)
                    .eq('is_active', true)
                    .order('last_used', { ascending: false });

                if (error) throw error;

                const now = new Date();
                const activeSessions = sessions?.filter(session => 
                    new Date(session.expires_at) > now
                ) || [];

                viewEl.innerHTML = `
                    <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                        <h1 class="text-2xl font-bold text-gray-700">ç™»å…¥æœƒè©±ç®¡ç†</h1>
                        <div class="flex space-x-4">
                            <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                            <button data-action="cleanup-expired-sessions" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">æ¸…é™¤éæœŸæœƒè©±</button>
                            <button data-action="refresh-sessions" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">é‡æ–°æ•´ç†</button>
                        </div>
                    </div>
                    <div class="bg-white shadow-md rounded-lg p-6">
                        <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="text-green-800 text-sm font-medium">æ´»èºæœƒè©±</div>
                                <div class="text-2xl font-bold text-green-900">${activeSessions.length}</div>
                            </div>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="text-yellow-800 text-sm font-medium">ä»Šæ—¥ç™»å…¥</div>
                                <div class="text-2xl font-bold text-yellow-900">${activeSessions.filter(s => 
                                    new Date(s.created_at).toDateString() === now.toDateString()
                                ).length}</div>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="text-blue-800 text-sm font-medium">è¨˜ä½ç™»å…¥</div>
                                <div class="text-2xl font-bold text-blue-900">${activeSessions.length}</div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä½¿ç”¨è€…</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">éƒ¨é–€</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å»ºç«‹æ™‚é–“</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æœ€å¾Œä½¿ç”¨</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">éæœŸæ™‚é–“</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç€è¦½å™¨</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${activeSessions.map(session => {
                                        const user = session.users;
                                        const isExpiringSoon = new Date(session.expires_at) - now < 7 * 24 * 60 * 60 * 1000; // 7å¤©å…§éæœŸ
                                        const browserInfo = session.user_agent ? 
                                            session.user_agent.includes('Chrome') ? 'Chrome' :
                                            session.user_agent.includes('Firefox') ? 'Firefox' :
                                            session.user_agent.includes('Safari') ? 'Safari' :
                                            session.user_agent.includes('Edge') ? 'Edge' : 'å…¶ä»–'
                                            : 'æœªçŸ¥';
                                        
                                        return `
                                            <tr class="${isExpiringSoon ? 'bg-yellow-50' : ''}">
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm font-medium text-gray-900">${user?.name || 'æœªçŸ¥'}</div>
                                                    <div class="text-sm text-gray-500">${user?.email || session.user_id.substring(0, 8)}</div>
                                                    <div class="text-xs text-gray-400">${user?.user_id || ''}</div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user?.department || 'æœªè¨­å®š'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${getFormattedDateTime(session.created_at)}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${getFormattedDateTime(session.last_used)}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm ${isExpiringSoon ? 'text-yellow-600 font-medium' : 'text-gray-900'}">${getFormattedDateTime(session.expires_at)}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${browserInfo}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                                        isExpiringSoon ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'
                                                    }">
                                                        ${isExpiringSoon ? 'å³å°‡éæœŸ' : 'æ­£å¸¸'}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                                    <button data-session-id="${session.id}" data-action="revoke-session" class="text-red-600 hover:text-red-900">æ’¤éŠ·</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('') || `<tr><td colspan="8" class="text-center py-10 text-gray-500">ç›®å‰æ²’æœ‰æ´»èºçš„ç™»å…¥æœƒè©±</td></tr>`}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('è¼‰å…¥æœƒè©±è³‡æ–™å¤±æ•—:', error);
                viewEl.innerHTML = `
                    <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                        <h1 class="text-2xl font-bold text-gray-700">ç™»å…¥æœƒè©±ç®¡ç†</h1>
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                    </div>
                    <div class="bg-white shadow-md rounded-lg p-6">
                        <div class="text-center py-10 text-red-500">
                            è¼‰å…¥æœƒè©±è³‡æ–™å¤±æ•—ï¼š${error.message}
                        </div>
                    </div>
                `;
            }
            
            viewEl.style.display = 'block';
        };

        // éƒ¨é–€è¡¨å–®
        window.renderDepartmentForm = function() {
            const viewEl = document.getElementById('departmentForm-view');
            const dept = state.editingDepartment || null;
            const isEditing = !!dept;
            const formData = dept || { department: '', director_threshold: '' };

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? 'ç·¨è¼¯éƒ¨é–€' : 'æ–°å¢éƒ¨é–€'}</h1>
                    <button data-view="departmentManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-2xl mx-auto">
                    <form id="department-form">
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">éƒ¨é–€åç¨±*</label>
                                <input type="text" name="department" value="${formData.department || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm ${isEditing ? 'bg-gray-100' : ''}" ${isEditing ? 'readonly' : 'required'}>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ä¸»ç®¡ç°½æ ¸é–€æª»(é‡‘é¡)</label>
                                <input type="number" name="director_threshold" value="${formData.director_threshold ?? ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0" step="1">
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="button" data-action="save-department" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">å„²å­˜</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderVendorManagement = function() {
            const viewEl = document.getElementById('vendorManagement-view');
            const searchTerm = state.local.vendorManagementSearchTerm.toLowerCase();
            const filteredVendors = state.vendors.filter(v => 
                JSON.stringify(v).toLowerCase().includes(searchTerm)
            );

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">å» å•†ç®¡ç†</h1>
                    <div class="flex space-x-4">
                        <button data-view="dashboard" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                        <button data-action="add-vendor" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">æ–°å¢å» å•†</button>
                    </div>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6">
                    <div class="mb-4">
                        <input type="text" id="vendor-search-input" placeholder="æœå°‹å» å•†..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm" value="${state.local.vendorManagementSearchTerm}">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å» å•†ä»£è™Ÿ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å» å•†ç°¡ç¨±</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">è¯çµ¡äºº</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é€£çµ¡é›»è©±</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">åŠŸèƒ½</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredVendors.map(v => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.vendor_id}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.short_name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.contact_person || ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${v.phone || ''}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                            <button data-id="${v.vendor_id}" data-action="edit-vendor" class="text-blue-600 hover:text-blue-900">ç·¨è¼¯</button>
                                            <button data-id="${v.vendor_id}" data-name="${v.name}" data-action="delete-vendor" class="text-red-600 hover:text-red-900 ml-4">åˆªé™¤</button>
                                        </td>
                                    </tr>
                                `).join('') || `<tr><td colspan="5" class="text-center py-10 text-gray-500">æ‰¾ä¸åˆ°å» å•†</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        window.renderVendorForm = function() {
            const viewEl = document.getElementById('vendorForm-view');
            const vendor = state.editingVendor;
            const isEditing = !!vendor;
            const formData = vendor || { tax_id: '', address: '', invoice_address: '', mailing_address: '' };

            viewEl.innerHTML = `
                <div class="bg-white shadow-sm mb-6 p-4 rounded-lg flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold text-gray-700">${isEditing ? 'ç·¨è¼¯å» å•†' : 'æ–°å¢å» å•†'}</h1>
                    <button data-view="vendorManagement" class="view-switch-btn px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">è¿”å›åˆ—è¡¨</button>
                </div>
                <div class="bg-white shadow-md rounded-lg p-6 max-w-4xl mx-auto">
                    <form id="vendor-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Column 1 -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">å» å•†ä»£è™Ÿ*</label>
                                    <input type="text" name="vendor_id" value="${formData.vendor_id || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100" ${isEditing ? 'readonly' : 'required'}>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">å» å•†åç¨±*</label>
                                    <input type="text" name="name" value="${formData.name || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">å» å•†ç°¡ç¨±*</label>
                                    <input type="text" name="short_name" value="${formData.short_name || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">çµ±ä¸€ç·¨è™Ÿ</label>
                                    <input type="text" name="tax_id" value="${formData.tax_id || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <p id="tax-id-error" class="text-xs text-red-500 mt-1 hidden">çµ±ä¸€ç·¨è™Ÿæ ¼å¼éŒ¯èª¤</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">è¯çµ¡äºº</label>
                                    <input type="text" name="contact_person" value="${formData.contact_person || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                            </div>
                            <!-- Column 2 -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">é€£çµ¡é›»è©±</label>
                                    <input type="text" name="phone" value="${formData.phone || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                                    <input type="text" name="mobile_phone" value="${formData.mobile_phone || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">å‚³çœŸ</label>
                                    <input type="text" name="fax" value="${formData.fax || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ä»˜æ¬¾æ–¹å¼</label>
                                    <select name="payment_method" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <option ${!formData.payment_method ? 'selected' : ''} disabled value="">è«‹é¸æ“‡</option>
                                        ${['é›»åŒ¯å³æœŸ', 'é›»åŒ¯30å¤©', 'é›»åŒ¯60å¤©', 'é›»åŒ¯90å¤©', 'æ¯æœˆ20æ—¥', 'ç¾é‡‘'].map(o => `<option value="${o}" ${formData.payment_method === o ? 'selected' : ''}>${o}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ç¨…åˆ¥</label>
                                    <select name="tax_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                        <option ${!formData.tax_type ? 'selected' : ''} disabled value="">è«‹é¸æ“‡</option>
                                        ${['å«ç¨…', 'æœªç¨…', 'é›¶ç¨…', 'å…ç¨…'].map(o => `<option value="${o}" ${formData.tax_type === o ? 'selected' : ''}>${o}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <!-- Column 3 -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">å…¬å¸åœ°å€</label>
                                    <input type="text" name="address" value="${formData.address || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ç™¼ç¥¨åœ°å€</label>
                                    <label class="flex items-center text-xs mt-1"><input type="checkbox" id="copy-invoice-address"> åŒå…¬å¸åœ°å€</label>
                                    <input type="text" name="invoice_address" value="${formData.invoice_address || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">å¯„æ¬¾åœ°å€</label>
                                    <label class="flex items-center text-xs mt-1"><input type="checkbox" id="copy-mailing-address"> åŒå…¬å¸åœ°å€</label>
                                    <input type="text" name="mailing_address" value="${formData.mailing_address || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                            </div>
                            <!-- Full Width -->
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-sm font-medium text-gray-700">å‚™è¨»</label>
                                <textarea name="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${formData.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button type="button" data-action="save-vendor" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">å„²å­˜</button>
                        </div>
                    </form>
                </div>
            `;
            viewEl.style.display = 'block';
        };

        // --- æ¨¡æ…‹æ¡† ---
        const renderModal = (content, options = {}) => {
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = content;
            // æ§åˆ¶è¦–çª—å¯¬åº¦ï¼ˆåŠå¯¬æˆ–é è¨­ï¼‰
            if (options.size === 'half') {
                modalContent.style.width = '50vw';
            } else {
                modalContent.style.width = '95vw';
            }
            document.getElementById('modal-container').style.display = 'flex';
        };

        const closeModal = () => {
            document.getElementById('modal-container').style.display = 'none';
            document.getElementById('modal-content').innerHTML = '';
            state.local.consolidatedData = null;
        };

        // ç°½æ ¸å½ˆçª—åŠŸèƒ½
        window.openApprovalModal = function(requestId) {
            const request = state.requests.find(r => r.id === requestId);
            if (!request) {
                showMessage('æ‰¾ä¸åˆ°å°æ‡‰çš„ç”³è«‹å–®ã€‚', 'error');
                return;
            }

            const approvers = request.approvers || [];
            const nextApprover = approvers.find(a => a.status === 'pending');
            
            // é©—è­‰æ¬Šé™
            if (request.status !== 'å¾…å¯©æ ¸' || !nextApprover || nextApprover.userId !== state.currentUser.id) {
                showMessage('æ‚¨æ²’æœ‰æ¬Šé™ç°½æ ¸æ­¤ç”³è«‹å–®ã€‚', 'error');
                return;
            }

            const getApproverStatusUI = (approver) => {
                let statusHTML = '';
                const approverUser = state.users[approver.userId];
                const approverInfo = approverUser ? `(${approverUser.email} ${approverUser.name})` : `(${approver.userId.substring(0,8)})`;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºä¿®æ”¹ç•¶ä¸‹çš„ç°½æ ¸åˆ—ï¼ˆç°½æ ¸é é¢ç‰ˆæœ¬ï¼‰
                let modificationMark = '';
                if (request.modification_history && request.modification_history.length > 0) {
                    const userToMatch = approverUser ? approverUser.name : approver.userId;
                    const hasEditModification = request.modification_history.some(h => 
                        ((h.userId === approver.userId) || (h.user === userToMatch)) && 
                        (h.action === 'handled_edit' || (h.changes && h.changes.length > 0))
                    );
                    
                    if (hasEditModification) {
                        modificationMark = ' <span class="text-orange-600 font-bold">æœ‰ä¿®æ”¹é</span>';
                    }
                }

                if (approver.status === 'approved') statusHTML = `<span class="text-green-600">âœ”ï¸ å·²æ ¸å‡† (${getFormattedDateTime(approver.date)}) by ${approver.role} ${approverInfo}</span>${modificationMark}`;
                else if (approver.status === 'rejected') statusHTML = `<span class="text-red-600">âŒ å·²é€€å› (${getFormattedDateTime(approver.date)}) by ${approver.role} ${approverInfo}</span>${modificationMark}`;
                else statusHTML = `<span class="text-gray-500">â€¦ å¾…ç°½æ ¸ by ${approver.role} ${approverInfo}</span>`;
                
                if(approver.comment) statusHTML += `<p class="text-xs text-gray-500 pl-4">æ„è¦‹: ${approver.comment}</p>`;
                if(approver.reason) statusHTML += `<p class="text-xs text-red-500 pl-4">é€€å›åŸå› : ${approver.reason}</p>`;
                return statusHTML;
            };

            const canApprove = state.currentUser && nextApprover && state.currentUser.id === nextApprover.userId;
            const isPurchaser = state.currentUser.role.includes('æ¡è³¼');
            const isPurchaserEditing = canApprove && isPurchaser;

            const itemsHTML = (request.items || []).map((item, index) => {
                const subtotal = (item.price || 0) * (item.quantity || 0) + (item.freight || 0) + (item.discount || 0);
                const workOrderNumber = item.is_scrap_work_order && item.work_order_number ? item.work_order_number : '';
                
                const product = state.allProducts.find(p => p.id === item.id);
                const imageUrl = product?.image 
                    ? `https://drive.google.com/thumbnail?id=${product.image}` 
                    : 'https://placehold.co/64x64?text=ç„¡åœ–ç‰‡';
                const vendorName = state.vendors.find(v => v.vendor_id === item.vendor)?.short_name || item.vendor || '';

                if (isPurchaserEditing) {
                    return `
                        <tr class="border-b item-row">
                            <td class="px-4 py-2 align-top"><img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64?text=éŒ¯èª¤';"/></td>
                            <td class="px-4 py-2 align-top">${item.id || ''}</td>
                            <td class="px-4 py-2 align-top">
                                ${item.name}
                                <div class="text-xs text-gray-700 mt-2 space-y-1">
                                    <div>
                                        <label class="text-gray-600 mr-2">åŸå› </label>
                                        <select name="reason_${index}" class="p-1 border rounded">
                                            ${['æ–°å¢','ä¿®ç¹•','å ±å»¢','å…¶ä»–'].map(r => `<option value="${r}" ${item.reason === r ? 'selected' : ''}>${r}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-gray-600 mr-2">èªªæ˜</label>
                                        <input type="text" name="description_${index}" class="p-1 border rounded w-64" value="${item.description || ''}" placeholder="è¼¸å…¥èªªæ˜...">
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <select name="demand_department_${index}" class="w-full p-1 border rounded">
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}" ${(item.demand_department || '') === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <div class="flex items-center gap-2">
                                    <select name="invoice_${index}" class="p-1 border rounded ${item.invoice === 'å…¶ä»–' ? 'w-1/3' : 'w-full'}">
                                        <option value="">-- è«‹é¸æ“‡ --</option>
                                        ${[
                                            "8Cæ¸…ç¦", "7Cæ¸…æ°£", "6Cæ¸…å¿ƒ", "5Cæ¸…å¹³", "3Cæ¸…å®‰", "2CDæ¸…è­·",
                                            "8Dæ¸…æ˜¥", "7Dæ¸…æ—¥", "6Dæ¸…ç…§", "5Dæ¸…é¢¨", "3Dæ¸…æ™¯", "8Eæ¸…å±±",
                                            "7Eæ¸…æ³‰", "6Eæ¸…æ°´", "8Eæ¸…æ¸…", "3Eæ¸…æ¶¼", "æ¸…ç¦æ³•äºº", "ä¸€é¤¨",
                                            "äºŒé¤¨", "ä¸‰é¤¨", "å«ç¬‘", "æ¸…ç¦å¹¼å…’åœ’", "å…¶ä»–"
                                        ].map(opt => `<option value="${opt}" ${item.invoice === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                    <input type="text" name="custom_invoice_${index}" class="p-1 border rounded ${item.invoice === 'å…¶ä»–' ? 'block w-2/3' : 'hidden'}" value="${item.custom_invoice || ''}" placeholder="è«‹è¼¸å…¥ç™¼ç¥¨é–‹ç«‹...">
                                </div>
                            </td>
                            <td class="px-4 py-2 align-top">${vendorName}</td>
                            <td class="px-4 py-2 text-right align-top">$${Number(item.price || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-right align-top">${item.quantity} ${item.unit || ''}</td>
                            <td class="px-4 py-2 text-right align-top">$${Number(item.freight || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-right align-top">$${Number(item.discount || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-right align-top subtotal-cell" data-index="${index}">$${subtotal.toLocaleString()}</td>
                            <td class="px-4 py-2 align-top">
                                <label class="inline-flex items-center gap-2">
                                    <input type="checkbox" name="scrap_${index}" ${item.reason === 'å ±å»¢' ? '' : 'disabled'} ${item.is_scrap_work_order ? 'checked' : ''}>
                                    <span>å ±å»¢</span>
                                </label>
                            </td>
                            <td class="px-4 py-2 align-top">
                                <input name="asset_number_${index}" class="w-full p-1 border rounded ${item.is_scrap_work_order ? '' : 'opacity-50'}" ${item.is_scrap_work_order ? '' : 'disabled'} value="${workOrderNumber}" placeholder="è«‹è¼¸å…¥è²¡ç”¢ç·¨è™Ÿ">
                            </td>
                        </tr>`;
                }
                return `
                    <tr class="border-b">
                        <td class="px-4 py-2 align-top"><img src="${imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64?text=éŒ¯èª¤';"/></td>
                        <td class="px-4 py-2 align-top">${item.id || ''}</td>
                        <td class="px-4 py-2 align-top">
                            ${item.name}
                            <div class="text-xs text-gray-500 mt-1">
                                <p><b>åŸå› :</b> ${item.reason || 'N/A'}</p>
                                <p><b>èªªæ˜:</b> ${item.description || 'N/A'}</p>
                            </div>
                        </td>
                        <td class="px-4 py-2 align-top">${item.demand_department || ''}</td>
                        <td class="px-4 py-2 align-top">${item.invoice === 'å…¶ä»–' ? (item.custom_invoice || '') : (item.invoice || '')}</td>
                        <td class="px-4 py-2 align-top">${vendorName}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.price || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">${item.quantity} ${item.unit}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.freight || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">$${Number(item.discount || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-right align-top">$${subtotal.toLocaleString()}</td>
                        <td class="px-4 py-2 text-center align-top">${item.is_scrap_work_order ? 'âœ”ï¸' : ''}</td>
                        <td class="px-4 py-2 align-top">${workOrderNumber}</td>
                    </tr>`;
            }).join('');
            
            const modificationHistoryHTML = (() => {
                const fieldNameMap = { reason: 'åŸå› ', description: 'èªªæ˜', demand_department: 'éœ€æ±‚èª²å®¤', invoice: 'ç™¼ç¥¨é–‹ç«‹', custom_invoice: 'è‡ªè¨‚ç™¼ç¥¨', vendor: 'å» å•†', price: 'å–®åƒ¹', quantity: 'æ•¸é‡', unit: 'å–®ä½', freight: 'é‹è²»', discount: 'æŠ˜æ‰£', is_scrap_work_order: 'å ±å»¢', work_order_number: 'è²¡ç”¢ç·¨è™Ÿ' };
                const hist = [...(request.modification_history || [])].reverse();
                return hist.map((entry, i) => `
                    <div class="text-xs text-gray-500 border-t pt-2 mt-2">
                        <p><strong>#${i + 1} ä¿®æ”¹äºº:</strong> ${entry.user} (${entry.role}) æ–¼ ${getFormattedDateTime(entry.date)}</p>
                        <p><strong>ä¿®æ”¹åŸå› :</strong> ${entry.reason || 'ï¼ˆæœªå¡«ï¼‰'}</p>
                    </div>
                `).join('');
            })();

            renderModal(`
                <div class="space-y-6">
                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="text-lg font-medium text-gray-900">ç”³è«‹å–®è©³æƒ…: ${request.id}</h3>
                        <p class="mt-1 text-sm text-gray-600">è«‹å¯©æ ¸ä»¥ä¸‹ç”³è«‹å–®çš„å…§å®¹</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><span class="font-bold text-gray-600">ç”³è«‹å–®è™Ÿ:</span> ${request.id} ${Array.isArray(request.attachments) && request.attachments.length ? 'ğŸ“' : ''}</div>
                        <div><span class="font-bold text-gray-600">ç”³è«‹æ—¥æœŸ:</span> ${getFormattedDateTime(request.request_date)}</div>
                        <div><span class="font-bold text-gray-600">ç‹€æ…‹:</span> <span class="px-3 py-1 rounded-full text-xs font-medium ${{'å¾…å¯©æ ¸': 'bg-yellow-100 text-yellow-800', 'å·²æ ¸å‡†': 'bg-green-100 text-green-800', 'å·²é€€å›': 'bg-red-100 text-red-800'}[request.status] || 'bg-gray-100 text-gray-800'}">${request.status}</span></div>
                        <div><span class="font-bold text-gray-600">ç”³è«‹äºº:</span> ${state.users[request.applicant_id]?.name || 'æœªçŸ¥'}</div>
                        <div><span class="font-bold text-gray-600">ç”³è«‹éƒ¨é–€:</span> ${request.department}</div>
                        <div><span class="font-bold text-gray-600">çµæ¡ˆç‹€æ…‹:</span> <span class="px-3 py-1 rounded-full text-xs font-medium ${request.closed_status === 'çµæ¡ˆ' ? 'bg-gray-300 text-gray-800' : 'bg-blue-100 text-blue-800'}">${request.closed_status || 'æœªçµæ¡ˆ'}</span></div>
                        <div class="md:col-span-3"><span class="font-bold text-gray-600">ç¸½èªªæ˜:</span> <span class="text-gray-800 whitespace-pre-wrap">${request.reason || 'ç„¡'}</span></div>
                    </div>

                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-3">ç”³è«‹é …ç›®</h4>
                        <form id="edit-request-form-modal">
                            <div class="overflow-x-auto mb-6" style="max-height: 300px; overflow-y: auto;">
                                <table class="min-w-full">
                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2 text-left">åœ–ç‰‡</th>
                                            <th class="px-4 py-2 text-left">å•†å“ç·¨è™Ÿ</th>
                        <th class="px-4 py-2 text-left">å“å/èªªæ˜ ${isPurchaserEditing ? '<span class="ml-2 inline-block align-middle text-[10px] px-2 py-0.5 rounded border border-gray-300 text-gray-600 bg-gray-50">å”¯è®€</span>' : ''}</th>
                                            <th class="px-4 py-2 text-left">éœ€æ±‚èª²å®¤</th>
                                            <th class="px-4 py-2 text-left">ç™¼ç¥¨é–‹ç«‹</th>
                                            <th class="px-4 py-2 text-left">å» å•†</th>
                                            <th class="px-4 py-2 text-right">å–®åƒ¹</th>
                                            <th class="px-4 py-2 text-right">æ•¸é‡</th>
                                            <th class="px-4 py-2 text-right">é‹è²»</th>
                                            <th class="px-4 py-2 text-right">æŠ˜æ‰£</th>
                                            <th class="px-4 py-2 text-right">å°è¨ˆ</th>
                                            <th class="px-4 py-2 text-center">å ±å»¢</th>
                                            <th class="px-4 py-2 text-left">è²¡ç”¢ç·¨è™Ÿ</th>
                                        </tr>
                                    </thead>
                                    <tbody>${itemsHTML}</tbody>
                                    <tfoot>
                                        <tr class="font-bold">
                                            <td colspan="10" class="px-4 py-2 text-right">ç¸½é‡‘é¡:</td>
                                            <td id="grand-total-modal" class="px-4 py-2 text-right">$${Number(request.total_amount).toLocaleString()}</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </form>
                    </div>

                    ${modificationHistoryHTML ? `
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-3">ä¿®æ”¹æ­·å²</h4>
                        <div class="space-y-2 mb-6">${modificationHistoryHTML}</div>
                    </div>` : ''}

                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-3">ç°½æ ¸æµç¨‹</h4>
                        <div class="space-y-4 mb-6">
                            ${(request.approvers || []).map(approver => {
                                let displayRole = approver.role;
                                if (approver.role === 'ä½¿ç”¨è€…') {
                                    if (approver.step === 1) displayRole = 'ç”³è«‹äººä¸»ç®¡';
                                    else if (approver.step === 2) displayRole = 'ç”³è«‹äººä¸»ç®¡çš„ä¸»ç®¡';
                                    else if (approver.step === 3) displayRole = 'ç¬¬ä¸‰ä¸»ç®¡';
                                }
                                return `<div class="flex items-start"><div class="font-bold w-48 flex-shrink-0">${displayRole}:</div><div>${getApproverStatusUI(approver)}</div></div>`;
                            }).join('')}
                        </div>
                    </div>

                    <div class="border-t pt-6">
                        ${canApprove ? `
                        <div class="flex-grow flex justify-end space-x-4">
                            ${isPurchaserEditing ? `
                            <div class="flex-grow">
                                <label for="modification-reason-modal" class="block text-sm font-medium text-gray-700">ä¿®æ”¹åŸå› </label>
                                <textarea id="modification-reason-modal" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                            </div>` : ''}
                            <div class="flex-grow">
                                <label for="approval-comment-modal" class="block text-sm font-medium text-gray-700">ç°½æ ¸æ„è¦‹ï¼ˆé¸å¡«ï¼‰</label>
                                <textarea id="approval-comment-modal" rows="3" 
                                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                          placeholder="è«‹å¡«å¯«ç°½æ ¸æ„è¦‹..."></textarea>
                            </div>
                        </div>` : ''}
                    </div>

                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                        ${canApprove ? `
                            ${isPurchaserEditing ? '<button data-action="modal-save-changes" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">å„²å­˜ä¿®æ”¹ä¸¦æ ¸å‡†</button>' : ''}
                            <button data-action="modal-reject-options" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">é€€å›</button>
                            <button data-action="modal-approve" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">æ ¸å‡†</button>
                        ` : ''}
                    </div>
                </div>
            `);

            // å¦‚æœæ˜¯æ¡è³¼äººå“¡ç·¨è¼¯æ¨¡å¼ï¼Œæ·»åŠ å‹•æ…‹è¨ˆç®—åŠŸèƒ½
            if (isPurchaserEditing) {
                setTimeout(() => {
                    const itemInputs = document.querySelectorAll('.item-input');
                    itemInputs.forEach(input => {
                        input.addEventListener('input', () => {
                            updateSubtotalModal(input.dataset.index);
                            updateGrandTotalModal();
                        });
                    });
                }, 100);
            }
        };

        // è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°å½ˆçª—ä¸­çš„å°è¨ˆ
        function updateSubtotalModal(index) {
            const price = parseFloat(document.querySelector(`input[name="price_${index}"]`).value) || 0;
            const quantity = parseFloat(document.querySelector(`input[name="quantity_${index}"]`).value) || 0;
            const freight = parseFloat(document.querySelector(`input[name="freight_${index}"]`).value) || 0;
            const discount = parseFloat(document.querySelector(`input[name="discount_${index}"]`).value) || 0;
            const subtotal = price * quantity + freight + discount;
            document.querySelector(`.subtotal-cell[data-index="${index}"]`).textContent = `$${subtotal.toLocaleString()}`;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°å½ˆçª—ä¸­çš„ç¸½é‡‘é¡
        function updateGrandTotalModal() {
            const subtotalCells = document.querySelectorAll('.subtotal-cell');
            let grandTotal = 0;
            subtotalCells.forEach(cell => {
                const value = cell.textContent.replace(/[$,]/g, '');
                grandTotal += parseFloat(value) || 0;
            });
            const grandTotalElement = document.getElementById('grand-total-modal');
            if (grandTotalElement) {
                grandTotalElement.textContent = `$${grandTotal.toLocaleString()}`;
            }
        };

        // --- äº‹ä»¶è™•ç†å™¨ ---
        
        document.body.addEventListener('click', (e) => {
            const detailLink = e.target.closest('[data-action="view-detail"]');
            if (detailLink) {
                e.preventDefault();
                const requestId = detailLink.dataset.id;
                const request = state.requests.find(r => r.id == requestId);
                if (request) {
                    updateState({ view: 'detailView', selectedRequest: request });
                } else {
                    showMessage('æ‰¾ä¸åˆ°å°æ‡‰çš„ç”³è«‹å–®ã€‚', 'error');
                }
                return;
            }

            const notificationLink = e.target.closest('[data-action="view-notification-detail"]');
            if (notificationLink) {
                e.preventDefault();
                const requestId = notificationLink.dataset.id;
                const notificationId = notificationLink.dataset.notificationId;
                const request = state.requests.find(r => r.id == requestId);

                if (request) {
                    if (notificationId) {
                        const notification = state.applicantNotifications.find(n => n.id == notificationId);
                        if (notification && !notification.is_read) {
                            supabase.from('notifications').update({ is_read: true }).eq('id', notificationId).then(({error}) => {
                                if (error) console.error("æ›´æ–°é€šçŸ¥ç‹€æ…‹å¤±æ•—:", error);
                            });
                        }
                    }
                    
                    const dropdown = document.getElementById('notification-dropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                    updateState({ view: 'detailView', selectedRequest: request });
                }
                return;
            }

            const viewSwitchBtn = e.target.closest('.view-switch-btn');
            if (viewSwitchBtn) {
                state.local.newRequestCart = [];
                 if (viewSwitchBtn.dataset.view === 'newRequest') {
                    updateState({ 
                        view: viewSwitchBtn.dataset.view
                    });
                } else {
                    updateState({ view: viewSwitchBtn.dataset.view });
                }
                return;
            }
            if (e.target.id === 'logout-btn') {
                // æ¸…é™¤ç™»å…¥æœƒè©±è³‡è¨Š
                loginSessionManager.clearLoginSession().catch(console.error);
                supabase.auth.signOut();
                return;
            }
            if (e.target.id === 'change-password-btn') {
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">ä¿®æ”¹å¯†ç¢¼</h3>
                    <p class="mb-4">ç‚º ${state.currentUser.name} è¨­å®šæ–°å¯†ç¢¼ï¼š</p>
                    <label for="new-password" class="block text-sm font-medium text-gray-700">æ–°å¯†ç¢¼</label>
                    <input type="password" id="new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">å–æ¶ˆ</button>
                        <button data-action="confirm-change-password" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white">ç¢ºèªä¿®æ”¹</button>
                    </div>`);
                return;
            }

            const bell = e.target.closest('#notification-bell');
            const dropdown = document.getElementById('notification-dropdown');

            if (bell && dropdown) {
                dropdown.classList.toggle('hidden');
            } else if (e.target && e.target.dataset && e.target.dataset.action === 'mark-all-read-updates') {
                // å°‡å±¬æ–¼ç•¶å‰ä½¿ç”¨è€…çš„æœªè®€é€šçŸ¥æ‰¹æ¬¡è¨­ç‚ºå·²è®€
                const ids = state.applicantNotifications.filter(n => n.user_id === state.currentUser.id && !n.is_read).map(n => n.id);
                if (ids.length) {
                    supabase.from('notifications').update({ is_read: true }).in('id', ids).then(({ error }) => {
                        if (error) {
                            console.error('æ‰¹æ¬¡è¨­ç‚ºå·²è®€å¤±æ•—:', error);
                            showMessage('è¨­ç‚ºå·²è®€å¤±æ•—', 'error');
                        } else {
                            // æœ¬åœ°æ›´æ–°ç‹€æ…‹
                            const updated = state.applicantNotifications.map(n => ids.includes(n.id) ? { ...n, is_read: true } : n);
                            updateState({ applicantNotifications: updated });
                            showMessage('å·²å°‡è¡¨å–®é€²åº¦æ›´æ–°å…¨éƒ¨è¨­ç‚ºå·²è®€', 'success');
                        }
                    });
                }
            } else if (!e.target.closest('.multi-select-container') && !e.target.closest('#notification-dropdown')) {
                 document.querySelectorAll('.multi-select-dropdown').forEach(el => el.classList.add('hidden'));
                 if(dropdown) dropdown.classList.add('hidden');
            }
        });

        document.getElementById('dashboard-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button, a, th');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'sort') {
                const key = button.dataset.sortKey;
                if (state.local.sortKey === key) {
                    state.local.sortDirection = state.local.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    state.local.sortKey = key;
                    state.local.sortDirection = 'asc';
                }
                renderDashboardTable();
            } else if (action === 'select-page') {
                e.preventDefault();
                const visibleIds = getFilteredRequests().slice((state.local.currentPage - 1) * state.local.itemsPerPage, state.local.currentPage * state.local.itemsPerPage).map(req => req.id);
                visibleIds.forEach(id => state.local.selectedRequestIds.add(id));
                renderDashboard();
            } else if (action === 'select-all-filtered') {
                e.preventDefault();
                const allFilteredIds = getFilteredRequests().map(req => req.id);
                allFilteredIds.forEach(id => state.local.selectedRequestIds.add(id));
                renderDashboard();
            } else if (action === 'deselect-all') {
                e.preventDefault();
                state.local.selectedRequestIds.clear();
                renderDashboard();
            
            } else if (action === 'search-dashboard') {
                const searchTerm = document.getElementById('dashboard-search-input').value;
                state.local.selectedRequestIds.clear();
                state.local.currentPage = 1;
                state.local.dashboardFilters.searchTerm = searchTerm;
                renderDashboardTable();
            } else if (action === 'batch-approve' || action === 'batch-reject' || action === 'batch-close') {
                const selectedIds = Array.from(state.local.selectedRequestIds);
                let requestsToProcess = [];
                let modalTitle = '';
                let modalAction = '';

                if (action === 'batch-approve' || action === 'batch-reject') {
                    requestsToProcess = state.requests.filter(req => 
                        selectedIds.includes(req.id) &&
                        req.status === 'å¾…å¯©æ ¸' &&
                        (req.approvers || []).find(a => a.status === 'pending')?.userId === state.currentUser.id
                    );
                } else if (action === 'batch-close') {
                    requestsToProcess = state.requests.filter(req => 
                        selectedIds.includes(req.id) &&
                        req.status === 'å·²æ ¸å‡†' &&
                        (req.closed_status === 'æœªçµæ¡ˆ' || !req.closed_status)
                    );
                }

                if (requestsToProcess.length === 0) {
                    showMessage('æ²’æœ‰å¯ä¾›æ“ä½œçš„å·²é¸å–å–®æ“šã€‚', 'error');
                    return;
                }

                if (action === 'batch-approve') {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">æ‰¹æ¬¡æ ¸å‡†</h3>
                        <p class="mb-4">æ‚¨ç¢ºå®šè¦æ ¸å‡† ${requestsToProcess.length} ç­†ç”³è«‹å–®å—ï¼Ÿ</p>
                        <label for="batch-approval-comment" class="block text-sm font-medium text-gray-700">ç°½æ ¸æ„è¦‹ (é¸å¡«ï¼Œå°‡å¥—ç”¨è‡³æ‰€æœ‰å–®æ“š)</label>
                        <textarea id="batch-approval-comment" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">å–æ¶ˆ</button>
                            <button data-action="confirm-batch-approve" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white">ç¢ºèªæ ¸å‡†</button>
                        </div>
                    `);
                } else if (action === 'batch-reject') {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">æ‰¹æ¬¡é€€å›</h3>
                        <p class="mb-4">æ‚¨ç¢ºå®šè¦é€€å› ${requestsToProcess.length} ç­†ç”³è«‹å–®å—ï¼Ÿ</p>
                        <label for="batch-rejection-reason" class="block text-sm font-medium text-gray-700">é€€å›ç†ç”± (å¿…å¡«ï¼Œå°‡å¥—ç”¨è‡³æ‰€æœ‰å–®æ®)</label>
                        <textarea id="batch-rejection-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">å–æ¶ˆ</button>
                            <button data-action="confirm-batch-reject" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">ç¢ºèªé€€å›</button>
                        </div>
                    `);
                } else if (action === 'batch-close') {
                     renderModal(`
                        <h3 class="text-lg font-bold mb-4">æ‰¹æ¬¡çµæ¡ˆ</h3>
                        <p class="mb-4">æ‚¨ç¢ºå®šè¦å°‡ ${requestsToProcess.length} ç­†å·²æ ¸å‡†çš„ç”³è«‹å–®çµæ¡ˆå—ï¼Ÿ</p>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">å–æ¶ˆ</button>
                            <button data-action="confirm-batch-close" data-ids='${JSON.stringify(requestsToProcess.map(r => r.id))}' class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-600 text-white">ç¢ºèªçµæ¡ˆ</button>
                        </div>
                    `);
                }
            } else if (action === 'consolidate-by-vendor') {
                let requestsToProcess;
                if (state.local.selectedRequestIds.size > 0) {
                    requestsToProcess = state.requests.filter(req => state.local.selectedRequestIds.has(req.id));
                } else {
                    requestsToProcess = getFilteredRequests();
                }

                if (requestsToProcess.length === 0) {
                    showMessage('æ²’æœ‰å¯å½™æ•´çš„è¨‚å–®', 'error');
                    return;
                }

                renderModal(`
                    <h3 class="text-xl font-bold mb-4">é¸æ“‡è¦å½™æ•´çš„è¨‚å–®ç‹€æ…‹</h3>
                    <p class="text-sm text-gray-600 mb-6">å‹¾é¸æ¬²ç´å…¥çš„æ¢ä»¶ï¼›å„å€å¡Šå¯ç¨ç«‹é¸æ“‡ï¼Œæœªå‹¾é¸è€…å‰‡ä¸å¥—ç”¨è©²æ¢ä»¶ã€‚</p>
                    <div class="space-y-3 mb-8">
                        <label class="flex items-center"><input type="checkbox" value="å¾…å¯©æ ¸" class="consolidation-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">å¾…å¯©æ ¸</span></label>
                        <label class="flex items-center"><input type="checkbox" value="å·²æ ¸å‡†" class="consolidation-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">å·²æ ¸å‡†</span></label>
                        <label class="flex items-center"><input type="checkbox" value="å·²é€€å›" class="consolidation-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">å·²é€€å›</span></label>
                    </div>
                    <h4 class="text-md font-bold mb-2">ç¯©é¸ç¶“è¾¦ç‹€æ…‹</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="æœªç¶“è¾¦" class="consolidation-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">æœªç¶“è¾¦</span></label>
                        <label class="flex items-center"><input type="checkbox" value="å¾…ç¶“è¾¦" class="consolidation-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">å¾…ç¶“è¾¦</span></label>
                        <label class="flex items-center"><input type="checkbox" value="å·²ç¶“è¾¦" class="consolidation-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">å·²ç¶“è¾¦</span></label>
                    </div>
                    <h4 class="text-md font-bold mb-2">ç¯©é¸çµæ¡ˆç‹€æ…‹</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="æœªçµæ¡ˆ" class="consolidation-closed-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">æœªçµæ¡ˆ</span></label>
                        <label class="flex items-center"><input type="checkbox" value="çµæ¡ˆ" class="consolidation-closed-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">çµæ¡ˆ</span></label>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button data-action="confirm-consolidation" class="px-4 py-2 rounded-md font-semibold text-sm bg-teal-600 text-white hover:bg-teal-700">ç¢ºèªå½™æ•´</button>
                    </div>
                `);
            } else if (action === 'export') {
                // å…ˆå½ˆå‡ºæ¢ä»¶ç¯©é¸è¦–çª—ï¼Œå†ç”±ç¢ºèªæŒ‰éˆ•åŒ¯å‡º
                renderModal(`
                    <h3 class="text-xl font-bold mb-4">åŒ¯å‡ºè¨‚å–® - ç¯©é¸æ¢ä»¶</h3>
                    <p class="text-sm text-gray-600 mb-6">å‹¾é¸æ¬²ç´å…¥çš„æ¢ä»¶ï¼›å„å€å¡Šå¯ç¨ç«‹é¸æ“‡ï¼Œæœªå‹¾é¸è€…å‰‡ä¸å¥—ç”¨è©²æ¢ä»¶ã€‚</p>
                    <h4 class="text-md font-bold mb-2">ç¯©é¸ç°½æ ¸ç‹€æ…‹</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="å¾…å¯©æ ¸" class="export-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">å¾…å¯©æ ¸</span></label>
                        <label class="flex items-center"><input type="checkbox" value="å·²æ ¸å‡†" class="export-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">å·²æ ¸å‡†</span></label>
                        <label class="flex items-center"><input type="checkbox" value="å·²é€€å›" class="export-status-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">å·²é€€å›</span></label>
                    </div>
                    <h4 class="text-md font-bold mb-2">ç¯©é¸ç¶“è¾¦ç‹€æ…‹</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="æœªç¶“è¾¦" class="export-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">æœªç¶“è¾¦</span></label>
                        <label class="flex items-center"><input type="checkbox" value="å¾…ç¶“è¾¦" class="export-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">å¾…ç¶“è¾¦</span></label>
                        <label class="flex items-center"><input type="checkbox" value="å·²ç¶“è¾¦" class="export-handler-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">å·²ç¶“è¾¦</span></label>
                    </div>
                    <h4 class="text-md font-bold mb-2">ç¯©é¸çµæ¡ˆç‹€æ…‹</h4>
                    <div class="space-y-2 mb-6">
                        <label class="flex items-center"><input type="checkbox" value="æœªçµæ¡ˆ" class="export-closed-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked> <span class="ml-2">æœªçµæ¡ˆ</span></label>
                        <label class="flex items-center"><input type="checkbox" value="çµæ¡ˆ" class="export-closed-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="ml-2">çµæ¡ˆ</span></label>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button data-action="confirm-export-orders-preview" class="px-4 py-2 rounded-md font-semibold text-sm bg-teal-600 text-white hover:bg-teal-700">ç¢ºèªå½™æ•´</button>
                    </div>
                `);
            } else if (action === 'go-to-page') {
                state.local.currentPage = parseInt(button.dataset.page, 10);
                renderDashboardTable();
            } else if (action === 'refresh') {
                // å¼·åˆ¶é‡æ–°æ•´ç† - æ¸…é™¤æ‰€æœ‰ç·©å­˜ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™
                updateState({ loading: true });
                try {
                    // æ¸…é™¤æ‰€æœ‰ç›¸é—œç·©å­˜
                    CacheManager.clear('dashboard_data');
                    CacheManager.clear(); // æ¸…é™¤æ‰€æœ‰ç·©å­˜
                    
                    // é—œé–‰ç¾æœ‰çš„å³æ™‚é€£æ¥
                    channels.forEach(channel => {
                        try {
                            supabase.removeChannel(channel);
                        } catch (e) {
                            console.warn('æ¸…ç†é »é“æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
                        }
                    });
                    channels = [];
                    
                    // å¼·åˆ¶é‡æ–°è¼‰å…¥è³‡æ–™ï¼Œä¸ä½¿ç”¨ä»»ä½•ç·©å­˜
                    await loadDashboardData(false, false);
                    
                    // é‡ç½®ç¯©é¸ç·©å­˜
                    getFilteredRequests.resetCache();
                    
                    // å¼·åˆ¶å®Œæ•´é‡æ–°æ¸²æŸ“
                    render();
                    
                    showMessage('è³‡æ–™å·²é‡æ–°æ•´ç†å®Œæˆï¼');
                } catch (err) {
                    console.error('é‡æ–°æ•´ç†å¤±æ•—:', err);
                    showMessage('é‡æ–°æ•´ç†å¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (e.target.closest('.multi-select-toggle')) {
                const toggle = e.target.closest('.multi-select-toggle');
                e.preventDefault();
                
                document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                    if (d !== toggle.nextElementSibling) {
                        d.classList.add('hidden');
                    }
                });

                const dropdown = toggle.nextElementSibling;
                const filterKey = toggle.dataset.filterKey;

                if (dropdown.classList.contains('hidden')) {
                    tempSelections[filterKey] = new Set(state.local.dashboardFilters[filterKey] || []);
                    const checkboxes = dropdown.querySelectorAll('.multi-select-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = tempSelections[filterKey].has(cb.value);
                    });
                }
                
                dropdown.classList.toggle('hidden');
            } else if (action === 'select-all-multi') {
                const filterKey = button.dataset.filterKey;
                const dropdown = button.closest('.multi-select-dropdown');
                const checkboxes = dropdown.querySelectorAll('.multi-select-checkbox');
                checkboxes.forEach(cb => {
                    if (cb.closest('li').style.display !== 'none') {
                        cb.checked = true;
                        tempSelections[filterKey].add(cb.value);
                    }
                });
            } else if (action === 'deselect-all-multi') {
                const filterKey = button.dataset.filterKey;
                const dropdown = button.closest('.multi-select-dropdown');
                const checkboxes = dropdown.querySelectorAll('.multi-select-checkbox');
                checkboxes.forEach(cb => {
                     if (cb.closest('li').style.display !== 'none') {
                        cb.checked = false;
                        tempSelections[filterKey].delete(cb.value);
                    }
                });
            } else if (action === 'cancel-multi-select') {
                button.closest('.multi-select-dropdown').classList.add('hidden');
            } else if (action === 'confirm-multi-select') {
                const filterKey = button.dataset.filterKey;
                state.local.dashboardFilters[filterKey] = new Set(tempSelections[filterKey]);
                button.closest('.multi-select-dropdown').classList.add('hidden');
                renderDashboardFilters();
                renderDashboardTable();
            }
        });

        // Hover popover for request id quick info/actions
        (function initDashboardHoverPopover(){
            const container = document.getElementById('dashboard-view');
            if (!container) return;

            let hideTimer = null;
            let suppressHover = false;
            let lastShownReqId = null;
            let lastAnchorEl = null;
            const popoverPageByReqId = Object.create(null);

            const hideLater = () => {
                const pop = document.getElementById('dashboard-hover-popover');
                if (!pop) return;
                if (hideTimer) clearTimeout(hideTimer);
                hideTimer = setTimeout(() => {
                    pop.classList.remove('show');
                    pop.style.visibility = 'hidden';
                    pop.style.display = 'none';
                }, 5000);
            };

            const showPopover = (target, reqId) => {
                const req = state.requests.find(r => r.id === reqId);
                if (!req) return;
                const applicant = state.users[req.applicant_id]?.name || 'æœªçŸ¥';
                const dept = req.department || '';
                const amount = Number(req.total_amount || 0).toLocaleString();
                const status = req.status || '';
                const handlerStatus = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                const closedStatus = req.closed_status || 'æœªçµæ¡ˆ';
                const orderType = req.type || 'ç‰¹æ¡';
                const itemsAll = (req.items || []).map(item => {
                    const product = state.allProducts?.find(p => p.id === item.id);
                    const imageUrl = product?.image ? `https://drive.google.com/thumbnail?id=${product.image}` : 'https://placehold.co/48x48?text=ç„¡';
                    const price = Number(item.price || 0);
                    return { imageUrl, name: item.name || '', qty: item.quantity || 0, unit: item.unit || '', price };
                });
                const pageSize = 5;
                const totalPages = Math.max(1, Math.ceil(itemsAll.length / pageSize));
                const currentPage = Math.min(totalPages, Math.max(1, popoverPageByReqId[req.id] || 1));
                const pageStart = (currentPage - 1) * pageSize;
                const items = itemsAll.slice(pageStart, pageStart + pageSize);
                const isCurrentApprover = (req.status === 'å¾…å¯©æ ¸') && (req.approvers || []).find(a => a.status === 'pending')?.userId === state.currentUser.id;

                const pop = document.getElementById('dashboard-hover-popover');
                if (!pop) return;
                lastShownReqId = req.id;
                lastAnchorEl = target;
                pop.innerHTML = `
                    <button class="close-btn" data-action="close-popover" aria-label="é—œé–‰">Ã—</button>
                    <div class="title">ç”³è«‹å–® ${req.id}</div>
                    <div class="kv">
                        <div>ç”³è«‹äºº</div><div>${applicant}</div>
                        <div>éƒ¨é–€</div><div>${dept}</div>
                        <div>ç”³è«‹æ—¥æœŸ</div><div>${getFormattedDateTime(req.request_date)}</div>
                        <div>è¨‚å–®é¡åˆ¥</div><div><span class="px-2 py-0.5 rounded-full text-[10px] font-medium ${orderType === 'ç‰¹æ¡' ? 'bg-pink-100 text-pink-800' : 'bg-teal-100 text-teal-800'}">${orderType}</span></div>
                        <div>ç°½æ ¸ç‹€æ…‹</div><div>${status}</div>
                        <div>ç¶“è¾¦ç‹€æ…‹</div><div>${handlerStatus}</div>
                        <div>çµæ¡ˆç‹€æ…‹</div><div>${closedStatus}</div>
                        <div>ç¸½é‡‘é¡</div><div>$${amount}</div>
                    </div>
                    ${itemsAll.length ? `
                    <div class="mt-2">
                        <div class="text-xs text-gray-500 mb-1">å“é …</div>
                        <div class="space-y-2">
                            ${items.map(it => `
                                <div class="flex items-center space-x-2">
                                    <img src="${it.imageUrl}" alt="${it.name}" class="w-10 h-10 rounded object-cover border" onerror="this.onerror=null;this.src='https://placehold.co/48x48?text=ç„¡';"/>
                                    <div class="flex-1">
                                        <div class="text-sm truncate" title="${it.name}">${it.name}</div>
                                        <div class="text-xs text-gray-500">${it.qty} ${it.unit} Â· å–®åƒ¹ $${Number(it.price || 0).toLocaleString()}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${totalPages > 1 ? `
                        <div class="mt-2 flex items-center justify-start gap-2">
                            <span class="text-xs text-gray-500">æª¢è¦–åˆ†é </span>
                            ${Array.from({length: totalPages}).map((_, i) => {
                                const p = i + 1;
                                const isCurrent = p === currentPage;
                                return `<button class=\"btn ${isCurrent ? 'bg-blue-500 text-white' : ''}\" data-action=\"popover-page\" data-id=\"${req.id}\" data-page=\"${p}\">${p}</button>`;
                            }).join('')}
                        </div>` : ''}
                    </div>` : ''}
                    <div class="actions">
                        <div class="flex gap-2 flex-wrap w-full">
                            <button class="btn" data-action="view-detail" data-id="${req.id}">é–‹å•Ÿ</button>
                            <button class="btn" data-action="print-request" data-id="${req.id}">åˆ—å°</button>
                            <button class="btn" data-action="copy-id" data-id="${req.id}">è¤‡è£½å–®è™Ÿ</button>
                        </div>
                        <div class="flex gap-2 flex-wrap w-full mt-1">
                            ${isCurrentApprover ? `<button class="btn" data-action="quick-approve" data-id="${req.id}">æ ¸å‡†</button>` : ''}
                            ${isCurrentApprover ? `<button class="btn" data-action="quick-reject" data-id="${req.id}">é€€å›</button>` : ''}
                            ${(() => {
                                const canHandle = (handlerStatus === 'å¾…ç¶“è¾¦') && ((state.currentUser.id === req.handler_id) || state.currentUser.role === 'æ¡è³¼' || state.currentUser.role === 'æ¡è³¼ä¸»ç®¡' || state.currentUser.is_admin) && closedStatus !== 'çµæ¡ˆ';
                                return canHandle ? `<button class=\"btn\" data-action=\"quick-handle\" data-id=\"${req.id}\">ç¶“è¾¦</button>` : '';
                            })()}
                            ${(() => {
                                const canClose = (handlerStatus === 'å·²ç¶“è¾¦') && (state.currentUser.role === 'æ¡è³¼' || state.currentUser.role === 'æ¡è³¼ä¸»ç®¡' || state.currentUser.is_admin) && closedStatus !== 'çµæ¡ˆ' && status === 'å·²æ ¸å‡†';
                                return canClose ? `<button class=\"btn\" data-action=\"quick-close\" data-id=\"${req.id}\">çµæ¡ˆ</button>` : '';
                            })()}
                        </div>
                    </div>`;

                // æš«æ™‚é¡¯ç¤ºä»¥é‡æ¸¬å¯¬åº¦ï¼Œå†å®šä½
                pop.style.visibility = 'hidden';
                pop.style.display = 'block';
                const rect = target.getBoundingClientRect();
                const measuredWidth = pop.offsetWidth || 340;
                const measuredHeight = pop.offsetHeight || 200;
                // é è¨­é¡¯ç¤ºåœ¨ç›®æ¨™å³å´ï¼Œè‹¥è¶…å‡ºè¦–çª—å‰‡é¡¯ç¤ºåœ¨å·¦å´ï¼›å‚ç›´ä½ç½®ç½®ä¸­ï¼ˆå›ºå®šå®šä½ï¼Œä¸ä½¿ç”¨æ²å‹•åç§»ï¼‰
                let top = Math.max(12, (window.innerHeight - measuredHeight) / 2);
                let left = rect.right + 8;
                const overflowRight = left + measuredWidth > window.innerWidth - 12;
                if (overflowRight) {
                    left = rect.left - measuredWidth - 8;
                }
                // å‚ç›´ä½ç½®é™åˆ¶åœ¨å¯è¦–ç¯„åœå…§
                const minTop = 12;
                const maxTop = window.innerHeight - measuredHeight - 12;
                top = Math.max(minTop, Math.min(top, maxTop));
                pop.style.top = `${top}px`;
                pop.style.left = `${left}px`;
                pop.style.visibility = 'visible';
                pop.classList.add('show');
            };

            container.addEventListener('mouseover', (e) => {
                const overPopover = e.target.closest('#dashboard-hover-popover');
                if (overPopover) {
                    if (hideTimer) clearTimeout(hideTimer);
                    return;
                }
                const t = e.target.closest('.request-id-hover');
                if (!t) return;
                if (suppressHover && t.dataset.requestId === lastShownReqId) return;
                if (hideTimer) clearTimeout(hideTimer);
                showPopover(t, t.dataset.requestId);
            });

            container.addEventListener('mouseout', (e) => {
                const pop = document.getElementById('dashboard-hover-popover');
                if (!pop) { return; }
                const leavingTo = e.relatedTarget;
                const goingIntoPopover = leavingTo && pop.contains(leavingTo);
                const goingIntoTrigger = leavingTo && leavingTo.closest && leavingTo.closest('.request-id-hover');
                if (goingIntoPopover || goingIntoTrigger) {
                    if (hideTimer) clearTimeout(hideTimer);
                    return;
                }
                // æ»‘é¼ é›¢é–‹è§¸ç™¼å…ƒç´ èˆ‡ Popoverï¼Œ3 ç§’å¾Œè‡ªå‹•é—œé–‰ï¼ˆè‹¥æœŸé–“åˆç§»å…¥å‰‡å–æ¶ˆï¼‰
                hideLater();
                suppressHover = false;
            });

            // Handle actions inside popover via delegation
            container.addEventListener('click', async (e) => {
                const closeBtn = e.target.closest('#dashboard-hover-popover .close-btn');
                if (closeBtn) {
                    const pop = document.getElementById('dashboard-hover-popover');
                    if (pop) {
                        pop.classList.remove('show');
                        pop.style.visibility = 'hidden';
                        pop.style.display = 'none';
                    }
                    suppressHover = true;
                    return;
                }
                const pageBtn = e.target.closest('#dashboard-hover-popover [data-action="popover-page"]');
                if (pageBtn) {
                    const id = pageBtn.getAttribute('data-id');
                    const page = parseInt(pageBtn.getAttribute('data-page'), 10) || 1;
                    popoverPageByReqId[id] = page;
                    if (lastAnchorEl) {
                        showPopover(lastAnchorEl, id);
                    }
                    return;
                }
                const btn = e.target.closest('#dashboard-hover-popover .btn');
                if (!btn) return;
                const act = btn.dataset.action;
                const id = btn.dataset.id;
                if (act === 'copy-id') {
                    try {
                        await navigator.clipboard.writeText(id);
                        showMessage('å·²è¤‡è£½å–®è™Ÿ');
                    } catch (err) {
                        try {
                            const ta = document.createElement('textarea');
                            ta.value = id;
                            ta.style.position = 'fixed';
                            ta.style.top = '-9999px';
                            ta.setAttribute('readonly', '');
                            document.body.appendChild(ta);
                            ta.select();
                            ta.setSelectionRange(0, ta.value.length);
                            const ok = document.execCommand('copy');
                            document.body.removeChild(ta);
                            if (ok) {
                                showMessage('å·²è¤‡è£½å–®è™Ÿ');
                            } else {
                                throw new Error('execCommand copy failed');
                            }
                        } catch (err2) {
                            showMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚', 'error');
                        }
                    }
                } else if (act === 'view-detail') {
                    const req = state.requests.find(r => r.id === id);
                    if (req) {
                        updateState({ view: 'detailView', selectedRequest: req });
                    }
                } else if (act === 'print-request') {
                    printRequest(id);
                } else if (act === 'quick-approve') {
                    // ç›´æ¥æ ¸å‡†ç•¶å‰æ­¥é©Ÿï¼ˆè‹¥ç¬¦åˆè³‡æ ¼ï¼‰
                    const req = state.requests.find(r => r.id === id);
                    if (!req) return;
                    const current = (req.approvers || []).find(a => a.status === 'pending');
                    if (!(req.status === 'å¾…å¯©æ ¸' && current?.userId === state.currentUser.id)) {
                        showMessage('æ‚¨ä¸æ˜¯æ­¤å–®ç›®å‰çš„ç°½æ ¸äººã€‚', 'error');
                        return;
                    }
                    try {
                        const approvers = [...req.approvers];
                        const idx = approvers.findIndex(a => a.status === 'pending');
                        if (idx === -1) return;
                        approvers[idx].status = 'approved';
                        approvers[idx].date = new Date().toISOString();
                        approvers[idx].comment = '';
                        const isFinal = idx === approvers.length - 1;
                        const updateData = {
                            approvers,
                            status: isFinal ? 'å·²æ ¸å‡†' : 'å¾…å¯©æ ¸',
                            ...(isFinal ? (() => {
                                const handlerUser = Object.values(state.users).find(u => u.is_handler);
                                return { handler_status: 'å¾…ç¶“è¾¦', handler_id: handlerUser ? handlerUser.id : null };
                            })() : {})
                        };
                        const { data: updated, error } = await supabase.from('requests').update(updateData).eq('id', id).select().single();
                        if (error) throw error;
                        // é€šçŸ¥ç”³è«‹äººèˆ‡ï¼ˆè‹¥æ˜¯æœ€å¾Œä¸€é—œï¼‰ç¶“è¾¦
                        try {
                            const msg = isFinal ? `æ‚¨çš„ç”³è«‹å–® ${id} å·²å…¨æ•¸ç°½æ ¸å®Œæˆï¼` : `æ‚¨çš„ç”³è«‹å–® ${id} å·²ç”± ${state.currentUser.name} æ ¸å‡†ã€‚`;
                            await supabase.from('notifications').insert({ user_id: req.applicant_id, request_id: id, message: msg, is_read: false });
                            if (isFinal && updateData.handler_id) {
                                await supabase.from('notifications').insert({ user_id: updateData.handler_id, request_id: id, message: `æ‚¨è¢«æŒ‡æ´¾ç¶“è¾¦ç”³è«‹å–® ${id}ï¼Œè«‹å„˜é€Ÿè™•ç†ã€‚`, is_read: false });
                            }
                        } catch {}
                        const newRequests = state.requests.map(r => r.id === id ? updated : r);
                        getFilteredRequests.resetCache?.();
                        updateState({ requests: newRequests });
                        showMessage('å·²æ ¸å‡†');
                    } catch (err) {
                        showMessage('æ ¸å‡†å¤±æ•—: ' + err.message, 'error');
                    }
                } else if (act === 'quick-reject') {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">é€€å›ç”³è«‹</h3>
                        <label for="popover-rejection-reason" class="block text-sm font-medium text-gray-700">é€€å›ç†ç”±ï¼š</label>
                        <textarea id="popover-rejection-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                        <div class="mt-6 flex justify-end space-x-4">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">å–æ¶ˆ</button>
                            <button data-action="confirm-popover-reject-previous" data-id="${id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-yellow-500 text-white">é€€å›ä¸Šä¸€å±¤</button>
                            <button data-action="confirm-popover-reject-all" data-id="${id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">æ•´ç­†é€€å–®</button>
                        </div>
                    `);
                } else if (act === 'quick-handle') {
                    const req = state.requests.find(r => r.id === id);
                    if (!req) return;
                    const effectiveHandlerStatus = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                    const canHandle = (req.status === 'å·²æ ¸å‡†') && (effectiveHandlerStatus === 'å¾…ç¶“è¾¦') && ((state.currentUser.id === req.handler_id) || state.currentUser.is_admin || ['æ¡è³¼','æ¡è³¼ä¸»ç®¡'].includes(state.currentUser.role)) && (req.closed_status !== 'çµæ¡ˆ');
                    if (!canHandle) { showMessage('ç›®å‰ç‹€æ…‹ä¸å¯ç¶“è¾¦æˆ–æ‚¨ç„¡æ¬Šé™ã€‚', 'error'); return; }
                    try {
                        const newHistoryEntry = { 
                            user: state.currentUser.name, 
                            userId: state.currentUser.id,
                            role: state.currentUser.role, 
                            date: new Date().toISOString(), 
                            reason: 'ç¶“è¾¦å®Œæˆ', 
                            action: 'handled', 
                            comment: '' 
                        };
                        const patch = { handler_status: 'å·²ç¶“è¾¦', modification_history: [...(req.modification_history || []), newHistoryEntry] };
                        const { data: updated, error } = await supabase.from('requests').update(patch).eq('id', id).select().single();
                        if (error) throw error;
                        // é€šçŸ¥ç”³è«‹äººèˆ‡ç¶“è¾¦ç¾¤çµ„
                        const notifs = [];
                        notifs.push({ user_id: req.applicant_id, request_id: req.id, message: `æ‚¨çš„ç”³è«‹å–® ${req.id} å·²ç”± ${state.currentUser.name} å®Œæˆç¶“è¾¦ã€‚`, is_read: false });
                        const handlerUsers = Object.values(state.users).filter(u => u.is_handler);
                        handlerUsers.forEach(u => notifs.push({ user_id: u.id, request_id: req.id, message: `ç”³è«‹å–® ${req.id} å·²ç”± ${state.currentUser.name} å®Œæˆç¶“è¾¦ã€‚`, is_read: false }));
                        if (notifs.length) { await supabase.from('notifications').insert(notifs); }
                        const newRequests = state.requests.map(r => r.id === id ? updated : r);
                        getFilteredRequests.resetCache?.();
                        updateState({ requests: newRequests });
                        showMessage('å·²å®Œæˆç¶“è¾¦');
                        // é—œé–‰ Popover
                        const pop = document.getElementById('dashboard-hover-popover');
                        if (pop) { pop.classList.remove('show'); pop.style.visibility = 'hidden'; pop.style.display = 'none'; }
                    } catch (err) {
                        showMessage('ç¶“è¾¦å¤±æ•—: ' + err.message, 'error');
                    }
                } else if (act === 'quick-close') {
                    const req = state.requests.find(r => r.id === id);
                    if (!req) return;
                    const effectiveHandlerStatus = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                    const canClose = (req.status === 'å·²æ ¸å‡†') && (effectiveHandlerStatus === 'å·²ç¶“è¾¦') && (req.closed_status !== 'çµæ¡ˆ') && (state.currentUser.is_admin || ['æ¡è³¼','æ¡è³¼ä¸»ç®¡'].includes(state.currentUser.role));
                    if (!canClose) { showMessage('ç›®å‰ç‹€æ…‹ä¸å¯çµæ¡ˆæˆ–æ‚¨ç„¡æ¬Šé™ã€‚', 'error'); return; }
                    try {
                        const newHistoryEntry = { 
                            user: state.currentUser.name, 
                            userId: state.currentUser.id,
                            role: state.currentUser.role, 
                            date: new Date().toISOString(), 
                            reason: 'çµæ¡ˆ', 
                            action: 'closed' 
                        };
                        const patch = { closed_status: 'çµæ¡ˆ', modification_history: [...(req.modification_history || []), newHistoryEntry] };
                        const { data: updated, error } = await supabase.from('requests').update(patch).eq('id', id).select().single();
                        if (error) throw error;
                        const newRequests = state.requests.map(r => r.id === id ? updated : r);
                        getFilteredRequests.resetCache?.();
                        updateState({ requests: newRequests });
                        showMessage('å·²çµæ¡ˆ');
                        const pop = document.getElementById('dashboard-hover-popover');
                        if (pop) { pop.classList.remove('show'); pop.style.visibility = 'hidden'; pop.style.display = 'none'; }
                    } catch (err) {
                        showMessage('çµæ¡ˆå¤±æ•—: ' + err.message, 'error');
                    }
                }
            });
        })();

        document.getElementById('dashboard-view').addEventListener('change', (e) => {
            const target = e.target;
            if (target.matches('.filter-change')) {
                state.local.selectedRequestIds.clear();
                state.local.currentPage = 1;
                state.local.dashboardFilters[target.dataset.filter] = target.value;
                renderDashboard();
            } else if (target.matches('.request-checkbox')) {
                const id = target.dataset.id;
                if (target.checked) {
                    state.local.selectedRequestIds.add(id);
                } else {
                    state.local.selectedRequestIds.delete(id);
                }
                renderDashboard();
            } else if (target.matches('.multi-select-checkbox')) {
                const filterKey = target.dataset.filterKey;
                const value = target.value;
                if (target.checked) {
                    tempSelections[filterKey].add(value);
                } else {
                    tempSelections[filterKey].delete(value);
                }
            }
        });

        document.getElementById('dashboard-view').addEventListener('keyup', (e) => {
            if (e.target.matches('.multi-select-search')) {
                const searchTerm = e.target.value.toLowerCase();
                const listItems = e.target.nextElementSibling.querySelectorAll('li');
                listItems.forEach(li => {
                    const label = li.querySelector('span').textContent.toLowerCase();
                    const value = li.querySelector('input').value.toLowerCase();
                    if (label.includes(searchTerm) || value.includes(searchTerm)) {
                        li.style.display = '';
                    } else {
                        li.style.display = 'none';
                    }
                });
            }
        });

        document.getElementById('newRequest-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'switch-category') {
                state.local.activeProductCategory = button.dataset.category;
                state.local.newRequestSearchTerm = '';
                state.local.newRequestCurrentPage = 1; // Reset page on category change
                const searchInput = document.getElementById('new-request-product-search');
                if (searchInput) searchInput.value = '';
                
                document.querySelectorAll('#newRequest-view .product-category-btn').forEach(btn => {
                    btn.classList.toggle('border-blue-500', btn === button);
                    btn.classList.toggle('text-blue-600', btn === button);
                });
                renderProductList();
            } else if (action === 'toggle-layout-scale') {
                const scale = button.dataset.scale;
                state.local.layoutScale = scale;
                renderNewRequest(); // é‡æ–°æ¸²æŸ“æ•´å€‹é é¢ä»¥æ‡‰ç”¨æ–°çš„å¸ƒå±€
            } else if (action === 'product-page-change') {
                const page = parseInt(button.dataset.page, 10);
                if (page) {
                    updateState({ local: { ...state.local, newRequestCurrentPage: page } });
                }
            } else if (action === 'add-to-cart') {
                const product = JSON.parse(button.dataset.product);
                const quantityInput = button.previousElementSibling;
                const quantity = parseInt(quantityInput.value, 10);
                if (quantity > 0) {
                    const existingItem = state.local.newRequestCart.find(item => item.id === product.id);
                    if (existingItem) {
                        existingItem.quantity += quantity;
                    } else {
                        state.local.newRequestCart.push({ 
                            ...product, 
                            quantity, 
                            is_scrap_work_order: false, 
                            work_order_number: '',
                            demand_department: state.currentUser.demand_department || state.currentUser.department || '',
                            // é å…ˆå¸¶å…¥é è¨­ç™¼ç¥¨é–‹ç«‹ï¼Œç¢ºä¿æœªæ“ä½œä¹Ÿèƒ½æ­£ç¢ºå¯«å…¥
                            invoice: state.currentUser.default_invoice || '',
                            custom_invoice: '',
                            reason: 'æ–°å¢',
                            description: ''
                        });
                    }
                    quantityInput.value = 1;
                    renderNewRequestSidebar();
                } else {
                    showMessage('è«‹è¼¸å…¥å“é …æ•¸é‡', 'error');
                }
            } else if (action === 'upload-attachments') {
                const fileInput = document.getElementById('request-attachment-input');
                const files = Array.from(fileInput.files || []);
                if (!files.length) {
                    showMessage('è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„é™„ä»¶ã€‚', 'error');
                    return;
                }
                // æª”æ¡ˆå¤§å°æª¢æŸ¥ï¼ˆæ¯æª” 1MBï¼‰
                const overs = files.filter(f => f.size > MAX_FILE_SIZE_BYTES);
                if (overs.length) {
                    const names = overs.map(f => `${f.name}ï¼ˆ${f.size.toLocaleString()} bytesï¼‰`).join(', ');
                    showMessage(`ä»¥ä¸‹æª”æ¡ˆè¶…é 1MB ä¸Šé™ï¼Œè«‹ç§»é™¤å¾Œå†ä¸Šå‚³ï¼š${names}`, 'error');
                    return;
                }
                button.disabled = true;
                button.textContent = 'ä¸Šå‚³ä¸­...';
                try {
                    const baseUrl = (window.getSupabaseBaseUrl && window.getSupabaseBaseUrl()) || '';
                    if (!baseUrl) throw new Error('æœªè¨­å®š SUPABASE_URL');
                    const session = (await supabase.auth.getSession()).data?.session;
                    const token = session?.access_token || (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                    const apikey = (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));

                    const uploaded = [];
                    const tryUploadViaFetch = async (formData, attempt = 1) => {
                        const urlPrimary = `${baseUrl}/functions/v1/${ATTACHMENT_UPLOAD_FN}`;
                        // å¦ä¸€è·¯å¾‘ï¼šfunctions å­ç¶²åŸŸï¼ˆæŸäº›éƒ¨ç½²å…è¨±åƒ…æ­¤ä¾†æºï¼‰
                        const projectRef = (() => {
                            try { return new URL(baseUrl).hostname.split('.')[0]; } catch { return null; }
                        })();
                        const altUrl = projectRef ? `https://${projectRef}.functions.supabase.co/${ATTACHMENT_UPLOAD_FN}` : null;
                        const endpoints = [urlPrimary, altUrl].filter(Boolean);
                        let lastErr;
                        for (const ep of endpoints) {
                            try {
                                // 1) å˜—è©¦ç°¡å–®è«‹æ±‚ï¼ˆä¸å¸¶è‡ªè¨‚æ¨™é ­ï¼Œé¿å…é æª¢ï¼‰
                                try {
                                    const resSimple = await fetch(ep, {
                                        method: 'POST',
                                        mode: 'cors',
                                        cache: 'no-store',
                                        body: formData,
                                    });
                                    if (resSimple.ok) return await resSimple.json();
                                } catch (simpleErr) {
                                    // è¨˜éŒ„ä½†ä¸ç«‹å³æ‹‹å‡ºï¼Œé€²å…¥å¸¶æˆæ¬Šé‡è©¦
                                    lastErr = simpleErr;
                                }

                                // 2) æ”œå¸¶æˆæ¬Šæ¨™é ­å†è©¦ä¸€æ¬¡
                                const resAuth = await fetch(ep, {
                                    method: 'POST',
                                    headers: { Authorization: `Bearer ${token}`, apikey },
                                    mode: 'cors',
                                    cache: 'no-store',
                                    body: formData,
                                });
                                if (!resAuth.ok) {
                                    const text = await resAuth.text().catch(() => '');
                                    throw new Error(`HTTP ${resAuth.status} ${text}`);
                                }
                                return await resAuth.json();
                            } catch (e) {
                                lastErr = e;
                            }
                        }
                        // çŸ­æš«é€€é¿é‡è©¦
                        if (attempt < 2) {
                            await new Promise(r => setTimeout(r, 600));
                            return tryUploadViaFetch(formData, attempt + 1);
                        }
                        throw lastErr || new Error('ç„¡æ³•é€£ç·š Edge Function');
                    };

                    for (const file of files) {
                        if (file.size > MAX_FILE_SIZE_BYTES) {
                            // åŠ å€ä¿éšªï¼ˆç†è«–ä¸Šå‰é¢å·²ç¯©æ‰ï¼‰
                            continue;
                        }
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('applicant_id', state.currentUser?.id || '');
                        let data;
                        try {
                            // 1) å…ˆèµ° fetchï¼ˆæœ€å¯æ§ï¼Œé¿å… invoke èˆ‡ multipart ä¸ç›¸å®¹æƒ…æ³ï¼‰
                            data = await tryUploadViaFetch(formData);
                        } catch (fetchErr) {
                            console.warn('fetch ä¸Šå‚³å¤±æ•—ï¼Œå˜—è©¦ invoke å¾Œå‚™ï¼š', fetchErr);
                            try {
                                const inv = await supabase.functions.invoke(ATTACHMENT_UPLOAD_FN, { body: formData });
                                if (inv.error) throw inv.error;
                                data = inv.data;
                            } catch (invokeErr) {
                                // å½™æ•´éŒ¯èª¤è¨Šæ¯
                                const reason = (fetchErr && fetchErr.message) ? fetchErr.message : (invokeErr?.message || 'æœªçŸ¥éŒ¯èª¤');
                                // å¸¸è¦‹ï¼šCORS/Preflight æœªå…è¨± Authorization/apikey/POST/OPTIONS
                                throw new Error(`ä¸Šå‚³å¤±æ•—ï¼Œå¯èƒ½ç‚ºè·¨åŸŸ/æ¬Šé™è¨­å®šå•é¡Œï¼š${reason}`);
                            }
                        }
                        // å¾Œç«¯å¯èƒ½å›å‚³å¤šç¨®æ¬„ä½ï¼›ä»¥çœ‹èµ·ä¾†åƒ Drive æª”æ¡ˆ id çš„å€¼ç‚ºæº–ï¼Œé¿å…æŠŠè³‡æ–™åº« id èª¤ç•¶æª”æ¡ˆ id
                        const urlCandidates = [
                            data?.url,
                            data?.signedUrl,
                            data?.downloadUrl,
                            data?.link,
                            data?.webViewLink,
                            data?.webContentLink,
                            data?.file?.url,
                            data?.result?.url,
                        ].filter((v) => typeof v === 'string');
                        let driveIdFromUrl = '';
                        for (const u of urlCandidates) {
                            const parsed = parseDriveRef(u);
                            if (parsed?.type === 'id' && isLikelyDriveId(parsed.value)) { driveIdFromUrl = parsed.value; break; }
                        }

                        const candidates = [
                            data?.fileId,
                            data?.driveFileId,
                            data?.drive_id,
                            data?.result?.id,
                            data?.file?.id,
                            data?.id,
                            driveIdFromUrl,
                        ].filter((v) => typeof v === 'string');
                        const driveId = candidates.find(isLikelyDriveId) || '';
                        // ç‚ºä¿ç›¸å®¹æ€§ï¼Œè‹¥å¾Œç«¯åƒ…å›å‚³è³‡æ–™åº«ä¸»éµï¼ˆUUIDï¼‰ï¼Œä»ä¿ç•™è©² idï¼Œä½†å¦å­˜ driveIdï¼ˆè‹¥æœ‰ï¼‰
                        const fallbackId = data?.id || data?.file?.id || data?.result?.id || data?.fileId || '';
                        const chosenId = driveId || fallbackId;
                        if (!chosenId) throw new Error('ä¸Šå‚³å¤±æ•—ï¼šæœªå–å¾—æª”æ¡ˆ ID');
                        const fileMeta = (data && (data.file || data)) || {};
                        const name = fileMeta.name || file.name;
                        const size = fileMeta.size || file.size;
                        const mimeType = fileMeta.mimeType || file.type;
                        const attObj = { id: chosenId, name, size, mimeType, uploaded_at: new Date().toISOString() };
                        if (driveId) attObj.driveId = driveId;
                        uploaded.push(attObj);
                    }

                    state.local.newRequestAttachments = [...(state.local.newRequestAttachments || []), ...uploaded];
                    // æ¸…ç©ºæª”æ¡ˆé¸æ“‡
                    fileInput.value = '';
                    const filenameSpan = document.getElementById('request-attachment-filename');
                    filenameSpan.textContent = 'æœªé¸æ“‡æª”æ¡ˆ';
                    button.textContent = 'ä¸Šå‚³é™„ä»¶';
                    showMessage(`å·²ä¸Šå‚³ ${uploaded.length} å€‹é™„ä»¶`);
                    renderNewRequestSidebar();
                } catch (err) {
                    console.error('é™„ä»¶ä¸Šå‚³å¤±æ•—:', err);
                    let msg = String(err?.message || err || 'æœªçŸ¥éŒ¯èª¤');
                    const lower = msg.toLowerCase();
                    if (lower.includes('storagequotaexceeded') || lower.includes('service accounts do not have storage quota')) {
                        msg += '\nå»ºè­°ï¼š\n1) å°‡ Service Account åŠ å…¥ Google å…±ç”¨é›²ç«¯ç¡¬ç¢Ÿä¸¦çµ¦äºˆè‡³å°‘ã€Œå…§å®¹ç®¡ç†å“¡ã€æ¬Šé™ï¼›\n2) å°‡ DRIVE_FOLDER_ID è¨­ç‚ºè©²å…±ç”¨é›²ç«¯ç¡¬ç¢Ÿä¸­çš„è³‡æ–™å¤¾ IDï¼›\n3) å¾Œç«¯ä¸Šå‚³è«‹æ±‚åŠ ä¸Š supportsAllDrives=trueï¼›\næˆ–æ¡ç”¨ç¶²åŸŸå§”æ´¾ï¼ˆDomain-wide Delegationï¼‰ä¸¦ä»¥ä½¿ç”¨è€…èº«åˆ†ä¸Šå‚³ã€‚';
                    }
                    showMessage('é™„ä»¶ä¸Šå‚³å¤±æ•—ï¼š' + msg, 'error');
                    button.textContent = 'ä¸Šå‚³é™„ä»¶';
                } finally {
                    button.disabled = false;
                }
            } else if (action === 'remove-attachment') {
                const idx = parseInt(button.dataset.index, 10);
                if (!isNaN(idx)) {
                    const att = (state.local.newRequestAttachments || [])[idx];
                    // å…ˆæ¨‚è§€æ›´æ–° UI
                    const removed = state.local.newRequestAttachments.splice(idx, 1);
                    renderNewRequestSidebar();

                    // åƒ…å°å·²ä¸Šå‚³è‡³é›²ç«¯ä¸”å…·æœ‰ id çš„æª”æ¡ˆç™¼å‡ºåˆªé™¤è«‹æ±‚
                    if (att && (att.driveId || att.id)) {
                        (async () => {
                            const rollback = () => {
                                if (removed && removed.length) {
                                    state.local.newRequestAttachments.splice(idx, 0, removed[0]);
                                    renderNewRequestSidebar();
                                }
                            };
                            try {
                                const baseUrl = (window.getSupabaseBaseUrl && window.getSupabaseBaseUrl()) || '';
                                if (!baseUrl) throw new Error('æœªè¨­å®š SUPABASE_URL');
                                const session = (await supabase.auth.getSession()).data?.session;
                                const token = session?.access_token || (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                                const apikey = (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));

                                // è§£æå‡ºæ‡‰åˆªé™¤çš„ Drive æª”æ¡ˆ IDï¼ˆå„ªå…ˆ driveIdï¼Œå…¶æ¬¡ att.id è‹¥åƒ Drive IDï¼Œæœ€å¾Œå˜—è©¦å¾ URL æå–ï¼‰
                                const toDeleteId = (() => {
                                    if (att.driveId && isLikelyDriveId(att.driveId)) return att.driveId;
                                    if (att.id && isLikelyDriveId(att.id)) return att.id;
                                    // å˜—è©¦å¾ URL é¡å­—ä¸²æŠ½å– /?id= æˆ– /d/{id}
                                    if (att.url && typeof att.url === 'string') {
                                        try {
                                            const u = new URL(att.url);
                                            const qid = u.searchParams.get('id');
                                            if (qid && isLikelyDriveId(qid)) return qid;
                                            const m = u.pathname.match(/\/d\/([A-Za-z0-9_-]{15,})/);
                                            if (m && m[1] && isLikelyDriveId(m[1])) return m[1];
                                        } catch {}
                                    }
                                    return att.id; // é€€å›åŸå€¼ï¼ˆå¾Œç«¯è‹¥èƒ½å…¼å®¹æœƒè‡ªè¡Œåˆ¤æ–·ï¼‰
                                })();

                                const projectRef = (() => { try { return new URL(baseUrl).hostname.split('.')[0]; } catch { return null; } })();
                                const primary = `${baseUrl}/functions/v1/${ATTACHMENT_DELETE_FN}?id=${encodeURIComponent(toDeleteId)}`;
                                const alt = projectRef ? `https://${projectRef}.functions.supabase.co/${ATTACHMENT_DELETE_FN}?id=${encodeURIComponent(toDeleteId)}` : null;
                                const endpoints = [primary, alt].filter(Boolean);

                                let lastErr;
                                const errs = [];
                                // 1) å˜—è©¦ DELETEï¼ˆå¸¶æˆæ¬Šï¼‰
                                for (const ep of endpoints) {
                                    try {
                                        const res = await fetch(ep, { method: 'DELETE', headers: { Authorization: `Bearer ${token}`, apikey } });
                                        if (res.ok) {
                                            // è¿½åŠ é©—è­‰ï¼šæª¢æŸ¥æ˜¯å¦çœŸçš„åˆªé™¤
                                            const stillExists = !(await verifyDriveDeleted(toDeleteId));
                                            if (stillExists) {
                                                console.warn('å¾Œç«¯å›è¦†æˆåŠŸï¼Œä½†æª”æ¡ˆä»å¯å–ç”¨ï¼š', toDeleteId);
                                                showMessage(`æ³¨æ„ï¼šåˆªé™¤å›è¦†æˆåŠŸï¼Œä½†æª”æ¡ˆä»å¯å­˜å–ï¼ˆid: ${toDeleteId}ï¼‰ã€‚è«‹æª¢æŸ¥å¾Œç«¯æ˜¯å¦ä»¥ Drive æª”æ¡ˆ ID åˆªé™¤ã€‚`, 'error');
                                            }
                                            return; // æˆåŠŸ
                                        }
                                        // ç›¡é‡è§£æéŒ¯èª¤å…§å®¹ï¼Œå”åŠ©é™¤éŒ¯ï¼ˆä¾‹å¦‚ Edge Function è½‰å‡º Drive éŒ¯èª¤ç´°ç¯€ï¼‰
                                        let t = '';
                                        try { t = await res.text(); } catch {}
                                        let brief = '';
                                        try {
                                            const j = t ? JSON.parse(t) : null;
                                            if (j) {
                                                // å¸¸è¦‹æ¬„ä½ï¼šmessage / error / driveError { status, body }
                                                const drv = j.driveError || j.drive_error || j.drive;
                                                if (drv && (drv.status || drv.body)) {
                                                    const bodyStr = typeof drv.body === 'string' ? drv.body : JSON.stringify(drv.body || {});
                                                    brief = `Drive ${drv.status || ''} ${bodyStr}`.trim();
                                                } else if (j.message || j.error) {
                                                    brief = String(j.message || j.error);
                                                } else {
                                                    brief = JSON.stringify(j);
                                                }
                                            }
                                        } catch (_) {
                                            brief = (t || '').slice(0, 300);
                                        }
                                        const rid = res.headers?.get?.('sb_request_id') || res.headers?.get?.('x-sb-request-id') || '';
                                        const host = (() => { try { return new URL(ep).host; } catch { return ep; } })();
                                        const msg = `${host}: HTTP ${res.status}${brief ? ' - ' + brief : ''}${rid ? ` (sb_request_id: ${rid})` : ''}`;
                                        errs.push(msg);
                                        throw new Error(msg);
                                    } catch (e) {
                                        lastErr = e;
                                    }
                                }
                                // 2) å¾Œå‚™ï¼šä½¿ç”¨ invoke ä»¥ POST å‚³éï¼ˆéœ€å¾Œç«¯å…è¨± POST åˆªé™¤ï¼‰
                                try {
                                    const inv = await supabase.functions.invoke(ATTACHMENT_DELETE_FN, { body: { id: toDeleteId } });
                                    if (inv.error) {
                                        // ç›¡é‡æ“·å–éŒ¯èª¤è¨Šæ¯
                                        const invMsg = inv.error?.message || inv.error?.name || 'invoke error';
                                        errs.push(`invoke: ${invMsg}`);
                                        throw new Error(invMsg);
                                    }
                                    return; // æˆåŠŸ
                                } catch (e) {
                                    lastErr = e;
                                }

                                // å°‡æ‰€æœ‰éŒ¯èª¤å½™æ•´è¼¸å‡ºï¼Œé¿å…éºå¤±è¼ƒæ—©çš„ 4xx/5xx è¨Šæ¯
                                const combined = errs.length ? `åˆªé™¤å¤±æ•—ï¼š\n- ${errs.join('\n- ')}` : (lastErr?.message || 'åˆªé™¤å¤±æ•—ï¼ˆç„¡å¯ç”¨ç«¯é»ï¼‰');
                                throw new Error(combined);
                            } catch (err) {
                                console.error('åˆªé™¤é™„ä»¶æª”æ¡ˆå¤±æ•—ï¼š', err);
                                // å°‡é—œéµéŒ¯èª¤ç¢¼/ç‰‡æ®µå‘ˆç¾çµ¦ä½¿ç”¨è€…ï¼Œåˆ©æ–¼å›å ±ï¼ˆé¿å…éé•·ï¼‰
                                const m = String(err?.message || err || 'æœªçŸ¥éŒ¯èª¤');
                                const short = m.length > 240 ? m.slice(0, 240) + 'â€¦' : m;
                                showMessage(`é›²ç«¯é™„ä»¶åˆªé™¤å¤±æ•—ï¼š${short}`, 'error');
                                rollback();
                            }
                        })();
                    }
                }
            } else if (action === 'submit-request' || action === 'save-request') {
                const isSubmitting = action === 'submit-request';
                const { newRequestCart } = state.local;

                if (newRequestCart.length > 0) {
                    updateState({ loading: true });
                    try {
                        const totalAmount = Math.round(newRequestCart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)) + (item.freight || 0) + (item.discount || 0), 0));
                        // è®€ DOM å¯ç¢ºä¿æœ€æ–°è¼¸å…¥ï¼›è‹¥ç„¡ DOM å‰‡é€€å›æœ¬åœ°æš«å­˜
                        const reasonInputEl = document.getElementById('request-reason');
                        const reason = reasonInputEl ? reasonInputEl.value : (state.local.requestReason || '');
                        
                        const applicant = state.currentUser;
                        const allUsers = state.users;
                        const approvers = [];
                        
                        if (isSubmitting) {
                            let step = 1;
                            // ç¬¬ä¸€éšæ®µï¼šè«‹è³¼éšæ®µç°½æ ¸ï¼ˆç”³è«‹äººä¸»ç®¡éˆï¼‰
                            if (applicant && applicant.manager_id) {
                                const m1 = Object.values(allUsers).find(u => u.id === applicant.manager_id);
                                if (m1) approvers.push({ step: step++, role: 'ç”³è«‹äººç›´å±¬ä¸»ç®¡', userId: m1.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            if (applicant && applicant.manager_id2) {
                                const m2 = Object.values(allUsers).find(u => u.id === applicant.manager_id2);
                                if (m2) approvers.push({ step: step++, role: 'ç”³è«‹äººç¬¬äºŒä¸»ç®¡', userId: m2.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            if (applicant && applicant.manager_id3) {
                                const m3 = Object.values(allUsers).find(u => u.id === applicant.manager_id3);
                                if (m3) approvers.push({ step: step++, role: 'ç”³è«‹äººç¬¬ä¸‰ä¸»ç®¡', userId: m3.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            // ç¬¬äºŒéšæ®µï¼šé™¢é•·ç°½æ ¸ï¼ˆä¾éƒ¨é–€é–€æª»é‡‘é¡ï¼‰
                            const departmentThreshold = state.departments[applicant.department] || Infinity;
                            if (totalAmount > departmentThreshold) {
                                const director = Object.values(allUsers).find(u => u.role === 'é™¢é•·');
                                if (director) approvers.push({ step: step++, role: 'é™¢é•·', userId: director.id, status: 'pending', date: '', reason: '', comment: '' });
                            }
                            // ç¬¬ä¸‰éšæ®µï¼šæ¡è³¼éšæ®µç°½æ ¸
                            // a. ç¬¬ä¸€é—œè§’è‰² = æ¡è³¼
                            // b. ç¬¬äºŒé—œ ~ ç¬¬å››é—œä¾ã€Œæ¡è³¼ã€çš„ manager_id/manager_id2/manager_id3 ç”¢ç”Ÿï¼šæ¡è³¼ç›´å±¬ä¸»ç®¡ã€æ¡è³¼ç¬¬äºŒä¸»ç®¡ã€æ¡è³¼ç¬¬ä¸‰ä¸»ç®¡
                            const purchasingStaff = Object.values(allUsers).find(u => u.role === 'æ¡è³¼');
                            if (purchasingStaff) {
                                // ç¬¬ä¸‰éšæ®µ-ç¬¬ä¸€é—œï¼šæ¡è³¼
                                approvers.push({ step: step++, role: 'æ¡è³¼', userId: purchasingStaff.id, status: 'pending', date: '', reason: '', comment: '' });
                                // æ¡è³¼ç›´å±¬ä¸»ç®¡
                                if (purchasingStaff.manager_id) {
                                    const pm1 = Object.values(allUsers).find(u => u.id === purchasingStaff.manager_id);
                                    if (pm1) approvers.push({ step: step++, role: 'æ¡è³¼ç›´å±¬ä¸»ç®¡', userId: pm1.id, status: 'pending', date: '', reason: '', comment: '' });
                                }
                                // æ¡è³¼ç¬¬äºŒä¸»ç®¡
                                if (purchasingStaff.manager_id2) {
                                    const pm2 = Object.values(allUsers).find(u => u.id === purchasingStaff.manager_id2);
                                    if (pm2) approvers.push({ step: step++, role: 'æ¡è³¼ç¬¬äºŒä¸»ç®¡', userId: pm2.id, status: 'pending', date: '', reason: '', comment: '' });
                                }
                                // æ¡è³¼ç¬¬ä¸‰ä¸»ç®¡
                                if (purchasingStaff.manager_id3) {
                                    const pm3 = Object.values(allUsers).find(u => u.id === purchasingStaff.manager_id3);
                                    if (pm3) approvers.push({ step: step++, role: 'æ¡è³¼ç¬¬ä¸‰ä¸»ç®¡', userId: pm3.id, status: 'pending', date: '', reason: '', comment: '' });
                                }
                            }
                            // ç¬¬å››éšæ®µï¼šç¶“è¾¦/çµæ¡ˆï¼ˆä¸åŠ å…¥ approversï¼Œç”±ç¶“è¾¦ç‹€æ…‹èˆ‡çµæ¡ˆç‹€æ…‹é©…å‹•ï¼‰
                        }

                        // ç¢ºä¿æ¯å€‹å“é …çš„ç™¼ç¥¨è³‡è¨Šæ­£ç¢ºå¯«å…¥ï¼ˆè‹¥æœªé¸æ“‡å‰‡å¸¶å…¥å€‹äººé è¨­ï¼‰
                        const itemsToSave = newRequestCart.map(item => {
                            const invoiceVal = (item.invoice === undefined || item.invoice === null || item.invoice === '')
                                ? (state.currentUser.default_invoice || '')
                                : item.invoice;
                            const customVal = invoiceVal === 'å…¶ä»–' ? (item.custom_invoice || '') : '';
                            return { ...item, invoice: invoiceVal, custom_invoice: customVal };
                        });

                        const requestData = {
                            applicant_id: state.currentUser.id, 
                            applicant_name: state.currentUser.name,
                            department: state.currentUser.department,
                            items: itemsToSave, 
                            type: state.local.newRequestOrderType || (state.editingRequest?.type) || 'ç‰¹æ¡', 
                            status: isSubmitting ? 'å¾…å¯©æ ¸' : 'å¾…é€å‡º', 
                            total_amount: totalAmount,
                            reason: reason,
                            approvers: approvers,
                            attachments: state.local.newRequestAttachments || [],
                            request_date: new Date().toISOString()
                        };

                        if (state.editingRequest) {
                            // æ›´æ–°è‰ç¨¿
                            const { data, error } = await supabase.from('requests').update(requestData).eq('id', state.editingRequest.id).select();
                            if(error) throw error;
                            console.log('è‰ç¨¿æ›´æ–°æˆåŠŸ:', data);
                        } else {
                            // æ–°å¢ç”³è«‹ - ç”Ÿæˆ SPYYYYMMDDXXX æ ¼å¼çš„ ID
                            try {
                                // å…ˆå˜—è©¦ä¸è¨­å®š ID
                                const { data, error } = await supabase.from('requests').insert(requestData).select();
                                if(error) throw error;
                                console.log('æ–°ç”³è«‹å‰µå»ºæˆåŠŸ:', data);
                            } catch (err) {
                                if (err.message.includes('null value in column "id"')) {
                                    // è³‡æ–™åº«éœ€è¦æ‰‹å‹•è¨­å®š IDï¼Œç”Ÿæˆ SPYYYYMMDDXXX æ ¼å¼
                                    const now = new Date();
                                    const year = now.getFullYear();
                                    const month = String(now.getMonth() + 1).padStart(2, '0');
                                    const day = String(now.getDate()).padStart(2, '0');
                                    const datePrefix = `SP${year}${month}${day}`;
                                    
                                    // æŸ¥è©¢ä»Šå¤©å·²æœ‰çš„ç”³è«‹å–®ï¼Œæ‰¾å‡ºæœ€å¤§æµæ°´è™Ÿ
                                    const { data: todayRequests, error: queryError } = await supabase
                                        .from('requests')
                                        .select('id')
                                        .like('id', `${datePrefix}%`)
                                        .order('id', { ascending: false })
                                        .limit(1);
                                    
                                    if (queryError) throw queryError;
                                    
                                    let sequenceNumber = 1;
                                    if (todayRequests && todayRequests.length > 0) {
                                        const lastId = todayRequests[0].id;
                                        const lastSequence = parseInt(lastId.substring(datePrefix.length));
                                        sequenceNumber = isNaN(lastSequence) ? 1 : lastSequence + 1;
                                    }
                                    
                                    const newId = `${datePrefix}${String(sequenceNumber).padStart(3, '0')}`;
                                    requestData.id = newId;
                                    
                                    const { data, error } = await supabase.from('requests').insert(requestData).select();
                                    if(error) throw error;
                                    console.log('æ–°ç”³è«‹å‰µå»ºæˆåŠŸ (SPYYYYMMDDXXXæ ¼å¼):', data);
                                } else {
                                    throw err;
                                }
                            }
                        }
                        
                        // æ¸…ç©ºè³¼ç‰©è»Šä¸¦é‡ç½®ç·¨è¼¯ç‹€æ…‹
                        state.local.newRequestCart = [];
                        state.editingRequest = null;
                        
                        // æ¸…ç©ºæœ¬åœ°ã€Œç¸½èªªæ˜(é¸å¡«)ã€æš«å­˜ï¼Œé¿å…æˆç‚ºä¸‹ä¸€å¼µæ–°å–®çš„é è¨­å€¼ï¼ˆè‰ç¨¿å…§å®¹å·²å¯«å…¥è³‡æ–™åº«ï¼‰
            updateState({ 
                            loading: false,
                            local: { 
                                ...state.local, 
                                newRequestCart: [], 
                requestReason: '',
                newRequestOrderType: undefined,
                newRequestAttachments: []
                            }
                        });
                        showMessage(isSubmitting ? 'ç”³è«‹å–®å·²æˆåŠŸé€å‡ºï¼' : 'è‰ç¨¿å·²å„²å­˜ï¼');
                        
                        // æ¸…é™¤ç·©å­˜ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™ï¼Œç¢ºä¿é¡¯ç¤ºæœ€æ–°çš„ç”³è«‹å–®
                        CacheManager.clear('dashboard_data');
                        await loadDashboardData(true, false); // å¼·åˆ¶ä¸ä½¿ç”¨ç·©å­˜
                        
                        // é‡ç½®ç¯©é¸ç·©å­˜
                        getFilteredRequests.resetCache();
                        
                        // ç¢ºä¿é‡æ–°æ¸²æŸ“ï¼Œç„¡è«–è¦–åœ–æ˜¯å¦æ”¹è®Š
                        requestAnimationFrame(() => {
                            render();
                        });

                    } catch (err) {
                        console.error("Error saving/submitting request:", err);
                        showMessage('æ“ä½œå¤±æ•—: ' + err.message, 'error');
                        updateState({ loading: false });
                    }
                } else {
                    showMessage('è«‹å…ˆæ·»åŠ å“é …åˆ°ç”³è«‹å–®ä¸­', 'error');
                }
            } else if (action === 'remove-from-cart') {
                // æ‰¾åˆ°çœŸæ­£çš„æ»¾å‹•å®¹å™¨
                const cartItemsContainer = document.querySelector('.cart-items');
                const currentScrollTop = cartItemsContainer ? cartItemsContainer.scrollTop : 0;
                
                const productId = button.dataset.id;
                state.local.newRequestCart = state.local.newRequestCart.filter(item => item.id != productId);
                
                renderNewRequestSidebar();
                
                // æ­£ç¢ºçš„æ»¾å‹•ä½ç½®æ¢å¾©æ©Ÿåˆ¶
                const restoreScrollPosition = () => {
                    const newCartItemsContainer = document.querySelector('.cart-items');
                    if (newCartItemsContainer) {
                        newCartItemsContainer.scrollTop = currentScrollTop;
                    }
                };
                
                // å¤šæ¬¡å˜—è©¦æ¢å¾©ï¼Œç¢ºä¿æˆåŠŸ
                requestAnimationFrame(() => {
                    restoreScrollPosition();
                    setTimeout(restoreScrollPosition, 0);
                    setTimeout(restoreScrollPosition, 10);
                    setTimeout(restoreScrollPosition, 50);
                    setTimeout(restoreScrollPosition, 100);
                });
            } else if (action === 'search-new-request-product') {
                const searchTerm = document.getElementById('new-request-product-search').value;
                const searchAll = document.getElementById('new-request-search-all-checkbox').checked;
                updateState({ local: { ...state.local, newRequestSearchTerm: searchTerm, newRequestSearchAll: searchAll, newRequestCurrentPage: 1 } });
            } else if (action === 'toggle-favorite') {
                const productId = button.dataset.productId;
                const favorites = state.local.favoriteProductIds;
                if (favorites.has(productId)) {
                    favorites.delete(productId);
                } else {
                    favorites.add(productId);
                }
                saveFavoritesToDb(state.currentUser.id, favorites);
                renderProductList();
            }
        });

        document.getElementById('newRequest-view').addEventListener('change', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const itemId = target.dataset.id;
            const itemInCart = state.local.newRequestCart.find(item => item.id == itemId);

            // é™„ä»¶é¸æ“‡
            if (target.id === 'request-attachment-input') {
                const files = Array.from(target.files || []);
                const filenameSpan = document.getElementById('request-attachment-filename');
                const uploadBtn = document.querySelector('[data-action="upload-attachments"]');
                if (files.length) {
                    const overs = files.filter(f => f.size > MAX_FILE_SIZE_BYTES);
                    filenameSpan.textContent = files.map(f => f.name).join(', ');
                    if (overs.length) {
                        const overNames = overs.map(f => `${f.name}ï¼ˆ>${(MAX_FILE_SIZE_BYTES/1024/1024).toFixed(0)}MBï¼‰`).join(', ');
                        filenameSpan.textContent += ` ï½œ è¶…å‡ºä¸Šé™ï¼š${overNames}`;
                        if (uploadBtn) uploadBtn.disabled = true;
                        showMessage('æœ‰æª”æ¡ˆè¶…é 1MBï¼Œä¸Šå‚³å·²åœç”¨ã€‚è«‹ç§»é™¤è¶…å¤§æª”æ¡ˆå¾Œå†è©¦ã€‚', 'error');
                    } else {
                        if (uploadBtn) uploadBtn.disabled = false;
                    }
                } else {
                    filenameSpan.textContent = 'æœªé¸æ“‡æª”æ¡ˆ';
                    if (uploadBtn) uploadBtn.disabled = true;
                }
                return;
            }

            if (!itemInCart) return;

            if (action === 'update-cart-quantity') {
                // æ‰¾åˆ°çœŸæ­£çš„æ»¾å‹•å®¹å™¨
                const cartItemsContainer = document.querySelector('.cart-items');
                const currentScrollTop = cartItemsContainer ? cartItemsContainer.scrollTop : 0;
                
                const newQuantity = parseInt(target.value, 10);
                if (newQuantity > 0) {
                    itemInCart.quantity = newQuantity;
                } else {
                    state.local.newRequestCart = state.local.newRequestCart.filter(item => item.id != itemId);
                }
                
                renderNewRequestSidebar();
                
                // æ­£ç¢ºçš„æ»¾å‹•ä½ç½®æ¢å¾©æ©Ÿåˆ¶
                const restoreScrollPosition = () => {
                    const newCartItemsContainer = document.querySelector('.cart-items');
                    if (newCartItemsContainer) {
                        newCartItemsContainer.scrollTop = currentScrollTop;
                    }
                };
                
                // å¤šæ¬¡å˜—è©¦æ¢å¾©ï¼Œç¢ºä¿æˆåŠŸ
                requestAnimationFrame(() => {
                    restoreScrollPosition();
                    setTimeout(restoreScrollPosition, 0);
                    setTimeout(restoreScrollPosition, 10);
                    setTimeout(restoreScrollPosition, 50);
                    setTimeout(restoreScrollPosition, 100);
                });
            } else if (action === 'toggle-item-scrap') {
                // æ‰¾åˆ°çœŸæ­£çš„æ»¾å‹•å®¹å™¨
                const cartItemsContainer = document.querySelector('.cart-items');
                const currentScrollTop = cartItemsContainer ? cartItemsContainer.scrollTop : 0;
                
                itemInCart.is_scrap_work_order = target.checked;
                if (!target.checked) {
                    itemInCart.work_order_number = '';
                }
                
                // é˜²æ­¢é è¨­è¡Œç‚ºå’Œäº‹ä»¶å†’æ³¡
                e.preventDefault();
                e.stopPropagation();
                
                // é‡æ–°æ¸²æŸ“ä¸¦ä¿æŒæ»¾å‹•ä½ç½®
                renderNewRequestSidebar();

                // æ¸²æŸ“å¾Œä¾æ¢ä»¶æ›´æ–°æé†’é¡¯ç¤º
                const reminderElement = document.getElementById(`scrap-reminder-${itemId}`);
                if (reminderElement) {
                    const shouldShow = itemInCart.reason === 'å ±å»¢' && !(itemInCart.is_scrap_work_order && (itemInCart.work_order_number || '').trim());
                    reminderElement.classList.toggle('hidden', !shouldShow);
                }
                
                // æ­£ç¢ºçš„æ»¾å‹•ä½ç½®æ¢å¾©æ©Ÿåˆ¶
                const restoreScrollPosition = () => {
                    const newCartItemsContainer = document.querySelector('.cart-items');
                    if (newCartItemsContainer) {
                        newCartItemsContainer.scrollTop = currentScrollTop;
                    }
                };
                
                // å¤šæ¬¡å˜—è©¦æ¢å¾©ï¼Œç¢ºä¿æˆåŠŸ
                requestAnimationFrame(() => {
                    restoreScrollPosition();
                    setTimeout(restoreScrollPosition, 0);
                    setTimeout(restoreScrollPosition, 10);
                    setTimeout(restoreScrollPosition, 50);
                    setTimeout(restoreScrollPosition, 100);
                });
            } else if (action === 'update-item-reason') {
                itemInCart.reason = target.value;
                
                // å‹•æ…‹é¡¯ç¤º/éš±è—æé†’è¨Šæ¯ï¼š
                // å ±å»¢ä¸”æœªåŒæ™‚å‹¾é¸å ±å»¢è²¡ç·¨èˆ‡å¡«å¯«å·¥å–® -> é¡¯ç¤ºï¼›å…¶é¤˜éš±è—
                const reminderId = `scrap-reminder-${itemId}`;
                const reminderElement = document.getElementById(reminderId);
                if (target.value !== 'å ±å»¢') {
                    // éå ±å»¢ï¼šè‡ªå‹•åå‹¾é¸ä¸¦æ¸…ç©ºï¼Œä¸”æé†’éš±è—
                    itemInCart.is_scrap_work_order = false;
                    itemInCart.work_order_number = '';
                }
                // é‡æ–°æ¸²æŸ“å´é‚Šæ¬„ä»¥å¥—ç”¨ checkbox disabled ç‹€æ…‹èˆ‡è¼¸å…¥æ¡†éš±è—
                const cartItemsContainer = document.querySelector('.cart-items');
                const currentScrollTop = cartItemsContainer ? cartItemsContainer.scrollTop : 0;
                renderNewRequestSidebar();
                requestAnimationFrame(() => {
                    const newCartItemsContainer = document.querySelector('.cart-items');
                    if (newCartItemsContainer) newCartItemsContainer.scrollTop = currentScrollTop;
                });
            }
        });
        
    document.getElementById('newRequest-view').addEventListener('input', (e) => {
            const target = e.target;
            const action = target.dataset.action;
            const itemId = target.dataset.id;
            const itemInCart = state.local.newRequestCart.find(item => item.id == itemId);

            if (itemInCart && action === 'update-item-work-order') {
                itemInCart.work_order_number = target.value;
                // ä¾æ¢ä»¶æ›´æ–°æé†’é¡¯ç¤º
                const reminderElement = document.getElementById(`scrap-reminder-${itemId}`);
                if (reminderElement) {
                    const shouldShow = itemInCart.reason === 'å ±å»¢' && !(itemInCart.is_scrap_work_order && (itemInCart.work_order_number || '').trim());
                    reminderElement.classList.toggle('hidden', !shouldShow);
                }
            } else if (target.id === 'request-reason') {
                // å³æ™‚ä¿å­˜ç¸½èªªæ˜ï¼Œé¿å…é‡æ¸²æŸ“é€ æˆå…§å®¹æ¶ˆå¤±
                state.local.requestReason = target.value;
            } else if (action === 'update-order-type') {
                // å³æ™‚ä¿å­˜è¨‚å–®é¡åˆ¥ï¼ˆç‰¹æ¡/å°ˆæ¡ˆï¼‰
                state.local.newRequestOrderType = target.value;
            } else if (itemInCart && action === 'update-item-demand-dept') {
                itemInCart.demand_department = target.value;
            } else if (itemInCart && action === 'update-item-description') {
                itemInCart.description = target.value;
            } else if (itemInCart && action === 'update-item-invoice') {
                // æ‰¾åˆ°çœŸæ­£çš„æ»¾å‹•å®¹å™¨
                const cartItemsContainer = document.querySelector('.cart-items');
                const currentScrollTop = cartItemsContainer ? cartItemsContainer.scrollTop : 0;
                
                itemInCart.invoice = target.value;
                itemInCart.custom_invoice = '';
                
                // ä¿ç•™ç¸½èªªæ˜çš„å€¼
                const currentReason = document.getElementById('request-reason')?.value ?? state.local.requestReason ?? '';
                state.local.requestReason = currentReason;
                renderNewRequestSidebar();
                
                // æ­£ç¢ºçš„æ»¾å‹•ä½ç½®æ¢å¾©æ©Ÿåˆ¶
                const restoreScrollPosition = () => {
                    const newCartItemsContainer = document.querySelector('.cart-items');
                    if (newCartItemsContainer) {
                        newCartItemsContainer.scrollTop = currentScrollTop;
                    }
                };
                
                // å¤šæ¬¡å˜—è©¦æ¢å¾©ï¼Œç¢ºä¿æˆåŠŸ
                requestAnimationFrame(() => {
                    restoreScrollPosition();
                    setTimeout(restoreScrollPosition, 0);
                    setTimeout(restoreScrollPosition, 10);
                    setTimeout(restoreScrollPosition, 50);
                    setTimeout(restoreScrollPosition, 100);
                });
            } else if (itemInCart && action === 'update-item-custom-invoice') {
                itemInCart.custom_invoice = target.value;
            }
        });

        document.getElementById('detailView-view').addEventListener('input', (e) => {
            if (e.target.classList.contains('item-input')) {
                const form = document.getElementById('edit-request-form');
                const formData = new FormData(form);
                let grandTotal = 0;
                state.selectedRequest.items.forEach((item, index) => {
                    const price = parseFloat(formData.get(`price_${index}`)) || 0;
                    const quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                    const freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                    const discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                    const subtotal = price * quantity + freight + discount;
                    grandTotal += subtotal;
                    const subtotalCell = document.querySelector(`.subtotal-cell[data-index="${index}"]`);
                    if (subtotalCell) subtotalCell.textContent = `$${subtotal.toLocaleString()}`;
                });
                const grandTotalCell = document.getElementById('grand-total');
                if (grandTotalCell) grandTotalCell.textContent = `$${Math.round(grandTotal).toLocaleString()}`;
            }
        });

        // è©³æƒ…é ï¼šåˆ‡æ›ç™¼ç¥¨é–‹ç«‹çš„ã€Œå…¶ä»–ã€è‡ªè¨‚æ¬„ä½é¡¯ç¤ºï¼Œä»¥åŠå ±å»¢ -> è²¡ç”¢ç·¨è™Ÿå•Ÿç”¨ç‹€æ…‹
    document.getElementById('detailView-view').addEventListener('change', (e) => {
            const target = e.target;
            if (!target.name) return;
            if (target.name.startsWith('invoice_')) {
                const idx = target.name.split('_')[1];
                const custom = document.querySelector(`input[name="custom_invoice_${idx}"]`);
                if (custom) {
                    if (target.value === 'å…¶ä»–') {
                        custom.classList.remove('hidden');
                        custom.classList.add('block', 'w-2/3');
                    } else {
                        custom.classList.add('hidden');
                        custom.classList.remove('block', 'w-2/3');
                        custom.value = '';
                    }
                }
            } else if (target.name.startsWith('scrap_')) {
                const idx = target.name.split('_')[1];
                const asset = document.querySelector(`input[name="asset_number_${idx}"]`);
                if (asset) {
                    const enabled = target.checked;
                    asset.disabled = !enabled;
                    asset.classList.toggle('opacity-50', !enabled);
                    if (!enabled) asset.value = '';
                }
            } else if (target.name.startsWith('reason_')) {
                const idx = target.name.split('_')[1];
                const scrap = document.querySelector(`input[name="scrap_${idx}"]`);
                const asset = document.querySelector(`input[name="asset_number_${idx}"]`);
                if (scrap && asset) {
                    const isScrapReason = target.value === 'å ±å»¢';
                    scrap.disabled = !isScrapReason;
                    if (!isScrapReason) {
                        scrap.checked = false;
                        asset.value = '';
                        asset.disabled = true;
                        asset.classList.add('opacity-50');
                    }
                }
            }
        });

        document.getElementById('detailView-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'download-attachment') {
                const fileId = button.dataset.fileId;
                if (!fileId) return;
                try {
                    button.disabled = true;
                    button.textContent = 'ä¸‹è¼‰ä¸­...';

                    // ä»¥å¸¶æˆæ¬Šæ¨™é ­çš„ fetch ä¸‹è¼‰ blobï¼Œé¿å… window.open ç¼ºå°‘ Authorization é€ æˆ 401
                    const baseUrl = (window.getSupabaseBaseUrl && window.getSupabaseBaseUrl()) || '';
                    if (!baseUrl) throw new Error('æœªè¨­å®š SUPABASE_URL');
                    const session = (await supabase.auth.getSession()).data?.session;
                    const token = session?.access_token || (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                    const apikey = (window.SUPABASE_ANON_KEY || (typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : ''));
                    const url = `${baseUrl}/functions/v1/${ATTACHMENT_SIGNED_URL_FN}?id=${encodeURIComponent(fileId)}`;

            const res = await fetch(url, {
                        method: 'GET',
                        headers: {
                            Authorization: `Bearer ${token}`,
                apikey
                        },
                        mode: 'cors',
                        cache: 'no-store'
                    });
                    if (!res.ok) {
                        const txt = await res.text().catch(() => '');
                        throw new Error(`ä¸‹è¼‰å¤±æ•—ï¼ˆ${res.status}ï¼‰ï¼š${txt || 'è«‹ç¨å¾Œå†è©¦'}`);
                    }
                    const blob = await res.blob();
                    // å…ˆå„ªå…ˆä½¿ç”¨è©³æƒ…é é™„ä»¶æ¸…å–®ä¸­çš„åç¨±ï¼ˆa.nameï¼‰ï¼Œå†å›é€€åˆ° Content-Disposition
                    const reqId = state.selectedRequest?.id || '';
                    const attFromState = (state.selectedRequest?.attachments || []).find(a => String(a.id) === String(fileId));
                    let originalName = attFromState?.name || '';
                    if (!originalName) {
                        const cd = res.headers.get('content-disposition') || '';
                        const m1 = cd.match(/filename\*=UTF-8''([^;]+)$/i);
                        const m2 = cd.match(/filename="?([^";]+)"?/i);
                        if (m1) {
                            try { originalName = decodeURIComponent(m1[1]); } catch (_) { originalName = m1[1]; }
                        } else if (m2) {
                            originalName = m2[1];
                        }
                    }
                    let filename = 'é™„ä»¶';
                    if (reqId && originalName) {
                        filename = `${reqId} - ${originalName}`;
                    } else if (originalName) {
                        filename = originalName;
                    } else if (reqId) {
                        filename = `${reqId}-${fileId}`;
                    }
                    const blobUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(blobUrl);
                    document.body.removeChild(a);
                } catch (err) {
                    console.error('ä¸‹è¼‰é™„ä»¶éŒ¯èª¤:', err);
                    showMessage('ä¸‹è¼‰é™„ä»¶å¤±æ•—ï¼š' + err.message, 'error');
                } finally {
                    button.disabled = false;
                    button.textContent = 'ä¸‹è¼‰';
                }
                return;
            }

            if (action === 'view-mod-history') {
                const req = state.selectedRequest;
                // åªé¡¯ç¤ºç·¨è¼¯ç›¸é—œçš„æ“ä½œï¼Œéæ¿¾æ‰å–®ç´”çš„ç¶“è¾¦ã€çµæ¡ˆç­‰æ“ä½œ
                const editRelatedHistory = (req?.modification_history || []).filter(h => {
                    // ä¿ç•™æ‰€æœ‰ç·¨è¼¯æ“ä½œï¼ˆhandled_edit å’Œå…¶ä»–æœ‰ changes çš„æ“ä½œï¼‰
                    return h.action === 'handled_edit' || (h.changes && h.changes.length > 0);
                });
                
                if (!editRelatedHistory.length) {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">ä¿®æ”¹æ­·ç¨‹</h3>
                        <p class="text-sm text-gray-600">ç›®å‰æ²’æœ‰ä»»ä½•ä¿®æ”¹ç´€éŒ„ã€‚</p>
                        <div class="mt-6 flex justify-end">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">é—œé–‰</button>
                        </div>
                    `, { size: 'half' });
                    return;
                }
                const fieldNameMap = {
                    reason: 'åŸå› ',
                    description: 'èªªæ˜',
                    demand_department: 'éœ€æ±‚èª²å®¤',
                    invoice: 'ç™¼ç¥¨é–‹ç«‹',
                    custom_invoice: 'è‡ªè¨‚ç™¼ç¥¨',
                    vendor: 'å» å•†',
                    price: 'å–®åƒ¹',
                    quantity: 'æ•¸é‡',
                    unit: 'å–®ä½',
                    freight: 'é‹è²»',
                    discount: 'æŠ˜æ‰£',
                    is_scrap_work_order: 'å ±å»¢',
                    work_order_number: 'è²¡ç”¢ç·¨è™Ÿ'
                };
                const ordered = [...editRelatedHistory].reverse(); // æœ€æ–°åœ¨ä¸Š
                const body = ordered.map((entry, i) => {
                    const changes = Array.isArray(entry.changes) ? entry.changes : [];
                    const changesHTML = changes.length ? `
                        <div class="mt-2 space-y-2">
                            ${changes.map(c => `
                                <div class="border rounded p-2 bg-gray-50">
                                    <div class="text-xs text-gray-500">å“é …ï¼š${c.name || c.item_id || ''}</div>
                                    <ul class="mt-1 text-sm list-disc list-inside">
                                        ${(c.changes || []).map(ch => `<li><span class="text-gray-600">${fieldNameMap[ch.field] || ch.field}ï¼š</span><span class="line-through text-gray-400">${ch.from === '' ? 'ï¼ˆç©ºï¼‰' : ch.from}</span> â†’ <span class="text-gray-800">${ch.to === '' ? 'ï¼ˆç©ºï¼‰' : ch.to}</span></li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>` : '<div class="text-sm text-gray-500">ç„¡æ¬„ä½è®Šæ›´æ˜ç´°</div>';
                    return `
                        <div class="mb-4 border-b pb-3">
                            <div class="text-sm font-semibold">#${ordered.length - i} ä¿®æ”¹äººï¼š${entry.user}ï¼ˆ${entry.role}ï¼‰</div>
                            <div class="text-xs text-gray-500">æ™‚é–“ï¼š${getFormattedDateTime(entry.date)}</div>
                            <div class="mt-1 text-sm"><span class="text-gray-600">åŸå› ï¼š</span>${entry.reason || 'ï¼ˆæœªå¡«ï¼‰'}</div>
                            ${changesHTML}
                        </div>
                    `;
                }).join('');
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">ä¿®æ”¹æ­·ç¨‹</h3>
                    <div class="max-h-[70vh] overflow-y-auto pr-1">${body}</div>
                    <div class="mt-4 flex justify-end">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">é—œé–‰</button>
                    </div>
                `, { size: 'half' });
                return;
            }

            // è‹¥æŒ‰ä¸‹æ ¸å‡†ä¸”æœ‰è³‡æ–™è®Šæ›´ï¼Œå…ˆè©¢å•æ˜¯å¦åŒæ™‚å„²å­˜ä¿®æ”¹
            if (action === 'approve') {
                const currentRequest = state.selectedRequest;
                const nextApprover = (currentRequest.approvers || []).find(a => a.status === 'pending');
                const canApprove = state.currentUser && nextApprover && state.currentUser.id === nextApprover.userId;
                const isPurchaser = state.currentUser.role.includes('æ¡è³¼');
                const isPurchaserEditing = canApprove && isPurchaser;
                const form = document.getElementById('edit-request-form');
                if (isPurchaserEditing && form) {
                    const formData = new FormData(form);
                    let hasChanges = false;
                    for (let index = 0; index < (currentRequest.items || []).length; index++) {
                        const item = currentRequest.items[index];
                        const newReason = (formData.get(`reason_${index}`) || '').toString();
                        const newDescription = (formData.get(`description_${index}`) || '').toString();
                        const demandDept = formData.get(`demand_department_${index}`) || '';
                        const invoice = formData.get(`invoice_${index}`) || '';
                        const customInvoice = formData.get(`custom_invoice_${index}`) || '';
                        const vendor = formData.get(`vendor_${index}`) || '';
                        const price = parseFloat(formData.get(`price_${index}`)) || 0;
                        const quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                        const unit = formData.get(`unit_${index}`) || '';
                        const freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                        const discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                        let newScrap = item.is_scrap_work_order;
                        let newAsset = item.work_order_number || '';
                        if (newReason === 'å ±å»¢') {
                            newScrap = !!formData.get(`scrap_${index}`);
                            newAsset = newScrap ? (formData.get(`asset_number_${index}`) || '') : '';
                        } else {
                            newScrap = false;
                            newAsset = '';
                        }
                        if (
                            (item.reason || '') !== newReason ||
                            (item.description || '') !== newDescription ||
                            (item.demand_department || '') !== demandDept ||
                            (item.invoice || '') !== invoice ||
                            (item.custom_invoice || '') !== (invoice === 'å…¶ä»–' ? customInvoice : '') ||
                            (item.vendor || '') !== vendor ||
                            Number(item.price || 0) !== price ||
                            Number(item.quantity || 0) !== quantity ||
                            (item.unit || '') !== unit ||
                            Number(item.freight || 0) !== freight ||
                            Number(item.discount || 0) !== discount ||
                            Boolean(item.is_scrap_work_order) !== Boolean(newScrap) ||
                            (item.work_order_number || '') !== newAsset
                        ) {
                            hasChanges = true;
                            break;
                        }
                    }
                    if (hasChanges) {
                        // å¿«ç…§è©³æƒ…é çš„è¡¨å–®èˆ‡æ¬„ä½å€¼ï¼Œé¿å…å½ˆå‡ºç¢ºèªå¾Œ DOM è¢«è¦†è“‹å°è‡´æ‰¾ä¸åˆ°è³‡æ–™
                        (window).__approvePendingContext = {
                            scope: 'detail',
                            requestId: currentRequest.id,
                            formSelector: '#edit-request-form',
                            commentSelector: '#approval-comment',
                            reasonSelector: '#modification-reason'
                        };
            renderModal(`
                            <h3 class="text-lg font-bold mb-4">è«‹ç¢ºèªæ˜¯å¦é€²è¡Œå–®æ“šè³‡æ–™ä¿®æ”¹</h3>
                            <p class="mb-6 text-sm text-gray-700">åµæ¸¬åˆ°æ‚¨å°å–®æ“šå…§å®¹åšäº†è®Šæ›´ï¼Œæ˜¯å¦ä¸€ä½µå„²å­˜ä¿®æ”¹å¾Œå†æ ¸å‡†ï¼Ÿ</p>
                            <div class="flex justify-end space-x-3">
                                <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                <button data-action="modal-confirm-approve-without-save" data-request-id="${currentRequest.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">å¦ï¼Œç›´æ¥æ ¸å‡†</button>
                <button data-action="modal-confirm-approve-with-save" data-request-id="${currentRequest.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">æ˜¯ï¼Œå„²å­˜ä¿®æ”¹å¾Œæ ¸å‡†</button>
                            </div>
                        `, { size: 'half' });
                        return; // å…ˆä¸é€²å…¥åŸæ ¸å‡†æµç¨‹
                    }
                }
            }

            if (action === 'approve' || action === 'save-changes' || action === 'confirm-approve-with-save' || action === 'confirm-approve-without-save') {
                if (action === 'save-changes') {
                    const modificationReason = document.getElementById('modification-reason').value;
                    if (!modificationReason.trim()) {
                        showMessage('ä¿®æ”¹è¨‚å–®å…§å®¹æ™‚ï¼Œå¿…é ˆå¡«å¯«ä¿®æ”¹åŸå› ã€‚', 'error');
                        return;
                    }
                }
                // è‹¥æ˜¯ã€Œç¢ºèª-å„²å­˜ä¿®æ”¹å¾Œæ ¸å‡†ã€ï¼Œè¦–åŒ save-changes
                const treatAsSave = action === 'save-changes' || action === 'confirm-approve-with-save';

                updateState({ loading: true });
                try {
                    const currentRequest = state.selectedRequest;
                    const approvers = [...currentRequest.approvers];
                    const currentStepIndex = approvers.findIndex(a => a.status === 'pending');

                    if (currentStepIndex !== -1) {
                        approvers[currentStepIndex].status = 'approved';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].comment = document.getElementById('approval-comment').value || '';
                        
                        const isFinal = currentStepIndex === approvers.length - 1;
                        const newStatus = isFinal ? 'å·²æ ¸å‡†' : 'å¾…å¯©æ ¸';

                        let updateData = { approvers, status: newStatus };
                        if (isFinal) {
                            const handlerUser = Object.values(state.users).find(u => u.is_handler);
                            updateData.handler_status = 'å¾…ç¶“è¾¦';
                            updateData.handler_id = handlerUser ? handlerUser.id : null;
                        }
                        if (isFinal) {
                            // æŒ‡æ´¾ç¶“è¾¦èˆ‡ç‹€æ…‹
                            const handlerUser = Object.values(state.users).find(u => u.is_handler);
                            updateData.handler_status = 'å¾…ç¶“è¾¦';
                            updateData.handler_id = handlerUser ? handlerUser.id : null;
                        }

                        if (treatAsSave) {
                            const modificationReason = document.getElementById('modification-reason').value;
                            const form = document.getElementById('edit-request-form');
                            const formData = new FormData(form);
                            const newItems = currentRequest.items.map((item, index) => {
                                const updated = { ...item };
                                // å…è¨±ï¼šåŸå› /èªªæ˜
                                const reasonVal = formData.get(`reason_${index}`);
                                if (reasonVal !== null) updated.reason = (reasonVal || '').toString();
                                const descVal = formData.get(`description_${index}`);
                                if (descVal !== null) updated.description = (descVal || '').toString();
                                // å…è¨±ï¼šéœ€æ±‚èª²å®¤
                                const demandDept = formData.get(`demand_department_${index}`);
                                if (demandDept !== null) updated.demand_department = demandDept || '';
                                // å…è¨±ï¼šç™¼ç¥¨é–‹ç«‹
                                const invoice = formData.get(`invoice_${index}`);
                                const customInvoice = formData.get(`custom_invoice_${index}`);
                                if (invoice !== null) {
                                    updated.invoice = invoice || '';
                                    updated.custom_invoice = invoice === 'å…¶ä»–' ? (customInvoice || '') : '';
                                }
                                // å…è¨±ï¼šå» å•†
                                const vendor = formData.get(`vendor_${index}`);
                                if (vendor !== null) updated.vendor = vendor || '';
                                // å…è¨±ï¼šåƒ¹æ ¼/æ•¸é‡/å–®ä½/é‹è²»/æŠ˜æ‰£
                                updated.price = parseFloat(formData.get(`price_${index}`)) || 0;
                                updated.quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                                updated.unit = formData.get(`unit_${index}`) || '';
                                updated.freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                                updated.discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                                // å…è¨±ï¼šå ±å»¢/è²¡ç”¢ç·¨è™Ÿï¼ˆåƒ…åŸå› ç‚ºå ±å»¢æ™‚ï¼›å¦å‰‡è‡ªå‹•æ¸…ç©ºï¼‰
                                if (updated.reason === 'å ±å»¢') {
                                    updated.is_scrap_work_order = !!formData.get(`scrap_${index}`);
                                    updated.work_order_number = updated.is_scrap_work_order ? (formData.get(`asset_number_${index}`) || '') : '';
                                } else {
                                    updated.is_scrap_work_order = false;
                                    updated.work_order_number = '';
                                }
                                // ä¸å…è¨±ä¿®æ”¹ï¼šå“å
                                return updated;
                            });
                            const newTotalAmount = Math.round(newItems.reduce((sum, item) => sum + (item.price * item.quantity) + (item.freight || 0) + (item.discount || 0), 0));
                            // å»ºç«‹è®Šæ›´æ˜ç´°ä¾›å¾ŒçºŒæŸ¥é–±æ¯”å°
                            const fieldsToCompare = ['reason','description','demand_department','invoice','custom_invoice','vendor','price','quantity','unit','freight','discount','is_scrap_work_order','work_order_number'];
                            const changesLog = [];
                            for (let i = 0; i < currentRequest.items.length; i++) {
                                const before = currentRequest.items[i] || {};
                                const after = newItems[i] || {};
                                const itemChanges = [];
                                fieldsToCompare.forEach(field => {
                                    const a = (before[field] === undefined || before[field] === null) ? '' : before[field];
                                    const b = (after[field] === undefined || after[field] === null) ? '' : after[field];
                                    if (String(a) !== String(b)) {
                                        itemChanges.push({ field, from: a, to: b });
                                    }
                                });
                                if (itemChanges.length > 0) {
                                    changesLog.push({ item_id: before.id, name: before.name, changes: itemChanges });
                                }
                            }
                            
                            const newHistoryEntry = {
                                user: state.currentUser.name,
                                role: state.currentUser.role,
                                date: new Date().toISOString(),
                                reason: modificationReason,
                                changes: changesLog
                            };
                            
                            updateData.items = newItems;
                            updateData.total_amount = newTotalAmount;
                            updateData.modification_history = [...(currentRequest.modification_history || []), newHistoryEntry];
                        }
                        
                        let notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${currentRequest.id} å·²ç”± ${state.currentUser.name} æ ¸å‡†ã€‚`;
                        if (isFinal) {
                            notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${currentRequest.id} å·²å…¨æ•¸ç°½æ ¸å®Œæˆï¼`;
                        }
                        
                        await supabase.from('notifications').insert({
                            user_id: currentRequest.applicant_id,
                            request_id: currentRequest.id,
                            message: notificationMessage,
                            is_read: false
                        });
                        if (isFinal && updateData.handler_id) {
                            await supabase.from('notifications').insert({
                                user_id: updateData.handler_id,
                                request_id: currentRequest.id,
                                message: `æ‚¨è¢«æŒ‡æ´¾ç¶“è¾¦ç”³è«‹å–® ${currentRequest.id}ï¼Œè«‹å„˜é€Ÿè™•ç†ã€‚`,
                                is_read: false
                            });
                        }

                        const { data: updatedRequest, error } = await supabase.from('requests').update(updateData).eq('id', currentRequest.id).select().single();
                        if (error) throw error;

                        const newRequests = state.requests.map(r => r.id === updatedRequest.id ? updatedRequest : r);
                        getFilteredRequests.resetCache();
                        
                        showMessage('ç”³è«‹å–®å·²æ ¸å‡†');
                        // å›åˆ°ç‰¹åˆ¥æ¡è³¼å–®åˆ—è¡¨ç•«é¢
                        updateState({ view: 'dashboard', loading: false, requests: newRequests });
                        closeModal(); // è‹¥æ˜¯å¾ç¢ºèªè¦–çª—ä¾†çš„ï¼Œé †æ‰‹é—œé–‰
                    }
                } catch (err) {
                    console.error("æ ¸å‡†å¤±æ•—:", err);
                    showMessage('æ ¸å‡†å¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'reject') {
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">é€€å›ç”³è«‹</h3>
                    <label for="rejection-reason" class="block text-sm font-medium text-gray-700">é€€å›ç†ç”±ï¼š</label>
                    <textarea id="rejection-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">å–æ¶ˆ</button>
                        <button data-action="confirm-reject-previous" class="px-4 py-2 rounded-md font-semibold text-sm bg-yellow-500 text-white">é€€å›ä¸Šä¸€å±¤</button>
                        <button data-action="confirm-reject-all" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">æ•´ç­†é€€å–®</button>
                    </div>`);
            } else if (action === 'close-request') {
                updateState({ loading: true });
                try {
                    const req = state.selectedRequest;
                    const newHistoryEntry = {
                        user: state.currentUser.name,
                        role: state.currentUser.role,
                        date: new Date().toISOString(),
                        reason: 'çµæ¡ˆ',
                        action: 'closed'
                    };
                    const patch = {
                        closed_status: 'çµæ¡ˆ',
                        modification_history: [...(req.modification_history || []), newHistoryEntry]
                    };
                    const { data, error } = await supabase.from('requests').update(patch).eq('id', req.id).select().single();
                    if (error) throw error;
                    
                    showMessage('ç”³è«‹å–®å·²çµæ¡ˆ');
                    updateState({ selectedRequest: data, loading: false });
                } catch (err) {
                    showMessage('çµæ¡ˆå¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'mark-handled') {
                const req = state.selectedRequest;
                if (!req) return;
                const isHandler = state.currentUser.id === req.handler_id;
                const isPurchasing = state.currentUser.role === 'æ¡è³¼' || state.currentUser.role === 'æ¡è³¼ä¸»ç®¡' || state.currentUser.is_admin;
                const effectiveHandlerStatus = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                if (req.status !== 'å·²æ ¸å‡†' || effectiveHandlerStatus !== 'å¾…ç¶“è¾¦') {
                    showMessage('ç›®å‰ç‹€æ…‹ä¸å¯ç¶“è¾¦ã€‚', 'error');
                    return;
                }
                if (!isHandler && !isPurchasing) {
                    showMessage('åƒ…è¢«æŒ‡æ´¾çš„ç¶“è¾¦æˆ–æ¡è³¼/ç®¡ç†å“¡å¯åŸ·è¡Œç¶“è¾¦', 'error');
                    return;
                }

                // é˜²å‘†ï¼šå¦‚è¡¨å–®æœ‰æœªå„²å­˜è®Šæ›´ï¼Œæç¤ºæ˜¯å¦å…ˆå„²å­˜å†ç¶“è¾¦
                const form = document.getElementById('edit-request-form');
                let hasChanges = false;
                if (form) {
                    const formData = new FormData(form);
                    for (let index = 0; index < (req.items || []).length; index++) {
                        const item = req.items[index];
                        const newReason = (formData.get(`reason_${index}`) || '').toString();
                        const newDescription = (formData.get(`description_${index}`) || '').toString();
                        const demandDept = formData.get(`demand_department_${index}`) || '';
                        const invoice = formData.get(`invoice_${index}`) || '';
                        const customInvoice = formData.get(`custom_invoice_${index}`) || '';
                        const vendor = formData.get(`vendor_${index}`) || '';
                        const price = parseFloat(formData.get(`price_${index}`)) || 0;
                        const quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                        const unit = formData.get(`unit_${index}`) || '';
                        const freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                        const discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                        let newScrap = item.is_scrap_work_order;
                        let newAsset = item.work_order_number || '';
                        if (newReason === 'å ±å»¢') {
                            newScrap = !!formData.get(`scrap_${index}`);
                            newAsset = newScrap ? (formData.get(`asset_number_${index}`) || '') : '';
                        } else {
                            newScrap = false;
                            newAsset = '';
                        }
                        if (
                            (item.reason || '') !== newReason ||
                            (item.description || '') !== newDescription ||
                            (item.demand_department || '') !== demandDept ||
                            (item.invoice || '') !== invoice ||
                            (item.custom_invoice || '') !== (invoice === 'å…¶ä»–' ? customInvoice : '') ||
                            (item.vendor || '') !== vendor ||
                            Number(item.price || 0) !== price ||
                            Number(item.quantity || 0) !== quantity ||
                            (item.unit || '') !== unit ||
                            Number(item.freight || 0) !== freight ||
                            Number(item.discount || 0) !== discount ||
                            Boolean(item.is_scrap_work_order) !== Boolean(newScrap) ||
                            (item.work_order_number || '') !== newAsset
                        ) { hasChanges = true; break; }
                    }
                }

                if (hasChanges) {
                    renderModal(`
                        <h3 class="text-lg font-bold mb-4">è«‹ç¢ºèªæ˜¯å¦é€²è¡Œå–®æ“šè³‡æ–™ä¿®æ”¹</h3>
                        <p class="mb-6 text-sm text-gray-700">åµæ¸¬åˆ°æ‚¨å°å–®æ“šå…§å®¹åšäº†è®Šæ›´ï¼Œæ˜¯å¦ä¸€ä½µå„²å­˜ä¿®æ”¹å¾Œå†ç¶“è¾¦ï¼Ÿ</p>
                        <div class="flex justify-end space-x-3">
                            <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                            <button data-action="modal-confirm-handle-without-save" data-request-id="${req.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">å¦ï¼Œç›´æ¥ç¶“è¾¦</button>
                            <button data-action="modal-confirm-handle-with-save" data-request-id="${req.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">æ˜¯ï¼Œå„²å­˜ä¿®æ”¹å¾Œç¶“è¾¦</button>
                        </div>
                    `, { size: 'half' });
                    return;
                }

                // ç„¡è®Šæ›´ï¼Œç›´æ¥ç¶“è¾¦
                updateState({ loading: true });
                try {
                    const comment = (document.getElementById('handler-comment')?.value || '').trim();
                    const newHistoryEntry = {
                        user: state.currentUser.name,
                        userId: state.currentUser.id,
                        role: state.currentUser.role,
                        date: new Date().toISOString(),
                        reason: 'ç¶“è¾¦å®Œæˆ',
                        action: 'handled',
                        comment
                    };
                    const patch = {
                        handler_status: 'å·²ç¶“è¾¦',
                        modification_history: [...(req.modification_history || []), newHistoryEntry]
                    };
                    const { data, error } = await supabase.from('requests').update(patch).eq('id', req.id).select().single();
                    if (error) throw error;

                    // é€šçŸ¥ç”³è«‹äººèˆ‡ç¶“è¾¦ç¾¤çµ„
                    const notifs = [];
                    notifs.push({ user_id: req.applicant_id, request_id: req.id, message: `æ‚¨çš„ç”³è«‹å–® ${req.id} å·²ç”± ${state.currentUser.name} å®Œæˆç¶“è¾¦ã€‚`, is_read: false });
                    const handlerUsers = Object.values(state.users).filter(u => u.is_handler);
                    handlerUsers.forEach(u => notifs.push({ user_id: u.id, request_id: req.id, message: `ç”³è«‹å–® ${req.id} å·²ç”± ${state.currentUser.name} å®Œæˆç¶“è¾¦ã€‚`, is_read: false }));
                    if (notifs.length) { await supabase.from('notifications').insert(notifs); }

                    const newRequests = state.requests.map(r => r.id === req.id ? { ...r, handler_status: 'å·²ç¶“è¾¦', modification_history: patch.modification_history } : r);
                    showMessage('å·²å®Œæˆç¶“è¾¦');
                    updateState({ selectedRequest: data, requests: newRequests, loading: false });
                    closeModal();
                } catch (err) {
                    showMessage('ç¶“è¾¦å¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'print-request') {
                const requestId = state.selectedRequest?.id;
                if (requestId) {
                    printRequest(requestId);
                } else {
                    showMessage('æ‰¾ä¸åˆ°è¦åˆ—å°çš„ç”³è«‹å–®ã€‚', 'error');
                }
            } else if (action === 'handler-save-changes') {
                const req = state.selectedRequest;
                if (!req) return;
                if ((req.handler_status || 'æœªç¶“è¾¦') !== 'å¾…ç¶“è¾¦') { showMessage('åƒ…å¾…ç¶“è¾¦ç‹€æ…‹å¯ä¿®æ”¹ã€‚', 'error'); return; }
                if (state.currentUser.id !== req.handler_id && !state.currentUser.is_admin && !['æ¡è³¼','æ¡è³¼ä¸»ç®¡'].includes(state.currentUser.role)) { showMessage('æ‚¨ç„¡æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œã€‚', 'error'); return; }
                const reason = (document.getElementById('handler-modification-reason')?.value || '').trim();
                if (!reason) { showMessage('è«‹å¡«å¯«ç¶“è¾¦ä¿®æ”¹åŸå› ã€‚', 'error'); return; }
                const comment = (document.getElementById('handler-comment')?.value || '').trim();
                updateState({ loading: true });
                try {
                    const form = document.getElementById('edit-request-form');
                    const formData = new FormData(form);
                    const newItems = (req.items || []).map((item, index) => {
                        const updated = { ...item };
                        const reasonVal = formData.get(`reason_${index}`);
                        if (reasonVal !== null) updated.reason = (reasonVal || '').toString();
                        const descVal = formData.get(`description_${index}`);
                        if (descVal !== null) updated.description = (descVal || '').toString();
                        const demandDept = formData.get(`demand_department_${index}`);
                        if (demandDept !== null) updated.demand_department = demandDept || '';
                        const invoice = formData.get(`invoice_${index}`);
                        const customInvoice = formData.get(`custom_invoice_${index}`);
                        if (invoice !== null) {
                            updated.invoice = invoice || '';
                            updated.custom_invoice = invoice === 'å…¶ä»–' ? (customInvoice || '') : '';
                        }
                        const vendor = formData.get(`vendor_${index}`);
                        if (vendor !== null) updated.vendor = vendor || '';
                        updated.price = parseFloat(formData.get(`price_${index}`)) || 0;
                        updated.quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                        updated.unit = formData.get(`unit_${index}`) || '';
                        updated.freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                        updated.discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                        if ((updated.reason || '') === 'å ±å»¢') {
                            updated.is_scrap_work_order = !!formData.get(`scrap_${index}`);
                            updated.work_order_number = updated.is_scrap_work_order ? (formData.get(`asset_number_${index}`) || '') : '';
                        } else {
                            updated.is_scrap_work_order = false;
                            updated.work_order_number = '';
                        }
                        return updated;
                    });
                    const newTotalAmount = Math.round(newItems.reduce((sum, item) => sum + (item.price * item.quantity) + (item.freight || 0) + (item.discount || 0), 0));
                    const fieldsToCompare = ['reason','description','demand_department','invoice','custom_invoice','vendor','price','quantity','unit','freight','discount','is_scrap_work_order','work_order_number'];
                    const changesLog = [];
                    for (let i = 0; i < (req.items || []).length; i++) {
                        const before = req.items[i] || {};
                        const after = newItems[i] || {};
                        const itemChanges = [];
                        fieldsToCompare.forEach(field => {
                            const a = (before[field] ?? '') + '';
                            const b = (after[field] ?? '') + '';
                            if (a !== b) itemChanges.push({ field, from: before[field] ?? '', to: after[field] ?? '' });
                        });
                        if (itemChanges.length) changesLog.push({ item_id: before.id, name: before.name, changes: itemChanges });
                    }
                    const newHistoryEntry = { 
                        user: state.currentUser.name, 
                        userId: state.currentUser.id,
                        role: state.currentUser.role, 
                        date: new Date().toISOString(), 
                        reason, 
                        action: 'handled_edit', 
                        comment, 
                        changes: changesLog 
                    };
                    const patch = { items: newItems, total_amount: newTotalAmount, handler_status: 'å·²ç¶“è¾¦', modification_history: [...(req.modification_history || []), newHistoryEntry] };
                    const { data, error } = await supabase.from('requests').update(patch).eq('id', req.id).select().single();
                    if (error) throw error;
                    // é€šçŸ¥ç”³è«‹äººèˆ‡ç¶“è¾¦ç¾¤çµ„
                    const notifs = [];
                    notifs.push({ user_id: req.applicant_id, request_id: req.id, message: `æ‚¨çš„ç”³è«‹å–® ${req.id} å·²ç”± ${state.currentUser.name} å®Œæˆç¶“è¾¦ã€‚`, is_read: false });
                    const handlerUsers = Object.values(state.users).filter(u => u.is_handler);
                    handlerUsers.forEach(u => notifs.push({ user_id: u.id, request_id: req.id, message: `ç”³è«‹å–® ${req.id} å·²ç”± ${state.currentUser.name} å®Œæˆç¶“è¾¦ã€‚`, is_read: false }));
                    if (notifs.length) { await supabase.from('notifications').insert(notifs); }
                    const newRequests = state.requests.map(r => r.id === req.id ? data : r);
                    showMessage('å·²å„²å­˜ç¶“è¾¦ä¿®æ”¹ä¸¦å®Œæˆç¶“è¾¦');
                    updateState({ selectedRequest: data, requests: newRequests, loading: false });
                } catch (err) {
                    showMessage('å„²å­˜å¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'modal-confirm-handle-with-save') {
                // è¦–åŒæŒ‰ä¸‹ã€Œå„²å­˜ä¿®æ”¹ä¸¦ç¶“è¾¦ã€
                const trigger = document.querySelector('[data-action="handler-save-changes"]');
                if (trigger) trigger.click();
            } else if (action === 'modal-confirm-handle-without-save') {
                // è¦–åŒæŒ‰ä¸‹ã€Œç¶“è¾¦ã€ä½†ä¸å„²å­˜ä¿®æ”¹
                const req = state.selectedRequest;
                if (!req) return;
                updateState({ loading: true });
                try {
                    const comment = (document.getElementById('handler-comment')?.value || '').trim();
                    const newHistoryEntry = { 
                        user: state.currentUser.name, 
                        userId: state.currentUser.id,
                        role: state.currentUser.role, 
                        date: new Date().toISOString(), 
                        reason: 'ç¶“è¾¦å®Œæˆ', 
                        action: 'handled', 
                        comment 
                    };
                    const patch = { handler_status: 'å·²ç¶“è¾¦', modification_history: [...(req.modification_history || []), newHistoryEntry] };
                    const { data, error } = await supabase.from('requests').update(patch).eq('id', req.id).select().single();
                    if (error) throw error;
                    const notifs = [];
                    notifs.push({ user_id: req.applicant_id, request_id: req.id, message: `æ‚¨çš„ç”³è«‹å–® ${req.id} å·²ç”± ${state.currentUser.name} å®Œæˆç¶“è¾¦ã€‚`, is_read: false });
                    const handlerUsers = Object.values(state.users).filter(u => u.is_handler);
                    handlerUsers.forEach(u => notifs.push({ user_id: u.id, request_id: req.id, message: `ç”³è«‹å–® ${req.id} å·²ç”± ${state.currentUser.name} å®Œæˆç¶“è¾¦ã€‚`, is_read: false }));
                    if (notifs.length) { await supabase.from('notifications').insert(notifs); }
                    const newRequests = state.requests.map(r => r.id === req.id ? { ...r, handler_status: 'å·²ç¶“è¾¦', modification_history: patch.modification_history } : r);
                    showMessage('å·²å®Œæˆç¶“è¾¦');
                    updateState({ selectedRequest: data, requests: newRequests, loading: false });
                    closeModal();
                } catch (err) {
                    showMessage('ç¶“è¾¦å¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'handler-reject-options') {
                const req = state.selectedRequest;
                if (!req) return;
                if (state.currentUser.id !== req.handler_id && !state.currentUser.is_admin && !['æ¡è³¼','æ¡è³¼ä¸»ç®¡'].includes(state.currentUser.role)) { showMessage('æ‚¨ç„¡æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œã€‚', 'error'); return; }
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">ç¶“è¾¦é€€å–®</h3>
                    <label for="handler-reject-reason" class="block text-sm font-medium text-gray-700">é€€å–®ç†ç”±ï¼š</label>
                    <textarea id="handler-reject-reason" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">å–æ¶ˆ</button>
                        <button data-action="confirm-handler-reject-all" data-id="${req.id}" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">æ•´ç­†é€€å–®</button>
                    </div>`);
            }
        });

        document.getElementById('productManagement-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button, th');
            if (!button) return;
            const action = button.dataset.action;
            const productId = button.dataset.id;

            if (action === 'sort-product') {
                const key = button.dataset.sortKey;
                if (state.local.productSortKey === key) {
                    state.local.productSortDirection = state.local.productSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    state.local.productSortKey = key;
                    state.local.productSortDirection = 'asc';
                }
                render();
            } else if (action === 'add-product') {
                state.editingProduct = null;
                updateState({ view: 'productForm' });
            } else if (action === 'edit-product') {
                const product = state.allProducts.find(p => p.id == productId);
                state.editingProduct = product;
                updateState({ view: 'productForm' });
            } else if (action === 'delete-product') {
                const productName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">ç¢ºèªåˆªé™¤</h3>
                    <p class="mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤å•†å“ "${productName}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button data-id="${productId}" data-action="confirm-delete-product" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">ç¢ºèªåˆªé™¤</button>
                    </div>
                `);
            } else if (action === 'switch-product-category') {
                updateState({ local: { ...state.local, activeProductManagementCategory: button.dataset.category, productManagementSearchTerm: '' } });
            } else if (action === 'search-product') {
                const searchTerm = document.getElementById('product-search-input').value;
                const searchAll = document.getElementById('product-management-search-all-checkbox').checked;
                updateState({ local: { ...state.local, productManagementSearchTerm: searchTerm, productManagementSearchAll: searchAll } });
            }
        });

        document.getElementById('productManagement-view').addEventListener('change', (e) => {
            if (e.target.id === 'product-management-search-all-checkbox') {
                updateState({ local: { ...state.local, productManagementSearchAll: e.target.checked } });
            }
        });

        document.getElementById('productForm-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'save-product') {
                const form = document.getElementById('product-form');
                if (!form.reportValidity()) return;

                const formData = new FormData(form);
                const productData = Object.fromEntries(formData.entries());
                productData.price = parseFloat(productData.price) || 0;
                
                updateState({ loading: true });
                // ä¾›å¾ŒçºŒæœ¬åœ°ç‹€æ…‹æ›´æ–°ä½¿ç”¨çš„è®Šæ›´å¿«ç…§ï¼ˆåªåœ¨å„²å­˜ä¿®æ”¹æ™‚å¡«å…¥ï¼‰
                let savedPatch = null;
                try {
                    const { data: savedProduct, error } = await supabase
                        .from('products')
                        .upsert(productData, { onConflict: 'id' })
                        .select()
                        .single();

                    if (error) {
                        if (error.code === '23505') { 
                            throw new Error(`å•†å“ç·¨è™Ÿ "${productData.id}" å·²å­˜åœ¨ã€‚`);
                        }
                        throw error;
                    }

                    const productIndex = state.allProducts.findIndex(p => p.id === savedProduct.id);
                    if (productIndex > -1) {
                        state.allProducts[productIndex] = savedProduct;
                    } else {
                        state.allProducts.push(savedProduct);
                    }

                    const productsData = {};
                    state.allProducts.forEach(product => {
                        const category = product.category;
                        if (!productsData[category]) productsData[category] = [];
                        productsData[category].push(product);
                    });
                    
                    showMessage('å•†å“å·²å„²å­˜');
                    updateState({ view: 'productManagement', loading: false, products: productsData });

                } catch (err) {
                    showMessage('å„²å­˜å¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'upload-image') {
                const fileInput = document.getElementById('image-upload-input');
                const file = fileInput.files[0];
                if (!file) {
                    showMessage('è«‹å…ˆé¸æ“‡ä¸€å€‹åœ–ç‰‡æª”æ¡ˆã€‚', 'error');
                    return;
                }

                const uploadButton = e.target;
                uploadButton.textContent = 'ä¸Šå‚³ä¸­...';
                uploadButton.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const { data, error } = await supabase.functions.invoke('upload-product-image', {
                        body: formData,
                    });

                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    const imageId = data.fileId;
                    
                    const hiddenImageInput = document.querySelector('#product-form input[name="image"]');
                    hiddenImageInput.value = imageId;

                    const preview = document.getElementById('product-form-image-preview');
                    preview.src = `https://drive.google.com/thumbnail?id=${imageId}`;
                    
                    showMessage('åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼è«‹è¨˜å¾—é»æ“Šã€Œå„²å­˜ã€ä»¥å®Œæˆæ›´æ–°ã€‚');
                    uploadButton.textContent = 'ä¸Šå‚³å®Œæˆ';

                } catch (err) {
                    console.error("åœ–ç‰‡ä¸Šå‚³å¤±æ•—:", err);
                    showMessage(`åœ–ç‰‡ä¸Šå‚³å¤±æ•—: ${err.message}`, 'error');
                    uploadButton.textContent = 'ä¸Šå‚³åœ–ç‰‡';
                    uploadButton.disabled = false;
                }
            }
        });
        
        document.getElementById('productForm-view').addEventListener('change', (e) => {
            const target = e.target;
            if (target.id === 'image-upload-input') {
                const file = target.files[0];
                const filenameSpan = document.getElementById('image-upload-filename');
                const uploadButton = document.getElementById('image-upload-button');
                if (file) {
                    filenameSpan.textContent = file.name;
                    uploadButton.disabled = false;
                    uploadButton.textContent = 'ä¸Šå‚³åœ–ç‰‡';
                } else {
                    filenameSpan.textContent = 'å°šæœªé¸æ“‡æª”æ¡ˆ';
                    uploadButton.disabled = true;
                }
            }
        });

        document.getElementById('personalForms-view').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const tab = button.dataset.tab;
            if(tab) {
                updateState({ local: { ...state.local, personalForms: { ...state.local.personalForms, activeTab: tab } } });
            }
        });
        
        document.getElementById('personalForms-view').addEventListener('input', (e) => {
            const target = e.target;
            if (target.matches('.personal-forms-filter')) {
                clearTimeout(window.personalFormsSearchTimeout);
                window.personalFormsSearchTimeout = setTimeout(() => {
                    const filterType = target.dataset.filterType;
                    const activeTab = state.local.personalForms.activeTab;
                    
                    const updatedFilters = {
                        ...state.local.personalForms,
                        [activeTab]: {
                            ...state.local.personalForms[activeTab],
                            [filterType]: target.value
                        }
                    };
                    updateState({ local: { ...state.local, personalForms: updatedFilters } });
                }, 300);
            }
        });

        document.getElementById('userManagement-view').addEventListener('change', (e) => {
            if (e.target.id === 'user-dept-filter') {
                updateState({ local: { ...state.local, userManagementFilters: { ...state.local.userManagementFilters, department: e.target.value } } });
            }
        });

        document.getElementById('userManagement-view').addEventListener('keyup', (e) => {
            if (e.target.id === 'user-search-input') {
                clearTimeout(window.userSearchTimeout);
                window.userSearchTimeout = setTimeout(() => {
                    updateState({ local: { ...state.local, userManagementFilters: { ...state.local.userManagementFilters, searchTerm: e.target.value } } });
                }, 300);
            }
        });

        document.getElementById('userManagement-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const userId = button.dataset.id;

            if (action === 'add-user') {
                updateState({ editingUser: null, view: 'userForm' });
            } else if (action === 'edit-user') {
                const user = state.users[userId];
                updateState({ editingUser: user, view: 'userForm' });
            } else if (action === 'reset-password') {
                const userName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">é‡è¨­ä½¿ç”¨è€…å¯†ç¢¼</h3>
                    <p class="mb-4">ç‚ºä½¿ç”¨è€… <strong>${userName}</strong> è¨­å®šæ–°å¯†ç¢¼ï¼š</p>
                    <div class="space-y-4">
                        <div>
                            <label for="reset-new-password" class="block text-sm font-medium text-gray-700">æ–°å¯†ç¢¼</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="password" id="reset-new-password" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰">
                                <button type="button" id="reset-show-password-btn" class="px-3 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-md">é¡¯ç¤º</button>
                            </div>
                        </div>
                        <div>
                            <label for="reset-confirm-password" class="block text-sm font-medium text-gray-700">ç¢ºèªæ–°å¯†ç¢¼</label>
                            <input type="password" id="reset-confirm-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button data-user-id="${userId}" data-action="confirm-reset-password" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white hover:bg-blue-700">ç¢ºèªé‡è¨­</button>
                    </div>
                `);
            } else if (action === 'delete-user') {
                const userName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">ç¢ºèªåˆªé™¤ä½¿ç”¨è€…</h3>
                    <p class="mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤ä½¿ç”¨è€… "${userName}" å—ï¼Ÿæ­¤æ“ä½œå°‡æœƒå¾ç³»çµ±ä¸­æ°¸ä¹…ç§»é™¤è©²ä½¿ç”¨è€…åŠå…¶èªè­‰è³‡æ–™ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button data-id="${userId}" data-action="confirm-delete-user" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">ç¢ºèªåˆªé™¤</button>
                    </div>
                `);
            } else if (action === 'toggle-user-enabled') {
                const currentStatus = button.dataset.enabled === 'true';
                const newStatus = !currentStatus;
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .update({ is_enabled: newStatus })
                        .eq('id', userId)
                        .select()
                        .single();
                    if (error) throw error;
                    state.users[userId] = data;
                    showMessage(`ä½¿ç”¨è€…ç‹€æ…‹å·²æ›´æ–°ç‚º ${newStatus ? 'å•Ÿç”¨' : 'åœç”¨'}`);
                    render();
                } catch (err) {
                    showMessage(`æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹å¤±æ•—: ${err.message}`, 'error');
                }
            }
        });

        // éƒ¨é–€ç®¡ç†äº‹ä»¶: æœå°‹ã€æŒ‰éˆ•
        document.getElementById('departmentManagement-view').addEventListener('keyup', (e) => {
            if (e.target.id === 'department-search-input') {
                updateState({ local: { ...state.local, departmentManagementSearchTerm: e.target.value } });
            }
        });
        document.getElementById('departmentManagement-view').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.dataset.action;
            if (action === 'add-department') {
                updateState({ editingDepartment: null, view: 'departmentForm' });
                return;
            }
            if (action === 'edit-department') {
                const deptName = btn.dataset.dept;
                const director_threshold = state.departments[deptName] ?? null;
                updateState({ editingDepartment: { department: deptName, director_threshold }, view: 'departmentForm' });
                return;
            }
            if (action === 'delete-department') {
                const deptName = btn.dataset.dept;
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤éƒ¨é–€ã€Œ${deptName}ã€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) return;
                try {
                    updateState({ loading: true });
                    const { error } = await supabase.from('departments').delete().eq('department', deptName);
                    if (error) throw error;
                    const newDepartments = { ...state.departments };
                    delete newDepartments[deptName];
                    updateState({ departments: newDepartments, loading: false });
                    showMessage('å·²åˆªé™¤éƒ¨é–€ã€‚', 'success');
                    renderDepartmentManagement();
                } catch (err) {
                    console.error(err);
                    updateState({ loading: false });
                    showMessage('åˆªé™¤éƒ¨é–€å¤±æ•—ï¼š' + (err.message || err), 'error');
                }
            }
        });

        // éƒ¨é–€è¡¨å–®äº‹ä»¶
        document.getElementById('departmentForm-view').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.dataset.action;
            if (action === 'save-department') {
                const form = document.getElementById('department-form');
                const formData = new FormData(form);
                const department = (formData.get('department') || '').trim();
                const director_threshold_raw = formData.get('director_threshold');
                const director_threshold = director_threshold_raw === '' ? null : Number(director_threshold_raw);
                if (!department) {
                    showMessage('è«‹è¼¸å…¥éƒ¨é–€åç¨±ã€‚', 'error');
                    return;
                }
                try {
                    updateState({ loading: true });
                    const payload = { department, director_threshold };
                    const { error } = await supabase.from('departments').upsert(payload, { onConflict: 'department' });
                    if (error) throw error;
                    const newDepartments = { ...state.departments, [department]: director_threshold };
                    updateState({ departments: newDepartments, loading: false, view: 'departmentManagement', editingDepartment: null });
                    showMessage('éƒ¨é–€å·²å„²å­˜ã€‚', 'success');
                } catch (err) {
                    console.error(err);
                    updateState({ loading: false });
                    showMessage('å„²å­˜å¤±æ•—ï¼š' + (err.message || err), 'error');
                }
            }
        });

        document.getElementById('userForm-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'save-user') {
                const form = document.getElementById('user-form');
                if (!form.reportValidity()) return;

                const formData = new FormData(form);
                const isEditing = !!state.editingUser;

                const userData = {
                    ...Object.fromEntries(formData.entries()),
                    is_admin: form.elements.is_admin.checked,
                    is_department_head: form.elements.is_department_head.checked,
                    is_enabled: form.elements.is_enabled.checked,
                    is_handler: form.elements.is_handler ? form.elements.is_handler.checked : false,
                };
                
                if (userData.manager_id === '') userData.manager_id = null;
                if (userData.manager_id2 === '') userData.manager_id2 = null;
                if (userData.manager_id3 === '') userData.manager_id3 = null;
                if (userData.department === '') userData.department = null;
                if (userData.demand_department === '') userData.demand_department = null;
                if (userData.default_invoice === '') userData.default_invoice = null;

                // è™•ç†å¯†ç¢¼æ¬„ä½
                const shouldUpdatePassword = isEditing && userData.new_password;
                if (shouldUpdatePassword && userData.new_password.length < 6) {
                    showMessage('æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½å­—å…ƒã€‚', 'error');
                    return;
                }
                
                const newPassword = userData.new_password;
                delete userData.new_password; // ç§»é™¤æ–°å¯†ç¢¼æ¬„ä½ï¼Œé¿å…å‚³é€åˆ°å¾Œç«¯

                updateState({ loading: true });

                try {
                    if (isEditing) {
                        const userId = state.editingUser.id;
                        
                        // æ›´æ–°ä½¿ç”¨è€…è³‡æ–™ï¼ˆä¸åŒ…å«å¯†ç¢¼ï¼‰
                        const { data, error } = await supabase.functions.invoke('update-user-admin', {
                            body: { user_id: userId, userData: userData }
                        });
                        if (error) throw error;
                        if (data.error) throw new Error(data.error);

                        // å¦‚æœéœ€è¦æ›´æ–°å¯†ç¢¼ï¼Œå–®ç¨è™•ç†
                        if (shouldUpdatePassword) {
                            const { data: passwordData, error: passwordError } = await supabase.functions.invoke('reset-user-password', {
                                body: { user_id: userId, new_password: newPassword }
                            });
                            if (passwordError) throw passwordError;
                            if (passwordData.error) throw new Error(passwordData.error);
                        }

                        state.users[userId] = data.user;
                        showMessage(shouldUpdatePassword ? 'ä½¿ç”¨è€…è³‡æ–™å’Œå¯†ç¢¼æ›´æ–°æˆåŠŸï¼' : 'ä½¿ç”¨è€…è³‡æ–™æ›´æ–°æˆåŠŸï¼');
                        updateState({ view: 'userManagement', loading: false, users: { ...state.users } });

                    } else {
                        const { password, ...profileData } = userData;
                        const { data, error: functionError } = await supabase.functions.invoke('create-user', {
                            body: {
                                email: userData.email,
                                password: password,
                                profileData: profileData
                            }
                        });

                        if (functionError) throw functionError;
                        if (data && data.error) throw new Error(data.error);
                        if (!data || !data.user) throw new Error('Edge Function å›å‚³äº†ç„¡æ•ˆçš„è³‡æ–™æ ¼å¼ã€‚');

                        const newUserProfile = data.user;
                        state.users[newUserProfile.id] = newUserProfile;
                        showMessage('ä½¿ç”¨è€…æ–°å¢æˆåŠŸï¼');
                        updateState({ view: 'userManagement', loading: false, users: { ...state.users } });
                    }
                } catch (err) {
                    console.error("å„²å­˜ä½¿ç”¨è€…å¤±æ•—:", err);
                    let detailedErrorMessage;

                    if (isEditing) {
                        detailedErrorMessage = `æ›´æ–°ä½¿ç”¨è€…è³‡æ–™å¤±æ•—.\n(åŸå§‹éŒ¯èª¤: ${err.message})`;
                        detailedErrorMessage += "\n\nè«‹æª¢æŸ¥å¾Œç«¯ 'update-user-admin' å‡½æ•¸çš„æ—¥èªŒã€‚";
                    } else {
                        detailedErrorMessage = `å¾Œç«¯å‡½æ•¸ 'create-user' åŸ·è¡Œå¤±æ•—.\n(åŸå§‹éŒ¯èª¤: ${err.message})`;
                        detailedErrorMessage += "\n\nè«‹æª¢æŸ¥æ‚¨ Supabase å°ˆæ¡ˆä¸­è©²å‡½æ•¸çš„æ—¥èªŒ(Logs)ä»¥å°‹æ‰¾æ ¹æœ¬åŸå› ã€‚";
                    }

                    showMessage(detailedErrorMessage, 'error');
                    updateState({ loading: false });
                }
            } else if (button.id === 'show-password-btn') {
                // åˆ‡æ›å¯†ç¢¼é¡¯ç¤º/éš±è—
                const passwordInput = button.previousElementSibling;
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    button.textContent = 'éš±è—';
                } else {
                    passwordInput.type = 'password';
                    button.textContent = 'é¡¯ç¤º';
                }
            }
        });

        document.getElementById('vendorManagement-view').addEventListener('keyup', (e) => {
            if (e.target.id === 'vendor-search-input') {
                clearTimeout(window.vendorSearchTimeout);
                window.vendorSearchTimeout = setTimeout(() => {
                    updateState({ local: { ...state.local, vendorManagementSearchTerm: e.target.value } });
                }, 300);
            }
        });

        document.getElementById('vendorManagement-view').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const vendorId = button.dataset.id;

            if (action === 'add-vendor') {
                updateState({ editingVendor: null, view: 'vendorForm' });
            } else if (action === 'edit-vendor') {
                const vendor = state.vendors.find(v => v.vendor_id === vendorId);
                updateState({ editingVendor: vendor, view: 'vendorForm' });
            } else if (action === 'delete-vendor') {
                const vendorName = button.dataset.name;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">ç¢ºèªåˆªé™¤å» å•†</h3>
                    <p class="mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤å» å•† "${vendorName}" å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button data-id="${vendorId}" data-action="confirm-delete-vendor" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">ç¢ºèªåˆªé™¤</button>
                    </div>
                `);
            }
        });

        document.getElementById('vendorForm-view').addEventListener('change', (e) => {
            const target = e.target;
            const form = document.getElementById('vendor-form');
            if (!form) return;

            if (target.id === 'copy-invoice-address') {
                form.elements.invoice_address.value = target.checked ? form.elements.address.value : '';
            } else if (target.id === 'copy-mailing-address') {
                form.elements.mailing_address.value = target.checked ? form.elements.address.value : '';
            }
        });

        document.getElementById('vendorForm-view').addEventListener('input', (e) => {
            const target = e.target;
            if (target.name === 'tax_id') {
                const errorEl = document.getElementById('tax-id-error');
                if (target.value && !validateTaxId(target.value)) {
                    errorEl.classList.remove('hidden');
                } else {
                    errorEl.classList.add('hidden');
                }
            }
        });

        document.getElementById('vendorForm-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || button.dataset.action !== 'save-vendor') return;

            const form = document.getElementById('vendor-form');
            if (!form.reportValidity()) return;

            const taxId = form.elements.tax_id.value;
            if (taxId && !validateTaxId(taxId)) {
                showMessage('çµ±ä¸€ç·¨è™Ÿæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œå†å„²å­˜ã€‚', 'error');
                return;
            }

            const formData = new FormData(form);
            const vendorData = Object.fromEntries(formData.entries());
            
            updateState({ loading: true });

            try {
                // ç¢ºèªä½¿ç”¨è€…æœ‰æ¬Šé™æ–°å¢/ä¿®æ”¹å» å•†
                if (!state.currentUser) {
                    throw new Error('è«‹å…ˆç™»å…¥');
                }
                
                // èª¿è©¦ï¼šè¼¸å‡ºç•¶å‰ä½¿ç”¨è€…è³‡è¨Š
                console.log('Current User Info:', {
                    name: state.currentUser.name,
                    role: state.currentUser.role,
                    is_admin: state.currentUser.is_admin,
                    id: state.currentUser.id
                });
                
                // æª¢æŸ¥ä½¿ç”¨è€…è§’è‰²æ¬Šé™ - æš«æ™‚æ”¾å¯¬æ¢ä»¶
                const allowedRoles = ['æ¡è³¼', 'æ¡è³¼ä¸»ç®¡', 'é™¢é•·'];
                const hasPermission = allowedRoles.includes(state.currentUser.role) || 
                                    state.currentUser.is_admin === true || 
                                    state.currentUser.role.includes('æ¡è³¼');
                
                console.log('Permission check:', {
                    userRole: state.currentUser.role,
                    isAdmin: state.currentUser.is_admin,
                    allowedRoles: allowedRoles,
                    hasPermission: hasPermission
                });
                
                if (!hasPermission) {
                    throw new Error(`æ‚¨çš„è§’è‰² "${state.currentUser.role}" æ²’æœ‰æ¬Šé™æ–°å¢æˆ–ä¿®æ”¹å» å•†è³‡æ–™ã€‚éœ€è¦ä»¥ä¸‹è§’è‰²ä¹‹ä¸€ï¼š${allowedRoles.join(', ')} æˆ–ç®¡ç†å“¡æ¬Šé™ã€‚`);
                }
                
                const { data, error } = await supabase.from('vendors').upsert(vendorData, { onConflict: 'vendor_id' }).select().single();
                if (error) {
                    console.error('Vendor upsert error:', error);
                    if (error.code === '23505') throw new Error(`å» å•†ä»£è™Ÿ "${vendorData.vendor_id}" å·²å­˜åœ¨ã€‚`);
                    if (error.message.includes('row-level security')) {
                        // è‡¨æ™‚è§£æ±ºæ–¹æ¡ˆï¼šæä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯å’Œå»ºè­°
                        console.error('RLS Policy Error:', error);
                        throw new Error(`è³‡æ–™åº«å®‰å…¨ç­–ç•¥é˜»æ­¢äº†æ­¤æ“ä½œã€‚
                        
å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆï¼š
1. è«‹ç¢ºèªæ‚¨çš„ Supabase vendors è³‡æ–™è¡¨ RLS ç­–ç•¥å…è¨±æ‚¨çš„ä½¿ç”¨è€…è§’è‰² "${state.currentUser.role}" é€²è¡Œ INSERT/UPDATE æ“ä½œ
2. æš«æ™‚é—œé–‰ vendors è³‡æ–™è¡¨çš„ RLSï¼šALTER TABLE vendors DISABLE ROW LEVEL SECURITY;
3. æˆ–å»ºç«‹å…è¨±ç­–ç•¥ï¼š
   CREATE POLICY "Allow all authenticated users" ON vendors FOR ALL TO authenticated USING (true) WITH CHECK (true);

éŒ¯èª¤è©³æƒ…: ${error.message}`);
                    }
                    throw error;
                }

                const index = state.vendors.findIndex(v => v.vendor_id === data.vendor_id);
                if (index > -1) {
                    state.vendors[index] = data;
                } else {
                    state.vendors.push(data);
                    state.vendors.sort((a, b) => a.vendor_id.localeCompare(b.vendor_id));
                }

                showMessage('å» å•†è³‡æ–™å·²å„²å­˜');
                updateState({ view: 'vendorManagement', loading: false, vendors: [...state.vendors] });
            } catch (err) {
                showMessage('å„²å­˜å» å•†å¤±æ•—: ' + err.message, 'error');
                updateState({ loading: false });
            }
        });

        // åˆ—å°ç®¡ç†äº‹ä»¶è™•ç†
        document.getElementById('printManagement-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'search-print-requests') {
                console.log('æœå°‹æŒ‰éˆ•è¢«é»æ“Š'); // èª¿è©¦è¨Šæ¯
                
                const startDate = document.getElementById('print-start-date').value;
                const endDate = document.getElementById('print-end-date').value;
                const status = document.getElementById('print-status-filter').value;
                const applicant = document.getElementById('print-applicant-filter').value;

                console.log('æœå°‹æ¢ä»¶:', { startDate, endDate, status, applicant }); // èª¿è©¦è¨Šæ¯

                if (!startDate || !endDate) {
                    showMessage('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸã€‚', 'error');
                    return;
                }

                console.log('å¯ç”¨çš„ç”³è«‹å–®ç¸½æ•¸:', state.requests.length); // èª¿è©¦è¨Šæ¯

                let filteredRequests = state.requests.filter(request => {
                    const requestDate = new Date(request.request_date);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999); // åŒ…å«çµæŸæ—¥æœŸç•¶å¤©

                    if (requestDate < start || requestDate > end) return false;
                    if (status && request.status !== status) return false;
                    if (applicant && request.applicant_id !== applicant) return false;

                    return true;
                });

                console.log('ç¯©é¸å¾Œçš„ç”³è«‹å–®æ•¸é‡:', filteredRequests.length); // èª¿è©¦è¨Šæ¯

                const tableBody = document.getElementById('print-results-table');
                const searchResults = document.getElementById('print-search-results');
                const printSelectedBtn = document.querySelector('[data-action="print-selected-requests"]');

                if (filteredRequests.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„ç”³è«‹å–®</td></tr>';
                    printSelectedBtn.disabled = true;
                } else {
                    tableBody.innerHTML = filteredRequests.map(request => {
                        const applicantName = state.users[request.applicant_id]?.name || 'æœªçŸ¥';
                        return `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input type="checkbox" class="request-checkbox rounded border-gray-300 text-blue-600" value="${request.id}">
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.id}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${applicantName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${getFormattedDateTime(request.request_date)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.department}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.status}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${Number(request.total_amount).toLocaleString()}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button data-action="print-single-request" data-id="${request.id}" class="text-blue-600 hover:text-blue-900">é è¦½åˆ—å°</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    printSelectedBtn.disabled = false;
                }

                searchResults.classList.remove('hidden');
            } else if (action === 'print-selected-requests') {
                const checkedBoxes = document.querySelectorAll('.request-checkbox:checked');
                if (checkedBoxes.length === 0) {
                    showMessage('è«‹è‡³å°‘é¸æ“‡ä¸€å¼µç”³è«‹å–®ã€‚', 'error');
                    return;
                }

                // æ‰¹é‡åˆ—å°é¸å–çš„ç”³è«‹å–® - å½™ç¸½åœ¨ä¸€å€‹è¦–çª—
                const selectedRequestIds = Array.from(checkedBoxes).map(cb => cb.value);
                printMultipleRequests(selectedRequestIds);
            } else if (action === 'print-single-request') {
                const requestId = button.dataset.id;
                printRequest(requestId);
            }
        });

        // å…¨é¸åŠŸèƒ½
        document.getElementById('printManagement-view').addEventListener('change', (e) => {
            if (e.target.id === 'select-all-print') {
                const checkboxes = document.querySelectorAll('.request-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            }
        });


    document.getElementById('modal-container').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            
            if(action === 'cancel-modal') {
                closeModal();
            } else if (button.id === 'reset-show-password-btn') {
                // åˆ‡æ›é‡è¨­å¯†ç¢¼çš„é¡¯ç¤º/éš±è—
                const passwordInput = document.getElementById('reset-new-password');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    button.textContent = 'éš±è—';
                } else {
                    passwordInput.type = 'password';
                    button.textContent = 'é¡¯ç¤º';
                }
                return; // é˜²æ­¢ç¹¼çºŒåŸ·è¡Œå…¶ä»–é‚è¼¯
            } else if (action === 'confirm-change-password') {
                const newPassword = document.getElementById('new-password').value;
                if (!newPassword || newPassword.length < 6) {
                    showMessage('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½å­—å…ƒã€‚', 'error');
                    return;
                }

                updateState({ loading: true });
                try {
                    const { data, error } = await supabase.functions.invoke('reset-user-password', {
                        body: { 
                            user_id: state.currentUser.id, 
                            new_password: newPassword
                        }
                    });
                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    showMessage('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼ä¸‹æ¬¡ç™»å…¥æ™‚è«‹ä½¿ç”¨æ–°å¯†ç¢¼ã€‚');
                    closeModal();
                } catch (err) {
                    showMessage('å¯†ç¢¼ä¿®æ”¹å¤±æ•—: ' + err.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            } else if (action === 'confirm-reset-password') {
                const newPassword = document.getElementById('reset-new-password').value;
                const confirmPassword = document.getElementById('reset-confirm-password').value;
                const targetUserId = button.dataset.userId;

                if (!newPassword || newPassword.length < 6) {
                    showMessage('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½å­—å…ƒã€‚', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showMessage('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚', 'error');
                    return;
                }

                updateState({ loading: true });
                try {
                    const { data, error } = await supabase.functions.invoke('reset-user-password', {
                        body: { 
                            user_id: targetUserId, 
                            new_password: newPassword
                        }
                    });
                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    showMessage('ä½¿ç”¨è€…å¯†ç¢¼é‡è¨­æˆåŠŸï¼');
                    closeModal();
                } catch (err) {
                    showMessage('å¯†ç¢¼é‡è¨­å¤±æ•—: ' + err.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            } else if (action === 'confirm-handler-reject-all') {
                const requestId = button.dataset.id;
                const reason = (document.getElementById('handler-reject-reason')?.value || '').trim();
                if (!reason) { showMessage('è«‹å¡«å¯«é€€å–®ç†ç”±ã€‚', 'error'); return; }
                updateState({ loading: true });
                try {
                    const req = state.requests.find(r => r.id === requestId);
                    if (!req) throw new Error('æ‰¾ä¸åˆ°å–®æ“š');
                    const patch = { status: 'å·²é€€å›', handler_status: null, handler_id: null };
                    const { data: updated, error } = await supabase.from('requests').update(patch).eq('id', requestId).select().single();
                    if (error) throw error;
                    try {
                        await supabase.from('notifications').insert({ user_id: req.applicant_id, request_id: requestId, message: `æ‚¨çš„ç”³è«‹å–® ${requestId} å·²è¢«ç¶“è¾¦é€€å–®ã€‚åŸå› ï¼š${reason}`, is_read: false });
                    } catch {}
                    const newRequests = state.requests.map(r => r.id === requestId ? updated : r);
                    closeModal();
                    showMessage('å·²é€€å–®');
                    getFilteredRequests.resetCache?.();
                    updateState({ requests: newRequests, selectedRequest: updated, loading: false });
                } catch (err) {
                    updateState({ loading: false });
                    showMessage('é€€å–®å¤±æ•—: ' + err.message, 'error');
                }
            } else if (action === 'confirm-reject-all' || action === 'confirm-reject-previous') {
                const reason = document.getElementById('rejection-reason').value;
                if (!reason.trim()) {
                    showMessage('è«‹å¡«å¯«é€€å›ç†ç”±ã€‚', 'error');
                    return;
                }

                updateState({ loading: true });
                try {
                    const currentRequest = state.selectedRequest;
                    const approvers = JSON.parse(JSON.stringify(currentRequest.approvers)); // Deep copy
                    const currentStepIndex = approvers.findIndex(a => a.status === 'pending');

                    if (currentStepIndex !== -1) {
                        let newStatus = 'å¾…å¯©æ ¸';
                        let notificationMessage = '';
                        
                        if (action === 'confirm-reject-previous' && currentStepIndex > 0) {
                            // Revert previous approver to pending
                            approvers[currentStepIndex - 1].status = 'pending';
                            approvers[currentStepIndex - 1].date = '';
                            approvers[currentStepIndex - 1].reason = '';
                            approvers[currentStepIndex - 1].comment = `ç”± ${state.currentUser.name} é€€å›ï¼Œè«‹é‡æ–°å¯©æ ¸ã€‚`;
                            
                            // Mark current approver's rejection in their comment field, but keep them pending for the future
                            approvers[currentStepIndex].comment = `æ–¼ ${getFormattedDateTime(new Date())} é€€å›ã€‚åŸå› : ${reason}`;

                            notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${currentRequest.id} å·²ç”± ${state.currentUser.name} é€€å›è‡³ä¸Šä¸€å±¤ç°½æ ¸ã€‚åŸå› ï¼š${reason}`;
                            
                            // Notify the previous approver as well
                             await supabase.from('notifications').insert({
                                user_id: approvers[currentStepIndex - 1].userId,
                                request_id: currentRequest.id,
                                message: `ç”³è«‹å–® ${currentRequest.id} å·²è¢«é€€å›çµ¦æ‚¨é‡æ–°ç°½æ ¸ã€‚åŸå› ï¼š${reason}`,
                                is_read: false
                            });

                        } else { // This handles 'confirm-reject-all' and 'confirm-reject-previous' on first step
                            approvers[currentStepIndex].status = 'rejected';
                            approvers[currentStepIndex].date = new Date().toISOString();
                            approvers[currentStepIndex].reason = reason;
                            newStatus = 'å·²é€€å›';
                            notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${currentRequest.id} å·²è¢« ${state.currentUser.name} æ•´ç­†é€€å›ã€‚åŸå› ï¼š${reason}`;
                        }
                        
                        const { data: updatedRequest, error } = await supabase
                            .from('requests')
                            .update({ approvers, status: newStatus })
                            .eq('id', currentRequest.id)
                            .select()
                            .single();
                        
                        if (error) throw error;

                        // Notify applicant
                        await supabase.from('notifications').insert({
                            user_id: currentRequest.applicant_id,
                            request_id: currentRequest.id,
                            message: notificationMessage,
                            is_read: false
                        });

                        const newRequests = state.requests.map(r => r.id === updatedRequest.id ? updatedRequest : r);
                        getFilteredRequests.resetCache();
                        
                        showMessage('ç”³è«‹å–®å·²é€€å›');
                        closeModal();
                        updateState({ view: 'dashboard', loading: false, requests: newRequests });

                    } else {
                         throw new Error("æ‰¾ä¸åˆ°å¾…ç°½æ ¸çš„æ­¥é©Ÿã€‚");
                    }
                } catch (err) {
                    console.error("é€€å›å¤±æ•—:", err);
                    showMessage('é€€å›å¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'confirm-delete-vendor') {
                const vendorId = button.dataset.id;
                try {
                    const { error } = await supabase.from('vendors').delete().eq('vendor_id', vendorId);
                    if (error) throw error;
                    
                    const newVendors = state.vendors.filter(v => v.vendor_id !== vendorId);
                    showMessage('å» å•†å·²æˆåŠŸåˆªé™¤');
                    closeModal();
                    updateState({ vendors: newVendors, view: 'vendorManagement' });
                } catch (err) {
                    console.error("åˆªé™¤å» å•†å¤±æ•—:", err);
                    showMessage('åˆªé™¤å» å•†å¤±æ•—: ' + err.message, 'error');
                    closeModal();
                }
            } else if (action === 'confirm-delete-product') {
                const productId = button.dataset.id;
                if (productId) {
                    try {
                        const { error } = await supabase.from('products').delete().eq('id', productId);
                        if(error) throw error;
                        
                        const newAllProducts = state.allProducts.filter(p => p.id != productId);
                        
                        const newProductsData = {};
                        newAllProducts.forEach(product => {
                            const category = product.category;
                            if (!newProductsData[category]) newProductsData[category] = [];
                            newProductsData[category].push(product);
                        });
                        
                        showMessage('å•†å“å·²æˆåŠŸåˆªé™¤');
                        closeModal();
                        
                        updateState({ allProducts: newAllProducts, products: newProductsData });

                    } catch (err) {
                        console.error("åˆªé™¤å•†å“å¤±æ•—:", err);
                        showMessage('åˆªé™¤å¤±æ•—: ' + err.message, 'error');
                        closeModal();
                    }
                }
            } else if (action === 'confirm-delete-user') {
                const userId = button.dataset.id;
                if (userId === state.currentUser.id) {
                    showMessage('ç„¡æ³•åˆªé™¤æ‚¨è‡ªå·±ã€‚', 'error');
                    return;
                }

                try {
                    const { data, error } = await supabase.functions.invoke('delete-user-admin', {
                        body: { user_id: userId }
                    });

                    if (error) throw error;
                    if (data.error) throw new Error(data.error);

                    delete state.users[userId];
                    showMessage('ä½¿ç”¨è€…å·²æˆåŠŸåˆªé™¤');
                    closeModal();
                    updateState({ users: { ...state.users } });

                } catch (err) {
                    console.error("åˆªé™¤ä½¿ç”¨è€…å¤±æ•—:", err);
                    showMessage('åˆªé™¤ä½¿ç”¨è€…å¤±æ•—: ' + err.message, 'error');
                    closeModal();
                }
            } else if (action === 'confirm-consolidation') {
                const selectedStatuses = [...document.querySelectorAll('.consolidation-status-checkbox:checked')].map(cb => cb.value);
                const selectedClosedStatuses = [...document.querySelectorAll('.consolidation-closed-checkbox:checked')].map(cb => cb.value);
                const selectedHandlerStatuses = [...document.querySelectorAll('.consolidation-handler-checkbox:checked')].map(cb => cb.value);
                if (selectedStatuses.length === 0 && selectedClosedStatuses.length === 0 && selectedHandlerStatuses.length === 0) {
                    showMessage('è«‹è‡³å°‘åœ¨ä»»ä¸€å€å¡Šé¸æ“‡ä¸€ç¨®æ¢ä»¶', 'error');
                    return;
                }

                let requestsToProcess;
                if (state.local.selectedRequestIds.size > 0) {
                    requestsToProcess = state.requests.filter(req => state.local.selectedRequestIds.has(req.id));
                } else {
                    requestsToProcess = getFilteredRequests();
                }

                const filteredByStatus = requestsToProcess.filter(req => {
                    const passApproval = selectedStatuses.length === 0 ? true : selectedStatuses.includes(req.status);
                    const passClosed = selectedClosedStatuses.length === 0 ? true : selectedClosedStatuses.includes(req.closed_status || 'æœªçµæ¡ˆ');
                    // ç¶“è¾¦ç‹€æ…‹å›æ¨ï¼šè‹¥å°šæœªæœ‰ handler_statusï¼Œä¸”ç°½æ ¸ç‚ºå·²æ ¸å‡†å‰‡è¦–ä½œå¾…ç¶“è¾¦ï¼›å¦å‰‡æœªç¶“è¾¦
                    const effectiveHandler = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                    const passHandler = selectedHandlerStatuses.length === 0 ? true : selectedHandlerStatuses.includes(effectiveHandler);
                    return passApproval && passClosed && passHandler;
                });

                if (filteredByStatus.length === 0) {
                    showMessage('æ²’æœ‰ç¬¦åˆé¸å–ç‹€æ…‹çš„è¨‚å–®å¯å½™æ•´', 'error');
                    closeModal();
                    return;
                }

                const consolidated = {};
                filteredByStatus.forEach(req => {
                    (req.items || []).forEach(item => {
                        const vendorId = item.vendor || 'æœªæŒ‡å®šå» å•†';
                        const vendorInfo = state.vendors.find(v => v.vendor_id === vendorId);
                        const vendorKey = vendorInfo ? (vendorInfo.short_name || vendorInfo.name) : vendorId;

                        if (!consolidated[vendorKey]) {
                            consolidated[vendorKey] = { items: {}, total: 0 };
                        }
                        const itemKey = item.id || item.name;
                                if (!consolidated[vendorKey].items[itemKey]) {
                                    // ä¿ç•™ä¾†æºç”³è«‹å–®çš„ç”³è«‹éƒ¨é–€ï¼Œè‹¥ item å·²æœ‰ department ä½¿ç”¨ item.department
                                    consolidated[vendorKey].items[itemKey] = { ...item, quantity: 0, subtotal: 0, department: req.department || (item.department || '') };
                                }
                        consolidated[vendorKey].items[itemKey].quantity += item.quantity;
                        consolidated[vendorKey].items[itemKey].subtotal += item.quantity * item.price;
                        consolidated[vendorKey].total += item.quantity * item.price;
                    });
                });
                
                state.local.consolidatedData = consolidated;

                let modalHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">å» å•†å½™ç¸½æ¡è³¼å–®</h2>
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center text-sm select-none">
                                <input id="consolidation-include-images" type="checkbox" class="mr-2" checked /> æ˜¯å¦é¡¯ç¤ºåœ–ç‰‡
                            </label>
                            <label class="inline-flex items-center text-sm select-none">
                                è¡Œé«˜(pt)
                                <input id="consolidation-row-height" type="number" min="10" max="200" step="1" value="80" class="ml-2 w-20 border rounded px-2 py-1" />
                            </label>
                            <button data-action="export-consolidation-xlsx" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">åŒ¯å‡º XLSX</button>
                            <button data-action="cancel-modal" class="ml-2 px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">é—œé–‰</button>
                        </div>
                    </div>
                `;

                Object.entries(consolidated).forEach(([vendor, data]) => {
                    modalHTML += `
                        <div class="mb-6 border rounded-lg p-4">
                            <h3 class="text-lg font-bold mb-2 bg-gray-100 p-2 rounded">${vendor} - ç¸½é‡‘é¡: ${data.total.toLocaleString()}</h3>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left">å“å</th>
                                        <th class="px-4 py-2 text-left">è¦æ ¼</th>
                                        <th class="px-4 py-2 text-right">å–®åƒ¹</th>
                                        <th class="px-4 py-2 text-right">ç¸½æ•¸é‡</th>
                                        <th class="px-4 py-2 text-right">å°è¨ˆ</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${Object.values(data.items).map(item => `
                                        <tr>
                                            <td class="px-4 py-2">${item.name}</td>
                                            <td class="px-4 py-2">${item.spec || ''}</td>
                                            <td class="px-4 py-2 text-right">${item.price.toLocaleString()}</td>
                                            <td class="px-4 py-2 text-right">${item.quantity} ${item.unit}</td>
                                            <td class="px-4 py-2 text-right">${item.subtotal.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                renderModal(modalHTML);

            } else if (action === 'export-consolidation-xlsx') {
                if (!state.local.consolidatedData) {
                    showMessage('æ²’æœ‰å¯åŒ¯å‡ºçš„å½™æ•´è³‡æ–™', 'error');
                    return;
                }
                // UX: é–å®šæŒ‰éˆ•ä¸¦æç¤ºé€²åº¦
                const prevText_CON = button.textContent;
                button.disabled = true;
                button.textContent = 'åŒ¯å‡ºä¸­...';
                showWorking();
                try {
                    const includeImages = !!document.getElementById('consolidation-include-images')?.checked;
                    const rowHeightPt = Math.max(10, Math.min(200, parseInt(document.getElementById('consolidation-row-height')?.value || '80', 10)));
                    // å„ªå…ˆå˜—è©¦ ExcelJSï¼ˆæ›´ç©©å®šçš„åµŒåœ–ï¼‰
                    try {
                        await exportConsolidationWithExcelJS(state.local.consolidatedData, state.allProducts, includeImages, rowHeightPt);
                        showMessage('åŒ¯å‡ºå®Œæˆ');
                        closeModal();
                        return;
                    } catch (_) {
                        // ignore -> fallback
                    }

                    const workbook = await XlsxPopulate.fromBlankAsync();
                    const imageTasks = [];
                    const consolidatedData = state.local.consolidatedData;

                    // å½™ç¸½çš„å·¥ä½œè¡¨
                    const summarySheet = workbook.addSheet("å½™ç¸½");
                    // headers: åœ–ç‰‡, å•†å“ç·¨è™Ÿ, å» å•†ä»£è™Ÿ, å» å•†ç°¡ç¨±, ç”³è«‹éƒ¨é–€, éœ€æ±‚èª²å®¤, ç™¼ç¥¨é–‹ç«‹, å“å, è¦æ ¼, å–®åƒ¹, å–®ä½, ç¸½æ•¸é‡, å°è¨ˆ
                    summarySheet.cell("A1").value("åœ–ç‰‡");
                    summarySheet.cell("B1").value("å•†å“ç·¨è™Ÿ");
                    summarySheet.cell("C1").value("å» å•†ä»£è™Ÿ");
                    summarySheet.cell("D1").value("å» å•†ç°¡ç¨±");
                    summarySheet.cell("E1").value("ç”³è«‹éƒ¨é–€");
                    summarySheet.cell("F1").value("éœ€æ±‚èª²å®¤");
                    summarySheet.cell("G1").value("ç™¼ç¥¨é–‹ç«‹");
                    summarySheet.cell("H1").value("å“å");
                    summarySheet.cell("I1").value("è¦æ ¼");
                    summarySheet.cell("J1").value("å–®åƒ¹");
                    summarySheet.cell("K1").value("å–®ä½");
                    summarySheet.cell("L1").value("ç¸½æ•¸é‡");
                    summarySheet.cell("M1").value("å°è¨ˆ");
                    summarySheet.row(1).style("bold", true);
                    summarySheet.row(1).height(40);

                    const summaryItems = {};
                    Object.values(consolidatedData).forEach(vendorData => {
                        Object.values(vendorData.items).forEach(item => {
                            const key = `${item.name}|${item.spec}|${item.price}`;
                            if (!summaryItems[key]) {
                                summaryItems[key] = { ...item, quantity: 0, subtotal: 0 };
                            }
                            summaryItems[key].quantity += item.quantity;
                            summaryItems[key].subtotal += item.subtotal;
                        });
                    });

                    let summaryRowIndex = 2;
                    let summaryTotal = 0;
                    Object.values(summaryItems).forEach(item => {
                        // åœ–ç‰‡ï¼šå¯«å…¥ thumbnail é€£çµï¼ˆè‹¥ item.image å¯ç”¨ï¼‰
                        const r = summaryRowIndex;
                        summarySheet.cell(`A${r}`).value(item.image ? `https://drive.google.com/thumbnail?id=${item.image}` : '');
                        summarySheet.cell(`B${r}`).value(item.product_id || '');
                        summarySheet.cell(`C${r}`).value(item.vendor_code || '');
                        summarySheet.cell(`D${r}`).value(item.vendor_short || '');
                        summarySheet.cell(`E${r}`).value(item.department || '');
                        summarySheet.cell(`F${r}`).value(item.demand_department || '');
                        summarySheet.cell(`G${r}`).value(item.invoice || '');
                        summarySheet.cell(`H${r}`).value(item.name || '');
                        summarySheet.cell(`I${r}`).value(item.spec || '');
                        summarySheet.cell(`J${r}`).value(item.price).style("numberFormat", "$#,##0.00");
                        summarySheet.cell(`K${r}`).value(item.unit || '');
                        summarySheet.cell(`L${r}`).value(item.quantity || 0);
                        summarySheet.cell(`M${r}`).value(item.subtotal || 0).style("numberFormat", "$#,##0.00");
                        summarySheet.row(r).height(40);
                        summaryTotal += Number(item.subtotal || 0);
                        summaryRowIndex++;
                    });

                    // summary totals row
                    summarySheet.cell(`H${summaryRowIndex + 1}`).value("ç¸½è¨ˆ").style("bold", true);
                    summarySheet.cell(`L${summaryRowIndex + 1}`).value(Object.values(summaryItems).reduce((s, it) => s + Number(it.quantity || 0), 0)).style("bold", true);
                    summarySheet.cell(`M${summaryRowIndex + 1}`).value(summaryTotal).style({bold: true, numberFormat: "$#,##0.00"});
                    summarySheet.row(summaryRowIndex + 1).height(40);


                    // å„å» å•†çš„å·¥ä½œè¡¨
                    Object.entries(consolidatedData).forEach(([vendor, data]) => {
                        const sheet = workbook.addSheet(vendor.replace(/[\/\\?*[\]]/g, ''));
                        // æ¬„ä½ï¼šåœ–ç‰‡ã€å» å•†ä»£è™Ÿã€å» å•†ç°¡ç¨±ã€å•†å“ç·¨è™Ÿã€å“åã€è¦æ ¼ã€å–®åƒ¹ã€ç¸½æ•¸é‡ã€å–®ä½ã€å°è¨ˆã€ç”³è«‹éƒ¨é–€ã€éœ€æ±‚èª²å®¤ã€ç™¼ç¥¨é–‹ç«‹
                        sheet.cell("A1").value("åœ–ç‰‡");
                        sheet.cell("B1").value("å» å•†ä»£è™Ÿ");
                        sheet.cell("C1").value("å» å•†ç°¡ç¨±");
                        sheet.cell("D1").value("å•†å“ç·¨è™Ÿ");
                        sheet.cell("E1").value("å“å");
                        sheet.cell("F1").value("è¦æ ¼");
                        sheet.cell("G1").value("å–®åƒ¹");
                        sheet.cell("H1").value("ç¸½æ•¸é‡");
                        sheet.cell("I1").value("å–®ä½");
                        sheet.cell("J1").value("å°è¨ˆ");
                        sheet.cell("K1").value("ç”³è«‹éƒ¨é–€");
                        sheet.cell("L1").value("éœ€æ±‚èª²å®¤");
                        sheet.cell("M1").value("ç™¼ç¥¨é–‹ç«‹");
                        sheet.row(1).style("bold", true);
                        sheet.row(1).height(40);

                        let vendorQtyTotal = 0;
                        Object.values(data.items).forEach((item, index) => {
                            const row = index + 2;
                            // åœ–ç‰‡ï¼šå˜—è©¦åµŒå…¥åœ–ç‰‡ï¼Œå¤±æ•—å‰‡é€€å›é€£çµæ–‡å­—
                            let fileId = '';
                            try {
                                const prod = (state.allProducts || []).find(p => p.id === item.id);
                                if (prod && prod.image) fileId = prod.image;
                            } catch {}
                            if (fileId && typeof sheet.addImage === 'function') {
                                // ä½¿ç”¨ thumbnail ç«¯é»æå‡è·¨åŸŸæˆåŠŸç‡
                                const url = `https://drive.google.com/thumbnail?id=${fileId}`;
                                imageTasks.push((async () => {
                                    try {
                                        const resp = await fetch(url);
                                        const buf = await resp.arrayBuffer();
                                        const ct = (resp.headers.get('content-type') || '').toLowerCase();
                                        const imgType = ct.includes('jpeg') || ct.includes('jpg') ? 'image/jpeg' : 'image/png';
                                        try {
                                            const img = typeof workbook.addImage === 'function'
                                                ? await workbook.addImage({ image: buf, type: imgType })
                                                : null;
                                            sheet.row(row).height(60);
                                            if (img) {
                                                sheet.addImage(img, {
                                                    tl: { col: 0.2, row: row - 0.8 },
                                                    br: { col: 1.8, row: row - 0.05 },
                                                    editAs: 'oneCell'
                                                });
                                            } else {
                                                // ä¸€äº›ç‰ˆæœ¬å¯èƒ½ç›´æ¥æ”¯æ´ sheet.addImage(buffer,...)
                                                sheet.addImage({ image: buf, type: imgType }, {
                                                    tl: { col: 0.2, row: row - 0.8 },
                                                    br: { col: 1.8, row: row - 0.05 },
                                                    editAs: 'oneCell'
                                                });
                                            }
                                        } catch (e2) {
                                            sheet.cell(`A${row}`).value(url);
                                        }
                                    } catch (e) {
                                        sheet.cell(`A${row}`).value(url);
                                    }
                                })());
                            } else {
                                sheet.cell(`A${row}`).value(fileId ? `https://drive.google.com/thumbnail?id=${fileId}` : '');
                            }
                            // å» å•†ä»£è™Ÿèˆ‡ç°¡ç¨±ï¼šå˜—è©¦å¾ consolidated key æˆ– state.vendors æ¨æ–·
                            const vendorInfoForSheet = (state && state.vendors) ? state.vendors.find(v => v.vendor_id === vendor || v.short_name === vendor || v.name === vendor) : null;
                            const vendorCodeForSheet = vendorInfoForSheet ? vendorInfoForSheet.vendor_id : vendor;
                            const vendorShortForSheet = vendorInfoForSheet ? (vendorInfoForSheet.short_name || vendorInfoForSheet.name) : (vendor || '');

                            sheet.cell(`B${row}`).value(vendorCodeForSheet);
                            sheet.cell(`C${row}`).value(vendorShortForSheet);
                            sheet.cell(`D${row}`).value(item.id || '');
                            sheet.cell(`E${row}`).value(item.name);
                            sheet.cell(`F${row}`).value(item.spec);
                            sheet.cell(`G${row}`).value(item.price).style("numberFormat", "$#,##0.00");
                            sheet.cell(`H${row}`).value(item.quantity);
                            vendorQtyTotal += Number(item.quantity || 0);
                            sheet.cell(`I${row}`).value(item.unit);
                            sheet.cell(`J${row}`).value(item.subtotal).style("numberFormat", "$#,##0.00");
                            sheet.row(row).height(40);
                            // ç”³è«‹/éœ€æ±‚/ç™¼ç¥¨ï¼šä¾†æºæ–¼å½™æ•´æ™‚ä¸åŒå–®æ“šå¯èƒ½ä¸åŒï¼Œé€™è£¡ä»¥é …ç›®æˆ–å½™æ•´æ™‚è¨˜éŒ„çš„ department ç‚ºä¸»
                            sheet.cell(`K${row}`).value(item.department || (data.department || '') );
                            sheet.cell(`L${row}`).value(item.demand_department || '');
                            const inv = item.invoice === 'å…¶ä»–' ? (item.custom_invoice || 'å…¶ä»–') : (item.invoice || '');
                            sheet.cell(`M${row}`).value(inv);
                        });
                        const itemCount = Object.values(data.items).length;
                        const blankRowIdx = itemCount + 2;
                        const totalRow = itemCount + 3;
                        sheet.row(blankRowIdx).height(40);
                        // ç¸½è¨ˆï¼šlabel æ”¾åœ¨å“åæ¬„(E)ï¼Œæ•¸é‡ç¸½è¨ˆæ”¾åœ¨ Hï¼Œé‡‘é¡ç¸½è¨ˆæ”¾åœ¨ J
                        sheet.cell(`E${totalRow}`).value("ç¸½è¨ˆ").style("bold", true);
                        sheet.cell(`H${totalRow}`).value(vendorQtyTotal).style("bold", true);
                        sheet.cell(`J${totalRow}`).value(data.total).style({bold: true, numberFormat: "$#,##0.00"});
                        sheet.row(totalRow).height(40);
                    });

                    // ç¢ºä¿æ‰€æœ‰åœ–ç‰‡éƒ½å·²æ’å…¥
                    if (imageTasks.length) {
                        try { await Promise.all(imageTasks); } catch {}
                    }

                    workbook.deleteSheet("Sheet1"); // Delete default sheet
                    const blob = await workbook.outputAsync();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    document.body.appendChild(a);
                    a.style = "display: none";
                    a.href = url;
                    a.download = `å» å•†å½™ç¸½è¨‚å–®_${getISODateString(new Date())}.xlsx`;
                    a.click();
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showMessage('åŒ¯å‡ºå®Œæˆ');
                    closeModal();
                } catch (err) {
                    console.error("åŒ¯å‡º Excel å¤±æ•—:", err);
                    showMessage("åŒ¯å‡º Excel å¤±æ•—: " + err.message, 'error');
                } finally {
                    hideWorking();
                    // é‚„åŸæŒ‰éˆ•ï¼ˆè‹¥å°šæœªé—œé–‰è¦–çª—ï¼‰
                    if (document.body.contains(button)) {
                        button.disabled = false;
                        button.textContent = prevText_CON;
                    }
                }
            } else if (action === 'confirm-export-orders-preview') {
                // è®€å–å‹¾é¸æ¢ä»¶
                const selectedStatuses = [...document.querySelectorAll('.export-status-checkbox:checked')].map(cb => cb.value);
                const selectedClosedStatuses = [...document.querySelectorAll('.export-closed-checkbox:checked')].map(cb => cb.value);
                const selectedHandlerStatuses = [...document.querySelectorAll('.export-handler-checkbox:checked')].map(cb => cb.value);

                // æ”¶é›†è³‡æ–™ä¾†æºï¼šå„ªå…ˆä½¿ç”¨ä½¿ç”¨è€…é¸å–çš„å¤šé¸ï¼Œå…¶æ¬¡ä½¿ç”¨ç›®å‰ç¯©é¸çš„å…¨éƒ¨
                let requestsToProcess;
                if (state.local.selectedRequestIds.size > 0) {
                    requestsToProcess = state.requests.filter(req => state.local.selectedRequestIds.has(req.id));
                } else {
                    requestsToProcess = getFilteredRequests();
                }

                const filtered = requestsToProcess.filter(req => {
                    const passApproval = selectedStatuses.length === 0 ? true : selectedStatuses.includes(req.status);
                    const passClosed = selectedClosedStatuses.length === 0 ? true : selectedClosedStatuses.includes(req.closed_status || 'æœªçµæ¡ˆ');
                    const effectiveHandler = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                    const passHandler = selectedHandlerStatuses.length === 0 ? true : selectedHandlerStatuses.includes(effectiveHandler);
                    return passApproval && passClosed && passHandler;
                });

                if (filtered.length === 0) { showMessage('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™å¯å½™æ•´', 'error'); return; }

                // æ•´å‚™å¹³é¢è³‡æ–™ä¾›é è¦½èˆ‡å¾ŒçºŒ XLSX
                    const flatRows = [];
                filtered.forEach(req => {
                    const orderType = req.type || 'ç‰¹æ¡';
                    const applicant = state.users[req.applicant_id]?.name || req.applicant_id;
                    const approval = (req.approvers || []).map(a => `${a.role}:${a.status}`).join('; ');
                    const handler = req.handler_status || (req.status === 'å·²æ ¸å‡†' ? 'å¾…ç¶“è¾¦' : 'æœªç¶“è¾¦');
                    const closed = req.closed_status || 'æœªçµæ¡ˆ';
                            if ((req.items || []).length > 0) {
                        (req.items || []).forEach(item => flatRows.push({
                            id: req.id,
                            type: orderType,
                            date: getFormattedDateTime(req.request_date),
                            applicant,
                            department: req.department || '',
                            demand_department: item.demand_department || (state.users[req.applicant_id]?.demand_department || ''),
                            invoice: item.invoice === 'å…¶ä»–' ? (item.custom_invoice || 'å…¶ä»–') : (item.invoice || (state.users[req.applicant_id]?.default_invoice || '')),
                            vendor: item.vendor || '',
                            // æ–°å¢å» å•†ç°¡ç¨±æ¬„ä½ï¼ˆåŒ¯å‡ºæ™‚ä½¿ç”¨ï¼‰
                            vendor_short: (state.vendors.find(v => v.vendor_id === item.vendor)?.short_name) || (item.vendor || ''),
                            approval: req.status,
                            handler,
                            closed,
                            name: item.name || '',
                            // æ–°å¢å•†å“ç·¨è™Ÿæ¬„ä½ï¼ˆä¾†è‡ª item.idï¼‰
                            product_id: item.id || null,
                            spec: item.spec || '',
                            price: item.price || 0,
                            unit: item.unit || '',
                            quantity: item.quantity || 0,
                            subtotal: (item.price || 0) * (item.quantity || 0),
                            approval_flow: approval
                        }));
                    } else {
                        flatRows.push({ id: req.id, type: orderType, date: getFormattedDateTime(req.request_date), applicant, department: req.department || '', demand_department: '', invoice: '', vendor: '', approval: req.status, handler, closed, name: '', spec: '', price: 0, unit: '', quantity: 0, subtotal: 0, approval_flow: approval, product_id: null });
                    }
                });
                state.local.exportOrdersFlatRows = flatRows;

        const previewHead = ['ç”³è«‹å–®è™Ÿ','è¨‚å–®é¡åˆ¥','ç”³è«‹æ—¥æœŸ','ç”³è«‹äºº','ç”³è«‹éƒ¨é–€','éœ€æ±‚èª²å®¤','ç™¼ç¥¨é–‹ç«‹','å» å•†ä»£è™Ÿ','å» å•†ç°¡ç¨±','ç°½æ ¸ç‹€æ…‹','ç¶“è¾¦ç‹€æ…‹','çµæ¡ˆç‹€æ…‹','å“å','å•†å“ç·¨è™Ÿ','è¦æ ¼','å–®åƒ¹','å–®ä½','æ•¸é‡','å°è¨ˆ','ç°½æ ¸é€²åº¦'];
        const previewRows = flatRows.slice(0, 200).map(r => `
                    <tr>
                        <td class="px-2 py-1">${r.id}</td>
                        <td class="px-2 py-1">${r.type}</td>
                        <td class="px-2 py-1 whitespace-nowrap">${r.date}</td>
                        <td class="px-2 py-1">${r.applicant}</td>
                        <td class="px-2 py-1">${r.department}</td>
                        <td class="px-2 py-1">${r.demand_department}</td>
                        <td class="px-2 py-1">${r.invoice}</td>
            <td class="px-2 py-1">${r.vendor}</td>
            <td class="px-2 py-1">${r.vendor_short || ''}</td>
                        <td class="px-2 py-1">${r.approval}</td>
                        <td class="px-2 py-1">${r.handler}</td>
                        <td class="px-2 py-1">${r.closed}</td>
            <td class="px-2 py-1">${r.name}</td>
            <td class="px-2 py-1">${r.product_id || ''}</td>
            <td class="px-2 py-1">${r.spec}</td>
                        <td class="px-2 py-1 text-right">${r.price}</td>
                        <td class="px-2 py-1">${r.unit}</td>
                        <td class="px-2 py-1 text-right">${r.quantity}</td>
                        <td class="px-2 py-1 text-right">${r.subtotal}</td>
                        <td class="px-2 py-1">${r.approval_flow}</td>
                    </tr>
                `).join('');

                renderModal(`
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold">åŒ¯å‡ºè¨‚å–® - å½™æ•´é è¦½ï¼ˆåƒ…é¡¯ç¤ºå‰200ç­†ï¼‰</h3>
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center text-sm select-none">
                                <input id="orders-include-images" type="checkbox" class="mr-2" checked /> æ˜¯å¦é¡¯ç¤ºåœ–ç‰‡
                            </label>
                            <label class="inline-flex items-center text-sm select-none">
                                è¡Œé«˜(pt)
                                <input id="orders-row-height" type="number" min="10" max="200" step="1" value="80" class="ml-2 w-20 border rounded px-2 py-1" />
                            </label>
                            <button data-action="export-orders-xlsx" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">åŒ¯å‡º XLSX</button>
                            <button data-action="cancel-modal" class="ml-2 px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">é—œé–‰</button>
                        </div>
                    </div>
                    <div class="max-h-[60vh] overflow-auto border rounded">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>${previewHead.map(h => `<th class='px-2 py-2 text-left'>${h}</th>`).join('')}</tr>
                            </thead>
                            <tbody class="bg-white divide-y">${previewRows}</tbody>
                        </table>
                    </div>
                `);
            } else if (action === 'export-orders-xlsx') {
                const flatRows = state.local.exportOrdersFlatRows || [];
                if (!flatRows.length) { showMessage('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™', 'error'); return; }
                // UX: é–å®šæŒ‰éˆ•ä¸¦æç¤ºé€²åº¦
                const prevText_ORD = button.textContent;
                button.disabled = true;
                button.textContent = 'åŒ¯å‡ºä¸­...';
                showWorking();
                try {
                    const includeImages = !!document.getElementById('orders-include-images')?.checked;
                    const rowHeightPt = Math.max(10, Math.min(200, parseInt(document.getElementById('orders-row-height')?.value || '80', 10)));
                    // å„ªå…ˆå˜—è©¦ ExcelJSï¼ˆæ›´ç©©å®šçš„åµŒåœ–ï¼‰
                    try {
                        await exportOrdersWithExcelJS(flatRows, state.allProducts, includeImages, rowHeightPt);
                        showMessage('åŒ¯å‡ºå®Œæˆ');
                        closeModal();
                        return;
                    } catch (_) {
                        // ignore -> fallback
                    }

                    const workbook = await XlsxPopulate.fromBlankAsync();
                    const sheet = workbook.addSheet('è¨‚å–®å½™æ•´');
                    const headers = ['åœ–ç‰‡','ç”³è«‹å–®è™Ÿ','è¨‚å–®é¡åˆ¥','ç”³è«‹æ—¥æœŸ','ç”³è«‹äºº','ç”³è«‹éƒ¨é–€','éœ€æ±‚èª²å®¤','ç™¼ç¥¨é–‹ç«‹','å» å•†ä»£è™Ÿ','å» å•†ç°¡ç¨±','ç°½æ ¸ç‹€æ…‹','ç¶“è¾¦ç‹€æ…‹','çµæ¡ˆç‹€æ…‹','å“å','å•†å“ç·¨è™Ÿ','è¦æ ¼','å–®åƒ¹','å–®ä½','æ•¸é‡','å°è¨ˆ','ç°½æ ¸é€²åº¦'];
                    headers.forEach((h, i) => sheet.cell(1, i+1).value(h));
                    sheet.row(1).style('bold', true);
                    sheet.row(1).height(40);
                    const colWidths = [12, 16, 10, 18, 12, 12, 12, 12, 12, 12, 10, 10, 10, 20, 14, 20, 10, 8, 8, 12, 24];
                    colWidths.forEach((w, i) => sheet.column(i+1).width(w));

                    const productImageById = {};
                    (state.allProducts || []).forEach(p => { if (p.id && p.image) productImageById[p.id] = p.image; });

                    let rowIndex = 2;
                    for (const r of flatRows) {
                        // è³‡æ–™æ¬„
                        sheet.cell(rowIndex, 2).value(r.id);
                        sheet.cell(rowIndex, 3).value(r.type);
                        sheet.cell(rowIndex, 4).value(r.date);
                        sheet.cell(rowIndex, 5).value(r.applicant);
                        sheet.cell(rowIndex, 6).value(r.department);
                        sheet.cell(rowIndex, 7).value(r.demand_department);
                        sheet.cell(rowIndex, 8).value(r.invoice);
                        sheet.cell(rowIndex, 9).value(r.vendor);
                        // å» å•†ç°¡ç¨±
                        sheet.cell(rowIndex, 10).value(r.vendor_short || '');
                        sheet.cell(rowIndex, 11).value(r.approval);
                        sheet.cell(rowIndex, 12).value(r.handler);
                        sheet.cell(rowIndex, 13).value(r.closed);
                        sheet.cell(rowIndex, 14).value(r.name);
                        // å•†å“ç·¨è™Ÿ
                        sheet.cell(rowIndex, 15).value(r.product_id || '');
                        sheet.cell(rowIndex, 16).value(r.spec);
                        sheet.cell(rowIndex, 17).value(r.price).style('numberFormat', '$#,##0.00');
                        sheet.cell(rowIndex, 18).value(r.unit);
                        sheet.cell(rowIndex, 19).value(r.quantity);
                        sheet.cell(rowIndex, 20).value(r.subtotal).style('numberFormat', '$#,##0.00');
                        sheet.cell(rowIndex, 21).value(r.approval_flow);
                        sheet.row(rowIndex).height(40);

                        // åœ–ç‰‡ï¼ˆå¦‚æœ‰ï¼‰ï¼šå˜—è©¦åµŒå…¥ï¼Œå¤±æ•—å‰‡é€£çµ
                        const fileId = r.product_id ? productImageById[r.product_id] : null;
                        if (fileId) {
                            // ä½¿ç”¨ thumbnail ç«¯é»æå‡è·¨åŸŸæˆåŠŸç‡
                            const url = `https://drive.google.com/thumbnail?id=${fileId}`;
                            try {
                                const resp = await fetch(url);
                                const buf = await resp.arrayBuffer();
                                const ct = (resp.headers.get('content-type') || '').toLowerCase();
                                const imgType = ct.includes('jpeg') || ct.includes('jpg') ? 'image/jpeg' : 'image/png';
                                sheet.row(rowIndex).height(60);
                                if (typeof workbook.addImage === 'function') {
                                    try {
                                        const img = await workbook.addImage({ image: buf, type: imgType });
                                        sheet.addImage(img, {
                                            tl: { col: 0.2, row: rowIndex - 0.8 },
                                            br: { col: 1.8, row: rowIndex - 0.05 },
                                            editAs: 'oneCell'
                                        });
                                    } catch {
                                        if (typeof sheet.addImage === 'function') {
                                            sheet.addImage({ image: buf, type: imgType }, {
                                                tl: { col: 0.2, row: rowIndex - 0.8 },
                                                br: { col: 1.8, row: rowIndex - 0.05 },
                                                editAs: 'oneCell'
                                            });
                                        } else {
                                            sheet.cell(rowIndex, 1).value(url);
                                        }
                                    }
                                } else if (typeof sheet.addImage === 'function') {
                                    sheet.addImage({ image: buf, type: imgType }, {
                                        tl: { col: 0.2, row: rowIndex - 0.8 },
                                        br: { col: 1.8, row: rowIndex - 0.05 },
                                        editAs: 'oneCell'
                                    });
                                } else {
                                    sheet.cell(rowIndex, 1).value(url);
                                }
                            } catch (e) {
                                sheet.cell(rowIndex, 1).value(url);
                            }
                        }

                        rowIndex++;
                    }

                    workbook.deleteSheet('Sheet1');
                    const blob = await workbook.outputAsync();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    document.body.appendChild(a);
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `è¨‚å–®å½™æ•´_${getISODateString(new Date())}.xlsx`;
                    a.click();
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showMessage('åŒ¯å‡ºå®Œæˆ');
                    closeModal();
                } catch (err) {
                    console.error('åŒ¯å‡º XLSX å¤±æ•—:', err);
                    showMessage('åŒ¯å‡º XLSX å¤±æ•—: ' + err.message, 'error');
                } finally {
                    hideWorking();
                    // é‚„åŸæŒ‰éˆ•ï¼ˆè‹¥å°šæœªé—œé–‰è¦–çª—ï¼‰
                    if (document.body.contains(button)) {
                        button.disabled = false;
                        button.textContent = prevText_ORD;
                    }
                }
            } else if (action === 'confirm-batch-close') {
                const idsToClose = JSON.parse(button.dataset.ids);
                updateState({ loading: true });
                try {
                    // é€ç­†é™„åŠ çµæ¡ˆæ­·ç¨‹
                    for (const id of idsToClose) {
                        const req = state.requests.find(r => r.id === id);
                        if (!req) continue;
                        const newEntry = {
                            user: state.currentUser.name,
                            role: state.currentUser.role,
                            date: new Date().toISOString(),
                            reason: 'çµæ¡ˆ',
                            action: 'closed'
                        };
                        const patch = { closed_status: 'çµæ¡ˆ', modification_history: [...(req.modification_history || []), newEntry] };
                        const { error: upErr } = await supabase.from('requests').update(patch).eq('id', id);
                        if (upErr) throw upErr;
                    }
                    
                    showMessage(`${idsToClose.length} ç­†è¨‚å–®å·²æˆåŠŸçµæ¡ˆã€‚`);
                    closeModal();
                    
                    // æ¸…é™¤ç·©å­˜ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™
                    CacheManager.clear('dashboard_data');
                    await loadDashboardData(false, false); // å¼·åˆ¶ä¸ä½¿ç”¨ç·©å­˜
                    
                    // é‡ç½®ç¯©é¸ç·©å­˜
                    getFilteredRequests.resetCache();
                    
                    state.local.selectedRequestIds.clear();
                    render();
                } catch (err) {
                    showMessage('æ‰¹æ¬¡çµæ¡ˆå¤±æ•—: ' + err.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            } else if (action === 'confirm-batch-approve') {
                const comment = document.getElementById('batch-approval-comment').value;
                const selectedIds = Array.from(state.local.selectedRequestIds);
                const requestsToProcess = state.requests.filter(req => 
                    selectedIds.includes(req.id) &&
                    req.status === 'å¾…å¯©æ ¸' &&
                    (req.approvers || []).find(a => a.status === 'pending')?.userId === state.currentUser.id
                );

                if (requestsToProcess.length === 0) {
                    showMessage('æ²’æœ‰å¯æ ¸å‡†çš„å–®æ“šã€‚', 'error');
                    closeModal();
                    return;
                }

                updateState({ loading: true });
                try {
                    for (const request of requestsToProcess) {
                        const approvers = [...request.approvers];
                        const currentStepIndex = approvers.findIndex(a => a.status === 'pending');
                        if (currentStepIndex === -1) continue;

                        approvers[currentStepIndex].status = 'approved';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].comment = comment;

                        const isFinal = currentStepIndex === approvers.length - 1;
                        const newStatus = isFinal ? 'å·²æ ¸å‡†' : 'å¾…å¯©æ ¸';

                        const { error: updateError } = await supabase.from('requests').update({ approvers, status: newStatus }).eq('id', request.id);
                        if(updateError) throw updateError;
                        
                        let notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${request.id} å·²ç”± ${state.currentUser.name} æ ¸å‡†ã€‚`;
                        if (isFinal) {
                            notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${request.id} å·²å…¨æ•¸ç°½æ ¸å®Œæˆï¼`;
                        }
                        const { error: notificationError } = await supabase.from('notifications').insert({
                            user_id: request.applicant_id,
                            request_id: request.id,
                            message: notificationMessage,
                            is_read: false
                        });
                        if(notificationError) console.error("Failed to create notification:", notificationError);
                    }
                    showMessage(`${requestsToProcess.length} ç­†å–®æ“šå·²æˆåŠŸæ ¸å‡†ã€‚`);
                } catch (err) {
                    showMessage('æ‰¹æ¬¡æ ¸å‡†å¤±æ•—: ' + err.message, 'error');
                } finally {
                    closeModal();
                    state.local.selectedRequestIds.clear();
                    
                    // æ¸…é™¤ç·©å­˜ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™
                    CacheManager.clear('dashboard_data');
                    await loadDashboardData(false, false); // å¼·åˆ¶ä¸ä½¿ç”¨ç·©å­˜
                    
                    // é‡ç½®ç¯©é¸ç·©å­˜
                    getFilteredRequests.resetCache();
                    
                    updateState({ loading: false });
                }
            } else if (action === 'save-profile') {
                const form = document.getElementById('edit-profile-form');
                if (!form) return;

                const demandDepartment = document.getElementById('edit-profile-demand-department').value;
                const defaultInvoice = document.getElementById('edit-profile-invoice').value;
                const themePref = document.getElementById('edit-profile-theme').value;
                const menuLayout = document.getElementById('edit-profile-menu-layout').value; // 'expanded' or 'compact'

                updateState({ loading: true });
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .update({
                            demand_department: demandDepartment || null,
                            default_invoice: defaultInvoice || null,
                            theme_preference: themePref || null,
                            menu_layout: menuLayout || null
                        })
                        .eq('id', state.currentUser.id)
                        .select()
                        .single();

                    if (error) throw error;

                    state.currentUser = data;
                    // ç«‹å³å¥—ç”¨ä¸»é¡Œèˆ‡ç‰ˆå‹
                    if (themePref) {
                        applyTheme(themePref);
                        const sel = document.getElementById('theme-select');
                        if (sel) sel.value = state.theme; // applyThemeå·²è™•ç†éš¨æ©Ÿæƒ…æ³
                    }
                    if (menuLayout) {
                        state.local.layoutScale = menuLayout === 'compact' ? 'compact' : 'expanded';
                        localStorage.setItem('menuLayout', state.local.layoutScale);
                    }

                    showMessage('å€‹äººè¨­å®šå·²æ›´æ–°');
                    closeModal();
                    render();
                } catch (err) {
                    showMessage('æ›´æ–°è¨­å®šå¤±æ•—: ' + err.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            } else if (action === 'confirm-batch-reject') {
                const reason = document.getElementById('batch-rejection-reason').value;
                if (!reason.trim()) {
                    showMessage('è«‹å¡«å¯«é€€å›ç†ç”±ã€‚', 'error');
                    return;
                }
            } else if (action === 'confirm-popover-reject-all' || action === 'confirm-popover-reject-previous') {
                const requestId = button.dataset.id;
                const reason = document.getElementById('popover-rejection-reason').value;
                if (!reason || !reason.trim()) { showMessage('è«‹å¡«å¯«é€€å›ç†ç”±ã€‚', 'error'); return; }

                const req = state.requests.find(r => r.id === requestId);
                if (!req) { showMessage('æ‰¾ä¸åˆ°å–®æ“š', 'error'); return; }
                const approvers = [...(req.approvers || [])];
                const currentStepIndex = approvers.findIndex(a => a.status === 'pending');
                if (currentStepIndex === -1 || approvers[currentStepIndex].userId !== state.currentUser.id) {
                    showMessage('æ‚¨ä¸æ˜¯æ­¤å–®ç›®å‰çš„ç°½æ ¸äººã€‚', 'error');
                    return;
                }
                updateState({ loading: true });
                try {
                    let newStatus = 'å·²é€€å›';
                    let notificationMessage = '';
                    if (action === 'confirm-popover-reject-previous' && currentStepIndex > 0) {
                        approvers[currentStepIndex - 1].status = 'pending';
                        approvers[currentStepIndex - 1].date = '';
                        approvers[currentStepIndex - 1].comment = '';
                        newStatus = 'å¾…å¯©æ ¸';
                        approvers[currentStepIndex].status = 'rejected';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].reason = reason;
                        approvers[currentStepIndex].comment = `ç”± ${state.currentUser.name} é€€å›ä¸Šä¸€å±¤ã€‚`;
                        notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${requestId} å·²ç”± ${state.currentUser.name} é€€å›è‡³ä¸Šä¸€å±¤ç°½æ ¸ã€‚åŸå› ï¼š${reason}`;
                    } else {
                        approvers[currentStepIndex].status = 'rejected';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].reason = reason;
                        approvers[currentStepIndex].comment = `æ–¼ ${getFormattedDateTime(new Date())} é€€å›ã€‚åŸå› : ${reason}`;
                        newStatus = 'å·²é€€å›';
                        notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${requestId} å·²è¢« ${state.currentUser.name} æ•´ç­†é€€å›ã€‚åŸå› ï¼š${reason}`;
                    }

                    const { data: updated, error: updateErr } = await supabase.from('requests')
                        .update({ approvers, status: newStatus })
                        .eq('id', requestId)
                        .select()
                        .single();
                    if (updateErr) throw updateErr;

                    try {
                        await supabase.from('notifications').insert({ user_id: req.applicant_id, request_id: requestId, message: notificationMessage, is_read: false });
                    } catch {}

                    const newRequests = state.requests.map(r => r.id === requestId ? updated : r);
                    getFilteredRequests.resetCache?.();
                    updateState({ requests: newRequests, loading: false });
                    closeModal();
                    showMessage('å·²é€€å›');
                } catch (err) {
                    updateState({ loading: false });
                    showMessage('é€€å›å¤±æ•—: ' + err.message, 'error');
                }
                const selectedIds = Array.from(state.local.selectedRequestIds);
                const requestsToProcess = state.requests.filter(req => 
                    selectedIds.includes(req.id) &&
                    req.status === 'å¾…å¯©æ ¸' &&
                    (req.approvers || []).find(a => a.status === 'pending')?.userId === state.currentUser.id
                );

                if (requestsToProcess.length === 0) {
                    showMessage('æ²’æœ‰å¯é€€å›çš„å–®æ“šã€‚', 'error');
                    closeModal();
                    return;
                }

                updateState({ loading: true });
                try {
                    for (const request of requestsToProcess) {
                        const approvers = [...request.approvers];
                        const currentStepIndex = approvers.findIndex(a => a.status === 'pending');
                        if (currentStepIndex === -1) continue;

                        approvers[currentStepIndex].status = 'rejected';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].reason = reason;

                        const { error: updateError } = await supabase.from('requests').update({ approvers, status: 'å·²é€€å›' }).eq('id', request.id);
                        if(updateError) throw updateError;

                        const { error: notificationError } = await supabase.from('notifications').insert({
                            user_id: request.applicant_id,
                            request_id: request.id,
                            message: `æ‚¨çš„ç”³è«‹å–® ${request.id} å·²è¢« ${state.currentUser.name} é€€å›ã€‚åŸå› ï¼š${reason}`,
                            is_read: false
                        });
                        if(notificationError) console.error("Failed to create notification:", notificationError);
                    }
                    showMessage(`${requestsToProcess.length} ç­†å–®æ“šå·²æˆåŠŸé€€å›ã€‚`);
                } catch (err) {
                    showMessage('æ‰¹æ¬¡é€€å›å¤±æ•—: ' + err.message, 'error');
                } finally {
                    closeModal();
                    state.local.selectedRequestIds.clear();
                    
                    // æ¸…é™¤ç·©å­˜ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™
                    CacheManager.clear('dashboard_data');
                    await loadDashboardData(false, false); // å¼·åˆ¶ä¸ä½¿ç”¨ç·©å­˜
                    
                    // é‡ç½®ç¯©é¸ç·©å­˜
                    getFilteredRequests.resetCache();
                    
                    updateState({ loading: false });
                }
            } else if (action === 'modal-reject-options') {
                // é¡¯ç¤ºé€€å›é¸é …å½ˆçª—
                const requestId = button.dataset.requestId;
                const currentComment = document.getElementById('approval-comment-modal').value || '';
                
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">é€€å›ç”³è«‹</h3>
                    <label for="rejection-reason-modal" class="block text-sm font-medium text-gray-700">é€€å›ç†ç”±ï¼š</label>
                    <textarea id="rejection-reason-modal" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${currentComment}</textarea>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">å–æ¶ˆ</button>
                        <button data-action="modal-confirm-reject-previous" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-yellow-500 text-white">é€€å›ä¸Šä¸€å±¤</button>
                        <button data-action="modal-confirm-reject-all" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white">æ•´ç­†é€€å–®</button>
                    </div>`);
            } else if (action === 'modal-confirm-reject-all' || action === 'modal-confirm-reject-previous') {
                // è™•ç†é€€å›ç¢ºèª
                const requestId = button.dataset.requestId;
                const request = state.requests.find(r => r.id === requestId);
                const reason = document.getElementById('rejection-reason-modal').value;
                
                if (!reason.trim()) {
                    showMessage('è«‹å¡«å¯«é€€å›ç†ç”±ã€‚', 'error');
                    return;
                }

                updateState({ loading: true });
                try {
                    const approvers = JSON.parse(JSON.stringify(request.approvers)); // Deep copy
                    const currentStepIndex = approvers.findIndex(a => a.status === 'pending');

                    if (currentStepIndex !== -1) {
                        let newStatus = 'å¾…å¯©æ ¸';
                        let notificationMessage = '';
                        
                        if (action === 'modal-confirm-reject-previous' && currentStepIndex > 0) {
                            // Revert previous approver to pending
                            approvers[currentStepIndex - 1].status = 'pending';
                            approvers[currentStepIndex - 1].date = '';
                            approvers[currentStepIndex - 1].reason = '';
                            approvers[currentStepIndex - 1].comment = `ç”± ${state.currentUser.name} é€€å›ï¼Œè«‹é‡æ–°å¯©æ ¸ã€‚`;
                            
                            // Mark current approver's rejection in their comment field, but keep them pending for the future
                            approvers[currentStepIndex].comment = `æ–¼ ${getFormattedDateTime(new Date())} é€€å›ã€‚åŸå› : ${reason}`;

                            notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${request.id} å·²ç”± ${state.currentUser.name} é€€å›è‡³ä¸Šä¸€å±¤ç°½æ ¸ã€‚åŸå› ï¼š${reason}`;
                            
                            // Notify the previous approver as well
                             await supabase.from('notifications').insert({
                                user_id: approvers[currentStepIndex - 1].userId,
                                request_id: request.id,
                                message: `ç”³è«‹å–® ${request.id} å·²è¢«é€€å›çµ¦æ‚¨é‡æ–°ç°½æ ¸ã€‚åŸå› ï¼š${reason}`,
                                is_read: false
                            });

                        } else { // This handles 'modal-confirm-reject-all' and 'modal-confirm-reject-previous' on first step
                            approvers[currentStepIndex].status = 'rejected';
                            approvers[currentStepIndex].date = new Date().toISOString();
                            approvers[currentStepIndex].reason = reason;
                            newStatus = 'å·²é€€å›';
                            notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${request.id} å·²è¢« ${state.currentUser.name} æ•´ç­†é€€å›ã€‚åŸå› ï¼š${reason}`;
                        }
                        
                        const { error } = await supabase
                            .from('requests')
                            .update({ approvers, status: newStatus })
                            .eq('id', request.id);
                        
                        if (error) throw error;

                        // Notify applicant
                        await supabase.from('notifications').insert({
                            user_id: request.applicant_id,
                            request_id: request.id,
                            message: notificationMessage,
                            is_read: false
                        });

                        // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                        const updatedRequest = { ...request, approvers, status: newStatus };
                        const newRequests = state.requests.map(r => r.id === request.id ? updatedRequest : r);
                        
                        // æ¸…é™¤ç·©å­˜ä¸¦é—œé–‰æ¨¡æ…‹æ¡†
                        CacheManager.clear('dashboard_data');
                        getFilteredRequests.resetCache();
                        
                        showMessage('ç”³è«‹å–®å·²é€€å›');
                        closeModal();
                        updateState({ view: 'dashboard', loading: false, requests: newRequests });
                        render();

                    } else {
                         throw new Error("æ‰¾ä¸åˆ°å¾…ç°½æ ¸çš„æ­¥é©Ÿã€‚");
                    }
                } catch (err) {
                    showMessage('é€€å›å¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            } else if (action === 'modal-approve' || action === 'modal-reject' || action === 'modal-save-changes' || action === 'modal-confirm-approve-with-save' || action === 'modal-confirm-approve-without-save') {
                // è™•ç†å–®å€‹ç”³è«‹å–®çš„ç°½æ ¸
                let requestId = button.dataset.requestId;
                // è‹¥å¾è©³æƒ…é å½ˆå‡ºç¢ºèªè¦–çª—ï¼Œå„ªå…ˆæ¡ç”¨å¿«ç…§ä¸­çš„ requestId
                if (!requestId && window.__approvePendingContext && window.__approvePendingContext.requestId) {
                    requestId = window.__approvePendingContext.requestId;
                }
                const request = state.requests.find(r => r.id === requestId);
                if (!request) {
                    showMessage('æ‰¾ä¸åˆ°å°æ‡‰çš„ç”³è«‹å–®ã€‚', 'error');
                    return;
                }

                // åœ¨å½ˆçª—æŒ‰æ ¸å‡†æ™‚ï¼Œè‹¥æœ‰è®Šæ›´ï¼Œå…ˆè©¢å•æ˜¯å¦å„²å­˜
                if (action === 'modal-approve') {
                    const form = document.getElementById('edit-request-form-modal');
                    if (form) {
                        const formData = new FormData(form);
                        let hasChanges = false;
                        for (let index = 0; index < (request.items || []).length; index++) {
                            const item = request.items[index];
                            const newReason = (formData.get(`reason_${index}`) || '').toString();
                            const newDescription = (formData.get(`description_${index}`) || '').toString();
                            const demandDept = formData.get(`demand_department_${index}`) || '';
                            const invoice = formData.get(`invoice_${index}`) || '';
                            const customInvoice = formData.get(`custom_invoice_${index}`) || '';
                            const vendor = formData.get(`vendor_${index}`) || '';
                            const price = parseFloat(formData.get(`price_${index}`)) || 0;
                            const quantity = parseInt(formData.get(`quantity_${index}`), 10) || 0;
                            const unit = formData.get(`unit_${index}`) || '';
                            const freight = parseFloat(formData.get(`freight_${index}`)) || 0;
                            const discount = parseFloat(formData.get(`discount_${index}`)) || 0;
                            let newScrap = item.is_scrap_work_order;
                            let newAsset = item.work_order_number || '';
                            if (newReason === 'å ±å»¢') {
                                newScrap = !!formData.get(`scrap_${index}`);
                                newAsset = newScrap ? (formData.get(`asset_number_${index}`) || '') : '';
                            } else {
                                newScrap = false;
                                newAsset = '';
                            }
                            if (
                                (item.reason || '') !== newReason ||
                                (item.description || '') !== newDescription ||
                                (item.demand_department || '') !== demandDept ||
                                (item.invoice || '') !== invoice ||
                                (item.custom_invoice || '') !== (invoice === 'å…¶ä»–' ? customInvoice : '') ||
                                (item.vendor || '') !== vendor ||
                                Number(item.price || 0) !== price ||
                                Number(item.quantity || 0) !== quantity ||
                                (item.unit || '') !== unit ||
                                Number(item.freight || 0) !== freight ||
                                Number(item.discount || 0) !== discount ||
                                Boolean(item.is_scrap_work_order) !== Boolean(newScrap) ||
                                (item.work_order_number || '') !== newAsset
                            ) {
                                hasChanges = true;
                                break;
                            }
                        }
                        if (hasChanges) {
                            // å¿«ç…§ modal ä¾†æºçš„è¡¨å–®å…§å®¹ï¼ˆå› ç‚ºç­‰ä¸‹æœƒè¦†è“‹ modal å…§å®¹ï¼‰
                            (window).__approvePendingContext = {
                                scope: 'modal',
                                requestId,
                                // å­˜æˆç‰©ä»¶ä»¥ä¾¿å¾ŒçºŒä½¿ç”¨
                                formData: Object.fromEntries(formData.entries()),
                                comment: document.getElementById('approval-comment-modal')?.value || '',
                                reason: document.getElementById('modification-reason-modal')?.value || ''
                            };
                            renderModal(`
                                <h3 class="text-lg font-bold mb-4">è«‹ç¢ºèªæ˜¯å¦é€²è¡Œå–®æ“šè³‡æ–™ä¿®æ”¹</h3>
                                <p class="mb-6 text-sm text-gray-700">åµæ¸¬åˆ°æ‚¨å°å–®æ“šå…§å®¹åšäº†è®Šæ›´ï¼Œæ˜¯å¦ä¸€ä½µå„²å­˜ä¿®æ”¹å¾Œå†æ ¸å‡†ï¼Ÿ</p>
                                <div class="flex justify-end space-x-3">
                                    <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                                    <button data-action="modal-confirm-approve-without-save" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-green-600 text-white hover:bg-green-700">å¦ï¼Œç›´æ¥æ ¸å‡†</button>
                                    <button data-action="modal-confirm-approve-with-save" data-request-id="${requestId}" class="px-4 py-2 rounded-md font-semibold text-sm bg-indigo-600 text-white hover:bg-indigo-700">æ˜¯ï¼Œå„²å­˜ä¿®æ”¹å¾Œæ ¸å‡†</button>
                                </div>
                            `, { size: 'half' });
                            return; // å…ˆä¸é€²å…¥åŸæ ¸å‡†æµç¨‹
                        }
                    }
                }

                if (action === 'modal-save-changes' || action === 'modal-confirm-approve-with-save') {
                    // å¾å¿«ç…§æˆ–ç¾æœ‰æ¬„ä½å–å¾—ä¿®æ”¹åŸå› ï¼ˆå„ªå…ˆå¿«ç…§ï¼‰
                    let modificationReason = '';
                    if (window.__approvePendingContext && typeof window.__approvePendingContext.reason !== 'undefined') {
                        modificationReason = window.__approvePendingContext.reason || '';
                    } else if (window.__approvePendingContext && window.__approvePendingContext.scope === 'detail') {
                        const reasonEl = document.querySelector(window.__approvePendingContext.reasonSelector);
                        modificationReason = reasonEl ? reasonEl.value : '';
                    } else {
                        const el = document.getElementById('modification-reason-modal');
                        modificationReason = el ? el.value : '';
                    }
                    if (!modificationReason.trim()) {
                        showMessage('ä¿®æ”¹è¨‚å–®å…§å®¹æ™‚ï¼Œå¿…é ˆå¡«å¯«ä¿®æ”¹åŸå› ã€‚', 'error');
                        return;
                    }
                }

                // å¾å¿«ç…§æˆ–ç¾æœ‰æ¬„ä½å–å¾—ç°½æ ¸æ„è¦‹
                let comment = '';
                if (window.__approvePendingContext && typeof window.__approvePendingContext.comment !== 'undefined') {
                    comment = window.__approvePendingContext.comment || '';
                } else if (window.__approvePendingContext && window.__approvePendingContext.scope === 'detail') {
                    const cmtEl = document.querySelector(window.__approvePendingContext.commentSelector);
                    comment = cmtEl ? (cmtEl.value || '') : '';
                } else {
                    const cmtEl = document.getElementById('approval-comment-modal');
                    comment = cmtEl ? (cmtEl.value || '') : '';
                }
                updateState({ loading: true });
                // ä¾›å¾ŒçºŒæœ¬åœ°ç‹€æ…‹æ›´æ–°ä½¿ç”¨çš„è®Šæ›´å¿«ç…§ï¼ˆåªåœ¨å„²å­˜ä¿®æ”¹æ™‚å¡«å…¥ï¼‰
                let savedPatch = null;
                
                try {
                    const approvers = [...request.approvers];
                    const currentStepIndex = approvers.findIndex(a => a.status === 'pending');
                    
                    if (currentStepIndex === -1) {
                        showMessage('æ‰¾ä¸åˆ°å¾…ç°½æ ¸çš„æ­¥é©Ÿã€‚', 'error');
                        return;
                    }

                    if (action === 'modal-approve' || action === 'modal-save-changes' || action === 'modal-confirm-approve-with-save' || action === 'modal-confirm-approve-without-save') {
                        // æ ¸å‡†é‚è¼¯
                        approvers[currentStepIndex].status = 'approved';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].comment = comment;
                        
                        const isFinal = currentStepIndex === approvers.length - 1;
                        const newStatus = isFinal ? 'å·²æ ¸å‡†' : 'å¾…å¯©æ ¸';

                        let updateData = { approvers, status: newStatus };

                        if (action === 'modal-save-changes' || action === 'modal-confirm-approve-with-save') {
                            // å–ç”¨å°æ‡‰è¡¨å–®è³‡æ–™ï¼šè©³æƒ…é è®€ DOMï¼›modal ç”¨å¿«ç…§
                            let modificationReason = '';
                            let getVal = (name) => null;
                            if (window.__approvePendingContext && window.__approvePendingContext.scope === 'detail') {
                                const reasonEl = document.querySelector(window.__approvePendingContext.reasonSelector);
                                modificationReason = reasonEl ? reasonEl.value : '';
                                const form = document.querySelector(window.__approvePendingContext.formSelector);
                                const formData = new FormData(form);
                                getVal = (name) => formData.get(name);
                            } else {
                                modificationReason = (window.__approvePendingContext && window.__approvePendingContext.reason) ? window.__approvePendingContext.reason : '';
                                const saved = (window.__approvePendingContext && window.__approvePendingContext.formData) ? window.__approvePendingContext.formData : {};
                                getVal = (name) => (name in saved ? saved[name] : null);
                            }
                            const newItems = request.items.map((item, index) => {
                                const updated = { ...item };
                                // å…è¨±ï¼šåŸå› /èªªæ˜
                                const reasonVal = getVal(`reason_${index}`);
                                if (reasonVal !== null) updated.reason = (reasonVal || '').toString();
                                const descVal = getVal(`description_${index}`);
                                if (descVal !== null) updated.description = (descVal || '').toString();
                                // å…è¨±ï¼šéœ€æ±‚èª²å®¤
                                const demandDept = getVal(`demand_department_${index}`);
                                if (demandDept !== null) updated.demand_department = demandDept || '';
                                // å…è¨±ï¼šç™¼ç¥¨é–‹ç«‹ + è‡ªè¨‚ç™¼ç¥¨
                                const invoice = getVal(`invoice_${index}`);
                                const customInvoice = getVal(`custom_invoice_${index}`);
                                if (invoice !== null) {
                                    updated.invoice = invoice || '';
                                    updated.custom_invoice = invoice === 'å…¶ä»–' ? (customInvoice || '') : '';
                                }
                                // å…è¨±ï¼šå» å•†
                                const vendor = getVal(`vendor_${index}`);
                                if (vendor !== null) updated.vendor = vendor || '';
                                // å…è¨±ï¼šåƒ¹æ ¼/æ•¸é‡/å–®ä½/é‹è²»/æŠ˜æ‰£
                                updated.price = parseFloat(getVal(`price_${index}`)) || 0;
                                updated.quantity = parseInt(getVal(`quantity_${index}`), 10) || 0;
                                updated.unit = getVal(`unit_${index}`) || '';
                                updated.freight = parseFloat(getVal(`freight_${index}`)) || 0;
                                updated.discount = parseFloat(getVal(`discount_${index}`)) || 0;
                                // å…è¨±ï¼šå ±å»¢/è²¡ç”¢ç·¨è™Ÿï¼ˆåƒ…åŸå› ç‚ºå ±å»¢æ™‚ï¼›å¦å‰‡è‡ªå‹•æ¸…ç©ºï¼‰
                                if (updated.reason === 'å ±å»¢') {
                                    const scrapChecked = !!getVal(`scrap_${index}`);
                                    updated.is_scrap_work_order = scrapChecked;
                                    updated.work_order_number = scrapChecked ? (getVal(`asset_number_${index}`) || '') : '';
                                } else {
                                    updated.is_scrap_work_order = false;
                                    updated.work_order_number = '';
                                }
                                return updated;
                            });
                            const newTotalAmount = Math.round(newItems.reduce((sum, item) => sum + (item.price * item.quantity) + (item.freight || 0) + (item.discount || 0), 0));
                            // å»ºç«‹è®Šæ›´æ˜ç´°ä¾›å¾ŒçºŒæŸ¥é–±æ¯”å°
                            const fieldsToCompare = ['reason','description','demand_department','invoice','custom_invoice','vendor','price','quantity','unit','freight','discount','is_scrap_work_order','work_order_number'];
                            const changesLog = [];
                            for (let i = 0; i < request.items.length; i++) {
                                const before = request.items[i] || {};
                                const after = newItems[i] || {};
                                const itemChanges = [];
                                fieldsToCompare.forEach(field => {
                                    const a = (before[field] === undefined || before[field] === null) ? '' : before[field];
                                    const b = (after[field] === undefined || after[field] === null) ? '' : after[field];
                                    if (String(a) !== String(b)) {
                                        itemChanges.push({ field, from: a, to: b });
                                    }
                                });
                                if (itemChanges.length > 0) {
                                    changesLog.push({ item_id: before.id, name: before.name, changes: itemChanges });
                                }
                            }
                            
                            const newHistoryEntry = {
                                user: state.currentUser.name,
                                role: state.currentUser.role,
                                date: new Date().toISOString(),
                                reason: modificationReason,
                                changes: changesLog
                            };
                            
                            updateData.items = newItems;
                            updateData.total_amount = newTotalAmount;
                            updateData.modification_history = [...(request.modification_history || []), newHistoryEntry];
                            savedPatch = { items: newItems, total_amount: newTotalAmount, modification_history: updateData.modification_history };
                        }

                        const { error: updateError } = await supabase
                            .from('requests')
                            .update(updateData)
                            .eq('id', requestId);
                        
                        if (updateError) throw updateError;
                        
                        // ç™¼é€é€šçŸ¥
                        let notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${requestId} å·²ç”± ${state.currentUser.name} æ ¸å‡†ã€‚`;
                        if (isFinal) {
                            notificationMessage = `æ‚¨çš„ç”³è«‹å–® ${requestId} å·²å…¨æ•¸ç°½æ ¸å®Œæˆï¼`;
                        }
                        // é€šçŸ¥ç”³è«‹äºº
                        await supabase.from('notifications').insert({
                            user_id: request.applicant_id,
                            request_id: requestId,
                            message: notificationMessage,
                            is_read: false
                        });
                        // è‹¥å·²æŒ‡æ´¾ç¶“è¾¦ï¼Œç™¼é€ç¶“è¾¦é€šçŸ¥
                        if (isFinal && updateData.handler_id) {
                            await supabase.from('notifications').insert({
                                user_id: updateData.handler_id,
                                request_id: requestId,
                                message: `æ‚¨è¢«æŒ‡æ´¾ç¶“è¾¦ç”³è«‹å–® ${requestId}ï¼Œè«‹å„˜é€Ÿè™•ç†ã€‚`,
                                is_read: false
                            });
                        }

                        showMessage((action === 'modal-save-changes' || action === 'modal-confirm-approve-with-save') ? 'ç”³è«‹å–®å·²ä¿®æ”¹ä¸¦æ ¸å‡†ã€‚' : 'ç”³è«‹å–®å·²æˆåŠŸæ ¸å‡†ã€‚');
                    } else {
                        // é€€å›é‚è¼¯
                        if (!comment.trim()) {
                            showMessage('é€€å›æ™‚å¿…é ˆå¡«å¯«æ„è¦‹ã€‚', 'error');
                            return;
                        }

                        approvers[currentStepIndex].status = 'rejected';
                        approvers[currentStepIndex].date = new Date().toISOString();
                        approvers[currentStepIndex].reason = comment;

                        const { error: updateError } = await supabase
                            .from('requests')
                            .update({ approvers, status: 'å·²é€€å›' })
                            .eq('id', requestId);
                        
                        if (updateError) throw updateError;

                        // ç™¼é€é€šçŸ¥
                        await supabase.from('notifications').insert({
                            user_id: request.applicant_id,
                            request_id: requestId,
                            message: `æ‚¨çš„ç”³è«‹å–® ${requestId} å·²è¢« ${state.currentUser.name} é€€å›ã€‚åŸå› ï¼š${comment}`,
                            is_read: false
                        });

                        showMessage('ç”³è«‹å–®å·²é€€å›ã€‚');
                    }

                    // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                    const updatedStatus = action === 'modal-reject' ? 'å·²é€€å›' : (currentStepIndex === approvers.length - 1 ? 'å·²æ ¸å‡†' : 'å¾…å¯©æ ¸');
                    const updatedRequest = { 
                        ...request, 
                        approvers, 
                        status: updatedStatus,
                        ...(currentStepIndex === approvers.length - 1 ? { handler_status: 'å¾…ç¶“è¾¦', handler_id: Object.values(state.users).find(u => u.is_handler)?.id || null } : {}),
                        ...(savedPatch ? savedPatch : {})
                    };
                    const newRequests = state.requests.map(r => r.id === requestId ? updatedRequest : r);
                    
                    // æ¸…é™¤ç·©å­˜ä¸¦é—œé–‰æ¨¡æ…‹æ¡†ä¸¦å›åˆ°åˆ—è¡¨
                    CacheManager.clear('dashboard_data');
                    getFilteredRequests.resetCache();
                    closeModal();
                    // æ¸…ç†å¿«ç…§
                    if (window.__approvePendingContext) delete window.__approvePendingContext;
                    updateState({ requests: newRequests, loading: false, view: 'dashboard' });
                    render();

                } catch (err) {
                    showMessage('ç°½æ ¸è™•ç†å¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                }
            }
        });

        // Modal å…§çš„æ¬„ä½äº’å‹•ï¼ˆç™¼ç¥¨é–‹ç«‹ã€è‡ªè¨‚ç™¼ç¥¨ã€å ±å»¢/è²¡ç”¢ç·¨è™Ÿï¼‰
    document.getElementById('modal-container').addEventListener('change', (e) => {
            const target = e.target;
            if (!target.name) return;
            if (target.name.startsWith('invoice_')) {
                const idx = target.name.split('_')[1];
                const custom = document.querySelector(`input[name="custom_invoice_${idx}"]`);
                if (custom) {
                    if (target.value === 'å…¶ä»–') {
                        custom.classList.remove('hidden');
                        custom.classList.add('block', 'w-2/3');
                    } else {
                        custom.classList.add('hidden');
                        custom.classList.remove('block', 'w-2/3');
                        custom.value = '';
                    }
                }
            } else if (target.name.startsWith('scrap_')) {
                const idx = target.name.split('_')[1];
                const asset = document.querySelector(`input[name="asset_number_${idx}"]`);
                if (asset) {
                    const enabled = target.checked;
                    asset.disabled = !enabled;
                    asset.classList.toggle('opacity-50', !enabled);
                    if (!enabled) asset.value = '';
                }
            } else if (target.name.startsWith('reason_')) {
                const idx = target.name.split('_')[1];
                const scrap = document.querySelector(`input[name="scrap_${idx}"]`);
                const asset = document.querySelector(`input[name="asset_number_${idx}"]`);
                if (scrap && asset) {
                    const isScrapReason = target.value === 'å ±å»¢';
                    scrap.disabled = !isScrapReason;
                    if (!isScrapReason) {
                        scrap.checked = false;
                        asset.value = '';
                        asset.disabled = true;
                        asset.classList.add('opacity-50');
                    }
                }
            }
        });
        
        document.body.addEventListener('click', async (e) => {
            const button = e.target.closest('button, a');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'edit-profile') {
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">å€‹äººè¨­å®š</h3>
                    <form id="edit-profile-form">
                        <div class="space-y-4">
                            <div>
                                <label for="edit-profile-name" class="block text-sm font-medium text-gray-700">å§“å</label>
                                <input type="text" id="edit-profile-name" value="${state.currentUser.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly>
                            </div>
                            <div>
                                <label for="edit-profile-email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="edit-profile-email" value="${state.currentUser.email}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" readonly>
                            </div>
                            <div>
                                <label for="edit-profile-demand-department" class="block text-sm font-medium text-gray-700">é è¨­éœ€æ±‚èª²å®¤</label>
                                <select id="edit-profile-demand-department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    ${DEMAND_DEPARTMENTS.map(d => `<option value="${d}" ${state.currentUser.demand_department === d ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="edit-profile-invoice" class="block text-sm font-medium text-gray-700">é è¨­ç™¼ç¥¨é–‹ç«‹</label>
                                <select id="edit-profile-invoice" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="">-- è«‹é¸æ“‡ --</option>
                                    ${[
                                        "8Cæ¸…ç¦", "7Cæ¸…æ°£", "6Cæ¸…å¿ƒ", "5Cæ¸…å¹³", "3Cæ¸…å®‰", "2CDæ¸…è­·",
                                        "8Dæ¸…æ˜¥", "7Dæ¸…æ—¥", "6Dæ¸…ç…§", "5Dæ¸…é¢¨", "3Dæ¸…æ™¯", "8Eæ¸…å±±",
                                        "7Eæ¸…æ³‰", "6Eæ¸…æ°´", "8Eæ¸…æ¸…", "3Eæ¸…æ¶¼", "æ¸…ç¦æ³•äºº", "ä¸€é¤¨",
                                        "äºŒé¤¨", "ä¸‰é¤¨", "å«ç¬‘", "æ¸…ç¦å¹¼å…’åœ’", "å…¶ä»–"
                                    ].map(opt => `<option value="${opt}" ${state.currentUser.default_invoice === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="edit-profile-theme" class="block text-sm font-medium text-gray-700">é è¨­é¢¨æ ¼</label>
                                <select id="edit-profile-theme" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    ${(() => { const cur = state.currentUser.theme_preference || localStorage.getItem('appTheme') || 'random'; return `
                                    <option value="default" ${cur==='default'?'selected':''}>é è¨­</option>
                                    <option value="random" ${cur==='random'?'selected':''}>*éš¨æ©Ÿ</option>
                                    <option value="apple" ${cur==='apple'?'selected':''}>Apple</option>
                                    <option value="scifi" ${cur==='scifi'?'selected':''}>é«˜ç§‘æŠ€</option>
                                    <option value="ghibli" ${cur==='ghibli'?'selected':''}>å‰åœåŠ›</option>
                                    <option value="abstract" ${cur==='abstract'?'selected':''}>è—è¡“</option>
                                    <option value="colorful" ${cur==='colorful'?'selected':''}>å¤šå½©</option>
                                    <option value="luhong" ${cur==='luhong'?'selected':''}>é­¯ç´…</option>
                                    <option value="lugreen" ${cur==='lugreen'?'selected':''}>é­¯ç¶ </option>
                                    <option value="forest" ${cur==='forest'?'selected':''}>æ£®æ—</option>
                                    <option value="ocean" ${cur==='ocean'?'selected':''}>æµ·æ´‹</option>
                                    <option value="sunset" ${cur==='sunset'?'selected':''}>å¤•é™½</option>
                                    <option value="midnight" ${cur==='midnight'?'selected':''}>åˆå¤œ</option>
                                    <option value="sakura" ${cur==='sakura'?'selected':''}>æ«»èŠ±</option>
                                    <option value="care-soft" ${cur==='care-soft'?'selected':''}>æº«é¦¨</option>
                                    <option value="care-fresh" ${cur==='care-fresh'?'selected':''}>æ¸…æ–°</option>
                                    <option value="med-clean" ${cur==='med-clean'?'selected':''}>æ¸…çˆ½</option>
                                    <option value="med-trust" ${cur==='med-trust'?'selected':''}>ä¿¡ä»»</option>
                                    <option value="hotel-lux" ${cur==='hotel-lux'?'selected':''}>å¥¢è¯</option>
                                    <option value="hotel-resort" ${cur==='hotel-resort'?'selected':''}>ä¼‘é–’</option>
                                    <option value="nord" ${cur==='nord'?'selected':''}>æ¸…å†·</option>
                                    <option value="latte" ${cur==='latte'?'selected':''}>æ‹¿éµ</option>
                                    <option value="mint" ${cur==='mint'?'selected':''}>è–„è·</option>
                                    <option value="solar" ${cur==='solar'?'selected':''}>æš–é™½</option>
                                    <option value="slate" ${cur==='slate'?'selected':''}>çŸ³æ¿</option>
                                    <option value="metro" ${cur==='metro'?'selected':''}>Metro</option>
                                    <option value="pastel" ${cur==='pastel'?'selected':''}>ç²‰å½©</option>
                                    <option value="neon" ${cur==='neon'?'selected':''}>éœ“è™¹</option>
                                    <option value="retro" ${cur==='retro'?'selected':''}>å¾©å¤</option>
                                    <option value="minimal" ${cur==='minimal'?'selected':''}>æ¥µç°¡</option>
                                    <option value="paper" ${cur==='paper'?'selected':''}>ç´™æ„Ÿ</option>
                                    <option value="grape" ${cur==='grape'?'selected':''}>è‘¡è„ç´«</option>
                                    <option value="cobalt" ${cur==='cobalt'?'selected':''}>éˆ·è—</option>
                                    <option value="sand" ${cur==='sand'?'selected':''}>æ²™ä¸˜</option>
                                    <option value="rosewood" ${cur==='rosewood'?'selected':''}>ç´…æœ¨</option>
                                    <option value="aurora" ${cur==='aurora'?'selected':''}>æ¥µå…‰</option>
                                    <option value="cocoa" ${cur==='cocoa'?'selected':''}>å¯å¯</option>
                                    <option value="denim" ${cur==='denim'?'selected':''}>ä¸¹å¯§</option>
                                    <option value="lime" ${cur==='lime'?'selected':''}>æª¸èŠå§†</option>
                                    <option value="coral" ${cur==='coral'?'selected':''}>çŠç‘š</option>
                                    <option value="plum" ${cur==='plum'?'selected':''}>ææ¢…ç´«</option>
                                    <option value="sky" ${cur==='sky'?'selected':''}>æ™´ç©º</option>
                                    <option value="graphite" ${cur==='graphite'?'selected':''}>çŸ³å¢¨</option>
                                    <option value="pearl" ${cur==='pearl'?'selected':''}>ç å…‰</option>
                                    <option value="rust" ${cur==='rust'?'selected':''}>éµé½</option>
                                    <option value="berry" ${cur==='berry'?'selected':''}>è“æœ</option>
                                    <option value="moss" ${cur==='moss'?'selected':''}>è‹”è˜š</option>
                                    <option value="teal" ${cur==='teal'?'selected':''}>æ°´é´¨</option>
                                    <option value="sepia" ${cur==='sepia'?'selected':''}>æ‡·èˆŠæ£•</option>
                                    <option value="charcoal" ${cur==='charcoal'?'selected':''}>ç‚­é»‘</option>
                                    <option value="ivory" ${cur==='ivory'?'selected':''}>è±¡ç‰™</option>
                                    <option value="azure" ${cur==='azure'?'selected':''}>å¤©è—</option>
                                    <option value="blush" ${cur==='blush'?'selected':''}>è…®ç´…</option>
                                    <option value="saffron" ${cur==='saffron'?'selected':''}>ç•ªç´…èŠ±</option>
                                    <option value="indigo" ${cur==='indigo'?'selected':''}>é›é’</option>
                                    <option value="copper" ${cur==='copper'?'selected':''}>éŠ…è‰²</option>
                                    <option value="lavender" ${cur==='lavender'?'selected':''}>è–°è¡£è‰</option>
                                    <option value="steel" ${cur==='steel'?'selected':''}>é‹¼éµ</option>
                                    <option value="clay" ${cur==='clay'?'selected':''}>é™¶åœŸ</option>
                                    <option value="cyan" ${cur==='cyan'?'selected':''}>é’è‰²</option>
                                    <option value="olive" ${cur==='olive'?'selected':''}>æ©„æ¬–</option>
                                    <option value="marigold" ${cur==='marigold'?'selected':''}>è¬å£½èŠ</option>
                                    <option value="orchid" ${cur==='orchid'?'selected':''}>è˜­èŠ±</option>
                                    <option value="flamingo" ${cur==='flamingo'?'selected':''}>ç«é¶´</option>
                                    <option value="iceberg" ${cur==='iceberg'?'selected':''}>å†°å±±</option>
                                    <option value="blossom" ${cur==='blossom'?'selected':''}>èŠ±æ¼¾</option>
                                    <option value="jade" ${cur==='jade'?'selected':''}>ç‰ç¿ </option>
                                    <option value="cinder" ${cur==='cinder'?'selected':''}>ç…¤ç‚­é»‘</option>
                                    <option value="fern" ${cur==='fern'?'selected':''}>è•¨ç¶ </option>
                                    <option value="glacier" ${cur==='glacier'?'selected':''}>å†°å·è—</option>
                                    <option value="ember" ${cur==='ember'?'selected':''}>é¤˜ç‡¼æ©™</option>
                                    <option value="horizon" ${cur==='horizon'?'selected':''}>å¤©éš›è—</option>
                                    <option value="canyon" ${cur==='canyon'?'selected':''}>å³½è°·æ©™</option>
                                    <option value="lagoon" ${cur==='lagoon'?'selected':''}>ç¤æ¹–é’</option>
                                    <option value="meadow" ${cur==='meadow'?'selected':''}>è‰ç”¸ç¶ </option>
                                    <option value="tundra" ${cur==='tundra'?'selected':''}>è‹”åŸè—ç°</option>
                                    <option value="dune" ${cur==='dune'?'selected':''}>æ²™æ¼ æ£•</option>
                                    <option value="willow" ${cur==='willow'?'selected':''}>å‚æŸ³ç¶ </option>
                                    <option value="bronze" ${cur==='bronze'?'selected':''}>å¤éŠ…</option>
                                    <option value="silver" ${cur==='silver'?'selected':''}>éŠ€éœœ</option>
                                    <option value="gold" ${cur==='gold'?'selected':''}>éé‡‘</option>
                                    <option value="amethyst" ${cur==='amethyst'?'selected':''}>ç´«æ°´æ™¶</option>
                                    <option value="sapphire" ${cur==='sapphire'?'selected':''}>è—å¯¶çŸ³</option>
                                    <option value="ruby" ${cur==='ruby'?'selected':''}>ç´…å¯¶çŸ³</option>
                                    <option value="emerald" ${cur==='emerald'?'selected':''}>ç¿ ç‰</option>
                                    <option value="topaz" ${cur==='topaz'?'selected':''}>é»ƒç‰</option>
                                    <option value="garnet" ${cur==='garnet'?'selected':''}>çŸ³æ¦´ç´…</option>
                                    <option value="quartz" ${cur==='quartz'?'selected':''}>çŸ³è‹±é’</option>
                                    <option value="onyx" ${cur==='onyx'?'selected':''}>ç¸ç‘ªç‘™</option>
                                    <option value="obsidian" ${cur==='obsidian'?'selected':''}>é»‘æ›œçŸ³</option>
                                    <option value="smoke" ${cur==='smoke'?'selected':''}>ç…™ç°</option>
                                    <option value="cloud" ${cur==='cloud'?'selected':''}>é›²ç™½</option>
                                    <option value="storm" ${cur==='storm'?'selected':''}>é¢¨æš´ç°</option>
                                    <option value="frost" ${cur==='frost'?'selected':''}>éœœè—</option>
                                    <option value="cherry" ${cur==='cherry'?'selected':''}>æ«»æ¡ƒç²‰</option>
                                    <option value="espresso" ${cur==='espresso'?'selected':''}>æ¿ƒç¸®å’–å•¡</option>
                                    <option value="mocha" ${cur==='mocha'?'selected':''}>æ‘©å¡</option>
                                    <option value="avocado" ${cur==='avocado'?'selected':''}>é…ªæ¢¨ç¶ </option>
                                    <option value="banana" ${cur==='banana'?'selected':''}>é¦™è•‰é»ƒ</option>
                                    <option value="plumeria" ${cur==='plumeria'?'selected':''}>é›è›‹èŠ±</option>
                                    <option value="reef" ${cur==='reef'?'selected':''}>çŠç‘šç¤è—</option>
                                    <option value="seafoam" ${cur==='seafoam'?'selected':''}>æµ·æ²«ç¶ </option>
                                    <option value="pine" ${cur==='pine'?'selected':''}>æ¾é‡ç¶ </option>
                                    <option value="iron" ${cur==='iron'?'selected':''}>éµç°</option>
                                    <option value="carbon" ${cur==='carbon'?'selected':''}>ç¢³é»‘</option>
                                    <option value="navy" ${cur==='navy'?'selected':''}>æµ·è»è—</option>
                                    <option value="air" ${cur==='air'?'selected':''}>ç©ºæ°£è—</option>
                                    <option value="violet" ${cur==='violet'?'selected':''}>ç´«ç¾…è˜­</option>
                                    <option value="caramel" ${cur==='caramel'?'selected':''}>ç„¦ç³–</option>
                                    <option value="peach" ${cur==='peach'?'selected':''}>èœœæ¡ƒ</option>
                                    <option value="lilac" ${cur==='lilac'?'selected':''}>ä¸é¦™ç´«</option>
                                    <option value="rose" ${cur==='rose'?'selected':''}>ç«ç‘°</option>
                                    <option value="magenta" ${cur==='magenta'?'selected':''}>æ´‹ç´…</option>
                                    <option value="periwinkle" ${cur==='periwinkle'?'selected':''}>é•·æ˜¥èŠ±</option>
                                    <option value="teak" ${cur==='teak'?'selected':''}>æŸšæœ¨</option>
                                    `; })()}
                                </select>
                            </div>
                            <div>
                                <label for="edit-profile-menu-layout" class="block text-sm font-medium text-gray-700">ç”³è«‹èœå–®ç‰ˆå‹</label>
                                <div class="mt-1 flex items-center gap-4">
                                    <select id="edit-profile-menu-layout" class="block w-48 rounded-md border-gray-300 shadow-sm">
                                        ${(() => { const cur = state.currentUser.menu_layout || localStorage.getItem('menuLayout') || (state.local.layoutScale || 'expanded'); return `
                                        <option value="expanded" ${cur==='expanded'?'selected':''}>æ¸…å–®è¼ƒå¯¬ï¼ˆå·¦ 2/3ï½œå³ 1/3ï¼‰</option>
                                        <option value="compact" ${cur==='compact'?'selected':''}>æ¸…å–®è¼ƒçª„ï¼ˆå·¦ 1/3ï½œå³ 2/3ï¼‰</option>
                                        `; })()}
                                    </select>
                                    <div id="menu-layout-preview" class="flex items-center text-gray-600"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200">å–æ¶ˆ</button>
                        <button data-action="save-profile" class="px-4 py-2 rounded-md font-semibold text-sm bg-blue-600 text-white">å„²å­˜</button>
                    </div>
                `);
                                // åˆå§‹åŒ–ç‰ˆå‹é è¦½
                                const preview = document.getElementById('menu-layout-preview');
                                const select = document.getElementById('edit-profile-menu-layout');
                                const renderPreview = (val) => {
                                        if (!preview) return;
                                        if (val === 'compact') {
                                                preview.innerHTML = `
                                                    <svg width="72" height="24" viewBox="0 0 24 8" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <rect x="0.5" y="0.5" width="7" height="7" rx="1" fill="currentColor" opacity="0.9"/>
                                                        <rect x="8.5" y="0.5" width="15" height="7" rx="1" fill="currentColor" opacity="0.35"/>
                                                    </svg>`;
                                        } else {
                                                preview.innerHTML = `
                                                    <svg width="72" height="24" viewBox="0 0 24 8" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <rect x="0.5" y="0.5" width="15" height="7" rx="1" fill="currentColor" opacity="0.35"/>
                                                        <rect x="16.5" y="0.5" width="7" height="7" rx="1" fill="currentColor" opacity="0.9"/>
                                                    </svg>`;
                                        }
                                };
                                renderPreview(select.value);
                                select.addEventListener('change', (ev) => renderPreview(ev.target.value));
            } else if (action === 'save-profile') {
                const form = document.getElementById('edit-profile-form');
                if (!form) return;

                // å–å¾—è¡¨å–®å€¼
                const demandDepartment = form.querySelector('#edit-profile-demand-department').value;
                const defaultInvoice = form.querySelector('#edit-profile-invoice').value;

                // é©—è­‰è³‡æ–™ä¸ç‚ºç©º
                if (!demandDepartment && !defaultInvoice) {
                    showMessage('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹è¨­å®šé …ç›®', 'error');
                    return;
                }

                // æº–å‚™æ›´æ–°è³‡æ–™ç‰©ä»¶ï¼Œå…©å€‹æ¬„ä½éƒ½å¸¶å…¥
                const updateData = {
                    demand_department: demandDepartment,
                    default_invoice: defaultInvoice
                };

                // å¦‚æœå…©å€‹æ¬„ä½éƒ½æ²’è®Šæ›´ï¼Œç›´æ¥é—œé–‰
                if (
                    demandDepartment === state.currentUser.demand_department &&
                    defaultInvoice === state.currentUser.default_invoice
                ) {
                    showMessage('æ²’æœ‰è³‡æ–™è¢«è®Šæ›´');
                    closeModal();
                    return;
                }

                updateState({ loading: true });
                try {
                    // å…ˆå–å¾—æœ€æ–°çš„ä½¿ç”¨è€…è³‡æ–™
                    const { data: currentUserData, error: fetchError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', state.currentUser.id)
                        .single();

                    if (fetchError) throw fetchError;

                    // åŸ·è¡Œæ›´æ–°
                    const { error: updateError } = await supabase
                        .from('users')
                        .update(updateData)
                        .eq('id', state.currentUser.id);

                    if (updateError) throw updateError;

                    // æ›´æ–°æˆåŠŸå¾Œï¼Œæ›´æ–°æœ¬åœ°ç‹€æ…‹
                    state.currentUser = {
                        ...state.currentUser,
                        ...updateData
                    };
                    showMessage('å€‹äººè¨­å®šå·²æ›´æ–°ï¼');
                    closeModal();
                } catch (err) {
                    console.error('æ›´æ–°å€‹äººè¨­å®šå¤±æ•—:', err);
                    showMessage('æ›´æ–°å¤±æ•—: ' + err.message, 'error');
                }
                updateState({ loading: false });
            } else if (action === 'view-detail') {
                const requestId = button.dataset.id;
                const request = state.requests.find(r => r.id == requestId);
                if (request.status === 'å¾…é€å‡º' && request.applicant_id === state.currentUser.id) {
                    // ç·¨è¼¯è‰ç¨¿
                    updateState({ 
                        view: 'newRequest', 
                        editingRequest: request, 
                        local: { ...state.local, newRequestCart: request.items || [] } 
                    });
                } else {
                    // æª¢è¦–æˆ–ç°½æ ¸
                    updateState({ selectedRequest: request, view: 'detailView' });
                }
            } else if (action === 'view-notification-detail') {
                e.preventDefault();
                const requestId = button.dataset.id;
                const notificationId = button.dataset.notificationId;
                const request = state.requests.find(r => r.id == requestId);

                if (request) {
                    if (notificationId) {
                        const notification = state.applicantNotifications.find(n => n.id == notificationId);
                        if (notification && !notification.is_read) {
                            supabase.from('notifications').update({ is_read: true }).eq('id', notificationId).then(({error}) => {
                                if (error) console.error("æ›´æ–°é€šçŸ¥ç‹€æ…‹å¤±æ•—:", error);
                            });
                        }
                    }
                    
                    const dropdown = document.getElementById('notification-dropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                    updateState({ view: 'detailView', selectedRequest: request });
                }
            } else if (action === 'delete-draft') {
                const button = e.target.closest('button[data-action="delete-draft"]'); // Be more specific
                const requestId = button ? button.dataset.id : undefined;
                renderModal(`
                    <h3 class="text-lg font-bold mb-4">ç¢ºèªåˆªé™¤è‰ç¨¿</h3>
                    <p class="mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤è‰ç¨¿ç”³è«‹å–® ${requestId} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
                    <div class="flex justify-end space-x-4">
                        <button data-action="cancel-modal" class="px-4 py-2 rounded-md font-semibold text-sm bg-gray-200 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button data-id="${requestId}" data-action="confirm-delete-draft" class="px-4 py-2 rounded-md font-semibold text-sm bg-red-600 text-white hover:bg-red-700">ç¢ºèªåˆªé™¤</button>
                    </div>
                `);
            } else if (action === 'confirm-delete-draft') {
                const requestId = button.dataset.id;
                const requestToDelete = state.requests.find(r => r.id == requestId);

                if (!requestToDelete) {
                    showMessage('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„ç”³è«‹å–®ã€‚', 'error');
                    closeModal();
                    return;
                }

                // æª¢æŸ¥æ¬Šé™
                const canDelete = state.currentUser.is_admin ||
                                  (requestToDelete.applicant_id === state.currentUser.id && requestToDelete.status === 'å¾…é€å‡º');

                if (!canDelete) {
                    showMessage('æ‚¨æ²’æœ‰æ¬Šé™åˆªé™¤æ­¤ç”³è«‹å–®ã€‚', 'error');
                    closeModal();
                    return;
                }

                updateState({ loading: true });
                try {
                    const { error } = await supabase.from('requests').delete().eq('id', requestId);
                    if (error) throw error;
                    showMessage('ç”³è«‹å–®å·²æˆåŠŸåˆªé™¤ï¼');
                    closeModal();
                    
                    // æ¸…é™¤ç·©å­˜ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™
                    CacheManager.clear('dashboard_data');
                    await loadDashboardData(false, false); // å¼·åˆ¶ä¸ä½¿ç”¨ç·©å­˜
                    
                    // é‡ç½®ç¯©é¸ç·©å­˜
                    getFilteredRequests.resetCache();
                    
                    updateState({ 
                        loading: false,
                        view: 'personalForms', 
                        local: { ...state.local, personalForms: { ...state.local.personalForms, activeTab: 'sent' } } 
                    });
                } catch (err) {
                    console.error("åˆªé™¤ç”³è«‹å–®å¤±æ•—:", err);
                    showMessage('åˆªé™¤ç”³è«‹å–®å¤±æ•—: ' + err.message, 'error');
                    updateState({ loading: false });
                    closeModal();
                }
            }
        });

        // æœƒè©±ç®¡ç†äº‹ä»¶è™•ç†å™¨
        document.getElementById('sessionManagement-view').addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;

            if (action === 'refresh-sessions') {
                try {
                    await renderSessionManagement();
                    showMessage('æœƒè©±åˆ—è¡¨å·²æ›´æ–°', 'success');
                } catch (error) {
                    showMessage('æ›´æ–°æœƒè©±åˆ—è¡¨å¤±æ•—ï¼š' + error.message, 'error');
                }
            } else if (action === 'cleanup-expired-sessions') {
                if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰éæœŸçš„æœƒè©±å—ï¼Ÿ')) return;
                
                try {
                    updateState({ loading: true });
                    
                    // æ¸…é™¤éæœŸæœƒè©±
                    const { error } = await supabase
                        .from('login_sessions')
                        .delete()
                        .or('expires_at.lt.now(),is_active.eq.false');
                    
                    if (error) throw error;
                    
                    showMessage('å·²æ¸…é™¤éæœŸæœƒè©±', 'success');
                    await renderSessionManagement();
                } catch (error) {
                    console.error('æ¸…é™¤éæœŸæœƒè©±å¤±æ•—:', error);
                    showMessage('æ¸…é™¤éæœŸæœƒè©±å¤±æ•—ï¼š' + error.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            } else if (action === 'revoke-session') {
                const sessionId = button.dataset.sessionId;
                if (!confirm('ç¢ºå®šè¦æ’¤éŠ·æ­¤ç™»å…¥æœƒè©±å—ï¼Ÿè©²ä½¿ç”¨è€…å°‡éœ€è¦é‡æ–°ç™»å…¥ã€‚')) return;
                
                try {
                    updateState({ loading: true });
                    
                    // æ’¤éŠ·æŒ‡å®šæœƒè©±
                    const { error } = await supabase
                        .from('login_sessions')
                        .update({ is_active: false })
                        .eq('id', sessionId);
                    
                    if (error) throw error;
                    
                    showMessage('æœƒè©±å·²æ’¤éŠ·', 'success');
                    await renderSessionManagement();
                } catch (error) {
                    console.error('æ’¤éŠ·æœƒè©±å¤±æ•—:', error);
                    showMessage('æ’¤éŠ·æœƒè©±å¤±æ•—ï¼š' + error.message, 'error');
                } finally {
                    updateState({ loading: false });
                }
            }
        });
        
        document.body.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (e.target.id === 'login-form') {
                const account = e.target.elements.account.value;
                const password = e.target.elements.password.value;
                const rememberMe = e.target.elements.rememberMe.checked;
                let email = account;

                updateState({ loading: true, error: null }); 

                try {
                    if (!account.includes('@')) {
                        const { data, error } = await supabase.functions.invoke('find-email-by-id', {
                            body: { id: account }
                        });

                        if (error) throw error;
                        if (data.error) throw new Error(data.error);

                        if (data.emails.length === 0) {
                            throw new Error('Invalid login credentials');
                        } else if (data.emails.length > 1) {
                            throw new Error(`å¸³è™Ÿ "${account}" å­˜åœ¨æ–¼å¤šå€‹ç¶²åŸŸï¼Œè«‹è¼¸å…¥å®Œæ•´çš„ Email ç™»å…¥ã€‚`);
                        }
                        email = data.emails[0];
                    }

                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;

                    // ç™»å…¥æˆåŠŸå¾Œä¿å­˜æœƒè©±è³‡è¨Š
                    if (data.user) {
                        console.log('ğŸ“Š æª¢æŸ¥ç™»å…¥å¾Œçš„ data.user çµæ§‹:', data.user);
                        
                        const userInfo = {
                            id: data.user.id || data.user.user_id || null,
                            email: email,
                            account: account,
                            user_id: account
                        };
                        
                        console.log('ğŸ“Š æ§‹å»ºçš„ userInfo å°è±¡:', userInfo);
                        
                        // ç¢ºä¿æœ‰æœ‰æ•ˆçš„ ID æ‰ä¿å­˜æœƒè©±
                        if (userInfo.id) {
                            await loginSessionManager.saveLoginSession(userInfo, rememberMe);
                        } else {
                            console.warn('âš ï¸ è­¦å‘Šï¼šdata.user ç¼ºå°‘ id å±¬æ€§ï¼Œè·³éæœƒè©±ä¿å­˜');
                        }
                        
                        // é¡¯ç¤ºç™»å…¥æˆåŠŸè¨Šæ¯
                        showMessage(`æ­¡è¿å›ä¾†${rememberMe ? 'ï¼Œå·²è¨˜ä½æ‚¨çš„ç™»å…¥è³‡è¨Š' : ''}ï¼`, 'success');
                    } else {
                        console.warn('âš ï¸ è­¦å‘Šï¼šç™»å…¥æˆåŠŸä½† data.user ç‚ºç©º');
                        showMessage('ç™»å…¥æˆåŠŸï¼', 'success');
                    }

                } catch (error) {
                    let message = "ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„å¸³è™Ÿå’Œå¯†ç¢¼ã€‚";
                    if (error.message.includes('Invalid login credentials')) {
                        message = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚";
                    } else if (error.message.includes('User account is disabled')) {
                        message = "æ­¤å¸³è™Ÿå·²è¢«åœç”¨ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚";
                    } else {
                        message = error.message;
                    }
                    showMessage(message, 'error');
                    updateState({ loading: false });
                }
            } 
        });

        // --- åˆå§‹è¼‰å…¥èˆ‡é©—è­‰ç‹€æ…‹ç›£è½ ---
        document.addEventListener('DOMContentLoaded', loadTheme);
        document.body.addEventListener('change', (e) => {
            if (e.target.id === 'theme-select') {
                applyTheme(e.target.value);
            }
        });
        
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                if (state.currentUser && state.currentUser.id === session.user.id) {
                    return; 
                }

                updateState({ loading: true });
                const user = session.user;
                const { data: userProfile, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (error || !userProfile) {
                    console.error("æ‰¾ä¸åˆ°ä½¿ç”¨è€…è¨­å®šæª”:", error);
                    await supabase.auth.signOut();
                    updateState({ error: "èªè­‰æˆåŠŸï¼Œä½†åœ¨è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°æ‚¨çš„è¨­å®šæª”ã€‚è«‹è¯ç¹«ç®¡ç†å“¡ã€‚", loading: false });
                } else {
                    state.currentUser = userProfile;
                    state.local.dashboardFilters.permission = 'pending_for_me'; 
                    if (userProfile.favorite_products && Array.isArray(userProfile.favorite_products)) {
                        state.local.favoriteProductIds = new Set(userProfile.favorite_products);
                    } else {
                        state.local.favoriteProductIds = new Set();
                    }
                    // å¥—ç”¨å€‹äººé è¨­ä¸»é¡Œèˆ‡èœå–®ç‰ˆå‹
                    if (userProfile.theme_preference) {
                        applyTheme(userProfile.theme_preference);
                        const sel = document.getElementById('theme-select');
                        if (sel) sel.value = state.theme;
                    }
                    if (userProfile.menu_layout) {
                        state.local.layoutScale = userProfile.menu_layout === 'compact' ? 'compact' : 'expanded';
                        localStorage.setItem('menuLayout', state.local.layoutScale);
                    }
                    await loadDashboardData(true);
                }
            } 
            else {
                // æ²’æœ‰ Supabase session æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰çš„è‡ªå‹•ç™»å…¥ç‹€æ…‹
                if (state.currentUser) {
                    console.log('æª¢æ¸¬åˆ° Supabase session çµæŸï¼Œä½†æœ‰è‡ªå‹•ç™»å…¥ç‹€æ…‹ï¼Œä¿æŒç™»å…¥');
                    return; // ä¿æŒç•¶å‰ç‹€æ…‹ï¼Œä¸è¦æ¸…é™¤
                }
                
                channels.forEach(channel => supabase.removeChannel(channel));
                channels = [];
                Object.assign(state, {
                    requests: [], products: {}, users: {}, categories: [], applicantNotifications: [],
                    currentUser: null,
                    loading: false, 
                    error: null
                });
                updateState({ view: 'login' });
            }
        });
        

        // --- Get Filtered Products ---
        const getFilteredProducts = () => {
            const { allProducts, products } = state;
            const { activeProductManagementCategory, productManagementSearchTerm, productManagementSearchAll, productSortKey, productSortDirection } = state.local;
            
            let productsToFilter = [];
            if (productManagementSearchAll || activeProductManagementCategory === 'å…¨å“é …' || !activeProductManagementCategory) {
                productsToFilter = allProducts;
            } else {
                productsToFilter = products[activeProductManagementCategory] || [];
            }

            const lowerCaseSearchTerm = (productManagementSearchTerm || '').toLowerCase();
            let filtered = productsToFilter;
            if (lowerCaseSearchTerm) {
                filtered = filtered.filter(p => {
                    const { image, ...searchableProduct } = p;
                    return JSON.stringify(searchableProduct).toLowerCase().includes(lowerCaseSearchTerm);
                });
            }
            
            if (productSortKey) {
                filtered.sort((a, b) => {
                    let valA = a[productSortKey];
                    let valB = b[productSortKey];

                    if (typeof valA === 'string') valA = valA.toLowerCase();
                    if (typeof valB === 'string') valB = valB.toLowerCase();

                    if (valA < valB) return productSortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return productSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            return filtered;
        };

        // æ€§èƒ½ç›£æ§
        function setupPerformanceMonitoring() {
            if ('performance' in window) {
                // ç›£æ§è³‡æºè¼‰å…¥æ™‚é–“
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        const navigation = performance.getEntriesByType('navigation')[0];
                        const paintEntries = performance.getEntriesByType('paint');
                        
                        console.log('æ€§èƒ½çµ±è¨ˆ:', {
                            loadTime: navigation.loadEventEnd - navigation.loadEventStart,
                            domContentLoaded: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
                            firstPaint: paintEntries.find(entry => entry.name === 'first-paint')?.startTime,
                            firstContentfulPaint: paintEntries.find(entry => entry.name === 'first-contentful-paint')?.startTime
                        });
                    }, 0);
                });
            }
        }

        // å…§å­˜å„ªåŒ–
        function setupMemoryOptimization() {
            // å®šæœŸæ¸…ç†å¿«å–
            setInterval(() => {
                if (window.CacheManager) {
                    window.CacheManager.cleanup();
                }
                if (window.resourceOptimizer) {
                    window.resourceOptimizer.cleanupCache();
                }
            }, 300000); // æ¯ 5 åˆ†é˜æ¸…ç†ä¸€æ¬¡
        }

        // åˆå§‹åŒ–æ‰€æœ‰å„ªåŒ–åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', async () => {
            setupPerformanceMonitoring();
            setupMemoryOptimization();
            
            // èª¿è©¦ï¼šåˆ—å‡ºæ‰€æœ‰ LocalStorage å…§å®¹
            console.log('ğŸ—‚ï¸ é é¢è¼‰å…¥æ™‚çš„ LocalStorage å…§å®¹:');
            if (localStorage.length === 0) {
                console.log('  âš ï¸ LocalStorage å®Œå…¨ç©ºç™½');
            } else {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    if (key.startsWith('sps_')) {
                        console.log(`  ğŸ”‘ ${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`);
                    }
                }
            }
            
            // åˆå§‹åŒ–æ™‚é è¼‰å…¥é—œéµè³‡æº
            if (window.resourceOptimizer) {
                window.resourceOptimizer.preloadCriticalResources();
            }
            
            // æª¢æŸ¥æ˜¯å¦ç‚º Google Sites ç’°å¢ƒï¼Œå¦‚æœæ˜¯å‰‡è·³é Supabase session æª¢æŸ¥
            if (loginSessionManager.isGoogleSites) {
                console.log('ğŸŒ [é é¢è¼‰å…¥] Google Sites ç’°å¢ƒï¼Œè·³é Supabase session æª¢æŸ¥ï¼Œç›´æ¥æª¢æŸ¥è‡ªå‹•ç™»å…¥');
                try {
                    updateState({ loading: true });
                    const autoLoginSuccess = await loginSessionManager.checkAutoLogin();
                    
                    if (autoLoginSuccess) {
                        console.log('ğŸ‰ [è‡ªå‹•ç™»å…¥] è‡ªå‹•ç™»å…¥æˆåŠŸï¼Œç›´æ¥é¡¯ç¤º dashboard');
                        updateState({ 
                            view: 'dashboard', 
                            loading: false,
                            error: null
                        });
                        showMessage('æ­¡è¿å›ä¾†ï¼å·²è‡ªå‹•ç™»å…¥', 'success');
                    } else {
                        console.log('âŒ [è‡ªå‹•ç™»å…¥] è‡ªå‹•ç™»å…¥å¤±æ•—æˆ–ç„¡ä»¤ç‰Œï¼Œé¡¯ç¤ºç™»å…¥é é¢');
                        updateState({ view: 'login', loading: false });
                    }
                } catch (error) {
                    console.error('âŒ [è‡ªå‹•ç™»å…¥] è‡ªå‹•ç™»å…¥æª¢æŸ¥å¤±æ•—:', error);
                    updateState({ view: 'login', loading: false });
                }
                return; // ææ—©è¿”å›ï¼Œä¸åŸ·è¡Œå¾ŒçºŒçš„ Supabase é‚è¼¯
            }

            // é Google Sites ç’°å¢ƒæ‰æª¢æŸ¥ Supabase session
            console.log('ğŸ” [é é¢è¼‰å…¥] æª¢æŸ¥ Supabase session ç‹€æ…‹...');
            
            let session = null;
            try {
                console.log('ğŸ“¡ [é é¢è¼‰å…¥] é–‹å§‹ Supabase getSession èª¿ç”¨...');
                const sessionResponse = await Promise.race([
                    supabase.auth.getSession(),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Supabase getSession è¶…æ™‚')), 5000)
                    )
                ]);
                session = sessionResponse.data?.session;
                console.log('âœ… [é é¢è¼‰å…¥] Supabase getSession å®Œæˆ');
            } catch (error) {
                console.error('âŒ [é é¢è¼‰å…¥] Supabase getSession å¤±æ•—:', error);
                console.log('ğŸ”„ [é é¢è¼‰å…¥] è·³é Supabase session æª¢æŸ¥ï¼Œç›´æ¥æª¢æŸ¥è‡ªå‹•ç™»å…¥');
            }
            
            console.log('ğŸ“‹ [é é¢è¼‰å…¥] Supabase session æª¢æŸ¥çµæœ:', {
                hasSession: !!session,
                sessionData: session ? {
                    user_id: session.user?.id,
                    email: session.user?.email,
                    access_token: session.access_token?.substring(0, 20) + '...',
                    expires_at: session.expires_at
                } : null
            });
            
            if (!session) {
                // æ²’æœ‰ Supabase sessionï¼Œå˜—è©¦è‡ªå‹•ç™»å…¥
                console.log('ğŸ” [è‡ªå‹•ç™»å…¥] æ²’æœ‰ Supabase sessionï¼Œæª¢æŸ¥è‡ªå‹•ç™»å…¥ä»¤ç‰Œ...');
                try {
                    updateState({ loading: true });
                    const autoLoginSuccess = await loginSessionManager.checkAutoLogin();
                    
                    if (autoLoginSuccess) {
                        console.log('ğŸ‰ [è‡ªå‹•ç™»å…¥] è‡ªå‹•ç™»å…¥æˆåŠŸï¼Œç›´æ¥é¡¯ç¤º dashboard');
                        // ä¸èª¿ç”¨ loadDashboardDataï¼Œç›´æ¥é¡¯ç¤ºç°¡åŒ–çš„ dashboard
                        updateState({ 
                            view: 'dashboard', 
                            loading: false,
                            error: null
                        });
                        
                        // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
                        showMessage('æ­¡è¿å›ä¾†ï¼å·²è‡ªå‹•ç™»å…¥', 'success');
                    } else {
                        console.log('âŒ [è‡ªå‹•ç™»å…¥] è‡ªå‹•ç™»å…¥å¤±æ•—æˆ–ç„¡ä»¤ç‰Œï¼Œé¡¯ç¤ºç™»å…¥é é¢');
                        updateState({ view: 'login', loading: false });
                    }
                } catch (error) {
                    console.error('âŒ [è‡ªå‹•ç™»å…¥] è‡ªå‹•ç™»å…¥æª¢æŸ¥å¤±æ•—:', error);
                    updateState({ view: 'login', loading: false });
                }
            } else {
                console.log('âœ… [é é¢è¼‰å…¥] æ‰¾åˆ° Supabase sessionï¼Œä½¿ç”¨åŸæœ‰é‚è¼¯');
                console.log('ğŸ” [é é¢è¼‰å…¥] Session è©³æƒ…:', {
                    user_id: session.user?.id,
                    email: session.user?.email,
                    role: session.user?.role || 'æœªæŒ‡å®š',
                    session_valid: !!session.access_token
                });
                // æœ‰ session æ™‚è®“ onAuthStateChange è™•ç†
            }
            
            console.log('æ‰€æœ‰æ•ˆèƒ½å„ªåŒ–å·²å•Ÿç”¨');
        });
    </script>
</body>
</html>
